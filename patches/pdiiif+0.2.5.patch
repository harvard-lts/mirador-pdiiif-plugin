diff --git a/node_modules/pdiiif/.DS_Store b/node_modules/pdiiif/.DS_Store
new file mode 100644
index 0000000..6710950
Binary files /dev/null and b/node_modules/pdiiif/.DS_Store differ
diff --git a/node_modules/pdiiif/dist/__tests__/parser.test.d.ts b/node_modules/pdiiif/dist/__tests__/parser.test.d.ts
new file mode 100644
index 0000000..cb0ff5c
--- /dev/null
+++ b/node_modules/pdiiif/dist/__tests__/parser.test.d.ts
@@ -0,0 +1 @@
+export {};
diff --git a/node_modules/pdiiif/dist/__tests__/pdf.spec.d.ts b/node_modules/pdiiif/dist/__tests__/pdf.spec.d.ts
new file mode 100644
index 0000000..cb0ff5c
--- /dev/null
+++ b/node_modules/pdiiif/dist/__tests__/pdf.spec.d.ts
@@ -0,0 +1 @@
+export {};
diff --git a/node_modules/pdiiif/dist/__tests__/setupJest.d.ts b/node_modules/pdiiif/dist/__tests__/setupJest.d.ts
new file mode 100644
index 0000000..e69de29
diff --git a/node_modules/pdiiif/dist/assets/optimization.worker-Ra1-MoAS.js b/node_modules/pdiiif/dist/assets/optimization.worker-Ra1-MoAS.js
new file mode 100644
index 0000000..ce7a5d9
--- /dev/null
+++ b/node_modules/pdiiif/dist/assets/optimization.worker-Ra1-MoAS.js
@@ -0,0 +1,885 @@
+var kt = (() => {
+  var v = import.meta.url;
+  return function(g = {}) {
+    var i = g, _, h, O = new Promise((r, e) => {
+      _ = r, h = e;
+    });
+    const Kr = globalThis.ServiceWorkerGlobalScope !== void 0 && typeof self < "u" && globalThis.caches && globalThis.caches.default !== void 0, Xr = typeof process == "object" && process.release && process.release.name === "node";
+    (Kr || Xr) && (globalThis.ImageData || (globalThis.ImageData = class {
+      constructor(e, t, n) {
+        this.data = e, this.width = t, this.height = n;
+      }
+    }), import.meta.url === void 0 && (import.meta.url = "https://localhost"), typeof self < "u" && self.location === void 0 && (self.location = { href: "" }));
+    var hr = Object.assign({}, i), _r = "./this.program", mr = (r, e) => {
+      throw e;
+    }, yr = typeof window == "object", J = typeof importScripts == "function";
+    typeof process == "object" && typeof process.versions == "object" && process.versions.node;
+    var T = "";
+    function Zr(r) {
+      return i.locateFile ? i.locateFile(r, T) : T + r;
+    }
+    var nr;
+    (yr || J) && (J ? T = self.location.href : typeof document < "u" && document.currentScript && (T = document.currentScript.src), v && (T = v), T.startsWith("blob:") ? T = "" : T = T.substr(0, T.replace(/[?#].*/, "").lastIndexOf("/") + 1), J && (nr = (r) => {
+      var e = new XMLHttpRequest();
+      return e.open("GET", r, !1), e.responseType = "arraybuffer", e.send(null), new Uint8Array(e.response);
+    }));
+    var Qr = i.print || console.log.bind(console), z = i.printErr || console.error.bind(console);
+    Object.assign(i, hr), hr = null, i.arguments && i.arguments, i.thisProgram && (_r = i.thisProgram), i.quit && (mr = i.quit);
+    var H;
+    i.wasmBinary && (H = i.wasmBinary);
+    var K, br = !1, C, y, x, ar, B, p, wr, Ar;
+    function Tr() {
+      var r = K.buffer;
+      i.HEAP8 = C = new Int8Array(r), i.HEAP16 = x = new Int16Array(r), i.HEAPU8 = y = new Uint8Array(r), i.HEAPU16 = ar = new Uint16Array(r), i.HEAP32 = B = new Int32Array(r), i.HEAPU32 = p = new Uint32Array(r), i.HEAPF32 = wr = new Float32Array(r), i.HEAPF64 = Ar = new Float64Array(r);
+    }
+    var $r = [], Er = [], Cr = [];
+    function Yr() {
+      if (i.preRun)
+        for (typeof i.preRun == "function" && (i.preRun = [i.preRun]); i.preRun.length; )
+          te(i.preRun.shift());
+      ir($r);
+    }
+    function re() {
+      ir(Er);
+    }
+    function ee() {
+      if (i.postRun)
+        for (typeof i.postRun == "function" && (i.postRun = [i.postRun]); i.postRun.length; )
+          ae(i.postRun.shift());
+      ir(Cr);
+    }
+    function te(r) {
+      $r.unshift(r);
+    }
+    function ne(r) {
+      Er.unshift(r);
+    }
+    function ae(r) {
+      Cr.unshift(r);
+    }
+    var k = 0, q = null;
+    function ie(r) {
+      var e;
+      k++, (e = i.monitorRunDependencies) == null || e.call(i, k);
+    }
+    function oe(r) {
+      var t;
+      if (k--, (t = i.monitorRunDependencies) == null || t.call(i, k), k == 0 && q) {
+        var e = q;
+        q = null, e();
+      }
+    }
+    function Rr(r) {
+      var t;
+      (t = i.onAbort) == null || t.call(i, r), r = "Aborted(" + r + ")", z(r), br = !0, r += ". Build with -sASSERTIONS for more info.";
+      var e = new WebAssembly.RuntimeError(r);
+      throw h(e), e;
+    }
+    var se = "data:application/octet-stream;base64,", Pr = (r) => r.startsWith(se), U;
+    i.locateFile ? (U = "mozjpeg_enc.wasm", Pr(U) || (U = Zr(U))) : U = null;
+    function Fr(r) {
+      if (r == U && H)
+        return new Uint8Array(H);
+      if (nr)
+        return nr(r);
+      throw "both async and sync fetching of the wasm failed";
+    }
+    function le(r) {
+      return !H && (yr || J) && typeof fetch == "function" ? fetch(r, { credentials: "same-origin" }).then((e) => {
+        if (!e.ok)
+          throw `failed to load wasm binary file at '${r}'`;
+        return e.arrayBuffer();
+      }).catch(() => Fr(r)) : Promise.resolve().then(() => Fr(r));
+    }
+    function Wr(r, e, t) {
+      return le(r).then((n) => WebAssembly.instantiate(n, e)).then(t, (n) => {
+        z(`failed to asynchronously prepare wasm: ${n}`), Rr(n);
+      });
+    }
+    function fe(r, e, t, n) {
+      return !r && typeof WebAssembly.instantiateStreaming == "function" && !Pr(e) && typeof fetch == "function" ? fetch(e, { credentials: "same-origin" }).then((a) => {
+        var o = WebAssembly.instantiateStreaming(a, t);
+        return o.then(n, function(f) {
+          return z(`wasm streaming compile failed: ${f}`), z("falling back to ArrayBuffer instantiation"), Wr(e, t, n);
+        });
+      }) : Wr(e, t, n);
+    }
+    function ue() {
+      var r = { a: Wt };
+      function e(n, a) {
+        return $ = n.exports, K = $.C, Tr(), Or = $.H, ne($.D), oe(), $;
+      }
+      ie();
+      function t(n) {
+        e(n.instance);
+      }
+      if (i.instantiateWasm)
+        try {
+          return i.instantiateWasm(r, e);
+        } catch (n) {
+          z(`Module.instantiateWasm callback failed with error: ${n}`), h(n);
+        }
+      return fe(H, U, r, t).catch(h), {};
+    }
+    function ce(r) {
+      this.name = "ExitStatus", this.message = `Program terminated with exit(${r})`, this.status = r;
+    }
+    var ir = (r) => {
+      for (; r.length > 0; )
+        r.shift()(i);
+    };
+    i.noExitRuntime;
+    class ve {
+      constructor(e) {
+        this.excPtr = e, this.ptr = e - 24;
+      }
+      set_type(e) {
+        p[this.ptr + 4 >> 2] = e;
+      }
+      get_type() {
+        return p[this.ptr + 4 >> 2];
+      }
+      set_destructor(e) {
+        p[this.ptr + 8 >> 2] = e;
+      }
+      get_destructor() {
+        return p[this.ptr + 8 >> 2];
+      }
+      set_caught(e) {
+        e = e ? 1 : 0, C[this.ptr + 12] = e;
+      }
+      get_caught() {
+        return C[this.ptr + 12] != 0;
+      }
+      set_rethrown(e) {
+        e = e ? 1 : 0, C[this.ptr + 13] = e;
+      }
+      get_rethrown() {
+        return C[this.ptr + 13] != 0;
+      }
+      init(e, t) {
+        this.set_adjusted_ptr(0), this.set_type(e), this.set_destructor(t);
+      }
+      set_adjusted_ptr(e) {
+        p[this.ptr + 16 >> 2] = e;
+      }
+      get_adjusted_ptr() {
+        return p[this.ptr + 16 >> 2];
+      }
+      get_exception_ptr() {
+        var e = qr(this.get_type());
+        if (e)
+          return p[this.excPtr >> 2];
+        var t = this.get_adjusted_ptr();
+        return t !== 0 ? t : this.excPtr;
+      }
+    }
+    var Sr = 0, de = (r, e, t) => {
+      var n = new ve(r);
+      throw n.init(e, t), Sr = r, Sr;
+    }, X = {}, or = (r) => {
+      for (; r.length; ) {
+        var e = r.pop(), t = r.pop();
+        t(e);
+      }
+    };
+    function Z(r) {
+      return this.fromWireType(p[r >> 2]);
+    }
+    var M = {}, j = {}, Q = {}, kr, Ur = (r) => {
+      throw new kr(r);
+    }, jr = (r, e, t) => {
+      r.forEach(function(s) {
+        Q[s] = e;
+      });
+      function n(s) {
+        var l = t(s);
+        l.length !== r.length && Ur("Mismatched type converter count");
+        for (var u = 0; u < r.length; ++u)
+          R(r[u], l[u]);
+      }
+      var a = new Array(e.length), o = [], f = 0;
+      e.forEach((s, l) => {
+        j.hasOwnProperty(s) ? a[l] = j[s] : (o.push(s), M.hasOwnProperty(s) || (M[s] = []), M[s].push(() => {
+          a[l] = j[s], ++f, f === o.length && n(a);
+        }));
+      }), o.length === 0 && n(a);
+    }, pe = (r) => {
+      var e = X[r];
+      delete X[r];
+      var t = e.rawConstructor, n = e.rawDestructor, a = e.fields, o = a.map((f) => f.getterReturnType).concat(a.map((f) => f.setterArgumentType));
+      jr([r], o, (f) => {
+        var s = {};
+        return a.forEach((l, u) => {
+          var c = l.fieldName, d = f[u], m = l.getter, A = l.getterContext, E = f[u + a.length], dr = l.setter, S = l.setterContext;
+          s[c] = { read: (L) => d.fromWireType(m(A, L)), write: (L, pr) => {
+            var er = [];
+            dr(S, L, E.toWireType(er, pr)), or(er);
+          } };
+        }), [{ name: e.name, fromWireType: (l) => {
+          var u = {};
+          for (var c in s)
+            u[c] = s[c].read(l);
+          return n(l), u;
+        }, toWireType: (l, u) => {
+          for (var c in s)
+            if (!(c in u))
+              throw new TypeError(`Missing field: "${c}"`);
+          var d = t();
+          for (c in s)
+            s[c].write(d, u[c]);
+          return l !== null && l.push(n, d), d;
+        }, argPackAdvance: F, readValueFromPointer: Z, destructorFunction: n }];
+      });
+    }, ge = (r, e, t, n, a) => {
+    }, he = () => {
+      for (var r = new Array(256), e = 0; e < 256; ++e)
+        r[e] = String.fromCharCode(e);
+      Ir = r;
+    }, Ir, b = (r) => {
+      for (var e = "", t = r; y[t]; )
+        e += Ir[y[t++]];
+      return e;
+    }, Dr, w = (r) => {
+      throw new Dr(r);
+    };
+    function _e(r, e, t = {}) {
+      var n = e.name;
+      if (r || w(`type "${n}" must have a positive integer typeid pointer`), j.hasOwnProperty(r)) {
+        if (t.ignoreDuplicateRegistrations)
+          return;
+        w(`Cannot register type '${n}' twice`);
+      }
+      if (j[r] = e, delete Q[r], M.hasOwnProperty(r)) {
+        var a = M[r];
+        delete M[r], a.forEach((o) => o());
+      }
+    }
+    function R(r, e, t = {}) {
+      if (!("argPackAdvance" in e))
+        throw new TypeError("registerType registeredInstance requires argPackAdvance");
+      return _e(r, e, t);
+    }
+    var F = 8, me = (r, e, t, n) => {
+      e = b(e), R(r, { name: e, fromWireType: function(a) {
+        return !!a;
+      }, toWireType: function(a, o) {
+        return o ? t : n;
+      }, argPackAdvance: F, readValueFromPointer: function(a) {
+        return this.fromWireType(y[a]);
+      }, destructorFunction: null });
+    }, sr = [], W = [], lr = (r) => {
+      r > 9 && --W[r + 1] === 0 && (W[r] = void 0, sr.push(r));
+    }, ye = () => W.length / 2 - 5 - sr.length, be = () => {
+      W.push(0, 1, void 0, 1, null, 1, !0, 1, !1, 1), i.count_emval_handles = ye;
+    }, I = { toValue: (r) => (r || w("Cannot use deleted val. handle = " + r), W[r]), toHandle: (r) => {
+      switch (r) {
+        case void 0:
+          return 2;
+        case null:
+          return 4;
+        case !0:
+          return 6;
+        case !1:
+          return 8;
+        default: {
+          const e = sr.pop() || W.length;
+          return W[e] = r, W[e + 1] = 1, e;
+        }
+      }
+    } }, we = { name: "emscripten::val", fromWireType: (r) => {
+      var e = I.toValue(r);
+      return lr(r), e;
+    }, toWireType: (r, e) => I.toHandle(e), argPackAdvance: F, readValueFromPointer: Z, destructorFunction: null }, Ae = (r) => R(r, we), Te = (r, e) => {
+      switch (e) {
+        case 4:
+          return function(t) {
+            return this.fromWireType(wr[t >> 2]);
+          };
+        case 8:
+          return function(t) {
+            return this.fromWireType(Ar[t >> 3]);
+          };
+        default:
+          throw new TypeError(`invalid float width (${e}): ${r}`);
+      }
+    }, $e = (r, e, t) => {
+      e = b(e), R(r, { name: e, fromWireType: (n) => n, toWireType: (n, a) => a, argPackAdvance: F, readValueFromPointer: Te(e, t), destructorFunction: null });
+    }, fr = (r, e) => Object.defineProperty(e, "name", { value: r });
+    function Ee(r) {
+      for (var e = 1; e < r.length; ++e)
+        if (r[e] !== null && r[e].destructorFunction === void 0)
+          return !0;
+      return !1;
+    }
+    function Ce(r, e, t, n, a, o) {
+      var f = e.length;
+      f < 2 && w("argTypes array size mismatch! Must at least get return value and 'this' types!"), e[1];
+      var s = Ee(e), l = e[0].name !== "void", u = f - 2, c = new Array(u), d = [], m = [], A = function(...E) {
+        E.length !== u && w(`function ${r} called with ${E.length} arguments, expected ${u}`), m.length = 0;
+        var dr;
+        d.length = 1, d[0] = a;
+        for (var S = 0; S < u; ++S)
+          c[S] = e[S + 2].toWireType(m, E[S]), d.push(c[S]);
+        var L = n(...d);
+        function pr(er) {
+          if (s)
+            or(m);
+          else
+            for (var V = 2; V < e.length; V++) {
+              var St = V === 1 ? dr : c[V - 2];
+              e[V].destructorFunction !== null && e[V].destructorFunction(St);
+            }
+          if (l)
+            return e[0].fromWireType(er);
+        }
+        return pr(L);
+      };
+      return fr(r, A);
+    }
+    var Re = (r, e, t) => {
+      if (r[e].overloadTable === void 0) {
+        var n = r[e];
+        r[e] = function(...a) {
+          return r[e].overloadTable.hasOwnProperty(a.length) || w(`Function '${t}' called with an invalid number of arguments (${a.length}) - expects one of (${r[e].overloadTable})!`), r[e].overloadTable[a.length].apply(this, a);
+        }, r[e].overloadTable = [], r[e].overloadTable[n.argCount] = n;
+      }
+    }, Pe = (r, e, t) => {
+      i.hasOwnProperty(r) ? ((t === void 0 || i[r].overloadTable !== void 0 && i[r].overloadTable[t] !== void 0) && w(`Cannot register public name '${r}' twice`), Re(i, r, r), i.hasOwnProperty(t) && w(`Cannot register multiple overloads of a function with the same number of arguments (${t})!`), i[r].overloadTable[t] = e) : (i[r] = e, t !== void 0 && (i[r].numArguments = t));
+    }, Fe = (r, e) => {
+      for (var t = [], n = 0; n < r; n++)
+        t.push(p[e + n * 4 >> 2]);
+      return t;
+    }, We = (r, e, t) => {
+      i.hasOwnProperty(r) || Ur("Replacing nonexistent public symbol"), i[r].overloadTable !== void 0 && t !== void 0 ? i[r].overloadTable[t] = e : (i[r] = e, i[r].argCount = t);
+    }, Se = (r, e, t) => {
+      r = r.replace(/p/g, "i");
+      var n = i["dynCall_" + r];
+      return n(e, ...t);
+    }, Y = [], Or, zr = (r) => {
+      var e = Y[r];
+      return e || (r >= Y.length && (Y.length = r + 1), Y[r] = e = Or.get(r)), e;
+    }, ke = (r, e, t = []) => {
+      if (r.includes("j"))
+        return Se(r, e, t);
+      var n = zr(e)(...t);
+      return n;
+    }, Ue = (r, e) => (...t) => ke(r, e, t), N = (r, e) => {
+      r = b(r);
+      function t() {
+        return r.includes("j") ? Ue(r, e) : zr(e);
+      }
+      var n = t();
+      return typeof n != "function" && w(`unknown function pointer with signature ${r}: ${e}`), n;
+    }, je = (r, e) => {
+      var t = fr(e, function(n) {
+        this.name = e, this.message = n;
+        var a = new Error(n).stack;
+        a !== void 0 && (this.stack = this.toString() + `
+` + a.replace(/^Error(:[^\n]*)?\n/, ""));
+      });
+      return t.prototype = Object.create(r.prototype), t.prototype.constructor = t, t.prototype.toString = function() {
+        return this.message === void 0 ? this.name : `${this.name}: ${this.message}`;
+      }, t;
+    }, Mr, Vr = (r) => {
+      var e = Br(r), t = b(e);
+      return P(e), t;
+    }, Ie = (r, e) => {
+      var t = [], n = {};
+      function a(o) {
+        if (!n[o] && !j[o]) {
+          if (Q[o]) {
+            Q[o].forEach(a);
+            return;
+          }
+          t.push(o), n[o] = !0;
+        }
+      }
+      throw e.forEach(a), new Mr(`${r}: ` + t.map(Vr).join([", "]));
+    }, De = (r) => {
+      r = r.trim();
+      const e = r.indexOf("(");
+      return e !== -1 ? r.substr(0, e) : r;
+    }, Oe = (r, e, t, n, a, o, f) => {
+      var s = Fe(e, t);
+      r = b(r), r = De(r), a = N(n, a), Pe(r, function() {
+        Ie(`Cannot call ${r} due to unbound types`, s);
+      }, e - 1), jr([], s, (l) => {
+        var u = [l[0], null].concat(l.slice(1));
+        return We(r, Ce(r, u, null, a, o), e - 1), [];
+      });
+    }, ze = (r, e, t) => {
+      switch (e) {
+        case 1:
+          return t ? (n) => C[n] : (n) => y[n];
+        case 2:
+          return t ? (n) => x[n >> 1] : (n) => ar[n >> 1];
+        case 4:
+          return t ? (n) => B[n >> 2] : (n) => p[n >> 2];
+        default:
+          throw new TypeError(`invalid integer width (${e}): ${r}`);
+      }
+    }, Me = (r, e, t, n, a) => {
+      e = b(e);
+      var o = (c) => c;
+      if (n === 0) {
+        var f = 32 - 8 * t;
+        o = (c) => c << f >>> f;
+      }
+      var s = e.includes("unsigned"), l = (c, d) => {
+      }, u;
+      s ? u = function(c, d) {
+        return l(d, this.name), d >>> 0;
+      } : u = function(c, d) {
+        return l(d, this.name), d;
+      }, R(r, { name: e, fromWireType: o, toWireType: u, argPackAdvance: F, readValueFromPointer: ze(e, t, n !== 0), destructorFunction: null });
+    }, Ve = (r, e, t) => {
+      var n = [Int8Array, Uint8Array, Int16Array, Uint16Array, Int32Array, Uint32Array, Float32Array, Float64Array], a = n[e];
+      function o(f) {
+        var s = p[f >> 2], l = p[f + 4 >> 2];
+        return new a(C.buffer, l, s);
+      }
+      t = b(t), R(r, { name: t, fromWireType: o, argPackAdvance: F, readValueFromPointer: o }, { ignoreDuplicateRegistrations: !0 });
+    }, He = (r, e, t, n) => {
+      if (!(n > 0)) return 0;
+      for (var a = t, o = t + n - 1, f = 0; f < r.length; ++f) {
+        var s = r.charCodeAt(f);
+        if (s >= 55296 && s <= 57343) {
+          var l = r.charCodeAt(++f);
+          s = 65536 + ((s & 1023) << 10) | l & 1023;
+        }
+        if (s <= 127) {
+          if (t >= o) break;
+          e[t++] = s;
+        } else if (s <= 2047) {
+          if (t + 1 >= o) break;
+          e[t++] = 192 | s >> 6, e[t++] = 128 | s & 63;
+        } else if (s <= 65535) {
+          if (t + 2 >= o) break;
+          e[t++] = 224 | s >> 12, e[t++] = 128 | s >> 6 & 63, e[t++] = 128 | s & 63;
+        } else {
+          if (t + 3 >= o) break;
+          e[t++] = 240 | s >> 18, e[t++] = 128 | s >> 12 & 63, e[t++] = 128 | s >> 6 & 63, e[t++] = 128 | s & 63;
+        }
+      }
+      return e[t] = 0, t - a;
+    }, xe = (r, e, t) => He(r, y, e, t), Be = (r) => {
+      for (var e = 0, t = 0; t < r.length; ++t) {
+        var n = r.charCodeAt(t);
+        n <= 127 ? e++ : n <= 2047 ? e += 2 : n >= 55296 && n <= 57343 ? (e += 4, ++t) : e += 3;
+      }
+      return e;
+    }, Hr = (r, e, t) => {
+      for (var n = e + t, a = ""; !(e >= n); ) {
+        var o = r[e++];
+        if (!o) return a;
+        if (!(o & 128)) {
+          a += String.fromCharCode(o);
+          continue;
+        }
+        var f = r[e++] & 63;
+        if ((o & 224) == 192) {
+          a += String.fromCharCode((o & 31) << 6 | f);
+          continue;
+        }
+        var s = r[e++] & 63;
+        if ((o & 240) == 224 ? o = (o & 15) << 12 | f << 6 | s : o = (o & 7) << 18 | f << 12 | s << 6 | r[e++] & 63, o < 65536)
+          a += String.fromCharCode(o);
+        else {
+          var l = o - 65536;
+          a += String.fromCharCode(55296 | l >> 10, 56320 | l & 1023);
+        }
+      }
+      return a;
+    }, qe = (r, e) => r ? Hr(y, r, e) : "", Ne = (r, e) => {
+      e = b(e);
+      var t = e === "std::string";
+      R(r, { name: e, fromWireType(n) {
+        var a = p[n >> 2], o = n + 4, f;
+        if (t)
+          for (var s = o, l = 0; l <= a; ++l) {
+            var u = o + l;
+            if (l == a || y[u] == 0) {
+              var c = u - s, d = qe(s, c);
+              f === void 0 ? f = d : (f += "\0", f += d), s = u + 1;
+            }
+          }
+        else {
+          for (var m = new Array(a), l = 0; l < a; ++l)
+            m[l] = String.fromCharCode(y[o + l]);
+          f = m.join("");
+        }
+        return P(n), f;
+      }, toWireType(n, a) {
+        a instanceof ArrayBuffer && (a = new Uint8Array(a));
+        var o, f = typeof a == "string";
+        f || a instanceof Uint8Array || a instanceof Uint8ClampedArray || a instanceof Int8Array || w("Cannot pass non-string to std::string"), t && f ? o = Be(a) : o = a.length;
+        var s = vr(4 + o + 1), l = s + 4;
+        if (p[s >> 2] = o, t && f)
+          xe(a, l, o + 1);
+        else if (f)
+          for (var u = 0; u < o; ++u) {
+            var c = a.charCodeAt(u);
+            c > 255 && (P(l), w("String has UTF-16 code units that do not fit in 8 bits")), y[l + u] = c;
+          }
+        else
+          for (var u = 0; u < o; ++u)
+            y[l + u] = a[u];
+        return n !== null && n.push(P, s), s;
+      }, argPackAdvance: F, readValueFromPointer: Z, destructorFunction(n) {
+        P(n);
+      } });
+    }, Ge = (r, e) => {
+      for (var t = "", n = 0; !(n >= e / 2); ++n) {
+        var a = x[r + n * 2 >> 1];
+        if (a == 0) break;
+        t += String.fromCharCode(a);
+      }
+      return t;
+    }, Le = (r, e, t) => {
+      if (t ?? (t = 2147483647), t < 2) return 0;
+      t -= 2;
+      for (var n = e, a = t < r.length * 2 ? t / 2 : r.length, o = 0; o < a; ++o) {
+        var f = r.charCodeAt(o);
+        x[e >> 1] = f, e += 2;
+      }
+      return x[e >> 1] = 0, e - n;
+    }, Je = (r) => r.length * 2, Ke = (r, e) => {
+      for (var t = 0, n = ""; !(t >= e / 4); ) {
+        var a = B[r + t * 4 >> 2];
+        if (a == 0) break;
+        if (++t, a >= 65536) {
+          var o = a - 65536;
+          n += String.fromCharCode(55296 | o >> 10, 56320 | o & 1023);
+        } else
+          n += String.fromCharCode(a);
+      }
+      return n;
+    }, Xe = (r, e, t) => {
+      if (t ?? (t = 2147483647), t < 4) return 0;
+      for (var n = e, a = n + t - 4, o = 0; o < r.length; ++o) {
+        var f = r.charCodeAt(o);
+        if (f >= 55296 && f <= 57343) {
+          var s = r.charCodeAt(++o);
+          f = 65536 + ((f & 1023) << 10) | s & 1023;
+        }
+        if (B[e >> 2] = f, e += 4, e + 4 > a) break;
+      }
+      return B[e >> 2] = 0, e - n;
+    }, Ze = (r) => {
+      for (var e = 0, t = 0; t < r.length; ++t) {
+        var n = r.charCodeAt(t);
+        n >= 55296 && n <= 57343 && ++t, e += 4;
+      }
+      return e;
+    }, Qe = (r, e, t) => {
+      t = b(t);
+      var n, a, o, f;
+      e === 2 ? (n = Ge, a = Le, f = Je, o = (s) => ar[s >> 1]) : e === 4 && (n = Ke, a = Xe, f = Ze, o = (s) => p[s >> 2]), R(r, { name: t, fromWireType: (s) => {
+        for (var l = p[s >> 2], u, c = s + 4, d = 0; d <= l; ++d) {
+          var m = s + 4 + d * e;
+          if (d == l || o(m) == 0) {
+            var A = m - c, E = n(c, A);
+            u === void 0 ? u = E : (u += "\0", u += E), c = m + e;
+          }
+        }
+        return P(s), u;
+      }, toWireType: (s, l) => {
+        typeof l != "string" && w(`Cannot pass non-string to C++ string type ${t}`);
+        var u = f(l), c = vr(4 + u + e);
+        return p[c >> 2] = u / e, a(l, c + 4, u + e), s !== null && s.push(P, c), c;
+      }, argPackAdvance: F, readValueFromPointer: Z, destructorFunction(s) {
+        P(s);
+      } });
+    }, Ye = (r, e, t, n, a, o) => {
+      X[r] = { name: b(e), rawConstructor: N(t, n), rawDestructor: N(a, o), fields: [] };
+    }, rt = (r, e, t, n, a, o, f, s, l, u) => {
+      X[r].fields.push({ fieldName: b(e), getterReturnType: t, getter: N(n, a), getterContext: o, setterArgumentType: f, setter: N(s, l), setterContext: u });
+    }, et = (r, e) => {
+      e = b(e), R(r, { isVoid: !0, name: e, argPackAdvance: 0, fromWireType: () => {
+      }, toWireType: (t, n) => {
+      } });
+    }, tt = (r, e, t) => y.copyWithin(r, e, e + t), ur = [], nt = (r, e, t, n) => (r = ur[r], e = I.toValue(e), r(null, e, t, n)), at = {}, it = (r) => {
+      var e = at[r];
+      return e === void 0 ? b(r) : e;
+    }, xr = () => {
+      if (typeof globalThis == "object")
+        return globalThis;
+      function r(e) {
+        e.$$$embind_global$$$ = e;
+        var t = typeof $$$embind_global$$$ == "object" && e.$$$embind_global$$$ == e;
+        return t || delete e.$$$embind_global$$$, t;
+      }
+      if (typeof $$$embind_global$$$ == "object" || (typeof global == "object" && r(global) ? $$$embind_global$$$ = global : typeof self == "object" && r(self) && ($$$embind_global$$$ = self), typeof $$$embind_global$$$ == "object"))
+        return $$$embind_global$$$;
+      throw Error("unable to get global object.");
+    }, ot = (r) => r === 0 ? I.toHandle(xr()) : (r = it(r), I.toHandle(xr()[r])), st = (r) => {
+      var e = ur.length;
+      return ur.push(r), e;
+    }, lt = (r, e) => {
+      var t = j[r];
+      return t === void 0 && w(`${e} has unknown type ${Vr(r)}`), t;
+    }, ft = (r, e) => {
+      for (var t = new Array(r), n = 0; n < r; ++n)
+        t[n] = lt(p[e + n * 4 >> 2], "parameter " + n);
+      return t;
+    }, ut = Reflect.construct, ct = (r, e, t) => {
+      var n = [], a = r.toWireType(n, t);
+      return n.length && (p[e >> 2] = I.toHandle(n)), a;
+    }, vt = (r, e, t) => {
+      var n = ft(r, e), a = n.shift();
+      r--;
+      var o = new Array(r), f = (l, u, c, d) => {
+        for (var m = 0, A = 0; A < r; ++A)
+          o[A] = n[A].readValueFromPointer(d + m), m += n[A].argPackAdvance;
+        var E = t === 1 ? ut(u, o) : u.apply(l, o);
+        return ct(a, c, E);
+      }, s = `methodCaller<(${n.map((l) => l.name).join(", ")}) => ${a.name}>`;
+      return st(fr(s, f));
+    }, dt = (r) => {
+      var e = I.toValue(r);
+      or(e), lr(r);
+    }, pt = () => {
+      Rr("");
+    }, gt = () => 2147483648, ht = (r) => {
+      var e = K.buffer, t = (r - e.byteLength + 65535) / 65536;
+      try {
+        return K.grow(t), Tr(), 1;
+      } catch {
+      }
+    }, _t = (r) => {
+      var e = y.length;
+      r >>>= 0;
+      var t = gt();
+      if (r > t)
+        return !1;
+      for (var n = (l, u) => l + (u - l % u) % u, a = 1; a <= 4; a *= 2) {
+        var o = e * (1 + 0.2 / a);
+        o = Math.min(o, r + 100663296);
+        var f = Math.min(t, n(Math.max(r, o), 65536)), s = ht(f);
+        if (s)
+          return !0;
+      }
+      return !1;
+    }, cr = {}, mt = () => _r || "./this.program", G = () => {
+      if (!G.strings) {
+        var r = (typeof navigator == "object" && navigator.languages && navigator.languages[0] || "C").replace("-", "_") + ".UTF-8", e = { USER: "web_user", LOGNAME: "web_user", PATH: "/", PWD: "/", HOME: "/home/web_user", LANG: r, _: mt() };
+        for (var t in cr)
+          cr[t] === void 0 ? delete e[t] : e[t] = cr[t];
+        var n = [];
+        for (var t in e)
+          n.push(`${t}=${e[t]}`);
+        G.strings = n;
+      }
+      return G.strings;
+    }, yt = (r, e) => {
+      for (var t = 0; t < r.length; ++t)
+        C[e++] = r.charCodeAt(t);
+      C[e] = 0;
+    }, bt = (r, e) => {
+      var t = 0;
+      return G().forEach((n, a) => {
+        var o = e + t;
+        p[r + a * 4 >> 2] = o, yt(n, o), t += n.length + 1;
+      }), 0;
+    }, wt = (r, e) => {
+      var t = G();
+      p[r >> 2] = t.length;
+      var n = 0;
+      return t.forEach((a) => n += a.length + 1), p[e >> 2] = n, 0;
+    }, At = (r) => {
+      mr(r, new ce(r));
+    }, Tt = (r, e) => {
+      At(r);
+    }, $t = Tt, Et = (r) => 52;
+    function Ct(r, e, t, n, a) {
+      return 70;
+    }
+    var Rt = [null, [], []], Pt = (r, e) => {
+      var t = Rt[r];
+      e === 0 || e === 10 ? ((r === 1 ? Qr : z)(Hr(t, 0)), t.length = 0) : t.push(e);
+    }, Ft = (r, e, t, n) => {
+      for (var a = 0, o = 0; o < t; o++) {
+        var f = p[e >> 2], s = p[e + 4 >> 2];
+        e += 8;
+        for (var l = 0; l < s; l++)
+          Pt(r, y[f + l]);
+        a += s;
+      }
+      return p[n >> 2] = a, 0;
+    };
+    kr = i.InternalError = class extends Error {
+      constructor(e) {
+        super(e), this.name = "InternalError";
+      }
+    }, he(), Dr = i.BindingError = class extends Error {
+      constructor(e) {
+        super(e), this.name = "BindingError";
+      }
+    }, be(), Mr = i.UnboundTypeError = je(Error, "UnboundTypeError");
+    var Wt = { j: de, k: pe, n: ge, h: me, z: Ae, f: $e, e: Oe, c: Me, a: Ve, g: Ne, d: Qe, l: Ye, b: rt, i: et, s: tt, y: nt, u: lr, A: ot, x: vt, w: dt, o: pt, p: _t, q: bt, r: wt, B: $t, t: Et, m: Ct, v: Ft }, $ = ue(), Br = (r) => (Br = $.E)(r), vr = (r) => (vr = $.F)(r), P = (r) => (P = $.G)(r), qr = (r) => (qr = $.I)(r);
+    i.dynCall_jiji = (r, e, t, n, a) => (i.dynCall_jiji = $.J)(r, e, t, n, a);
+    var rr;
+    q = function r() {
+      rr || Nr(), rr || (q = r);
+    };
+    function Nr() {
+      if (k > 0 || (Yr(), k > 0))
+        return;
+      function r() {
+        rr || (rr = !0, i.calledRun = !0, !br && (re(), _(i), i.onRuntimeInitialized && i.onRuntimeInitialized(), ee()));
+      }
+      i.setStatus ? (i.setStatus("Running..."), setTimeout(function() {
+        setTimeout(function() {
+          i.setStatus("");
+        }, 1), r();
+      }, 1)) : r();
+    }
+    if (i.preInit)
+      for (typeof i.preInit == "function" && (i.preInit = [i.preInit]); i.preInit.length > 0; )
+        i.preInit.pop()();
+    return Nr(), O;
+  };
+})();
+const Ut = {
+  quality: 75,
+  baseline: !1,
+  arithmetic: !1,
+  progressive: !0,
+  optimize_coding: !0,
+  smoothing: 0,
+  color_space: 3,
+  quant_table: 3,
+  trellis_multipass: !1,
+  trellis_opt_zero: !1,
+  trellis_opt_table: !1,
+  trellis_loops: 1,
+  auto_subsample: !0,
+  chroma_subsample: 2,
+  separate_chroma_quality: !1,
+  chroma_quality: 75
+};
+function jt(v, g, i = {}) {
+  let _;
+  return g && (_ = (h, O) => {
+    const tr = new WebAssembly.Instance(g, h);
+    return O(tr), tr.exports;
+  }), v({
+    // Just to be safe, don't automatically invoke any wasm functions
+    noInitialRun: !0,
+    instantiateWasm: _,
+    ...i
+  });
+}
+let gr;
+async function Lr(v, g) {
+  gr = jt(kt, v, g);
+}
+async function It(v, g = {}) {
+  gr || Lr();
+  const i = await gr, _ = { ...Ut, ...g };
+  return i.encode(v.data, v.width, v.height, _).buffer;
+}
+class Dt extends Error {
+  constructor(g, i, _) {
+    super(g), this.taskId = i, this.cause = _;
+  }
+}
+const Ot = {
+  quality: 75,
+  progressive: !0,
+  optimize_coding: !0,
+  smoothing: 0,
+  color_space: 3,
+  // YCbCr
+  quant_table: 3,
+  trellis_multipass: !1,
+  trellis_opt_table: !0,
+  trellis_opt_zero: !0,
+  trellis_loops: 0,
+  auto_subsample: !1,
+  chroma_subsample: 2,
+  separate_chroma_quality: !1,
+  chroma_quality: 75,
+  arithmetic: !1,
+  baseline: !1
+};
+let Gr = !1;
+const D = new OffscreenCanvas(1, 1);
+self.onmessage = async function(v) {
+  if ("mozjpegWasm" in v.data.data) {
+    console.debug("worker: received MozJPEG WASM module");
+    const h = await WebAssembly.compile(v.data.data.mozjpegWasm);
+    await Lr(h), Gr = !0, console.debug("worker: initialized MozJPEG encoder"), self.postMessage({
+      input: v.data,
+      result: {}
+    });
+    return;
+  }
+  const g = v.data.data;
+  console.debug("worker: received optimization task", v.data.id, g);
+  let i;
+  try {
+    if (g.method === "mozjpeg") {
+      if (!Gr)
+        throw new Error("MozJPEG encoder not initialized");
+      i = await zt(g);
+    } else if (g.method === "browser")
+      i = await Mt(g);
+    else
+      throw new Error("Unsupported optimization method");
+  } catch (h) {
+    console.error(`Failed to optimize image: ${h}`, v.data.id, h), self.postMessage(
+      new Dt(
+        `Failed to optimize image: ${h}`,
+        v.data.id,
+        h
+      )
+    );
+    return;
+  }
+  const _ = {
+    input: v.data,
+    result: {
+      jpegData: i,
+      sizeFactor: i.length / g.imageData.length
+    }
+  };
+  self.postMessage(_), console.debug(`worker optimized image with factor ${_.result.sizeFactor}`);
+};
+function Jr(v, g) {
+  return new Promise(async (i, _) => {
+    try {
+      const h = await createImageBitmap(
+        new Blob([v], { type: g })
+      );
+      D.width = h.width, D.height = h.height;
+      const O = D.getContext("2d");
+      if (!O) {
+        _(new Error("Could not get 2D context"));
+        return;
+      }
+      O.drawImage(h, 0, 0), i();
+    } catch (h) {
+      _(h);
+      return;
+    }
+  });
+}
+async function zt(v) {
+  await Jr(v.imageData, v.imageFormat);
+  const g = D.getContext("2d").getImageData(0, 0, D.width, D.height), i = await It(g, {
+    ...Ot,
+    ...v
+  });
+  return new Uint8Array(i);
+}
+async function Mt(v) {
+  await Jr(v.imageData, v.imageFormat);
+  const g = await D.convertToBlob({
+    type: "image/jpeg",
+    quality: v.quality / 100
+  });
+  return new Uint8Array(await g.arrayBuffer());
+}
+//# sourceMappingURL=optimization.worker-Ra1-MoAS.js.map
diff --git a/node_modules/pdiiif/dist/assets/optimization.worker-Ra1-MoAS.js.map b/node_modules/pdiiif/dist/assets/optimization.worker-Ra1-MoAS.js.map
new file mode 100644
index 0000000..189404c
--- /dev/null
+++ b/node_modules/pdiiif/dist/assets/optimization.worker-Ra1-MoAS.js.map
@@ -0,0 +1 @@
+{"version":3,"file":"optimization.worker-Ra1-MoAS.js","sources":["../../node_modules/.pnpm/@jsquash+jpeg@1.5.0/node_modules/@jsquash/jpeg/codec/enc/mozjpeg_enc.js","../../node_modules/.pnpm/@jsquash+jpeg@1.5.0/node_modules/@jsquash/jpeg/meta.js","../../node_modules/.pnpm/@jsquash+jpeg@1.5.0/node_modules/@jsquash/jpeg/utils.js","../../node_modules/.pnpm/@jsquash+jpeg@1.5.0/node_modules/@jsquash/jpeg/encode.js","../src/optimization.ts","../src/optimization.worker.ts"],"sourcesContent":["\nvar Module = (() => {\n  var _scriptDir = import.meta.url;\n  \n  return (\nfunction(moduleArg = {}) {\n\nvar Module=moduleArg;var readyPromiseResolve,readyPromiseReject;var readyPromise=new Promise((resolve,reject)=>{readyPromiseResolve=resolve;readyPromiseReject=reject});const isServiceWorker=globalThis.ServiceWorkerGlobalScope!==undefined;const isRunningInCloudFlareWorkers=isServiceWorker&&typeof self!==\"undefined\"&&globalThis.caches&&globalThis.caches.default!==undefined;const isRunningInNode=typeof process===\"object\"&&process.release&&process.release.name===\"node\";if(isRunningInCloudFlareWorkers||isRunningInNode){if(!globalThis.ImageData){globalThis.ImageData=class ImageData{constructor(data,width,height){this.data=data;this.width=width;this.height=height}}}if(import.meta.url===undefined){import.meta.url=\"https://localhost\"}if(typeof self!==\"undefined\"&&self.location===undefined){self.location={href:\"\"}}}var moduleOverrides=Object.assign({},Module);var arguments_=[];var thisProgram=\"./this.program\";var quit_=(status,toThrow)=>{throw toThrow};var ENVIRONMENT_IS_WEB=typeof window==\"object\";var ENVIRONMENT_IS_WORKER=typeof importScripts==\"function\";var ENVIRONMENT_IS_NODE=typeof process==\"object\"&&typeof process.versions==\"object\"&&typeof process.versions.node==\"string\";var scriptDirectory=\"\";function locateFile(path){if(Module[\"locateFile\"]){return Module[\"locateFile\"](path,scriptDirectory)}return scriptDirectory+path}var read_,readAsync,readBinary;if(ENVIRONMENT_IS_WEB||ENVIRONMENT_IS_WORKER){if(ENVIRONMENT_IS_WORKER){scriptDirectory=self.location.href}else if(typeof document!=\"undefined\"&&document.currentScript){scriptDirectory=document.currentScript.src}if(_scriptDir){scriptDirectory=_scriptDir}if(scriptDirectory.startsWith(\"blob:\")){scriptDirectory=\"\"}else{scriptDirectory=scriptDirectory.substr(0,scriptDirectory.replace(/[?#].*/,\"\").lastIndexOf(\"/\")+1)}{read_=url=>{var xhr=new XMLHttpRequest;xhr.open(\"GET\",url,false);xhr.send(null);return xhr.responseText};if(ENVIRONMENT_IS_WORKER){readBinary=url=>{var xhr=new XMLHttpRequest;xhr.open(\"GET\",url,false);xhr.responseType=\"arraybuffer\";xhr.send(null);return new Uint8Array(xhr.response)}}readAsync=(url,onload,onerror)=>{var xhr=new XMLHttpRequest;xhr.open(\"GET\",url,true);xhr.responseType=\"arraybuffer\";xhr.onload=()=>{if(xhr.status==200||xhr.status==0&&xhr.response){onload(xhr.response);return}onerror()};xhr.onerror=onerror;xhr.send(null)}}}else{}var out=Module[\"print\"]||console.log.bind(console);var err=Module[\"printErr\"]||console.error.bind(console);Object.assign(Module,moduleOverrides);moduleOverrides=null;if(Module[\"arguments\"])arguments_=Module[\"arguments\"];if(Module[\"thisProgram\"])thisProgram=Module[\"thisProgram\"];if(Module[\"quit\"])quit_=Module[\"quit\"];var wasmBinary;if(Module[\"wasmBinary\"])wasmBinary=Module[\"wasmBinary\"];var wasmMemory;var ABORT=false;var EXITSTATUS;var HEAP8,HEAPU8,HEAP16,HEAPU16,HEAP32,HEAPU32,HEAPF32,HEAPF64;function updateMemoryViews(){var b=wasmMemory.buffer;Module[\"HEAP8\"]=HEAP8=new Int8Array(b);Module[\"HEAP16\"]=HEAP16=new Int16Array(b);Module[\"HEAPU8\"]=HEAPU8=new Uint8Array(b);Module[\"HEAPU16\"]=HEAPU16=new Uint16Array(b);Module[\"HEAP32\"]=HEAP32=new Int32Array(b);Module[\"HEAPU32\"]=HEAPU32=new Uint32Array(b);Module[\"HEAPF32\"]=HEAPF32=new Float32Array(b);Module[\"HEAPF64\"]=HEAPF64=new Float64Array(b)}var __ATPRERUN__=[];var __ATINIT__=[];var __ATPOSTRUN__=[];var runtimeInitialized=false;function preRun(){if(Module[\"preRun\"]){if(typeof Module[\"preRun\"]==\"function\")Module[\"preRun\"]=[Module[\"preRun\"]];while(Module[\"preRun\"].length){addOnPreRun(Module[\"preRun\"].shift())}}callRuntimeCallbacks(__ATPRERUN__)}function initRuntime(){runtimeInitialized=true;callRuntimeCallbacks(__ATINIT__)}function postRun(){if(Module[\"postRun\"]){if(typeof Module[\"postRun\"]==\"function\")Module[\"postRun\"]=[Module[\"postRun\"]];while(Module[\"postRun\"].length){addOnPostRun(Module[\"postRun\"].shift())}}callRuntimeCallbacks(__ATPOSTRUN__)}function addOnPreRun(cb){__ATPRERUN__.unshift(cb)}function addOnInit(cb){__ATINIT__.unshift(cb)}function addOnPostRun(cb){__ATPOSTRUN__.unshift(cb)}var runDependencies=0;var runDependencyWatcher=null;var dependenciesFulfilled=null;function addRunDependency(id){runDependencies++;Module[\"monitorRunDependencies\"]?.(runDependencies)}function removeRunDependency(id){runDependencies--;Module[\"monitorRunDependencies\"]?.(runDependencies);if(runDependencies==0){if(runDependencyWatcher!==null){clearInterval(runDependencyWatcher);runDependencyWatcher=null}if(dependenciesFulfilled){var callback=dependenciesFulfilled;dependenciesFulfilled=null;callback()}}}function abort(what){Module[\"onAbort\"]?.(what);what=\"Aborted(\"+what+\")\";err(what);ABORT=true;EXITSTATUS=1;what+=\". Build with -sASSERTIONS for more info.\";var e=new WebAssembly.RuntimeError(what);readyPromiseReject(e);throw e}var dataURIPrefix=\"data:application/octet-stream;base64,\";var isDataURI=filename=>filename.startsWith(dataURIPrefix);var wasmBinaryFile;if(Module[\"locateFile\"]){wasmBinaryFile=\"mozjpeg_enc.wasm\";if(!isDataURI(wasmBinaryFile)){wasmBinaryFile=locateFile(wasmBinaryFile)}}else{wasmBinaryFile=new URL(\"mozjpeg_enc.wasm\",import.meta.url).href}function getBinarySync(file){if(file==wasmBinaryFile&&wasmBinary){return new Uint8Array(wasmBinary)}if(readBinary){return readBinary(file)}throw\"both async and sync fetching of the wasm failed\"}function getBinaryPromise(binaryFile){if(!wasmBinary&&(ENVIRONMENT_IS_WEB||ENVIRONMENT_IS_WORKER)){if(typeof fetch==\"function\"){return fetch(binaryFile,{credentials:\"same-origin\"}).then(response=>{if(!response[\"ok\"]){throw`failed to load wasm binary file at '${binaryFile}'`}return response[\"arrayBuffer\"]()}).catch(()=>getBinarySync(binaryFile))}}return Promise.resolve().then(()=>getBinarySync(binaryFile))}function instantiateArrayBuffer(binaryFile,imports,receiver){return getBinaryPromise(binaryFile).then(binary=>WebAssembly.instantiate(binary,imports)).then(receiver,reason=>{err(`failed to asynchronously prepare wasm: ${reason}`);abort(reason)})}function instantiateAsync(binary,binaryFile,imports,callback){if(!binary&&typeof WebAssembly.instantiateStreaming==\"function\"&&!isDataURI(binaryFile)&&typeof fetch==\"function\"){return fetch(binaryFile,{credentials:\"same-origin\"}).then(response=>{var result=WebAssembly.instantiateStreaming(response,imports);return result.then(callback,function(reason){err(`wasm streaming compile failed: ${reason}`);err(\"falling back to ArrayBuffer instantiation\");return instantiateArrayBuffer(binaryFile,imports,callback)})})}return instantiateArrayBuffer(binaryFile,imports,callback)}function createWasm(){var info={\"a\":wasmImports};function receiveInstance(instance,module){wasmExports=instance.exports;wasmMemory=wasmExports[\"C\"];updateMemoryViews();wasmTable=wasmExports[\"H\"];addOnInit(wasmExports[\"D\"]);removeRunDependency(\"wasm-instantiate\");return wasmExports}addRunDependency(\"wasm-instantiate\");function receiveInstantiationResult(result){receiveInstance(result[\"instance\"])}if(Module[\"instantiateWasm\"]){try{return Module[\"instantiateWasm\"](info,receiveInstance)}catch(e){err(`Module.instantiateWasm callback failed with error: ${e}`);readyPromiseReject(e)}}instantiateAsync(wasmBinary,wasmBinaryFile,info,receiveInstantiationResult).catch(readyPromiseReject);return{}}function ExitStatus(status){this.name=\"ExitStatus\";this.message=`Program terminated with exit(${status})`;this.status=status}var callRuntimeCallbacks=callbacks=>{while(callbacks.length>0){callbacks.shift()(Module)}};var noExitRuntime=Module[\"noExitRuntime\"]||true;class ExceptionInfo{constructor(excPtr){this.excPtr=excPtr;this.ptr=excPtr-24}set_type(type){HEAPU32[this.ptr+4>>2]=type}get_type(){return HEAPU32[this.ptr+4>>2]}set_destructor(destructor){HEAPU32[this.ptr+8>>2]=destructor}get_destructor(){return HEAPU32[this.ptr+8>>2]}set_caught(caught){caught=caught?1:0;HEAP8[this.ptr+12]=caught}get_caught(){return HEAP8[this.ptr+12]!=0}set_rethrown(rethrown){rethrown=rethrown?1:0;HEAP8[this.ptr+13]=rethrown}get_rethrown(){return HEAP8[this.ptr+13]!=0}init(type,destructor){this.set_adjusted_ptr(0);this.set_type(type);this.set_destructor(destructor)}set_adjusted_ptr(adjustedPtr){HEAPU32[this.ptr+16>>2]=adjustedPtr}get_adjusted_ptr(){return HEAPU32[this.ptr+16>>2]}get_exception_ptr(){var isPointer=___cxa_is_pointer_type(this.get_type());if(isPointer){return HEAPU32[this.excPtr>>2]}var adjusted=this.get_adjusted_ptr();if(adjusted!==0)return adjusted;return this.excPtr}}var exceptionLast=0;var uncaughtExceptionCount=0;var ___cxa_throw=(ptr,type,destructor)=>{var info=new ExceptionInfo(ptr);info.init(type,destructor);exceptionLast=ptr;uncaughtExceptionCount++;throw exceptionLast};var structRegistrations={};var runDestructors=destructors=>{while(destructors.length){var ptr=destructors.pop();var del=destructors.pop();del(ptr)}};function readPointer(pointer){return this[\"fromWireType\"](HEAPU32[pointer>>2])}var awaitingDependencies={};var registeredTypes={};var typeDependencies={};var InternalError;var throwInternalError=message=>{throw new InternalError(message)};var whenDependentTypesAreResolved=(myTypes,dependentTypes,getTypeConverters)=>{myTypes.forEach(function(type){typeDependencies[type]=dependentTypes});function onComplete(typeConverters){var myTypeConverters=getTypeConverters(typeConverters);if(myTypeConverters.length!==myTypes.length){throwInternalError(\"Mismatched type converter count\")}for(var i=0;i<myTypes.length;++i){registerType(myTypes[i],myTypeConverters[i])}}var typeConverters=new Array(dependentTypes.length);var unregisteredTypes=[];var registered=0;dependentTypes.forEach((dt,i)=>{if(registeredTypes.hasOwnProperty(dt)){typeConverters[i]=registeredTypes[dt]}else{unregisteredTypes.push(dt);if(!awaitingDependencies.hasOwnProperty(dt)){awaitingDependencies[dt]=[]}awaitingDependencies[dt].push(()=>{typeConverters[i]=registeredTypes[dt];++registered;if(registered===unregisteredTypes.length){onComplete(typeConverters)}})}});if(0===unregisteredTypes.length){onComplete(typeConverters)}};var __embind_finalize_value_object=structType=>{var reg=structRegistrations[structType];delete structRegistrations[structType];var rawConstructor=reg.rawConstructor;var rawDestructor=reg.rawDestructor;var fieldRecords=reg.fields;var fieldTypes=fieldRecords.map(field=>field.getterReturnType).concat(fieldRecords.map(field=>field.setterArgumentType));whenDependentTypesAreResolved([structType],fieldTypes,fieldTypes=>{var fields={};fieldRecords.forEach((field,i)=>{var fieldName=field.fieldName;var getterReturnType=fieldTypes[i];var getter=field.getter;var getterContext=field.getterContext;var setterArgumentType=fieldTypes[i+fieldRecords.length];var setter=field.setter;var setterContext=field.setterContext;fields[fieldName]={read:ptr=>getterReturnType[\"fromWireType\"](getter(getterContext,ptr)),write:(ptr,o)=>{var destructors=[];setter(setterContext,ptr,setterArgumentType[\"toWireType\"](destructors,o));runDestructors(destructors)}}});return[{name:reg.name,\"fromWireType\":ptr=>{var rv={};for(var i in fields){rv[i]=fields[i].read(ptr)}rawDestructor(ptr);return rv},\"toWireType\":(destructors,o)=>{for(var fieldName in fields){if(!(fieldName in o)){throw new TypeError(`Missing field: \"${fieldName}\"`)}}var ptr=rawConstructor();for(fieldName in fields){fields[fieldName].write(ptr,o[fieldName])}if(destructors!==null){destructors.push(rawDestructor,ptr)}return ptr},\"argPackAdvance\":GenericWireTypeSize,\"readValueFromPointer\":readPointer,destructorFunction:rawDestructor}]})};var __embind_register_bigint=(primitiveType,name,size,minRange,maxRange)=>{};var embind_init_charCodes=()=>{var codes=new Array(256);for(var i=0;i<256;++i){codes[i]=String.fromCharCode(i)}embind_charCodes=codes};var embind_charCodes;var readLatin1String=ptr=>{var ret=\"\";var c=ptr;while(HEAPU8[c]){ret+=embind_charCodes[HEAPU8[c++]]}return ret};var BindingError;var throwBindingError=message=>{throw new BindingError(message)};function sharedRegisterType(rawType,registeredInstance,options={}){var name=registeredInstance.name;if(!rawType){throwBindingError(`type \"${name}\" must have a positive integer typeid pointer`)}if(registeredTypes.hasOwnProperty(rawType)){if(options.ignoreDuplicateRegistrations){return}else{throwBindingError(`Cannot register type '${name}' twice`)}}registeredTypes[rawType]=registeredInstance;delete typeDependencies[rawType];if(awaitingDependencies.hasOwnProperty(rawType)){var callbacks=awaitingDependencies[rawType];delete awaitingDependencies[rawType];callbacks.forEach(cb=>cb())}}function registerType(rawType,registeredInstance,options={}){if(!(\"argPackAdvance\"in registeredInstance)){throw new TypeError(\"registerType registeredInstance requires argPackAdvance\")}return sharedRegisterType(rawType,registeredInstance,options)}var GenericWireTypeSize=8;var __embind_register_bool=(rawType,name,trueValue,falseValue)=>{name=readLatin1String(name);registerType(rawType,{name:name,\"fromWireType\":function(wt){return!!wt},\"toWireType\":function(destructors,o){return o?trueValue:falseValue},\"argPackAdvance\":GenericWireTypeSize,\"readValueFromPointer\":function(pointer){return this[\"fromWireType\"](HEAPU8[pointer])},destructorFunction:null})};var emval_freelist=[];var emval_handles=[];var __emval_decref=handle=>{if(handle>9&&0===--emval_handles[handle+1]){emval_handles[handle]=undefined;emval_freelist.push(handle)}};var count_emval_handles=()=>emval_handles.length/2-5-emval_freelist.length;var init_emval=()=>{emval_handles.push(0,1,undefined,1,null,1,true,1,false,1);Module[\"count_emval_handles\"]=count_emval_handles};var Emval={toValue:handle=>{if(!handle){throwBindingError(\"Cannot use deleted val. handle = \"+handle)}return emval_handles[handle]},toHandle:value=>{switch(value){case undefined:return 2;case null:return 4;case true:return 6;case false:return 8;default:{const handle=emval_freelist.pop()||emval_handles.length;emval_handles[handle]=value;emval_handles[handle+1]=1;return handle}}}};var EmValType={name:\"emscripten::val\",\"fromWireType\":handle=>{var rv=Emval.toValue(handle);__emval_decref(handle);return rv},\"toWireType\":(destructors,value)=>Emval.toHandle(value),\"argPackAdvance\":GenericWireTypeSize,\"readValueFromPointer\":readPointer,destructorFunction:null};var __embind_register_emval=rawType=>registerType(rawType,EmValType);var floatReadValueFromPointer=(name,width)=>{switch(width){case 4:return function(pointer){return this[\"fromWireType\"](HEAPF32[pointer>>2])};case 8:return function(pointer){return this[\"fromWireType\"](HEAPF64[pointer>>3])};default:throw new TypeError(`invalid float width (${width}): ${name}`)}};var __embind_register_float=(rawType,name,size)=>{name=readLatin1String(name);registerType(rawType,{name:name,\"fromWireType\":value=>value,\"toWireType\":(destructors,value)=>value,\"argPackAdvance\":GenericWireTypeSize,\"readValueFromPointer\":floatReadValueFromPointer(name,size),destructorFunction:null})};var createNamedFunction=(name,body)=>Object.defineProperty(body,\"name\",{value:name});function usesDestructorStack(argTypes){for(var i=1;i<argTypes.length;++i){if(argTypes[i]!==null&&argTypes[i].destructorFunction===undefined){return true}}return false}function craftInvokerFunction(humanName,argTypes,classType,cppInvokerFunc,cppTargetFunc,isAsync){var argCount=argTypes.length;if(argCount<2){throwBindingError(\"argTypes array size mismatch! Must at least get return value and 'this' types!\")}var isClassMethodFunc=argTypes[1]!==null&&classType!==null;var needsDestructorStack=usesDestructorStack(argTypes);var returns=argTypes[0].name!==\"void\";var expectedArgCount=argCount-2;var argsWired=new Array(expectedArgCount);var invokerFuncArgs=[];var destructors=[];var invokerFn=function(...args){if(args.length!==expectedArgCount){throwBindingError(`function ${humanName} called with ${args.length} arguments, expected ${expectedArgCount}`)}destructors.length=0;var thisWired;invokerFuncArgs.length=isClassMethodFunc?2:1;invokerFuncArgs[0]=cppTargetFunc;if(isClassMethodFunc){thisWired=argTypes[1][\"toWireType\"](destructors,this);invokerFuncArgs[1]=thisWired}for(var i=0;i<expectedArgCount;++i){argsWired[i]=argTypes[i+2][\"toWireType\"](destructors,args[i]);invokerFuncArgs.push(argsWired[i])}var rv=cppInvokerFunc(...invokerFuncArgs);function onDone(rv){if(needsDestructorStack){runDestructors(destructors)}else{for(var i=isClassMethodFunc?1:2;i<argTypes.length;i++){var param=i===1?thisWired:argsWired[i-2];if(argTypes[i].destructorFunction!==null){argTypes[i].destructorFunction(param)}}}if(returns){return argTypes[0][\"fromWireType\"](rv)}}return onDone(rv)};return createNamedFunction(humanName,invokerFn)}var ensureOverloadTable=(proto,methodName,humanName)=>{if(undefined===proto[methodName].overloadTable){var prevFunc=proto[methodName];proto[methodName]=function(...args){if(!proto[methodName].overloadTable.hasOwnProperty(args.length)){throwBindingError(`Function '${humanName}' called with an invalid number of arguments (${args.length}) - expects one of (${proto[methodName].overloadTable})!`)}return proto[methodName].overloadTable[args.length].apply(this,args)};proto[methodName].overloadTable=[];proto[methodName].overloadTable[prevFunc.argCount]=prevFunc}};var exposePublicSymbol=(name,value,numArguments)=>{if(Module.hasOwnProperty(name)){if(undefined===numArguments||undefined!==Module[name].overloadTable&&undefined!==Module[name].overloadTable[numArguments]){throwBindingError(`Cannot register public name '${name}' twice`)}ensureOverloadTable(Module,name,name);if(Module.hasOwnProperty(numArguments)){throwBindingError(`Cannot register multiple overloads of a function with the same number of arguments (${numArguments})!`)}Module[name].overloadTable[numArguments]=value}else{Module[name]=value;if(undefined!==numArguments){Module[name].numArguments=numArguments}}};var heap32VectorToArray=(count,firstElement)=>{var array=[];for(var i=0;i<count;i++){array.push(HEAPU32[firstElement+i*4>>2])}return array};var replacePublicSymbol=(name,value,numArguments)=>{if(!Module.hasOwnProperty(name)){throwInternalError(\"Replacing nonexistent public symbol\")}if(undefined!==Module[name].overloadTable&&undefined!==numArguments){Module[name].overloadTable[numArguments]=value}else{Module[name]=value;Module[name].argCount=numArguments}};var dynCallLegacy=(sig,ptr,args)=>{sig=sig.replace(/p/g,\"i\");var f=Module[\"dynCall_\"+sig];return f(ptr,...args)};var wasmTableMirror=[];var wasmTable;var getWasmTableEntry=funcPtr=>{var func=wasmTableMirror[funcPtr];if(!func){if(funcPtr>=wasmTableMirror.length)wasmTableMirror.length=funcPtr+1;wasmTableMirror[funcPtr]=func=wasmTable.get(funcPtr)}return func};var dynCall=(sig,ptr,args=[])=>{if(sig.includes(\"j\")){return dynCallLegacy(sig,ptr,args)}var rtn=getWasmTableEntry(ptr)(...args);return rtn};var getDynCaller=(sig,ptr)=>(...args)=>dynCall(sig,ptr,args);var embind__requireFunction=(signature,rawFunction)=>{signature=readLatin1String(signature);function makeDynCaller(){if(signature.includes(\"j\")){return getDynCaller(signature,rawFunction)}return getWasmTableEntry(rawFunction)}var fp=makeDynCaller();if(typeof fp!=\"function\"){throwBindingError(`unknown function pointer with signature ${signature}: ${rawFunction}`)}return fp};var extendError=(baseErrorType,errorName)=>{var errorClass=createNamedFunction(errorName,function(message){this.name=errorName;this.message=message;var stack=new Error(message).stack;if(stack!==undefined){this.stack=this.toString()+\"\\n\"+stack.replace(/^Error(:[^\\n]*)?\\n/,\"\")}});errorClass.prototype=Object.create(baseErrorType.prototype);errorClass.prototype.constructor=errorClass;errorClass.prototype.toString=function(){if(this.message===undefined){return this.name}else{return`${this.name}: ${this.message}`}};return errorClass};var UnboundTypeError;var getTypeName=type=>{var ptr=___getTypeName(type);var rv=readLatin1String(ptr);_free(ptr);return rv};var throwUnboundTypeError=(message,types)=>{var unboundTypes=[];var seen={};function visit(type){if(seen[type]){return}if(registeredTypes[type]){return}if(typeDependencies[type]){typeDependencies[type].forEach(visit);return}unboundTypes.push(type);seen[type]=true}types.forEach(visit);throw new UnboundTypeError(`${message}: `+unboundTypes.map(getTypeName).join([\", \"]))};var getFunctionName=signature=>{signature=signature.trim();const argsIndex=signature.indexOf(\"(\");if(argsIndex!==-1){return signature.substr(0,argsIndex)}else{return signature}};var __embind_register_function=(name,argCount,rawArgTypesAddr,signature,rawInvoker,fn,isAsync)=>{var argTypes=heap32VectorToArray(argCount,rawArgTypesAddr);name=readLatin1String(name);name=getFunctionName(name);rawInvoker=embind__requireFunction(signature,rawInvoker);exposePublicSymbol(name,function(){throwUnboundTypeError(`Cannot call ${name} due to unbound types`,argTypes)},argCount-1);whenDependentTypesAreResolved([],argTypes,argTypes=>{var invokerArgsArray=[argTypes[0],null].concat(argTypes.slice(1));replacePublicSymbol(name,craftInvokerFunction(name,invokerArgsArray,null,rawInvoker,fn,isAsync),argCount-1);return[]})};var integerReadValueFromPointer=(name,width,signed)=>{switch(width){case 1:return signed?pointer=>HEAP8[pointer]:pointer=>HEAPU8[pointer];case 2:return signed?pointer=>HEAP16[pointer>>1]:pointer=>HEAPU16[pointer>>1];case 4:return signed?pointer=>HEAP32[pointer>>2]:pointer=>HEAPU32[pointer>>2];default:throw new TypeError(`invalid integer width (${width}): ${name}`)}};var __embind_register_integer=(primitiveType,name,size,minRange,maxRange)=>{name=readLatin1String(name);if(maxRange===-1){maxRange=4294967295}var fromWireType=value=>value;if(minRange===0){var bitshift=32-8*size;fromWireType=value=>value<<bitshift>>>bitshift}var isUnsignedType=name.includes(\"unsigned\");var checkAssertions=(value,toTypeName)=>{};var toWireType;if(isUnsignedType){toWireType=function(destructors,value){checkAssertions(value,this.name);return value>>>0}}else{toWireType=function(destructors,value){checkAssertions(value,this.name);return value}}registerType(primitiveType,{name:name,\"fromWireType\":fromWireType,\"toWireType\":toWireType,\"argPackAdvance\":GenericWireTypeSize,\"readValueFromPointer\":integerReadValueFromPointer(name,size,minRange!==0),destructorFunction:null})};var __embind_register_memory_view=(rawType,dataTypeIndex,name)=>{var typeMapping=[Int8Array,Uint8Array,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array];var TA=typeMapping[dataTypeIndex];function decodeMemoryView(handle){var size=HEAPU32[handle>>2];var data=HEAPU32[handle+4>>2];return new TA(HEAP8.buffer,data,size)}name=readLatin1String(name);registerType(rawType,{name:name,\"fromWireType\":decodeMemoryView,\"argPackAdvance\":GenericWireTypeSize,\"readValueFromPointer\":decodeMemoryView},{ignoreDuplicateRegistrations:true})};var stringToUTF8Array=(str,heap,outIdx,maxBytesToWrite)=>{if(!(maxBytesToWrite>0))return 0;var startIdx=outIdx;var endIdx=outIdx+maxBytesToWrite-1;for(var i=0;i<str.length;++i){var u=str.charCodeAt(i);if(u>=55296&&u<=57343){var u1=str.charCodeAt(++i);u=65536+((u&1023)<<10)|u1&1023}if(u<=127){if(outIdx>=endIdx)break;heap[outIdx++]=u}else if(u<=2047){if(outIdx+1>=endIdx)break;heap[outIdx++]=192|u>>6;heap[outIdx++]=128|u&63}else if(u<=65535){if(outIdx+2>=endIdx)break;heap[outIdx++]=224|u>>12;heap[outIdx++]=128|u>>6&63;heap[outIdx++]=128|u&63}else{if(outIdx+3>=endIdx)break;heap[outIdx++]=240|u>>18;heap[outIdx++]=128|u>>12&63;heap[outIdx++]=128|u>>6&63;heap[outIdx++]=128|u&63}}heap[outIdx]=0;return outIdx-startIdx};var stringToUTF8=(str,outPtr,maxBytesToWrite)=>stringToUTF8Array(str,HEAPU8,outPtr,maxBytesToWrite);var lengthBytesUTF8=str=>{var len=0;for(var i=0;i<str.length;++i){var c=str.charCodeAt(i);if(c<=127){len++}else if(c<=2047){len+=2}else if(c>=55296&&c<=57343){len+=4;++i}else{len+=3}}return len};var UTF8ArrayToString=(heapOrArray,idx,maxBytesToRead)=>{var endIdx=idx+maxBytesToRead;var str=\"\";while(!(idx>=endIdx)){var u0=heapOrArray[idx++];if(!u0)return str;if(!(u0&128)){str+=String.fromCharCode(u0);continue}var u1=heapOrArray[idx++]&63;if((u0&224)==192){str+=String.fromCharCode((u0&31)<<6|u1);continue}var u2=heapOrArray[idx++]&63;if((u0&240)==224){u0=(u0&15)<<12|u1<<6|u2}else{u0=(u0&7)<<18|u1<<12|u2<<6|heapOrArray[idx++]&63}if(u0<65536){str+=String.fromCharCode(u0)}else{var ch=u0-65536;str+=String.fromCharCode(55296|ch>>10,56320|ch&1023)}}return str};var UTF8ToString=(ptr,maxBytesToRead)=>ptr?UTF8ArrayToString(HEAPU8,ptr,maxBytesToRead):\"\";var __embind_register_std_string=(rawType,name)=>{name=readLatin1String(name);var stdStringIsUTF8=name===\"std::string\";registerType(rawType,{name:name,\"fromWireType\"(value){var length=HEAPU32[value>>2];var payload=value+4;var str;if(stdStringIsUTF8){var decodeStartPtr=payload;for(var i=0;i<=length;++i){var currentBytePtr=payload+i;if(i==length||HEAPU8[currentBytePtr]==0){var maxRead=currentBytePtr-decodeStartPtr;var stringSegment=UTF8ToString(decodeStartPtr,maxRead);if(str===undefined){str=stringSegment}else{str+=String.fromCharCode(0);str+=stringSegment}decodeStartPtr=currentBytePtr+1}}}else{var a=new Array(length);for(var i=0;i<length;++i){a[i]=String.fromCharCode(HEAPU8[payload+i])}str=a.join(\"\")}_free(value);return str},\"toWireType\"(destructors,value){if(value instanceof ArrayBuffer){value=new Uint8Array(value)}var length;var valueIsOfTypeString=typeof value==\"string\";if(!(valueIsOfTypeString||value instanceof Uint8Array||value instanceof Uint8ClampedArray||value instanceof Int8Array)){throwBindingError(\"Cannot pass non-string to std::string\")}if(stdStringIsUTF8&&valueIsOfTypeString){length=lengthBytesUTF8(value)}else{length=value.length}var base=_malloc(4+length+1);var ptr=base+4;HEAPU32[base>>2]=length;if(stdStringIsUTF8&&valueIsOfTypeString){stringToUTF8(value,ptr,length+1)}else{if(valueIsOfTypeString){for(var i=0;i<length;++i){var charCode=value.charCodeAt(i);if(charCode>255){_free(ptr);throwBindingError(\"String has UTF-16 code units that do not fit in 8 bits\")}HEAPU8[ptr+i]=charCode}}else{for(var i=0;i<length;++i){HEAPU8[ptr+i]=value[i]}}}if(destructors!==null){destructors.push(_free,base)}return base},\"argPackAdvance\":GenericWireTypeSize,\"readValueFromPointer\":readPointer,destructorFunction(ptr){_free(ptr)}})};var UTF16ToString=(ptr,maxBytesToRead)=>{var str=\"\";for(var i=0;!(i>=maxBytesToRead/2);++i){var codeUnit=HEAP16[ptr+i*2>>1];if(codeUnit==0)break;str+=String.fromCharCode(codeUnit)}return str};var stringToUTF16=(str,outPtr,maxBytesToWrite)=>{maxBytesToWrite??=2147483647;if(maxBytesToWrite<2)return 0;maxBytesToWrite-=2;var startPtr=outPtr;var numCharsToWrite=maxBytesToWrite<str.length*2?maxBytesToWrite/2:str.length;for(var i=0;i<numCharsToWrite;++i){var codeUnit=str.charCodeAt(i);HEAP16[outPtr>>1]=codeUnit;outPtr+=2}HEAP16[outPtr>>1]=0;return outPtr-startPtr};var lengthBytesUTF16=str=>str.length*2;var UTF32ToString=(ptr,maxBytesToRead)=>{var i=0;var str=\"\";while(!(i>=maxBytesToRead/4)){var utf32=HEAP32[ptr+i*4>>2];if(utf32==0)break;++i;if(utf32>=65536){var ch=utf32-65536;str+=String.fromCharCode(55296|ch>>10,56320|ch&1023)}else{str+=String.fromCharCode(utf32)}}return str};var stringToUTF32=(str,outPtr,maxBytesToWrite)=>{maxBytesToWrite??=2147483647;if(maxBytesToWrite<4)return 0;var startPtr=outPtr;var endPtr=startPtr+maxBytesToWrite-4;for(var i=0;i<str.length;++i){var codeUnit=str.charCodeAt(i);if(codeUnit>=55296&&codeUnit<=57343){var trailSurrogate=str.charCodeAt(++i);codeUnit=65536+((codeUnit&1023)<<10)|trailSurrogate&1023}HEAP32[outPtr>>2]=codeUnit;outPtr+=4;if(outPtr+4>endPtr)break}HEAP32[outPtr>>2]=0;return outPtr-startPtr};var lengthBytesUTF32=str=>{var len=0;for(var i=0;i<str.length;++i){var codeUnit=str.charCodeAt(i);if(codeUnit>=55296&&codeUnit<=57343)++i;len+=4}return len};var __embind_register_std_wstring=(rawType,charSize,name)=>{name=readLatin1String(name);var decodeString,encodeString,readCharAt,lengthBytesUTF;if(charSize===2){decodeString=UTF16ToString;encodeString=stringToUTF16;lengthBytesUTF=lengthBytesUTF16;readCharAt=pointer=>HEAPU16[pointer>>1]}else if(charSize===4){decodeString=UTF32ToString;encodeString=stringToUTF32;lengthBytesUTF=lengthBytesUTF32;readCharAt=pointer=>HEAPU32[pointer>>2]}registerType(rawType,{name:name,\"fromWireType\":value=>{var length=HEAPU32[value>>2];var str;var decodeStartPtr=value+4;for(var i=0;i<=length;++i){var currentBytePtr=value+4+i*charSize;if(i==length||readCharAt(currentBytePtr)==0){var maxReadBytes=currentBytePtr-decodeStartPtr;var stringSegment=decodeString(decodeStartPtr,maxReadBytes);if(str===undefined){str=stringSegment}else{str+=String.fromCharCode(0);str+=stringSegment}decodeStartPtr=currentBytePtr+charSize}}_free(value);return str},\"toWireType\":(destructors,value)=>{if(!(typeof value==\"string\")){throwBindingError(`Cannot pass non-string to C++ string type ${name}`)}var length=lengthBytesUTF(value);var ptr=_malloc(4+length+charSize);HEAPU32[ptr>>2]=length/charSize;encodeString(value,ptr+4,length+charSize);if(destructors!==null){destructors.push(_free,ptr)}return ptr},\"argPackAdvance\":GenericWireTypeSize,\"readValueFromPointer\":readPointer,destructorFunction(ptr){_free(ptr)}})};var __embind_register_value_object=(rawType,name,constructorSignature,rawConstructor,destructorSignature,rawDestructor)=>{structRegistrations[rawType]={name:readLatin1String(name),rawConstructor:embind__requireFunction(constructorSignature,rawConstructor),rawDestructor:embind__requireFunction(destructorSignature,rawDestructor),fields:[]}};var __embind_register_value_object_field=(structType,fieldName,getterReturnType,getterSignature,getter,getterContext,setterArgumentType,setterSignature,setter,setterContext)=>{structRegistrations[structType].fields.push({fieldName:readLatin1String(fieldName),getterReturnType:getterReturnType,getter:embind__requireFunction(getterSignature,getter),getterContext:getterContext,setterArgumentType:setterArgumentType,setter:embind__requireFunction(setterSignature,setter),setterContext:setterContext})};var __embind_register_void=(rawType,name)=>{name=readLatin1String(name);registerType(rawType,{isVoid:true,name:name,\"argPackAdvance\":0,\"fromWireType\":()=>undefined,\"toWireType\":(destructors,o)=>undefined})};var __emscripten_memcpy_js=(dest,src,num)=>HEAPU8.copyWithin(dest,src,src+num);var emval_methodCallers=[];var __emval_call=(caller,handle,destructorsRef,args)=>{caller=emval_methodCallers[caller];handle=Emval.toValue(handle);return caller(null,handle,destructorsRef,args)};var emval_symbols={};var getStringOrSymbol=address=>{var symbol=emval_symbols[address];if(symbol===undefined){return readLatin1String(address)}return symbol};var emval_get_global=()=>{if(typeof globalThis==\"object\"){return globalThis}function testGlobal(obj){obj[\"$$$embind_global$$$\"]=obj;var success=typeof $$$embind_global$$$==\"object\"&&obj[\"$$$embind_global$$$\"]==obj;if(!success){delete obj[\"$$$embind_global$$$\"]}return success}if(typeof $$$embind_global$$$==\"object\"){return $$$embind_global$$$}if(typeof global==\"object\"&&testGlobal(global)){$$$embind_global$$$=global}else if(typeof self==\"object\"&&testGlobal(self)){$$$embind_global$$$=self}if(typeof $$$embind_global$$$==\"object\"){return $$$embind_global$$$}throw Error(\"unable to get global object.\")};var __emval_get_global=name=>{if(name===0){return Emval.toHandle(emval_get_global())}else{name=getStringOrSymbol(name);return Emval.toHandle(emval_get_global()[name])}};var emval_addMethodCaller=caller=>{var id=emval_methodCallers.length;emval_methodCallers.push(caller);return id};var requireRegisteredType=(rawType,humanName)=>{var impl=registeredTypes[rawType];if(undefined===impl){throwBindingError(`${humanName} has unknown type ${getTypeName(rawType)}`)}return impl};var emval_lookupTypes=(argCount,argTypes)=>{var a=new Array(argCount);for(var i=0;i<argCount;++i){a[i]=requireRegisteredType(HEAPU32[argTypes+i*4>>2],\"parameter \"+i)}return a};var reflectConstruct=Reflect.construct;var emval_returnValue=(returnType,destructorsRef,handle)=>{var destructors=[];var result=returnType[\"toWireType\"](destructors,handle);if(destructors.length){HEAPU32[destructorsRef>>2]=Emval.toHandle(destructors)}return result};var __emval_get_method_caller=(argCount,argTypes,kind)=>{var types=emval_lookupTypes(argCount,argTypes);var retType=types.shift();argCount--;var argN=new Array(argCount);var invokerFunction=(obj,func,destructorsRef,args)=>{var offset=0;for(var i=0;i<argCount;++i){argN[i]=types[i][\"readValueFromPointer\"](args+offset);offset+=types[i][\"argPackAdvance\"]}var rv=kind===1?reflectConstruct(func,argN):func.apply(obj,argN);return emval_returnValue(retType,destructorsRef,rv)};var functionName=`methodCaller<(${types.map(t=>t.name).join(\", \")}) => ${retType.name}>`;return emval_addMethodCaller(createNamedFunction(functionName,invokerFunction))};var __emval_run_destructors=handle=>{var destructors=Emval.toValue(handle);runDestructors(destructors);__emval_decref(handle)};var _abort=()=>{abort(\"\")};var getHeapMax=()=>2147483648;var growMemory=size=>{var b=wasmMemory.buffer;var pages=(size-b.byteLength+65535)/65536;try{wasmMemory.grow(pages);updateMemoryViews();return 1}catch(e){}};var _emscripten_resize_heap=requestedSize=>{var oldSize=HEAPU8.length;requestedSize>>>=0;var maxHeapSize=getHeapMax();if(requestedSize>maxHeapSize){return false}var alignUp=(x,multiple)=>x+(multiple-x%multiple)%multiple;for(var cutDown=1;cutDown<=4;cutDown*=2){var overGrownHeapSize=oldSize*(1+.2/cutDown);overGrownHeapSize=Math.min(overGrownHeapSize,requestedSize+100663296);var newSize=Math.min(maxHeapSize,alignUp(Math.max(requestedSize,overGrownHeapSize),65536));var replacement=growMemory(newSize);if(replacement){return true}}return false};var ENV={};var getExecutableName=()=>thisProgram||\"./this.program\";var getEnvStrings=()=>{if(!getEnvStrings.strings){var lang=(typeof navigator==\"object\"&&navigator.languages&&navigator.languages[0]||\"C\").replace(\"-\",\"_\")+\".UTF-8\";var env={\"USER\":\"web_user\",\"LOGNAME\":\"web_user\",\"PATH\":\"/\",\"PWD\":\"/\",\"HOME\":\"/home/web_user\",\"LANG\":lang,\"_\":getExecutableName()};for(var x in ENV){if(ENV[x]===undefined)delete env[x];else env[x]=ENV[x]}var strings=[];for(var x in env){strings.push(`${x}=${env[x]}`)}getEnvStrings.strings=strings}return getEnvStrings.strings};var stringToAscii=(str,buffer)=>{for(var i=0;i<str.length;++i){HEAP8[buffer++]=str.charCodeAt(i)}HEAP8[buffer]=0};var _environ_get=(__environ,environ_buf)=>{var bufSize=0;getEnvStrings().forEach((string,i)=>{var ptr=environ_buf+bufSize;HEAPU32[__environ+i*4>>2]=ptr;stringToAscii(string,ptr);bufSize+=string.length+1});return 0};var _environ_sizes_get=(penviron_count,penviron_buf_size)=>{var strings=getEnvStrings();HEAPU32[penviron_count>>2]=strings.length;var bufSize=0;strings.forEach(string=>bufSize+=string.length+1);HEAPU32[penviron_buf_size>>2]=bufSize;return 0};var runtimeKeepaliveCounter=0;var keepRuntimeAlive=()=>noExitRuntime||runtimeKeepaliveCounter>0;var _proc_exit=code=>{EXITSTATUS=code;if(!keepRuntimeAlive()){Module[\"onExit\"]?.(code);ABORT=true}quit_(code,new ExitStatus(code))};var exitJS=(status,implicit)=>{EXITSTATUS=status;_proc_exit(status)};var _exit=exitJS;var _fd_close=fd=>52;var convertI32PairToI53Checked=(lo,hi)=>hi+2097152>>>0<4194305-!!lo?(lo>>>0)+hi*4294967296:NaN;function _fd_seek(fd,offset_low,offset_high,whence,newOffset){var offset=convertI32PairToI53Checked(offset_low,offset_high);return 70}var printCharBuffers=[null,[],[]];var printChar=(stream,curr)=>{var buffer=printCharBuffers[stream];if(curr===0||curr===10){(stream===1?out:err)(UTF8ArrayToString(buffer,0));buffer.length=0}else{buffer.push(curr)}};var _fd_write=(fd,iov,iovcnt,pnum)=>{var num=0;for(var i=0;i<iovcnt;i++){var ptr=HEAPU32[iov>>2];var len=HEAPU32[iov+4>>2];iov+=8;for(var j=0;j<len;j++){printChar(fd,HEAPU8[ptr+j])}num+=len}HEAPU32[pnum>>2]=num;return 0};InternalError=Module[\"InternalError\"]=class InternalError extends Error{constructor(message){super(message);this.name=\"InternalError\"}};embind_init_charCodes();BindingError=Module[\"BindingError\"]=class BindingError extends Error{constructor(message){super(message);this.name=\"BindingError\"}};init_emval();UnboundTypeError=Module[\"UnboundTypeError\"]=extendError(Error,\"UnboundTypeError\");var wasmImports={j:___cxa_throw,k:__embind_finalize_value_object,n:__embind_register_bigint,h:__embind_register_bool,z:__embind_register_emval,f:__embind_register_float,e:__embind_register_function,c:__embind_register_integer,a:__embind_register_memory_view,g:__embind_register_std_string,d:__embind_register_std_wstring,l:__embind_register_value_object,b:__embind_register_value_object_field,i:__embind_register_void,s:__emscripten_memcpy_js,y:__emval_call,u:__emval_decref,A:__emval_get_global,x:__emval_get_method_caller,w:__emval_run_destructors,o:_abort,p:_emscripten_resize_heap,q:_environ_get,r:_environ_sizes_get,B:_exit,t:_fd_close,m:_fd_seek,v:_fd_write};var wasmExports=createWasm();var ___wasm_call_ctors=()=>(___wasm_call_ctors=wasmExports[\"D\"])();var ___getTypeName=a0=>(___getTypeName=wasmExports[\"E\"])(a0);var _malloc=a0=>(_malloc=wasmExports[\"F\"])(a0);var _free=a0=>(_free=wasmExports[\"G\"])(a0);var __emscripten_stack_restore=a0=>(__emscripten_stack_restore=wasmExports[\"_emscripten_stack_restore\"])(a0);var __emscripten_stack_alloc=a0=>(__emscripten_stack_alloc=wasmExports[\"_emscripten_stack_alloc\"])(a0);var _emscripten_stack_get_current=()=>(_emscripten_stack_get_current=wasmExports[\"emscripten_stack_get_current\"])();var ___cxa_increment_exception_refcount=a0=>(___cxa_increment_exception_refcount=wasmExports[\"__cxa_increment_exception_refcount\"])(a0);var ___cxa_is_pointer_type=a0=>(___cxa_is_pointer_type=wasmExports[\"I\"])(a0);var dynCall_jiji=Module[\"dynCall_jiji\"]=(a0,a1,a2,a3,a4)=>(dynCall_jiji=Module[\"dynCall_jiji\"]=wasmExports[\"J\"])(a0,a1,a2,a3,a4);var calledRun;dependenciesFulfilled=function runCaller(){if(!calledRun)run();if(!calledRun)dependenciesFulfilled=runCaller};function run(){if(runDependencies>0){return}preRun();if(runDependencies>0){return}function doRun(){if(calledRun)return;calledRun=true;Module[\"calledRun\"]=true;if(ABORT)return;initRuntime();readyPromiseResolve(Module);if(Module[\"onRuntimeInitialized\"])Module[\"onRuntimeInitialized\"]();postRun()}if(Module[\"setStatus\"]){Module[\"setStatus\"](\"Running...\");setTimeout(function(){setTimeout(function(){Module[\"setStatus\"](\"\")},1);doRun()},1)}else{doRun()}}if(Module[\"preInit\"]){if(typeof Module[\"preInit\"]==\"function\")Module[\"preInit\"]=[Module[\"preInit\"]];while(Module[\"preInit\"].length>0){Module[\"preInit\"].pop()()}}run();\n\n\n  return readyPromise\n}\n);\n})();\nexport default Module;","export const label = 'MozJPEG';\nexport const mimeType = 'image/jpeg';\nexport const extension = 'jpg';\nexport const defaultOptions = {\n    quality: 75,\n    baseline: false,\n    arithmetic: false,\n    progressive: true,\n    optimize_coding: true,\n    smoothing: 0,\n    color_space: 3 /* MozJpegColorSpace.YCbCr */,\n    quant_table: 3,\n    trellis_multipass: false,\n    trellis_opt_zero: false,\n    trellis_opt_table: false,\n    trellis_loops: 1,\n    auto_subsample: true,\n    chroma_subsample: 2,\n    separate_chroma_quality: false,\n    chroma_quality: 75,\n};\nexport const defaultEncodeOptions = defaultOptions;\nexport const defaultDecodeOptions = {\n    preserveOrientation: false,\n};\n","/**\n * Copyright 2020 Google Inc. All Rights Reserved.\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *     http://www.apache.org/licenses/LICENSE-2.0\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n/**\n * Notice: I (Jamie Sinclair) have modified this file to allow manual instantiation of the Wasm Module.\n */\nexport function initEmscriptenModule(moduleFactory, wasmModule, moduleOptionOverrides = {}) {\n    let instantiateWasm;\n    if (wasmModule) {\n        instantiateWasm = (imports, callback) => {\n            const instance = new WebAssembly.Instance(wasmModule, imports);\n            callback(instance);\n            return instance.exports;\n        };\n    }\n    return moduleFactory({\n        // Just to be safe, don't automatically invoke any wasm functions\n        noInitialRun: true,\n        instantiateWasm,\n        ...moduleOptionOverrides,\n    });\n}\n","/**\n * Copyright 2020 Google Inc. All Rights Reserved.\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *     http://www.apache.org/licenses/LICENSE-2.0\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport mozjpeg_enc from './codec/enc/mozjpeg_enc.js';\nimport { defaultOptions } from './meta.js';\nimport { initEmscriptenModule } from './utils.js';\nlet emscriptenModule;\nexport async function init(module, moduleOptionOverrides) {\n    emscriptenModule = initEmscriptenModule(mozjpeg_enc, module, moduleOptionOverrides);\n}\nexport default async function encode(data, options = {}) {\n    if (!emscriptenModule)\n        init();\n    const module = await emscriptenModule;\n    const _options = { ...defaultOptions, ...options };\n    const resultView = module.encode(data.data, data.width, data.height, _options);\n    // wasm cant run on SharedArrayBuffers, so we hard-cast to ArrayBuffer.\n    return resultView.buffer;\n}\n","import type { EncodeOptions } from '@jsquash/jpeg/meta';\nimport { randomUUIDv4 } from './util';\nimport OptimizationWorker from './optimization.worker.ts?worker';\nimport log from './log';\n\nexport type InitializationRequest = {\n  mozjpegWasm: Uint8Array;\n};\n\nexport type TaskDescription<I> = {\n  id: string;\n  data: I;\n};\n\nexport type WorkerMessage<I, O> = { input: { id: string; data: I }; result: O };\nexport type WorkerTask<I, O> = {\n  resolve: (value: O) => void;\n  reject: (reason: any) => void;\n  task: TaskDescription<I>;\n};\n\nexport type MozJPEGParams = {\n  method: 'mozjpeg';\n  quality: number;\n} & Partial<EncodeOptions>;\n\nexport type BrowserEncoderParams = {\n  method: 'browser';\n  quality: number;\n};\n\nexport type OptimizationParams = MozJPEGParams | BrowserEncoderParams;\n\nexport type OptimizationRequest = {\n  imageData: Uint8Array;\n  imageFormat: 'image/jpeg' | 'image/png';\n} & OptimizationParams;\n\nexport type OptimizedImage = {\n  jpegData: Uint8Array;\n  sizeFactor: number;\n};\n\nexport class OptimizationError extends Error {\n  constructor(message: string, public taskId: string, public cause?: unknown) {\n    super(message);\n  }\n}\n\nexport const MOZJPEG_DEFAULT_PARAMS: EncodeOptions = {\n  quality: 75,\n  progressive: true,\n  optimize_coding: true,\n  smoothing: 0,\n  color_space: 3, // YCbCr\n  quant_table: 3,\n  trellis_multipass: false,\n  trellis_opt_table: true,\n  trellis_opt_zero: true,\n  trellis_loops: 0,\n  auto_subsample: false,\n  chroma_subsample: 2,\n  separate_chroma_quality: false,\n  chroma_quality: 75,\n  arithmetic: false,\n  baseline: false,\n};\n\nclass WorkerPool<I, O> {\n  private workers: Worker[] = [];\n  private queue: WorkerTask<I, O>[] = [];\n  private pendingTasks: Map<string, WorkerTask<I, O>> = new Map();\n  private busyWorkers: Set<Worker> = new Set();\n\n  constructor(public size: number) {}\n\n  start(): void {\n    for (let i = 0; i < this.size; i++) {\n      const worker = new OptimizationWorker();\n      worker.onmessage = this.handleMessage.bind(this, worker);\n      worker.onerror = this.handleError.bind(this, worker);\n      this.workers.push(worker);\n    }\n  }\n\n  stop(): void {\n    this.workers.forEach((worker) => worker.terminate());\n    this.workers = [];\n    this.queue = [];\n    this.busyWorkers.clear();\n  }\n\n  dispatch(data: I): Promise<O> {\n    return new Promise((resolve, reject) => {\n      this.queue.push({\n        resolve,\n        reject,\n        task: {\n          id: randomUUIDv4(),\n          data,\n        },\n      });\n      this.processQueue();\n    });\n  }\n\n  private processQueue(): void {\n    if (this.queue.length === 0) return;\n    const availableWorker = this.workers.find((w) => !this.busyWorkers.has(w));\n    if (!availableWorker) return;\n\n    const job = this.queue.shift()!;\n    this.pendingTasks.set(job.task.id, job);\n    this.busyWorkers.add(availableWorker);\n    availableWorker.postMessage(job.task);\n  }\n\n  private handleMessage(\n    worker: Worker,\n    event: MessageEvent<WorkerMessage<I, O>>\n  ): void {\n    log.debug(`worker: received message`, event.data);\n    const job = this.pendingTasks.get(event.data.input.id);\n    if (job) {\n      job.resolve(event.data.result);\n      log.debug(`worker: resolved job`, job.task.id);\n      this.pendingTasks.delete(job.task.id);\n      this.busyWorkers.delete(worker);\n      this.processQueue();\n    } else {\n      log.warn(\n        `worker: unknown job, known jobs: ${[...this.pendingTasks.keys()].join(\n          ', '\n        )}`,\n        event.data.input.id\n      );\n    }\n  }\n\n  private handleError(worker: Worker, evt: ErrorEvent): void {\n    const optimError = evt.error as OptimizationError;\n    const job = this.queue.find((j) => j.task.id === optimError.taskId);\n    if (job) {\n      job.reject(optimError.cause);\n      this.busyWorkers.delete(worker);\n      this.processQueue();\n    }\n  }\n}\n\nlet pool: WorkerPool<\n  OptimizationParams | InitializationRequest,\n  OptimizedImage | undefined\n> | null = null;\nlet isInitialized = false;\n\nexport function startWorkerPool(size = navigator.hardwareConcurrency): void {\n  if (pool !== null) {\n    return;\n  }\n  pool = new WorkerPool(size);\n  pool.start();\n}\n\nexport function stopWorkerPool(): void {\n  if (pool === null) {\n    return;\n  }\n  pool.stop();\n  pool = null;\n}\n\nexport async function initialize(wasmLoader: () => Promise<Uint8Array>): Promise<void> {\n  if (pool === null) {\n    startWorkerPool();\n  }\n\n  if (isInitialized) {\n    return;\n  }\n\n  const mozjpegWasm = await wasmLoader();\n  let promises: Promise<undefined>[] = [];\n  for (let i = 0; i < pool!.size; i++) {\n    promises.push(pool!.dispatch({ mozjpegWasm }) as Promise<undefined>);\n  }\n  log.debug('main: mozjpegWasm sent to workers');\n  await Promise.all(promises);\n  log.debug('main: workers initialized with MozJPEG encoder');\n  isInitialized = true;\n}\n\nexport async function optimizeImage(\n  params: OptimizationRequest\n): Promise<OptimizedImage> {\n  if (pool === null) {\n    startWorkerPool();\n  }\n\n  return pool!.dispatch(params) as Promise<OptimizedImage>;\n}\n","import encode, { init as initMozJpegEnc } from '@jsquash/jpeg/encode';\n\nimport {\n  BrowserEncoderParams,\n  InitializationRequest,\n  MOZJPEG_DEFAULT_PARAMS,\n  MozJPEGParams,\n  OptimizationError,\n  OptimizationRequest,\n  OptimizedImage,\n  TaskDescription,\n  type WorkerMessage,\n} from './optimization';\n\nlet mozjpegInitialized = false;\nconst canvas = new OffscreenCanvas(1, 1);\n\nself.onmessage = async function (\n  evt: MessageEvent<TaskDescription<OptimizationRequest | InitializationRequest>>\n) {\n  if ('mozjpegWasm' in evt.data.data) {\n    console.debug(`worker: received MozJPEG WASM module`);\n    const module = await WebAssembly.compile(evt.data.data.mozjpegWasm);\n    await initMozJpegEnc(module);\n    mozjpegInitialized = true;\n    console.debug(`worker: initialized MozJPEG encoder`);\n    self.postMessage({\n      input: evt.data,\n      result: {},\n    });\n    return;\n  }\n\n  const params = evt.data.data;\n  console.debug(`worker: received optimization task`, evt.data.id, params);\n  let optimizedData: Uint8Array;\n  try {\n    if (params.method === 'mozjpeg') {\n      if (!mozjpegInitialized) {\n        throw new Error('MozJPEG encoder not initialized');\n      }\n      optimizedData = await reencodeWithMozJPEG(params);\n    } else if (params.method === 'browser') {\n      optimizedData = await reencodeWithBrowserEncoder(params);\n    } else {\n      throw new Error('Unsupported optimization method');\n    }\n  } catch (err) {\n    console.error(`Failed to optimize image: ${err}`, evt.data.id, err);\n    self.postMessage(\n      new OptimizationError(\n        `Failed to optimize image: ${err}`,\n        evt.data.id,\n        err\n      )\n    );\n    return;\n  }\n  const result = {\n    input: evt.data,\n    result: {\n      jpegData: optimizedData,\n      sizeFactor: optimizedData.length / params.imageData.length,\n    },\n  };\n  self.postMessage(result);\n  console.debug(`worker optimized image with factor ${result.result.sizeFactor}`);\n};\n\nfunction loadImageToCanvas(\n  imageData: Uint8Array,\n  imageFormat: string\n): Promise<void> {\n  return new Promise(async (resolve, reject) => {\n    try {\n      const bitmap = await createImageBitmap(\n        new Blob([imageData], { type: imageFormat })\n      );\n      canvas.width = bitmap.width;\n      canvas.height = bitmap.height;\n      const ctx = canvas.getContext('2d');\n      if (!ctx) {\n        reject(new Error('Could not get 2D context'));\n        return;\n      }\n      ctx.drawImage(bitmap, 0, 0);\n      resolve();\n    } catch (err) {\n      reject(err);\n      return;\n    }\n  });\n}\n\nasync function reencodeWithMozJPEG(\n  params: OptimizationRequest & MozJPEGParams\n): Promise<Uint8Array> {\n  await loadImageToCanvas(params.imageData, params.imageFormat);\n  const pixelData = canvas\n    .getContext('2d')!\n    .getImageData(0, 0, canvas.width, canvas.height);\n  const encoded = await encode(pixelData, {\n    ...MOZJPEG_DEFAULT_PARAMS,\n    ...params,\n  });\n  return new Uint8Array(encoded);\n}\n\nasync function reencodeWithBrowserEncoder(\n  params: OptimizationRequest & BrowserEncoderParams\n): Promise<Uint8Array> {\n  await loadImageToCanvas(params.imageData, params.imageFormat);\n  const encoded = await canvas.convertToBlob({\n    type: 'image/jpeg',\n    quality: params.quality / 100,\n  });\n  return new Uint8Array(await encoded.arrayBuffer());\n}\n"],"names":["Module","_scriptDir","moduleArg","readyPromiseResolve","readyPromiseReject","readyPromise","resolve","reject","isRunningInCloudFlareWorkers","isRunningInNode","data","width","height","moduleOverrides","thisProgram","quit_","status","toThrow","ENVIRONMENT_IS_WEB","ENVIRONMENT_IS_WORKER","scriptDirectory","locateFile","path","readBinary","url","xhr","out","err","wasmBinary","wasmMemory","ABORT","HEAP8","HEAPU8","HEAP16","HEAPU16","HEAP32","HEAPU32","HEAPF32","HEAPF64","updateMemoryViews","b","__ATPRERUN__","__ATINIT__","__ATPOSTRUN__","preRun","addOnPreRun","callRuntimeCallbacks","initRuntime","postRun","addOnPostRun","cb","addOnInit","runDependencies","dependenciesFulfilled","addRunDependency","id","_a","removeRunDependency","callback","abort","what","dataURIPrefix","isDataURI","filename","wasmBinaryFile","getBinarySync","file","getBinaryPromise","binaryFile","response","instantiateArrayBuffer","imports","receiver","binary","reason","instantiateAsync","result","createWasm","info","wasmImports","receiveInstance","instance","module","wasmExports","wasmTable","receiveInstantiationResult","e","ExitStatus","callbacks","ExceptionInfo","excPtr","type","destructor","caught","rethrown","adjustedPtr","isPointer","___cxa_is_pointer_type","adjusted","exceptionLast","___cxa_throw","ptr","structRegistrations","runDestructors","destructors","del","readPointer","pointer","awaitingDependencies","registeredTypes","typeDependencies","InternalError","throwInternalError","message","whenDependentTypesAreResolved","myTypes","dependentTypes","getTypeConverters","onComplete","typeConverters","myTypeConverters","i","registerType","unregisteredTypes","registered","dt","__embind_finalize_value_object","structType","reg","rawConstructor","rawDestructor","fieldRecords","fieldTypes","field","fields","fieldName","getterReturnType","getter","getterContext","setterArgumentType","setter","setterContext","o","rv","GenericWireTypeSize","__embind_register_bigint","primitiveType","name","size","minRange","maxRange","embind_init_charCodes","codes","embind_charCodes","readLatin1String","ret","c","BindingError","throwBindingError","sharedRegisterType","rawType","registeredInstance","options","__embind_register_bool","trueValue","falseValue","wt","emval_freelist","emval_handles","__emval_decref","handle","count_emval_handles","init_emval","Emval","value","EmValType","__embind_register_emval","floatReadValueFromPointer","__embind_register_float","createNamedFunction","body","usesDestructorStack","argTypes","craftInvokerFunction","humanName","classType","cppInvokerFunc","cppTargetFunc","isAsync","argCount","needsDestructorStack","returns","expectedArgCount","argsWired","invokerFuncArgs","invokerFn","args","thisWired","onDone","param","ensureOverloadTable","proto","methodName","prevFunc","exposePublicSymbol","numArguments","heap32VectorToArray","count","firstElement","array","replacePublicSymbol","dynCallLegacy","sig","f","wasmTableMirror","getWasmTableEntry","funcPtr","func","dynCall","rtn","getDynCaller","embind__requireFunction","signature","rawFunction","makeDynCaller","fp","extendError","baseErrorType","errorName","errorClass","stack","UnboundTypeError","getTypeName","___getTypeName","_free","throwUnboundTypeError","types","unboundTypes","seen","visit","getFunctionName","argsIndex","__embind_register_function","rawArgTypesAddr","rawInvoker","fn","invokerArgsArray","integerReadValueFromPointer","signed","__embind_register_integer","fromWireType","bitshift","isUnsignedType","checkAssertions","toTypeName","toWireType","__embind_register_memory_view","dataTypeIndex","typeMapping","TA","decodeMemoryView","stringToUTF8Array","str","heap","outIdx","maxBytesToWrite","startIdx","endIdx","u","u1","stringToUTF8","outPtr","lengthBytesUTF8","len","UTF8ArrayToString","heapOrArray","idx","maxBytesToRead","u0","u2","ch","UTF8ToString","__embind_register_std_string","stdStringIsUTF8","length","payload","decodeStartPtr","currentBytePtr","maxRead","stringSegment","a","valueIsOfTypeString","base","_malloc","charCode","UTF16ToString","codeUnit","stringToUTF16","startPtr","numCharsToWrite","lengthBytesUTF16","UTF32ToString","utf32","stringToUTF32","endPtr","trailSurrogate","lengthBytesUTF32","__embind_register_std_wstring","charSize","decodeString","encodeString","readCharAt","lengthBytesUTF","maxReadBytes","__embind_register_value_object","constructorSignature","destructorSignature","__embind_register_value_object_field","getterSignature","setterSignature","__embind_register_void","__emscripten_memcpy_js","dest","src","num","emval_methodCallers","__emval_call","caller","destructorsRef","emval_symbols","getStringOrSymbol","address","symbol","emval_get_global","testGlobal","obj","success","__emval_get_global","emval_addMethodCaller","requireRegisteredType","impl","emval_lookupTypes","reflectConstruct","emval_returnValue","returnType","__emval_get_method_caller","kind","retType","argN","invokerFunction","offset","functionName","t","__emval_run_destructors","_abort","getHeapMax","growMemory","pages","_emscripten_resize_heap","requestedSize","oldSize","maxHeapSize","alignUp","x","multiple","cutDown","overGrownHeapSize","newSize","replacement","ENV","getExecutableName","getEnvStrings","lang","env","strings","stringToAscii","buffer","_environ_get","__environ","environ_buf","bufSize","string","_environ_sizes_get","penviron_count","penviron_buf_size","_proc_exit","code","exitJS","implicit","_exit","_fd_close","fd","_fd_seek","offset_low","offset_high","whence","newOffset","printCharBuffers","printChar","stream","curr","_fd_write","iov","iovcnt","pnum","j","a0","a1","a2","a3","a4","calledRun","runCaller","run","doRun","defaultOptions","initEmscriptenModule","moduleFactory","wasmModule","moduleOptionOverrides","instantiateWasm","emscriptenModule","init","mozjpeg_enc","encode","_options","OptimizationError","taskId","cause","MOZJPEG_DEFAULT_PARAMS","mozjpegInitialized","canvas","evt","initMozJpegEnc","params","optimizedData","reencodeWithMozJPEG","reencodeWithBrowserEncoder","loadImageToCanvas","imageData","imageFormat","bitmap","ctx","pixelData","encoded"],"mappings":"AACA,IAAAA,MAAA,MAAA;AACA,MAAAC,IAAA,YAAA;AAEA,SACA,SAAAC,IAAA,CAAA,GAAA;AAEA,QAAAF,IAAAE,GAAAC,GAAAC,GAAAC,IAAA,IAAA,QAAA,CAAAC,GAAAC,MAAA;AAAA,MAAAJ,IAAAG,GAAAF,IAAAG;AAAA,IAAA,CAAA;AAAA,UAAAC,KAAA,WAAA,6BAAA,UAAA,OAAA,OAAA,OAAA,WAAA,UAAA,WAAA,OAAA,YAAA,QAAAC,KAAA,OAAA,WAAA,YAAA,QAAA,WAAA,QAAA,QAAA,SAAA;AAAA,KAAAD,MAAAC,QAAA,WAAA,cAAA,WAAA,YAAA,MAAA;AAAA,MAAA,YAAAC,GAAAC,GAAAC,GAAA;AAAA,aAAA,OAAAF,GAAA,KAAA,QAAAC,GAAA,KAAA,SAAAC;AAAA,MAAA;AAAA,IAAA,IAAA,YAAA,QAAA,WAAA,YAAA,MAAA,sBAAA,OAAA,OAAA,OAAA,KAAA,aAAA,WAAA,KAAA,WAAA,EAAA,MAAA,GAAA;AAAA,QAAAC,KAAA,OAAA,OAAA,CAAA,GAAAb,CAAA,GAAAc,KAAA,kBAAAC,KAAA,CAAAC,GAAAC,MAAA;AAAA,YAAAA;AAAA,IAAA,GAAAC,KAAA,OAAA,UAAA,UAAAC,IAAA,OAAA,iBAAA;AAAA,WAAA,WAAA,YAAA,OAAA,QAAA,YAAA,YAAA,QAAA,SAAA;AAAA,QAAAC,IAAA;AAAA,aAAAC,GAAAC,GAAA;AAAA,aAAAtB,EAAA,aAAAA,EAAA,WAAAsB,GAAAF,CAAA,IAAAA,IAAAE;AAAA,IAAA;AAAA,QAAAC;AAAA,KAAAL,MAAAC,OAAAA,IAAAC,IAAA,KAAA,SAAA,OAAA,OAAA,WAAA,OAAA,SAAA,kBAAAA,IAAA,SAAA,cAAA,MAAAnB,MAAAmB,IAAAnB,IAAAmB,EAAA,WAAA,OAAA,IAAAA,IAAA,KAAAA,IAAAA,EAAA,OAAA,GAAAA,EAAA,QAAA,UAAA,EAAA,EAAA,YAAA,GAAA,IAAA,CAAA,GAAAD,MAAAI,KAAA,CAAAC,MAAA;AAAA,UAAAC,IAAA,IAAA;AAAA,aAAAA,EAAA,KAAA,OAAAD,GAAA,EAAA,GAAAC,EAAA,eAAA,eAAAA,EAAA,KAAA,IAAA,GAAA,IAAA,WAAAA,EAAA,QAAA;AAAA,IAAA;AAAA,QAAAC,KAAA1B,EAAA,SAAA,QAAA,IAAA,KAAA,OAAA,GAAA2B,IAAA3B,EAAA,YAAA,QAAA,MAAA,KAAA,OAAA;AAAA,WAAA,OAAAA,GAAAa,EAAA,GAAAA,KAAA,MAAAb,EAAA,aAAAA,EAAA,WAAAA,EAAA,gBAAAc,KAAAd,EAAA,cAAAA,EAAA,SAAAe,KAAAf,EAAA;AAAA,QAAA4B;AAAA,IAAA5B,EAAA,eAAA4B,IAAA5B,EAAA;AAAA,QAAA6B,GAAAC,KAAA,IAAAC,GAAAC,GAAAC,GAAAC,IAAAC,GAAAC,GAAAC,IAAAC;AAAA,aAAAC,KAAA;AAAA,UAAAC,IAAAX,EAAA;AAAA,MAAA7B,EAAA,QAAA+B,IAAA,IAAA,UAAAS,CAAA,GAAAxC,EAAA,SAAAiC,IAAA,IAAA,WAAAO,CAAA,GAAAxC,EAAA,SAAAgC,IAAA,IAAA,WAAAQ,CAAA,GAAAxC,EAAA,UAAAkC,KAAA,IAAA,YAAAM,CAAA,GAAAxC,EAAA,SAAAmC,IAAA,IAAA,WAAAK,CAAA,GAAAxC,EAAA,UAAAoC,IAAA,IAAA,YAAAI,CAAA,GAAAxC,EAAA,UAAAqC,KAAA,IAAA,aAAAG,CAAA,GAAAxC,EAAA,UAAAsC,KAAA,IAAA,aAAAE,CAAA;AAAA,IAAA;AAAA,QAAAC,KAAA,CAAA,GAAAC,KAAA,IAAAC,KAAA,CAAA;AAAA,aAAAC,KAAA;AAAA,UAAA5C,EAAA;AAAA,aAAA,OAAAA,EAAA,UAAA,eAAAA,EAAA,SAAA,CAAAA,EAAA,MAAA,IAAAA,EAAA,OAAA;AAAA,UAAA6C,GAAA7C,EAAA,OAAA,MAAA,CAAA;AAAA,MAAA8C,GAAAL,EAAA;AAAA,IAAA;AAAA,aAAAM,KAAA;AAAA,MAAAD,GAAAJ,EAAA;AAAA,IAAA;AAAA,aAAAM,KAAA;AAAA,UAAAhD,EAAA;AAAA,aAAA,OAAAA,EAAA,WAAA,eAAAA,EAAA,UAAA,CAAAA,EAAA,OAAA,IAAAA,EAAA,QAAA;AAAA,UAAAiD,GAAAjD,EAAA,QAAA,MAAA,CAAA;AAAA,MAAA8C,GAAAH,EAAA;AAAA,IAAA;AAAA,aAAAE,GAAAK,GAAA;AAAA,MAAAT,GAAA,QAAAS,CAAA;AAAA,IAAA;AAAA,aAAAC,GAAAD,GAAA;AAAA,MAAAR,GAAA,QAAAQ,CAAA;AAAA,IAAA;AAAA,aAAAD,GAAAC,GAAA;AAAA,MAAAP,GAAA,QAAAO,CAAA;AAAA,IAAA;AAAA,QAAAE,IAAA,GAAAC,IAAA;AAAA,aAAAC,GAAAC,GAAA;AANA,UAAAC;AAMA,MAAAJ,MAAAI,IAAAxD,EAAA,2BAAA,QAAAwD,EAAA,KAAAxD,GAAAoD;AAAA,IAAA;AAAA,aAAAK,GAAAF,GAAA;AANA,UAAAC;AAMA,UAAAJ,MAAAI,IAAAxD,EAAA,2BAAA,QAAAwD,EAAA,KAAAxD,GAAAoD,IAAAA,KAAA,KAAAC,GAAA;AAAA,YAAAK,IAAAL;AAAA,QAAAA,IAAA,MAAAK,EAAA;AAAA,MAAA;AAAA,IAAA;AAAA,aAAAC,GAAAC,GAAA;AANA,UAAAJ;AAMA,OAAAA,IAAAxD,EAAA,YAAA,QAAAwD,EAAA,KAAAxD,GAAA4D,IAAAA,IAAA,aAAAA,IAAA,KAAAjC,EAAAiC,CAAA,GAAA9B,KAAA,IAAA8B,KAAA;AAAA,UAAA,IAAA,IAAA,YAAA,aAAAA,CAAA;AAAA,YAAAxD,EAAA,CAAA,GAAA;AAAA,IAAA;AAAA,QAAAyD,KAAA,yCAAAC,KAAA,CAAAC,MAAAA,EAAA,WAAAF,EAAA,GAAAG;AAAA,IAAAhE,EAAA,cAAAgE,IAAA,oBAAAF,GAAAE,CAAA,MAAAA,IAAA3C,GAAA2C,CAAA,MAAAA,IAAs5J;AAAgD,aAAAC,GAAAC,GAAA;AAAA,UAAAA,KAAAF,KAAApC;AAAA,eAAA,IAAA,WAAAA,CAAA;AAAA,UAAAL;AAAA,eAAAA,GAAA2C,CAAA;AAAA,YAAA;AAAA,IAAA;AAAA,aAAAC,GAAAC,GAAA;AAAA,aAAA,CAAAxC,MAAAV,MAAAC,MAAA,OAAA,SAAA,aAAA,MAAAiD,GAAA,EAAA,aAAA,cAAA,CAAA,EAAA,KAAA,CAAAC,MAAA;AAAA,YAAA,CAAAA,EAAA;AAAA,gBAAA,uCAAAD,CAAA;AAAA,eAAAC,EAAA,YAAA;AAAA,MAAA,CAAA,EAAA,MAAA,MAAAJ,GAAAG,CAAA,CAAA,IAAA,QAAA,QAAA,EAAA,KAAA,MAAAH,GAAAG,CAAA,CAAA;AAAA,IAAA;AAAA,aAAAE,GAAAF,GAAAG,GAAAC,GAAA;AAAA,aAAAL,GAAAC,CAAA,EAAA,KAAA,CAAAK,MAAA,YAAA,YAAAA,GAAAF,CAAA,CAAA,EAAA,KAAAC,GAAA,CAAAE,MAAA;AAAA,QAAA/C,EAAA,0CAAA+C,CAAA,EAAA,GAAAf,GAAAe,CAAA;AAAA,MAAA,CAAA;AAAA,IAAA;AAAA,aAAAC,GAAAF,GAAAL,GAAAG,GAAAb,GAAA;AAAA,aAAA,CAAAe,KAAA,OAAA,YAAA,wBAAA,cAAA,CAAAX,GAAAM,CAAA,KAAA,OAAA,SAAA,aAAA,MAAAA,GAAA,EAAA,aAAA,cAAA,CAAA,EAAA,KAAA,CAAAC,MAAA;AAAA,YAAAO,IAAA,YAAA,qBAAAP,GAAAE,CAAA;AAAA,eAAAK,EAAA,KAAAlB,GAAA,SAAAgB,GAAA;AAAA,iBAAA/C,EAAA,kCAAA+C,CAAA,EAAA,GAAA/C,EAAA,2CAAA,GAAA2C,GAAAF,GAAAG,GAAAb,CAAA;AAAA,QAAA,CAAA;AAAA,MAAA,CAAA,IAAAY,GAAAF,GAAAG,GAAAb,CAAA;AAAA,IAAA;AAAA,aAAAmB,KAAA;AAAA,UAAAC,IAAA,EAAA,GAAAC,GAAA;AAAA,eAAAC,EAAAC,GAAAC,GAAA;AAAA,eAAAC,IAAAF,EAAA,SAAApD,IAAAsD,EAAA,GAAA5C,GAAA,GAAA6C,KAAAD,EAAA,GAAAhC,GAAAgC,EAAA,CAAA,GAAA1B,GAAA,GAAA0B;AAAA,MAAA;AAAA,MAAA7B,GAAA;AAAA,eAAA+B,EAAAT,GAAA;AAAA,QAAAI,EAAAJ,EAAA,QAAA;AAAA,MAAA;AAAA,UAAA5E,EAAA;AAAA,YAAA;AAAA,iBAAAA,EAAA,gBAAA8E,GAAAE,CAAA;AAAA,QAAA,SAAAM,GAAA;AAAA,UAAA3D,EAAA,sDAAA2D,CAAA,EAAA,GAAAlF,EAAAkF,CAAA;AAAA,QAAA;AAAA,aAAAX,GAAA/C,GAAAoC,GAAAc,GAAAO,CAAA,EAAA,MAAAjF,CAAA,GAAA;IAAA;AAAA,aAAAmF,GAAAvE,GAAA;AAAA,WAAA,OAAA,cAAA,KAAA,UAAA,gCAAAA,CAAA,KAAA,KAAA,SAAAA;AAAA,IAAA;AAAA,QAAA8B,KAAA,CAAA0C,MAAA;AAAA,aAAAA,EAAA,SAAA;AAAA,QAAAA,EAAA,MAAA,EAAAxF,CAAA;AAAA,IAAA;AAAA,IAAAA,EAAA;AAAA,IAAA,MAAAyF,GAAA;AAAA,MAAA,YAAAC,GAAA;AAAA,aAAA,SAAAA,GAAA,KAAA,MAAAA,IAAA;AAAA,MAAA;AAAA,MAAA,SAAAC,GAAA;AAAA,QAAAvD,EAAA,KAAA,MAAA,KAAA,CAAA,IAAAuD;AAAA,MAAA;AAAA,MAAA,WAAA;AAAA,eAAAvD,EAAA,KAAA,MAAA,KAAA,CAAA;AAAA,MAAA;AAAA,MAAA,eAAAwD,GAAA;AAAA,QAAAxD,EAAA,KAAA,MAAA,KAAA,CAAA,IAAAwD;AAAA,MAAA;AAAA,MAAA,iBAAA;AAAA,eAAAxD,EAAA,KAAA,MAAA,KAAA,CAAA;AAAA,MAAA;AAAA,MAAA,WAAAyD,GAAA;AAAA,QAAAA,IAAAA,IAAA,IAAA,GAAA9D,EAAA,KAAA,MAAA,EAAA,IAAA8D;AAAA,MAAA;AAAA,MAAA,aAAA;AAAA,eAAA9D,EAAA,KAAA,MAAA,EAAA,KAAA;AAAA,MAAA;AAAA,MAAA,aAAA+D,GAAA;AAAA,QAAAA,IAAAA,IAAA,IAAA,GAAA/D,EAAA,KAAA,MAAA,EAAA,IAAA+D;AAAA,MAAA;AAAA,MAAA,eAAA;AAAA,eAAA/D,EAAA,KAAA,MAAA,EAAA,KAAA;AAAA,MAAA;AAAA,MAAA,KAAA4D,GAAAC,GAAA;AAAA,aAAA,iBAAA,CAAA,GAAA,KAAA,SAAAD,CAAA,GAAA,KAAA,eAAAC,CAAA;AAAA,MAAA;AAAA,MAAA,iBAAAG,GAAA;AAAA,QAAA3D,EAAA,KAAA,MAAA,MAAA,CAAA,IAAA2D;AAAA,MAAA;AAAA,MAAA,mBAAA;AAAA,eAAA3D,EAAA,KAAA,MAAA,MAAA,CAAA;AAAA,MAAA;AAAA,MAAA,oBAAA;AAAA,YAAA4D,IAAAC,GAAA,KAAA,SAAA,CAAA;AAAA,YAAAD;AAAA,iBAAA5D,EAAA,KAAA,UAAA,CAAA;AAAA,YAAA8D,IAAA,KAAA,iBAAA;AAAA,eAAAA,MAAA,IAAAA,IAAA,KAAA;AAAA,MAAA;AAAA,IAAA;AAAA,QAAAC,KAAA,GAAAC,KAAA,CAAAC,GAAAV,GAAAC,MAAA;AAAA,UAAAd,IAAA,IAAAW,GAAAY,CAAA;AAAA,YAAAvB,EAAA,KAAAa,GAAAC,CAAA,GAAAO,KAAAE,GAAAF;AAAA,IAAA,GAAAG,IAAA,CAAA,GAAAC,KAAA,CAAAC,MAAA;AAAA,aAAAA,EAAA,UAAA;AAAA,YAAAH,IAAAG,EAAA,IAAA,GAAAC,IAAAD,EAAA,IAAA;AAAA,QAAAC,EAAAJ,CAAA;AAAA,MAAA;AAAA,IAAA;AAAA,aAAAK,EAAAC,GAAA;AAAA,aAAA,KAAA,aAAAvE,EAAAuE,KAAA,CAAA,CAAA;AAAA,IAAA;AAAA,QAAAC,IAAA,CAAA,GAAAC,IAAA,CAAA,GAAAC,IAAA,IAAAC,IAAAC,KAAA,CAAAC,MAAA;AAAA,YAAA,IAAAF,GAAAE,CAAA;AAAA,IAAA,GAAAC,KAAA,CAAAC,GAAAC,GAAAC,MAAA;AAAA,MAAAF,EAAA,QAAA,SAAAxB,GAAA;AAAA,QAAAmB,EAAAnB,CAAA,IAAAyB;AAAA,MAAA,CAAA;AAAA,eAAAE,EAAAC,GAAA;AAAA,YAAAC,IAAAH,EAAAE,CAAA;AAAA,QAAAC,EAAA,WAAAL,EAAA,UAAAH,GAAA,iCAAA;AAAA,iBAAAS,IAAA,GAAAA,IAAAN,EAAA,QAAA,EAAAM;AAAA,UAAAC,EAAAP,EAAAM,CAAA,GAAAD,EAAAC,CAAA,CAAA;AAAA,MAAA;AAAA,UAAAF,IAAA,IAAA,MAAAH,EAAA,MAAA,GAAAO,IAAA,CAAA,GAAAC,IAAA;AAAA,MAAAR,EAAA,QAAA,CAAAS,GAAAJ,MAAA;AAAA,QAAAZ,EAAA,eAAAgB,CAAA,IAAAN,EAAAE,CAAA,IAAAZ,EAAAgB,CAAA,KAAAF,EAAA,KAAAE,CAAA,GAAAjB,EAAA,eAAAiB,CAAA,MAAAjB,EAAAiB,CAAA,IAAA,CAAA,IAAAjB,EAAAiB,CAAA,EAAA,KAAA,MAAA;AAAA,UAAAN,EAAAE,CAAA,IAAAZ,EAAAgB,CAAA,GAAA,EAAAD,GAAAA,MAAAD,EAAA,UAAAL,EAAAC,CAAA;AAAA,QAAA,CAAA;AAAA,MAAA,CAAA,GAAAI,EAAA,WAAA,KAAAL,EAAAC,CAAA;AAAA,IAAA,GAAAO,KAAA,CAAAC,MAAA;AAAA,UAAAC,IAAA1B,EAAAyB,CAAA;AAAA,aAAAzB,EAAAyB,CAAA;AAAA,UAAAE,IAAAD,EAAA,gBAAAE,IAAAF,EAAA,eAAAG,IAAAH,EAAA,QAAAI,IAAAD,EAAA,IAAA,CAAAE,MAAAA,EAAA,gBAAA,EAAA,OAAAF,EAAA,IAAA,CAAAE,MAAAA,EAAA,kBAAA,CAAA;AAAA,MAAAnB,GAAA,CAAAa,CAAA,GAAAK,GAAA,CAAAA,MAAA;AAAA,YAAAE,IAAA,CAAA;AAAA,eAAAH,EAAA,QAAA,CAAAE,GAAAZ,MAAA;AAAA,cAAAc,IAAAF,EAAA,WAAAG,IAAAJ,EAAAX,CAAA,GAAAgB,IAAAJ,EAAA,QAAAK,IAAAL,EAAA,eAAAM,IAAAP,EAAAX,IAAAU,EAAA,MAAA,GAAAS,KAAAP,EAAA,QAAAQ,IAAAR,EAAA;AAAA,UAAAC,EAAAC,CAAA,IAAA,EAAA,MAAA,CAAAlC,MAAAmC,EAAA,aAAAC,EAAAC,GAAArC,CAAA,CAAA,GAAA,OAAA,CAAAA,GAAAyC,OAAA;AAAA,gBAAAtC,KAAA,CAAA;AAAA,YAAAoC,GAAAC,GAAAxC,GAAAsC,EAAA,WAAAnC,IAAAsC,EAAA,CAAA,GAAAvC,GAAAC,EAAA;AAAA,UAAA,EAAA;AAAA,QAAA,CAAA,GAAA,CAAA,EAAA,MAAAwB,EAAA,MAAA,cAAA,CAAA3B,MAAA;AAAA,cAAA0C,IAAA,CAAA;AAAA,mBAAAtB,KAAAa;AAAA,YAAAS,EAAAtB,CAAA,IAAAa,EAAAb,CAAA,EAAA,KAAApB,CAAA;AAAA,iBAAA6B,EAAA7B,CAAA,GAAA0C;AAAA,QAAA,GAAA,YAAA,CAAAvC,GAAAsC,MAAA;AAAA,mBAAAP,KAAAD;AAAA,gBAAA,EAAAC,KAAAO;AAAA,oBAAA,IAAA,UAAA,mBAAAP,CAAA,GAAA;AAAA,cAAAlC,IAAA4B,EAAA;AAAA,eAAAM,KAAAD;AAAA,YAAAA,EAAAC,CAAA,EAAA,MAAAlC,GAAAyC,EAAAP,CAAA,CAAA;AAAA,iBAAA/B,MAAA,QAAAA,EAAA,KAAA0B,GAAA7B,CAAA,GAAAA;AAAA,QAAA,GAAA,gBAAA2C,GAAA,sBAAAtC,GAAA,oBAAAwB,EAAA,CAAA;AAAA,MAAA,CAAA;AAAA,IAAA,GAAAe,KAAA,CAAAC,GAAAC,GAAAC,GAAAC,GAAAC,MAAA;AAAA,IAAA,GAAAC,KAAA,MAAA;AAAA,eAAAC,IAAA,IAAA,MAAA,GAAA,GAAA/B,IAAA,GAAAA,IAAA,KAAA,EAAAA;AAAA,QAAA+B,EAAA/B,CAAA,IAAA,OAAA,aAAAA,CAAA;AAAA,MAAAgC,KAAAD;AAAA,IAAA,GAAAC,IAAAC,IAAA,CAAArD,MAAA;AAAA,eAAAsD,IAAA,IAAAC,IAAAvD,GAAArE,EAAA4H,CAAA;AAAA,QAAAD,KAAAF,GAAAzH,EAAA4H,GAAA,CAAA;AAAA,aAAAD;AAAA,IAAA,GAAAE,IAAAC,IAAA,CAAA7C,MAAA;AAAA,YAAA,IAAA4C,GAAA5C,CAAA;AAAA,IAAA;AAAA,aAAA8C,GAAAC,GAAAC,GAAAC,IAAA,CAAA,GAAA;AAAA,UAAAf,IAAAc,EAAA;AAAA,UAAAD,KAAAF,EAAA,SAAAX,CAAA,+CAAA,GAAAtC,EAAA,eAAAmD,CAAA,GAAA;AAAA,YAAAE,EAAA;AAAA;AAAA,QAAAJ,EAAA,yBAAAX,CAAA,SAAA;AAAA,MAAA;AAAA,UAAAtC,EAAAmD,CAAA,IAAAC,GAAA,OAAAnD,EAAAkD,CAAA,GAAApD,EAAA,eAAAoD,CAAA,GAAA;AAAA,YAAAxE,IAAAoB,EAAAoD,CAAA;AAAA,eAAApD,EAAAoD,CAAA,GAAAxE,EAAA,QAAA,CAAAtC,MAAAA,EAAA,CAAA;AAAA,MAAA;AAAA,IAAA;AAAA,aAAAwE,EAAAsC,GAAAC,GAAAC,IAAA,CAAA,GAAA;AAAA,UAAA,EAAA,oBAAAD;AAAA,cAAA,IAAA,UAAA,yDAAA;AAAA,aAAAF,GAAAC,GAAAC,GAAAC,CAAA;AAAA,IAAA;AAAA,QAAAlB,IAAA,GAAAmB,KAAA,CAAAH,GAAAb,GAAAiB,GAAAC,MAAA;AAAA,MAAAlB,IAAAO,EAAAP,CAAA,GAAAzB,EAAAsC,GAAA,EAAA,MAAAb,GAAA,cAAA,SAAAmB,GAAA;AAAA,eAAA,CAAA,CAAAA;AAAA,MAAA,GAAA,YAAA,SAAA9D,GAAA,GAAA;AAAA,eAAA,IAAA4D,IAAAC;AAAA,MAAA,GAAA,gBAAArB,GAAA,sBAAA,SAAArC,GAAA;AAAA,eAAA,KAAA,aAAA3E,EAAA2E,CAAA,CAAA;AAAA,MAAA,GAAA,oBAAA,KAAA,CAAA;AAAA,IAAA,GAAA4D,KAAA,CAAA,GAAAC,IAAA,IAAAC,KAAA,CAAAC,MAAA;AAAA,MAAAA,IAAA,KAAA,EAAAF,EAAAE,IAAA,CAAA,MAAA,MAAAF,EAAAE,CAAA,IAAA,QAAAH,GAAA,KAAAG,CAAA;AAAA,IAAA,GAAAC,KAAA,MAAAH,EAAA,SAAA,IAAA,IAAAD,GAAA,QAAAK,KAAA,MAAA;AAAA,MAAAJ,EAAA,KAAA,GAAA,GAAA,QAAA,GAAA,MAAA,GAAA,IAAA,GAAA,IAAA,CAAA,GAAAxK,EAAA,sBAAA2K;AAAA,IAAA,GAAAE,IAAA,EAAA,SAAA,CAAAH,OAAAA,KAAAZ,EAAA,sCAAAY,CAAA,GAAAF,EAAAE,CAAA,IAAA,UAAA,CAAAI,MAAA;AAAA,cAAAA,GAAA;AAAA,QAAA,KAAA;AAAA,iBAAA;AAAA,QAAA,KAAA;AAAA,iBAAA;AAAA,QAAA,KAAA;AAAA,iBAAA;AAAA,QAAA,KAAA;AAAA,iBAAA;AAAA,QAAA,SAAA;AAAA,gBAAAJ,IAAAH,GAAA,IAAA,KAAAC,EAAA;AAAA,iBAAAA,EAAAE,CAAA,IAAAI,GAAAN,EAAAE,IAAA,CAAA,IAAA,GAAAA;AAAA,QAAA;AAAA,MAAA;AAAA,IAAA,EAAA,GAAAK,KAAA,EAAA,MAAA,mBAAA,cAAA,CAAAL,MAAA;AAAA,UAAA3B,IAAA8B,EAAA,QAAAH,CAAA;AAAA,aAAAD,GAAAC,CAAA,GAAA3B;AAAA,IAAA,GAAA,YAAA,CAAAvC,GAAAsE,MAAAD,EAAA,SAAAC,CAAA,GAAA,gBAAA9B,GAAA,sBAAAtC,GAAA,oBAAA,KAAA,GAAAsE,KAAA,CAAAhB,MAAAtC,EAAAsC,GAAAe,EAAA,GAAAE,KAAA,CAAA9B,GAAAxI,MAAA;AAAA,cAAAA,GAAA;AAAA,QAAA,KAAA;AAAA,iBAAA,SAAAgG,GAAA;AAAA,mBAAA,KAAA,aAAAtE,GAAAsE,KAAA,CAAA,CAAA;AAAA,UAAA;AAAA,QAAA,KAAA;AAAA,iBAAA,SAAAA,GAAA;AAAA,mBAAA,KAAA,aAAArE,GAAAqE,KAAA,CAAA,CAAA;AAAA,UAAA;AAAA,QAAA;AAAA,gBAAA,IAAA,UAAA,wBAAAhG,CAAA,MAAAwI,CAAA,EAAA;AAAA,MAAA;AAAA,IAAA,GAAA+B,KAAA,CAAAlB,GAAAb,GAAAC,MAAA;AAAA,MAAAD,IAAAO,EAAAP,CAAA,GAAAzB,EAAAsC,GAAA,EAAA,MAAAb,GAAA,cAAA,CAAA2B,MAAAA,GAAA,YAAA,CAAAtE,GAAAsE,MAAAA,GAAA,gBAAA9B,GAAA,sBAAAiC,GAAA9B,GAAAC,CAAA,GAAA,oBAAA,KAAA,CAAA;AAAA,IAAA,GAAA+B,KAAA,CAAAhC,GAAAiC,MAAA,OAAA,eAAAA,GAAA,QAAA,EAAA,OAAAjC,EAAA,CAAA;AAAA,aAAAkC,GAAAC,GAAA;AAAA,eAAA7D,IAAA,GAAAA,IAAA6D,EAAA,QAAA,EAAA7D;AAAA,YAAA6D,EAAA7D,CAAA,MAAA,QAAA6D,EAAA7D,CAAA,EAAA,uBAAA;AAAA,iBAAA;AAAA,aAAA;AAAA,IAAA;AAAA,aAAA8D,GAAAC,GAAAF,GAAAG,GAAAC,GAAAC,GAAAC,GAAA;AAAA,UAAAC,IAAAP,EAAA;AAAA,MAAAO,IAAA,KAAA/B,EAAA,gFAAA,GAAAwB,EAAA,CAAA;AAAA,UAAAQ,IAAAT,GAAAC,CAAA,GAAAS,IAAAT,EAAA,CAAA,EAAA,SAAA,QAAAU,IAAAH,IAAA,GAAAI,IAAA,IAAA,MAAAD,CAAA,GAAAE,IAAA,CAAA,GAAA1F,IAAA,CAAA,GAAA2F,IAAA,YAAAC,GAAA;AAAA,QAAAA,EAAA,WAAAJ,KAAAlC,EAAA,YAAA0B,CAAA,gBAAAY,EAAA,MAAA,wBAAAJ,CAAA,EAAA,GAAAxF,EAAA,SAAA;AAAA,YAAA6F;AAAA,QAAAH,EAAA,SAAA,GAAAA,EAAA,CAAA,IAAAP;AAAA,iBAAAlE,IAAA,GAAAA,IAAAuE,GAAA,EAAAvE;AAAA,UAAAwE,EAAAxE,CAAA,IAAA6D,EAAA7D,IAAA,CAAA,EAAA,WAAAjB,GAAA4F,EAAA3E,CAAA,CAAA,GAAAyE,EAAA,KAAAD,EAAAxE,CAAA,CAAA;AAAA,YAAAsB,IAAA2C,EAAA,GAAAQ,CAAA;AAAA,iBAAAI,GAAAvD,IAAA;AAAA,cAAA+C;AAAA,YAAAvF,GAAAC,CAAA;AAAA;AAAA,qBAAAiB,IAAA,GAAAA,IAAA6D,EAAA,QAAA7D,KAAA;AAAA,kBAAA8E,KAAA9E,MAAA,IAAA4E,KAAAJ,EAAAxE,IAAA,CAAA;AAAA,cAAA6D,EAAA7D,CAAA,EAAA,uBAAA,QAAA6D,EAAA7D,CAAA,EAAA,mBAAA8E,EAAA;AAAA,YAAA;AAAA,cAAAR;AAAA,mBAAAT,EAAA,CAAA,EAAA,aAAAvC,EAAA;AAAA,QAAA;AAAA,eAAAuD,GAAAvD,CAAA;AAAA,MAAA;AAAA,aAAAoC,GAAAK,GAAAW,CAAA;AAAA,IAAA;AAAA,QAAAK,KAAA,CAAAC,GAAAC,GAAAlB,MAAA;AAAA,UAAAiB,EAAAC,CAAA,EAAA,kBAAA,QAAA;AAAA,YAAAC,IAAAF,EAAAC,CAAA;AAAA,QAAAD,EAAAC,CAAA,IAAA,YAAAN,GAAA;AAAA,iBAAAK,EAAAC,CAAA,EAAA,cAAA,eAAAN,EAAA,MAAA,KAAAtC,EAAA,aAAA0B,CAAA,iDAAAY,EAAA,MAAA,uBAAAK,EAAAC,CAAA,EAAA,aAAA,IAAA,GAAAD,EAAAC,CAAA,EAAA,cAAAN,EAAA,MAAA,EAAA,MAAA,MAAAA,CAAA;AAAA,QAAA,GAAAK,EAAAC,CAAA,EAAA,gBAAA,CAAA,GAAAD,EAAAC,CAAA,EAAA,cAAAC,EAAA,QAAA,IAAAA;AAAA,MAAA;AAAA,IAAA,GAAAC,KAAA,CAAAzD,GAAA2B,GAAA+B,MAAA;AAAA,MAAA7M,EAAA,eAAAmJ,CAAA,MAAA0D,MAAA,UAAA7M,EAAAmJ,CAAA,EAAA,kBAAA,UAAAnJ,EAAAmJ,CAAA,EAAA,cAAA0D,CAAA,MAAA,WAAA/C,EAAA,gCAAAX,CAAA,SAAA,GAAAqD,GAAAxM,GAAAmJ,GAAAA,CAAA,GAAAnJ,EAAA,eAAA6M,CAAA,KAAA/C,EAAA,uFAAA+C,CAAA,IAAA,GAAA7M,EAAAmJ,CAAA,EAAA,cAAA0D,CAAA,IAAA/B,MAAA9K,EAAAmJ,CAAA,IAAA2B,GAAA+B,MAAA,WAAA7M,EAAAmJ,CAAA,EAAA,eAAA0D;AAAA,IAAA,GAAAC,KAAA,CAAAC,GAAAC,MAAA;AAAA,eAAAC,IAAA,CAAA,GAAAxF,IAAA,GAAAA,IAAAsF,GAAAtF;AAAA,QAAAwF,EAAA,KAAA7K,EAAA4K,IAAAvF,IAAA,KAAA,CAAA,CAAA;AAAA,aAAAwF;AAAA,IAAA,GAAAC,KAAA,CAAA/D,GAAA2B,GAAA+B,MAAA;AAAA,MAAA7M,EAAA,eAAAmJ,CAAA,KAAAnC,GAAA,qCAAA,GAAAhH,EAAAmJ,CAAA,EAAA,kBAAA,UAAA0D,MAAA,SAAA7M,EAAAmJ,CAAA,EAAA,cAAA0D,CAAA,IAAA/B,KAAA9K,EAAAmJ,CAAA,IAAA2B,GAAA9K,EAAAmJ,CAAA,EAAA,WAAA0D;AAAA,IAAA,GAAAM,KAAA,CAAAC,GAAA/G,GAAA+F,MAAA;AAAA,MAAAgB,IAAAA,EAAA,QAAA,MAAA,GAAA;AAAA,UAAAC,IAAArN,EAAA,aAAAoN,CAAA;AAAA,aAAAC,EAAAhH,GAAA,GAAA+F,CAAA;AAAA,IAAA,GAAAkB,IAAA,CAAA,GAAAlI,IAAAmI,KAAA,CAAAC,MAAA;AAAA,UAAAC,IAAAH,EAAAE,CAAA;AAAA,aAAAC,MAAAD,KAAAF,EAAA,WAAAA,EAAA,SAAAE,IAAA,IAAAF,EAAAE,CAAA,IAAAC,IAAArI,GAAA,IAAAoI,CAAA,IAAAC;AAAA,IAAA,GAAAC,KAAA,CAAAN,GAAA/G,GAAA+F,IAAA,CAAA,MAAA;AAAA,UAAAgB,EAAA,SAAA,GAAA;AAAA,eAAAD,GAAAC,GAAA/G,GAAA+F,CAAA;AAAA,UAAAuB,IAAAJ,GAAAlH,CAAA,EAAA,GAAA+F,CAAA;AAAA,aAAAuB;AAAA,IAAA,GAAAC,KAAA,CAAAR,GAAA/G,MAAA,IAAA+F,MAAAsB,GAAAN,GAAA/G,GAAA+F,CAAA,GAAAyB,IAAA,CAAAC,GAAAC,MAAA;AAAA,MAAAD,IAAApE,EAAAoE,CAAA;AAAA,eAAAE,IAAA;AAAA,eAAAF,EAAA,SAAA,GAAA,IAAAF,GAAAE,GAAAC,CAAA,IAAAR,GAAAQ,CAAA;AAAA,MAAA;AAAA,UAAAE,IAAAD,EAAA;AAAA,aAAA,OAAAC,KAAA,cAAAnE,EAAA,2CAAAgE,CAAA,KAAAC,CAAA,EAAA,GAAAE;AAAA,IAAA,GAAAC,KAAA,CAAAC,GAAAC,MAAA;AAAA,UAAAC,IAAAlD,GAAAiD,GAAA,SAAAnH,GAAA;AAAA,aAAA,OAAAmH,GAAA,KAAA,UAAAnH;AAAA,YAAAqH,IAAA,IAAA,MAAArH,CAAA,EAAA;AAAA,QAAAqH,MAAA,WAAA,KAAA,QAAA,KAAA,SAAA,IAAA;AAAA,IAAAA,EAAA,QAAA,sBAAA,EAAA;AAAA,MAAA,CAAA;AAAA,aAAAD,EAAA,YAAA,OAAA,OAAAF,EAAA,SAAA,GAAAE,EAAA,UAAA,cAAAA,GAAAA,EAAA,UAAA,WAAA,WAAA;AAAA,eAAA,KAAA,YAAA,SAAA,KAAA,OAAA,GAAA,KAAA,IAAA,KAAA,KAAA,OAAA;AAAA,MAAA,GAAAA;AAAA,IAAA,GAAAE,IAAAC,KAAA,CAAA7I,MAAA;AAAA,UAAAU,IAAAoI,GAAA9I,CAAA,GAAAoD,IAAAW,EAAArD,CAAA;AAAA,aAAAqI,EAAArI,CAAA,GAAA0C;AAAA,IAAA,GAAA4F,KAAA,CAAA1H,GAAA2H,MAAA;AAAA,UAAAC,IAAA,IAAAC,IAAA,CAAA;AAAA,eAAAC,EAAApJ,GAAA;AAAA,YAAA,CAAAmJ,EAAAnJ,CAAA,KAAA,CAAAkB,EAAAlB,CAAA,GAAA;AAAA,cAAAmB,EAAAnB,CAAA,GAAA;AAAA,YAAAmB,EAAAnB,CAAA,EAAA,QAAAoJ,CAAA;AAAA;AAAA,UAAA;AAAA,UAAAF,EAAA,KAAAlJ,CAAA,GAAAmJ,EAAAnJ,CAAA,IAAA;AAAA;AAAA,MAAA;AAAA,YAAAiJ,EAAA,QAAAG,CAAA,GAAA,IAAAR,GAAA,GAAAtH,CAAA,OAAA4H,EAAA,IAAAL,EAAA,EAAA,KAAA,CAAA,IAAA,CAAA,CAAA;AAAA,IAAA,GAAAQ,KAAA,CAAAlB,MAAA;AAAA,MAAAA,IAAAA,EAAA,KAAA;AAAA,YAAAmB,IAAAnB,EAAA,QAAA,GAAA;AAAA,aAAAmB,MAAA,KAAAnB,EAAA,OAAA,GAAAmB,CAAA,IAAAnB;AAAA,IAAA,GAAAoB,KAAA,CAAA/F,GAAA0C,GAAAsD,GAAArB,GAAAsB,GAAAC,GAAAzD,MAAA;AAAA,UAAAN,IAAAwB,GAAAjB,GAAAsD,CAAA;AAAA,MAAAhG,IAAAO,EAAAP,CAAA,GAAAA,IAAA6F,GAAA7F,CAAA,GAAAiG,IAAAvB,EAAAC,GAAAsB,CAAA,GAAAxC,GAAAzD,GAAA,WAAA;AAAA,QAAAwF,GAAA,eAAAxF,CAAA,yBAAAmC,CAAA;AAAA,MAAA,GAAAO,IAAA,CAAA,GAAA3E,GAAA,IAAAoE,GAAA,CAAAA,MAAA;AAAA,YAAAgE,IAAA,CAAAhE,EAAA,CAAA,GAAA,IAAA,EAAA,OAAAA,EAAA,MAAA,CAAA,CAAA;AAAA,eAAA4B,GAAA/D,GAAAoC,GAAApC,GAAAmG,GAAA,MAAAF,GAAAC,CAAA,GAAAxD,IAAA,CAAA,GAAA,CAAA;AAAA,MAAA,CAAA;AAAA,IAAA,GAAA0D,KAAA,CAAApG,GAAAxI,GAAA6O,MAAA;AAAA,cAAA7O,GAAA;AAAA,QAAA,KAAA;AAAA,iBAAA6O,IAAA,CAAA7I,MAAA5E,EAAA4E,CAAA,IAAA,CAAAA,MAAA3E,EAAA2E,CAAA;AAAA,QAAA,KAAA;AAAA,iBAAA6I,IAAA,CAAA7I,MAAA1E,EAAA0E,KAAA,CAAA,IAAA,CAAAA,MAAAzE,GAAAyE,KAAA,CAAA;AAAA,QAAA,KAAA;AAAA,iBAAA6I,IAAA,CAAA7I,MAAAxE,EAAAwE,KAAA,CAAA,IAAA,CAAAA,MAAAvE,EAAAuE,KAAA,CAAA;AAAA,QAAA;AAAA,gBAAA,IAAA,UAAA,0BAAAhG,CAAA,MAAAwI,CAAA,EAAA;AAAA,MAAA;AAAA,IAAA,GAAAsG,KAAA,CAAAvG,GAAAC,GAAAC,GAAAC,GAAAC,MAAA;AAAA,MAAAH,IAAAO,EAAAP,CAAA;AAAA,UAAAuG,IAAA,CAAA5E,MAAAA;AAAA,UAAAzB,MAAA,GAAA;AAAA,YAAAsG,IAAA,KAAA,IAAAvG;AAAA,QAAAsG,IAAA,CAAA5E,MAAAA,KAAA6E,MAAAA;AAAA,MAAA;AAAA,UAAAC,IAAAzG,EAAA,SAAA,UAAA,GAAA0G,IAAA,CAAA/E,GAAAgF,MAAA;AAAA,MAAA,GAAAC;AAAA,MAAAH,IAAAG,IAAA,SAAAvJ,GAAAsE,GAAA;AAAA,eAAA+E,EAAA/E,GAAA,KAAA,IAAA,GAAAA,MAAA;AAAA,MAAA,IAAAiF,IAAA,SAAAvJ,GAAAsE,GAAA;AAAA,eAAA+E,EAAA/E,GAAA,KAAA,IAAA,GAAAA;AAAA,MAAA,GAAApD,EAAAwB,GAAA,EAAA,MAAAC,GAAA,cAAAuG,GAAA,YAAAK,GAAA,gBAAA/G,GAAA,sBAAAuG,GAAApG,GAAAC,GAAAC,MAAA,CAAA,GAAA,oBAAA,KAAA,CAAA;AAAA,IAAA,GAAA2G,KAAA,CAAAhG,GAAAiG,GAAA9G,MAAA;AAAA,UAAA+G,IAAA,CAAA,WAAA,YAAA,YAAA,aAAA,YAAA,aAAA,cAAA,YAAA,GAAAC,IAAAD,EAAAD,CAAA;AAAA,eAAAG,EAAA1F,GAAA;AAAA,YAAAtB,IAAAhH,EAAAsI,KAAA,CAAA,GAAAhK,IAAA0B,EAAAsI,IAAA,KAAA,CAAA;AAAA,eAAA,IAAAyF,EAAApO,EAAA,QAAArB,GAAA0I,CAAA;AAAA,MAAA;AAAA,MAAAD,IAAAO,EAAAP,CAAA,GAAAzB,EAAAsC,GAAA,EAAA,MAAAb,GAAA,cAAAiH,GAAA,gBAAApH,GAAA,sBAAAoH,EAAA,GAAA,EAAA,8BAAA,GAAA,CAAA;AAAA,IAAA,GAAAC,KAAA,CAAAC,GAAAC,GAAAC,GAAAC,MAAA;AAAA,UAAA,EAAAA,IAAA,GAAA,QAAA;AAAA,eAAAC,IAAAF,GAAAG,IAAAH,IAAAC,IAAA,GAAAhJ,IAAA,GAAAA,IAAA6I,EAAA,QAAA,EAAA7I,GAAA;AAAA,YAAAmJ,IAAAN,EAAA,WAAA7I,CAAA;AAAA,YAAAmJ,KAAA,SAAAA,KAAA,OAAA;AAAA,cAAAC,IAAAP,EAAA,WAAA,EAAA7I,CAAA;AAAA,UAAAmJ,IAAA,UAAAA,IAAA,SAAA,MAAAC,IAAA;AAAA,QAAA;AAAA,YAAAD,KAAA,KAAA;AAAA,cAAAJ,KAAAG,EAAA;AAAA,UAAAJ,EAAAC,GAAA,IAAAI;AAAA,QAAA,WAAAA,KAAA,MAAA;AAAA,cAAAJ,IAAA,KAAAG,EAAA;AAAA,UAAAJ,EAAAC,GAAA,IAAA,MAAAI,KAAA,GAAAL,EAAAC,GAAA,IAAA,MAAAI,IAAA;AAAA,QAAA,WAAAA,KAAA,OAAA;AAAA,cAAAJ,IAAA,KAAAG,EAAA;AAAA,UAAAJ,EAAAC,GAAA,IAAA,MAAAI,KAAA,IAAAL,EAAAC,GAAA,IAAA,MAAAI,KAAA,IAAA,IAAAL,EAAAC,GAAA,IAAA,MAAAI,IAAA;AAAA,QAAA,OAAA;AAAA,cAAAJ,IAAA,KAAAG,EAAA;AAAA,UAAAJ,EAAAC,GAAA,IAAA,MAAAI,KAAA,IAAAL,EAAAC,GAAA,IAAA,MAAAI,KAAA,KAAA,IAAAL,EAAAC,GAAA,IAAA,MAAAI,KAAA,IAAA,IAAAL,EAAAC,GAAA,IAAA,MAAAI,IAAA;AAAA,QAAA;AAAA,MAAA;AAAA,aAAAL,EAAAC,CAAA,IAAA,GAAAA,IAAAE;AAAA,IAAA,GAAAI,KAAA,CAAAR,GAAAS,GAAAN,MAAAJ,GAAAC,GAAAtO,GAAA+O,GAAAN,CAAA,GAAAO,KAAA,CAAAV,MAAA;AAAA,eAAAW,IAAA,GAAAxJ,IAAA,GAAAA,IAAA6I,EAAA,QAAA,EAAA7I,GAAA;AAAA,YAAAmC,IAAA0G,EAAA,WAAA7I,CAAA;AAAA,QAAAmC,KAAA,MAAAqH,MAAArH,KAAA,OAAAqH,KAAA,IAAArH,KAAA,SAAAA,KAAA,SAAAqH,KAAA,GAAA,EAAAxJ,KAAAwJ,KAAA;AAAA,MAAA;AAAA,aAAAA;AAAA,IAAA,GAAAC,KAAA,CAAAC,GAAAC,GAAAC,MAAA;AAAA,eAAAV,IAAAS,IAAAC,GAAAf,IAAA,IAAA,EAAAc,KAAAT,MAAA;AAAA,YAAAW,IAAAH,EAAAC,GAAA;AAAA,YAAA,CAAAE,EAAA,QAAAhB;AAAA,YAAA,EAAAgB,IAAA,MAAA;AAAA,UAAAhB,KAAA,OAAA,aAAAgB,CAAA;AAAA;AAAA,QAAA;AAAA,YAAAT,IAAAM,EAAAC,GAAA,IAAA;AAAA,aAAAE,IAAA,QAAA,KAAA;AAAA,UAAAhB,KAAA,OAAA,cAAAgB,IAAA,OAAA,IAAAT,CAAA;AAAA;AAAA,QAAA;AAAA,YAAAU,IAAAJ,EAAAC,GAAA,IAAA;AAAA,aAAAE,IAAA,QAAA,MAAAA,KAAAA,IAAA,OAAA,KAAAT,KAAA,IAAAU,IAAAD,KAAAA,IAAA,MAAA,KAAAT,KAAA,KAAAU,KAAA,IAAAJ,EAAAC,GAAA,IAAA,IAAAE,IAAA;AAAA,UAAAhB,KAAA,OAAA,aAAAgB,CAAA;AAAA,aAAA;AAAA,cAAAE,IAAAF,IAAA;AAAA,UAAAhB,KAAA,OAAA,aAAA,QAAAkB,KAAA,IAAA,QAAAA,IAAA,IAAA;AAAA,QAAA;AAAA,MAAA;AAAA,aAAAlB;AAAA,IAAA,GAAAmB,KAAA,CAAApL,GAAAgL,MAAAhL,IAAA6K,GAAAlP,GAAAqE,GAAAgL,CAAA,IAAA,IAAAK,KAAA,CAAA1H,GAAAb,MAAA;AAAA,MAAAA,IAAAO,EAAAP,CAAA;AAAA,UAAAwI,IAAAxI,MAAA;AAAA,MAAAzB,EAAAsC,GAAA,EAAA,MAAAb,GAAA,aAAA2B,GAAA;AAAA,YAAA8G,IAAAxP,EAAA0I,KAAA,CAAA,GAAA+G,IAAA/G,IAAA,GAAAwF;AAAA,YAAAqB;AAAA,mBAAAG,IAAAD,GAAApK,IAAA,GAAAA,KAAAmK,GAAA,EAAAnK,GAAA;AAAA,gBAAAsK,IAAAF,IAAApK;AAAA,gBAAAA,KAAAmK,KAAA5P,EAAA+P,CAAA,KAAA,GAAA;AAAA,kBAAAC,IAAAD,IAAAD,GAAAG,IAAAR,GAAAK,GAAAE,CAAA;AAAA,cAAA1B,MAAA,SAAAA,IAAA2B,KAAA3B,KAAA,MAAAA,KAAA2B,IAAAH,IAAAC,IAAA;AAAA,YAAA;AAAA,UAAA;AAAA,aAAA;AAAA,mBAAAG,IAAA,IAAA,MAAAN,CAAA,GAAAnK,IAAA,GAAAA,IAAAmK,GAAA,EAAAnK;AAAA,YAAAyK,EAAAzK,CAAA,IAAA,OAAA,aAAAzF,EAAA6P,IAAApK,CAAA,CAAA;AAAA,UAAA6I,IAAA4B,EAAA,KAAA,EAAA;AAAA,QAAA;AAAA,eAAAxD,EAAA5D,CAAA,GAAAwF;AAAA,MAAA,GAAA,WAAA9J,GAAAsE,GAAA;AAAA,QAAAA,aAAA,gBAAAA,IAAA,IAAA,WAAAA,CAAA;AAAA,YAAA8G,GAAAO,IAAA,OAAArH,KAAA;AAAA,QAAAqH,KAAArH,aAAA,cAAAA,aAAA,qBAAAA,aAAA,aAAAhB,EAAA,uCAAA,GAAA6H,KAAAQ,IAAAP,IAAAZ,GAAAlG,CAAA,IAAA8G,IAAA9G,EAAA;AAAA,YAAAsH,IAAAC,GAAA,IAAAT,IAAA,CAAA,GAAAvL,IAAA+L,IAAA;AAAA,YAAAhQ,EAAAgQ,KAAA,CAAA,IAAAR,GAAAD,KAAAQ;AAAA,UAAArB,GAAAhG,GAAAzE,GAAAuL,IAAA,CAAA;AAAA,iBAAAO;AAAA,mBAAA1K,IAAA,GAAAA,IAAAmK,GAAA,EAAAnK,GAAA;AAAA,gBAAA6K,IAAAxH,EAAA,WAAArD,CAAA;AAAA,YAAA6K,IAAA,QAAA5D,EAAArI,CAAA,GAAAyD,EAAA,wDAAA,IAAA9H,EAAAqE,IAAAoB,CAAA,IAAA6K;AAAA,UAAA;AAAA;AAAA,mBAAA7K,IAAA,GAAAA,IAAAmK,GAAA,EAAAnK;AAAA,YAAAzF,EAAAqE,IAAAoB,CAAA,IAAAqD,EAAArD,CAAA;AAAA,eAAAjB,MAAA,QAAAA,EAAA,KAAAkI,GAAA0D,CAAA,GAAAA;AAAA,MAAA,GAAA,gBAAApJ,GAAA,sBAAAtC,GAAA,mBAAAL,GAAA;AAAA,QAAAqI,EAAArI,CAAA;AAAA,MAAA,EAAA,CAAA;AAAA,IAAA,GAAAkM,KAAA,CAAAlM,GAAAgL,MAAA;AAAA,eAAAf,IAAA,IAAA7I,IAAA,GAAA,EAAAA,KAAA4J,IAAA,IAAA,EAAA5J,GAAA;AAAA,YAAA+K,IAAAvQ,EAAAoE,IAAAoB,IAAA,KAAA,CAAA;AAAA,YAAA+K,KAAA,EAAA;AAAA,QAAAlC,KAAA,OAAA,aAAAkC,CAAA;AAAA,MAAA;AAAA,aAAAlC;AAAA,IAAA,GAAAmC,KAAA,CAAAnC,GAAAS,GAAAN,MAAA;AAAA,UAAAA,UAAA,aAAAA,IAAA,EAAA,QAAA;AAAA,MAAAA,KAAA;AAAA,eAAAiC,IAAA3B,GAAA4B,IAAAlC,IAAAH,EAAA,SAAA,IAAAG,IAAA,IAAAH,EAAA,QAAA7I,IAAA,GAAAA,IAAAkL,GAAA,EAAAlL,GAAA;AAAA,YAAA+K,IAAAlC,EAAA,WAAA7I,CAAA;AAAA,QAAAxF,EAAA8O,KAAA,CAAA,IAAAyB,GAAAzB,KAAA;AAAA,MAAA;AAAA,aAAA9O,EAAA8O,KAAA,CAAA,IAAA,GAAAA,IAAA2B;AAAA,IAAA,GAAAE,KAAA,CAAAtC,MAAAA,EAAA,SAAA,GAAAuC,KAAA,CAAAxM,GAAAgL,MAAA;AAAA,eAAA5J,IAAA,GAAA6I,IAAA,IAAA,EAAA7I,KAAA4J,IAAA,MAAA;AAAA,YAAAyB,IAAA3Q,EAAAkE,IAAAoB,IAAA,KAAA,CAAA;AAAA,YAAAqL,KAAA,EAAA;AAAA,YAAA,EAAArL,GAAAqL,KAAA,OAAA;AAAA,cAAAtB,IAAAsB,IAAA;AAAA,UAAAxC,KAAA,OAAA,aAAA,QAAAkB,KAAA,IAAA,QAAAA,IAAA,IAAA;AAAA,QAAA;AAAA,UAAAlB,KAAA,OAAA,aAAAwC,CAAA;AAAA,MAAA;AAAA,aAAAxC;AAAA,IAAA,GAAAyC,KAAA,CAAAzC,GAAAS,GAAAN,MAAA;AAAA,UAAAA,UAAA,aAAAA,IAAA,EAAA,QAAA;AAAA,eAAAiC,IAAA3B,GAAAiC,IAAAN,IAAAjC,IAAA,GAAAhJ,IAAA,GAAAA,IAAA6I,EAAA,QAAA,EAAA7I,GAAA;AAAA,YAAA+K,IAAAlC,EAAA,WAAA7I,CAAA;AAAA,YAAA+K,KAAA,SAAAA,KAAA,OAAA;AAAA,cAAAS,IAAA3C,EAAA,WAAA,EAAA7I,CAAA;AAAA,UAAA+K,IAAA,UAAAA,IAAA,SAAA,MAAAS,IAAA;AAAA,QAAA;AAAA,YAAA9Q,EAAA4O,KAAA,CAAA,IAAAyB,GAAAzB,KAAA,GAAAA,IAAA,IAAAiC,EAAA;AAAA,MAAA;AAAA,aAAA7Q,EAAA4O,KAAA,CAAA,IAAA,GAAAA,IAAA2B;AAAA,IAAA,GAAAQ,KAAA,CAAA5C,MAAA;AAAA,eAAAW,IAAA,GAAAxJ,IAAA,GAAAA,IAAA6I,EAAA,QAAA,EAAA7I,GAAA;AAAA,YAAA+K,IAAAlC,EAAA,WAAA7I,CAAA;AAAA,QAAA+K,KAAA,SAAAA,KAAA,SAAA,EAAA/K,GAAAwJ,KAAA;AAAA,MAAA;AAAA,aAAAA;AAAA,IAAA,GAAAkC,KAAA,CAAAnJ,GAAAoJ,GAAAjK,MAAA;AAAA,MAAAA,IAAAO,EAAAP,CAAA;AAAA,UAAAkK,GAAAC,GAAAC,GAAAC;AAAA,MAAAJ,MAAA,KAAAC,IAAAd,IAAAe,IAAAb,IAAAe,IAAAZ,IAAAW,IAAA,CAAA5M,MAAAzE,GAAAyE,KAAA,CAAA,KAAAyM,MAAA,MAAAC,IAAAR,IAAAS,IAAAP,IAAAS,IAAAN,IAAAK,IAAA,CAAA5M,MAAAvE,EAAAuE,KAAA,CAAA,IAAAe,EAAAsC,GAAA,EAAA,MAAAb,GAAA,cAAA,CAAA2B,MAAA;AAAA,iBAAA8G,IAAAxP,EAAA0I,KAAA,CAAA,GAAAwF,GAAAwB,IAAAhH,IAAA,GAAArD,IAAA,GAAAA,KAAAmK,GAAA,EAAAnK,GAAA;AAAA,cAAAsK,IAAAjH,IAAA,IAAArD,IAAA2L;AAAA,cAAA3L,KAAAmK,KAAA2B,EAAAxB,CAAA,KAAA,GAAA;AAAA,gBAAA0B,IAAA1B,IAAAD,GAAAG,IAAAoB,EAAAvB,GAAA2B,CAAA;AAAA,YAAAnD,MAAA,SAAAA,IAAA2B,KAAA3B,KAAA,MAAAA,KAAA2B,IAAAH,IAAAC,IAAAqB;AAAA,UAAA;AAAA,QAAA;AAAA,eAAA1E,EAAA5D,CAAA,GAAAwF;AAAA,MAAA,GAAA,YAAA,CAAA9J,GAAAsE,MAAA;AAAA,QAAA,OAAAA,KAAA,YAAAhB,EAAA,6CAAAX,CAAA,EAAA;AAAA,YAAAyI,IAAA4B,EAAA1I,CAAA,GAAAzE,IAAAgM,GAAA,IAAAT,IAAAwB,CAAA;AAAA,eAAAhR,EAAAiE,KAAA,CAAA,IAAAuL,IAAAwB,GAAAE,EAAAxI,GAAAzE,IAAA,GAAAuL,IAAAwB,CAAA,GAAA5M,MAAA,QAAAA,EAAA,KAAAkI,GAAArI,CAAA,GAAAA;AAAA,MAAA,GAAA,gBAAA2C,GAAA,sBAAAtC,GAAA,mBAAAL,GAAA;AAAA,QAAAqI,EAAArI,CAAA;AAAA,MAAA,EAAA,CAAA;AAAA,IAAA,GAAAqN,KAAA,CAAA1J,GAAAb,GAAAwK,GAAA1L,GAAA2L,GAAA1L,MAAA;AAAA,MAAA5B,EAAA0D,CAAA,IAAA,EAAA,MAAAN,EAAAP,CAAA,GAAA,gBAAA0E,EAAA8F,GAAA1L,CAAA,GAAA,eAAA4F,EAAA+F,GAAA1L,CAAA,GAAA,QAAA,CAAA,EAAA;AAAA,IAAA,GAAA2L,KAAA,CAAA9L,GAAAQ,GAAAC,GAAAsL,GAAArL,GAAAC,GAAAC,GAAAoL,GAAAnL,GAAAC,MAAA;AAAA,MAAAvC,EAAAyB,CAAA,EAAA,OAAA,KAAA,EAAA,WAAA2B,EAAAnB,CAAA,GAAA,kBAAAC,GAAA,QAAAqF,EAAAiG,GAAArL,CAAA,GAAA,eAAAC,GAAA,oBAAAC,GAAA,QAAAkF,EAAAkG,GAAAnL,CAAA,GAAA,eAAAC,EAAA,CAAA;AAAA,IAAA,GAAAmL,KAAA,CAAAhK,GAAAb,MAAA;AAAA,MAAAA,IAAAO,EAAAP,CAAA,GAAAzB,EAAAsC,GAAA,EAAA,QAAA,IAAA,MAAAb,GAAA,gBAAA,GAAA,cAAA,MAAA;AAAA,SAAA,YAAA,CAAA3C,GAAAsC,MAAA;AAAA,QAAA,CAAA;AAAA,IAAA,GAAAmL,KAAA,CAAAC,GAAAC,GAAAC,MAAApS,EAAA,WAAAkS,GAAAC,GAAAA,IAAAC,CAAA,GAAAC,KAAA,IAAAC,KAAA,CAAAC,GAAA7J,GAAA8J,GAAApI,OAAAmI,IAAAF,GAAAE,CAAA,GAAA7J,IAAAG,EAAA,QAAAH,CAAA,GAAA6J,EAAA,MAAA7J,GAAA8J,GAAApI,CAAA,IAAAqI,KAAA,CAAA,GAAAC,KAAA,CAAAC,MAAA;AAAA,UAAAC,IAAAH,GAAAE,CAAA;AAAA,aAAAC,MAAA,SAAAlL,EAAAiL,CAAA,IAAAC;AAAA,IAAA,GAAAC,KAAA,MAAA;AAAA,UAAA,OAAA,cAAA;AAAA,eAAA;AAAA,eAAAC,EAAAC,GAAA;AAAA,QAAAA,EAAA,sBAAAA;AAAA,YAAAC,IAAA,OAAA,uBAAA,YAAAD,EAAA,uBAAAA;AAAA,eAAAC,KAAA,OAAAD,EAAA,qBAAAC;AAAA,MAAA;AAAA,UAAA,OAAA,uBAAA,aAAA,OAAA,UAAA,YAAAF,EAAA,MAAA,IAAA,sBAAA,SAAA,OAAA,QAAA,YAAAA,EAAA,IAAA,MAAA,sBAAA,OAAA,OAAA,uBAAA;AAAA,eAAA;AAAA,YAAA,MAAA,8BAAA;AAAA,IAAA,GAAAG,KAAA,CAAA9L,MAAAA,MAAA,IAAA0B,EAAA,SAAAgK,IAAA,KAAA1L,IAAAuL,GAAAvL,CAAA,GAAA0B,EAAA,SAAAgK,KAAA1L,CAAA,CAAA,IAAA+L,KAAA,CAAAX,MAAA;AAAA,UAAAhR,IAAA8Q,GAAA;AAAA,aAAAA,GAAA,KAAAE,CAAA,GAAAhR;AAAA,IAAA,GAAA4R,KAAA,CAAAnL,GAAAwB,MAAA;AAAA,UAAA4J,IAAAvO,EAAAmD,CAAA;AAAA,aAAAoL,MAAA,UAAAtL,EAAA,GAAA0B,CAAA,qBAAAgD,GAAAxE,CAAA,CAAA,EAAA,GAAAoL;AAAA,IAAA,GAAAC,KAAA,CAAAxJ,GAAAP,MAAA;AAAA,eAAA4G,IAAA,IAAA,MAAArG,CAAA,GAAApE,IAAA,GAAAA,IAAAoE,GAAA,EAAApE;AAAA,QAAAyK,EAAAzK,CAAA,IAAA0N,GAAA/S,EAAAkJ,IAAA7D,IAAA,KAAA,CAAA,GAAA,eAAAA,CAAA;AAAA,aAAAyK;AAAA,IAAA,GAAAoD,KAAA,QAAA,WAAAC,KAAA,CAAAC,GAAAhB,GAAA9J,MAAA;AAAA,UAAAlE,IAAA,CAAA,GAAA5B,IAAA4Q,EAAA,WAAAhP,GAAAkE,CAAA;AAAA,aAAAlE,EAAA,WAAApE,EAAAoS,KAAA,CAAA,IAAA3J,EAAA,SAAArE,CAAA,IAAA5B;AAAA,IAAA,GAAA6Q,KAAA,CAAA5J,GAAAP,GAAAoK,MAAA;AAAA,UAAA9G,IAAAyG,GAAAxJ,GAAAP,CAAA,GAAAqK,IAAA/G,EAAA,MAAA;AAAA,MAAA/C;AAAA,UAAA+J,IAAA,IAAA,MAAA/J,CAAA,GAAAgK,IAAA,CAAAd,GAAAtH,GAAA+G,GAAApI,MAAA;AAAA,iBAAA0J,IAAA,GAAArO,IAAA,GAAAA,IAAAoE,GAAA,EAAApE;AAAA,UAAAmO,EAAAnO,CAAA,IAAAmH,EAAAnH,CAAA,EAAA,qBAAA2E,IAAA0J,CAAA,GAAAA,KAAAlH,EAAAnH,CAAA,EAAA;AAAA,YAAAsB,IAAA2M,MAAA,IAAAJ,GAAA7H,GAAAmI,CAAA,IAAAnI,EAAA,MAAAsH,GAAAa,CAAA;AAAA,eAAAL,GAAAI,GAAAnB,GAAAzL,CAAA;AAAA,MAAA,GAAAgN,IAAA,iBAAAnH,EAAA,IAAA,CAAAoH,MAAAA,EAAA,IAAA,EAAA,KAAA,IAAA,CAAA,QAAAL,EAAA,IAAA;AAAA,aAAAT,GAAA/J,GAAA4K,GAAAF,CAAA,CAAA;AAAA,IAAA,GAAAI,KAAA,CAAAvL,MAAA;AAAA,UAAAlE,IAAAqE,EAAA,QAAAH,CAAA;AAAA,MAAAnE,GAAAC,CAAA,GAAAiE,GAAAC,CAAA;AAAA,IAAA,GAAAwL,KAAA,MAAA;AAAA,MAAAvS,GAAA,EAAA;AAAA,IAAA,GAAAwS,KAAA,MAAA,YAAAC,KAAA,CAAAhN,MAAA;AAAA,UAAA5G,IAAAX,EAAA,QAAAwU,KAAAjN,IAAA5G,EAAA,aAAA,SAAA;AAAA,UAAA;AAAA,eAAAX,EAAA,KAAAwU,CAAA,GAAA9T,MAAA;AAAA,MAAA,QAAA;AAAA,MAAA;AAAA,IAAA,GAAA+T,KAAA,CAAAC,MAAA;AAAA,UAAAC,IAAAxU,EAAA;AAAA,MAAAuU,OAAA;AAAA,UAAAE,IAAAN,GAAA;AAAA,UAAAI,IAAAE;AAAA,eAAA;AAAA,eAAAC,IAAA,CAAAC,GAAAC,MAAAD,KAAAC,IAAAD,IAAAC,KAAAA,GAAAC,IAAA,GAAAA,KAAA,GAAAA,KAAA,GAAA;AAAA,YAAAC,IAAAN,KAAA,IAAA,MAAAK;AAAA,QAAAC,IAAA,KAAA,IAAAA,GAAAP,IAAA,SAAA;AAAA,YAAAQ,IAAA,KAAA,IAAAN,GAAAC,EAAA,KAAA,IAAAH,GAAAO,CAAA,GAAA,KAAA,CAAA,GAAAE,IAAAZ,GAAAW,CAAA;AAAA,YAAAC;AAAA,iBAAA;AAAA,MAAA;AAAA,aAAA;AAAA,IAAA,GAAAC,KAAA,CAAA,GAAAC,KAAA,MAAApW,MAAA,kBAAAqW,IAAA,MAAA;AAAA,UAAA,CAAAA,EAAA,SAAA;AAAA,YAAAC,KAAA,OAAA,aAAA,YAAA,UAAA,aAAA,UAAA,UAAA,CAAA,KAAA,KAAA,QAAA,KAAA,GAAA,IAAA,UAAAC,IAAA,EAAA,MAAA,YAAA,SAAA,YAAA,MAAA,KAAA,KAAA,KAAA,MAAA,kBAAA,MAAAD,GAAA,GAAAF,GAAA,EAAA;AAAA,iBAAAP,KAAAM;AAAA,UAAAA,GAAAN,CAAA,MAAA,SAAA,OAAAU,EAAAV,CAAA,IAAAU,EAAAV,CAAA,IAAAM,GAAAN,CAAA;AAAA,YAAAW,IAAA,CAAA;AAAA,iBAAAX,KAAAU;AAAA,UAAAC,EAAA,KAAA,GAAAX,CAAA,IAAAU,EAAAV,CAAA,CAAA,EAAA;AAAA,QAAAQ,EAAA,UAAAG;AAAA,MAAA;AAAA,aAAAH,EAAA;AAAA,IAAA,GAAAI,KAAA,CAAAjH,GAAAkH,MAAA;AAAA,eAAA/P,IAAA,GAAAA,IAAA6I,EAAA,QAAA,EAAA7I;AAAA,QAAA1F,EAAAyV,GAAA,IAAAlH,EAAA,WAAA7I,CAAA;AAAA,MAAA1F,EAAAyV,CAAA,IAAA;AAAA,IAAA,GAAAC,KAAA,CAAAC,GAAAC,MAAA;AAAA,UAAAC,IAAA;AAAA,aAAAT,EAAA,EAAA,QAAA,CAAAU,GAAApQ,MAAA;AAAA,YAAApB,IAAAsR,IAAAC;AAAA,QAAAxV,EAAAsV,IAAAjQ,IAAA,KAAA,CAAA,IAAApB,GAAAkR,GAAAM,GAAAxR,CAAA,GAAAuR,KAAAC,EAAA,SAAA;AAAA,MAAA,CAAA,GAAA;AAAA,IAAA,GAAAC,KAAA,CAAAC,GAAAC,MAAA;AAAA,UAAAV,IAAAH,EAAA;AAAA,MAAA/U,EAAA2V,KAAA,CAAA,IAAAT,EAAA;AAAA,UAAAM,IAAA;AAAA,aAAAN,EAAA,QAAA,CAAAO,MAAAD,KAAAC,EAAA,SAAA,CAAA,GAAAzV,EAAA4V,KAAA,CAAA,IAAAJ,GAAA;AAAA,IAAA,GAAAK,KAAA,CAAAC,MAAA;AAAA,MAAAnX,GAAAmX,GAAA,IAAA3S,GAAA2S,CAAA,CAAA;AAAA,IAAA,GAAAC,KAAA,CAAAnX,GAAAoX,MAAA;AAAA,MAAAH,GAAAjX,CAAA;AAAA,IAAA,GAAAqX,KAAAF,IAAAG,KAAA,CAAAC,MAAA;AAAA,aAAAC,GAAAD,GAAAE,GAAAC,GAAAC,GAAAC,GAAA;AAAA,aAAA;AAAA,IAAA;AAAA,QAAAC,KAAA,CAAA,MAAA,CAAA,GAAA,EAAA,GAAAC,KAAA,CAAAC,GAAAC,MAAA;AAAA,UAAAxB,IAAAqB,GAAAE,CAAA;AAAA,MAAAC,MAAA,KAAAA,MAAA,OAAAD,MAAA,IAAArX,KAAAC,GAAAuP,GAAAsG,GAAA,CAAA,CAAA,GAAAA,EAAA,SAAA,KAAAA,EAAA,KAAAwB,CAAA;AAAA,IAAA,GAAAC,KAAA,CAAAV,GAAAW,GAAAC,GAAAC,MAAA;AAAA,eAAAhF,IAAA,GAAA3M,IAAA,GAAAA,IAAA0R,GAAA1R,KAAA;AAAA,YAAApB,IAAAjE,EAAA8W,KAAA,CAAA,GAAAjI,IAAA7O,EAAA8W,IAAA,KAAA,CAAA;AAAA,QAAAA,KAAA;AAAA,iBAAAG,IAAA,GAAAA,IAAApI,GAAAoI;AAAA,UAAAP,GAAAP,GAAAvW,EAAAqE,IAAAgT,CAAA,CAAA;AAAA,QAAAjF,KAAAnD;AAAA,MAAA;AAAA,aAAA7O,EAAAgX,KAAA,CAAA,IAAAhF,GAAA;AAAA,IAAA;AAAA,IAAArN,KAAA/G,EAAA,gBAAA,cAAA,MAAA;AAAA,MAAA,YAAAiH,GAAA;AAAA,cAAAA,CAAA,GAAA,KAAA,OAAA;AAAA,MAAA;AAAA,IAAA,GAAAsC,MAAAM,KAAA7J,EAAA,eAAA,cAAA,MAAA;AAAA,MAAA,YAAAiH,GAAA;AAAA,cAAAA,CAAA,GAAA,KAAA,OAAA;AAAA,MAAA;AAAA,IAAA,GAAA2D,GAAA,GAAA2D,KAAAvO,EAAA,mBAAAkO,GAAA,OAAA,kBAAA;AAAA,QAAAnJ,KAAA,EAAA,GAAAqB,IAAA,GAAA0B,IAAA,GAAAmB,IAAA,GAAAkB,IAAA,GAAAa,IAAA,GAAAE,IAAA,GAAAgE,IAAA,GAAAO,IAAA,GAAAO,IAAA,GAAA0B,IAAA,GAAAyB,IAAA,GAAAO,IAAA,GAAAG,IAAA,GAAAG,IAAA,GAAAC,IAAA,GAAAK,IAAA,GAAA7J,IAAA,GAAAwK,IAAA,GAAAQ,IAAA,GAAAQ,IAAA,GAAAC,IAAA,GAAAI,IAAA,GAAAmB,IAAA,GAAAK,IAAA,GAAAO,IAAA,GAAAC,IAAA,GAAAE,IAAA,GAAAS,GAAA,GAAA9T,IAAAN,MAAA4J,KAAA,CAAA6K,OAAA7K,KAAAtJ,EAAA,GAAAmU,CAAA,GAAAjH,KAAA,CAAAiH,OAAAjH,KAAAlN,EAAA,GAAAmU,CAAA,GAAA5K,IAAA,CAAA4K,OAAA5K,IAAAvJ,EAAA,GAAAmU,CAAA,GAAArT,KAAA,CAAAqT,OAAArT,KAAAd,EAAA,GAAAmU,CAAA;AAAA,IAAAtZ,EAAA,eAAA,CAAAsZ,GAAAC,GAAAC,GAAAC,GAAAC,OAAA1Z,EAAA,eAAAmF,EAAA,GAAAmU,GAAAC,GAAAC,GAAAC,GAAAC,CAAA;AAAA,QAAAC;AAAA,IAAAtW,IAAA,SAAAuW,IAAA;AAAA,MAAAD,MAAAE,GAAA,GAAAF,OAAAtW,IAAAuW;AAAA,IAAA;AAAA,aAAAC,KAAA;AAAA,UAAAzW,IAAA,MAAAR,GAAA,GAAAQ,IAAA;AAAA;AAAA,eAAA0W,IAAA;AAAA,QAAAH,OAAAA,KAAA,IAAA3Z,EAAA,YAAA,IAAA,CAAA8B,OAAAiB,GAAA,GAAA5C,EAAAH,CAAA,GAAAA,EAAA,wBAAAA,EAAA,qBAAA,GAAAgD;MAAA;AAAA,MAAAhD,EAAA,aAAAA,EAAA,UAAA,YAAA,GAAA,WAAA,WAAA;AAAA,mBAAA,WAAA;AAAA,UAAAA,EAAA,UAAA,EAAA;AAAA,QAAA,GAAA,CAAA,GAAA8Z,EAAA;AAAA,MAAA,GAAA,CAAA,KAAAA,EAAA;AAAA,IAAA;AAAA,QAAA9Z,EAAA;AAAA,WAAA,OAAAA,EAAA,WAAA,eAAAA,EAAA,UAAA,CAAAA,EAAA,OAAA,IAAAA,EAAA,QAAA,SAAA;AAAA,QAAAA,EAAA,QAAA,IAAA,EAAA;AAAA,WAAA6Z,GAAA,GAGt8JxZ;AAAA,EACA;AAEA,GAAA;ACVO,MAAM0Z,KAAiB;AAAA,EAC1B,SAAS;AAAA,EACT,UAAU;AAAA,EACV,YAAY;AAAA,EACZ,aAAa;AAAA,EACb,iBAAiB;AAAA,EACjB,WAAW;AAAA,EACX,aAAa;AAAA,EACb,aAAa;AAAA,EACb,mBAAmB;AAAA,EACnB,kBAAkB;AAAA,EAClB,mBAAmB;AAAA,EACnB,eAAe;AAAA,EACf,gBAAgB;AAAA,EAChB,kBAAkB;AAAA,EAClB,yBAAyB;AAAA,EACzB,gBAAgB;AACpB;ACLO,SAASC,GAAqBC,GAAeC,GAAYC,IAAwB,CAAA,GAAI;AACxF,MAAIC;AACJ,SAAIF,MACAE,IAAkB,CAAC7V,GAASb,MAAa;AACrC,UAAMuB,KAAW,IAAI,YAAY,SAASiV,GAAY3V,CAAO;AAC7D,WAAAb,EAASuB,EAAQ,GACVA,GAAS;AAAA,EACnB,IAEEgV,EAAc;AAAA;AAAA,IAEjB,cAAc;AAAA,IACd,iBAAAG;AAAA,IACA,GAAGD;AAAA,EACX,CAAK;AACL;ACfA,IAAIE;AACG,eAAeC,GAAKpV,GAAQiV,GAAuB;AACtD,EAAAE,KAAmBL,GAAqBO,IAAarV,GAAQiV,CAAqB;AACtF;AACe,eAAeK,GAAO9Z,GAAMwJ,IAAU,IAAI;AACrD,EAAKmQ,MACDC,GAAM;AACV,QAAMpV,IAAS,MAAMmV,IACfI,IAAW,EAAE,GAAGV,IAAgB,GAAG7P,EAAS;AAGlD,SAFmBhF,EAAO,OAAOxE,EAAK,MAAMA,EAAK,OAAOA,EAAK,QAAQ+Z,CAAQ,EAE3D;AACtB;ACgBO,MAAMC,WAA0B,MAAM;AAAA,EAC3C,YAAYzT,GAAwB0T,GAAuBC,GAAiB;AAC1E,UAAM3T,CAAO,GADqB,KAAA,SAAA0T,GAAuB,KAAA,QAAAC;AAAA,EAAA;AAG7D;AAEO,MAAMC,KAAwC;AAAA,EACnD,SAAS;AAAA,EACT,aAAa;AAAA,EACb,iBAAiB;AAAA,EACjB,WAAW;AAAA,EACX,aAAa;AAAA;AAAA,EACb,aAAa;AAAA,EACb,mBAAmB;AAAA,EACnB,mBAAmB;AAAA,EACnB,kBAAkB;AAAA,EAClB,eAAe;AAAA,EACf,gBAAgB;AAAA,EAChB,kBAAkB;AAAA,EAClB,yBAAyB;AAAA,EACzB,gBAAgB;AAAA,EAChB,YAAY;AAAA,EACZ,UAAU;AACZ;ACpDA,IAAIC,KAAqB;AACzB,MAAMC,IAAS,IAAI,gBAAgB,GAAG,CAAC;AAEvC,KAAK,YAAY,eACfC,GACA;AACI,MAAA,iBAAiBA,EAAI,KAAK,MAAM;AAClC,YAAQ,MAAM,sCAAsC;AACpD,UAAM9V,IAAS,MAAM,YAAY,QAAQ8V,EAAI,KAAK,KAAK,WAAW;AAClE,UAAMC,GAAe/V,CAAM,GACN4V,KAAA,IACrB,QAAQ,MAAM,qCAAqC,GACnD,KAAK,YAAY;AAAA,MACf,OAAOE,EAAI;AAAA,MACX,QAAQ,CAAA;AAAA,IAAC,CACV;AACD;AAAA,EAAA;AAGI,QAAAE,IAASF,EAAI,KAAK;AACxB,UAAQ,MAAM,sCAAsCA,EAAI,KAAK,IAAIE,CAAM;AACnE,MAAAC;AACA,MAAA;AACE,QAAAD,EAAO,WAAW,WAAW;AAC/B,UAAI,CAACJ;AACG,cAAA,IAAI,MAAM,iCAAiC;AAEnC,MAAAK,IAAA,MAAMC,GAAoBF,CAAM;AAAA,IAAA,WACvCA,EAAO,WAAW;AACX,MAAAC,IAAA,MAAME,GAA2BH,CAAM;AAAA;AAEjD,YAAA,IAAI,MAAM,iCAAiC;AAAA,WAE5CvZ,GAAK;AACZ,YAAQ,MAAM,6BAA6BA,CAAG,IAAIqZ,EAAI,KAAK,IAAIrZ,CAAG,GAC7D,KAAA;AAAA,MACH,IAAI+Y;AAAA,QACF,6BAA6B/Y,CAAG;AAAA,QAChCqZ,EAAI,KAAK;AAAA,QACTrZ;AAAA,MAAA;AAAA,IAEJ;AACA;AAAA,EAAA;AAEF,QAAMiD,IAAS;AAAA,IACb,OAAOoW,EAAI;AAAA,IACX,QAAQ;AAAA,MACN,UAAUG;AAAA,MACV,YAAYA,EAAc,SAASD,EAAO,UAAU;AAAA,IAAA;AAAA,EAExD;AACA,OAAK,YAAYtW,CAAM,GACvB,QAAQ,MAAM,sCAAsCA,EAAO,OAAO,UAAU,EAAE;AAChF;AAEA,SAAS0W,GACPC,GACAC,GACe;AACf,SAAO,IAAI,QAAQ,OAAOlb,GAASC,MAAW;AACxC,QAAA;AACF,YAAMkb,IAAS,MAAM;AAAA,QACnB,IAAI,KAAK,CAACF,CAAS,GAAG,EAAE,MAAMC,EAAa,CAAA;AAAA,MAC7C;AACA,MAAAT,EAAO,QAAQU,EAAO,OACtBV,EAAO,SAASU,EAAO;AACjB,YAAAC,IAAMX,EAAO,WAAW,IAAI;AAClC,UAAI,CAACW,GAAK;AACD,QAAAnb,EAAA,IAAI,MAAM,0BAA0B,CAAC;AAC5C;AAAA,MAAA;AAEE,MAAAmb,EAAA,UAAUD,GAAQ,GAAG,CAAC,GAClBnb,EAAA;AAAA,aACDqB,GAAK;AACZ,MAAApB,EAAOoB,CAAG;AACV;AAAA,IAAA;AAAA,EACF,CACD;AACH;AAEA,eAAeyZ,GACbF,GACqB;AACrB,QAAMI,GAAkBJ,EAAO,WAAWA,EAAO,WAAW;AACtD,QAAAS,IAAYZ,EACf,WAAW,IAAI,EACf,aAAa,GAAG,GAAGA,EAAO,OAAOA,EAAO,MAAM,GAC3Ca,IAAU,MAAMpB,GAAOmB,GAAW;AAAA,IACtC,GAAGd;AAAA,IACH,GAAGK;AAAA,EAAA,CACJ;AACM,SAAA,IAAI,WAAWU,CAAO;AAC/B;AAEA,eAAeP,GACbH,GACqB;AACrB,QAAMI,GAAkBJ,EAAO,WAAWA,EAAO,WAAW;AACtD,QAAAU,IAAU,MAAMb,EAAO,cAAc;AAAA,IACzC,MAAM;AAAA,IACN,SAASG,EAAO,UAAU;AAAA,EAAA,CAC3B;AACD,SAAO,IAAI,WAAW,MAAMU,EAAQ,aAAa;AACnD;","x_google_ignoreList":[0,1,2,3]}
\ No newline at end of file
diff --git a/node_modules/pdiiif/dist/convert.d.ts b/node_modules/pdiiif/dist/convert.d.ts
new file mode 100644
index 0000000..d5c51c0
--- /dev/null
+++ b/node_modules/pdiiif/dist/convert.d.ts
@@ -0,0 +1,218 @@
+import { Writable } from 'stream';
+import { Manifest, Annotation as IIIF3Annotation } from '@iiif/presentation-3';
+import { CanvasNormalized } from '@iiif/presentation-3-normalized';
+import { default as Presentation2 } from '@iiif/presentation-2';
+import { OptimizationParams } from './optimization.js';
+
+/** Progress information for rendering a progress bar or similar UI elements. */
+export interface ProgressStatus {
+    /** Message code that should be mapped to a human readable description in a UI. */
+    messageCode?: ProgressMessageCode;
+    /** Expected total number of pages in the PDF */
+    totalPages: number;
+    /** Number of pages that were submitted for writing */
+    pagesWritten: number;
+    /** Number of bytes that were submitted for writing to the output stream */
+    bytesPushed: number;
+    /** Number of bytes that were written to the output stream so far */
+    bytesWritten: number;
+    /** Predicted size of the final file in bytes */
+    estimatedFileSize?: number;
+    /** Write speed in bytes per second */
+    writeSpeed: number;
+    /** Estimated time in seconds until PDF has finished generating */
+    remainingDuration: number;
+}
+/** Parameters for rendering a cover page, parsed from IIIF manifest. */
+export interface CoverPageParams {
+    title: string;
+    manifestUrl: string;
+    thumbnail?: {
+        url: string;
+        iiifImageService?: string;
+    };
+    provider?: {
+        label: string;
+        homepage?: string;
+        logo?: string;
+    };
+    requiredStatement?: {
+        label: string;
+        value: string;
+    };
+    rights?: {
+        text: string;
+        url?: string;
+        logo?: string;
+    };
+    metadata?: Array<[string, string | Array<string>]>;
+    pdiiifVersion: string;
+}
+/** Options for converting a IIIF Manifest to a PDF. */
+export interface ConvertOptions {
+    /** Callback to provide annotations for a given canvas identifier.
+     * Should return either a `sc:AnnotationList` (IIIF2) or an `AnnotationPage` (IIIF3).
+     */
+    fetchCanvasAnnotations?: (canvasId: string) => Promise<Array<IIIF3Annotation> | Array<Presentation2.Annotation>>;
+    /** Pixels per inch to assume for the full resolution version of each canvas.
+        If not set, the conversion will use an available IIIF Physical Dimensions
+        service to calculate the page dimensions instead. */
+    ppi?: number;
+    /** Set of canvas ids to include in PDF, or a predicate to filter canvas identifiers
+        by. By default, all canvases are included in the PDF. */
+    filterCanvases?: readonly string[] | ((canvasId: string) => boolean);
+    /** List of languages to use for metadata, page labels and table of contents, in
+        descending order of preference. Will use the environment's locale settings by
+        default. */
+    languagePreference?: readonly string[];
+    /** Restrict the image size to include in the PDF by downscaling by a fixed factor.
+     * The value must be a number between 0.1 and 1.
+     * Only works with Level 2 Image API services that allow arbitrary downscaling, the
+     * conversion will not perform downscaling itself.
+     * For Level 1 endpoints, the closest available lower width will be selected. */
+    scaleFactor?: number;
+    /** Number of maximum concurrent IIIF Image API requests to be performed, defaults to 1 */
+    concurrency?: number;
+    /** Callback that gets called whenever a page has finished, useful to render a
+        progress bar. */
+    onProgress?: (status: ProgressStatus) => void;
+    /** Callback that gets called with a notification when an error occurs during PDF generation
+     *  that does not cause the conversion to fail. */
+    onNotification?: (notification: ProgressNotification) => void;
+    /** Controller that allows aborting the PDF generation. All pending
+        downloads will be terminated. The caller is responsible for
+        removing underlying partial files and/or other user signaling. */
+    abortController?: AbortController;
+    /** Set PDF metadata, by default `Title` will be the manifest's label. */
+    metadata?: {
+        CreationDate?: Date;
+        Title?: string;
+        Author?: string;
+        Keywords?: string;
+    };
+    /** Endpoint to contact for retrieving PDF data with one or more cover pages
+        to insert before the canvas pages */
+    coverPageEndpoint?: string;
+    /** Callback to call for retrieving PDF data with one or more cover pages
+        to insert before the canvas pages */
+    coverPageCallback?: (params: CoverPageParams) => Promise<Uint8Array>;
+    /** Generate the PDF in a way that the resulting file is also a valid
+     *  ZIP file that contains the manifest, all of the images and, if present,
+     *  the OCR files referenced in the manifest. */
+    polyglotZipPdf?: boolean;
+    /** Base directory in the polyglot ZIP archive. If not set, all resource
+     * directories will be to-level in the archive. */
+    polyglotZipBaseDir?: string;
+    /** Custom loader callback that fetches the WASM binary for the `sax-wasm`
+     *  dependency (v2.2.4). By default, the dependency will be loaded from
+     *  `https://unpkg.com/sax-wasm/dist/sax-wasm.wasm`. Override if you want
+     *  to provide your own payload. Loader will not be called if {@link initialize}
+     *  from `ocr-parser` has been called before.
+     */
+    saxWasmLoader?: () => Promise<Uint8Array>;
+    /** Custom loader callback that fetches the WASM binary for the `@jsquash/jpeg`
+     * dependency (v1.5.0). By default the dependency will be loaded from
+     * `https://unpkg.com/@jsquash/jpeg@1.5.0/codec/enc/mozjpeg_enc.wasm`. Override
+     * if you want to provide your own payload. Loader will not be called if
+     * {@link optimization} is not set to use the `mozjpeg` method.
+     */
+    mozjpegWasmLoader?: () => Promise<Uint8Array>;
+    /** Parameters for optimizing the images for size by re-encoding them to JPEGs. */
+    optimization?: OptimizationParams;
+}
+/** Parameters for size estimation */
+export interface EstimationParams {
+    /** The manifest to determine the PDF size for */
+    manifest: string | Manifest | Presentation2.Manifest;
+    /** Restrict the image size to include in the PDF by downscaling by a fixed factor.
+     * The value must be a number between 0.1 and 1.
+     * Only works with Level 2 Image API services that allow arbitrary downscaling, the
+     * conversion will not perform downscaling itself.
+     * For Level 1 endpoints, the closest available lower width will be selected. */
+    scaleFactor?: number;
+    /** Set of canvas ids to include in PDF, or a predicate to filter canvas identifiers
+        by. By default, all canvases are included in the PDF. */
+    filterCanvases?: readonly string[] | ((canvasId: string) => boolean);
+    /** Number of canvses to sample for estimation, defaults to 8 */
+    numSamples?: number;
+    /** Number of maximum concurrent IIIF Image API requests to be performed, defaults to 1 */
+    concurrency?: number;
+    /** Parameters for optimizing the images for size by re-encoding them to JPEGs. */
+    optimization?: OptimizationParams;
+    /** Custom loader callback that fetches the WASM binary for the `sax-wasm`
+     *  dependency (v2.2.4). By default, the dependency will be loaded from
+     *  `https://unpkg.com/sax-wasm/dist/sax-wasm.wasm`. Override if you want
+     *  to provide your own payload. Loader will not be called if {@link initialize}
+     *  from `ocr-parser` has been called before.
+     */
+    saxWasmLoader?: () => Promise<Uint8Array>;
+    /** Custom loader callback that fetches the WASM binary for the `@jsquash/jpeg`
+     * dependency (v1.5.0). By default the dependency will be loaded from
+     * `https://unpkg.com/@jsquash/jpeg@1.5.0/codec/enc/mozjpeg_enc.wasm`. Override
+     * if you want to provide your own payload. Loader will not be called if
+     * {@link optimization} is not set to use the `mozjpeg` method.
+     */
+    mozjpegWasmLoader?: () => Promise<Uint8Array>;
+    /** Pre-sampled list of canvases to use for estimating the size */
+    sampleCanvases?: CanvasNormalized[];
+}
+export type Estimation = {
+    /** Estimated size of the PDF in bytes */
+    size: number;
+    /** If CORS is enabled for all of the images referenced in the sample canvases */
+    corsSupported: boolean;
+    /** Image data for a sample image, present when optimization is enabled. */
+    sampleImageData?: Uint8Array;
+    /** Image MIME type for a sample image, present when optimization is enabled. */
+    sampleImageMimeType?: string;
+    /** How large is the PDF after the image optimization, compared to the unoptimized images?  */
+    optimizationResult?: number;
+    /** Canvases that were used for estimating */
+    sampleCanvases: CanvasNormalized[];
+};
+/** Estimate the final size of the PDF for a given manifest.
+ *
+ * This will randomly sample a few representative canvases from the manifest,
+ * check their size in bytes and extrapolate from that to all canvases.
+ *
+ * @throws {Error} if the manifest cannot be loaded
+ */
+export declare function estimatePdfSize({ manifest: inputManifest, concurrency, scaleFactor, filterCanvases, numSamples, optimization, saxWasmLoader, mozjpegWasmLoader, sampleCanvases }: EstimationParams): Promise<Estimation>;
+export type ProgressMessageCode = 'generate-cover-page' | 'generate-pages' | 'finishing';
+export type ProgressNotification = ImageDownloadFailureNotification | OcrDownloadFailureNotification;
+export type ImageDownloadFailureNotification = {
+    code: 'image-download-failure';
+    canvasIndex: number;
+    numFailed: number;
+    numTotal: number;
+    details: {
+        [imageUrl: string]: string;
+    };
+};
+export type OcrDownloadFailureNotification = {
+    code: 'ocr-download-failure';
+    canvasIndex: number;
+    ocrUrl: string;
+};
+export type ConversionReport = {
+    fileSizeBytes: number;
+    numPages: number;
+    fileName?: string;
+    failedImages?: Array<{
+        canvasIndex: number;
+        numFailed: number;
+        numTotal: number;
+        details: {
+            [imageUrl: string]: string;
+        };
+    }>;
+    failedOcr?: Array<{
+        canvasIndex: number;
+        ocrUrl: string;
+    }>;
+};
+export type ConversionReportWithData = ConversionReport & {
+    data: Blob;
+};
+export declare function convertManifest(inputManifest: string | Manifest | Presentation2.Manifest, outputStream: Writable | WritableStream, options: ConvertOptions): Promise<ConversionReport>;
+export declare function convertManifest(inputManifest: string | Manifest | Presentation2.Manifest, outputStream: undefined, options: ConvertOptions): Promise<ConversionReportWithData>;
diff --git a/node_modules/pdiiif/dist/download.d.ts b/node_modules/pdiiif/dist/download.d.ts
new file mode 100644
index 0000000..ac6cda2
--- /dev/null
+++ b/node_modules/pdiiif/dist/download.d.ts
@@ -0,0 +1,99 @@
+import { Mutex } from 'async-mutex';
+import { ImageService, Reference, Service } from '@iiif/presentation-3';
+import { CanvasNormalized, ManifestNormalized, RangeNormalized } from '@iiif/presentation-3-normalized';
+import { OcrPageWithMarkup } from './ocr.js';
+import { Annotation, ImageInfo } from './iiif.js';
+
+/** Maps rate-limited hosts to a mutex that limits the concurrent fetching. */
+declare class RateLimitingRegistry {
+    private hostMutexes;
+    private callbacks;
+    getMutex(host: string): Mutex | undefined;
+    limitHost(host: string): Mutex;
+    unlimitHost(host: string): void;
+    subscribe(cb: (host: string, limited: boolean) => void): number;
+    unsubscribe(ticket: number): void;
+    isLimited(url: string): boolean;
+}
+export declare const rateLimitRegistry: RateLimitingRegistry;
+/** Check if requests to the given host should include credentials */
+export declare function requestsShouldIncludeCredentials(host: string): boolean;
+/** A 'respectful' wrapper around `fetch` that tries to respect rate-limiting headers.
+ *
+ * Will also retry with exponential backoff in case of server errors.
+ */
+export declare function fetchRespectfully(url: string, init?: RequestInit, maxRetries?: number): Promise<Response>;
+/** Container for image size along with its corresponding IIIF Image API string. */
+export type SizeInfo = {
+    iiifSize: string;
+    width: number;
+    height: number;
+};
+/** Calculate the image size to fetch, based on user constraints and available sizes
+ *  in the Image API info.json response.
+ */
+export declare function getImageSize(imgService: ImageService, scaleFactor?: number): SizeInfo;
+/** Use a IIIF Physical Dimensions service to obtain the PPI for a canvas. */
+export declare function getPointsPerInch(services: Service[]): number | null;
+export declare function isImageFetchFailure(obj: CanvasImageData | ImageFetchFailure): obj is ImageFetchFailure;
+/** All the data relevant for the canvas: images and text */
+export type CanvasData = {
+    canvas: Reference<'Canvas'>;
+    text?: OcrPageWithMarkup;
+    images: CanvasImage[];
+    annotations: Annotation[];
+    ppi?: number;
+    imageFailures: ImageFetchFailure[];
+};
+export type ImageFetchFailure = ImageInfo & {
+    cause: Error | string;
+};
+/** Data and additional information for an image on a canvas. */
+export type CanvasImage = ImageInfo & CanvasImageData;
+/** Data and additional info for a canvas image, based on retrieval
+ *  of external resources.
+ */
+export type CanvasImageData = {
+    data?: ArrayBuffer;
+    numBytes: number;
+    format: 'jpeg' | 'png';
+    corsAvailable: boolean;
+    ppi?: number;
+    nativeWidth?: number;
+    nativeHeight?: number;
+    downscaled?: boolean;
+};
+/** Options for fetching image */
+export type FetchImageOptions = {
+    scaleFactor?: number;
+    ppiOverride?: number;
+    abortSignal?: AbortSignal;
+    sizeOnly?: boolean;
+};
+/** Information about the starting canvas of a Manifet or a Range.
+ * Can point to a whole canvas or to a part of it. */
+export type StartCanvasInfo = string | {
+    id: string;
+    ppi: number;
+    dimensions: {
+        width: number;
+        height: number;
+    };
+    position: {
+        x: number;
+        y: number;
+        width: number;
+        height: number;
+    };
+};
+/** Fetch all of the information needed for a start canvas. */
+export declare function fetchStartCanvasInfo(resource: ManifestNormalized | RangeNormalized): Promise<StartCanvasInfo | undefined>;
+/** Fetch all of the data associated with a canvas, including external services. */
+export declare function fetchCanvasData(canvas: CanvasNormalized, imageInfos: ImageInfo[], { scaleFactor, ppiOverride, abortSignal, sizeOnly }: FetchImageOptions): Promise<CanvasData | undefined>;
+/** Download the JSON data for a manifest, handling stuff like broken CORS implementations
+ *  and Content-Negotiation for IIIFv3 */
+export declare function fetchManifestJson(manifestUrl: string): Promise<any>;
+/** Fetch the full IIIF Image service definition from
+ * its info.json endpoint. */
+export declare function fetchFullImageService(serviceRef: ImageService): Promise<ImageService>;
+export {};
diff --git a/node_modules/pdiiif/dist/iiif.d.ts b/node_modules/pdiiif/dist/iiif.d.ts
new file mode 100644
index 0000000..5b10721
--- /dev/null
+++ b/node_modules/pdiiif/dist/iiif.d.ts
@@ -0,0 +1,98 @@
+import { InternationalString, ExternalWebResource, IIIFExternalWebResource, ContentResource, ImageProfile, Reference } from '@iiif/presentation-3';
+import { ManifestNormalized, CanvasNormalized, AnnotationNormalized } from '@iiif/presentation-3-normalized';
+import { Vault, SupportedTarget } from '@iiif/helpers';
+
+export declare const vault: Vault;
+/** Given a language preference in descending order,
+ * determine the best set of strings from the
+ * internationalized string.
+ */
+export declare function getI18nValue(val: string | InternationalString, languagePreference: readonly string[]): string[];
+export declare function getI18nValue(val: string | InternationalString, languagePreference: readonly string[], separator: string): string;
+export declare const getPaintables: (paintingAnnotationsOrCanvas: string | CanvasNormalized | AnnotationNormalized[], enabledChoices?: string[]) => import('@iiif/helpers').Paintables, getAllPaintingAnnotations: (canvasOrId: string | CanvasNormalized | undefined | null) => AnnotationNormalized[], extractChoices: (paintingAnnotationsOrCanvas: string | CanvasNormalized | AnnotationNormalized[]) => import('@iiif/helpers').ChoiceDescription | null;
+/** Determine best thumbnail image for the manifest. */
+export declare function getThumbnail(manifest: ManifestNormalized, maxDimension: number): Promise<string | undefined>;
+/** Like a regular external web resource, but with an associated
+ profile URI, needed for OCR discovery */
+export interface ExternalWebResourceWithProfile extends ExternalWebResource {
+    profile: string;
+}
+/** Check if a resource is an external resource with an
+ * associated profile. */
+export declare function isExternalWebResourceWithProfile(res: ContentResource): res is ExternalWebResourceWithProfile;
+/** See https://iiif.io/api/annex/services/#physical-dimensions */
+export interface PhysicalDimensionService {
+    '@context': 'http://iiif.io/api/annex/services/physdim/1/context.json';
+    profile: 'http://iiif.io/api/annex/services/physdim';
+    '@id': string;
+    physicalScale: number;
+    physicalUnits: 'in' | 'cm' | 'mm';
+}
+/** Check if a service is a IIIF Physical Dimensions service */
+export declare function isPhysicalDimensionService(service: any): service is PhysicalDimensionService;
+/** Check if a IIIF Image endpoint supports arbitrary downscaling. */
+export declare function supportsScaling(profile: ImageProfile): boolean;
+export type ImageInfo = {
+    resource: (ExternalWebResource | IIIFExternalWebResource) & {
+        type: 'Image';
+    };
+    x: number;
+    y: number;
+    width: number;
+    height: number;
+    nativeWidth?: number;
+    nativeHeight?: number;
+    ppi?: number;
+    format?: 'jpeg' | 'png' | 'unsupported';
+    choiceInfo?: {
+        enabled: boolean;
+        optional: boolean;
+        visibleByDefault: boolean;
+        label?: InternationalString;
+    };
+};
+/** Information about a canvas that can be obtained without
+ *  fetching any external resources */
+export type CanvasInfo = {
+    canvas: Reference<'Canvas'>;
+    ocr?: {
+        id: string;
+    };
+    images: ImageInfo[];
+    numAnnotations: number;
+};
+/** Extract all non-painting annotations that are of interest for PDF generation
+ * from a canvas */
+export declare function getCanvasAnnotations(canvas: CanvasNormalized): Annotation[];
+/** Obtain all information about a canvas and its images
+ * without hitting any external endpoints.
+ */
+export declare function getCanvasInfo(canvas: CanvasNormalized): CanvasInfo;
+/** A annotation prepared for rendering to PDF. */
+export interface Annotation {
+    id: string;
+    target: SupportedTarget;
+    markup: string;
+    lastModified?: Date;
+    author?: string;
+}
+/** Parse a IIIF annotation into a format that is more
+ *  suitable for rendering to a PDF. */
+export declare function parseAnnotation(anno: AnnotationNormalized, langPrefs: readonly string[]): Annotation | undefined;
+export interface CompatibilityReport {
+    compatibility: 'compatible' | 'incompatible' | 'degraded';
+    incompatibleElements: {
+        [canvasId: string]: Set<'no-jpeg' | 'no-image' | 'annotations' | 'unsupported-painting'>;
+    };
+}
+export declare function checkCompatibility(manifest: ManifestNormalized): CompatibilityReport | undefined;
+/** Parse a IIIF target specification */
+export declare function parseTarget(targetStr: string): {
+    x: number;
+    y: number;
+    width: number;
+    height: number;
+};
+export declare function getImageFormat(image: ExternalWebResource | IIIFExternalWebResource): 'jpeg' | 'png' | 'unsupported' | undefined;
+/** Get information about images on a Canvas. */
+export declare function getImageInfos(canvas: CanvasNormalized): ImageInfo[];
diff --git a/node_modules/pdiiif/dist/index.cjs b/node_modules/pdiiif/dist/index.cjs
index 99c4529..0432e28 100644
--- a/node_modules/pdiiif/dist/index.cjs
+++ b/node_modules/pdiiif/dist/index.cjs
@@ -1,3006 +1,50 @@
-"use strict";
-var __create = Object.create;
-var __defProp = Object.defineProperty;
-var __getOwnPropDesc = Object.getOwnPropertyDescriptor;
-var __getOwnPropNames = Object.getOwnPropertyNames;
-var __getProtoOf = Object.getPrototypeOf;
-var __hasOwnProp = Object.prototype.hasOwnProperty;
-var __export = (target, all) => {
-  for (var name in all)
-    __defProp(target, name, { get: all[name], enumerable: true });
-};
-var __copyProps = (to, from, except, desc) => {
-  if (from && typeof from === "object" || typeof from === "function") {
-    for (let key of __getOwnPropNames(from))
-      if (!__hasOwnProp.call(to, key) && key !== except)
-        __defProp(to, key, { get: () => from[key], enumerable: !(desc = __getOwnPropDesc(from, key)) || desc.enumerable });
-  }
-  return to;
-};
-var __toESM = (mod, isNodeMode, target) => (target = mod != null ? __create(__getProtoOf(mod)) : {}, __copyProps(
-  // If the importer is in node compatibility mode or this is not an ESM
-  // file that has been converted to a CommonJS file using a Babel-
-  // compatible transform (i.e. "__esModule" has not been set), then set
-  // "default" to the CommonJS "module.exports" for node compatibility.
-  isNodeMode || !mod || !mod.__esModule ? __defProp(target, "default", { value: mod, enumerable: true }) : target,
-  mod
-));
-var __toCommonJS = (mod) => __copyProps(__defProp({}, "__esModule", { value: true }), mod);
-
-// src/index.ts
-var src_exports = {};
-__export(src_exports, {
-  ConsoleLogger: () => ConsoleLogger,
-  convertManifest: () => convertManifest,
-  estimatePdfSize: () => estimatePdfSize,
-  fetchManifestJson: () => fetchManifestJson,
-  setLogger: () => setLogger,
-  version: () => version_default
-});
-module.exports = __toCommonJS(src_exports);
-
-// src/log.ts
-var ConsoleLogger = class {
-  level;
-  constructor(level = "warn") {
-    this.level = level;
-  }
-  setLevel(level) {
-    this.level = level;
-  }
-  debug(message, ...args) {
-    if (this.level === "debug") {
-      console.debug(message, ...args);
-    }
-  }
-  info(message, ...args) {
-    if (this.level !== "error" && this.level !== "warn") {
-      console.info(message, ...args);
-    }
-  }
-  warn(message, ...args) {
-    if (this.level !== "error") {
-      console.warn(message, ...args);
-    }
-  }
-  error(message, ...args) {
-    console.error(message, ...args);
-  }
-};
-var logger = new ConsoleLogger();
-function setLogger(newLogger) {
-  logger = newLogger;
-}
-
-// src/download.ts
-var import_async_mutex = require("async-mutex");
-
-// src/ocr.ts
-var import_ocr_parser = require("ocr-parser");
-
-// src/metrics.ts
-var import_prom_client = __toESM(require("prom-client"), 1);
-
-// src/util.ts
-var saxParserWasm = null;
-function now() {
-  if (typeof window !== "undefined" && window.performance) {
-    return window.performance.now();
-  } else {
-    return Date.now();
-  }
-}
-function isDefined(val) {
-  return val != void 0 && val !== null && val !== void 0;
-}
-var CRC_TABLE = (() => {
-  const t = new Int32Array(256);
-  for (let i = 0; i < 256; ++i) {
-    let c = i, k = 9;
-    while (--k)
-      c = (c & 1 && -306674912) ^ c >>> 1;
-    t[i] = c;
-  }
-  return t;
-})();
-function crc32(data) {
-  let c = -1;
-  for (let i = 0; i < data.length; ++i) {
-    c = CRC_TABLE[c & 255 ^ data[i]] ^ c >>> 8;
-  }
-  return ~c;
-}
-function runningInNode() {
-  return typeof process !== "undefined" && typeof process.versions?.node !== "undefined";
-}
-function initializeSaxParser(parserWasm) {
-  saxParserWasm = parserWasm;
-}
-
-// src/metrics.ts
-var metrics;
-if (runningInNode()) {
-  metrics = {
-    pageGenerationDuration: new import_prom_client.default.Histogram({
-      name: "pdiiif_page_generation_duration_seconds",
-      help: "Latency for generating the PDF for a single page",
-      buckets: [1e-3, 5e-3, 0.015, 0.05, 0.1, 0.5, 1, 2],
-      labelNames: ["status"]
-    }),
-    imageFetchDuration: new import_prom_client.default.Histogram({
-      name: "pdiiif_image_fetch_duration_seconds",
-      help: "Latency for fetching data from IIIF Image API endpoints",
-      buckets: [0.01, 0.05, 0.15, 0.5, 1, 5, 10],
-      labelNames: ["status", "iiif_host", "limited"]
-    }),
-    imageInfoDuration: new import_prom_client.default.Histogram({
-      name: "pdiiif_image_info_duration_seconds",
-      help: "Latency for fetching info from IIIF Image API endpoints",
-      buckets: [0.01, 0.05, 0.15, 0.5, 1, 5, 10],
-      labelNames: ["status", "iiif_host", "limited"]
-    }),
-    ocrFetchDuration: new import_prom_client.default.Histogram({
-      name: "pdiiif_ocr_fetch_duration_seconds",
-      help: "Latency for fetching OCR data",
-      buckets: [0.01, 0.05, 0.15, 0.5, 1, 5, 10],
-      labelNames: ["status", "ocr_host", "limited"]
-    })
-  };
-}
-var metrics_default = metrics;
-
-// src/iiif.ts
-var import_vault = require("@iiif/vault");
-var import_vault_helpers = require("@iiif/vault-helpers");
-var import_iiif_image_api = require("@atlas-viewer/iiif-image-api");
-var PURPOSE_ORDER = ["commenting", "describing", "tagging", "no-purpose"];
-var PURPOSE_LABELS = {
-  commenting: "Comment",
-  describing: "Description",
-  tagging: "Tags"
-};
-var vault = (0, import_vault.globalVault)();
-function getI18nValue(val, languagePreference, separator) {
-  let splitAfter = false;
-  if (!separator) {
-    separator = "<<<SNIP>>>";
-    splitAfter = true;
-  }
-  const localized = (0, import_vault_helpers.buildLocaleString)(val, languagePreference[0] ?? "none", {
-    defaultText: "",
-    fallbackLanguages: languagePreference.slice(1),
-    separator
-  });
-  if (splitAfter) {
-    return localized.split(separator).filter((s) => s.length > 0);
-  } else {
-    return localized;
-  }
-}
-var ImageServiceLoader = class extends import_iiif_image_api.ImageServiceLoader {
-  async fetch(input, init) {
-    return fetch(input, init);
-  }
-};
-var thumbHelper = (0, import_vault_helpers.createThumbnailHelper)(vault, {
-  imageServiceLoader: new ImageServiceLoader()
-});
-var {
-  getPaintables,
-  getAllPaintingAnnotations,
-  extractChoices
-} = (0, import_vault_helpers.createPaintingAnnotationsHelper)(vault);
-async function getThumbnail(manifest, maxDimension) {
-  const thumb = await thumbHelper.getBestThumbnailAtSize(manifest, {
-    maxWidth: maxDimension,
-    maxHeight: maxDimension
-  });
-  return thumb.best?.id;
-}
-function isExternalWebResourceWithProfile(res) {
-  return res.type !== void 0 && ["Dataset", "Image", "Video", "Sound", "Text", "unknown"].indexOf(
-    res.type
-  ) >= 0 && res.profile !== void 0;
-}
-function isPhysicalDimensionService(service) {
-  return typeof service.profile === "string" && service.profile === "http://iiif.io/api/annex/services/physdim";
-}
-function supportsScaling(profile) {
-  if (typeof profile === "string") {
-    return profile.indexOf("level2") >= 0;
-  } else {
-    return (profile.supports?.indexOf("sizeByWh") ?? -1) >= 0;
-  }
-}
-async function fetchFullImageService(serviceRef) {
-  const serviceUrl = `${serviceRef["@id"] ?? serviceRef.id}/info.json`;
-  const resp = await fetch(serviceUrl);
-  const res = await resp.json();
-  return res;
-}
-function getCanvasAnnotations(canvas) {
-  return vault.get(canvas.annotations).flatMap((p) => vault.get(p.items)).filter(
-    (a) => Array.isArray(a.motivation) ? a.motivation.find((m) => PURPOSE_LABELS[m] !== void 0) !== void 0 : PURPOSE_LABELS[a.motivation ?? "invalid"] !== void 0
-  ).map((a) => parseAnnotation(a, [])).filter((a) => a !== void 0);
-}
-function getCanvasInfo(canvas) {
-  const imageInfos = getImageInfos(canvas);
-  const text = getOcrReferences(canvas);
-  return {
-    canvas: { id: canvas.id, type: "Canvas" },
-    images: imageInfos,
-    // eslint-disable-next-line @typescript-eslint/no-non-null-assertion
-    ocr: text ? { id: text.id } : void 0,
-    numAnnotations: getCanvasAnnotations(canvas).length
-  };
-}
-function agentToString(agent) {
-  let name = Array.isArray(agent.name) ? agent.name.join("; ") : agent.name;
-  if (!name) {
-    name = agent.nickname ?? "unknown";
-  }
-  if (agent.email) {
-    return `${name} <${agent.email}>`;
-  }
-  return name;
-}
-function creatorToString(creator) {
-  if (Array.isArray(creator)) {
-    if (typeof creator[0] === "string") {
-      return creator.join("; ");
-    } else {
-      return creator.map((a) => agentToString(a)).join("; ");
-    }
-  }
-  if (typeof creator === "string") {
-    return creator;
-  }
-  return agentToString(creator);
-}
-function parseAnnotation(anno, langPrefs) {
-  if (!anno.target) {
-    return;
-  }
-  const annoBody = anno.body.map(
-    (bodyRef) => vault.get(bodyRef)
-  );
-  const creatorNames = annoBody.map((body) => body.creator).filter((v) => v !== void 0).map(creatorToString);
-  const modifiedDates = annoBody.map((body) => body.modified).filter((v) => v !== void 0).map((v) => new Date(v).getTime());
-  const target = (0, import_vault_helpers.expandTarget)(anno.target);
-  const markup = buildAnnotationMarkup(annoBody);
-  if (!markup) {
-    throw `No valid textual content in annotation.`;
-  }
-  return {
-    id: anno.id,
-    target,
-    markup,
-    lastModified: modifiedDates.length > 0 ? new Date(Math.max(...modifiedDates)) : void 0,
-    author: creatorNames.length > 0 ? creatorNames.join("; ") : void 0
-  };
-}
-function buildAnnotationMarkup(bodies) {
-  const parts = {};
-  for (const body of bodies) {
-    if (body.type !== "TextualBody" || body.format !== "text/plain" && body.format !== "text/html" || body.value === void 0) {
-      continue;
-    }
-    let { purpose } = body;
-    if (Array.isArray(purpose)) {
-      purpose = purpose[0];
-    } else if (!purpose) {
-      purpose = "no-purpose";
-    }
-    if (!parts[purpose]) {
-      parts[purpose] = [];
-    }
-    parts[purpose].push(body.value);
-  }
-  if (Object.keys(parts).length === 0) {
-    return void 0;
-  }
-  const out = [];
-  for (const purpose of PURPOSE_ORDER) {
-    const purposeLabel = PURPOSE_LABELS[purpose];
-    if (!parts[purpose]) {
-      continue;
-    }
-    if (parts[purpose].length > 1) {
-      if (purposeLabel) {
-        out.push(`<p><b>${purposeLabel}:</b></p>`);
-      }
-      for (const part of parts[purpose]) {
-        out.push(`<p>${part}</p>`);
-      }
-    } else {
-      out.push("<p>");
-      if (purposeLabel) {
-        out.push(`<b>${purposeLabel}:</b> `);
-      }
-      out.push(`${parts[purpose][0]}</p>`);
-    }
-  }
-  if (out.length === 0) {
-    return void 0;
-  }
-  return out.join("\n");
-}
-function parseTarget(targetStr) {
-  const [canvasId, fragment] = targetStr.split("#xywh=");
-  if (fragment) {
-    const [x, y, width, height] = fragment.split(",").map((x2) => parseInt(x2, 10));
-    return { x, y, width, height };
-  } else {
-    const canvas = vault.get(canvasId);
-    return { x: 0, y: 0, width: canvas.width, height: canvas.height };
-  }
-}
-function getImageInfos(canvas) {
-  const imageInfos = [];
-  const paintingAnnos = getAllPaintingAnnotations(canvas);
-  for (const anno of paintingAnnos) {
-    if (typeof anno.target !== "string") {
-      logger.error(`Annotation ${anno.id} has a non-string target, currently not supported.`);
-      continue;
-    }
-    const target = parseTarget(anno.target);
-    const body = vault.get(anno.body);
-    for (const resource of body) {
-      if (resource.type !== "Image") {
-        continue;
-      }
-      imageInfos.push({
-        resource,
-        ...target,
-        nativeWidth: resource.width,
-        nativeHeight: resource.height
-      });
-    }
-  }
-  const choice = extractChoices(paintingAnnos);
-  if (choice?.type !== "single-choice") {
-    return imageInfos;
-  }
-  for (const choiceItem of choice.items) {
-    const resource = vault.get(choiceItem.id);
-    if (resource.type !== "Image") {
-      continue;
-    }
-    imageInfos.push({
-      resource,
-      // FIXME: Can't choice images have a location and rendering dimensions?
-      x: 0,
-      y: 0,
-      width: canvas.width,
-      height: canvas.height,
-      nativeWidth: resource.width,
-      nativeHeight: resource.height,
-      choiceInfo: {
-        enabled: choiceItem.selected ?? false,
-        optional: true,
-        label: resource.label,
-        visibleByDefault: choiceItem.selected ?? false
-      }
-    });
-  }
-  return imageInfos;
-}
-
-// src/ocr.ts
-async function parseOcr(id, ocrText, referenceSize) {
-  let pageIter;
-  const isAlto2 = ocrText.indexOf("<alto") >= 0;
-  if (isAlto2) {
-    pageIter = (0, import_ocr_parser.parseAltoPages)(ocrText, [referenceSize]);
-  } else {
-    pageIter = (0, import_ocr_parser.parseHocrPages)(ocrText, [referenceSize]);
-  }
-  const page = (await pageIter.next()).value;
-  if (!page) {
-    return null;
-  }
-  return {
-    ...page,
-    id,
-    markup: ocrText,
-    mimeType: isAlto2 ? "application/xml+alto" : "text/vnd.hocr+html"
-  };
-}
-var isAlto = (resource) => resource.format === "application/xml+alto" || resource.profile?.startsWith("http://www.loc.gov/standards/alto/");
-var isHocr = (resource) => resource.format === "text/vnd.hocr+html" || resource.profile === "https://github.com/kba/hocr-spec/blob/master/hocr-spec.md" || resource.profile?.startsWith("http://kba.cloud/hocr-spec/") || resource.profile?.startsWith("http://kba.github.io/hocr-spec/");
-async function fetchOcrMarkup(url) {
-  const resp = await fetch(url);
-  if (resp.status === 404) {
-    return void 0;
-  }
-  if (resp.status != 200) {
-    throw new Error(
-      `Could not fetch OCR markup from ${url}, got status code ${resp.status}`
-    );
-  }
-  return resp.text();
-}
-function getOcrReferences(canvas) {
-  const refs = vault.get(canvas.seeAlso);
-  refs.push(...vault.get(canvas.rendering));
-  return refs.filter(isExternalWebResourceWithProfile).find((r) => isAlto(r) || isHocr(r));
-}
-async function fetchAndParseText(canvas, annotations) {
-  const ocrRefs = getOcrReferences(canvas);
-  if (ocrRefs) {
-    const stopMeasuring = metrics_default?.ocrFetchDuration.startTimer({
-      ocr_host: new URL(ocrRefs.id).host
-    });
-    let markup;
-    try {
-      markup = await fetchOcrMarkup(ocrRefs.id);
-      stopMeasuring?.({
-        status: "success",
-        limited: rateLimitRegistry.isLimited(ocrRefs.id).toString()
-      });
-      if (!markup) {
-        return void 0;
-      }
-    } catch (err) {
-      stopMeasuring?.({
-        status: "error",
-        limited: rateLimitRegistry.isLimited(ocrRefs.id).toString()
-      });
-      throw err;
-    }
-    return await parseOcr(ocrRefs.id, markup, {
-      width: canvas.width,
-      height: canvas.height
-    }) ?? void 0;
-  }
-}
-
-// src/download.ts
-var FALLBACK_PPI = 300;
-var MANIFEST_ACCEPT_HEADER = 'application/ld+json;q=0.9;profile="http://iiif.io/api/presentation/3/context.json", application/ld+json;q=0.7;profile="http://iiif.io/api/presentation/2/context.json", application/ld+json;q=0.5, application/json;q=0.2';
-var RateLimitingRegistry = class {
-  hostMutexes = /* @__PURE__ */ new Map();
-  callbacks = [];
-  getMutex(host) {
-    return this.hostMutexes.get(host);
-  }
-  limitHost(host) {
-    const mutex = new import_async_mutex.Mutex();
-    this.hostMutexes.set(host, mutex);
-    this.callbacks.forEach((cb) => cb(host, true));
-    return mutex;
-  }
-  unlimitHost(host) {
-    this.hostMutexes.delete(host);
-    this.callbacks.forEach((cb) => cb(host, false));
-  }
-  subscribe(cb) {
-    this.callbacks.push(cb);
-    return this.callbacks.length - 1;
-  }
-  unsubscribe(ticket) {
-    this.callbacks.splice(ticket, 1);
-  }
-  isLimited(url) {
-    return this.hostMutexes.has(new URL(url).host);
-  }
-};
-var rateLimitRegistry = new RateLimitingRegistry();
-async function fetchRespectfully(url, init, maxRetries = 3) {
-  const { host } = new URL(url);
-  let rateLimitMutex = rateLimitRegistry.getMutex(host);
-  let numRetries = -1;
-  let resp;
-  let waitMs = 5e3;
-  let lastError;
-  const release = await rateLimitMutex?.acquire();
-  try {
-    do {
-      resp = await fetch(url, init);
-      if (resp.ok) {
-        break;
-      }
-      numRetries++;
-      const retryAfter = resp?.headers.get("retry-after");
-      if (isDefined(retryAfter)) {
-        if (Number.isInteger(retryAfter)) {
-          waitMs = Number.parseInt(retryAfter, 10) * 1e3;
-        } else {
-          const waitUntil = Date.parse(retryAfter);
-          waitMs = waitUntil - Date.now();
-        }
-      } else {
-        waitMs = Math.pow(Math.random() * 2 * waitMs, numRetries);
-      }
-      const getHeaderValue = (ietfHeader) => {
-        const headerVariants = [
-          ietfHeader,
-          `x-${ietfHeader}`,
-          `x-${ietfHeader.replace("ratelimit", "rate-limit")}`
-        ];
-        return headerVariants.map((header) => resp?.headers.get(header)).filter(isDefined).map((limit2) => Number.parseInt(limit2, 10)).find((limit2) => limit2 != null);
-      };
-      const limit = getHeaderValue("ratelimit-limit");
-      const remaining = getHeaderValue("ratelimit-remaining");
-      const reset = getHeaderValue("ratelimit-reset");
-      if (limit !== void 0 && remaining !== void 0 && reset !== void 0) {
-        rateLimitMutex = rateLimitRegistry.limitHost(host);
-        const secsPerQuotaUnit = reset / (limit - remaining);
-        if (remaining > 0) {
-          waitMs = 2 * remaining * secsPerQuotaUnit * 1e3;
-        } else {
-          waitMs = secsPerQuotaUnit * 1e3;
-        }
-      }
-      await new Promise((resolve) => setTimeout(resolve, waitMs + 100));
-    } while (numRetries < maxRetries);
-  } finally {
-    if (rateLimitMutex) {
-      await new Promise((resolve) => setTimeout(resolve, waitMs + 100));
-    }
-    release?.();
-  }
-  if (!resp) {
-    throw lastError;
-  }
-  return resp;
-}
-function getImageSize(imgService, scaleFactor = 1) {
-  let sizeStr;
-  const isIIIFv3 = imgService.id !== void 0;
-  const maxWidth = imgService.maxWidth ?? imgService.width;
-  let requestedWidth = Math.floor(scaleFactor * maxWidth);
-  const aspectRatio = imgService.width / imgService.height;
-  const supportsScaleByWh = Array.isArray(imgService.profile) ? imgService.profile.find(supportsScaling) !== void 0 : supportsScaling(imgService.profile);
-  if (scaleFactor < 1 && !supportsScaleByWh) {
-    if (imgService.sizes) {
-      requestedWidth = Math.min(...imgService.sizes.map((dims) => Math.abs(requestedWidth - dims.width)));
-      sizeStr = `${requestedWidth},`;
-    } else {
-      sizeStr = `${maxWidth},`;
-    }
-  } else if (scaleFactor == 1) {
-    sizeStr = isIIIFv3 || imgService.maxWidth || imgService.maxArea ? "max" : "full";
-    if (imgService.maxWidth) {
-      requestedWidth = imgService.maxWidth;
-    } else if (imgService.maxHeight) {
-      requestedWidth = Math.round(aspectRatio * imgService.maxHeight);
-    } else if (imgService.maxArea) {
-      const fullArea = imgService.width * imgService.height;
-      const scaleFactor2 = imgService.maxArea / fullArea;
-      requestedWidth = Math.round(scaleFactor2 * imgService.width);
-    } else {
-      requestedWidth = imgService.width;
-    }
-  } else {
-    sizeStr = `${requestedWidth},`;
-  }
-  return {
-    iiifSize: sizeStr,
-    width: requestedWidth,
-    height: requestedWidth / aspectRatio
-  };
-}
-function getPointsPerInch(services) {
-  const physDimService = services.find(isPhysicalDimensionService);
-  if (!physDimService) {
-    return null;
-  }
-  const { physicalScale, physicalUnits } = physDimService;
-  let ppi;
-  if (physicalUnits === "in") {
-    ppi = 1 / physicalScale;
-  } else if (physicalUnits === "mm") {
-    ppi = 25.4 / physicalScale;
-  } else if (physicalUnits === "cm") {
-    ppi = 2.54 / physicalScale;
-  } else {
-    ppi = FALLBACK_PPI;
-  }
-  return ppi;
-}
-function isImageFetchFailure(obj) {
-  return obj.cause !== void 0;
-}
-async function fetchCanvasImage(image, { scaleFactor, abortSignal, sizeOnly = false }) {
-  if (abortSignal?.aborted) {
-    logger.debug(
-      "Abort signalled, aborting before initiating image data fetching."
-    );
-    throw new Error("Aborted due to client request", { cause: { type: "abort" } });
-  }
-  if (image.type !== "Image") {
-    throw new Error(`Can only fetch image resources, got ${image.type}`);
-  }
-  let imgService;
-  if ("service" in image) {
-    imgService = image.service?.find(
-      (s) => (s?.type?.startsWith("ImageService") ?? false) || (s?.["@type"]?.startsWith("ImageService") ?? false)
-    );
-  }
-  let ppi;
-  let imageUrl;
-  if (imgService) {
-    if (!imgService.width) {
-      imgService = await fetchFullImageService(imgService);
-    }
-    const sizeInfo = getImageSize(imgService, scaleFactor);
-    imageUrl = `${imgService.id ?? imgService["@id"]}/full/${sizeInfo.iiifSize}/0/default.jpg`;
-    ppi = getPointsPerInch(imgService.service ?? []) ?? void 0;
-    if (ppi) {
-      ppi = ppi * (sizeInfo.width / imgService.width);
-    }
-  } else if (image.id && image.format === "image/jpeg") {
-    imageUrl = image.id;
-  } else {
-    logger.error(
-      `No JPEG image identifier for resource ${image.id} could be found!`
-    );
-    return null;
-  }
-  let data;
-  let numBytes;
-  let corsAvailable = true;
-  const stopMeasuring = metrics_default?.imageFetchDuration.startTimer({
-    iiif_host: new URL(imageUrl).host
-  });
-  try {
-    const imgResp = await fetchRespectfully(imageUrl, {
-      method: "GET",
-      signal: abortSignal
-    });
-    if (imgResp.status >= 400) {
-      throw new Error(
-        `Failed to fetch page image from ${imageUrl}, server returned status ${imgResp.status}`,
-        { cause: { type: "http-status", status: imgResp.status } }
-      );
-    }
-    if (abortSignal?.aborted) {
-      throw new Error("Aborted due to client request", { cause: { type: "abort" } });
-    }
-    numBytes = Number.parseInt(imgResp.headers.get("Content-Length") ?? "-1");
-    data = sizeOnly && numBytes >= 0 ? void 0 : await imgResp.arrayBuffer();
-    if (numBytes < 0) {
-      numBytes = data?.byteLength ?? -1;
-    }
-    stopMeasuring?.({
-      status: "success",
-      limited: rateLimitRegistry.isLimited(imageUrl).toString()
-    });
-  } catch (err) {
-    const isCorsError = typeof document !== "undefined" && await isImageUnavailableDueToCors(imageUrl);
-    if (!isCorsError) {
-      logger.error(`Failed to fetch image data from ${imageUrl}: ${err}`);
-      stopMeasuring?.({
-        status: "error",
-        limited: rateLimitRegistry.isLimited(imageUrl).toString(),
-        cause: err instanceof Error ? err.cause.type : err
-      });
-      throw err;
-    } else if (!sizeOnly) {
-      throw new Error("Data requested, but no CORS for the image endpoint", { cause: { type: "no-cors" } });
-    }
-    corsAvailable = false;
-    logger.warn(
-      `Failed to fetch image data from ${imageUrl}: CORS headers missing!`
-    );
-    const imgResp = await fetchRespectfully(imageUrl, {
-      method: "GET",
-      signal: abortSignal,
-      mode: "no-cors"
-    });
-    numBytes = Number.parseInt(imgResp.headers.get("Content-Length") ?? "-1");
-  }
-  return {
-    data,
-    ppi,
-    numBytes,
-    corsAvailable
-  };
-}
-async function isImageUnavailableDueToCors(imageUrl) {
-  const imgElem = document.createElement("img");
-  imgElem.src = imageUrl;
-  return new Promise((resolve) => {
-    imgElem.onload = () => resolve(true);
-    imgElem.onerror = () => resolve(false);
-  });
-}
-async function fetchStartCanvasInfo(resource) {
-  const startRef = resource.start;
-  if (!startRef) {
-    return;
-  }
-  let canvasId;
-  let fragment;
-  if (typeof startRef === "string") {
-    const [ident, selectorStr] = startRef.split("#xywh=");
-    if (!selectorStr) {
-      return ident;
-    }
-    canvasId = ident;
-    fragment = `xywh=${selectorStr}`;
-  } else if (startRef.type === "Canvas") {
-    return startRef.id;
-  } else {
-    const selector = vault.get(startRef);
-    if (typeof selector === "string" || selector.type !== "FragmentSelector") {
-      console.warn(
-        `Unsupported selector type, cannot determine start canvas for ${resource.id}`
-      );
-      return;
-    }
-    const fragSel = selector;
-    if (fragSel.conformsTo !== "http://www.w3.org/TR/media-frags/") {
-      console.warn(
-        `Unsupported selector type, cannot determine start canvas for ${resource.id} (fragment selector type was ${fragSel.conformsTo})`
-      );
-      return;
-    }
-    canvasId = fragSel.value;
-  }
-  if (!fragment || !canvasId) {
-    console.error(
-      `Couldn't parse either canvas identifier or selector for ${resource.id} start canvas.`
-    );
-    return;
-  }
-  const [selX, selY, selWidth, selHeight] = fragment.substring(5).split(",").map((v) => Number.parseInt(v, 10));
-  const canvas = vault.get(canvasId);
-  const ppi = getPointsPerInch(canvas.service) ?? FALLBACK_PPI;
-  return {
-    id: canvasId,
-    ppi,
-    dimensions: { width: canvas.width, height: canvas.height },
-    position: {
-      x: selX,
-      y: selY,
-      width: selWidth,
-      height: selHeight
-    }
-  };
-}
-async function fetchCanvasData(canvas, imageInfos, { scaleFactor, ppiOverride, abortSignal, sizeOnly = false }) {
-  const imagePromises = imageInfos.map((i) => i.resource).map((r) => fetchCanvasImage(r, { scaleFactor, abortSignal, sizeOnly }));
-  const results = await Promise.allSettled(imagePromises);
-  const canvasImages = results.reduce((acc, x, idx) => {
-    if (x.status !== "fulfilled" || x.value === null) {
-      return acc;
-    }
-    const imgInfo = imageInfos[idx];
-    acc.push({
-      ...imgInfo,
-      ...x.value
-      // FIXME: How can we get rid of the cast?
-    });
-    return acc;
-  }, []);
-  const failures = results.filter((x) => x.status === "rejected").map((x, idx) => {
-    const info = imageInfos[idx];
-    return {
-      ...info,
-      cause: x.reason
-    };
-  });
-  const ppi = ppiOverride;
-  if (!ppiOverride) {
-    let ppi2 = getPointsPerInch(canvas.service) ?? void 0;
-    if (ppi2 && scaleFactor) {
-      ppi2 = ppi2 * scaleFactor;
-    }
-  }
-  let text;
-  if (!sizeOnly) {
-    try {
-      text = await fetchAndParseText(canvas, void 0);
-    } catch (err) {
-      logger.warn(`Failed to fetch text for canvas ${canvas.id}: ${err}`);
-    }
-  }
-  return {
-    canvas,
-    images: canvasImages,
-    imageFailures: failures,
-    ppi,
-    text,
-    annotations: getCanvasAnnotations(canvas)
-  };
-}
-async function fetchManifestJson(manifestUrl) {
-  try {
-    const resp = await fetch(manifestUrl, {
-      headers: {
-        Accept: MANIFEST_ACCEPT_HEADER
-      }
-    });
-    return await resp.json();
-  } catch (err) {
-    const resp = await fetch(manifestUrl);
-    return await resp.json();
-  }
-}
-
-// src/convert.ts
-var import_presentation_2 = require("@iiif/parser/presentation-2");
-var import_p_queue = __toESM(require("p-queue"), 1);
-var import_events = __toESM(require("events"), 1);
-var ocrParser = __toESM(require("ocr-parser"), 1);
-
-// src/pdf/generator.ts
-var import_dedent_js = __toESM(require("dedent-js"), 1);
-
-// src/pdf/util.ts
-var import_util3 = __toESM(require("util"), 1);
-var import_zlib = __toESM(require("zlib"), 1);
-var import_fflate = require("fflate");
-var import_crypto = __toESM(require("crypto"), 1);
-var textEncoder;
-var textDecoder;
-if (typeof TextEncoder !== "undefined" && typeof TextDecoder !== "undefined") {
-  textEncoder = new TextEncoder();
-  textDecoder = new TextDecoder();
-} else {
-  textEncoder = new import_util3.default.TextEncoder();
-  textDecoder = new import_util3.default.TextDecoder();
-}
-var cryptoImpl;
-if (runningInNode()) {
-  cryptoImpl = import_crypto.default.webcrypto;
-} else {
-  cryptoImpl = crypto;
-}
-var IS_BIG_ENDIAN = (() => {
-  const array = new Uint8Array(4);
-  const view = new Uint32Array(array.buffer);
-  return !((view[0] = 1) & array[0]);
-})();
-function randomData(length) {
-  if (length > 2 ** 16) {
-    length = 2 ** 16;
-  }
-  const buf = new Uint8Array(length);
-  if (cryptoImpl !== void 0) {
-    cryptoImpl.getRandomValues(buf);
-  } else {
-    const u32View = new Uint32Array(buf.buffer);
-    for (let i = 0; i < u32View.length; i++) {
-      u32View[i] = Math.floor(Math.random() * 2 ** 32);
-    }
-  }
-  return buf;
-}
-async function tryDeflateStream(pdfStream) {
-  const data = pdfStream instanceof Uint8Array ? pdfStream : textEncoder.encode(pdfStream);
-  let compressed;
-  if (!runningInNode()) {
-    if (typeof CompressionStream === "undefined") {
-      try {
-        let bytes;
-        if (pdfStream instanceof Uint8Array) {
-          bytes = pdfStream;
-        } else {
-          bytes = textEncoder.encode(pdfStream);
-        }
-        compressed = (0, import_fflate.zlibSync)(bytes);
-        return Promise.resolve({
-          stream: compressed,
-          dict: { Length: compressed.length, Filter: "/FlateDecode" }
-        });
-      } catch (err) {
-        logger.warn(
-          `Failed to use JS deflate implementation, data will be written uncompressed: ${err}`
-        );
-        return Promise.resolve({
-          stream: pdfStream,
-          dict: { Length: pdfStream.length }
-        });
-      }
-    }
-    const compStream = new CompressionStream("deflate");
-    const c = new Blob([data]).stream().pipeThrough(compStream);
-    compressed = new Uint8Array(await new Response(c).arrayBuffer());
-  } else {
-    compressed = await new Promise(
-      (resolve, reject) => import_zlib.default.deflate(data, (err, buf) => err ? reject(err) : resolve(buf))
-    );
-  }
-  return {
-    dict: {
-      Length: compressed.length,
-      Filter: "/FlateDecode"
-    },
-    stream: compressed
-  };
-}
-
-// src/pdf/common.ts
-var PDF_INDENTATION = 2;
-var PdfRef = class {
-  refObj;
-  constructor(num) {
-    this.refObj = num;
-  }
-};
-function makeRef(target) {
-  const num = typeof target === "number" ? target : target.num;
-  return new PdfRef(num);
-}
-function isUnicode(str) {
-  for (let i = 0, end = str.length; i < end; i++) {
-    if (str.charCodeAt(i) > 127) {
-      return true;
-    }
-  }
-  return false;
-}
-function toUTF16BE(str, includeBom = true) {
-  const buf = new Uint16Array(str.length + (includeBom ? 1 : 0));
-  for (let i = includeBom ? 1 : 0; i < buf.length; i++) {
-    buf[i] = str.charCodeAt(i - (includeBom ? 1 : 0));
-  }
-  const outBuf = new Uint8Array(buf.buffer, buf.byteOffset, buf.byteLength);
-  if (!IS_BIG_ENDIAN) {
-    for (let i = includeBom ? 2 : 0, end = outBuf.length - 1; i < end; i += 2) {
-      const a = outBuf[i];
-      outBuf[i] = outBuf[i + 1];
-      outBuf[i + 1] = a;
-    }
-  }
-  if (includeBom) {
-    outBuf[0] = 254;
-    outBuf[1] = 255;
-  }
-  return outBuf;
-}
-function safeNumber(num) {
-  if (num > -1e21 && num < 1e21) {
-    return Math.round(num * 1e6) / 1e6;
-  }
-  throw new Error(`unsupported number: ${num}`);
-}
-function serialize(value, dictIndent = 0) {
-  if (typeof value === "string") {
-    if (value[0] === "(" && value[value.length - 1] === ")" && isUnicode(value)) {
-      return serialize(toUTF16BE(value.substring(1, value.length - 1)));
-    }
-    return value;
-  } else if (value instanceof Uint8Array) {
-    return `<${Array.from(value).map((x) => x.toString(16).padStart(2, "0").toUpperCase()).join("")}>`;
-  } else if (value instanceof Date) {
-    const dateString = `D:${value.getUTCFullYear().toString(10).padStart(4, "0")}` + (value.getUTCMonth() + 1).toString(10).padStart(2, "0") + value.getUTCDate().toString(10).padStart(2, "0") + value.getUTCHours().toString(10).padStart(2, "0") + value.getUTCMinutes().toString(10).padStart(2, "0") + value.getUTCSeconds().toString(10).padStart(2, "0") + "Z";
-    return `(${dateString})`;
-  } else if (Array.isArray(value)) {
-    return `[${value.map((v) => serialize(v, dictIndent + 1)).join(" ")}]`;
-  } else if (value instanceof PdfRef) {
-    return `${value.refObj} 0 R`;
-  } else if ({}.toString.call(value) === "[object Object]") {
-    const outsideIndent = " ".repeat(PDF_INDENTATION * dictIndent);
-    const insideIndent = outsideIndent + " ".repeat(PDF_INDENTATION);
-    return `<<
-${Object.entries(value).map(
-      ([k, v]) => `${insideIndent}/${k} ${serialize(v, dictIndent + 1)}`
-    ).join("\n")}
-${outsideIndent}>>`;
-  } else if (typeof value === "number") {
-    return safeNumber(value).toString(10);
-  } else {
-    return `${value}`;
-  }
-}
-
-// src/io.ts
-var CountingWriter = class {
-  _writer;
-  bytesWritten = 0;
-  constructor(writer) {
-    this._writer = writer;
-  }
-  write(buffer) {
-    this.bytesWritten += buffer.length;
-    return this._writer.write(buffer);
-  }
-  close() {
-    return this._writer.close();
-  }
-  waitForDrain() {
-    return this._writer.waitForDrain();
-  }
-};
-var WebWriter = class {
-  _writer;
-  constructor(stream) {
-    this._writer = stream.getWriter();
-  }
-  write(buffer) {
-    return this._writer.write(buffer);
-  }
-  waitForDrain() {
-    return this._writer.ready;
-  }
-  close() {
-    return this._writer.close();
-  }
-};
-var BlobWriter = class {
-  // TODO: A good reference seems to be the mega.nz implementation, which has always worked great for me on desktops at least:
-  // https://github.com/meganz/webclient/blob/f19289127b68ceaf19a5e884f2f48f15078304da/js/transfers/meths/memory.js
-  _parts;
-  _blob;
-  constructor() {
-    this._parts = [];
-  }
-  write(buffer) {
-    if (this._blob) {
-      return Promise.reject("Cannot write to closed BlobWriter.");
-    }
-    this._parts.push(buffer);
-    return Promise.resolve();
-  }
-  waitForDrain() {
-    if (this._blob) {
-      return Promise.reject("Cannot wait on a closed BlobWriter.");
-    }
-    return Promise.resolve();
-  }
-  close() {
-    if (this._blob) {
-      return Promise.reject("BlobWriter is already closed");
-    }
-    this._blob = new Blob(this._parts);
-    this._parts = [];
-    return Promise.resolve();
-  }
-  get blob() {
-    if (!this._blob) {
-      throw "BlobWriter must be closed first!";
-    }
-    return this._blob;
-  }
-};
-var NodeWriter = class {
-  _writable;
-  _drainWaiters = [];
-  constructor(writable) {
-    this._writable = writable;
-    this._writable.on("drain", () => {
-      logger.debug("Drained writer.");
-      for (const waiter of this._drainWaiters) {
-        waiter();
-      }
-      this._drainWaiters = [];
-    });
-    this._writable.on("close", () => {
-      for (const waiter of this._drainWaiters) {
-        waiter();
-      }
-      this._drainWaiters = [];
-    });
-  }
-  async write(buffer) {
-    let waitForDrain = false;
-    const out = new Promise((resolve, reject) => {
-      if (!this._writable.writable) {
-        reject("Cannot write to closed NodeWriter.");
-      }
-      waitForDrain = !this._writable.write(
-        buffer,
-        (err) => err ? reject(err) : resolve()
-      );
-    });
-    if (waitForDrain) {
-      logger.debug("Waiting for writer to drain");
-      return await this.waitForDrain();
-    } else {
-      return await out;
-    }
-  }
-  waitForDrain() {
-    return new Promise((resolve) => this._drainWaiters.push(resolve));
-  }
-  close() {
-    return new Promise((resolve) => this._writable.end(() => resolve()));
-  }
-};
-var ArrayReader = class {
-  _buf;
-  constructor(buf) {
-    this._buf = buf;
-  }
-  read(dst, offset, position, length) {
-    const sub = this._buf.subarray(position, position + length);
-    dst.set(sub, offset);
-    return Promise.resolve(sub.length);
-  }
-  size() {
-    return Promise.resolve(this._buf.length);
-  }
-};
-
-// src/pdf/image.ts
-function readUint16BE(buf, pos = 0) {
-  const val = new Uint16Array(buf.slice(pos, pos + 2).buffer)[0];
-  if (IS_BIG_ENDIAN) {
-    return val;
-  } else {
-    return (val & 255) << 8 | val >> 8 & 255;
-  }
-}
-var PdfImage = class {
-  static open(data) {
-    if (data[0] === 255 && data[1] === 216) {
-      return new JPEGImage(data);
-    } else {
-      throw new Error("Unknown image format.");
-    }
-  }
-};
-var JPEGImage = class _JPEGImage extends PdfImage {
-  static MARKERS = [
-    65472,
-    65473,
-    65474,
-    65475,
-    65477,
-    65478,
-    65479,
-    65480,
-    65481,
-    65482,
-    65483,
-    65484,
-    65485,
-    65486,
-    65487
-  ];
-  static COLOR_SPACE_MAP = {
-    1: "DeviceGray",
-    3: "DeviceRGB",
-    4: "DeviceCMYK"
-  };
-  data;
-  bits;
-  width;
-  height;
-  colorSpace;
-  constructor(data) {
-    super();
-    let marker;
-    this.data = data;
-    if (readUint16BE(this.data, 0) !== 65496) {
-      throw "SOI not found in JPEG";
-    }
-    let pos = 2;
-    while (pos < this.data.length) {
-      marker = readUint16BE(this.data, pos);
-      pos += 2;
-      if (_JPEGImage.MARKERS.includes(marker)) {
-        break;
-      }
-      pos += readUint16BE(this.data, pos);
-    }
-    if (!marker || !_JPEGImage.MARKERS.includes(marker)) {
-      throw "Invalid JPEG.";
-    }
-    pos += 2;
-    this.bits = this.data[pos++];
-    this.height = readUint16BE(this.data, pos);
-    pos += 2;
-    this.width = readUint16BE(this.data, pos);
-    pos += 2;
-    const channels = this.data[pos++];
-    if ([1, 3, 4].indexOf(channels) < 0) {
-      throw "Bad number of channels, only 1, 3 or 4 are supported";
-    }
-    this.colorSpace = _JPEGImage.COLOR_SPACE_MAP[channels];
-  }
-  toObjects(startNum) {
-    const obj = {
-      Type: "/XObject",
-      Subtype: "/Image",
-      BitsPerComponent: this.bits,
-      Width: this.width,
-      Height: this.height,
-      ColorSpace: `/${this.colorSpace}`,
-      Filter: "/DCTDecode",
-      Length: this.data.length
-    };
-    if (this.colorSpace === "DeviceCMYK") {
-      obj.Decode = [1, 0, 1, 0, 1, 0, 1, 0];
-    }
-    return [{ num: startNum, data: serialize(obj), stream: this.data }];
-  }
-};
-var image_default = PdfImage;
-
-// src/pdf/parser.ts
-if (!Uint8Array.prototype.findLastIndex) {
-  Uint8Array.prototype.findLastIndex = function(predicate) {
-    let l = this.length;
-    while (l--) {
-      if (predicate(this[l], l, this))
-        return l;
-    }
-    return -1;
-  };
-}
-var ESCAPE_CHARS = {
-  n: "\n",
-  r: "\r",
-  t: "	",
-  b: "\b",
-  f: "\f",
-  "(": "(",
-  ")": ")",
-  "\\": "\\"
-};
-async function* parseCrossRefSection(reader, offset, length) {
-  const buf = new Uint8Array(length);
-  offset += await reader.read(buf, 0, offset, buf.length);
-  if (!testForString(buf, 0, "xref")) {
-    throw "Invalid crossreference section, did not start with `xref` line.";
-  }
-  const trailerIdx = buf.findIndex(
-    (_x, idx) => testForString(buf, idx, "trailer")
-  );
-  const parts = textDecoder.decode(buf.subarray(0, trailerIdx)).split(/[\r ]?\n/).slice(1);
-  let currentSection;
-  for (const part of parts) {
-    if (part.length === 18) {
-      if (!currentSection) {
-        throw "Invalid crossreference section, entry outside of subsection.";
-      }
-      const entryParts = part.trim().split(" ");
-      currentSection.entries.push([
-        Number.parseInt(entryParts[0], 10),
-        Number.parseInt(entryParts[1], 10),
-        entryParts[2] === "n"
-      ]);
-    } else {
-      if (currentSection) {
-        if (currentSection.numObjs !== currentSection.entries.length) {
-          throw `Invalid subsection, expected ${currentSection.numObjs} objects, found ${currentSection.entries.length}!`;
-        }
-        yield currentSection;
-        currentSection = void 0;
-      }
-      if (part.length === 0 || part.indexOf("trailer") >= 0) {
-        break;
-      }
-      const [startNum, numObjs] = part.trimEnd().split(" ").map((p) => Number.parseInt(p, 10));
-      currentSection = {
-        startNum,
-        numObjs,
-        entries: []
-      };
-    }
-  }
-  if (currentSection) {
-    yield currentSection;
-  }
-  const trailerBuf = buf.subarray(trailerIdx);
-  const trailerStartIdx = trailerBuf.findIndex(
-    (_x, idx) => testForString(trailerBuf, idx, "<<")
-  );
-  const trailerEndIdx = trailerBuf.findIndex(
-    (_x, idx) => testForString(trailerBuf, idx, ">>")
-  );
-  const trailerDict = new PdfValueParser(
-    trailerBuf.subarray(trailerStartIdx, trailerEndIdx + 2)
-  ).read();
-  if (trailerDict.Prev) {
-    const previousXrefOffset = trailerDict.Prev;
-    yield* parseCrossRefSection(
-      reader,
-      previousXrefOffset,
-      offset - previousXrefOffset
-    );
-  }
-}
-function testForString(buf, offset, value, backwards = false) {
-  if (backwards) {
-    for (let idx = value.length - 1; idx >= 0; idx--) {
-      if (buf[offset + idx] !== value.charCodeAt(idx)) {
-        return false;
-      }
-    }
-  } else {
-    for (let idx = 0; idx < value.length; idx++) {
-      if (buf[offset + idx] !== value.charCodeAt(idx)) {
-        return false;
-      }
-    }
-  }
-  return true;
-}
-function isDigit(c) {
-  return !isNaN(parseInt(c, 10));
-}
-function isHex(c) {
-  return c >= 48 && c <= 57 || c >= 65 && c <= 70 || c >= 97 && c <= 102;
-}
-var PdfValueParser = class {
-  start = 0;
-  current = 0;
-  buf;
-  /** Construct a parser for a buffer containing one or more PDF values. */
-  constructor(buf) {
-    this.buf = buf;
-  }
-  /** Get the buffer content at the current offset as a character. */
-  getChar() {
-    return String.fromCharCode(this.buf[this.current]);
-  }
-  /** Compares the buffer contents at the current offset against a string value. */
-  matchValue(value) {
-    const valueRead = textDecoder.decode(
-      this.buf.subarray(
-        this.current,
-        this.current + textEncoder.encode(value).length
-      )
-    );
-    return valueRead === value;
-  }
-  /** Checks if the buffer at the current offset contains a number.
-   *
-   * See ISO32000-2:2020 section 7.3.3.
-   */
-  matchInteger(resetAfter = true) {
-    this.start = this.current;
-    let chr;
-    let isInt = true;
-    const chars = [];
-    while (!this.matchWhiteSpace(chr = this.getChar()) && !this.matchDelimiter(chr)) {
-      if (chr === "+" || chr === "-") {
-        if (this.current - this.start > 0) {
-          isInt = false;
-          break;
-        }
-      } else if (!isDigit(chr)) {
-        isInt = false;
-        break;
-      }
-      this.current++;
-      chars.push(chr);
-    }
-    if (resetAfter) {
-      this.current = this.start;
-    }
-    return isInt ? chars.join("") : void 0;
-  }
-  /** Read a PDF value from the current offset, advancing the cursor. */
-  read() {
-    let c = this.getChar();
-    if (this.matchWhiteSpace(c)) {
-      this.skipWhiteSpace();
-      c = this.getChar();
-    }
-    switch (this.getChar()) {
-      case "[":
-        return this.readArray();
-      case "<":
-        return this.matchValue("<<") ? this.readDict() : this.readHexString();
-      case "(":
-        return this.readLiteralString();
-      case "/":
-        return this.readName();
-      case "t":
-        if (this.matchValue("true")) {
-          this.current += "true".length;
-          return true;
-        }
-        throw new Error("Unexpected character while parsing");
-      case "f":
-        if (this.matchValue("false")) {
-          this.current += "false".length;
-          return false;
-        }
-        throw new Error("Unexpected character while parsing");
-      case "n":
-        if (this.matchValue("null")) {
-          this.current += "null".length;
-          return null;
-        }
-        throw new Error("Unexpected character while parsing");
-      case ".":
-        return this.readRealNumber();
-      default:
-        if (this.matchIndirectObject()) {
-          return this.readIndirectObject();
-        }
-        if (this.matchRealNumber()) {
-          return this.readRealNumber();
-        }
-        if (this.matchInteger()) {
-          return this.readInteger();
-        }
-        throw new Error(
-          `Encountered unexpected character during parsing: '${c}'`
-        );
-    }
-  }
-  /** Check if the input string contains PDF whitespace.
-   *
-   * See ISO32000-2:2020 section 7.2.3, Table 1.
-   */
-  matchWhiteSpace(c) {
-    return c === " " || c === "\0" || c === "\n" || c === "\r" || c === "\r\n" || c == "\f";
-  }
-  /** Read an integer from the current offset. */
-  readInteger() {
-    const intStr = this.matchInteger(false);
-    if (intStr === void 0) {
-      throw new Error("Failed to read integer.");
-    }
-    return Number.parseInt(intStr, 10);
-  }
-  /** Read an indirect object from the current offset. */
-  readIndirectObject() {
-    const match = this.matchIndirectObject(false);
-    if (match === void 0) {
-      throw new Error("Failed to read indirect object");
-    }
-    return new PdfRef(Number.parseInt(match.split(" ")[0]));
-  }
-  /** Check if the buffer contains an indirect object at the current offset.
-   *
-   * See ISO32000-2:2020 section 7.3.10.
-   */
-  matchIndirectObject(resetAfter = true) {
-    this.start = this.current;
-    let c = this.getChar();
-    const chars = [];
-    const matchNumber = () => {
-      if (!isDigit(c)) {
-        return false;
-      }
-      chars.push(c);
-      this.current++;
-      while (isDigit(c = this.getChar())) {
-        chars.push(c);
-        this.current++;
-      }
-      return true;
-    };
-    const matchWhitespace = () => this.skipWhiteSpace();
-    const match = () => {
-      if (!matchNumber()) {
-        return false;
-      }
-      if (!matchWhitespace()) {
-        return false;
-      }
-      chars.push(" ");
-      c = this.getChar();
-      if (!matchNumber()) {
-        return false;
-      }
-      if (!matchWhitespace()) {
-        return false;
-      }
-      chars.push(" ");
-      if (this.getChar() !== "R") {
-        return false;
-      }
-      chars.push("R");
-      this.current++;
-      return true;
-    };
-    const doesMatch = match();
-    if (resetAfter) {
-      this.current = this.start;
-    }
-    if (doesMatch) {
-      return chars.join("");
-    }
-  }
-  /** Check if the buffer contains a real number at the current offset.
-   *
-   * See ISO32000-2:2020 section 7.3.3.
-   */
-  matchRealNumber(resetAfter = true) {
-    this.start = this.current;
-    let isRealNumber = true;
-    let digitSeen = false;
-    let separatorSeen = false;
-    const chars = [];
-    let c;
-    while (true) {
-      c = this.getChar();
-      if (c === ".") {
-        if (separatorSeen) {
-          isRealNumber = false;
-          break;
-        }
-        separatorSeen = true;
-      } else if (isDigit(c)) {
-        digitSeen = true;
-      } else if (c === "-" || c === "+") {
-        if (this.current - this.start > 0) {
-          break;
-        }
-      } else {
-        break;
-      }
-      chars.push(c);
-      this.current++;
-    }
-    if (resetAfter) {
-      this.current = this.start;
-    }
-    if (!isRealNumber) {
-      return void 0;
-    }
-    if (digitSeen && separatorSeen) {
-      return chars.join("");
-    }
-    return void 0;
-  }
-  /** Read a real number from the current offset. */
-  readRealNumber() {
-    const str = this.matchRealNumber(false);
-    if (!str) {
-      throw new Error("Could not read real number.");
-    }
-    return Number.parseFloat(str);
-  }
-  /** Skip a contiguous sequence of whitespae, advancing the cursor. */
-  skipWhiteSpace() {
-    let skipped = false;
-    while (!this.atEnd() && this.matchWhiteSpace(this.getChar())) {
-      this.current++;
-      skipped = true;
-    }
-    return skipped;
-  }
-  /** Check if we're at the end of the buffer. */
-  atEnd() {
-    return this.current >= this.buf.length;
-  }
-  /** Read a name from the current offset.
-   *
-   * See ISO32000-2:2020 section 7.3.5.
-   */
-  readName() {
-    const chars = ["/"];
-    this.current++;
-    let c;
-    while (!this.matchWhiteSpace(c = this.getChar()) && !this.matchDelimiter(c)) {
-      if (c === "#") {
-        const a = this.buf[this.current++];
-        const b = this.buf[this.current++];
-        if (!isHex(a) || !isHex(b)) {
-          throw new Error("Illegal character escape in name.");
-        }
-        chars.push(
-          String.fromCharCode(
-            Number.parseInt(String.fromCharCode(a) + String.fromCharCode(b), 16)
-          )
-        );
-      } else {
-        chars.push(c);
-        this.current++;
-      }
-    }
-    return chars.join("");
-  }
-  /** Check if the current offset contains a delimiter.
-   *
-   * See ISO32000-2:2020 section 7.2.3, Table 2
-   */
-  matchDelimiter(c) {
-    return "[]{}()<>/%".indexOf(c) >= 0;
-  }
-  /** Read a hex string from the current offset.
-   *
-   * See ISO32000-2:2020 section 7.3.4.3
-   */
-  readHexString() {
-    this.current++;
-    const vals = [];
-    while (this.getChar() !== ">") {
-      const a = this.buf[this.current++];
-      const b = this.buf[this.current++];
-      if (!isHex(a) || !isHex(b)) {
-        throw new Error(`Invalid value in hex string: '${a}${b}`);
-      }
-      vals.push(
-        Number.parseInt(String.fromCharCode(a) + String.fromCharCode(b), 16)
-      );
-    }
-    this.current++;
-    return new Uint8Array(vals);
-  }
-  /** Read a literal string from the current offset.
-   *
-   * See ISO32000-2:2020 section 7.3.4.2
-   */
-  readLiteralString() {
-    this.current++;
-    const chars = [];
-    let openParens = 0;
-    let c;
-    while (true) {
-      c = this.getChar();
-      if (c === "\\") {
-        this.current++;
-        c = this.getChar();
-        if (isDigit(c)) {
-          let cs = [c];
-          this.current++;
-          while (isDigit(this.getChar())) {
-            cs.push(this.getChar());
-            this.current++;
-          }
-          if (cs.length > 3) {
-            this.current -= cs.length - 3;
-            cs = cs.slice(0, 3);
-          }
-          this.current--;
-          c = String.fromCharCode(Number.parseInt(cs.join(""), 8));
-        } else {
-          c = ESCAPE_CHARS[c];
-          if (c === void 0) {
-            throw new Error(
-              `Illegal escape sequence in string literal: '\\${c}`
-            );
-          }
-        }
-      } else if (c === "(") {
-        openParens++;
-      } else if (c === ")") {
-        openParens--;
-        if (openParens < 0) {
-          this.current++;
-          return chars.join("");
-        }
-      }
-      chars.push(c);
-      this.current++;
-    }
-  }
-  /** Read a dictionary from the current offset.
-   *
-   * See ISO32000-2:2020 section 7.3.7
-   */
-  readDict() {
-    this.current += 2;
-    const obj = {};
-    this.skipWhiteSpace();
-    while (this.getChar() !== ">") {
-      const name = this.read();
-      if (typeof name !== "string" || !name.startsWith("/")) {
-        throw new Error(`Dictionary keys must be name objects, got '${name}`);
-      }
-      this.skipWhiteSpace();
-      const val = this.read();
-      if (val !== null) {
-        obj[name.substring(1)] = val;
-      }
-      this.skipWhiteSpace();
-    }
-    this.current += 2;
-    return obj;
-  }
-  /** Read an array from the current offset.
-   *
-   * See ISO32000-2:2020 section 7.3.6
-   */
-  readArray() {
-    this.current++;
-    const arr = [];
-    while (this.getChar() !== "]") {
-      arr.push(this.read());
-      this.skipWhiteSpace();
-    }
-    this.current++;
-    return arr;
-  }
-};
-var PdfParser = class _PdfParser {
-  reader;
-  objectOffsets;
-  sortedOffsets;
-  pdfSize;
-  objGenerations;
-  infoNum;
-  catalogNum;
-  /** Construct a new parser from a Reader.
-   *
-   * Used instead of the constructor to allow for async initialization.
-   */
-  static async parse(reader) {
-    const trailerBuf = new Uint8Array(1024);
-    const pdfSize = await reader.size();
-    const bufStart = pdfSize - trailerBuf.length;
-    await reader.read(trailerBuf, 0, bufStart, trailerBuf.length);
-    const eofIdx = trailerBuf.length - (trailerBuf[trailerBuf.length - 1] === 70 ? 5 : 6);
-    if (!testForString(trailerBuf, eofIdx, "%%EOF")) {
-      throw "Invalid PDF, missing EOF comment at end of file";
-    }
-    const startXrefPos = trailerBuf.findLastIndex(
-      (_x, idx) => testForString(trailerBuf, idx, "startxref")
-    );
-    if (startXrefPos < 0) {
-      throw "Invalid PDF, missing startxref marker in file trailer.";
-    }
-    const objGenerations = [];
-    const objsDeleted = [];
-    const objOffsets = [];
-    const xrefStartOffset = Number.parseInt(
-      textDecoder.decode(trailerBuf.subarray(startXrefPos + 9, eofIdx)).trim(),
-      10
-    );
-    const dictEnd = trailerBuf.findLastIndex(
-      (_x, idx) => testForString(trailerBuf, idx, ">>")
-    ) + 2;
-    const dictStart = trailerBuf.findLastIndex(
-      (_x, idx) => testForString(trailerBuf, idx, "<<")
-    );
-    const trailerDict = new PdfValueParser(
-      trailerBuf.subarray(dictStart, dictEnd)
-    ).read();
-    for await (const { startNum, entries } of parseCrossRefSection(
-      reader,
-      xrefStartOffset,
-      bufStart + dictEnd - xrefStartOffset
-    )) {
-      for (const [idx, [offset, gen, inUse]] of entries.entries()) {
-        const objNum = idx + startNum;
-        if ((objGenerations[objNum] ?? -1) > gen) {
-          continue;
-        }
-        objGenerations[objNum] = gen;
-        if (inUse) {
-          objOffsets[objNum] = offset;
-          objsDeleted[objNum] = false;
-        } else {
-          objOffsets[objNum] = -1;
-          objsDeleted[objNum] = true;
-        }
-      }
-    }
-    if (objOffsets.length !== trailerDict.Size) {
-      throw `Trailer dictionary has different number of objects than crossreference tables, ${objOffsets.length} vs. ${trailerDict.Size}`;
-    }
-    return new _PdfParser(reader, objOffsets, objGenerations, trailerDict);
-  }
-  /** Private constructor, use factory method above. */
-  constructor(reader, objOffsets, objGenerations, trailerDict) {
-    this.reader = reader;
-    this.objectOffsets = objOffsets;
-    this.sortedOffsets = [...objOffsets].sort((a, b) => a - b);
-    this.objGenerations = objGenerations;
-    this.catalogNum = trailerDict.Root.refObj;
-    this.infoNum = trailerDict.Info.refObj;
-  }
-  /** Retrieve the catalog dictionary. */
-  async catalog() {
-    const obj = await this.getObject(this.catalogNum);
-    if (!obj) {
-      throw `Document has no catalog object (num as per trailer: ${this.catalogNum}!`;
-    }
-    return obj.data;
-  }
-  /** Retrieve the info dictionary. */
-  async info() {
-    const obj = await this.getObject(this.infoNum);
-    if (!obj) {
-      throw `Document has no info object (num as per trailer: ${this.infoNum}!`;
-    }
-    return obj.data;
-  }
-  /** Yield all pages referenced in the given page dictionary. */
-  async *_pagesFromPagesObj(pagesObj) {
-    for (const pageRef of pagesObj.Kids) {
-      const page = await this.getObject(pageRef.refObj, true);
-      if (!page) {
-        throw `Could not find Page object with number ${pageRef.refObj}`;
-      }
-      const pageDict = page.data;
-      if (pageDict.Type === "/Pages") {
-        yield* this._pagesFromPagesObj(pageDict);
-      } else {
-        yield page;
-      }
-    }
-  }
-  /** Yield all pages in the PDF. */
-  async *pages() {
-    const catalog = await this.catalog();
-    const pagesRef = catalog.Pages;
-    const pagesRoot = await this.getObject(pagesRef.refObj);
-    if (!pagesRoot) {
-      throw `Could not find Pages object with number ${pagesRef.refObj}`;
-    }
-    const pagesDict = pagesRoot.data;
-    yield* this._pagesFromPagesObj(pagesDict);
-  }
-  /** Yield all annotations for the given page dictionary. */
-  async *annotations(pageDict) {
-    const annots = pageDict.Annots;
-    if (!annots) {
-      return;
-    }
-    for (const annoRef of annots) {
-      const anno = await this.getObject(annoRef.refObj);
-      if (!anno) {
-        throw `Could not find Annotation object with number ${annoRef.refObj}`;
-      }
-      yield anno.data;
-    }
-  }
-  /** Resolve a PDF reference to the corresponding object. */
-  resolveRef(ref) {
-    return this.getObject(ref.refObj, true);
-  }
-  /** Get an object from the PDF from its number. */
-  async getObject(num, withStream = false) {
-    const offset = this.objectOffsets[num];
-    if (!offset) {
-      return;
-    }
-    if (!this.pdfSize) {
-      this.pdfSize = await this.reader.size();
-    }
-    const nextOffset = this.sortedOffsets[this.sortedOffsets.indexOf(offset) + 1] ?? this.pdfSize;
-    const buf = new Uint8Array(nextOffset - offset);
-    await this.reader.read(buf, 0, offset, buf.length);
-    const objEndIdx = buf.findIndex(
-      (_x, idx) => testForString(buf, idx, "endobj")
-    );
-    let streamIdx = buf.findIndex(
-      (_x, idx) => testForString(buf, idx, "stream")
-    );
-    if (streamIdx >= 0) {
-      streamIdx += "stream".length;
-      if (buf[streamIdx] === "\r".charCodeAt(0)) {
-        streamIdx += 2;
-      } else {
-        streamIdx += 1;
-      }
-    }
-    const objSig = `${num} ${this.objGenerations[num]} obj`;
-    const objParser = new PdfValueParser(
-      buf.subarray(objSig.length, streamIdx < 0 ? objEndIdx : streamIdx)
-    );
-    const data = objParser.read();
-    if (typeof data !== "object" || data === null) {
-      throw new Error("Illegal PDF object, does not start with a dictionary.");
-    }
-    let stream;
-    if (withStream && streamIdx > 0) {
-      const streamLength = data.Length;
-      if (streamLength === void 0) {
-        throw new Error(
-          "Illegal stream object, missing Length entry in object dictionary."
-        );
-      }
-      stream = buf.subarray(streamIdx, streamIdx + streamLength);
-    }
-    return {
-      num,
-      data,
-      stream
-    };
-  }
-};
-
-// src/version.ts
-var version_default = "0.2.3";
-
-// src/pdf/pkzip.ts
-function buildLocalZipHeader({
-  creationDate = /* @__PURE__ */ new Date(),
-  filename,
-  data,
-  compressedData,
-  extraDataLength
-}) {
-  const creationTimeZip = creationDate.getHours() << 11 | creationDate.getDay() << 5 | Math.round(creationDate.getSeconds() / 2);
-  const creationDateZip = creationDate.getFullYear() - 1980 << 9 | creationDate.getMonth() + 1 << 5 | creationDate.getDate();
-  const dataCrc = crc32(data);
-  const filenameEncoded = textEncoder.encode(filename);
-  const compressedLength = compressedData ? compressedData.length - 2 : data.length;
-  return new Uint8Array([
-    // PKZIP magic number
-    80,
-    75,
-    // Local File Header magic
-    3,
-    4,
-    // Required PKZip version
-    20,
-    0,
-    // General purpose bit flag, 2 bytes
-    0,
-    0,
-    // Compression method, 2 bytes little endian
-    compressedData ? 8 : 0,
-    0,
-    // Creation time, 2 bytes little endian
-    creationTimeZip & 255,
-    creationTimeZip >> 8,
-    // Creation date, 2 bytes little endian
-    creationDateZip & 255,
-    creationDateZip >> 8,
-    // CRC32 of data, 4 bytes little endian
-    dataCrc & 255,
-    dataCrc >> 8 & 255,
-    dataCrc >> 16 & 255,
-    dataCrc >> 24 & 255,
-    // Compressed size, 4 bytes little endian
-    compressedLength & 255,
-    compressedLength >> 8 & 255,
-    compressedLength >> 16 & 255,
-    compressedLength >> 24 & 255,
-    // Uncompressed size, 4 bytes little endian
-    data.length & 255,
-    data.length >> 8 & 255,
-    data.length >> 16 & 255,
-    data.length >> 24 & 255,
-    // Filename length, 2 bytes little endian
-    filenameEncoded.length & 255,
-    filenameEncoded.length >> 8,
-    // Filename length in little endian
-    // Extra field length, 2 bytes little endian
-    extraDataLength + 4 & 255,
-    extraDataLength + 4 >> 8,
-    // Encoded file name
-    ...filenameEncoded,
-    // Beginning of extra field: identifier, 2 bytes
-    255,
-    255,
-    // Beginning of extra field: length, 2 bytes little endian
-    extraDataLength & 255,
-    extraDataLength >> 8
-  ]);
-}
-function buildCentralFileDirectory({
-  files,
-  trailingLength,
-  offset
-}) {
-  const chunks = files.map(buildCentralDirectoryFileHeader);
-  const cdSize = chunks.reduce((acc, chunk) => acc + chunk.length, 0);
-  chunks.push(new Uint8Array([
-    // PKZIP magic number
-    80,
-    75,
-    // End of central directory magic
-    5,
-    6,
-    // Disk number
-    0,
-    0,
-    // Disk with central directory
-    0,
-    0,
-    // Disk entries
-    files.length & 255,
-    files.length >> 8,
-    // Total entries
-    files.length & 255,
-    files.length >> 8,
-    // Central directory size,
-    cdSize & 255,
-    cdSize >> 8 & 255,
-    cdSize >> 16 & 255,
-    cdSize >> 24 & 255,
-    // Offset of central directory in file
-    offset & 255,
-    offset >> 8 & 255,
-    offset >> 16 & 255,
-    offset >> 24 & 255,
-    // Length of trailing comment
-    trailingLength & 255,
-    trailingLength >> 8
-  ]));
-  return new Uint8Array(
-    chunks.reduce((acc, curr) => {
-      acc.push(...curr);
-      return acc;
-    }, [])
-  );
-}
-function buildCentralDirectoryFileHeader(spec) {
-  const creationTimeZip = spec.creationDate.getHours() << 11 | spec.creationDate.getMinutes() << 5 | Math.round(spec.creationDate.getSeconds() / 2);
-  const creationDateZip = spec.creationDate.getFullYear() - 1980 << 9 | spec.creationDate.getMonth() + 1 << 5 | spec.creationDate.getDate();
-  const filenameEncoded = textEncoder.encode(spec.filename);
-  return new Uint8Array([
-    // PKZIP magic number
-    80,
-    75,
-    // Central directory file header magic
-    1,
-    2,
-    // Version
-    23,
-    3,
-    //  Version needed
-    20,
-    0,
-    // Flags, none set
-    0,
-    0,
-    // Compression method, 2 bytes little endian
-    spec.deflated ? 8 : 0,
-    0,
-    // Creation time, 2 bytes little endian
-    creationTimeZip & 255,
-    creationTimeZip >> 8,
-    // Creation date, 2 bytes little endian
-    creationDateZip & 255,
-    creationDateZip >> 8,
-    // CRC32 of data, 4 bytes little endian
-    spec.crc32 & 255,
-    spec.crc32 >> 8 & 255,
-    spec.crc32 >> 16 & 255,
-    spec.crc32 >> 24 & 255,
-    // Compressed size, 4 bytes little endian
-    spec.compressedDataLength & 255,
-    spec.compressedDataLength >> 8 & 255,
-    spec.compressedDataLength >> 16 & 255,
-    spec.compressedDataLength >> 24 & 255,
-    // Uncompressed size, 4 bytes little endian
-    spec.dataLength & 255,
-    spec.dataLength >> 8 & 255,
-    spec.dataLength >> 16 & 255,
-    spec.dataLength >> 24 & 255,
-    // Filename length, 2 bytes little endian
-    filenameEncoded.length & 255,
-    filenameEncoded.length >> 8,
-    // Filename length in little endian
-    // Extra field length, 2 bytes little endian
-    0,
-    0,
-    // File comment length, 2 bytes little endian
-    0,
-    0,
-    // Disk # start, 2 bytes little endian
-    0,
-    0,
-    // Internal Attribute, 2 bytes little endian
-    0,
-    0,
-    // External Attribute, 4 bytes little endian
-    0,
-    0,
-    164,
-    129,
-    // Offset of local header, 4 bytes little endian
-    spec.localHeaderOffset & 255,
-    spec.localHeaderOffset >> 8 & 255,
-    spec.localHeaderOffset >> 16 & 255,
-    spec.localHeaderOffset >> 24 & 255,
-    ...filenameEncoded
-  ]);
-}
-
-// src/pdf/annos.ts
-var import_color = __toESM(require("color"), 1);
-var import_sax_wasm = require("sax-wasm");
-var CSS_LENGTH_PAT = /(?<val>\d+(?:\.\d+)?)\s*(?<unit>[[a-z%]+)?/;
-function htmlToPlainText(html) {
-  const parser = new import_sax_wasm.SAXParser(import_sax_wasm.SaxEventType.Text, { highWaterMark: 1024 });
-  const txt = [];
-  parser.eventHandler = (ev, data) => {
-    txt.push(data.value);
-  };
-  parser.write(textEncoder.encode(html));
-  return txt.join("").trim();
-}
-function toPdfRect(selector, pageHeight, unitScale) {
-  if (!selector.spatial) {
-    return null;
-  }
-  const lly = pageHeight - selector.spatial.y;
-  const ury = lly - selector.spatial.height;
-  return {
-    Subtype: "/Square",
-    Rect: [
-      selector.spatial.x * unitScale,
-      lly * unitScale,
-      (selector.spatial.x + selector.spatial.width) * unitScale,
-      ury * unitScale
-    ]
-  };
-}
-function cssColorToRgb(cssColor) {
-  return (0, import_color.default)(cssColor).rgb().array();
-}
-function cssLengthToPdfUserspace(cssLength, unitScale, referenceDimensionPx) {
-  const match = CSS_LENGTH_PAT.exec(cssLength);
-  if (!match || !match.groups) {
-    return null;
-  }
-  const val = parseFloat(match.groups.val);
-  const unit = match.groups.unit;
-  if (!unit) {
-    return val * unitScale;
-  }
-  switch (unit) {
-    case "%":
-      if (!referenceDimensionPx) {
-        return null;
-      }
-      return val / 100 * referenceDimensionPx * unitScale;
-    case "px":
-      return unitScale * val;
-    default:
-      console.warn(`Unsupported CSS length unit: ${unit}`);
-      return null;
-  }
-}
-function selectorStyleToPdf(style, unitScale) {
-  const pdfStyle = {};
-  if (style.stroke || style.strokeDasharray || style.strokeWidth) {
-    pdfStyle.BS = {
-      Type: "/Border",
-      W: style.strokeWidth ?? 1,
-      S: style.strokeDasharray ? "/D" : "/S"
-    };
-    if (style.strokeDasharray) {
-      pdfStyle.BS.D = style.strokeDasharray;
-    }
-  }
-  if (style.fill) {
-    const rgb = cssColorToRgb(style.fill);
-    if (rgb) {
-      pdfStyle.IC = rgb.map((c) => c / 255);
-    }
-  }
-  if (style.strokeWidth) {
-    const width = cssLengthToPdfUserspace(style.strokeWidth, unitScale);
-    pdfStyle.BS = {
-      Type: "/Border",
-      W: width
-    };
-  }
-  return pdfStyle;
-}
-function selectorToPdf(selector, unitScale, pageHeight) {
-  const styleDict = selector.style ? selectorStyleToPdf(selector.style, unitScale) : {};
-  switch (selector.type) {
-    case "BoxSelector":
-      return {
-        Subtype: "/Square",
-        ...toPdfRect(selector, pageHeight, unitScale),
-        ...styleDict
-      };
-    case "PointSelector": {
-      const point = selector;
-      if (!point.x || !point.y) {
-        throw `Only PointSelectors with both x and y coordinates are supported!`;
-      }
-      return {
-        Subtype: "/Circle",
-        BS: {
-          Type: "/Border",
-          W: 2,
-          S: "/S"
-        },
-        IC: [1, 1, 1],
-        Rect: [
-          point.x * unitScale - 0.5,
-          point.y * unitScale - 0.5,
-          point.x * unitScale + 1,
-          point.y * unitScale + 1
-        ]
-      };
-    }
-    case "SvgSelector": {
-      const svgSel = selector;
-      switch (svgSel.svgShape) {
-        case "rect":
-          return {
-            Subtype: "/Square",
-            ...toPdfRect(svgSel, pageHeight, unitScale),
-            ...styleDict
-          };
-        case "circle":
-        case "ellipse":
-          return {
-            Subtype: "/Circle",
-            Rect: toPdfRect(svgSel, pageHeight, unitScale),
-            ...styleDict
-          };
-        case "polyline":
-        case "polygon":
-          return {
-            Subtype: svgSel.svgShape === "polyline" ? "/PolyLine" : "/Polygon",
-            Vertices: svgSel.points?.flatMap(([x, y]) => [
-              x * unitScale,
-              (pageHeight - y) * unitScale
-            ]) ?? [],
-            ...styleDict
-          };
-        case "path":
-          return {
-            Subtype: "/Ink",
-            InkList: svgSel.points?.flatMap(([x, y]) => [
-              x * unitScale,
-              (pageHeight - y) * unitScale
-            ]) ?? [],
-            ...styleDict
-          };
-        default:
-          throw new Error("not implemented yet");
-      }
-    }
-    default:
-      throw `${selector.type} selector is currently not supported`;
-  }
-}
-function exportPdfAnnotation(anno, unitScale, pageHeight) {
-  const annoDict = {
-    Type: "/Annot",
-    NM: `(${anno.id})`,
-    Contents: `(${htmlToPlainText(anno.markup)})`,
-    F: 4,
-    C: [1, 0, 0],
-    // Red title bar
-    CA: 1,
-    // Constant opacity of 1
-    Border: [0, 0, 5]
-    //RC: `(${htmlToPdfRichText(anno.markup)})`,
-  };
-  if (anno.author) {
-    annoDict.T = `(${anno.author})`;
-  }
-  if (anno.lastModified) {
-    annoDict.M = anno.lastModified;
-  }
-  if (anno.target.selector) {
-    return [
-      {
-        ...annoDict,
-        ...selectorToPdf(anno.target.selector, unitScale, pageHeight)
-      }
-    ];
-  } else if (anno.target.selectors && anno.target.selectors.length > 0) {
-    return anno.target.selectors.map((s) => ({
-      ...annoDict,
-      ...selectorToPdf(s, unitScale, pageHeight)
-    }));
-  }
-  return [];
-}
-
-// src/pdf/generator.ts
-var PRODUCER = `pdiiif v${version_default}`;
-var CHAR_WIDTH = 2;
-var FONTDATA = new Uint8Array([
-  0,
-  1,
-  0,
-  0,
-  0,
-  10,
-  0,
-  128,
-  0,
-  3,
-  0,
-  32,
-  79,
-  83,
-  47,
-  50,
-  86,
-  222,
-  200,
-  148,
-  0,
-  0,
-  1,
-  40,
-  0,
-  0,
-  0,
-  96,
-  99,
-  109,
-  97,
-  112,
-  0,
-  10,
-  0,
-  52,
-  0,
-  0,
-  1,
-  144,
-  0,
-  0,
-  0,
-  30,
-  103,
-  108,
-  121,
-  102,
-  21,
-  34,
-  65,
-  36,
-  0,
-  0,
-  1,
-  184,
-  0,
-  0,
-  0,
-  24,
-  104,
-  101,
-  97,
-  100,
-  11,
-  120,
-  241,
-  101,
-  0,
-  0,
-  0,
-  172,
-  0,
-  0,
-  0,
-  54,
-  104,
-  104,
-  101,
-  97,
-  12,
-  2,
-  4,
-  2,
-  0,
-  0,
-  0,
-  228,
-  0,
-  0,
-  0,
-  36,
-  104,
-  109,
-  116,
-  120,
-  4,
-  0,
-  0,
-  0,
-  0,
-  0,
-  1,
-  136,
-  0,
-  0,
-  0,
-  8,
-  108,
-  111,
-  99,
-  97,
-  0,
-  12,
-  0,
-  0,
-  0,
-  0,
-  1,
-  176,
-  0,
-  0,
-  0,
-  6,
-  109,
-  97,
-  120,
-  112,
-  0,
-  4,
-  0,
-  5,
-  0,
-  0,
-  1,
-  8,
-  0,
-  0,
-  0,
-  32,
-  110,
-  97,
-  109,
-  101,
-  242,
-  235,
-  22,
-  218,
-  0,
-  0,
-  1,
-  208,
-  0,
-  0,
-  0,
-  75,
-  112,
-  111,
-  115,
-  116,
-  0,
-  1,
-  0,
-  1,
-  0,
-  0,
-  2,
-  28,
-  0,
-  0,
-  0,
-  32,
-  0,
-  1,
-  0,
-  0,
-  0,
-  1,
-  0,
-  0,
-  176,
-  148,
-  113,
-  16,
-  95,
-  15,
-  60,
-  245,
-  4,
-  7,
-  8,
-  0,
-  0,
-  0,
-  0,
-  0,
-  207,
-  154,
-  252,
-  110,
-  0,
-  0,
-  0,
-  0,
-  212,
-  195,
-  167,
-  242,
-  0,
-  0,
-  0,
-  0,
-  4,
-  0,
-  8,
-  0,
-  0,
-  0,
-  0,
-  16,
-  0,
-  2,
-  0,
-  0,
-  0,
-  0,
-  0,
-  0,
-  0,
-  1,
-  0,
-  0,
-  8,
-  0,
-  255,
-  255,
-  0,
-  0,
-  4,
-  0,
-  0,
-  0,
-  0,
-  0,
-  4,
-  0,
-  0,
-  1,
-  0,
-  0,
-  0,
-  0,
-  0,
-  0,
-  0,
-  0,
-  0,
-  0,
-  0,
-  0,
-  0,
-  0,
-  0,
-  2,
-  0,
-  1,
-  0,
-  0,
-  0,
-  2,
-  0,
-  4,
-  0,
-  1,
-  0,
-  0,
-  0,
-  0,
-  0,
-  1,
-  0,
-  0,
-  0,
-  0,
-  0,
-  0,
-  0,
-  0,
-  0,
-  0,
-  0,
-  0,
-  0,
-  0,
-  0,
-  0,
-  0,
-  3,
-  0,
-  0,
-  1,
-  144,
-  0,
-  5,
-  0,
-  0,
-  0,
-  0,
-  0,
-  0,
-  0,
-  0,
-  0,
-  0,
-  0,
-  0,
-  0,
-  0,
-  0,
-  0,
-  0,
-  0,
-  0,
-  0,
-  0,
-  0,
-  0,
-  0,
-  5,
-  0,
-  1,
-  0,
-  1,
-  0,
-  0,
-  0,
-  0,
-  0,
-  0,
-  0,
-  0,
-  0,
-  0,
-  0,
-  0,
-  0,
-  0,
-  0,
-  0,
-  0,
-  0,
-  0,
-  0,
-  0,
-  71,
-  79,
-  79,
-  71,
-  0,
-  64,
-  0,
-  0,
-  0,
-  0,
-  0,
-  1,
-  255,
-  255,
-  0,
-  0,
-  0,
-  1,
-  0,
-  1,
-  128,
-  0,
-  0,
-  0,
-  0,
-  0,
-  0,
-  0,
-  0,
-  0,
-  0,
-  0,
-  0,
-  0,
-  0,
-  1,
-  0,
-  0,
-  0,
-  0,
-  0,
-  0,
-  4,
-  0,
-  0,
-  0,
-  0,
-  0,
-  0,
-  2,
-  0,
-  1,
-  0,
-  0,
-  0,
-  0,
-  0,
-  20,
-  0,
-  3,
-  0,
-  0,
-  0,
-  0,
-  0,
-  20,
-  0,
-  6,
-  0,
-  10,
-  0,
-  0,
-  0,
-  0,
-  0,
-  0,
-  0,
-  0,
-  0,
-  0,
-  0,
-  0,
-  0,
-  12,
-  0,
-  0,
-  0,
-  1,
-  0,
-  0,
-  0,
-  0,
-  4,
-  0,
-  8,
-  0,
-  0,
-  3,
-  0,
-  0,
-  49,
-  33,
-  17,
-  33,
-  4,
-  0,
-  252,
-  0,
-  8,
-  0,
-  0,
-  0,
-  0,
-  3,
-  0,
-  42,
-  0,
-  0,
-  0,
-  3,
-  0,
-  0,
-  0,
-  5,
-  0,
-  22,
-  0,
-  0,
-  0,
-  1,
-  0,
-  0,
-  0,
-  0,
-  0,
-  5,
-  0,
-  11,
-  0,
-  22,
-  0,
-  3,
-  0,
-  1,
-  4,
-  9,
-  0,
-  5,
-  0,
-  22,
-  0,
-  0,
-  0,
-  86,
-  0,
-  101,
-  0,
-  114,
-  0,
-  115,
-  0,
-  105,
-  0,
-  111,
-  0,
-  110,
-  0,
-  32,
-  0,
-  49,
-  0,
-  46,
-  0,
-  48,
-  86,
-  101,
-  114,
-  115,
-  105,
-  111,
-  110,
-  32,
-  49,
-  46,
-  48,
-  0,
-  0,
-  1,
-  0,
-  0,
-  0,
-  0,
-  0,
-  0,
-  0,
-  0,
-  0,
-  0,
-  0,
-  0,
-  0,
-  1,
-  0,
-  0,
-  0,
-  0,
-  0,
-  0,
-  0,
-  0,
-  0,
-  0,
-  0,
-  0,
-  0,
-  0,
-  0,
-  0
-]);
-var PDFGenerator = class {
-  // Keep track of how many bytes have been written so far
-  _offset = 0;
-  // PDF objects that are scheduled for writing, will be written on _flush()
-  _objects = [];
-  // Number of the next PDF object
-  _nextObjNo = 1;
-  // References to various central objects
-  _objRefs = {};
-  // Tracks offset of every XObject
-  _offsets = [];
-  // Writer used for outputting the PDF
-  _writer;
-  // Have we already started writing the IIIF pages?
-  _pagesStarted = false;
-  // Information about each canvas, needed for pre-allocating objects
-  _canvasInfos = [];
-  // Object number of the first page
-  _firstPageObjectNum;
-  // Labels for every page in the PDF
-  _pageLabels;
-  // Number of cover pages inserted at the beginning of the PDF
-  _numCoverPages = 0;
-  // PDF outline
-  _outline = [];
-  // Is the PDF supposed to have a hidden text layer?
-  _hasText = false;
-  // List of top-level entries in the PDF's logical structure tree
-  _strucTree = [];
-  // Maps a page's object number to the marked content sequence IDs its content
-  // stream has
-  _pageMCIds = /* @__PURE__ */ new Map();
-  // Identifier of the next structure parent entry
-  _nextStructParentId = 0;
-  // For every page, its corresponding parent ID for the parent tree
-  _pageParentIds = /* @__PURE__ */ new Map();
-  // Language preference
-  _langPref;
-  _initialCanvas;
-  _polyglot;
-  _manifestJson;
-  _zipCatalog;
-  _zipBaseDir;
-  _readingDirection;
-  constructor({
-    writer,
-    metadata,
-    canvasInfos,
-    langPref,
-    pageLabels,
-    outline = [],
-    readingDirection = "left-to-right",
-    hasText = false,
-    initialCanvas,
-    manifestJson,
-    zipPolyglot = false,
-    zipBaseDir
-  }) {
-    this._writer = writer;
-    this._canvasInfos = canvasInfos;
-    this._pageLabels = pageLabels;
-    this._outline = outline;
-    this._hasText = hasText;
-    this._readingDirection = readingDirection;
-    this._langPref = langPref;
-    this._initialCanvas = initialCanvas;
-    this._polyglot = zipPolyglot;
-    this._zipBaseDir = zipBaseDir;
-    this._manifestJson = manifestJson;
-    const pdfMetadata = {
-      ...Object.entries(metadata).filter((k, v) => v !== void 0).reduce((prev, [k, v]) => {
-        prev[k] = `(${v})`;
-        return prev;
-      }, {}),
-      Producer: `(${PRODUCER})`
-    };
-    this._addObject(pdfMetadata, "Info");
-  }
-  async setup() {
-    const catalog = {
-      Type: "/Catalog"
-    };
-    this._addObject(catalog, "Catalog");
-    const pagesObj = this._addObject(
-      {
-        Type: "/Pages",
-        Count: this._canvasInfos.length
-      },
-      "Pages"
-    );
-    catalog.Pages = makeRef(pagesObj);
-    if (this._hasText) {
-      catalog.MarkInfo = {
-        Type: "/MarkInfo",
-        Marked: true
-      };
-    }
-    if (this._outline.length > 0) {
-      catalog.PageMode = "/UseOutlines";
-      const outlines = {
-        Type: "/Outlines",
-        Count: 0
-      };
-      const outlinesObj = this._addObject(outlines);
-      catalog.Outlines = makeRef(outlinesObj);
-      let prev;
-      for (const [idx, itm] of this._outline.entries()) {
-        const [childObj, numKids] = this._addOutline(itm, outlinesObj, prev);
-        outlines.Count += 1 + numKids;
-        if (idx === 0) {
-          outlines.First = makeRef(childObj);
-        } else if (idx === this._outline.length - 1) {
-          outlines.Last = makeRef(childObj);
-        }
-        prev = childObj;
-      }
-    } else {
-      catalog.PageMode = "/UseThumbs";
-    }
-    catalog.ViewerPreferences = {
-      Direction: this._readingDirection === "right-to-left" ? "/R2L" : "/L2R"
-    };
-    if (this._hasText) {
-      await this._setupHiddenTextFont();
-    }
-  }
-  async _setupHiddenTextFont() {
-    const typeZeroFont = this._addObject(
-      {
-        Type: "/Font",
-        Subtype: "/Type0",
-        BaseFont: "/GlyphLessFont",
-        Encoding: "/Identity-H"
-      },
-      "Type0Font"
-    );
-    const typeTwoFont = this._addObject({
-      type: "/Font",
-      Subtype: "/CIDFontType2",
-      BaseFont: "/GlyphLessFont",
-      DW: 1e3 / CHAR_WIDTH,
-      CIDSystemInfo: {
-        Ordering: "(Identity)",
-        Registry: "(Adobe)",
-        Supplement: 0
-      }
-    });
-    typeZeroFont.data.DescendantFonts = [
-      makeRef(typeTwoFont)
-    ];
-    const cidtoGidMapData = new Uint8Array(128 * 1024);
-    for (let i = 0; i < cidtoGidMapData.length; i++) {
-      cidtoGidMapData[i] = i % 2 ? 1 : 0;
-    }
-    const comp = await tryDeflateStream(cidtoGidMapData);
-    const cidToGidMap = this._addObject(comp.dict, void 0, comp.stream);
-    typeTwoFont.data.CIDToGIDMap = makeRef(cidToGidMap);
-    const cmapStream = import_dedent_js.default`
+"use strict";var Uo=Object.defineProperty;var zo=(e,t,r)=>t in e?Uo(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r;var v=(e,t,r)=>zo(e,typeof t!="symbol"?t+"":t,r);Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const sr=require("prom-client"),Bo=require("events"),tn=require("util"),qo=require("zlib"),Ho=require("crypto");class Vn{constructor(t="warn"){v(this,"level");this.level=t}setLevel(t){this.level=t}debug(t,...r){this.level==="debug"&&console.debug(t,...r)}info(t,...r){this.level!=="error"&&this.level!=="warn"&&console.info(t,...r)}warn(t,...r){this.level!=="error"&&console.warn(t,...r)}error(t,...r){console.error(t,...r)}}let O=new Vn;function Qo(e){O=e}const Go=new Error("request for lock canceled");var Yo=function(e,t,r,i){function n(s){return s instanceof r?s:new r(function(a){a(s)})}return new(r||(r=Promise))(function(s,a){function o(l){try{h(i.next(l))}catch(u){a(u)}}function c(l){try{h(i.throw(l))}catch(u){a(u)}}function h(l){l.done?s(l.value):n(l.value).then(o,c)}h((i=i.apply(e,t||[])).next())})};class Vo{constructor(t,r=Go){this._value=t,this._cancelError=r,this._weightedQueues=[],this._weightedWaiters=[]}acquire(t=1){if(t<=0)throw new Error(`invalid weight ${t}: must be positive`);return new Promise((r,i)=>{this._weightedQueues[t-1]||(this._weightedQueues[t-1]=[]),this._weightedQueues[t-1].push({resolve:r,reject:i}),this._dispatch()})}runExclusive(t,r=1){return Yo(this,void 0,void 0,function*(){const[i,n]=yield this.acquire(r);try{return yield t(i)}finally{n()}})}waitForUnlock(t=1){if(t<=0)throw new Error(`invalid weight ${t}: must be positive`);return new Promise(r=>{this._weightedWaiters[t-1]||(this._weightedWaiters[t-1]=[]),this._weightedWaiters[t-1].push(r),this._dispatch()})}isLocked(){return this._value<=0}getValue(){return this._value}setValue(t){this._value=t,this._dispatch()}release(t=1){if(t<=0)throw new Error(`invalid weight ${t}: must be positive`);this._value+=t,this._dispatch()}cancel(){this._weightedQueues.forEach(t=>t.forEach(r=>r.reject(this._cancelError))),this._weightedQueues=[]}_dispatch(){var t;for(let r=this._value;r>0;r--){const i=(t=this._weightedQueues[r-1])===null||t===void 0?void 0:t.shift();if(!i)continue;const n=this._value,s=r;this._value-=r,r=this._value+1,i.resolve([n,this._newReleaser(s)])}this._drainUnlockWaiters()}_newReleaser(t){let r=!1;return()=>{r||(r=!0,this.release(t))}}_drainUnlockWaiters(){for(let t=this._value;t>0;t--)this._weightedWaiters[t-1]&&(this._weightedWaiters[t-1].forEach(r=>r()),this._weightedWaiters[t-1]=[])}}var Jo=function(e,t,r,i){function n(s){return s instanceof r?s:new r(function(a){a(s)})}return new(r||(r=Promise))(function(s,a){function o(l){try{h(i.next(l))}catch(u){a(u)}}function c(l){try{h(i.throw(l))}catch(u){a(u)}}function h(l){l.done?s(l.value):n(l.value).then(o,c)}h((i=i.apply(e,t||[])).next())})};class Xo{constructor(t){this._semaphore=new Vo(1,t)}acquire(){return Jo(this,void 0,void 0,function*(){const[,t]=yield this._semaphore.acquire();return t})}runExclusive(t){return this._semaphore.runExclusive(()=>t())}isLocked(){return this._semaphore.isLocked()}waitForUnlock(){return this._semaphore.waitForUnlock()}release(){this._semaphore.isLocked()&&this._semaphore.release()}cancel(){return this._semaphore.cancel()}}var we;let N=(we=class{},v(we,"Text",1),v(we,"ProcessingInstruction",2),v(we,"SGMLDeclaration",4),v(we,"Doctype",8),v(we,"Comment",16),v(we,"OpenTagStart",32),v(we,"Attribute",64),v(we,"OpenTag",128),v(we,"CloseTag",256),v(we,"Cdata",512),we),Tr=class{constructor(t,r=0){v(this,"data");v(this,"cache",{});v(this,"ptr");this.data=t,this.ptr=r}},Ko=class{constructor(t,r){v(this,"line");v(this,"character");this.line=t,this.character=r}};var rn;(function(e){e[e.Normal=0]="Normal",e[e.JSX=1]="JSX"})(rn||(rn={}));let Jn=class extends Tr{constructor(r,i=0){super(r,i);v(this,"type");v(this,"name");v(this,"value");this.type=r[i],i+=1;const n=xe(r,i);i+=4,this.name=new Pt(r,i),i+=n,this.value=new Pt(r,i)}toJSON(){const{name:r,value:i,type:n}=this;return{name:r,value:i,type:n}}toString(){const{name:r,value:i}=this;return`${r}="${i}"`}},Zo=class extends Tr{constructor(r,i=0){super(r,i);v(this,"target");v(this,"content");i+=16;const n=xe(r,i);i+=4,this.target=new Pt(r,i),i+=n,this.content=new Pt(r,i)}get start(){return this.cache.start||(this.cache.start=Xe(this.data,this.ptr))}get end(){return this.cache.end||(this.cache.end=Xe(this.data,this.ptr+8))}toJSON(){const{start:r,end:i,target:n,content:s}=this;return{start:r,end:i,target:n,content:s}}toString(){const{target:r,content:i}=this;return`<? ${r} ${i} ?>`}},Pt=class extends Tr{get start(){return this.cache.start||(this.cache.start=Xe(this.data,this.ptr))}get end(){return this.cache.end||(this.cache.end=Xe(this.data,this.ptr+8))}get value(){if(this.cache.value)return this.cache.value;const t=xe(this.data,this.ptr+16);return this.cache.value=Xn(this.data,this.ptr+20,t)}toJSON(){const{start:t,end:r,value:i}=this;return{start:t,end:r,value:i}}toString(){return this.value}},ec=class extends Tr{get openStart(){return this.cache.openStart||(this.cache.openStart=Xe(this.data,this.ptr+8))}get openEnd(){return this.cache.openEnd||(this.cache.openEnd=Xe(this.data,this.ptr+16))}get closeStart(){return this.cache.closeStart||(this.cache.closeStart=Xe(this.data,this.ptr+24))}get closeEnd(){return this.cache.closeEnd||(this.cache.closeEnd=Xe(this.data,this.ptr+32))}get selfClosing(){return!!this.data[this.ptr+40]}get name(){if(this.cache.name)return this.cache.name;const t=xe(this.data,this.ptr+41);return this.cache.name=Xn(this.data,this.ptr+45,t)}get attributes(){if(this.cache.attributes)return this.cache.attributes;let t=xe(this.data,this.ptr);const r=xe(this.data,t);t+=4;const i=[];for(let n=0;n<r;n++){const s=xe(this.data,t);t+=4,i[n]=new Jn(this.data,t),t+=s}return this.cache.attributes=i}get textNodes(){if(this.cache.textNodes)return this.cache.textNodes;let t=xe(this.data,this.ptr+4);const r=xe(this.data,t),i=[];t+=4;for(let n=0;n<r;n++){const s=xe(this.data,t);t+=4,i[n]=new Pt(this.data,t),t+=s}return this.cache.textNodes=i}toJSON(){const{openStart:t,openEnd:r,closeStart:i,closeEnd:n,name:s,attributes:a,textNodes:o,selfClosing:c}=this;return{openStart:t,openEnd:r,closeStart:i,closeEnd:n,name:s,attributes:a,textNodes:o,selfClosing:c}}get value(){return this.name}};var oi;let ci=(oi=class{constructor(t=0,r={highWaterMark:32*1024}){v(this,"events");v(this,"wasmSaxParser");v(this,"eventHandler");v(this,"options");v(this,"writeBuffer");v(this,"eventTrap",(t,r,i)=>{if(!this.wasmSaxParser)return;const n=new Uint8Array(this.wasmSaxParser.memory.buffer,r,i).slice();let s;switch(t){case N.Attribute:s=new Jn(n);break;case N.ProcessingInstruction:s=new Zo(n);break;case N.OpenTag:case N.CloseTag:case N.OpenTagStart:s=new ec(n);break;case N.Text:case N.Cdata:case N.Comment:case N.Doctype:case N.SGMLDeclaration:s=new Pt(n);break;default:throw new Error("No reader for this event type")}this.eventHandler&&this.eventHandler(t,s)});this.options=r;const i=this;Object.defineProperties(this,{events:{get:()=>~~t,set:n=>{t=~~n,i.wasmSaxParser&&i.wasmSaxParser.parser(t)},configurable:!1,enumerable:!0}})}write(t){if(!this.wasmSaxParser)return;const{write:r,memory:i}=this.wasmSaxParser;(!this.writeBuffer||this.writeBuffer.buffer!==i.buffer)&&(this.writeBuffer=new Uint8Array(i.buffer)),this.writeBuffer.set(t,0),r(0,t.byteLength)}end(){var t;this.writeBuffer=void 0,(t=this.wasmSaxParser)==null||t.end()}async prepareWasm(t){let r;if(t instanceof Uint8Array?r=await WebAssembly.instantiate(t,{env:{memoryBase:0,tableBase:0,memory:new WebAssembly.Memory({initial:10}),table:new WebAssembly.Table({initial:1,element:"anyfunc"}),event_listener:this.eventTrap}}):r=await WebAssembly.instantiateStreaming(t),r&&typeof this.events=="number"){const{parser:i}=this.wasmSaxParser=r.instance.exports;return i(this.events),!0}throw new Error("Failed to instantiate the parser.")}},v(oi,"textDecoder"),oi);const Xn=(e,t,r)=>globalThis.hasOwnProperty("Buffer")?Buffer.from(e.buffer,e.byteOffset+t,r).toString():(ci.textDecoder||(ci.textDecoder=new TextDecoder)).decode(e.subarray(t,t+r)),xe=(e,t)=>e[t+3]<<24|e[t+2]<<16|e[t+1]<<8|e[t],Xe=(e,t=0)=>{const r=xe(e,t),i=xe(e,t+4);return new Ko(r,i)};function Kn(e){return{...e,type:"line",children:[],get words(){return this.children.filter(t=>typeof t!="string")},get text(){return this.children.map(t=>typeof t=="string"?t:t.text).join("")}}}function tc(e){return{...e,type:"paragraph",children:[],get lines(){return this.children},get words(){return this.children.flatMap(t=>t.words)},get text(){var t;const r=[];for(const[i,n]of this.children.entries())r.push(n.text),i<this.children.length-1&&!((t=n.words.slice(-1)[0])!=null&&t.hyphenStart)&&r.push(" ");return r.join("")}}}function Zn(e){return{...e,type:"block",children:[],get paragraphs(){return this.children.filter(t=>"lines"in t)},get lines(){return this.children.reduce((t,r)=>("lines"in r?t.push(...r.lines):"words"in r&&t.push(r),t),[])},get words(){return this.lines.flatMap(t=>t.words)},get text(){var t;const r=[];for(const[i,n]of this.children.entries())r.push(n.text),i<this.children.length-1&&!((t=n.words.slice(-1)[0])!=null&&t.hyphenStart)&&(n.type==="line"?r.push(" "):r.push(`
+`));return r.join("")}}}function es(e){return{...e,type:"page",children:[],get blocks(){return this.children.filter(t=>"paragraphs"in t)},get paragraphs(){return this.children.reduce((t,r)=>("paragraphs"in r?t.push(...r.paragraphs):"lines"in r&&t.push(r),t),[])},get lines(){return this.children.reduce((t,r)=>("lines"in r?t.push(...r.lines):"words"in r&&t.push(r),t),[])},get words(){return this.children.flatMap(t=>t.words)},get text(){var t;const r=[];for(const[i,n]of this.children.entries())r.push(n.text),i<this.children.length-1&&!((t=n.words.slice(-1)[0])!=null&&t.hyphenStart)&&(n.type==="line"?r.push(" "):r.push(`
+`));return r.join("")}}}var Ri="2.2.4",Pr=null;async function ts(e=()=>fetch(`https://unpkg.com/sax-wasm@${Ri}/lib/sax-wasm.wasm`).then(t=>t.arrayBuffer()).then(t=>new Uint8Array(t))){Pr=await e()}function Xt(){return Pr!==null}async function rs(e,t){const r=new sc(e,new Set([N.OpenTag,N.Text,N.CloseTag]),{highWaterMark:65536});if(!Xt())throw new Error("XML parser WASM not initialized, call initialize() first!");if(!await r.prepareWasm(Pr))throw new Error("Failed to initialize parser with WASM");return r}var rc=/&#(\d+);/g,ic=/&#x([A-Fa-f0-9]+);/g,is={amp:"&",apos:"'",quot:'"',lt:"<",gt:">"},nc=new RegExp(`&(${Object.keys(is).join("|")});`,"g");function xr(e){return e=e.replace(nc,function(t,r){return is[r]}),e=e.replace(rc,function(t,r){const i=parseInt(r,10);return String.fromCharCode(i)}),e=e.replace(ic,function(t,r){const i=parseInt(r,16);return String.fromCharCode(i)}),e}function ns(e){const t=new TextEncoder;return new ReadableStream({start(r){r.enqueue(e instanceof Uint8Array?e:t.encode(e)),r.close()}})}function Ue(e,t){var r;const i=e.attributes.find(n=>n.name.value===t);return(r=i==null?void 0:i.value)==null?void 0:r.value}function Mi(e){return Object.fromEntries(e.attributes.map(t=>[t.name.value,t.value.value]))}var sc=class{constructor(e,t,r){this.accumulator=[],this.readable=e;let i;if(t){i=0;for(const n of t)i|=n}this.saxParser=new ci(i,r),this.saxParser.eventHandler=(n,s)=>this.accumulator.push([n,s])}prepareWasm(e){return this.saxParser.prepareWasm(Pr)}[Symbol.asyncIterator](){return this.iterate()}async*iterate(){const e=this.readable.getReader();try{for(;;){const t=await e.read();if(t.done)break;for(this.saxParser.write(t.value);this.accumulator.length>0;)yield this.accumulator.shift()}}finally{e.releaseLock()}for(;this.accumulator.length>0;)yield this.accumulator.shift()}};function jr(e,t="log",r){console[t](`At line ${r.openStart.line}, column ${r.openStart.character}: ${e}`)}function ir(e){const t=Ue(e,"title");return t?t.split(";").map(i=>i.trim()).reduce((i,n)=>{const s=n.split(" ")[0];return s==="bbox"?i[s]=n.split(" ").slice(1,5).map(a=>Number.parseInt(a,10)):(i[s]=n.split(" ").slice(1,5).join(" "),i[s].startsWith('"')&&i[s].endsWith('"')&&(i[s]=i[s].slice(1,-1))),i},{}):{}}function $r(e,t){return e.split(" ").map(r=>Number.parseFloat(r)).reduce((r,i)=>{const n=r.slice(-1)[0];return!n||n.length===2?r.push([i]):n.push(i),r},[]).map(([r,i])=>({x:t*r,y:t*i}))}async function Fr(e,t,r){let i=0,n;for(;i>=0&&!(n=await e.next()).done;){const[s,a]=n.value;if(s===N.Text&&t.has("text")){const h=r.elementStack.slice(-1)[0];if(typeof h!="string"&&h.type==="line"){const l=a.value.replace(/\s+/g," "),u=l===" ";(h.children.length>0||!u)&&!(h.children.slice(-1)[0]===" "&&u)&&h.children.push(l)}}if(s===N.CloseTag&&i--,s!==N.OpenTag)continue;i++;const o=a,c=Ni(o);if(c!==null){if(!t.has(c)){jr(`Unexpected hOCR element type: ${c}, expected one of [${Array.from(t).join(", ")}]`,"warn",o);continue}switch(c){case"block":await oc(e,o,r),i--;break;case"paragraph":await cc(e,o,r),i--;break;case"line":await lc(e,o,r),i--;break;case"word":await hc(e,o,r),i--;break}}}r.elementStack.pop()}async function ac(e,t,r,i){var n;const s=ir(t),a=s.bbox;r.scaleFactor=i?uc(a,i):1;const o=es({features:[],width:a[2]*r.scaleFactor,height:a[3]*r.scaleFactor});"ppageno"in s&&(o.physicalPageNumber=Number.parseInt(s.ppageno,10)),"lpageno"in s&&(o.logicalPageNumber=s.lpageno),"image"in s&&(o.imageSource={fileName:s.image}),"x_source"in s&&(o.imageSource||(o.imageSource={}),o.imageSource.documentIdentifier=s.x_source),"imagemd5"in s&&(o.imageSource||(o.imageSource={}),o.imageSource.checksum=s.imagemd5,o.imageSource.checksumType="MD5"),"scan_res"in s&&(o.imageSource||(o.imageSource={}),o.imageSource.ppi=Number.parseInt(s.scan_res.split(" ")[0],10)),r.elementStack.push(o),await Fr(e,new Set(["block","paragraph","line"]),r);for(const c of["blocks","paragraphs","lines"])((n=o[c])!=null?n:[]).some(h=>h.polygon!==void 0)&&o.features.push("POLYGONS");return o.words.some(c=>c.choices!==void 0)&&o.features.push("CHOICES"),o.words.some(c=>c.hyphenStart)&&o.features.push("HYPHEN"),o.words.some(c=>c.confidence!==void 0)&&o.features.push("CONFIDENCE"),o}async function oc(e,t,r){const i=ir(t),[n,s,a,o]=i.bbox.map(h=>h*r.scaleFactor),c=Zn({x:n,y:s,width:a-n,height:o-s});"poly"in i&&(c.polygon=$r(i.poly,r.scaleFactor)),r.elementStack.slice(-1)[0].children.push(c),r.elementStack.push(c),await Fr(e,new Set(["paragraph","line"]),r)}async function cc(e,t,r){const i=ir(t);let n,s,a,o;if(i.bbox){const l=i.bbox.map(u=>u*r.scaleFactor);n=l[0],s=l[1],a=l[2]-n,o=l[3]-s}const c=tc({x:n,y:s,width:a,height:o});"poly"in i&&(c.polygon=$r(i.poly,r.scaleFactor)),r.elementStack.slice(-1)[0].children.push(c),r.elementStack.push(c),await Fr(e,new Set(["line"]),r)}async function lc(e,t,r){const i=ir(t);if(!("bbox"in i)){jr("Missing bbox attribute on line element","warn",t);return}const[n,s,a,o]=i.bbox.map(u=>u*r.scaleFactor),c=Kn({x:n,y:s,width:a-n,height:o-s});if("poly"in i&&(c.polygon=$r(i.poly,r.scaleFactor)),"baseline"in i){const u=i.baseline.split(" "),f=Number.parseFloat(u[0]),p=Number.parseInt(u[1],10),d=c.x,m=c.y;c.baseline=[{x:d,y:m+p},{x:d+c.width,y:m+p+c.width*f}]}if(r.elementStack.slice(-1)[0].children.push(c),r.elementStack.push(c),await Fr(e,new Set(["word","text"]),r),c.children.slice(-1)[0]===" "&&(c.children=c.children.slice(0,-1)),c.words.some(u=>u.confidence!==void 0&&u.confidence>1))for(const u of c.words)u.confidence!==void 0&&(u.confidence/=100)}async function hc(e,t,r){const i=ir(t),[n,s,a,o]=i.bbox.map(f=>f*r.scaleFactor);let c="",h,l=0;for(;l>=0;){const f=await e.next();if(f.done)throw new Error("Unexpected end of stream while parsing word");const[p,d]=f.value;if(p===N.OpenTag){l++;const m=d;m.name==="span"&&Ni(m)==="alternatives"&&(h=[])}else if(p===N.CloseTag){l--;const m=d;if(h&&m.name==="ins")c=m.textNodes.map(g=>g.value.trim()).join("");else if(h&&m.name==="del"){const g=Ue(m,"nlp"),y={text:m.textNodes.map(b=>b.value.trim()).join("")};y.text.includes("&")&&(y.text=xr(y.text)),g&&(y.probability=Math.exp(-Number.parseFloat(g))),h.push(y)}}else if(p===N.Text&&!h){const m=d.value;c+=m.trim()}}if(!c.length){jr("Word element has no text, skipping.","debug",t);return}const u={type:"word",x:n,y:s,width:a-n,height:o-s,text:c};h!=null&&h.length&&(u.choices=h),u.hyphenStart=u.text.endsWith(""),u.hyphenStart&&(u.text=u.text.slice(0,-1)),u.text.includes("&")&&(u.text=xr(u.text)),"poly"in i&&(u.polygon=$r(i.poly,r.scaleFactor)),"x_wconf"in i&&(u.confidence=Number.parseFloat(i.x_wconf)),r.elementStack.slice(-1)[0].children.push(u)}function uc(e,t){if(e[2]===t.width&&e[3]===t.height)return 1;const r=t.width/e[2],i=t.height/e[3],n=Math.round(i*e[2]),s=Math.round(r*e[3]);return(n!==t.width||s!==t.height)&&console.warn(`Differing scale factors for x and y axis while parsing hOCR, will use X factor: x=${r}, y=${i}`),r}function Ni(e){switch(Ue(e,"class")){case"ocr_page":return"page";case"ocr_carea":case"ocrx_block":return"block";case"ocr_par":return"paragraph";case"ocr_line":case"ocrx_line":return"line";case"ocrx_word":return"word";case"ocrx_cinfo":return"char";case"alternatives":return"alternatives";case"alt":return"alt";default:return null}}async function*fc(e,t){var r;if(Array.isArray(t)){const h=t;t=l=>{var u;return(u=h[l])!=null?u:null}}const i=typeof e=="string"||e instanceof Uint8Array?ns(e):e,n=await rs(i),s={scaleFactor:1,elementStack:[]};let a=0;const o=n.iterate();let c;for(;!(c=await o.next()).done;){const[h,l]=c.value;if(h!==N.OpenTag||l.name!=="div"||Ni(l)!=="page")continue;const u=await ac(o,l,s,(r=t==null?void 0:t(a,Mi(l)))!=null?r:void 0);u&&(yield u)}}var dc=["HEIGHT","WIDTH","HPOS","VPOS","WC"];function pc(e,t){return Object.fromEntries(e.attributes.filter(r=>!t||t.includes(r.name.value)).map(r=>[r.name.value,dc.includes(r.name.value)?Number.parseFloat(r.value.value):r.value.value]))}function Er(e){const t=pc(e,["HEIGHT","WIDTH","HPOS","VPOS"]);return{height:t.HEIGHT,width:t.WIDTH,x:t.HPOS,y:t.VPOS}}async function gc(e,t,r,i){var n;const s=Er(r);if(!s.width||!s.height)throw new Error("Could not get Page dimensions");const a=i?i.width/s.width:1,o=i?i.height/s.height:1;a!==o&&console.warn(`Scale factors differ: x=${a} vs y=${o}, using X scale factor.`),t.scaleFactor=a;const c=es({features:[],width:s.width*a,height:s.height*a});t.elementStack.push(c);const h=Mi(r);"PHYSICAL_IMG_NR"in h&&(c.physicalPageNumber=Number.parseInt(h.PHYSICAL_IMG_NR)),"PRINTED_IMG_NR"in h&&(c.logicalPageNumber=h.PRINTED_IMG_NR);let l=0,u;for(;l>=0&&!(u=await e.next()).done;){const[f,p]=u.value;if(f===N.CloseTag)l--;else if(f!==N.OpenTag)continue;l++,p.name==="TextBlock"&&await mc(e,t,p)}t.elementStack.pop();for(const f of["blocks","paragraphs","lines"])((n=c[f])!=null?n:[]).some(p=>p.polygon!==void 0)&&c.features.push("POLYGONS");return c.words.some(f=>f.choices!==void 0)&&c.features.push("CHOICES"),c.words.some(f=>f.hyphenStart)&&c.features.push("HYPHEN"),c.words.some(f=>f.confidence!==void 0)&&c.features.push("CONFIDENCE"),t.sourceImageInformation&&(c.imageSource=t.sourceImageInformation,t.sourceImageInformation=void 0),c}async function mc(e,t,r){const i=Er(r),n=Zn({x:i.x?i.x*t.scaleFactor:-1,y:i.y?i.y*t.scaleFactor:-1,width:i.width?i.width*t.scaleFactor:-1,height:i.height?i.height*t.scaleFactor:-1});t.elementStack.slice(-1)[0].children.push(n),t.elementStack.push(n);let s=0,a;for(;s>=0&&!(a=await e.next()).done;){const[o,c]=a.value;if(o===N.CloseTag)s--;else if(o!==N.OpenTag)continue;s++;const h=c;if(h.name==="TextLine")await vc(e,t,c);else if(h.name==="Shape"){const l=await Di(e,t);l!=null&&(n.polygon=l)}}t.elementStack.pop()}async function vc(e,t,r){const i=Er(r),n=Kn({x:i.x?i.x*t.scaleFactor:-1,y:i.y?i.y*t.scaleFactor:-1,width:i.width?i.width*t.scaleFactor:-1,height:i.height?i.height*t.scaleFactor:-1});t.elementStack.slice(-1)[0].children.push(n),t.elementStack.push(n);let s=0,a;for(;s>=0&&!(a=await e.next()).done;){const[o,c]=a.value;if(o===N.CloseTag&&s--,o!==N.OpenTag)continue;s++;const h=c;if(h.name==="String")await yc(e,t,c),s--;else if(h.name==="SP")n.children.push(" ");else if(h.name==="Shape"){const l=await Di(e,t);l!=null&&(n.polygon=l)}}t.elementStack.pop(),n.children.find(o=>o===" ")||(n.children=n.children.flatMap((o,c)=>c===n.children.length-1?[o]:[o," "]))}async function Di(e,t,r){let i=null,n=0,s;for(;n>=0&&!(s=await e.next()).done;){const[o,c]=s.value;if(o===N.CloseTag&&n--,o!==N.OpenTag)continue;n++;const h=c;if(h.name==="Polygon"){const l=Ue(h,"POINTS");if(!l){jr("<Polygon> without POINTS attribute, ignoring","warn",h);continue}i=l.split(" ").map(u=>u.split(/(,| )/).map(f=>Number.parseFloat(f))).reduce((u,[f])=>{const p=u.slice(-1)[0];return!p||p.length===2?u.push([f]):p.push(f),u},[]).map(([u,f])=>({x:u*t.scaleFactor,y:f*t.scaleFactor}))}}const a=t.elementStack.slice(-1)[0];if(a.x<0||a.y<0||a.width<0||a.height<0)if(i)a.x=Math.min(...i.map(o=>o.x)),a.y=Math.min(...i.map(o=>o.y)),a.width=Math.max(...i.map(o=>o.x))-a.x,a.height=Math.max(...i.map(o=>o.y))-a.y;else throw new Error(`Could not get dimensions for ${a.type}, no HPOS/VPOS/WIDTH/HEIGHT attribs and no associated Shape`);return i}async function yc(e,t,r){const i=Er(r);let n=Ue(r,"CONTENT");if(!n)throw new Error("Could not get String text");n.includes("&")&&(n=xr(n));const s={type:"word",x:i.x?i.x*t.scaleFactor:-1,y:i.y?i.y*t.scaleFactor:-1,width:i.width?i.width*t.scaleFactor:-1,height:i.height?i.height*t.scaleFactor:-1,text:n};t.elementStack.push(s),Ue(r,"SUBS_TYPE")==="HypPart1"&&(s.hyphenStart=!0);const o=Ue(r,"WC");o!==void 0&&(s.confidence=Number.parseFloat(o));let c=0,h;for(;c>=0&&!(h=await e.next()).done;){const[u,f]=h.value;if(u===N.CloseTag){if(c--,f.name==="ALTERNATIVE"){"choices"in s||(s.choices=[]);let p=f.textNodes.filter(d=>d.value.trim()!=="").map(d=>d.value.trim()).join("");p.includes("&")&&(p=xr(p)),s.choices.push({text:p})}}else if(u===N.OpenTag&&(c++,f.name==="Shape")){const p=await Di(e,t);c--,p!=null&&(s.polygon=p)}}t.elementStack.slice(-2)[0].children.push(s),t.elementStack.pop()}async function bc(e,t,r){let i=0,n;for(t.sourceImageInformation={};i>=0&&!(n=await e.next()).done;){const[s,a]=n.value,o=a;if(s===N.CloseTag){if(i--,o.name==="fileName")t.sourceImageInformation.fileName=o.textNodes.map(c=>c.value).join("");else if(o.name==="fileIdentifier"){let c=o.textNodes.map(l=>l.value).join("");const h=Ue(o,"fileIdentifierLocation");h&&(c=`${h}:${c}`),t.sourceImageInformation.fileIdentifier=c}else if(o.name==="documentIdentifier"){let c=o.textNodes.map(l=>l.value).join("");const h=Ue(o,"documentIdentifierLocation");h&&(c=`${h}:${c}`),t.sourceImageInformation.documentIdentifier=c}}else s===N.OpenTag&&i++}}async function*wc(e,t){var r;if(Array.isArray(t)){const h=t;t=l=>{var u;return(u=h[l])!=null?u:null}}const i=typeof e=="string"||e instanceof Uint8Array?ns(e):e,n=await rs(i),s={scaleFactor:1,elementStack:[]},a=n.iterate();let o,c=0;for(;!(o=await a.next()).done;){const[h,l]=o.value;if(h===N.CloseTag&&l.name==="MeasurementUnit"){const f=l.textNodes[0].value.trim();if(f!=="pixel"&&!t)throw new Error(`Measurement unit ${f} requires a reference size.`)}if(h!==N.OpenTag)continue;const u=l;if(u.name==="Page"){const f=await gc(a,s,l,(r=t==null?void 0:t(c,Mi(l)))!=null?r:void 0);f&&(yield f,c++)}else u.name==="sourceImageInformation"&&await bc(a,s)}}let yt=null;function nn(){return typeof window<"u"&&window.performance?window.performance.now():Date.now()}function bt(e){return e!=null&&e!==null&&e!==void 0}const xc=(()=>{const e=new Int32Array(256);for(let t=0;t<256;++t){let r=t,i=9;for(;--i;)r=(r&1&&-306674912)^r>>>1;e[t]=r}return e})();function ss(e){let t=-1;for(let r=0;r<e.length;++r)t=xc[t&255^e[r]]^t>>>8;return~t}function Li(){var e;return typeof process<"u"&&typeof((e=process.versions)==null?void 0:e.node)<"u"}function as(e){yt=e}function Cc(){return typeof crypto<"u"&&crypto.randomUUID?crypto.randomUUID():"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){return e!=="x"?e:((Math.random()*16|0)&3|8).toString(16)})}let Ee;Li()&&(Ee={pageGenerationDuration:new sr.Histogram({name:"pdiiif_page_generation_duration_seconds",help:"Latency for generating the PDF for a single page",buckets:[.001,.005,.015,.05,.1,.5,1,2],labelNames:["status"]}),imageFetchDuration:new sr.Histogram({name:"pdiiif_image_fetch_duration_seconds",help:"Latency for fetching data from IIIF Image API endpoints",buckets:[.01,.05,.15,.5,1,5,10],labelNames:["status","iiif_host","limited"]}),imageInfoDuration:new sr.Histogram({name:"pdiiif_image_info_duration_seconds",help:"Latency for fetching info from IIIF Image API endpoints",buckets:[.01,.05,.15,.5,1,5,10],labelNames:["status","iiif_host","limited"]}),ocrFetchDuration:new sr.Histogram({name:"pdiiif_ocr_fetch_duration_seconds",help:"Latency for fetching OCR data",buckets:[.01,.05,.15,.5,1,5,10],labelNames:["status","ocr_host","limited"]})});const Sc={};var sn=e=>{let t;const r=new Set,i=(l,u)=>{const f=typeof l=="function"?l(t):l;if(!Object.is(f,t)){const p=t;t=u??(typeof f!="object"||f===null)?f:Object.assign({},t,f),r.forEach(d=>d(t,p))}},n=()=>t,c={setState:i,getState:n,getInitialState:()=>h,subscribe:l=>(r.add(l),()=>r.delete(l)),destroy:()=>{(Sc?"production":void 0)!=="production"&&console.warn("[DEPRECATED] The `destroy` method will be unsupported in a future version. Instead use unsubscribe function returned by subscribe. Everything will be garbage-collected if store is garbage-collected."),r.clear()}},h=t=e(i,n,c);return c},os=e=>e?sn(e):sn,cs="http://library.stanford.edu/iiif/image-api/compliance.html#level0",ls="http://library.stanford.edu/iiif/image-api/compliance.html#level1",hs="http://library.stanford.edu/iiif/image-api/compliance.html#level2",us="http://library.stanford.edu/iiif/image-api/conformance.html#level0",fs="http://library.stanford.edu/iiif/image-api/conformance.html#level1",ds="http://library.stanford.edu/iiif/image-api/conformance.html#level2",ps="http://library.stanford.edu/iiif/image-api/1.1/compliance.html#level0",gs="http://library.stanford.edu/iiif/image-api/1.1/compliance.html#level1",ms="http://library.stanford.edu/iiif/image-api/1.1/compliance.html#level2",vs="http://library.stanford.edu/iiif/image-api/1.1/conformance.html#level0",ys="http://library.stanford.edu/iiif/image-api/1.1/conformance.html#level1",bs="http://library.stanford.edu/iiif/image-api/1.1/conformance.html#level2",ws="http://iiif.io/api/image/1/level0.json",xs="http://iiif.io/api/image/1/profiles/level0.json",Cs="http://iiif.io/api/image/1/level1.json",Ss="http://iiif.io/api/image/1/profiles/level1.json",As="http://iiif.io/api/image/1/level2.json",_s="http://iiif.io/api/image/1/profiles/level2.json",Os="http://iiif.io/api/image/2/level0.json",Is="http://iiif.io/api/image/2/profiles/level0.json",ks="http://iiif.io/api/image/2/level1.json",Ts="http://iiif.io/api/image/2/profiles/level1.json",Ps="http://iiif.io/api/image/2/level2.json",js="http://iiif.io/api/image/2/profiles/level2.json",$s="level0",Fs="level1",Es="level2",Rs="http://iiif.io/api/image/2/level0",Ms="http://iiif.io/api/image/2/level1",Ns="http://iiif.io/api/image/2/level2",Rr=[Ns,hs,ds,ms,bs,As,_s,Ps,js,Es],Wi=[...Rr,Ms,ls,fs,gs,ys,Cs,Ss,ks,Ts,Fs],Ds=[Rs,Ms,Ns,cs,ls,hs,us,fs,ds,ps,gs,ms,vs,ys,bs,ws,xs,Cs,Ss,As,_s,Os,Is,ks,Ts,Ps,js,$s,Fs,Es],Ac=Ds,Ls=[Rs,cs,us,ps,vs,ws,xs,Os,Is,$s],_c={extraFormats:["jpg"],extraQualities:["default"],extraFeatures:["sizeByWhListed"]},Oc={extraFormats:["jpg"],extraQualities:["default"],extraFeatures:["baseUriRedirect","cors","jsonldMediaType","regionByPx","regionSquare","sizeByWhListed","sizeByH","sizeByW","sizeByWh"]},Ic={extraFormats:["jpg","png"],extraQualities:["default"],extraFeatures:["baseUriRedirect","cors","jsonldMediaType","regionByPct","regionByPx","regionSquare","rotationBy90s","sizeByWhListed","sizeByConfinedWh","sizeByH","sizeByPct","sizeByW","sizeByWh"]};function Me(e){for(let t in e)(typeof e[t]>"u"||e[t]===null)&&delete e[t];return e}function ht(e){return Array.isArray(e)?e:e?[e]:[]}var kc=Object.defineProperty,Tc=(e,t,r)=>t in e?kc(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,Ye=(e,t,r)=>(Tc(e,typeof t!="symbol"?t+"":t,r),r),an=["sc:Collection","sc:Manifest","sc:Canvas","sc:AnnotationList","oa:Annotation","sc:Range","sc:Layer","sc:Sequence","oa:Choice","Service","ContentResource"];function Pc(e){if(typeof e>"u"||e===null)throw new Error("Null or undefined is not a valid entity.");if(Array.isArray(e))throw new Error("Array is not a valid entity");if(typeof e!="object")throw new Error(`${typeof e} is not a valid entity`);if(typeof e["@type"]=="string"){let t=an.indexOf(e["@type"]);if(t!==-1)return an[t]}if(e.profile)return"Service";if(e.format||e["@type"])return"ContentResource";throw new Error("Resource type is not known")}var jc=class Ws{constructor(t,r={}){Ye(this,"traversals"),Ye(this,"options"),this.traversals={collection:[],manifest:[],canvas:[],annotationList:[],sequence:[],annotation:[],contentResource:[],choice:[],range:[],service:[],layer:[],...t},this.options={convertPropsToArray:!0,mergeMemberProperties:!0,allowUndefinedReturn:!1,...r}}static all(t){return new Ws({collection:[t],manifest:[t],canvas:[t],annotationList:[t],sequence:[t],annotation:[t],contentResource:[t],choice:[t],range:[t],service:[t],layer:[t]})}traverseCollection(t){return this.traverseType(this.traverseDescriptive(this.traverseLinking(this.traverseCollectionItems(t))),this.traversals.collection)}traverseCollectionItems(t){if(this.options.mergeMemberProperties){let r=[...(t.manifests||[]).map(i=>typeof i=="string"?{"@id":i,"@type":"sc:Manifest"}:i),...(t.collections||[]).map(i=>typeof i=="string"?{"@id":i,"@type":"sc:Collection"}:i),...t.members||[]];delete t.collections,delete t.manifests,t.members=r}return t.manifests&&(t.manifests=t.manifests.map(r=>this.traverseManifest(typeof r=="string"?{"@id":r,"@type":"sc:Manifest"}:r))),t.collections&&(t.collections=t.collections.map(r=>this.traverseCollection(typeof r=="string"?{"@id":r,"@type":"sc:Collection"}:r))),t.members&&(t.members=t.members.map(r=>typeof r=="string"?r:this.traverseUnknown(r))),t}traverseManifest(t){return this.traverseType(this.traverseDescriptive(this.traverseLinking(this.traverseManifestItems(t))),this.traversals.manifest)}traverseManifestItems(t){return t.sequences&&(t.sequences=t.sequences.map(r=>this.traverseSequence(r))),t.structures&&(t.structures=t.structures.map(r=>this.traverseRange(r))),t}traverseSequence(t){return this.traverseType(this.traverseDescriptive(this.traverseLinking(this.traverseSequenceItems(t))),this.traversals.sequence)}traverseSequenceItems(t){return t.canvases&&(t.canvases=t.canvases.map(r=>this.traverseCanvas(r))),t}traverseCanvas(t){return this.traverseType(this.traverseDescriptive(this.traverseLinking(this.traverseCanvasItems(t))),this.traversals.canvas)}traverseCanvasItems(t){return t.images&&(t.images=t.images.map(r=>this.traverseAnnotation(r))),t.otherContent&&(t.otherContent=t.otherContent.map(r=>this.traverseAnnotationList(r))),t}traverseRange(t){return this.traverseType(this.traverseDescriptive(this.traverseLinking(this.traverseRangeItems(t))),this.traversals.range)}traverseRangeItems(t){if(this.options.mergeMemberProperties){let r=[...(t.ranges||[]).map(i=>typeof i=="string"?{"@id":i,"@type":"sc:Range"}:i),...(t.canvases||[]).map(i=>typeof i=="string"?{"@id":i,"@type":"sc:Canvas"}:i),...t.members||[]];delete t.ranges,delete t.canvases,t.members=r.length?r.map(i=>this.traverseUnknown(i)):void 0}return t}traverseAnnotationList(t){let r=typeof t=="string"?{"@id":t,"@type":"sc:AnnotationList"}:t;return this.traverseType(this.traverseDescriptive(this.traverseAnnotationListItems(r)),this.traversals.annotationList)}traverseAnnotationListItems(t){return t.resources&&(t.resources=t.resources.map(r=>this.traverseAnnotation(r))),t}traverseAnnotation(t){return this.traverseType(this.traverseDescriptive(this.traverseLinking(this.traverseAnnotationItems(t))),this.traversals.annotation)}traverseAnnotationItems(t){return t.resource&&(Array.isArray(t.resource)?t.resource=t.resource.map(r=>this.traverseContentResource(r)):t.resource=this.traverseContentResource(t.resource)),t.on,t}traverseLayer(t){return this.traverseType(this.traverseLinking(this.traverseLayerItems(t)),this.traversals.layer)}traverseLayerItems(t){return t.otherContent&&(t.otherContent=t.otherContent.map(r=>this.traverseAnnotationList(r))),t}traverseChoice(t){return this.traverseType(this.traverseChoiceItems(t),this.traversals.choice)}traverseChoiceItems(t){return t.default&&t.default!=="rdf:nil"&&(t.default=this.traverseContentResource(t.default)),t.item&&t.item!=="rdf:nil"&&(t.item=t.item.map(r=>this.traverseContentResource(r))),t}traverseService(t){return this.traverseType(this.traverseLinking(t),this.traversals.service)}traverseContentResource(t){return t["@type"]==="oa:Choice"?this.traverseChoice(t):this.traverseType(this.traverseDescriptive(this.traverseLinking(t)),this.traversals.contentResource)}traverseUnknown(t){if(!t["@type"]||typeof t=="string")return t;switch(Pc(t)){case"sc:Collection":return this.traverseCollection(t);case"sc:Manifest":return this.traverseManifest(t);case"sc:Canvas":return this.traverseCanvas(t);case"sc:Sequence":return this.traverseSequence(t);case"sc:Range":return this.traverseRange(t);case"oa:Annotation":return this.traverseAnnotation(t);case"sc:AnnotationList":return this.traverseAnnotationList(t);case"sc:Layer":return this.traverseLayer(t);case"Service":return this.traverseService(t);case"oa:Choice":return this.traverseChoice(t);case"ContentResource":return this.traverseContentResource(t)}return t.profile?this.traverseService(t):t}traverseImageResource(t){let r=Array.isArray(t),i=Array.isArray(t)?t:[t],n=[];for(let s of i)typeof s=="string"?n.push(this.traverseContentResource({"@id":s,"@type":"dctypes:Image"})):n.push(this.traverseContentResource(s));return!r&&!this.options.convertPropsToArray?n[0]:n}traverseDescriptive(t){return t.thumbnail&&(t.thumbnail=this.traverseImageResource(t.thumbnail)),t.logo&&(t.logo=this.traverseImageResource(t.logo)),t}traverseOneOrMoreServices(t){let r=Array.isArray(t),i=Array.isArray(t)?t:[t],n=[];for(let s of i)n.push(this.traverseService(s));return!r&&!this.options.convertPropsToArray?n[0]:n}traverseLinking(t){return t.related&&(t.related=this.traverseOneOrManyType(t.related,this.traversals.contentResource)),t.rendering&&(t.rendering=this.traverseOneOrManyType(t.rendering,this.traversals.contentResource)),t.service&&(t.service=this.traverseOneOrMoreServices(t.service)),t.seeAlso&&(t.seeAlso=this.traverseOneOrManyType(t.seeAlso,this.traversals.contentResource)),t.within&&(typeof t.within=="string"||(t.within=this.traverseOneOrManyType(t.within,this.traversals.contentResource))),t.startCanvas&&(typeof t.startCanvas=="string"?t.startCanvas=this.traverseType({"@id":t.startCanvas,"@type":"sc:Canvas"},this.traversals.canvas):t.startCanvas&&this.traverseType(t.startCanvas,this.traversals.canvas)),t.contentLayer&&(typeof t.contentLayer=="string"?t.contentLayer=this.traverseLayer({"@id":t.contentLayer,"@type":"sc:Layer"}):t.contentLayer=this.traverseLayer(t.contentLayer)),t}traverseOneOrManyType(t,r){if(!Array.isArray(t))if(this.options.convertPropsToArray)t=[t];else return this.traverseType(t,r);return t.map(i=>this.traverseType(i,r))}traverseType(t,r){return r.reduce((i,n)=>{let s=n(i);return typeof s>"u"&&!this.options.allowUndefinedReturn?i:s},t)}},$c="http://library.stanford.edu/iiif/image-api/compliance.html#level1",Fc="http://library.stanford.edu/iiif/image-api/compliance.html#level2",Ec="http://library.stanford.edu/iiif/image-api/conformance.html#level1",Rc="http://library.stanford.edu/iiif/image-api/conformance.html#level2",Mc="http://library.stanford.edu/iiif/image-api/1.1/compliance.html#level1",Nc="http://library.stanford.edu/iiif/image-api/1.1/compliance.html#level2",Dc="http://library.stanford.edu/iiif/image-api/1.1/conformance.html#level1",Lc="http://library.stanford.edu/iiif/image-api/1.1/conformance.html#level2",Wc="http://iiif.io/api/image/1/level1.json",Uc="http://iiif.io/api/image/1/profiles/level1.json",zc="http://iiif.io/api/image/1/level2.json",Bc="http://iiif.io/api/image/1/profiles/level2.json",qc="http://iiif.io/api/image/2/level1.json",Hc="http://iiif.io/api/image/2/profiles/level1.json",Qc="http://iiif.io/api/image/2/level2.json",Gc="http://iiif.io/api/image/2/profiles/level2.json",Yc="level1",Vc="level2",Jc="http://iiif.io/api/image/2/level1",Xc="http://iiif.io/api/image/2/level2",Kc=[Jc,Xc,$c,Fc,Ec,Rc,Mc,Nc,Dc,Lc,Wc,Uc,zc,Bc,qc,Hc,Qc,Gc,Yc,Vc],li={attributionLabel:"Attribution",providerId:"http://example.org/provider",providerName:"Unknown"};function Zc(e){if(typeof e=="string")return[e];if(!e)return[];let t=Array.isArray(e)?e:[e],r=[];for(let i of t){if(typeof i=="string"){r.push(i);continue}r.push({"@language":i["@language"]||i.language,"@value":i["@value"]||i.value})}return r}function vt(e,t="none"){if(!e)return{none:[""]};let r=Zc(e),i={};for(let n of r){if(typeof n=="string"){i[t]=i[t]?i[t]:[],i[t].push(n||"");continue}if(!n["@language"]){i[t]=i[t]?i[t]:[],i[t].push(n["@value"]||"");continue}let s=n["@language"];i[s]=i[s]?i[s]:[],i[s].push(n["@value"]||"")}return Object.keys(i).length===0?{none:[""]}:i}function Us(e){if(Array.isArray(e))return Us(e.find(t=>typeof t=="string"));if(Rr.indexOf(e)!==-1)return"level2";if(Kc.indexOf(e)!==-1)return"level1";if(Ac.indexOf(e)!==-1)return"level0";if(typeof e=="string")return e}function el(e){let t=Array.isArray(e)?e:[e];for(let r of t)switch(r){case"http://iiif.io/api/image/2/context.json":case"http://library.stanford.edu/iiif/image-api/1.1/compliance.html#level2":return"ImageService2";case"http://iiif.io/api/image/1/context.json":case"http://library.stanford.edu/iiif/image-api/1.1/context.json":return"ImageService1";case"http://iiif.io/api/annex/openannotation/context.json":return"ImageApiSelector"}}function tl(e){switch(e){case"http://iiif.io/api/image/2/level0.json":case"http://iiif.io/api/image/2/level1.json":case"http://iiif.io/api/image/2/level2.json":return"ImageService2";case"http://iiif.io/api/auth/1/kiosk":case"http://iiif.io/api/auth/1/login":case"http://iiif.io/api/auth/1/clickthrough":case"http://iiif.io/api/auth/1/external":case"http://iiif.io/api/auth/0/kiosk":case"http://iiif.io/api/auth/0/login":case"http://iiif.io/api/auth/0/clickthrough":case"http://iiif.io/api/auth/0/external":return"AuthCookieService1";case"http://iiif.io/api/auth/1/token":case"http://iiif.io/api/auth/0/token":return"AuthTokenService1";case"http://iiif.io/api/auth/1/logout":case"http://iiif.io/api/auth/0/logout":return"AuthLogoutService1";case"http://iiif.io/api/search/1/search":case"http://iiif.io/api/search/0/search":return"SearchService1";case"http://iiif.io/api/search/1/autocomplete":case"http://iiif.io/api/search/0/autocomplete":return"AutoCompleteService1"}}function on(e){for(let t of["sc","oa","dcterms","dctypes","iiif"])if(e.startsWith(`${t}:`))return e.slice(t.length+1);return e}var rl=["Collection","Manifest","Annotation","AnnotationPage","Range","Service"];function Ui(e){let t=e["@id"]||e.id,r=e["@type"]||e.type,i=e.profile||void 0,n=e["@context"]||void 0;if(i){let s=tl(i);if(s)return s}if(n){let s=el(n);if(s)return s}if(r){if(Array.isArray(r)){if(r.indexOf("oa:CssStylesheet")!==-1)return"CssStylesheet";if(r.indexOf("cnt:ContentAsText")!==-1)return"TextualBody";r=r[0]}for(let s of["sc","oa","dcterms","dctypes","iiif"])if(r.startsWith(`${s}:`)){r=r.slice(s.length+1);break}switch(r){case"Layer":return"AnnotationCollection";case"AnnotationList":return"AnnotationPage";case"cnt:ContentAsText":return"TextualBody"}}if(r&&rl.indexOf(r)!==-1)return r;if(e.format){if(e.format.startsWith("image/"))return"Image";if(e.format.startsWith("text/")||e.format==="application/pdf")return"Text";if(e.format.startsWith("application/"))return"Dataset"}return t&&(t.endsWith(".jpg")||t.endsWith(".png")||t.endsWith(".jpeg"))?"Image":r||"unknown"}var il=/http(s)?:\/\/(creativecommons.org|rightsstatements.org)[^"'\\<\n]+/gm;function nl(e){let t=e.match(il);return t?t[0]:e}function sl(e,t="Rights/License",r="none"){let i=null,n=[],s=Array.isArray(e)?e:[e];for(let a of s){let o=a?nl(a):void 0;if(o&&(o.indexOf("creativecommons.org")!==-1||o.indexOf("rightsstatements.org")!==-1)){o.startsWith("https://")?i=`http://${o.slice(8)}`:i=o;continue}o&&n.push({label:{[r]:[t]},value:{[r]:[o]}})}return[i,n]}var al=["http://iiif.io/api/presentation/2/context.json","http://iiif.io/api/image/2/context.json","http://iiif.io/api/image/1/context.json","http://library.stanford.edu/iiif/image-api/1.1/context.json","http://iiif.io/api/search/1/context.json","http://iiif.io/api/search/0/context.json","http://iiif.io/api/auth/1/context.json","http://iiif.io/api/auth/0/context.json","http://iiif.io/api/annex/openannotation/context.json"];function ol(e){if(e){let t=Array.isArray(e)?e:[e],r=[];for(let i of t)i==="http://iiif.io/api/presentation/2/context.json"&&r.push("http://iiif.io/api/presentation/3/context.json"),al.indexOf(i)===-1&&r.push(i);if(t.length)return r.length===1?r[0]:r}}function cl(e){return e?e.map(t=>({label:vt(t.label),value:vt(t.value)})):[]}var cn=0;function zs(e,t){let r=encodeURI(e.id||e["@id"]||"").trim();return r&&t?`${r}/${t}`:r||(cn++,`http://example.org/${e["@type"]}${t?`/${t}`:""}/${cn}`)}function Be(e){let t=[...e.behavior||[]];e.viewingHint&&t.push(e.viewingHint);let r;return Array.isArray(e.motivation)?r=e.motivation.map(on):e.motivation&&(r=on(e.motivation)),{"@context":e["@context"]?ol(e["@context"]):void 0,id:(e["@id"]||zs(e)).trim(),type:Ui(e),behavior:t.length?t:void 0,height:e.height?e.height:void 0,width:e.width?e.width:void 0,motivation:r,viewingDirection:e.viewingDirection,profile:e.profile,format:e.format?e.format:void 0,duration:void 0,timeMode:void 0}}function qe(e){let[t,r]=sl(e.license),i=[...e.metadata?cl(e.metadata):[],...r];return{rights:t,metadata:i.length?i:void 0,label:e.label?vt(e.label):void 0,requiredStatement:e.attribution?{label:vt(li.attributionLabel),value:vt(e.attribution)}:void 0,navDate:e.navDate,summary:e.description?vt(e.description):void 0,thumbnail:ll(e.thumbnail)}}function ll(e){return e&&(Array.isArray(e)?e:[e]).map(t=>typeof t=="string"?{id:t,type:"Image"}:(t.type==="unknown"&&(t.type="Image"),t))}function hl(e){if(!e.within)return;let t=Array.isArray(e.within)?e.within:[e.within],r=[];for(let i of t)if(typeof i=="string"){if(i)switch(e["@type"]){case"sc:Manifest":r.push({id:i,type:"Collection"});break}}else i["@id"]&&r.push({id:i["@id"],type:Ui(i)});return r.length?r:void 0}function nt(e){let t=e.related?Array.isArray(e.related)?e.related:[e.related]:[],r=e.contentLayer;return{provider:e.logo||t.length?[{id:li.providerId,type:"Agent",homepage:t.length?[t[0]]:void 0,logo:e.logo?Array.isArray(e.logo)?e.logo:[e.logo]:void 0,label:vt(li.providerName)}]:void 0,partOf:hl(e),rendering:e.rendering,seeAlso:e.seeAlso,start:e.startCanvas,service:e.service?ht(e.service):void 0,supplementary:r?[r]:void 0}}function ul(e){return{chars:e.chars,format:e.format?e.format:void 0,language:e.language}}function fl(e){return Me({...Be(e),...qe(e),...nt(e),items:e.members})}function dl(e){let t=[],r=[],i,n;for(let a of e.sequences||[])console.log(a),a.canvases.length&&t.push(...a.canvases),a.behavior&&r.push(...a.behavior),a.viewingDirection&&(n=a.viewingDirection),a.startCanvas&&(i=a.startCanvas);let s=Be(e);return r.length&&(s.behavior?s.behavior.push(...r):s.behavior=r),Me({...s,...qe(e),...nt(e),viewingDirection:n,start:i,items:t,structures:pl(e.structures)})}function pl(e){if(!e)return e;let t=new Map;for(let i of e)t.set(i.id,i);let r=[];for(let i of e)if(i.items){let n=i.items.map(s=>typeof s=="string"?(r.push(s),t.get(s)||s):s&&s.id?(r.push(s.id),t.get(s.id)||s):s);i.items=n}return e.filter(i=>r.indexOf(i.id)===-1)}function gl(e){return Me({...Be(e),...qe(e),...nt(e),annotations:e.otherContent&&e.otherContent.length?e.otherContent:void 0,items:e.images&&e.images.length?[{id:zs(e,"annotation-page"),type:"AnnotationPage",items:e.images}]:void 0})}function ml(e){return Me({...Be(e),...qe(e),...nt(e),items:e.resources&&e.resources.length?e.resources:void 0})}function vl(e){return!e.canvases||e.canvases.length===0?{canvases:[],behavior:[]}:{canvases:e.canvases,behavior:e.viewingHint?[e.viewingHint]:[],viewingDirection:e.viewingDirection,startCanvas:e.startCanvas}}function yl(e){function t(r){if(Array.isArray(r)){if(r.length>1)return{type:"List",items:r.map(t)};r=r[0]}if(typeof r=="string")return encodeURI(r).trim();if("@type"in r){let i;if(typeof r.full=="string")i=r.full;else if(r.full["@type"]==="dctypes:Image")i={id:r.full["@id"],type:"Image"};else if(r.full["@type"]==="sc:Canvas")i={id:r.full["@id"],type:"Canvas"};else throw new Error(`Unsupported source type on annotation: ${r.full["@type"]}`);return{type:"SpecificResource",source:i,selector:hi(r.selector)}}else return encodeURI(r["@id"]).trim()}return Me({...Be(e),...qe(e),...nt(e),target:t(e.on),body:Array.isArray(e.resource)?e.resource.map(ln):ln(e.resource)})}function ln(e){return e.type==="Choice"?e:Bs(e)}function Bs(e){let t=e;return Me({...Be(t),...qe(t),...nt(t),...ul(t)})}function bl(e){let t=[];return e.default&&e.default!=="rdf:nil"&&t.push(e.default),e.item&&e.item!=="rdf:nil"&&t.push(...e.item),Me({...Be(e),...qe(e),items:t})}function wl(e){return Me({...Be(e),...qe(e),...nt(e),items:e.members})}function xl(e){let{"@id":t,"@type":r,"@context":i,profile:n,...s}=e,a={};return t&&(a["@id"]=t),a["@type"]=Ui(e),a["@type"]==="unknown"&&(i&&i.length&&(a["@context"]=i),a["@type"]="Service"),n&&(a.profile=Us(n)),Me({...a,...s})}function Cl(e){return Me({...Be(e),...qe(e),...nt(e)})}var Sl=new jc({collection:[fl],manifest:[dl],canvas:[gl],annotationList:[ml],sequence:[vl],annotation:[yl],contentResource:[Bs],choice:[bl],range:[wl],service:[xl],layer:[Cl]});function qs(e){return e&&e["@context"]&&(e["@context"]==="http://iiif.io/api/presentation/2/context.json"||e["@context"].indexOf("http://iiif.io/api/presentation/2/context.json")!==-1||e["@context"]==="http://www.shared-canvas.org/ns/context.json")||e["@context"]==="http://iiif.io/api/image/2/context.json"?Sl.traverseUnknown(e):e}function hi(e){if((Array.isArray(e["@type"])&&e["@type"].includes("oa:SvgSelector")||e["@type"]=="oa:SvgSelector")&&("chars"in e||"value"in e))return{type:"SvgSelector",value:"chars"in e?e.chars:e.value};if(e["@type"]==="oa:FragmentSelector")return{type:"FragmentSelector",value:e.value};if(e["@type"]==="oa:Choice")return[hi(e.default),...(Array.isArray(e.item)?e.item:[e.item]).map(hi)];if(e["@type"]=="iiif:ImageApiSelector")return{type:"ImageApiSelector",region:"region"in e?e.region:void 0,rotation:"rotation"in e?e.rotation:void 0};throw new Error(`Unsupported selector type: ${e["@type"]}`)}var Al=qs,ar={},zi={get(e){return e},setMetaValue([e,t,r],i){const n=zi.getResourceMeta(e,t),s=n?n[r]:void 0,a=typeof i=="function"?i(s):i;ar[e]={...ar[e]||{},[t]:{...(ar[e]||{})[t]||{},[r]:a}}},getResourceMeta:(e,t)=>{const r=ar[e];if(r)return t?r[t]:r},async load(e){const t=typeof e=="string"?e:e.id;return fetch(t).then(r=>r.json())},requestStatus(e){}};function _l(e){return e.type==="SpecificResource"?[e.source,{selector:e.selector}]:[e,{selector:null}]}function Ol(e=zi){function t(n){const s=n?typeof n=="string"?e.get(n):n:null;if(!s)return[];const a=e.get(s.items,{parent:s}),o=[];for(const c of a)o.push(...e.get(c.items,{parent:c}));return o}function r(n,s=[]){const a=Array.isArray(n)?n:t(n),o=[];let c={items:[],type:"complex-choice"};const h=[];for(const l of a){if(l.type!=="Annotation")throw new Error("getPaintables() accept either a canvas or list of annotations");const u=Array.from(Array.isArray(l.body)?l.body:[l.body]);for(const f of u){const[p,{selector:d}]=_l(f),m=e.get(p),g=(m.type||"unknown").toLowerCase();if(g==="choice"){const y=e.get(m.items,{parent:m.id}),b=s.length?s.map(w=>y.find(F=>F.id===w)).filter(Boolean):[y[0]];b.length===0&&b.push(y[0]),c.items.push({type:"single-choice",items:y.map(w=>({id:w.id,label:w.label,selected:b.indexOf(w)!==-1})),label:p.label}),u.push(...b);continue}o.indexOf(g)===-1&&o.push(g),h.push({type:g,annotationId:l.id,annotation:l,resource:m,target:l.target,selector:d})}}return{types:o,items:h,choice:c.items.length<2?c.items[0]||null:c,allChoices:c.items.length?c:null}}function i(n){const{choice:s}=r(n);return s}return{getAllPaintingAnnotations:t,getPaintables:r,extractChoices:i}}function Ze(e){return typeof e=="string"?!1:e&&!e.type&&"source"in e?(e.type="SpecificResource",!0):!!e&&e.type==="SpecificResource"}function or(...e){return t=>e.reduce((r,i)=>i(r),t)}var hn=["Collection","Manifest","Canvas","AnnotationPage","AnnotationCollection","Annotation","ContentResource","Range","Service","Selector","Agent"];function Il(e,t){if(typeof e>"u"||e===null)throw new Error("Null or undefined is not a valid entity.");if(Array.isArray(e))throw new Error("Array is not a valid entity");if(typeof e!="object"){if(t)return t;throw new Error(`${typeof e} is not a valid entity`)}if(typeof e.type=="string"){let r=hn.indexOf(e.type);if(r!==-1)return hn[r]}if(e.profile)return"Service";throw new Error("Resource type is not known")}var kl=class Hs{constructor(t,r={}){Ye(this,"traversals"),Ye(this,"options"),Ye(this,"_traverseManifest",or(this.traverseManifestItems.bind(this),this.traverseLinking.bind(this),this.traverseDescriptive.bind(this),this.traverseLinkedCanvases.bind(this),this.traverseManifestStructures.bind(this),this.traverseInlineAnnotationPages.bind(this))),Ye(this,"_traverseCanvas",or(this.traverseCanvasItems.bind(this),this.traverseLinking.bind(this),this.traverseDescriptive.bind(this),this.traverseLinkedCanvases.bind(this),this.traverseInlineAnnotationPages.bind(this))),Ye(this,"_traverseAnnotationPage",or(this.traverseAnnotationPageItems.bind(this),this.traverseLinking.bind(this),this.traverseDescriptive.bind(this))),Ye(this,"_traverseRange",or(this.traverseRangeRanges.bind(this),this.traverseLinking.bind(this),this.traverseDescriptive.bind(this),this.traverseLinkedCanvases.bind(this))),this.traversals={collection:[],manifest:[],canvas:[],annotationCollection:[],annotationPage:[],annotation:[],contentResource:[],choice:[],range:[],service:[],agent:[],specificResource:[],geoJson:[],...t},this.options={allowUndefinedReturn:!1,...r}}static all(t){return new Hs({collection:[t],manifest:[t],canvas:[t],annotationCollection:[t],annotationPage:[t],annotation:[t],contentResource:[t],choice:[t],range:[t],service:[t],geoJson:[t],specificResource:[t],agent:[t]})}traverseDescriptive(t){return t.thumbnail&&(t.thumbnail=ht(t.thumbnail).map(r=>this.traverseType(r,{parent:t},this.traversals.contentResource))),t.provider&&(t.provider=t.provider.map(r=>this.traverseAgent(r,t))),t}traverseLinking(t){return t.seeAlso&&(t.seeAlso=t.seeAlso.map(r=>this.traverseType(r,{parent:t},this.traversals.contentResource))),t.service&&(t.service=ht(t.service).map(r=>this.traverseService(r))),t.services&&(t.services=ht(t.services).map(r=>this.traverseService(r,t))),t.logo&&(t.logo=t.logo.map(r=>this.traverseType(r,{parent:t},this.traversals.contentResource))),t.homepage&&(t.homepage=ht(t.homepage).map(r=>this.traverseType(r,{parent:t},this.traversals.contentResource))),t.partOf&&(t.partOf=t.partOf.map(r=>typeof r=="string"||!r.type?this.traverseType(r,{parent:t},this.traversals.contentResource):r.type==="Canvas"?this.traverseType(r,{parent:t},this.traversals.canvas):r.type==="AnnotationCollection"?this.traverseType(r,{parent:t},this.traversals.annotationCollection):r.type==="Collection"?this.traverseType(r,{parent:t},this.traversals.collection):this.traverseType(r,{parent:t},this.traversals.contentResource))),t.start&&(Ze(t.start)?t.start=this.traverseSpecificResource(t.start,"Canvas",t):t.start=this.traverseType(t.start,{parent:t},this.traversals.canvas)),t.rendering&&(t.rendering=t.rendering.map(r=>this.traverseType(r,{parent:t},this.traversals.contentResource))),t.supplementary&&(t.supplementary=t.supplementary.map(r=>this.traverseType(r,{parent:t},this.traversals.contentResource))),t}traverseCollectionItems(t){return t.items&&t.items.map(r=>r.type==="Collection"?this.traverseCollection(r):this.traverseManifest(r)),t}traverseCollection(t,r){return this.traverseType(this.traverseDescriptive(this.traverseInlineAnnotationPages(this.traverseLinking(this.traverseLinkedCanvases(this.traverseCollectionItems(t))))),{parent:r},this.traversals.collection)}traverseGeoJson(t,r){return this.traverseType(t,{parent:r},this.traversals.geoJson)}traverseNavPlace(t){return t.navPlace&&(t.navPlace=this.traverseGeoJson(t.navPlace,t)),t}traverseManifestItems(t){return t.items&&(t.items=t.items.map(r=>this.traverseCanvas(r))),t}traverseManifestStructures(t){return t.structures&&(t.structures=t.structures.map(r=>this.traverseRange(r))),t}traverseManifest(t,r){return this.traverseType(this._traverseManifest(t),{parent:r},this.traversals.manifest)}traverseCanvasItems(t){return t.items=(t.items||[]).map(r=>this.traverseAnnotationPage(r,t)),t}traverseInlineAnnotationPages(t){return typeof t=="string"||!t||t.annotations&&(t.annotations=t.annotations.map(r=>this.traverseAnnotationPage(r,t))),t}traverseCanvas(t,r){return this.traverseType(this._traverseCanvas(t),{parent:r},this.traversals.canvas)}traverseAnnotationPageItems(t){return t.items&&(t.items=t.items.map(r=>this.traverseAnnotation(r,t))),t}traverseAnnotationPage(t,r){return this.traverseType(this._traverseAnnotationPage(t),{parent:r},this.traversals.annotationPage)}traverseAnnotationBody(t){return Array.isArray(t.body)?t.body=t.body.map(r=>this.traverseContentResource(r,t)):t.body&&(t.body=this.traverseContentResource(t.body,t)),t}traverseLinkedCanvases(t){return t.placeholderCanvas&&(t.placeholderCanvas=this.traverseCanvas(t.placeholderCanvas)),t.accompanyingCanvas&&(t.accompanyingCanvas=this.traverseCanvas(t.accompanyingCanvas)),t}traverseAnnotation(t,r){return this.traverseType(this.traverseLinking(this.traverseAnnotationBody(this.traverseDescriptive(t))),{parent:r},this.traversals.annotation)}traverseContentResourceLinking(t){return typeof t=="string"||!t||t&&t.service&&(t.service=ht(t.service||[]).map(r=>this.traverseService(r,t))),t}traverseContentResource(t,r){return t.type==="Choice"&&(t.items=t.items.map(i=>this.traverseContentResource(i,t))),Ze(t)?this.traverseSpecificResource(t,"ContentResource"):this.traverseType(this.traverseInlineAnnotationPages(this.traverseContentResourceLinking(t)),{parent:r},this.traversals.contentResource)}traverseSpecificResource(t,r,i){let n=t.source;return typeof t.source=="string"&&(n={id:t.source,type:r||"unknown"}),this.traverseType({...t,source:r==="Canvas"||n.type==="Canvas"?this.traverseType(n,{parent:i},this.traversals.canvas):r==="ContentResource"?this.traverseContentResource(n,{parent:i}):this.traverseUnknown(n,{parent:i,typeHint:r})},{parent:i},this.traversals.specificResource)}traverseRangeRanges(t){return t.items&&(t.items=t.items.map(r=>typeof r=="string"?this.traverseCanvas({id:r,type:"Canvas"},t):Ze(r)?this.traverseSpecificResource(r,"Canvas",t):r.type==="Manifest"?this.traverseManifest(r,t):this.traverseRange(r,t))),t}traverseRange(t,r){return this.traverseType(this._traverseRange(t),{parent:r},this.traversals.range)}traverseAgent(t,r){return this.traverseType(this.traverseDescriptive(this.traverseLinking(t)),{parent:r},this.traversals.agent)}traverseType(t,r,i){return i.reduce((n,s)=>{let a=s(n,r);return typeof a>"u"&&!this.options.allowUndefinedReturn?n:a},t)}traverseService(t,r){let i=Object.assign({},t);return i&&i.service&&(i.service=ht(i.service).map(n=>this.traverseService(n))),this.traverseType(i,{parent:r},this.traversals.service)}traverseUnknown(t,{parent:r,typeHint:i}={}){let n=Il(t,i);switch(n){case"Collection":return this.traverseCollection(t,r);case"Manifest":return this.traverseManifest(t,r);case"Canvas":return this.traverseCanvas(t,r);case"AnnotationPage":return this.traverseAnnotationPage(t,r);case"Annotation":return this.traverseAnnotation(t,r);case"ContentResource":return this.traverseContentResource(t,r);case"Range":return this.traverseRange(t,r);case"Service":return this.traverseService(t,r);case"Agent":return this.traverseAgent(t,r);default:throw new Error(`Unknown or unsupported resource type of ${n}`)}}};function Qs(e,t){let r="unknown";if(!e)return;if(typeof e=="string")return{id:e,type:r};if(Ze(e))return Qs(e.source);let i=e.type||e["@type"],n=e.id||e["@id"];if(i&&i.indexOf(":")!==-1&&(i=i.split(":").pop()),n&&i)return{id:n,type:i}}var Ut={},oe="iiif-parser:hasPart",ze="iiif-parser:partOf",zt="iiif-parser:isExternal",Te="__$UNSET$__",Gs="__$UNWRAP$__",T=[];Object.freeze(T);Object.freeze(Ut);function Tl(e){if(e===Ut||Object.keys(e).length===0)return!0;for(let t in e)return!1;return!0}function Bi(e,t){if(t&&t["@explicit"]){let r={},i=Object.keys(t);for(let n of i)n===ze||n==="@explicit"||(Tl(t[n])?r[n]=e[n]:r[n]=t[n]);return r}return e}function Ys(e,t,r){let i=Qs(t);if(!i)return[void 0,void 0];let n=e.requests[i.id],s=i.type||e.mapping[i.id];if(!s||n&&n.resourceUri&&(!e.entities[s]||!e.entities[s][n.resourceUri]))return[void 0,void 0];let a=e.entities[s][n?n.resourceUri:i.id];if(i.type&&!a)return Ys(e,{id:i.id},r);if(a&&a[oe]){let o=a[oe].find(c=>r?c[ze]===r.id:c[ze]===a.id);return[Bi(a,o),a]}return[a,a]}var Pl={id:"https://iiif-parser/annotation-page",type:"AnnotationPage",behavior:T,label:null,thumbnail:T,summary:null,requiredStatement:null,metadata:T,rights:null,provider:T,items:T,seeAlso:T,homepage:T,rendering:T,service:T},jl={id:"https://iiif-parser/empty-canvas",type:"Canvas",label:null,behavior:T,thumbnail:T,accompanyingCanvas:null,placeholderCanvas:null,summary:null,requiredStatement:null,metadata:T,rights:null,navDate:null,provider:T,items:T,annotations:T,seeAlso:T,homepage:T,partOf:T,rendering:T,service:T,duration:0,height:0,width:0},$l={id:"https://iiif-parser/empty-collection",type:"Collection",label:null,viewingDirection:"left-to-right",behavior:T,thumbnail:T,accompanyingCanvas:null,placeholderCanvas:null,summary:null,requiredStatement:null,metadata:T,rights:null,navDate:null,provider:T,items:T,annotations:T,seeAlso:T,homepage:T,partOf:T,rendering:T,service:T,services:T},Fl={id:"https://iiif-parser/empty-manifest",type:"Manifest",annotations:T,behavior:T,homepage:T,items:T,label:null,metadata:T,navDate:null,provider:T,partOf:T,accompanyingCanvas:null,placeholderCanvas:null,rendering:T,requiredStatement:null,rights:null,seeAlso:T,service:T,services:T,start:null,structures:T,summary:null,thumbnail:T,viewingDirection:"left-to-right"},El={id:"https://iiif-parser/empty-canvas",type:"Range",label:null,behavior:T,thumbnail:T,accompanyingCanvas:null,placeholderCanvas:null,summary:null,requiredStatement:null,metadata:T,rights:null,navDate:null,provider:T,items:T,annotations:T,seeAlso:T,homepage:T,partOf:T,rendering:T,service:T,start:null,supplementary:null,viewingDirection:"left-to-right"},Rl={id:"https://iiif-parser/empty-agent",type:"Agent",label:{},logo:T,seeAlso:T,homepage:T},Ml={id:"https://iiif-parser/empty-service",type:"UnknownService"};function ui(e,t={}){if(Array.isArray(e))return ui(e[0]);if(typeof e=="string"){let[r,i]=e.split("#");return i?{type:"SpecificResource",source:{id:r,type:t.typeHint||"Unknown"},selector:{type:"FragmentSelector",value:i}}:{type:"SpecificResource",source:{id:r,type:t.typeMap&&t.typeMap[r]||t.typeHint||"Unknown"}}}if(e.type==="Choice"||e.type==="List"||e.type==="Composite"||e.type==="Independents")return ui(e.items[0]);if(!e.type&&"source"in e&&(e.type="SpecificResource"),e.type==="SpecificResource")return e.source.type==="Canvas"&&e.source.partOf&&typeof e.source.partOf=="string"&&(e.source.partOf=[{id:e.source.partOf,type:"Manifest"}]),e.selector?{type:"SpecificResource",source:e.source,selector:e.selector}:{type:"SpecificResource",source:e.source};if(e.id){e.type==="Canvas"&&e.partOf&&typeof e.partOf=="string"&&(e.partOf=[{id:e.partOf,type:"Manifest"}]);let[r,i]=e.id.split("#");return i?{type:"SpecificResource",source:{...e,id:r},selector:{type:"FragmentSelector",value:i}}:{type:"SpecificResource",source:{...e,id:r}}}return{type:"SpecificResource",source:e}}function Nl(){return{Collection:{},Manifest:{},Canvas:{},AnnotationPage:{},AnnotationCollection:{},Annotation:{},ContentResource:{},Range:{},Service:{},Selector:{},Agent:{}}}function Vs(e,t){if(typeof e=="string")return{id:e,type:t};if(!e.id)throw new Error(`Invalid resource does not have an ID (${JSON.stringify(e)}, ${t})`);return e}function Dl(e,t){return(r,i)=>{let n=e[r]?e[r]:{};return(s,a)=>{let o=Vs(s,i||r);return o&&o.id&&r?(n[o.id]=n[o.id]?di(n[o.id],o,{parent:a.parent,isTopLevel:t.id===o.id}):di({id:o.id,type:o.type},o,{parent:a.parent,isTopLevel:t.id===o.id}),{id:o.id,type:r==="ContentResource"?r:o.type}):o}}}function fi(e,t,r){if(!t)return e;if(Array.isArray(e)){if(!Array.isArray(t))throw new Error("Cannot merge array with non-array");let i=[...e];for(let n of t)if(n["@id"]&&!n.id&&(n.id=n["@id"]),n["@type"]&&!n.type&&(n.type=n["@type"]),n!=null)if(Array.isArray(n))i.push(n);else if(typeof n=="object"&&n.id&&n.type){let s=i.findIndex(a=>a.id===n.id&&a.type===n.type);s>=0&&(i[s]=fi(i[s],n))}else e.indexOf(n)===-1&&i.push(n);return i}else if(typeof e=="object"){if(Array.isArray(t)||typeof t!="object")throw new Error("Cannot merge object with non-object");let i={...e},n=[],s=[],a=Object.keys(e).filter(h=>h!==oe&&h!=="id"&&h!=="type"),o={},c={};for(let[h,l]of Object.entries(t)){if(h===oe||h==="id"||h==="type")continue;let u=i[h];u===l?s.push(h):u===T||!u?(n.push(h),i[h]=l):(u&&l&&(o[h]=u,c[h]=l),i[h]=fi(u,l),i[h]===o[h]&&(s.push(h),delete o[h]))}if(r&&(r.parent&&r.parent.id||r.isTopLevel)){let h=[],l={};if(r.parent?l[ze]=r.parent.id:r.isTopLevel&&(l[ze]=e.id),i[oe]&&i[oe].length){let u=!(i[oe]||[]).find(p=>p["@explicit"]),f=n.length>0||s.length!==a.length;if(u&&f)for(let p of i[oe]){let d={...p},m=Object.keys(o);if(d){d["@explicit"]=!0;for(let g of a)g!==oe&&(d[g]=Ut);for(let g of m)d[g]=o[g]}h.push(d)}else h.push(...i[oe]);if(f){let p=Object.keys(c);l["@explicit"]=!0;for(let d of n)l[d]=Ut;for(let d of s)l[d]=Ut;for(let d of p)l[d]=c[d]}}l.id=i.id,l.type=i.type,h.push(l),i[oe]=h}return i}else if(e)return e;return t}function di(e,t,r){if(typeof e=="string")return e;if(t.id!==e.id||t.type!==e.type){if(t.type==="ImageService3")return t;if(e.type==="ImageService3")return e;throw new Error(`Can only merge entities with identical identifiers and type! ${t.type}(${t.id}) => ${e.type}(${e.id})`)}return fi({...e},t,r)}function Ll(e){return(t,r)=>i=>{let{id:n,type:s}=Vs(i,r||t);if(typeof n>"u")throw new Error("Found invalid entity without an ID.");return t==="ContentResource"||t==="Service"?e[n]=t:e[n]=s,i}}function Wl(e){let t=Object.assign({},e);if(t["@id"]&&(t.id=t["@id"]),t["@type"]&&(t.type=t["@type"]),t.service){let r=[];t.service=Array.isArray(t.service)?t.service:[t.service];for(let i of t.service)r.push({id:i["@id"]||i.id,type:i["@type"]||i.type});t.service=r}return Object.assign({},Ml,t)}function Ul(e){return t=>{e.Service=e.Service?e.Service:{};let r=t.id||t["@id"],i=Wl(t);return i&&i.id&&(e.Service[i.id]?e.Service[r]=di(e.Service[r],i):e.Service[r]=i),t}}function zl(e){let t=JSON.stringify(e),r=5381,i=t.length;for(;i;)r=r*33^t.charCodeAt(--i);let n=(r>>>0).toString(16);return n.length%2?"0"+n:n}function zr(e){return t=>typeof t=="string"?{id:t,type:e}:t.id?t.type?t:{type:e,...t}:{id:`vault://${zl(t)}`,type:e,...t}}function wt(e){return t=>({...e,...t})}function Ft(e){return Array.isArray(e)?e:[e]}function Bl(e){return e.body&&(e.body=Ft(e.body)),e.seeAlso&&(e.seeAlso=Ft(e.seeAlso)),e.audience&&(e.audience=Ft(e.audience)),e.accessibility&&(e.accessibility=Ft(e.accessibility)),e.motivation&&(e.motivation=Ft(e.motivation)),e}function Js(e,{typeHint:t,partOfTypeHint:r}={}){if(typeof e=="string"&&(e={id:e,type:t||"unknown"}),Ze(e))return typeof e.source=="string"&&(e.source={id:e.source,type:t||"unknown"}),e.source.type==="Canvas"&&e.source.partOf&&typeof e.source.partOf=="string"&&(e.source.partOf=[{id:e.source.partOf,type:r||"Manifest"}]),e;let i;if((e.id||"").indexOf("#")!==-1){let[n,s]=(e.id||"").split("#");e.id=n,s&&(i={type:"FragmentSelector",value:s})}return{type:"SpecificResource",source:e,selector:i}}function ql(e){let t=Object.assign({},e);return e&&e.items&&(t.items=e.items.map(r=>typeof r=="string"||r.type==="Canvas"?Js(r):r)),t}function Hl(e){let t=Object.assign({},e);return t.start?(t.start=Js(t.start,{typeHint:"Canvas"}),t):e}function Ql(e){let t=Object.assign({},e);return t.target?(t.target=ui(t.target,{typeHint:"Canvas"}),t):e}function Gl(e){return e}function Br(e){return typeof e.items>"u"&&(e[zt]=!0),e}function Yl(e){let t=qs(e),r=Nl(),i={},n=Dl(r,t),s=Ll(i),a=new kl({collection:[Br,wt($l),s("Collection"),n("Collection")],manifest:[Br,wt(Fl),Hl,s("Manifest"),n("Manifest")],canvas:[wt(jl),s("Canvas"),n("Canvas")],annotationPage:[Br,zr("AnnotationPage"),wt(Pl),s("AnnotationPage"),n("AnnotationPage")],annotation:[zr("Annotation"),Bl,Ql,s("Annotation"),n("Annotation")],contentResource:[zr("ContentResource"),s("ContentResource"),n("ContentResource")],range:[wt(El),ql,s("Range","Canvas"),n("Range","Canvas")],agent:[wt(Rl),s("Agent"),n("Agent")],specificResource:[Gl],service:[Ul(r)]}).traverseUnknown(t);return{entities:r,resource:a,mapping:i}}function Vl(e){let t={};for(let[r,i]of e){if(r===Gs&&i!==Te)return i;i!==Te&&typeof i<"u"&&i!==null&&(t[r]=i)}return t}function Jl(e,t,r){if(!t.type||!t.id)throw new Error("Unknown entity");if(!r[t.type])throw new Error(`Serializer not found for ${t.type}`);function i(n,s,a=0){let o=r[n.type];if(!o)return Te;if(a>20)throw new Error("Circular reference: "+n.id+" "+n.type);let[c,h]=Ys(e,n.type?n:n.id,s)||(n.id&&n.type?n:null);if(!c)return Te;let l=o(c,e,{parent:s,isTopLevel:t.id===n.id,fullResource:h}),u=l.next();for(;!u.done;){let f=u.value,p=Te;if(f)if(Array.isArray(f)){let d=[];for(let m of f)d.push(i(m,n,a+1));p=d}else p=i(f,n,a+1);u=l.next(p)}return u.value===Te?Te:Vl(u.value)}return i(t)}function Bt(e,{allowSourceString:t=!0,allowString:r=!1,allowedStringType:i}={}){let n=s=>{if(t&&s&&s.source&&typeof s.source!="string"){let a=Object.keys(s.source);if(s.source.id&&s.source.type&&a.length===2)return{...s,source:s.source.id}}return s};if(e){if(e.source&&e.source.partOf)return n(e);let s=Object.keys(e);if(s.length===2&&e.type&&e.source||s.length===3&&e.type&&e.source&&s.indexOf("selector")!==-1&&!e.selector)return r&&(!i||i===e.source.type)?e.source.id:e.source.type==="ContentResource"?{type:"SpecificResource",source:e.source.id}:e.source;if(e.selector&&!Array.isArray(e.selector)&&typeof e.selector!="string"&&e.selector.type==="FragmentSelector"){let a=`${e.source.id}#${e.selector.value}`;return r?a:{id:a,type:e.source.type}}}return n(e)}function At(e){if(!e)return;let t=Object.keys(e);if(t.length!==0){if(t.length===1){let r=t[0];if(!r)return"";let i=(e[r]||[]).join("");return r==="@none"||r==="none"||r==="en"?i:{"@language":r,"@value":i}}return t.map(r=>({"@language":r,"@value":(e[r]||[]).join("")}))}}function Xs(e){return Array.isArray(e)?e.map(t=>Xs(t)):typeof e=="string"?e:e.type&&e.type==="Canvas"?e.id:e}function et(e,t=!1){if(e)return e.length>1&&!t?e:e[0]||void 0}function Xl(e){if(e){if(typeof e=="string")return{"@id":e};if("@id"in e){let t={...e};return delete t["@type"],t}return{"@context":"http://iiif.io/api/image/2/context.json","@id":e.id,profile:`http://iiif.io/api/image/2/profiles/${e.profile}.json`}}}function at(e,t){return[["@id",e.id],["@type",t],["format",e.format],["height",e.height],["width",e.width],["viewingDirection",e.viewingDirection!=="left-to-right"?e.viewingDirection:void 0],["license",e.license?e.license:void 0]]}function*ot(e){let t=e.provider?yield e.provider[0]:void 0;return[["label",At(e.label)],["metadata",e.metadata&&e.metadata.length?e.metadata.map(r=>({label:At(r.label)||"",value:At(r.value)||""})):void 0],["description",At(e.summary)],["thumbnail",et(yield e.thumbnail)],["navDate",e.navDate],["logo",t?et(t.logo):void 0],["homepage",t?t.homepage:void 0],["attribution",e.requiredStatement?At(e.requiredStatement.value):void 0]]}function*Et(e){let t=e.start&&e.start.type&&e.start.type==="SpecificResource"?Bt(e.start):e.start;return[["seeAlso",et(yield e.seeAlso)],["service",et((e.service||[]).map(Xl))],["rendering",et(yield e.rendering)],["startCanvas",t?t.id:void 0]]}function Kl(e){return e.type==="SpecificResource"}function Zl(e){return e&&e.type==="FragmentSelector"}function eh(e){if(e&&Kl(e)){let t=e.id,r=e.selector?Array.isArray(e.selector)?e.selector[0]:e.selector:void 0;return Zl(r)&&(t+="#"+r.value),t}return e==null?void 0:e.id}var th={Manifest:function*(e,t,{isTopLevel:r}){return[...r?[["@context","http://iiif.io/api/presentation/2/context.json"]]:[],...at(e,"sc:Manifest"),...yield*ot(e),...yield*Et(e),["sequences",[{"@id":`${e.id}/sequence0`,"@type":"sc:Sequence",canvases:yield e.items}]],["structures",yield e.structures]]},Canvas:function*(e){let t=(yield e.items)[0];return[...at(e,"sc:Canvas"),...yield*ot(e),...yield*Et(e),["images",t?[t.resources]:void 0],["annotations",e.annotations&&e.annotations.length?et(yield e.annotations):void 0]]},AnnotationPage:function*(e){return[...at(e,"sc:AnnotationList"),...yield*ot(e),["resources",e.items&&e.items.length?et(yield e.items):void 0]]},Annotation:function*(e){return[["@id",e.id],["@type","oa:Annotation"],["motivation","sc:painting"],["on",Xs(e.target)],["resource",et(yield e.body,!0)]]},ContentResource:function*(e){switch(e.type){case"Image":return[...at(e,"dctypes:Image"),...yield*ot(e),...yield*Et(e)];case"Text":case"Dataset":default:return[...at(e,void 0),...yield*ot(e)]}},AnnotationCollection:function*(e){return[["@id",e.id],["@type","sc:Layer"],["label",At(e.label)]]},Collection:function*(e){return[...at(e,"sc:Collection"),...yield*ot(e),...yield*Et(e),["members",yield*e.items]]},Range:function*(e){let t=[],r=[];if(e.items)for(let i of e.items){let n=i.type==="SpecificResource"?i.source:i;if(n){let s=yield n;t.push({"@id":eh(i),"@type":n.type,label:s?s.label:void 0,within:e.id}),n.type==="Canvas"&&r.push(n.id)}}return[...at(e,"sc:Range"),...yield*ot(e),...yield*Et(e),["canvases",r.length===t.length?r:void 0],["members",r.length!==t.length?t:void 0]]}};function ct(e){var t;return[["id",(t=e.id)!=null&&t.startsWith("vault://")?void 0:e.id],["type",e.type],["format",e.format],["profile",e.profile],["height",e.height||void 0],["width",e.width||void 0],["duration",e.duration||void 0],["viewingDirection",e.viewingDirection!=="left-to-right"?e.viewingDirection:void 0],["behavior",e.behavior&&e.behavior.length?e.behavior:void 0],["timeMode",e.timeMode],["motivation",Array.isArray(e.motivation)?e.motivation[0]:e.motivation],[oe,Te]]}function ne(e){if(e===Te||!e||e.length===0)return;let t=e.filter(r=>r!==Te);if(t.length!==0)return t}function Ks(e){if(e&&e.type&&e.type==="ImageService2"){let{id:t,type:r,profile:i,...n}=e,s=typeof i=="string"?i:Array.isArray(i)?i.find(a=>typeof a=="string"):"";return{"@id":t,"@type":r,profile:s?s.startsWith("http")?s:`http://iiif.io/api/image/2/${s}.json`:"http://iiif.io/api/image/2/level0.json",...n}}return e}function un(e){if(Array.isArray(e)||(e=e?[e]:[]),!(!e||e.length===0))return e.map(Ks)}function*He(e){return[["label",e.label],["metadata",ne(e.metadata)],["summary",e.summary],["requiredStatement",e.requiredStatement],["rights",Array.isArray(e.rights)?e.rights[0]||void 0:e.rights||void 0],["navDate",e.navDate],["language",e.language],["thumbnail",ne(yield e.thumbnail)],["placeholderCanvas",yield e.placeholderCanvas],["accompanyingCanvas",yield e.accompanyingCanvas],["provider",ne(yield e.provider)]]}function*Qe(e,t){let r=[];for(let i of e.partOf||[])i.type==="Manifest"&&t.type==="Manifest"||r.push(yield i);return[["seeAlso",ne(yield e.seeAlso)],["service",ne(un(e.service))],["services",ne(un(e.services))],["rendering",ne(yield e.rendering)],["supplementary",ne(yield e.supplementary)],["homepage",ne(yield e.homepage)],["logo",ne(yield e.logo)],["partOf",ne(r)],["start",e.start?Bt(e.start):e.start]]}var rh={Manifest:function*(e,t,{isTopLevel:r}){return r?[["@context",e["@context"]?e["@context"]:"http://iiif.io/api/presentation/3/context.json"],...ct(e),...yield*He(e),...yield*Qe(e),["items",yield e.items],["structures",ne(yield e.structures)],["annotations",ne(yield e.annotations)],["navPlace",e.navPlace]]:[...ct(e),...yield*He(e)]},Canvas:function*(e,t,{parent:r}){return r&&r.type!=="Manifest"&&r.type!=="Canvas"?[["id",e.id]]:[...ct(e),...yield*He(e),...yield*Qe(e,r),["items",yield e.items],["annotations",ne(yield e.annotations)],["navPlace",e.navPlace]]},Agent:function*(e){return[["id",e.id],["type","Agent"],["label",e.label],...yield*Qe(e)]},AnnotationPage:function*(e){var i;let t=Object.entries(e).map(([n,s])=>[n,Array.isArray(s)?ne(s):s]).filter(([n,s])=>n!=="items"&&n!=="id"&&n!==oe&&n!==ze&&n!==zt),r=yield e.items;return[["id",(i=e.id)!=null&&i.startsWith("vault://")?void 0:e.id],...t,...yield*Qe(e),["items",r.length||e[zt]===!1?r:Te]]},Service:function*(e){return[[Gs,Ks(e)]]},Annotation:function*(e){let t=Object.entries(e).map(([i,n])=>i==="motivation"?[i,Array.isArray(n)?n[0]:n]:i==="target"?[i,Bt(n,{allowString:!0,allowSourceString:!0,allowedStringType:"Canvas"})]:[i,Array.isArray(n)?ne(n):n]).filter(([i])=>i!=="body"&&i!==oe&&i!==zt),r;if(Array.isArray(e.body)){let i=[];for(let n of e.body)if(n&&Ze(n)){let s={...n};n.source.type!=="Canvas"?s.source=yield n.source:s.source=n.source,i.push(Bt(s,{allowSourceString:!0}))}else i.push(yield n);r=i}else e.body&&Ze(e.body)?(r={...e.body},r.source=yield e.body.source):r=yield e.body;return[...t,...yield*He(e),...yield*Qe(e),["body",r.length===1?r[0]:r]]},ContentResource:function*(e){return ih([...ct(e),...yield*He(e),...yield*Qe(e),["annotations",ne(yield e.annotations)],["items",ne(yield e.items)]],e)},AnnotationCollection:function*(e){return[["id",e.id],["type","AnnotationCollection"],["label",e.label]]},Collection:function*(e,t,{isTopLevel:r}){return r?[["@context","http://iiif.io/api/presentation/3/context.json"],...ct(e),...yield*He(e),...yield*Qe(e),["items",ne(yield e.items)],["navPlace",e.navPlace]]:[...ct(e),...yield*He(e)]},Range:function*(e){let t=[];for(let r of e.items)r.type==="Range"?t.push(yield r):r&&r.type==="SpecificResource"?t.push(Bt(r)):t.push(r);return[...ct(e),...yield*He(e),...yield*Qe(e),["items",t],["annotations",ne(yield e.annotations)],["navPlace",e.navPlace]]}};function ih(e,t){let r=Object.keys(t),i=e.map(([n])=>n);for(let n of r)n===oe||n===zt||i.indexOf(n)===-1&&typeof t[n]<"u"&&e.push([n,t[n]]);return e}var se=function(t){return function(){const r={type:t,getType:()=>t,toString:()=>t};return(i,n)=>({...r,...i!==void 0&&{payload:i},...n!==void 0&&{meta:n}})}},Zs="@iiif/IMPORT_ENTITIES",ea="@iiif/MODIFY_ENTITY_FIELD",ta="@iiif/REORDER_ENTITY_FIELD",ra="@iiif/ADD_REFERENCE",pi="@iiif/UPDATE_REFERENCE",ia="@iiif/REMOVE_REFERENCE",na="@iiif/ADD_METADATA",sa="@iiif/REMOVE_METADATA",gi="@iiif/UPDATE_METADATA",aa="@iiif/REORDER_METADATA",oa=se(Zs)(),nh=se(ea)(),sh=se(ta)(),ah=se(ra)(),oh=se(ia)(),ch=se(pi)(),lh=se(na)(),hh=se(gi)(),uh=se(sa)(),fh=se(aa)(),dh={importEntities:oa,modifyEntityField:nh,reorderEntityField:sh,addReference:ah,removeReference:oh,updateReference:ch,addMetadata:lh,removeMetadata:uh,updateMetadata:hh,reorderMetadata:fh},ca="@iiif/ADD_MAPPING",la="@iiif/ADD_MAPPINGS",ph=se(ca)(),gh=se(la)(),mi="RESOURCE_ERROR",ha="RESOURCE_LOADING",vi="RESOURCE_READY",ua="@iiif/REQUEST_RESOURCE",fa="@iiif/REQUEST_ERROR",da="@iiif/REQUEST_MISMATCH",pa="@iiif/REQUEST_COMPLETE",mh="@iiif/REQUEST_OFFLINE_RESOURCE",vh=se(ua)(),yi=se(fa)(),yh=se(da)(),bh=se(pa)(),qi="@iiif/BATCH",wh="@iiif/BATCH_IMPORT",bi=se(qi)(),xh=(e,t)=>{const{entities:r,resource:i,mapping:n}=Yl(t);if(i.id===void 0)return[yi({id:e,message:"ID is not defined in resource."})];const s=[oa({entities:r}),gh({mapping:n})];return i.id!==e&&(s.push(ph({id:e,type:i.type})),s.push(yh({requestId:e,actualId:i.id}))),s.push(bh({id:e})),s},fn=Number.isNaN||function(t){return typeof t=="number"&&t!==t};function Ch(e,t){return!!(e===t||fn(e)&&fn(t))}function dn(e,t){if(!Array.isArray(e)||!Array.isArray(t))return e===t;if(e.length!==t.length)return!1;for(let r=0;r<e.length;r++)if(!Ch(e[r],t[r]))return!1;return!0}function qr(e,t,r){const i=e.iiif.requests[t],n=e.iiif.mapping[t];if(!n||!e.iiif.entities[n][i.resourceUri])return;const s=e.iiif.entities[n][i.resourceUri];if(s&&s[oe]){const a=s[oe].find(o=>o[ze]===s.id);return Bi(s,a)}return s}function Sh(e){return e&&typeof e.then=="function"}function pn(e,t,{waitTimeout:r=30}={}){return(i,n)=>{const s=e.getStore(),a=s.getState(),o=a.iiif.requests[i];if(o){if(o.loadingState===vi){const h=qr(a,i);if(h)return h}switch(o.loadingState){case mi:break;case ha:return(async()=>{let h,l=!1;try{const u=await Promise.race([new Promise((f,p)=>{l||(h=s.subscribe(()=>{const d=s.getState();if(d.iiif.requests[i].loadingState===mi){p();return}if(d.iiif.requests[i].loadingState===vi){const m=qr(d,i);m?f(m):p()}}))}),new Promise((f,p)=>setTimeout(()=>{l=!0,p()},r*60*1e3))]);if(h&&h(),u)return u}catch{h&&h()}})()}}e.dispatch(vh({id:i}));const c=h=>{if(!h)return;!h.id&&!h["@id"]&&(h["@type"]&&(h["@id"]=i),h.id=i);const l=xh(i,h);return e.dispatch(bi({actions:l})),qr(s.getState(),i)};try{const h=t(i,n);return Sh(h)?(async()=>{try{return c(await h)}catch(l){throw e.dispatch(yi({id:i,message:l.toString()})),l}})():c(h)}catch(h){throw e.dispatch(yi({id:i,message:h.toString()})),h}}}var ga="@iiif/SET_META_VALUE",ma="@iiif/SET_META_VALUE_DYNAMIC",va="@iiif/UNSET_META_VALUE",Ah=se(ga)(),_h=se(ma)(),Oh=se(va)(),gn={setMetaValue:Ah,setMetaValueDynamic:_h,unsetMetaValue:Oh};function ya(){return{Collection:{},Manifest:{},Canvas:{},AnnotationPage:{},AnnotationCollection:{},Annotation:{},ContentResource:{},Range:{},Service:{},Selector:{},Agent:{}}}const Hr={BASE_URL:"./",DEV:!1,MODE:"production",PROD:!0,SSR:!1};var Ih=(e,t)=>(r,i,n)=>(n.dispatch=s=>(r(a=>e(a,s),!1,s),s),n.dispatchFromDevtools=!0,{dispatch:(...s)=>n.dispatch(...s),...t}),kh=Ih,wi=new Map,cr=e=>{const t=wi.get(e);return t?Object.fromEntries(Object.entries(t.stores).map(([r,i])=>[r,i.getState()])):{}},Th=(e,t,r)=>{if(e===void 0)return{type:"untracked",connection:t.connect(r)};const i=wi.get(r.name);if(i)return{type:"tracked",store:e,...i};const n={connection:t.connect(r),stores:{}};return wi.set(r.name,n),{type:"tracked",store:e,...n}},Ph=(e,t={})=>(r,i,n)=>{const{enabled:s,anonymousActionType:a,store:o,...c}=t;let h;try{h=(s??(Hr?"production":void 0)!=="production")&&window.__REDUX_DEVTOOLS_EXTENSION__}catch{}if(!h)return(Hr?"production":void 0)!=="production"&&s&&console.warn("[zustand devtools middleware] Please install/enable Redux devtools extension"),e(r,i,n);const{connection:l,...u}=Th(o,h,c);let f=!0;n.setState=(m,g,y)=>{const b=r(m,g);if(!f)return b;const w=y===void 0?{type:a||"anonymous"}:typeof y=="string"?{type:y}:y;return o===void 0?(l==null||l.send(w,i()),b):(l==null||l.send({...w,type:`${o}/${w.type}`},{...cr(c.name),[o]:n.getState()}),b)};const p=(...m)=>{const g=f;f=!1,r(...m),f=g},d=e(n.setState,i,n);if(u.type==="untracked"?l==null||l.init(d):(u.stores[u.store]=n,l==null||l.init(Object.fromEntries(Object.entries(u.stores).map(([m,g])=>[m,m===u.store?d:g.getState()])))),n.dispatchFromDevtools&&typeof n.dispatch=="function"){let m=!1;const g=n.dispatch;n.dispatch=(...y)=>{(Hr?"production":void 0)!=="production"&&y[0].type==="__setState"&&!m&&(console.warn('[zustand devtools middleware] "__setState" action type is reserved to set state from the devtools. Avoid using it.'),m=!0),g(...y)}}return l.subscribe(m=>{var g;switch(m.type){case"ACTION":if(typeof m.payload!="string"){console.error("[zustand devtools middleware] Unsupported action format");return}return Qr(m.payload,y=>{if(y.type==="__setState"){if(o===void 0){p(y.state);return}Object.keys(y.state).length!==1&&console.error(`
+                    [zustand devtools middleware] Unsupported __setState action format. 
+                    When using 'store' option in devtools(), the 'state' should have only one key, which is a value of 'store' that was passed in devtools(),
+                    and value of this only key should be a state object. Example: { "type": "__setState", "state": { "abc123Store": { "foo": "bar" } } }
+                    `);const b=y.state[o];if(b==null)return;JSON.stringify(n.getState())!==JSON.stringify(b)&&p(b);return}n.dispatchFromDevtools&&typeof n.dispatch=="function"&&n.dispatch(y)});case"DISPATCH":switch(m.payload.type){case"RESET":return p(d),o===void 0?l==null?void 0:l.init(n.getState()):l==null?void 0:l.init(cr(c.name));case"COMMIT":if(o===void 0){l==null||l.init(n.getState());return}return l==null?void 0:l.init(cr(c.name));case"ROLLBACK":return Qr(m.state,y=>{if(o===void 0){p(y),l==null||l.init(n.getState());return}p(y[o]),l==null||l.init(cr(c.name))});case"JUMP_TO_STATE":case"JUMP_TO_ACTION":return Qr(m.state,y=>{if(o===void 0){p(y);return}JSON.stringify(n.getState())!==JSON.stringify(y[o])&&p(y[o])});case"IMPORT_STATE":{const{nextLiftedState:y}=m.payload,b=(g=y.computedStates.slice(-1)[0])==null?void 0:g.state;if(!b)return;p(o===void 0?b:b[o]),l==null||l.send(null,y);return}case"PAUSE_RECORDING":return f=!f}return}}),d},jh=Ph,Qr=(e,t)=>{let r;try{r=JSON.parse(e)}catch(i){console.error("[zustand devtools middleware] Could not parse the received json",i)}r!==void 0&&t(r)},$h=e=>(t,r,i)=>{const n=i.subscribe;return i.subscribe=(a,o,c)=>{let h=a;if(o){const l=(c==null?void 0:c.equalityFn)||Object.is;let u=a(i.getState());h=f=>{const p=a(f);if(!l(u,p)){const d=u;o(u=p,d)}},c!=null&&c.fireImmediately&&o(u,u)}return n(h)},e(t,r,i)},Fh=$h,Eh=(e={},t)=>{switch(t.type){case ca:return{...e,[t.payload.id]:t.payload.type};case la:return{...e,...t.payload.mapping};default:return e}};function Gr(e,t,r,i){return!(!e[r]||!e[r][t]||!e[r][t][i]||!Array.isArray(e[r][t][i]))}function Rh(e,t){const r={},i=[];for(const[n,s]of Object.entries(e||{})){i.push(n);const a=(t||{})[n];if(!a||a.length===0){r[n]=s;continue}r[n]=a}for(const[n,s]of Object.entries(t||{}))i.indexOf(n)===-1&&(r[n]=s);return r}function j(e){return e.payload}function Yr(e,t){return typeof e>"u"?t:e}var Mh=(e=ya(),t)=>{var i;const r=(n,s)=>({...e,[j(t).type]:{...e[j(t).type],[j(t).id]:{...n,...s}}});switch(t.type){case ea:{if(!e[j(t).type]||!e[j(t).type][j(t).id])return e;const n=e[j(t).type][j(t).id];return typeof n=="string"?e:r(n,{[j(t).key]:j(t).value})}case ta:{if(!Gr(e,j(t).id,j(t).type,j(t).key))return e;const n=e[j(t).type][j(t).id];if(typeof n=="string")return e;const s=Array.from(n[j(t).key]),[a]=s.splice(j(t).startIndex,1);return s.splice(j(t).endIndex,0,a),r(n,{[j(t).key]:s})}case Zs:{const n=Object.keys(j(t).entities),s={...e};for(const a of n){const o=j(t).entities[a],c={...e[a]||{}};let h=!1;const l=Object.keys(o||{})||[];if(o&&l){for(const u of l)h=!0,c[u]=e[a][u]?Rh(e[a][u],o[u]):o[u];h&&(s[a]=c)}}return s}case ra:{if(!Gr(e,j(t).id,j(t).type,j(t).key))return e;const n=e[j(t).type][j(t).id],s=Array.from(n[j(t).key]);return s.splice(Yr(j(t).index,s.length+1),0,j(t).reference),r(n,{[j(t).key]:s})}case pi:case ia:{if(!Gr(e,j(t).id,j(t).type,j(t).key))return e;const n=e[j(t).type][j(t).id],s=Array.from(n[j(t).key]),a=Yr(j(t).index,s.findIndex(o=>o&&o.id===j(t).reference.id));return a===-1||((i=s[a])==null?void 0:i.id)!==j(t).reference.id?e:(t.type===pi?s.splice(a,1,j(t).reference):s.splice(a,1),r(n,{[j(t).key]:s}))}case na:{const n=e[j(t).type][j(t).id];if(!n)return e;const s=Array.from(n.metadata||[]),a=j(t);return s.splice(Yr(t.payload.beforeIndex,s.length+1),0,{label:a.label,value:a.label}),r(n,{metadata:s})}case aa:{const n=e[j(t).type][j(t).id];if(typeof n=="string"||!n)return e;const s=Array.from(n.metadata||[]),[a]=s.splice(j(t).startIndex,1);return s.splice(j(t).endIndex,0,a),r(n,{metadata:s})}case gi:case sa:{const n=e[j(t).type][j(t).id],s=Array.from(n.metadata||[]),a=j(t).atIndex;return typeof a>"u"||a===-1||!s[a]?e:(t.type===gi?s.splice(a,1,{label:j(t).label,value:j(t).value}):s.splice(a,1),r(n,{metadata:s}))}default:return e}},Nh=(e={},t)=>{switch(t.type){case ua:case mh:return{...e,[t.payload.id]:{requestUri:t.payload.id,loadingState:ha,uriMismatch:!1,resourceUri:t.payload.id}};case da:return{...e,[t.payload.requestId]:{...e[t.payload.requestId]||{},uriMismatch:!0,resourceUri:t.payload.actualId},[t.payload.actualId]:{requestUri:t.payload.requestId,loadingState:e[t.payload.requestId].loadingState,uriMismatch:!0,resourceUri:t.payload.actualId}};case fa:return{...e,[t.payload.id]:{...e[t.payload.id]||{},loadingState:mi,error:t.payload.message}};case pa:return{...e,[t.payload.id]:{...e[t.payload.id]||{},loadingState:vi,error:void 0}}}return e},Dh=(e={},t)=>{const{id:r,updateValue:i,value:n,meta:s,key:a}=t&&t.payload||{};switch(t.type){case ga:return{...e,[r]:{...e[r]||{},[s]:{...e[r]?e[r][s]||{}:{},[a]:n}}};case ma:return{...e,[r]:{...e[r]||{},[s]:{...e[r]?e[r][s]||{}:{},[a]:e[r]&&e[r][s]?i(e[r][s][a]):i(void 0)}}};case va:return e[r]&&e[r][s]&&e[r][s][a]?{...e,[r]:{...e[r]||{},[s]:{...e[r]?e[r][s]||{}:{},[a]:void 0}}}:e;default:return e}};function ba(e={}){const t=Object.keys(e);return function(i={},n){let s=!1;const a={};for(let o=0;o<t.length;o++){const c=t[o];a[c]=e[c](i[c],n),s=s||a[c]!==i[c]}return s?a:i}}function Lh(e){return(t,r)=>r&&r.type===qi?r.payload.actions.reduce(e,t):r&&r.type===wh?{...t,iiif:{...t.iiif,...r.payload.state}}:e(t,r)}var Wh=ba({mapping:Eh,entities:Mh,requests:Nh,meta:Dh});function Uh(){return{iiif:{entities:ya(),meta:{},mapping:{},requests:{}}}}function zh(e={}){const{enableDevtools:t=!1,iiifStoreName:r="iiif",defaultState:i=Uh(),customReducers:n={}}=e,s=Lh(ba({[r]:Wh,...n})),o=!!(typeof window<"u"&&window.__REDUX_DEVTOOLS_EXTENSION__)?jh:(c,h)=>c;return os(Fh(o(kh(s,i),{enabled:t})))}function wa(e){return{all:e=e||new Map,on:function(t,r){var i=e.get(t);i?i.push(r):e.set(t,[r])},off:function(t,r){var i=e.get(t);i&&(r?i.splice(i.indexOf(r)>>>0,1):e.set(t,[]))},emit:function(t,r){var i=e.get(t);i&&i.slice().map(function(n){n(r)}),(i=e.get("*"))&&i.slice().map(function(n){n(t,r)})}}}var Bh=Object.create,Hi=Object.defineProperty,qh=Object.getOwnPropertyDescriptor,xa=Object.getOwnPropertyNames,Hh=Object.getPrototypeOf,Qh=Object.prototype.hasOwnProperty,Gh=(e,t,r)=>t in e?Hi(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,Ca=(e,t)=>function(){return t||(0,e[xa(e)[0]])((t={exports:{}}).exports,t),t.exports},Yh=(e,t,r,i)=>{if(t&&typeof t=="object"||typeof t=="function")for(let n of xa(t))!Qh.call(e,n)&&n!==r&&Hi(e,n,{get:()=>t[n],enumerable:!(i=qh(t,n))||i.enumerable});return e},Sa=(e,t,r)=>(r=e!=null?Bh(Hh(e)):{},Yh(Hi(r,"default",{value:e,enumerable:!0}),e)),he=(e,t,r)=>(Gh(e,typeof t!="symbol"?t+"":t,r),r);function fe(e,t,r,i=!0){t[It]=t[It]||[],t[It].push(e);const n=new Map;Object.defineProperty(t,e,{enumerable:i,get(){if(typeof t[ft][e]>"u")return;const s=t[ft][e];if(!s)return s;const a=r.get(t[ft][e],{parent:this.id?{id:this.id,type:this.type}:void 0});return n.has(a)||(n.clear(),n.set(a,dt(a,r))),n.get(a)},set(s){t[ft][e]!==s&&(this[ut]?r.modifyEntityField({id:this.id,type:this.type},e,Aa(s)):this[ft][e]=s)}})}var ft=Symbol.for("_refs_"),ut=Symbol.for("_reactive_"),It=Symbol.for("_defined_"),mn=Symbol.for("_parent_");function Vh(e,t=!1,r){const i={id:"",type:"unknown",[It]:[],[ft]:{},[mn]:null,[ut]:null,is(n){return typeof n=="string"?this.id===n:n.id?n.id===this.id:!1},reactive(){if(!this[ut])return this[ut]=this.subscribe(()=>this.refresh(),!0),()=>{this.unreactive()}},refresh(){if(this.id){const n=this.unwrap();for(const s of Object.keys(n||{}))this[It].includes(s)?this[ft][s]=n[s]:this[s]=n[s]}},unreactive(){this[ut]&&(this[ut](),this[ut]=null)},unwrap(){if(!this.id)throw new Error("Invalid object");const n=this[mn];return e.get(this.id,{parent:n?{id:n,type:"unknown"}:void 0})},toPresentation3(){return e.toPresentation3(this.unwrap())},toPresentation2(){return e.toPresentation2(this.unwrap())},valueOf(){return this.unwrap()},toJSON(){const n=this;return{...n,items:n.items,annotations:n.annotations,structures:n.structures,seeAlso:n.seeAlso,service:n.service,services:n.services,rendering:n.rendering,partOf:n.partOf,start:n.start,supplementary:n.supplementary,homepage:n.homepage,thumbnail:n.thumbnail,placeholderCanvas:n.placeholderCanvas,accompanyingCanvas:n.accompanyingCanvas,provider:n.provider}},subscribe(n,s=!0){return e.subscribe(()=>this.id?e.get(this.id):null,n,s)}};return fe("items",i,e),fe("annotations",i,e),fe("structures",i,e),fe("seeAlso",i,e),fe("rendering",i,e),fe("partOf",i,e),fe("start",i,e,!1),fe("supplementary",i,e),fe("homepage",i,e),fe("thumbnail",i,e),fe("placeholderCanvas",i,e,!1),fe("accompanyingCanvas",i,e,!1),fe("provider",i,e),fe("body",i,e),fe("logo",i,e),i}function Jh(e){return!!e[It]}function Aa(e){return Array.isArray(e)?e.map(t=>Aa(t)):!e||!e.type?e:{id:e.id,type:e.type}}function dt(e,t,r=!1,i){if(Array.isArray(e))return e.map(o=>dt(o,t,r));if(!e||!e.type||!e.id)return e;const n=Vh(t,r),s=Object.create(n),a=Object.assign(s,e);return r&&a.reactive(),a}function vn(e){switch(e){case"Image":case"Video":case"Sound":case"Dataset":case"Text":case"Composite":case"List":case"Independents":case"Audience":return"ContentResource";case"ImageService1":case"ImageService2":case"ImageService3":return"Service"}return e}var Xh=class{constructor(e,t){he(this,"options"),he(this,"store"),he(this,"emitter"),he(this,"isBatching",!1),he(this,"batchQueue",[]),he(this,"remoteFetcher"),he(this,"staticFetcher"),he(this,"defaultFetcher",r=>fetch(r).then(i=>{if(i.status===200)return i.json();{const n=new Error(`${i.status} ${i.statusText}`);throw n.name="HTTPError",n}})),this.options=Object.assign({reducers:{},customFetcher:this.defaultFetcher,enableDevtools:!0},e||{}),this.store=t||zh({customReducers:this.options.reducers,defaultState:this.options.defaultState,enableDevtools:this.options.enableDevtools}),this.emitter=wa(),this.remoteFetcher=pn(this,this.options.customFetcher),this.staticFetcher=pn(this,(r,i)=>i)}batch(e){this.isBatching=!0;try{e(this),this.isBatching=!1,this.dispatch(bi({actions:this.batchQueue}))}catch(t){throw this.batchQueue=[],this.isBatching=!1,t}this.batchQueue=[]}async asyncBatch(e){this.isBatching=!0;try{await e(this),this.isBatching=!1,this.dispatch(bi({actions:this.batchQueue}))}catch(t){throw this.batchQueue=[],this.isBatching=!1,t}this.batchQueue=[]}modifyEntityField(e,t,r){this.dispatch(dh.modifyEntityField({id:e.id,type:e.type,key:t,value:r}))}dispatch(e){if(this.isBatching)this.batchQueue.push(e);else{if(e.type===qi){for(const i of e.payload.actions)this.emitter.emit(i.type,{action:i,state:this.store.getState()});this.store.dispatch(e);const r=this.getState();for(const i of e.payload.actions)this.emitter.emit(`after:${i.type}`,{action:i,state:r});return}this.emitter.emit(e.type,{action:e,state:this.store.getState()}),this.store.dispatch(e);const t=this.store.getState();this.emitter.emit(`after:${e.type}`,{action:e,state:t});return}}on(e,t){return this.emitter.on(e,t),()=>{this.emitter.off(e,t)}}serialize(e,t){return Jl(this.getState().iiif,e,t)}toPresentation2(e){return this.serialize(e,th)}toPresentation3(e){return this.serialize(e,rh)}hydrate(e,t,r={}){return this.get(e,t,{...r,skipSelfReturn:!1})}get(e,t,r={}){typeof t!="string"&&(r=t||{},t=void 0);const{skipSelfReturn:i=!0}=r||{};let n=r.parent?typeof r.parent=="string"?r.parent:r.parent.id:void 0;if(Array.isArray(e))return e.map(l=>this.get(l,r));const s=this.getState();if(Ze(e)&&!r.preserveSpecificResources&&(e=e.source),typeof e=="string"){const l=vn(t||s.iiif.mapping[e]);if(!l)return i?null:{id:e,type:"unknown"};e={id:e,type:l}}if(e&&e.partOf&&!n&&!r.skipPartOfCheck){const l=Array.isArray(e.partOf)?e.partOf[0]:e.partOf;l&&(typeof l=="string"&&(n=l),typeof l.id=="string"&&(n=l.id))}const a=vn(t||(e==null?void 0:e.type)),o=e==null?void 0:e.id,c=s.iiif.entities[a];if(!c){const l=s.iiif.requests[o];return l&&l.resourceUri!==o?this.get(l.resourceUri,r):i?null:e}const h=c[e.id];if(h&&h[oe]){const l=h[oe].find(u=>n?u[ze]===n:u[ze]===h.id);return Bi(h,l)}return c[e.id]||(i?null:e)}select(e){return e(this.getState())}getStore(){return this.store}getState(){return this.store.getState()}deep(e,t){if(typeof e>"u")return this.get(t,{skipSelfReturn:!1});if(typeof e=="function")try{const i=e(this.get(t,{skipSelfReturn:!1})),n=s=>this.deep(s,i);return n.size=Array.isArray(i)?i.length:1,n}catch{const n=s=>this.deep(s,void 0);return n.size=0,n}const r=i=>this.deep(i,e);return r.size=Array.isArray(e)?e.length:1,r}loadManifest(e,t){const r=typeof e=="string"?e:e.id;return this.load(r,t)}loadCollection(e,t){const r=typeof e=="string"?e:e.id;return this.load(r,t)}load(e,t){const r=typeof e=="string"?e:e.id;return t?Promise.resolve(this.staticFetcher(r,t)):Promise.resolve(this.remoteFetcher(r))}loadSync(e,t){const r=typeof e=="string"?e:e.id;return this.staticFetcher(r,t)}loadManifestSync(e,t){const r=typeof e=="string"?e:e.id;return this.loadSync(r,t)}loadCollectionSync(e,t){const r=typeof e=="string"?e:e.id;return this.loadSync(r,t)}areInputsEqual(e,t){return dn(e,t)}subscribe(e,t,r){return typeof r>"u"&&(typeof t>"u"||t===!1||t===!0)&&(r=t,t=e,e=i=>i),this.store.subscribe(e,i=>t(i,this),{equalityFn:dn,fireImmediately:!r})}async ensureLoaded(e){const t=typeof e=="string"?e:e.id;this.requestStatus(t)||await this.load(t)}requestStatus(e){return this.select(t=>t.iiif.requests[e])}getResourceMeta(e,t){const r=this.getState().iiif.meta[e];if(r)return t?r[t]:r}getObject(e,t,r={}){const{reactive:i,...n}=r;return dt(this.get(e,t,n),this,i)}async loadObject(e,t){return dt(await this.load(e,t),this)}async loadManifestObject(e,t){return dt(await this.loadManifest(e,t),this)}async loadCollectionObject(e,t){return dt(await this.loadCollection(e,t),this)}wrapObject(e){return dt(this.get(e,{skipSelfReturn:!1}),this)}isWrapped(e){return Jh(e)}setMetaValue([e,t,r],i){this.dispatch(typeof i=="function"?gn.setMetaValueDynamic({id:e,meta:t,key:r,updateValue:i}):gn.setMetaValue({id:e,meta:t,key:r,value:i}))}};function Kh(){return typeof self<"u"?self:typeof window<"u"?window:typeof global<"u"?global:{}}function Zh(e){const t=Kh();try{const i=t.IIIF_VAULT;if(i)return i}catch{}const r=new Xh(e);try{t.IIIF_VAULT=r}catch{}return r}function eu(e,t,r=[],i=!1,n=[]){if(n.length&&(t=t.filter(a=>n.indexOf(a)===-1)),!t||t.length===0)return;if(t.length===1)return t[0];if(!e)return t.indexOf("none")!==-1?"none":t[0];if(t.indexOf(e)!==-1)return e;const s=e.indexOf("-")!==-1?e.slice(0,e.indexOf("-")):null;if(s&&t.indexOf(s)!==-1)return s;for(const a of r)if(t.indexOf(a)!==-1)return a;if(!i&&e){const o=t.map(c=>c.indexOf("-")!==-1?c.slice(0,c.indexOf("-")):null).indexOf(e);if(o!==-1)return t[o];for(const c of r){const h=c.indexOf("-")!==-1?c.slice(0,c.indexOf("-")):null,l=h?t.indexOf(h):-1;if(l!==-1)return t[l]}}return t.indexOf("none")!==-1?"none":t.indexOf("@none")!==-1?"@none":t[0]}function _a(e,t,r={}){const{strictFallback:i=!1,defaultText:n="",separator:s=`
+`,fallbackLanguages:a=[],closest:o,skipLanguages:c}=r,h=Object.keys(e||{}),l=o?t:eu(t,h,a,i,c);if(!e)return n;if(typeof e=="string")return e;const u=l?e[l]:void 0;if(u&&l){if(typeof u=="string")return u;if(u.length===1&&u[0]===""){const f=r.skipLanguages||[];return _a(e,t,{...r,skipLanguages:[...f,l]})}return u.join(s)}return""}function tu(e){try{if(e==="full")return{full:!0};if(e==="square")return{square:!0};let t=e.startsWith("pct:"),r=e.substr(t?4:0).split(",").map(i=>parseFloat(i));return{x:r[0],y:r[1],w:r[2],h:r[3],percent:t}}catch{throw new Error("Expected 'full', 'square' or 'x,y,w,h'. Found "+e)}}function ru(e){let t={upscaled:!1,max:!1,confined:!1};if(e[0]==="^"&&(t.upscaled=!0,e=e.slice(1)),e==="max"||e==="full")return t.max=!0,t.serialiseAsFull=e==="full",t;if(e[0]==="!"&&(t.confined=!0,e=e.slice(1)),e[0]==="p")return t.percentScale=parseFloat(e.slice(4)),t;let r=e.split(",").map(i=>i.trim());return r.length&&(r[0]!==""&&(t.width=parseInt(r[0],10)),r[1]!==""&&(t.height=parseInt(r[1],10))),t}function iu(e){let t={angle:0};if(e[0]==="!"&&(t.mirror=!0,e=e.substr(1)),t.angle=parseFloat(e)%360,Number.isNaN(t.angle))throw new Error(`Invalid rotation ${e}`);return t}function nu(e,t=""){let r=e.match(/^(([a-zA-Z]+):\/\/([^/]+))?((.*)+)/);if(!r)throw new Error(`Invalid or unknown input ${e}`);let i=r[2],n=r[3],s=r[4];if(s[0]==="/"&&(s=s.substring(1)),t.length>0){if(t[0]==="/"&&(t=t.substring(1)),t!==s.substring(0,t.length))throw new Error(`Path does not start with prefix (path: ${s}, prefix: ${t})`);s=s.substring(t.length)}return{scheme:i,server:n,path:s,prefix:t}}function su(e,t=""){let{path:r,scheme:i,server:n,prefix:s}=nu(e,t),a=r.split("/").reverse(),[o,c,h,l,...u]=a,f=u.reverse().filter(Boolean).join("/");if(a.length===1||o==="")return{type:"base",scheme:i,server:n,prefix:s,identifier:f};if(o==="info.json"){let[,...m]=a;return{type:"info",scheme:i,server:n,prefix:s,identifier:m.reverse().filter(Boolean).join("/")}}if(typeof i>"u"||typeof n>"u"||typeof r>"u"||typeof l>"u"||typeof h>"u"||typeof c>"u"||typeof o>"u")throw new Error("Invalid image service URL");let[p="",d=""]=o.split(".");return{type:"image",scheme:i,server:n,prefix:s,identifier:f,originalPath:r,region:tu(l),size:ru(h),rotation:iu(c),quality:p,format:d}}function au(e){return Rr.indexOf(e)!==-1?Ic:Wi.indexOf(e)!==-1?Oc:_c}function ou(e){let t=e?Array.isArray(e.profile)?e.profile:[e.profile]:[],r={extraQualities:[],extraFormats:[],extraFeatures:[]};for(let i of t)if(typeof i=="string"&&(i=au(i)),!!i){if(i.formats)for(let n of i.formats)r.extraFormats.indexOf(n)===-1&&r.extraFormats.push(n);if(i.qualities)for(let n of i.qualities)r.extraQualities.indexOf(n)===-1&&r.extraQualities.push(n);if(i.supports)for(let n of i.supports)r.extraFeatures.indexOf(n)===-1&&r.extraFeatures.push(n);if(i.maxHeight&&(r.maxHeight=i.maxHeight),i.maxWidth&&(r.maxWidth=i.maxWidth),i.maxArea&&(r.maxArea=i.maxArea),i.extraFormats)for(let n of i.extraFormats)r.extraFormats.indexOf(n)===-1&&r.extraFormats.push(n);if(i.extraQualities)for(let n of i.extraQualities)r.extraQualities.indexOf(n)===-1&&r.extraQualities.push(n);if(i.extraFeatures)for(let n of i.extraFeatures)r.extraFeatures.indexOf(n)===-1&&r.extraFeatures.push(n);i.maxHeight&&(r.maxHeight=i.maxHeight),i.maxWidth&&(r.maxWidth=i.maxWidth),i.maxArea&&(r.maxArea=i.maxArea)}if(e.extraFormats)for(let i of e.extraFormats)r.extraFormats.indexOf(i)===-1&&r.extraFormats.push(i);if(e.extraFeatures)for(let i of e.extraFeatures)r.extraFeatures.indexOf(i)===-1&&r.extraFeatures.push(i);if(e.extraQualities)for(let i of e.extraQualities)r.extraQualities.indexOf(i)===-1&&r.extraQualities.push(i);return r}function yn(e){let t=Array.isArray(e.profile)?e.profile:[e.profile];for(let r of t)if(typeof r=="string"&&Ls.indexOf(r)!==-1)return!0;return!1}function Y(e){if(e["@id"])return e["@id"];if(e.id)return e.id}function Mr(e){if(!e||!e.profile||!Y(e))return!1;let t=Array.isArray(e.profile)?e.profile:[e.profile];for(let r of t)if(typeof r=="string"&&Ds.indexOf(r)!==-1)return!0;return!1}function cu(e){if(!Mr(e))return!1;let t=Array.isArray(e.profile)?e.profile:[e.profile];for(let r of t)if(typeof r=="string"){if(Wi.indexOf(r)!==-1)return!0}else{let i=[...r.supports||[],...r.extraFeatures||[]];if(i.indexOf("regionByPx")!==-1&&(i.indexOf("sizeByW")!==-1||i.indexOf("sizeByWh")!==-1))return!0}return!1}function lu({x:e=0,y:t=0,w:r,h:i,full:n,square:s,percent:a}){return"full"}function hu({max:e,percentScale:t,upscaled:r,confined:i,width:n,height:s,serialiseAsFull:a,version:o}){let c=[];return r&&c.push("^"),e?(c.push(a?"full":"max"),c.join("")):(i&&c.push("!"),t&&c.push(`pct:${t}`),n&&c.push(`${n}`),c.push(","),s&&o===3&&c.push(`${s}`),c.join(""))}function uu(e){return`${e.mirror?"!":""}${(e.angle||0)%360}`}function fu(e,t){let r=e.prefix.startsWith("/")?e.prefix.substring(1):e.prefix,i=`${e.scheme}://${e.server}/${r?`${r}/`:""}${e.identifier}`,{size:n}=e,{region:s,rotation:a,format:o,quality:c}=e;return[i,lu(s),hu(n),uu(a),`${c}.${o}`].filter(Boolean).join("/")}function pt(e){return e.endsWith("info.json")?e:e.endsWith("/")?`${e}info.json`:`${e}/info.json`}function du(e){let t=su(pt(e.id));if(t.type!=="info")throw new Error("Invalid service URL");let r=ou(e);return{identifier:t.identifier,originalPath:"",server:t.server,prefix:t.prefix,scheme:t.scheme,type:"image",quality:r.extraQualities.indexOf("default")===-1?r.extraQualities[0]:"default",region:{full:!0},size:{max:!0,upscaled:!1,confined:!1},format:"jpg",rotation:{angle:0}}}function pu(e,t,r){let i=r.length,n=[];for(let s=0;s<i;s++){let a=r[s];if(!a)continue;let o=a.width;n.push(e/o)}return n}function gu(e,t,r){let i=r.length,n=[];for(let s=0;s<i;s++){let a=r[s];a&&n.push({width:Math.floor(e/a),height:Math.floor(t/a)})}return n}function Vr(e,t){if(t&&t.profile){let r=t.profile;if(r){let i=Array.isArray(r)?r:[r];if(i.includes(`level${e}`)||i.includes(`http://iiif.io/api/image/2/level${e}.json`)||i.includes(`http://iiif.io/api/image/1/level${e}.json`)||i.includes(`http://iiif.io/api/image/1/profiles/level${e}.json`))return!0;if(e===2){for(let n of i)if(Rr.includes(n))return!0}if(e===1){for(let n of i)if(Wi.includes(n))return!0}if(e===0){for(let n of i)if(Ls.includes(n))return!0}}}return!1}function xi(e){return Mr(e)?Vr(0,e)?0:Vr(1,e)?1:Vr(2,e)?2:null:null}function Oa(e){let t=e.service?Array.isArray(e.service)?e.service:[e.service]:[],r=t.length,i=[];for(let n=0;n<r;n++)Mr(t[n])&&i.push(t[n]);return i}function mu(e){if(e["@type"])return e["@type"];if(e.type)return e.type}function xt(e){const t=e.replace(/(https?:\/\/)?(www.)?/i,"");return t.indexOf("/")!==-1?t.split("/")[0]:t}function vu(e,t,r){const i=e>t?e:t,n=r.length,s=[];for(let a=0;a<n;a++){const o=r[a];if(!o||o.scaleFactors.length===0)continue;let c=o.scaleFactors[0];if(!c)continue;let h=i/c;const l=[c];for(;h>=o.width;)c=c*2,l.push(c),h=h/2;s.push({...o,scaleFactors:l})}return s}function Jr(e,t,r){const i=du({"@context":e.version===3?"http://iiif.io/api/image/3/context.json":"http://iiif.io/api/image/2/context.json",id:pt(Y(e)),profile:e.level===null||typeof e.level>"u"?"level0":`level${e.level}`,type:e.version===3?"ImageService3":"ImageService2"});return i.size.max=!1,i.size.width=t,i.size.height=r,{id:fu(i),type:"fixed",width:t,height:r||e.height/(e.width||1)*t,unsafe:e.width>t}}function yu(e,t,r){const i=e.width?e.width:e.maxWidth;return r.height<=e.maxHeight&&r.width<=e.maxWidth&&r.height>=e.minHeight&&r.width>=e.minWidth&&(!t||Math.abs(r.width-i)<Math.abs(t.width-i))}function bu(e,t){const r=[],i=Object.assign({unsafeImageService:!1,atAnyCost:!0,fallback:!0,minHeight:64,minWidth:64,maxHeight:1/0,maxWidth:1/0,returnAllOptions:!1,preferFixedSize:!1,allowUnsafe:!1,explain:!1,height:0,width:0},e),n=(l,u=0)=>i.explain?r.push(new Array(u).fill(0).map(f=>"    ").join("")+l().trim()):void 0,s=[],a=[];let o=null;n(()=>`Using configuration: ${JSON.stringify(i,null,2)}`);const c=(l,u)=>{if(n(()=>"Swapping choice",3),yu(i,u,l)){if(i.preferFixedSize&&l.unsafe){n(()=>`We found an image that was marked as unsafe, but it was the best size. (${l.id})`,4),a.push(l);return}i.returnAllOptions&&u&&a.push(u),n(()=>`We found a new image that was the best size. (${l.id})`,4),o=l}else i.returnAllOptions&&a.push(l)};n(()=>`The input shows we have ${t.length} list(s) of candidates to choose from.`);const h=t.length;for(let l=0;l<h;l++){const u=t[l]();n(()=>`Candidate group ${l}: ${JSON.stringify(u,null,2)}`,1);const f=u.length;n(()=>`Checking candidate list number ${l} and found ${f} potential ways of creating image(s)`,1);for(let p=0;p<f;p++){const d=u[p];if(n(()=>`-> Checking candidate ${p}`,1),d.type==="unknown"&&i.atAnyCost&&(n(()=>`We've found an unknown image type, adding this to the "last resort" list`,2),s.push(d)),d.type==="fixed"&&(d.unsafe?(n(()=>`We've found an unsafe fixed image type, adding this to the "last resort" list`,2),s.push(d)):(n(()=>"We've found a fixed size image, checking if it matches the request",2),c(d,o))),d.type==="fixed-service")if(i.unsafeImageService){n(()=>"Checking for an image from the tile source, without calculating the right height and width (unsafeImageService)",2);const m=Jr(d,i.width,i.height);c(m,o)}else{n(()=>"Checking for an image from the tile source 3",2);const m=Jr(d,d.width,d.height);c(m,o)}if(d.type==="variable"&&d.maxWidth){const m=Jr({id:d.id,width:d.maxWidth,height:d.maxWidth,level:d.level,version:d.version},d.maxWidth);c(m,o)}}if(o&&!i.returnAllOptions){if(o.unsafe||i.allowUnsafe)continue;n(()=>`We found a match in choice list number ${l}, no searching any more`);break}}return i.atAnyCost&&a.length===0?(n(()=>o?`We found an image! ${o.id} of type ${o.type}`:'We found no images, but "atAnyCost" is set, so returning that'),{best:o||s[0]||null,fallback:s.slice(1),log:r}):i.returnAllOptions?(n(()=>"Returning all options that we have found"),{best:(i.atAnyCost?o||a[0]||s[0]:o||a[0])||null,fallback:[...a,...s],log:r}):(n(()=>"Returning the best image that we found, and a fallback"),{best:o||a[0]||null,fallback:o?a:a.slice(1),log:r})}function Ia(e){return(e["@context"]?Array.isArray(e["@context"])?e["@context"]:[e["@context"]]:[]).indexOf("http://iiif.io/api/image/3/context.json")!==-1}function wu(e){return Mr(e)?(e&&e.sizes?e.sizes:[]).map(t=>({id:Y(e),type:"fixed-service",height:t.height,width:t.width,level:xi(e),version:Ia(e)?3:2})):[]}function xu(e){if(!cu(e))return[];const t=[],r=Array.isArray(e.profile)?e.profile:[e.profile],i=r.length;for(let n=0;n<i;n++){const s=r[n];if(s&&typeof s!="string"&&(s.maxHeight||s.maxWidth))return[{id:Y(e),type:"variable",minWidth:0,minHeight:0,maxHeight:s.maxHeight||s.maxWidth,maxWidth:s.maxWidth||s.maxHeight,level:xi(e),version:e["@context"]==="http://iiif.io/api/image/3/context.json"?3:2}]}if(e.tiles){const n=e.tiles.length;for(let s=0;s<n;s++){const a=e.tiles[s];a&&(a.height||a.width)&&t.push({id:Y(e),type:"variable",minHeight:0,minWidth:0,maxHeight:a.height||a.width,maxWidth:a.width,level:xi(e),version:Ia(e)?3:2})}}return t}function bn(e){const t=[],r=e.length;for(let i=0;i<r;i++){const n=e[i];if(!n)continue;const s=wu(n);s.length&&t.push(...s);const a=xu(n);a.length&&t.push(...a)}return t}function wn(e){const t=/^.*\/(full)\/(((\d+),(\d+)?)|max)\/(\d+)\/default\.(jpg|png|jpeg)$/,r=e.match(t);if(r&&r[4]&&r[5]){const i=r[1],n=parseInt(r[4],10),s=parseInt(r[5],10),a=r[7];if((i==="max"||i==="full")&&n&&s&&a)return{type:"fixed",id:e,height:s,width:n}}return{type:"unknown",id:e}}function Ci(e){if(typeof e=="string")return wn(e);const t=mu(e);if(t!=="Image"&&t!=="sc:Image")return null;const r=e,i=Y(r);return i?i&&r.width&&r.height?{id:i,type:"fixed",width:r.width,height:r.height,unsafe:!0}:wn(i):null}function Cu(e,t=!0,r){const i=[],n=Ci(e);if(n===null)return i;const s=e;if(i.push(n),t&&s&&s.width&&s.height){const a=[],o=Oa(s);for(const c of o){const h={id:Y(c),width:s.width,height:s.height};if(r.canLoadSync(h)){const l=r.loadServiceSync(h);l&&(l.height||(l.height=s.height),l.width||(l.width=s.width),a.push(...bn([l])))}}if(a.length)return i.push(...a),i}return s.service&&i.push(...bn(s.service)),i}function Su(e,t){if(e.length!==t.length)return!1;if(e.length===0&&t.length===0)return!0;const r=e.length;let i=!0;for(let s=0;s<r;s++){const a=e[s],o=t[s];if(a.width!==o.width||a.height!==o.height){i=!1;break}}if(i)return!0;let n=0;for(let s=0;s<r;s++)for(let a=0;a<r;a++)if(e[s].width===t[a].width&&e[s].height===t[a].height){n++;break}return n===r}var ka=class{constructor(t={}){he(this,"config",{verificationsRequired:1,approximateServices:!1,enableFetching:!0,disableThrottling:!1}),he(this,"fetchingCount",0),he(this,"imageServices",{}),he(this,"knownImageServers",{}),this.config=Object.assign(this.config,t)}setConfig(t){Object.assign(this.config,t)}sample(t,r,i=!0){const n=xt(Y(t)),s=pt(Y(t)),a=this.knownImageServers[n];return this.imageServices[s]=Object.assign(t,{real:!0}),!a&&t.tiles&&!yn(t)?(this.knownImageServers[n]={verifications:0,malformed:!1,root:n,preLoaded:i,sampledId:Y(t),verified:!1,server:null,result:{context:t["@context"]||[],sampledProfile:t.profile,resourceServiceRatio:r&&t.height?r.height/t.height:1,sampledSizes:t.sizes||[],sizeRatios:pu(t.width,t.height,t.sizes||[]),sampledTiles:t.tiles||[]}},!0):this.verify(t)}preLoad(t,r=!0){this.knownImageServers[t.root]=t,r&&(this.knownImageServers[t.root].malformed=!1,this.knownImageServers[t.root].verifications=this.config.verificationsRequired)}predict(t,r=!1,i=!1){const n=t==null?void 0:t.source,s=xt(Y(t)),a=this.knownImageServers[s],o=pt(Y(t));return this.imageServices[o]?this.imageServices[o]||null:!this.config.approximateServices||!a||!a.result||!(n!=null&&n.height||t.height)||!(n!=null&&n.width||t.width)||!i&&(a.malformed||a.verifications<this.config.verificationsRequired)||t.source&&yn(t.source)?null:(this.imageServices[o]||(this.imageServices[o]={"@context":a.result.context,"@id":Y(t),id:Y(t),protocol:"http://iiif.io/api/image",tiles:(n==null?void 0:n.tiles)||vu(t.width,t.height,a.result.sampledTiles),sizes:(n==null?void 0:n.sizes)||gu(Math.round(t.width/a.result.resourceServiceRatio),Math.round(t.height/a.result.resourceServiceRatio),a.result.sizeRatios),profile:(n==null?void 0:n.profile)||a.result.sampledProfile,height:(n==null?void 0:n.height)||t.height,width:(n==null?void 0:n.width)||t.width,real:!1}),this.imageServices[o]||null)}async getThumbnailFromResource(t,r,i=!0,n=[]){const s=t?await this.getImageCandidates(t,i):[];return bu(r,[()=>n,()=>s])}async getImageCandidates(t,r=!0){const i=t;if(r&&i&&i.height&&i.width){const n=Oa(i);for(const s of n){const a={id:Y(s),width:s.width?s.width:i.width,height:s.height?s.height:i.height,source:s};await this.loadService(a)}}return Cu(t,r,this)}async verify(t){const r=this.predict(t,!1,!0),i=await this.fetchService(Y(t));if(!r)return!1;const n=r.height===i.height&&r.width===i.width&&r["@context"]===i["@context"]&&Su(r.sizes||[],i.sizes||[]);if(n){const s=xt(Y(t)),a=this.knownImageServers[s];a&&(a.verifications+=1,a.verifications>=this.config.verificationsRequired&&(a.verified=!0))}return n}canLoadSync(t){const r=typeof t=="string"?t:Y(t),i=pt(r);if(this.imageServices[i])return!0;const n=this.knownImageServers[xt(r)];return!!(n&&!n.malformed&&n.verifications>=this.config.verificationsRequired)}async markAsMalformed(t){return this.knownImageServers[xt(Y(t))].malformed=!0,this.loadService(t,!0)}async fetchService(t,r=!1){const i=pt(t),n=this.imageServices[i];if(n&&(!r||n.real))return n;if(!this.config.enableFetching)throw new Error("Fetching is not enabled");const s=await this.fetch(i).then(a=>a.json());return!s.id&&s["@id"]&&(s.id=s["@id"]),s.id!==t&&(s.id=t,s["@id"]&&(s["@id"]=t)),this.imageServices[i]=Object.assign(s,{real:!0}),this.imageServices[i]}async fetch(t,r){return fetch(t,r)}async loadService(t,r=!1){if(!this.config.disableThrottling){let s=!0;for(;s;)if(this.fetchingCount>=this.config.verificationsRequired)await new Promise(a=>setTimeout(a,500));else{s=!1;break}}const i=this.knownImageServers[xt(Y(t))];if(i&&!i.malformed&&!r){await i.result;const s=this.loadServiceSync(t);if(s)return s}this.fetchingCount++;const n=await this.fetchService(Y(t),r);return this.fetchingCount--,n.real&&this.sample(n,t),n}loadServiceSync(t){const r=pt(Y(t));return this.imageServices[r]?this.imageServices[r]:this.config.approximateServices?this.predict(t):null}};function Au(e={}){const t=e.events||wa(),r=e.loader||new ka;return{store:os((n,s)=>({loaded:{},loadServiceSync:(a,o,c)=>{const h=a.id||a["@id"],l=s().loaded[h];if(l&&l.status==="done")return l.service;if(l&&l.status==="loading")return null;if(l&&l.status==="error")throw new Error("Failed to load image service");const u={id:Y(a),width:a.width||(o==null?void 0:o.width)||0,height:a.height||(o==null?void 0:o.height)||0,source:a},f=r.loadServiceSync(u);return f?(n(p=>({loaded:{...p.loaded,[h]:{status:"done",service:f,real:!0}}})),t.emit("image-service.loaded",{id:h,service:f})):c&&s().loadService(a,o).then(()=>{}),f},loadService:async(a,o)=>{const c=a.id||a["@id"],h=s().loaded[c];if(h&&h.status==="done")return h.service;if(h&&h.status==="loading")return new Promise((l,u)=>{const f=p=>{p.id===c&&(t.off("image-service.loaded",f),l(p.service||a))};t.on("image-service.loaded",f)});if(h&&h.status==="error"&&!(o!=null&&o.force))throw new Error("Failed to load image service");t.emit("image-service.loading",{id:c});try{const l={id:Y(a),width:a.width||0,height:a.height||0,source:a},u=await r.loadService(l,o==null?void 0:o.force);return n(f=>({loaded:{...f.loaded,[c]:{status:"done",service:u,real:u.real}}})),t.emit("image-service.loaded",{id:c,service:u}),u}catch(l){throw t.emit("image-service.error",{id:c,error:l}),l}}})),events:t}}Au();var _u=new ka;function Ou(e=zi,t={}){const r=t.imageServiceLoader||_u;async function i(n,s,a=!1,o=[],c){const h=()=>r.getThumbnailFromResource(void 0,s,a,o);if(!n)return await r.getThumbnailFromResource(void 0,s,a,o);if(typeof n=="string"){const f=Ci(n);return f&&o.push(f),await r.getThumbnailFromResource(void 0,s,a,o)}const l=e.get(n,{skipSelfReturn:!1});if(typeof l=="string")return{best:Ci(l),fallback:[],log:[]};if(!l)return await h();switch(await(async f=>{if(f&&f.thumbnail&&f.thumbnail.length){const p=e.get(f.thumbnail[0]),d=await r.getImageCandidates(p,a);d&&d.length&&o.push(...d)}})(l),l.type){case"Annotation":{const f=Array.isArray(l.body)?l.body:[l.body],p=e.get(f[0]);return c&&!p.width&&(p.width=c.width,p.height=c.height),await r.getThumbnailFromResource(p,s,a,o)}case"Canvas":{const f=l;return i(f.items[0],s,a,o,{width:f.width,height:f.height})}case"AnnotationPage":return i(l.items[0],s,a,o,c);case"Choice":{const f=l;return!f.items||f.items[0]?await h():i(f.items[0],s,a,o,c)}case"Collection":{const p=l.items[0];return p?i(p,s,a,o,c):await h()}case"Manifest":{const p=l.items[0];return p?i(p,s,a,o,c):await h()}case"SpecificResource":case"Image":case"Dataset":case"Sound":case"Text":case"TextualBody":case"Video":return c&&!l.width&&(l.width=c.width,l.height=c.height),r.getThumbnailFromResource(l,s,a,o)}return await h()}return{getBestThumbnailAtSize:i}}var Iu=Ca({"node_modules/.pnpm/parse-svg-path@0.1.2/node_modules/parse-svg-path/index.js"(e,t){t.exports=n;var r={a:7,c:6,h:1,l:2,m:2,q:4,s:4,t:2,v:1,z:0},i=/([astvzqmhlc])([^astvzqmhlc]*)/ig;function n(o){var c=[];return o.replace(i,function(h,l,u){var f=l.toLowerCase();for(u=a(u),f=="m"&&u.length>2&&(c.push([l].concat(u.splice(0,2))),f="l",l=l=="m"?"l":"L");;){if(u.length==r[f])return u.unshift(l),c.push(u);if(u.length<r[f])throw new Error("malformed path data");c.push([l].concat(u.splice(0,r[f])))}}),c}var s=/-?[0-9]*\.?[0-9]+(?:e[-+]?\d+)?/ig;function a(o){var c=o.match(s);return c?c.map(Number):[]}}}),ku=Ca({"node_modules/.pnpm/abs-svg-path@0.1.1/node_modules/abs-svg-path/index.js"(e,t){t.exports=r;function r(i){var n=0,s=0,a=0,o=0;return i.map(function(c){c=c.slice();var h=c[0],l=h.toUpperCase();if(h!=l)switch(c[0]=l,h){case"a":c[6]+=a,c[7]+=o;break;case"v":c[1]+=o;break;case"h":c[1]+=a;break;default:for(var u=1;u<c.length;)c[u++]+=a,c[u++]+=o}switch(l){case"Z":a=n,o=s;break;case"H":a=c[1];break;case"V":o=c[1];break;case"M":a=n=c[1],o=s=c[2];break;default:a=c[c.length-2],o=c[c.length-1]}return c})}}}),Tu=function(){function e(t,r){var i=[],n=!0,s=!1,a=void 0;try{for(var o=t[Symbol.iterator](),c;!(n=(c=o.next()).done)&&(i.push(c.value),!(r&&i.length===r));n=!0);}catch(h){s=!0,a=h}finally{try{!n&&o.return&&o.return()}finally{if(s)throw a}}return i}return function(t,r){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,r);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),qt=Math.PI*2,Xr=function(t,r,i,n,s,a,o){var c=t.x,h=t.y;c*=r,h*=i;var l=n*c-s*h,u=s*c+n*h;return{x:l+a,y:u+o}},Pu=function(t,r){var i=r===1.5707963267948966?.551915024494:r===-1.5707963267948966?-.551915024494:1.3333333333333333*Math.tan(r/4),n=Math.cos(t),s=Math.sin(t),a=Math.cos(t+r),o=Math.sin(t+r);return[{x:n-s*i,y:s+n*i},{x:a+o*i,y:o-a*i},{x:a,y:o}]},xn=function(t,r,i,n){var s=t*n-r*i<0?-1:1,a=t*i+r*n;return a>1&&(a=1),a<-1&&(a=-1),s*Math.acos(a)},ju=function(t,r,i,n,s,a,o,c,h,l,u,f){var p=Math.pow(s,2),d=Math.pow(a,2),m=Math.pow(u,2),g=Math.pow(f,2),y=p*d-p*g-d*m;y<0&&(y=0),y/=p*g+d*m,y=Math.sqrt(y)*(o===c?-1:1);var b=y*s/a*f,w=y*-a/s*u,F=l*b-h*w+(t+i)/2,x=h*b+l*w+(r+n)/2,A=(u-b)/s,k=(f-w)/a,C=(-u-b)/s,S=(-f-w)/a,E=xn(1,0,A,k),_=xn(A,k,C,S);return c===0&&_>0&&(_-=qt),c===1&&_<0&&(_+=qt),[F,x,E,_]},$u=function(t){var r=t.px,i=t.py,n=t.cx,s=t.cy,a=t.rx,o=t.ry,c=t.xAxisRotation,h=c===void 0?0:c,l=t.largeArcFlag,u=l===void 0?0:l,f=t.sweepFlag,p=f===void 0?0:f,d=[];if(a===0||o===0)return[];var m=Math.sin(h*qt/360),g=Math.cos(h*qt/360),y=g*(r-n)/2+m*(i-s)/2,b=-m*(r-n)/2+g*(i-s)/2;if(y===0&&b===0)return[];a=Math.abs(a),o=Math.abs(o);var w=Math.pow(y,2)/Math.pow(a,2)+Math.pow(b,2)/Math.pow(o,2);w>1&&(a*=Math.sqrt(w),o*=Math.sqrt(w));var F=ju(r,i,n,s,a,o,u,p,m,g,y,b),x=Tu(F,4),A=x[0],k=x[1],C=x[2],S=x[3],E=Math.abs(S)/(qt/4);Math.abs(1-E)<1e-7&&(E=1);var _=Math.max(Math.ceil(E),1);S/=_;for(var R=0;R<_;R++)d.push(Pu(C,S)),C+=S;return d.map(function(V){var Q=Xr(V[0],a,o,g,m,A,k),z=Q.x,B=Q.y,D=Xr(V[1],a,o,g,m,A,k),X=D.x,W=D.y,Ae=Xr(V[2],a,o,g,m,A,k),$=Ae.x,q=Ae.y;return{x1:z,y1:B,x2:X,y2:W,x:$,y:q}})},Fu=$u,Eu=Sa(Iu()),Ru=Sa(ku());function Mu(e){const t=(0,Eu.default)(e),r=(0,Ru.default)(t);let i,n=0,s=0,a=0,o=0,c,h,l=0,u=0;const f=[];for(let p=0;p<r.length;p++){let d=r[p];const m=d[0];switch(m){case"M":n=d[1],s=d[2];break;case"H":d=["L",d[1],s];break;case"V":d=["L",n,d[1]];break;case"S":{let g=l,y=u;(i==="C"||i=="S")&&(g+=g-a,y+=y-o),d=["C",g,y,d[1],d[2],d[3],d[4]]}break;case"T":i==="Q"||i=="T"?(c=l*2-c,h=u*2-h):(c=l,h=u),d=["Q",c,h,d[1],d[2]];break;case"Q":c=d[1],h=d[2];break;case"A":{const g=Fu({px:l,py:u,cx:d[6],cy:d[7],rx:d[1],ry:d[2],xAxisRotation:d[3],largeArcFlag:d[4],sweepFlag:d[5]});if(!g.length)continue;for(const[y,b]of g.entries())d=["C",b.x1,b.y1,b.x2,b.y2,b.x,b.y],y<g.length-1&&f.push(d);d=d}break;case"Z":d=["L",n,s];break}i=m,l=d[d.length-2],u=d[d.length-1],["C","Q","A"].indexOf(m)>-1?(a=d[d.length-4],o=d[d.length-3]):(a=l,o=u),f.push(d)}return f}function Nu(e,t,r,i=1){return new Ta(e,t,r).subdivide(i)}function Du(e,t,r,i,n=1){return new Wu(new Float64Array([e.x,e.y,t.x,t.y,r.x,r.y,i.x,i.y])).subdivide(n)}function Lu(e){return e.x*e.x+e.y*e.y}function Ht(e){return e/(1-.67+Math.pow(Math.pow(.67,4)+.25*e*e,.25))}function kt(e){return e*(1-.39+Math.sqrt(.39*.39+.25*e*e))}var Ta=class{constructor(e,t,r){he(this,"start"),he(this,"control"),he(this,"end"),this.start=e,this.control=t,this.end=r}eval(e){const t=1-e;return{x:this.start.x*t*t+2*this.control.x*t*e+this.end.x*e*e,y:this.start.y*t*t+2*this.control.y*t*e+this.end.y*e*e}}mapToBasic(){const{x:e,y:t}=this.start,{x:r,y:i}=this.control,{x:n,y:s}=this.end,a=2*r-e-n,o=2*i-t-s,c=(r-e)*a+(i-t)*o,h=(n-r)*a+(s-i)*o,l=(n-e)*o-(s-t)*a,u=c/l,f=h/l,p=Math.abs(l)/(Math.hypot(a,o)*Math.abs(f-u));return{x0:e,x2:n,scale:p,cross:l}}subdivide(e){const t=this.mapToBasic(),r=Ht(t.x0),i=Ht(t.x2),n=.5*Math.abs(i-r)*Math.sqrt(t.scale/e),s=Math.ceil(n),a=kt(r),o=kt(i),c=[0];for(let h=1;h<s;h++){const u=(kt(r+(i-r)*h/s)-a)/(o-a);c.push(u)}return c.push(1),c.map(h=>this.eval(h))}},Wu=class Pa{constructor(t){he(this,"c"),this.c=t}weightsum(t,r,i,n){const s=t*this.c[0]+r*this.c[2]+i*this.c[4]+n*this.c[6],a=t*this.c[1]+r*this.c[3]+i*this.c[5]+n*this.c[7];return{x:s,y:a}}eval(t){const r=1-t,i=r*r*r,n=3*r*r*t,s=3*r*t*t,a=t*t*t;return this.weightsum(i,n,s,a)}deriv(t){const r=1-t,i=-3*r*r,n=3*t*t,s=-6*t*r-i,a=6*t*r-n;return this.weightsum(i,s,a,n)}midpoint_quadbez(){const t=this.weightsum(-.25,.75,.75,-.25);return new Ta({x:this.c[0],y:this.c[1]},t,{x:this.c[6],y:this.c[7]})}subsegment(t,r){const i=new Float64Array(8),n=this.eval(t),s=this.eval(r);i[0]=n.x,i[1]=n.y;const a=(r-t)/3,o=this.deriv(t);i[2]=n.x+a*o.x,i[3]=n.y+a*o.y;const c=this.deriv(r);return i[4]=s.x-a*c.x,i[5]=s.y-a*c.y,i[6]=s.x,i[7]=s.y,new Pa(i)}subdivide(t){const r=.1*t,i=t-r,n=Math.sqrt(i),s=Lu(this.weightsum(1,-3,3,-1)),a=Math.ceil(Math.pow(s/(432*r*r),1/6)),o=[];let c=0;for(let d=0;d<a;d++){const m=d/a,g=(d+1)/a,y=this.subsegment(m,g).midpoint_quadbez(),b=y.mapToBasic(),w=Ht(b.x0),F=Ht(b.x2),x=Math.sqrt(b.scale);let A=Math.abs(F-w)*x;if(Math.sign(b.x0)!=Math.sign(b.x2)){const k=n/x,C=n*Math.abs(F-w)/Ht(k);A=Math.max(A,C)}o.push({quad:y,a0:w,a2:F,val:A}),c+=A}const h=.5*c/n,l=Math.ceil(h),u=[{x:this.c[0],y:this.c[1]}];let f=0,p=0;for(let d=1;d<l;d++){const m=c*d/l;for(;f+o[p].val<m;)f+=o[p].val,p++;const g=o[p].a0,y=o[p].a2,b=kt(g),w=kt(y),F=g+(y-g)*(m-f)/o[p].val,A=(kt(F)-b)/(w-b);u.push(o[p].quad.eval(A))}return u.push({x:this.c[6],y:this.c[7]}),u}},Uu=/&?(xywh=)?(pixel:|percent:|pct:)?([0-9]+(?:\.[0-9]+)?),([0-9]+(?:\.[0-9]+)?),([0-9]+(?:\.[0-9]+)?),([0-9]+(?:\.[0-9]+)?)/,Cn=/&?(t=)(npt:)?([0-9]+(\.[0-9]+)?)?(,([0-9]+(\.[0-9]+)?))?/,Sn=/^rgba\((\d+),(\d+),(\d+),([0-9.]+)\)$/;function pr(e,{domParser:t,svgPreprocessor:r,iiifRenderingHints:i}={}){if(Array.isArray(e))return be(e.reduce((n,s)=>{const{selector:a,selectors:o,iiifRenderingHints:c}=pr(s,{domParser:t,svgPreprocessor:r,iiifRenderingHints:i});return a&&(n.selector||(n.selector=a),n.selectors.push(...o)),c&&(n.iiifRenderingHints=n.iiifRenderingHints||{type:"ImageApiSelector"},Object.assign(n.iiifRenderingHints,c)),n},{selector:null,selectors:[],iiifRenderingHints:i}));if(!e)return be({selector:null,selectors:[],iiifRenderingHints:i});if(typeof e=="string"){const[n,s]=e.split("#");return s?pr({type:"FragmentSelector",value:s},{svgPreprocessor:r,iiifRenderingHints:i,domParser:t}):be({selector:null,selectors:[],iiifRenderingHints:i})}if(e.type){if(e.type==="PointSelector"&&(e.t||e.t===0)){const n={type:"TemporalSelector",temporal:{startTime:e.t}};return be({selector:n,selectors:[n],iiifRenderingHints:i})}if(e.type==="PointSelector"&&e.x&&e.y){const n={type:"PointSelector",spatial:{x:e.x,y:e.y}};return be({selector:n,selectors:[n],iiifRenderingHints:i})}}if(Hu(e)){const n=[];if(e.region){const s=pr({type:"FragmentSelector",value:"xywh="+e.region},{domParser:t,svgPreprocessor:r,iiifRenderingHints:i});n.push(...s.selectors)}return be({selector:n[0],selectors:n,iiifRenderingHints:i?{...i,...e}:e})}if(e.type==="FragmentSelector"){const n=Uu.exec(e.value);if(n){let a={type:"BoxSelector",spatial:{unit:n[2]==="percent:"||n[2]==="pct:"?"percent":"pixel",x:parseFloat(n[3]),y:parseFloat(n[4]),width:parseFloat(n[5]),height:parseFloat(n[6])}};const o=e.value.match(Cn);return o&&(a={type:"TemporalBoxSelector",spatial:a.spatial,temporal:{startTime:o[3]?parseFloat(o[3]):0,endTime:o[6]?parseFloat(o[6]):void 0}}),be({selector:a,selectors:[a],iiifRenderingHints:i})}const s=e.value.match(Cn);if(s){const a={type:"TemporalSelector",temporal:{startTime:s[3]?parseFloat(s[3]):0,endTime:s[6]?parseFloat(s[6]):void 0}};return be({selector:a,selectors:[a],iiifRenderingHints:i})}return be({selector:null,selectors:[],iiifRenderingHints:i})}if(e.type==="SvgSelector"&&"value"in e){t||(typeof window<"u"?t=new window.DOMParser:console.warn("No DOMParser available, cannot parse SVG selector, `points`, `spatial` and `style` will be unavailable and the SVG will not be normalized."));let n=[],s,a,o=(r==null?void 0:r(e.value))??e.value,c;if(t){const l=t.parseFromString(e.value,"image/svg+xml").querySelector("svg");if(!l)return console.warn(`Illegal SVG selector: ${e.value}`),be({selector:null,selectors:[],iiifRenderingHints:i});const u=ja(l);u&&(n=u.points,c=u.shapeType,s=[Math.min(...n.map(f=>f[0])),Math.min(...n.map(f=>f[1])),Math.max(...n.map(f=>f[0])),Math.max(...n.map(f=>f[1]))],{style:a,svg:o}=qu(u.element)??{svg:o})}const h={type:"SvgSelector",svg:o,svgShape:c,style:a,points:n.length?n:void 0,spatial:s?{unit:"pixel",x:s[0],y:s[1],width:s[2]-s[0],height:s[3]-s[1]}:void 0};return be({selector:h,selectors:[h],iiifRenderingHints:i})}return be({selector:null,selectors:[],iiifRenderingHints:i})}function zu(e){const t=e.map(i=>i[0]).reduce((i,n)=>(i[n]+=1,i),{C:0,Q:0,L:0,M:0}),r=new Set(e.map(i=>i[0]));if(t.C>0||t.Q>0)return"path";if(t.L>0&&(r.size===1||r.size===2&&r.has("M"))){if(t.L===4)return"rect";const i=e.slice(-1)[0];return e[0][0]==="M"&&i[0]==="L"&&i[1]==e[0][1]&&i[2]===e[0][2]||i[1]===0&&i[2]===0?"polygon":"polyline"}return"path"}function ja(e){var t;for(const r of Array.from(e.children))switch(r==null?void 0:r.tagName.toLowerCase()){case"g":{const i=ja(r);if(i)return i}continue;case"path":{const i=r.getAttribute("d");if(!i)continue;const n=Mu(i);return{element:r,points:Bu(n),shapeType:zu(n)}}case"circle":{const i=parseFloat(r.getAttribute("cx")??"0"),n=parseFloat(r.getAttribute("cy")??"0"),s=parseFloat(r.getAttribute("r")??"0");if(!s)continue;const a=[];for(let o=0;o<=360;o+=12){const c=o*Math.PI/180;a.push([i+s*Math.cos(c),n+s*Math.sin(c)])}return{element:r,points:a,shapeType:"circle"}}case"ellipse":{const i=parseFloat(r.getAttribute("cx")??"0"),n=parseFloat(r.getAttribute("cy")??"0"),s=parseFloat(r.getAttribute("rx")??"0"),a=parseFloat(r.getAttribute("ry")??"0");if(!s&&!a)continue;const o=[];for(let c=0;c<=360;c+=12){const h=Math.tan(c/360*Math.PI),l=s*(1-h**2)/(1+h**2),u=a*2*h/(1+h**2);o.push([i+l,n+u])}return{element:r,points:o,shapeType:"ellipse"}}case"line":{const i=parseFloat(r.getAttribute("x0")??"0"),n=parseFloat(r.getAttribute("y0")??"0"),s=parseFloat(r.getAttribute("x1")??"0"),a=parseFloat(r.getAttribute("y1")??"0");if(i===s&&n===a)continue;return{element:r,points:[[i,n],[s,a]],shapeType:"polyline"}}case"polygon":case"polyline":{const i=((t=r.getAttribute("points"))==null?void 0:t.split(" ").map(s=>s.split(",").map(parseFloat)))??[];if(!i.length)continue;let n="polyline";return r.tagName.toLowerCase()==="polygon"&&(i.push(i[0]),n="polygon"),{element:r,points:i,shapeType:n}}case"rect":{const i=parseFloat(r.getAttribute("x")??"0"),n=parseFloat(r.getAttribute("y")??"0"),s=parseFloat(r.getAttribute("width")??"0"),a=parseFloat(r.getAttribute("height")??"0");if(!s||!a)continue;return{element:r,points:[[i,n],[i+s,n],[i+s,n+a],[i,n+a],[i,n]],shapeType:"rect"}}default:continue}return null}function Bu(e){const t=[];for(let r=0;r<e.length;r++){const i=t[t.length-1]??[0,0],n=e[r];switch(n[0]){case"M":case"L":t.push([n[1],n[2]]);continue;case"C":t.push(...Du({x:i[0],y:i[1]},{x:n[1],y:n[2]},{x:n[3],y:n[4]},{x:n[5],y:n[6]}).map(s=>[s.x,s.y]).slice(1));continue;case"Q":t.push(...Nu({x:i[0],y:i[1]},{x:n[1],y:n[2]},{x:n[3],y:n[4]}).map(s=>[s.x,s.y]).slice(1));continue}}return t}function qu(e){const t={};if(e.hasAttribute("fill")?(t.fill=e.getAttribute("fill"),e.removeAttribute("fill")):e.style&&e.style.fill&&(t.fill=e.style.fill),t.fill){const i=Sn.exec(t.fill);i&&(t.fillOpacity=parseFloat(i[4]),t.fill=`rgb(${i[1]}, ${i[2]}, ${i[3]})`)}if(e.hasAttribute("fill-opacity")?(t.fillOpacity=parseFloat(e.getAttribute("fill-opacity")),e.removeAttribute("fill-opacity")):e.style&&e.style.fillOpacity&&(t.fillOpacity=parseFloat(e.style.fillOpacity)),e.hasAttribute("stroke")?(t.stroke=e.getAttribute("stroke"),e.removeAttribute("stroke")):e.style&&e.style.stroke&&(t.stroke=e.style.stroke),t.stroke){const i=Sn.exec(t.stroke);i&&(t.strokeOpacity=parseFloat(i[4]),t.stroke=`rgb(${i[1]}, ${i[2]}, ${i[3]})`)}e.hasAttribute("stroke-opacity")?(t.strokeOpacity=parseFloat(e.getAttribute("stroke-opacity")),e.removeAttribute("stroke-opacity")):e.style&&e.style.strokeOpacity&&(t.strokeOpacity=parseFloat(e.style.strokeOpacity)),e.hasAttribute("stroke-width")?(t.strokeWidth=e.getAttribute("stroke-width"),e.removeAttribute("stroke-width")):e.style&&e.style.strokeWidth&&(t.strokeWidth=e.style.strokeWidth),e.hasAttribute("stroke-dasharray")?(t.strokeDasharray=e.getAttribute("stroke-dasharray"),e.removeAttribute("stroke-dasharray")):e.style&&e.style.strokeDasharray&&(t.strokeDasharray=e.style.strokeDasharray);let r=e;for(;r.tagName.toLowerCase()!=="svg";)if(r=r.parentElement,r===null)throw new Error("Could not find root SVG element");return{svg:r.outerHTML,style:Object.keys(t).length>0?t:void 0}}function Hu(e){return!!e&&e.type==="iiif:ImageApiSelector"&&e.type==="iiif:ImageApiSelector"}function be(e){if(e.iiifRenderingHints){const t=e.iiifRenderingHints;if(t.rotation){const r=Qu(`${t.rotation}`);if(r)if(e.selectors.length)for(const i of e.selectors)i.rotation=r;else e.selectors.push({type:"RotationSelector",rotation:r})}}else delete e.iiifRenderingHints;return e}function Qu(e){let t=parseFloat(e);return t&&e.startsWith("!")&&(t=360-t),t&&(t=t%360),t!==t?0:t||0}function Dt(e,t={}){if(Array.isArray(e))return Dt(e[0]);if(typeof e=="string"){const[r,i]=e.split("#");return i?Dt({type:"SpecificResource",source:{id:r,type:"Unknown"},selector:{type:"FragmentSelector",value:i}}):{type:"SpecificResource",source:{id:r,type:t.typeMap&&t.typeMap[r]||"Unknown"},selector:null,selectors:[]}}if(e.type==="Choice"||e.type==="List"||e.type==="Composite"||e.type==="Independents")return Dt(e.items[0]);if(!e.type&&"source"in e&&(e.type="SpecificResource"),e.type==="SpecificResource"){e.source.type==="Canvas"&&e.source.partOf&&typeof e.source.partOf=="string"&&(e.source.partOf=[{id:e.source.partOf,type:"Manifest"}]);const{selector:r,selectors:i}=e.selector?pr(e.selector,t):{selector:null,selectors:[]};return{type:"SpecificResource",source:e.source,selector:r,selectors:i}}if(e.id){e.type==="Canvas"&&e.partOf&&typeof e.partOf=="string"&&(e.partOf=[{id:e.partOf,type:"Manifest"}]);const[r,i]=e.id.split("#");return i?Dt({type:"SpecificResource",source:{...e,id:r},selector:{type:"FragmentSelector",value:i}}):{type:"SpecificResource",source:{...e,id:r},selector:null,selectors:[]}}return{type:"SpecificResource",source:e,selector:null,selectors:[]}}/** Code to "flatten" quadratic and cubic Bzier curves to polylines.
+ *
+ * All code in this module is based on JavaScript code by Raph Levien, published on his blog at
+ * https://raphlinus.github.io/.
+ * I merely changed the structure a bit, removed some unneeded parts and added some comments and type hints.
+ *
+ * Flattening of quadratic Bzier curves:
+ * - Article: https://raphlinus.github.io/graphics/curves/2019/12/23/flatten-quadbez.html
+ * - Code: https://github.com/raphlinus/raphlinus.github.io/blob/master/_posts/2019-12-23-flatten-quadbez.md?plain=1#L73-L212
+ *
+ * Flattening of cubic Bzier curves: https://levien.com/tmp/flatten.html
+ *
+ * Note that the code in this module has a different license than the rest of the package,
+ * due to the inclusion of Apache-licensed third party code.
+ *
+ * @license
+ * Copyright 2022 Johannes Baiter <johannes.baiter@gmail.com>
+ * Copyright 2019, 2022 Raph Levien <raph.levien@gmail.com>
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *     http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */var Gu=Object.defineProperty,Yu=(e,t,r)=>t in e?Gu(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,lr=(e,t,r)=>(Yu(e,typeof t!="symbol"?t+"":t,r),r);function gt(e){return e.endsWith("info.json")?e:e.endsWith("/")?`${e}info.json`:`${e}/info.json`}var Vu="http://library.stanford.edu/iiif/image-api/compliance.html#level0",$a="http://library.stanford.edu/iiif/image-api/compliance.html#level1",Fa="http://library.stanford.edu/iiif/image-api/compliance.html#level2",Ju="http://library.stanford.edu/iiif/image-api/conformance.html#level0",Ea="http://library.stanford.edu/iiif/image-api/conformance.html#level1",Ra="http://library.stanford.edu/iiif/image-api/conformance.html#level2",Xu="http://library.stanford.edu/iiif/image-api/1.1/compliance.html#level0",Ma="http://library.stanford.edu/iiif/image-api/1.1/compliance.html#level1",Na="http://library.stanford.edu/iiif/image-api/1.1/compliance.html#level2",Ku="http://library.stanford.edu/iiif/image-api/1.1/conformance.html#level0",Da="http://library.stanford.edu/iiif/image-api/1.1/conformance.html#level1",La="http://library.stanford.edu/iiif/image-api/1.1/conformance.html#level2",Zu="http://iiif.io/api/image/1/level0.json",ef="http://iiif.io/api/image/1/profiles/level0.json",Wa="http://iiif.io/api/image/1/level1.json",Ua="http://iiif.io/api/image/1/profiles/level1.json",za="http://iiif.io/api/image/1/level2.json",Ba="http://iiif.io/api/image/1/profiles/level2.json",tf="http://iiif.io/api/image/2/level0.json",rf="http://iiif.io/api/image/2/profiles/level0.json",qa="http://iiif.io/api/image/2/level1.json",Ha="http://iiif.io/api/image/2/profiles/level1.json",Qa="http://iiif.io/api/image/2/level2.json",Ga="http://iiif.io/api/image/2/profiles/level2.json",nf="level0",Ya="level1",Va="level2",sf="http://iiif.io/api/image/2/level0",Ja="http://iiif.io/api/image/2/level1",Xa="http://iiif.io/api/image/2/level2",af="https://iiif.io/api/image/1.1/compliance/#level0",Ka="https://iiif.io/api/image/1.1/compliance/#level1",Za="https://iiif.io/api/image/1.1/compliance/#level2",eo=[Xa,Fa,Ra,Na,La,za,Ba,Qa,Ga,Va,Za],to=[...eo,Ja,$a,Ea,Ma,Da,Wa,Ua,qa,Ha,Ya,Ka],of=[sf,Ja,Xa,Vu,$a,Fa,Ju,Ea,Ra,Xu,Ma,Na,Ku,Da,La,Zu,ef,Wa,Ua,za,Ba,tf,rf,qa,Ha,Qa,Ga,nf,Ya,Va,af,Ka,Za],cf={extraFormats:["jpg"],extraQualities:["default"],extraFeatures:["sizeByWhListed"]},lf={extraFormats:["jpg"],extraQualities:["default"],extraFeatures:["baseUriRedirect","cors","jsonldMediaType","regionByPx","regionSquare","sizeByWhListed","sizeByH","sizeByW","sizeByWh"]},hf={extraFormats:["jpg","png"],extraQualities:["default"],extraFeatures:["baseUriRedirect","cors","jsonldMediaType","regionByPct","regionByPx","regionSquare","rotationBy90s","sizeByWhListed","sizeByConfinedWh","sizeByH","sizeByPct","sizeByW","sizeByWh"]};function uf(e){return eo.indexOf(e)!==-1?hf:to.indexOf(e)!==-1?lf:cf}function ff(e){let t=e?Array.isArray(e.profile)?e.profile:[e.profile]:[],r={extraQualities:[],extraFormats:[],extraFeatures:[]};for(let i of t)if(typeof i=="string"&&(i=uf(i)),!!i){if(i.formats)for(let n of i.formats)r.extraFormats.indexOf(n)===-1&&r.extraFormats.push(n);if(i.qualities)for(let n of i.qualities)r.extraQualities.indexOf(n)===-1&&r.extraQualities.push(n);if(i.supports)for(let n of i.supports)r.extraFeatures.indexOf(n)===-1&&r.extraFeatures.push(n);if(i.maxHeight&&(r.maxHeight=i.maxHeight),i.maxWidth&&(r.maxWidth=i.maxWidth),i.maxArea&&(r.maxArea=i.maxArea),i.extraFormats)for(let n of i.extraFormats)r.extraFormats.indexOf(n)===-1&&r.extraFormats.push(n);if(i.extraQualities)for(let n of i.extraQualities)r.extraQualities.indexOf(n)===-1&&r.extraQualities.push(n);if(i.extraFeatures)for(let n of i.extraFeatures)r.extraFeatures.indexOf(n)===-1&&r.extraFeatures.push(n);i.maxHeight&&(r.maxHeight=i.maxHeight),i.maxWidth&&(r.maxWidth=i.maxWidth),i.maxArea&&(r.maxArea=i.maxArea)}if(e.extraFormats)for(let i of e.extraFormats)r.extraFormats.indexOf(i)===-1&&r.extraFormats.push(i);if(e.extraFeatures)for(let i of e.extraFeatures)r.extraFeatures.indexOf(i)===-1&&r.extraFeatures.push(i);if(e.extraQualities)for(let i of e.extraQualities)r.extraQualities.indexOf(i)===-1&&r.extraQualities.push(i);return r}function df(e){try{if(e==="full")return{full:!0};if(e==="square")return{square:!0};let t=e.startsWith("pct:"),r=e.substr(t?4:0).split(",").map(i=>parseFloat(i));return{x:r[0],y:r[1],w:r[2],h:r[3],percent:t}}catch{throw new Error("Expected 'full', 'square' or 'x,y,w,h'. Found "+e)}}function pf(e){let t={upscaled:!1,max:!1,confined:!1};if(e[0]==="^"&&(t.upscaled=!0,e=e.slice(1)),e==="max"||e==="full")return t.max=!0,t.serialiseAsFull=e==="full",t;if(e[0]==="!"&&(t.confined=!0,e=e.slice(1)),e[0]==="p")return t.percentScale=parseFloat(e.slice(4)),t;let r=e.split(",").map(i=>i.trim());return r.length&&typeof r[0]<"u"&&(r[0]!==""&&(t.width=parseInt(r[0],10)),typeof r[1]<"u"&&r[1]!==""?(t.height=parseInt(r[1],10),t.version=2):t.version=3),t}function gf(e){let t={angle:0};if(e[0]==="!"&&(t.mirror=!0,e=e.substr(1)),t.angle=parseFloat(e)%360,Number.isNaN(t.angle))throw new Error(`Invalid rotation ${e}`);return t}function mf(e,t=""){let r=e.match(/^(([a-zA-Z]+):\/\/([^/]+))?((.*)+)/);if(!r)throw new Error(`Invalid or unknown input ${e}`);let i=r[2],n=r[3],s=r[4];if(s[0]==="/"&&(s=s.substring(1)),t.length>0){if(t[0]==="/"&&(t=t.substring(1)),t!==s.substring(0,t.length))throw new Error(`Path does not start with prefix (path: ${s}, prefix: ${t})`);s=s.substring(t.length)}return{scheme:i,server:n,path:s,prefix:t}}function vf(e,t=""){let{path:r,scheme:i,server:n,prefix:s}=mf(e,t),a=(r||"").split("/").reverse(),[o,c,h,l,...u]=a,f=u.reverse().filter(Boolean).join("/");if(a.length===1||o==="")return{type:"base",scheme:i,server:n,prefix:s,identifier:f};if(o==="info.json"){let[,...d]=a;return{type:"info",scheme:i,server:n,prefix:s,identifier:d.reverse().filter(Boolean).join("/")}}let p=(o||"").split(".");if(typeof p[1]>"u"||typeof p[0]>"u"||typeof l>"u"||typeof h>"u"||typeof c>"u")throw new Error("Invalid image request");return{type:"image",scheme:i,server:n,prefix:s,identifier:f,originalPath:r,region:df(l),size:pf(h),rotation:gf(c),quality:p[0],format:p[1]}}function yf(e){let t=vf(gt(e.id));if(t.type!=="info")throw new Error("Invalid service URL");let r=ff(e);return{identifier:t.identifier,originalPath:"",server:t.server,prefix:t.prefix,scheme:t.scheme,type:"image",quality:r.extraQualities.indexOf("default")===-1?r.extraQualities[0]:"default",region:{full:!0},size:{max:!0,upscaled:!1,confined:!1},format:"jpg",rotation:{angle:0}}}function bf(e,t,r){let i=r.length,n=[];for(let s=0;s<i;s++){let a=r[s];if(a){let o=a.width;n.push(e/o)}}return n}function wf(e,t,r){let i=r.length,n=[];for(let s=0;s<i;s++){let a=r[s];a&&n.push({width:Math.floor(e/a),height:Math.floor(t/a)})}return n}function Z(e){if(e["@id"])return e["@id"];if(e.id)return e.id}function Nr(e){if(!e||!e.profile||!Z(e))return!1;let t=Array.isArray(e.profile)?e.profile:[e.profile];for(let r of t)if(typeof r=="string"&&of.indexOf(r)!==-1)return!0;return!1}function xf(e){if(!Nr(e))return!1;let t=Array.isArray(e.profile)?e.profile:[e.profile];for(let r of t)if(typeof r=="string"){if(to.indexOf(r)!==-1)return!0}else{let i=[...r.supports||[],...r.extraFeatures||[]];if(i.indexOf("regionByPx")!==-1&&(i.indexOf("sizeByW")!==-1||i.indexOf("sizeByWh")!==-1))return!0}return!1}function gr(e,t){if(t&&t.profile){let r=t.profile;if(r){let i=Array.isArray(r)?r:[r];return i.includes(`level${e}`)||i.includes(`http://iiif.io/api/image/2/level${e}.json`)||i.includes(`http://iiif.io/api/image/1/level${e}.json`)||i.includes(`http://iiif.io/api/image/1/profiles/level${e}.json`)}}return!1}function Si(e){return Nr(e)?gr(0,e)?0:gr(1,e)?1:gr(2,e)?2:null:null}function ro(e){return(e["@context"]?Array.isArray(e["@context"])?e["@context"]:[e["@context"]]:[]).indexOf("http://iiif.io/api/image/3/context.json")!==-1}function Cf(e){if(!xf(e))return[];let t=[],r=Array.isArray(e.profile)?e.profile:[e.profile],i=r.length;for(let n=0;n<i;n++){let s=r[n];if(s&&typeof s!="string"&&(s.maxHeight||s.maxWidth))return[{id:Z(e),type:"variable",minWidth:0,minHeight:0,maxHeight:s.maxHeight||s.maxWidth,maxWidth:s.maxWidth||s.maxHeight,level:Si(e),version:e["@context"]==="http://iiif.io/api/image/3/context.json"?3:2}]}if(e.tiles){let n=e.tiles.length;for(let s=0;s<n;s++){let a=e.tiles[s];a&&(a.height||a.width)&&t.push({id:Z(e),type:"variable",minHeight:0,minWidth:0,maxHeight:a.height||a.width,maxWidth:a.width,level:Si(e),version:ro(e)?3:2})}}return t}function An(e){let t=/^.*\/(full)\/(((\d+),(\d+)?)|max)\/(\d+)\/default\.(jpg|png|jpeg)$/,r=e.match(t);if(r&&r[4]&&r[5]){let i=r[1],n=parseInt(r[4],10),s=parseInt(r[5],10),a=r[7];if((i==="max"||i==="full")&&n&&s&&a)return{type:"fixed",id:e,height:s,width:n}}return{type:"unknown",id:e}}function Sf(e){if(e["@type"])return e["@type"];if(e.type)return e.type}function Af(e){if(typeof e=="string")return An(e);let t=Sf(e);if(t!=="Image"&&t!=="sc:Image")return null;let r=e,i=Z(r);return i?i&&r.width&&r.height?{id:i,type:"fixed",width:r.width,height:r.height,unsafe:!0}:An(i):null}function _f(e){return Nr(e)?(e&&e.sizes?e.sizes:[]).map(t=>({id:Z(e),type:"fixed-service",height:t.height,width:t.width,level:Si(e),version:ro(e)?3:2})):[]}function _n(e){let t=[],r=e.length;for(let i=0;i<r;i++){let n=e[i];if(!n)continue;let s=_f(n);s.length&&t.push(...s);let a=Cf(n);a.length&&t.push(...a)}return t}function io(e){let t=e.service?Array.isArray(e.service)?e.service:[e.service]:[],r=t.length,i=[];for(let n=0;n<r;n++)Nr(t[n])&&i.push(t[n]);return i}function Of(e,t=!0,r){let i=[],n=Af(e);if(n===null)return i;let s=e;if(i.push(n),t&&s&&s.width&&s.height){let a=[],o=io(s);for(let c of o){let h={id:Z(c),width:s.width,height:s.height};if(r.canLoadSync(h)){let l=r.loadServiceSync(h);l&&(l.height||(l.height=s.height),l.width||(l.width=s.width),a.push(..._n([l])))}}if(a.length)return i.push(...a),i}return s.service&&i.push(..._n(s.service)),i}function If({x:e=0,y:t=0,w:r,h:i,full:n,square:s,percent:a}){return"full"}function kf({max:e,percentScale:t,upscaled:r,confined:i,width:n,height:s,serialiseAsFull:a,version:o}){let c=[];return r&&c.push("^"),e?(c.push(a?"full":"max"),c.join("")):(i&&c.push("!"),t&&c.push(`pct:${t}`),n&&c.push(`${n}`),c.push(","),s&&o===3&&c.push(`${s}`),c.join(""))}function Tf(e){return`${e.mirror?"!":""}${(e.angle||0)%360}`}function Pf(e,t){let r=e.prefix.startsWith("/")?e.prefix.substr(1):e.prefix,i=`${e.scheme}://${e.server}/${r?`${r}/`:""}${e.identifier}`,{size:n}=e,{region:s,rotation:a,format:o,quality:c}=e;return[i,If(s),kf(n),Tf(a),`${c}.${o}`].filter(Boolean).join("/")}function Kr(e,t,r){let i=yf({"@context":e.version===3?"http://iiif.io/api/image/3/context.json":"http://iiif.io/api/image/2/context.json",id:gt(Z(e)),profile:e.level===null||typeof e.level>"u"?"level0":`level${e.level}`,type:e.version===3?"ImageService3":"ImageService2"});return i.size.max=!1,i.size.width=t,i.size.height=r,{id:Pf(i),type:"fixed",width:t,height:r||e.height/(e.width||1)*t,unsafe:e.width>t}}function Ct(e){let t=e.replace(/(https?:\/\/)?(www.)?/i,"");return t.indexOf("/")!==-1?t.split("/")[0]:t}function jf(e,t,r){let i=e.width?e.width:e.maxWidth;return r.height<=e.maxHeight&&r.width<=e.maxWidth&&r.height>=e.minHeight&&r.width>=e.minWidth&&(!t||Math.abs(r.width-i)<Math.abs(t.width-i))}function $f(e,t){let r=[],i=Object.assign({unsafeImageService:!1,atAnyCost:!0,fallback:!0,minHeight:64,minWidth:64,maxHeight:1/0,maxWidth:1/0,returnAllOptions:!1,preferFixedSize:!1,allowUnsafe:!1,explain:!1,height:0,width:0},e),n=(l,u=0)=>i.explain?r.push(new Array(u).fill(0).map(f=>"    ").join("")+l().trim()):void 0,s=[],a=[],o=null;n(()=>`Using configuration: ${JSON.stringify(i,null,2)}`);let c=(l,u)=>{if(n(()=>"Swapping choice",3),jf(i,u,l)){if(i.preferFixedSize&&l.unsafe){n(()=>`We found an image that was marked as unsafe, but it was the best size. (${l.id})`,4),a.push(l);return}i.returnAllOptions&&u&&a.push(u),n(()=>`We found a new image that was the best size. (${l.id})`,4),o=l}else i.returnAllOptions&&a.push(l)};n(()=>`The input shows we have ${t.length} list(s) of candidates to choose from.`);let h=t.length;for(let l=0;l<h;l++){let u=t[l]();n(()=>`Candidate group ${l}: ${JSON.stringify(u,null,2)}`,1);let f=u.length;n(()=>`Checking candidate list number ${l} and found ${f} potential ways of creating image(s)`,1);for(let p=0;p<f;p++){let d=u[p];if(n(()=>`-> Checking candidate ${p}`,1),d.type==="unknown"&&i.atAnyCost&&(n(()=>`We've found an unknown image type, adding this to the "last resort" list`,2),s.push(d)),d.type==="fixed"&&(d.unsafe?(n(()=>`We've found an unsafe fixed image type, adding this to the "last resort" list`,2),s.push(d)):(n(()=>"We've found a fixed size image, checking if it matches the request",2),c(d,o))),d.type==="fixed-service")if(i.unsafeImageService){n(()=>"Checking for an image from the tile source, without calculating the right height and width (unsafeImageService)",2);let m=Kr(d,i.width,i.height);c(m,o)}else{n(()=>"Checking for an image from the tile source 3",2);let m=Kr(d,d.width,d.height);c(m,o)}if(d.type==="variable"&&d.maxWidth){let m=Kr({id:d.id,width:d.maxWidth,height:d.maxWidth,level:d.level,version:d.version},d.maxWidth);c(m,o)}}if(o&&!i.returnAllOptions){if(o.unsafe||i.allowUnsafe)continue;n(()=>`We found a match in choice list number ${l}, no searching any more`);break}}return i.atAnyCost&&a.length===0?(n(()=>o?`We found an image! ${o.id} of type ${o.type}`:'We found no images, but "atAnyCost" is set, so returning that'),{best:o||s[0]||null,fallback:s.slice(1),log:r}):i.returnAllOptions?(n(()=>"Returning all options that we have found"),{best:(i.atAnyCost?o||a[0]||s[0]:o||a[0])||null,fallback:[...a,...s],log:r}):(n(()=>"Returning the best image that we found, and a fallback"),{best:o||a[0]||null,fallback:o?a:a.slice(1),log:r})}function Ff(e,t,r){let i=e>t?e:t,n=r.length,s=[];for(let a=0;a<n;a++){let o=r[a];if(!o||o.scaleFactors.length===0)continue;let c=o.scaleFactors[0];if(!c)continue;let h=i/c,l=[c];for(;h>=o.width;)c=c*2,l.push(c),h=h/2;s.push({...o,scaleFactors:l})}return s}function Ef(e,t){if(e.length!==t.length)return!1;if(e.length===0&&t.length===0)return!0;let r=e.length,i=!0;for(let s=0;s<r;s++){let a=e[s],o=t[s];if(a.width!==o.width||a.height!==o.height){i=!1;break}}if(i)return!0;let n=0;for(let s=0;s<r;s++)for(let a=0;a<r;a++)if(e[s].width===t[a].width&&e[s].height===t[a].height){n++;break}return n===r}function On(e){return gr(0,e)}var no=class{constructor(e={}){lr(this,"config",{verificationsRequired:1,approximateServices:!1,enableFetching:!0,disableThrottling:!1}),lr(this,"fetchingCount",0),lr(this,"imageServices",{}),lr(this,"knownImageServers",{}),this.config=Object.assign(this.config,e)}setConfig(e){Object.assign(this.config,e)}sample(e,t,r=!0){let i=Ct(Z(e)),n=gt(Z(e)),s=this.knownImageServers[i];return this.imageServices[n]=Object.assign(e,{real:!0}),!s&&e.tiles&&!On(e)?(this.knownImageServers[i]={verifications:0,malformed:!1,root:i,preLoaded:r,sampledId:Z(e),verified:!1,server:null,result:{context:e["@context"]||[],sampledProfile:e.profile,resourceServiceRatio:t&&e.height?t.height/e.height:1,sampledSizes:e.sizes||[],sizeRatios:bf(e.width,e.height,e.sizes||[]),sampledTiles:e.tiles||[]}},!0):this.verify(e)}preLoad(e,t=!0){this.knownImageServers[e.root]=e,t&&(this.knownImageServers[e.root].malformed=!1,this.knownImageServers[e.root].verifications=this.config.verificationsRequired)}predict(e,t=!1,r=!1){let i=e==null?void 0:e.source,n=Ct(Z(e)),s=this.knownImageServers[n],a=gt(Z(e));return this.imageServices[a]?this.imageServices[a]||null:!this.config.approximateServices||!s||!s.result||!(i!=null&&i.height||e.height)||!(i!=null&&i.width||e.width)||!r&&(s.malformed||s.verifications<this.config.verificationsRequired)||On(e.source)?null:(this.imageServices[a]||(this.imageServices[a]={"@context":s.result.context,"@id":Z(e),id:Z(e),protocol:"http://iiif.io/api/image",tiles:(i==null?void 0:i.tiles)||Ff(e.width,e.height,s.result.sampledTiles),sizes:(i==null?void 0:i.sizes)||wf(Math.round(e.width/s.result.resourceServiceRatio),Math.round(e.height/s.result.resourceServiceRatio),s.result.sizeRatios),profile:(i==null?void 0:i.profile)||s.result.sampledProfile,height:(i==null?void 0:i.height)||e.height,width:(i==null?void 0:i.width)||e.width,real:!1}),this.imageServices[a]||null)}async getThumbnailFromResource(e,t,r=!0,i=[]){let n=e?await this.getImageCandidates(e,r):[];return $f(t,[()=>i,()=>n])}async getImageCandidates(e,t=!0){let r=e;if(t&&r&&r.height&&r.width){let i=io(r);for(let n of i){let s={id:Z(n),width:n.width?n.width:r.width,height:n.height?n.height:r.height,source:n};await this.loadService(s)}}return Of(e,t,this)}async verify(e){let t=this.predict(e,!1,!0),r=await this.fetchService(Z(e));if(!t)return!1;let i=t.height===r.height&&t.width===r.width&&t["@context"]===r["@context"]&&Ef(t.sizes||[],r.sizes||[]);if(i){let n=Ct(Z(e)),s=this.knownImageServers[n];s&&(s.verifications+=1,s.verifications>=this.config.verificationsRequired&&(s.verified=!0))}return i}canLoadSync(e){let t=typeof e=="string"?e:Z(e),r=gt(t);if(this.imageServices[r])return!0;let i=this.knownImageServers[Ct(t)];return!!(i&&!i.malformed&&i.verifications>=this.config.verificationsRequired)}async markAsMalformed(e){return this.knownImageServers[Ct(Z(e))].malformed=!0,this.loadService(e,!0)}async fetchService(e,t=!1){let r=gt(e),i=this.imageServices[r];if(i&&(!t||i.real))return i;if(!this.config.enableFetching)throw new Error("Fetching is not enabled");let n=await this.fetch(r).then(s=>s.json());return!n.id&&n["@id"]&&(n.id=n["@id"]),n.id!==e&&(n.id=e,n["@id"]&&(n["@id"]=e)),this.imageServices[r]=Object.assign(n,{real:!0}),this.imageServices[r]}async fetch(e,t){return fetch(e,t)}async loadService(e,t=!1){if(!this.config.disableThrottling){let n=!0;for(;n;)if(this.fetchingCount>=this.config.verificationsRequired)await new Promise(s=>setTimeout(s,500));else{n=!1;break}}let r=this.knownImageServers[Ct(Z(e))];if(r&&!r.malformed&&!t){await r.result;let n=this.loadServiceSync(e);if(n)return n}this.fetchingCount++;let i=await this.fetchService(Z(e),t);return this.fetchingCount--,i.real&&this.sample(i,e),i}loadServiceSync(e){let t=gt(Z(e));return this.imageServices[t]?this.imageServices[t]:this.config.approximateServices?this.predict(e):null}};new no;const Rf=["commenting","describing","tagging","no-purpose"],Ai={commenting:"Comment",describing:"Description",tagging:"Tags"},H=Zh();function $e(e,t,r){let i=!1;r||(r="<<<SNIP>>>",i=!0);const n=_a(e,t[0]??"none",{defaultText:"",fallbackLanguages:t.slice(1),separator:r});return i?n.split(r).filter(s=>s.length>0):n}class Mf extends no{async fetch(t,r){return Kt(t,r)}}const Nf=Ou(H,{imageServiceLoader:new Mf}),{extractChoices:Df}=Ol(H);async function Lf(e,t){var i;return(i=(await Nf.getBestThumbnailAtSize(e,{maxWidth:t,maxHeight:t})).best)==null?void 0:i.id}function Wf(e){return e.type!==void 0&&["Dataset","Image","Video","Sound","Text","unknown"].indexOf(e.type)>=0&&e.profile!==void 0}function Uf(e){return typeof e.profile=="string"&&e.profile==="http://iiif.io/api/annex/services/physdim"}function In(e){var t;return typeof e=="string"?e.indexOf("level2")>=0:(((t=e.supports)==null?void 0:t.indexOf("sizeByWh"))??-1)>=0}function so(e){return H.get(e.annotations).flatMap(t=>H.get(t.items)).filter(t=>Array.isArray(t.motivation)?t.motivation.find(r=>Ai[r]!==void 0)!==void 0:Ai[t.motivation??"invalid"]!==void 0).map(t=>oo(t)).filter(t=>t!==void 0)}function ao(e){const t=qf(e),r=Qi(e);return{canvas:{id:e.id,type:"Canvas"},images:t,ocr:r?{id:r.id}:void 0,numAnnotations:so(e).length}}function kn(e){let t=Array.isArray(e.name)?e.name.join("; "):e.name;return t||(t=e.nickname??"unknown"),e.email?`${t} <${e.email}>`:t}function zf(e){return Array.isArray(e)?typeof e[0]=="string"?e.join("; "):e.map(t=>kn(t)).join("; "):typeof e=="string"?e:kn(e)}function oo(e,t){if(!e.target)return;const r=e.body.map(c=>H.get(c.id)),i=r.map(c=>c.creator).filter(c=>c!==void 0).map(zf),n=r.map(c=>c.modified).filter(c=>c!==void 0).map(c=>new Date(c).getTime());if(typeof e.target=="string")return;const s=H.get(e.target.map(c=>c.id)),a=Dt(s),o=Bf(r);if(!o)throw"No valid textual content in annotation.";return{id:e.id,target:a,markup:o,lastModified:n.length>0?new Date(Math.max(...n)):void 0,author:i.length>0?i.join("; "):void 0}}function Bf(e){const t={};for(const i of e){if(i.type!=="TextualBody"||i.format!=="text/plain"&&i.format!=="text/html"||i.value===void 0)continue;let{purpose:n}=i;Array.isArray(n)?n=n[0]:n||(n="no-purpose"),t[n]||(t[n]=[]),t[n].push(i.value)}if(Object.keys(t).length===0)return;const r=[];for(const i of Rf){const n=Ai[i];if(t[i])if(t[i].length>1){n&&r.push(`<p><b>${n}:</b></p>`);for(const s of t[i])r.push(`<p>${s}</p>`)}else r.push("<p>"),n&&r.push(`<b>${n}:</b> `),r.push(`${t[i][0]}</p>`)}if(r.length!==0)return r.join(`
+`)}function Tn(e){const[t,r]=e.split("#xywh=");if(r){const[i,n,s,a]=r.split(",").map(o=>parseInt(o,10));return{x:i,y:n,width:s,height:a}}else{const i=H.get(t);return{x:0,y:0,width:i.width,height:i.height}}}function Pn(e){var t,r,i;if(e.format==="image/jpeg")return"jpeg";if(e.format==="image/png")return"png";if(e.format===void 0){if((t=e.id)!=null&&t.endsWith(".jpg")||(r=e.id)!=null&&r.endsWith(".jpeg"))return"jpeg";if((i=e.id)!=null&&i.endsWith(".png"))return"png"}else return"unsupported"}function qf(e){const t=[],r=H.get(e.items).flatMap(n=>H.get(n.items));for(const n of r){const s=n.target;let a;if(typeof s=="string")a=Tn(s);else if(s.type==="SpecificResource")a=Tn(s.source.id);else{console.error(`Unsupported target type for annotation on canvas ${e.id}: '${s.type}'`);continue}const o=H.get(n.body.map(c=>c.id));for(const c of o)c.type==="Image"&&t.push({resource:c,...a,format:Pn(c),nativeWidth:c.width,nativeHeight:c.height})}const i=Df(r);if((i==null?void 0:i.type)!=="single-choice")return t;for(const n of i.items){const s=H.get(n.id);s.type==="Image"&&t.push({resource:s,x:0,y:0,width:e.width,height:e.height,nativeWidth:s.width,nativeHeight:s.height,format:Pn(s),choiceInfo:{enabled:n.selected??!1,optional:!0,label:s.label,visibleByDefault:n.selected??!1}})}return t}async function Hf(e,t,r){let i;const n=t.indexOf("<alto")>=0;n?i=wc(t,[r]):i=fc(t,[r]);const s=(await i.next()).value;return s?{...s,id:e,markup:t,mimeType:n?"application/xml+alto":"text/vnd.hocr+html"}:null}const Qf=e=>{var t;return e.format==="application/xml+alto"||((t=e.profile)==null?void 0:t.startsWith("http://www.loc.gov/standards/alto/"))},Gf=e=>{var t,r;return e.format==="text/vnd.hocr+html"||e.profile==="https://github.com/kba/hocr-spec/blob/master/hocr-spec.md"||((t=e.profile)==null?void 0:t.startsWith("http://kba.cloud/hocr-spec/"))||((r=e.profile)==null?void 0:r.startsWith("http://kba.github.io/hocr-spec/"))};async function Yf(e){const t=await Kt(e);if(t.status!==404){if(t.status!=200)throw new Error(`Could not fetch OCR markup from ${e}, got status code ${t.status}`);return t.text()}}function Qi(e){const t=H.get(e.seeAlso.map(r=>r.id));return t.push(...H.get(e.rendering.map(r=>r.id))),t.filter(Wf).find(r=>Qf(r)||Gf(r))}async function Vf(e,t){const r=Qi(e);if(r){const i=Ee==null?void 0:Ee.ocrFetchDuration.startTimer({ocr_host:new URL(r.id).host});let n;try{if(n=await Yf(r.id),i==null||i({status:"success",limited:jt.isLimited(r.id).toString()}),!n)return}catch(s){throw i==null||i({status:"error",limited:jt.isLimited(r.id).toString()}),s}return await Hf(r.id,n,{width:e.width,height:e.height})??void 0}}const co=300,Jf='application/ld+json;q=0.9;profile="http://iiif.io/api/presentation/3/context.json", application/ld+json;q=0.7;profile="http://iiif.io/api/presentation/2/context.json", application/ld+json;q=0.5, application/json;q=0.2';class Xf{constructor(){v(this,"hostMutexes",new Map);v(this,"callbacks",[])}getMutex(t){return this.hostMutexes.get(t)}limitHost(t){const r=new Xo;return this.hostMutexes.set(t,r),this.callbacks.forEach(i=>i(t,!0)),r}unlimitHost(t){this.hostMutexes.delete(t),this.callbacks.forEach(r=>r(t,!1))}subscribe(t){return this.callbacks.push(t),this.callbacks.length-1}unsubscribe(t){this.callbacks.splice(t,1)}isLimited(t){return this.hostMutexes.has(new URL(t).host)}}const jt=new Xf,jn=new Set;async function Kt(e,t={},r=3){const{host:i}=new URL(e);let n=jt.getMutex(i),s=-1,a,o=5e3,c={...t};jn.has(i)&&(c.credentials="include");const h=await(n==null?void 0:n.acquire());try{do{if(a=await fetch(e,c),a.ok){c.credentials==="include"&&jn.add(i);break}if((a.status==401||a.status==403)&&c.credentials!=="include"){c.credentials="include";continue}s++;const l=a==null?void 0:a.headers.get("retry-after");bt(l)?Number.isInteger(l)?o=Number.parseInt(l,10)*1e3:o=Date.parse(l)-Date.now():o=Math.pow(Math.random()*2*o,s);const u=m=>[m,`x-${m}`,`x-${m.replace("ratelimit","rate-limit")}`].map(y=>a==null?void 0:a.headers.get(y)).filter(bt).map(y=>Number.parseInt(y,10)).find(y=>y!=null),f=u("ratelimit-limit"),p=u("ratelimit-remaining"),d=u("ratelimit-reset");if(f!==void 0&&p!==void 0&&d!==void 0){n=jt.limitHost(i);const m=d/(f-p);p>0?o=2*p*m*1e3:o=m*1e3}await new Promise(m=>setTimeout(m,o+100))}while(s<r)}finally{n&&await new Promise(l=>setTimeout(l,o+100)),h==null||h()}return a}function Kf(e,t=1){let r;const i=e.id!==void 0,n=e.maxWidth??e.width;let s=Math.floor(t*n);const a=e.width/e.height,o=Array.isArray(e.profile)?e.profile.find(In)!==void 0:In(e.profile);if(t<1&&!o)e.sizes?(s=Math.min(...e.sizes.map(c=>Math.abs(s-c.width))),r=`${s},`):r=`${n},`;else if(t==1)if(r=i||e.maxWidth||e.maxArea?"max":"full",e.maxWidth)s=e.maxWidth;else if(e.maxHeight)s=Math.round(a*e.maxHeight);else if(e.maxArea){const c=e.width*e.height,h=e.maxArea/c;s=Math.round(h*e.width)}else s=e.width;else r=`${s},`;return{iiifSize:r,width:s,height:s/a}}function Gi(e){const t=e.find(Uf);if(!t)return null;const{physicalScale:r,physicalUnits:i}=t;let n;return i==="in"?n=1/r:i==="mm"?n=25.4/r:i==="cm"?n=2.54/r:n=co,n}function hr(e){return e.cause!==void 0}async function Zf(e,{scaleFactor:t,abortSignal:r,sizeOnly:i=!1}){var p,d,m;if(r!=null&&r.aborted)throw O.debug("Abort signalled, aborting before initiating image data fetching."),new Error("Aborted due to client request",{cause:{type:"abort"}});if(e.type!=="Image")throw new Error(`Can only fetch image resources, got ${e.type}`);let n;"service"in e&&(n=(p=e.service)==null?void 0:p.find(g=>{var y,b;return(((y=g==null?void 0:g.type)==null?void 0:y.startsWith("ImageService"))??!1)||(((b=g==null?void 0:g["@type"])==null?void 0:b.startsWith("ImageService"))??!1)}));let s,a,o=!1;if(n){n.width||(n=await td(n));const g=Kf(n,t);a=`${n.id??n["@id"]}/full/${g.iiifSize}/0/default.jpg`,s=Gi(n.service??[])??void 0,s&&(s=s*(g.width/n.width)),g.width<n.width&&(o=!0)}else if(e.id&&["image/jpeg","image/png"].indexOf(e.format??"unknown")>=0)a=e.id;else return O.error(`No JPEG or PNG image identifier for resource ${e.id} could be found!`),null;let c,h,l=!0,u=null;const f=Ee==null?void 0:Ee.imageFetchDuration.startTimer({iiif_host:new URL(a).host});try{const g=await Kt(a,{method:"GET",signal:r});if(g.status>=400)throw new Error(`Failed to fetch page image from ${a}, server returned status ${g.status}`,{cause:{type:"http-status",status:g.status}});if(r!=null&&r.aborted)throw new Error("Aborted due to client request",{cause:{type:"abort"}});if(h=Number.parseInt(g.headers.get("Content-Length")??"-1"),c=i&&h>=0?void 0:await g.arrayBuffer(),(d=g.headers.get("Content-Type"))!=null&&d.startsWith("image/jpeg"))u="jpeg";else if((m=g.headers.get("Content-Type"))!=null&&m.startsWith("image/png"))u="png";else throw new Error("Unsupported image content type",{cause:{type:"content-type"}});h<0&&(h=(c==null?void 0:c.byteLength)??-1),f==null||f({status:"success",limited:jt.isLimited(a).toString()})}catch(g){if(typeof document<"u"&&await ed(a)){if(!i)throw new Error("Data requested, but no CORS for the image endpoint",{cause:{type:"no-cors"}})}else throw O.error(`Failed to fetch image data from ${a}: ${g}`),f==null||f({status:"error",limited:jt.isLimited(a).toString(),cause:g instanceof Error?g.cause.type:g}),g;l=!1,O.warn(`Failed to fetch image data from ${a}: CORS headers missing!`);const b=await Kt(a,{method:"GET",signal:r,mode:"no-cors"});h=Number.parseInt(b.headers.get("Content-Length")??"-1")}return{data:c,ppi:s,numBytes:h,corsAvailable:l,format:u,downscaled:o}}async function ed(e){const t=document.createElement("img");return t.src=e,new Promise(r=>{t.onload=()=>r(!0),t.onerror=()=>r(!1)})}async function lo(e){const t=e.start;if(!t)return;let r,i;if(typeof t=="string"){const[l,u]=t.split("#xywh=");if(!u)return l;r=l,i=`xywh=${u}`}else{if(t.type==="SpecificResource")return t.id;{const l=H.get(t.id);if(typeof l=="string"||l.type!=="FragmentSelector"){O.warn(`Unsupported selector type, cannot determine start canvas for ${e.id}`);return}const u=l;if(u.conformsTo!=="http://www.w3.org/TR/media-frags/"){O.warn(`Unsupported selector type, cannot determine start canvas for ${e.id} (fragment selector type was ${u.conformsTo})`);return}r=u.value}}if(!i||!r){O.error(`Couldn't parse either canvas identifier or selector for ${e.id} start canvas.`);return}const[n,s,a,o]=i.substring(5).split(",").map(l=>Number.parseInt(l,10)),c=H.get(r),h=Gi(c.service)??co;return{id:r,ppi:h,dimensions:{width:c.width,height:c.height},position:{x:n,y:s,width:a,height:o}}}async function ho(e,t,{scaleFactor:r,ppiOverride:i,abortSignal:n,sizeOnly:s=!1}){const a=t.map(f=>f.resource).map(f=>Zf(f,{scaleFactor:r,abortSignal:n,sizeOnly:s})),o=await Promise.allSettled(a),c=o.reduce((f,p,d)=>{if(p.status!=="fulfilled"||p.value===null)return f;const m=t[d];return f.push({...m,...p.value}),f},[]),h=o.filter(f=>f.status==="rejected").map((f,p)=>({...t[p],cause:f.reason})),l=i;i||Gi(e.service);let u;if(!s)try{u=await Vf(e,void 0)}catch(f){O.warn(`Failed to fetch text for canvas ${e.id}: ${f}`)}return{canvas:e,images:c,imageFailures:h,ppi:l,text:u,annotations:so(e)}}async function Yi(e){try{return await(await fetch(e,{headers:{Accept:Jf}})).json()}catch{return await(await fetch(e)).json()}}async function td(e){const t=`${e["@id"]??e.id}/info.json`;return await(await fetch(t)).json()}function Vi(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var uo={exports:{}};(function(e){var t=Object.prototype.hasOwnProperty,r="~";function i(){}Object.create&&(i.prototype=Object.create(null),new i().__proto__||(r=!1));function n(c,h,l){this.fn=c,this.context=h,this.once=l||!1}function s(c,h,l,u,f){if(typeof l!="function")throw new TypeError("The listener must be a function");var p=new n(l,u||c,f),d=r?r+h:h;return c._events[d]?c._events[d].fn?c._events[d]=[c._events[d],p]:c._events[d].push(p):(c._events[d]=p,c._eventsCount++),c}function a(c,h){--c._eventsCount===0?c._events=new i:delete c._events[h]}function o(){this._events=new i,this._eventsCount=0}o.prototype.eventNames=function(){var h=[],l,u;if(this._eventsCount===0)return h;for(u in l=this._events)t.call(l,u)&&h.push(r?u.slice(1):u);return Object.getOwnPropertySymbols?h.concat(Object.getOwnPropertySymbols(l)):h},o.prototype.listeners=function(h){var l=r?r+h:h,u=this._events[l];if(!u)return[];if(u.fn)return[u.fn];for(var f=0,p=u.length,d=new Array(p);f<p;f++)d[f]=u[f].fn;return d},o.prototype.listenerCount=function(h){var l=r?r+h:h,u=this._events[l];return u?u.fn?1:u.length:0},o.prototype.emit=function(h,l,u,f,p,d){var m=r?r+h:h;if(!this._events[m])return!1;var g=this._events[m],y=arguments.length,b,w;if(g.fn){switch(g.once&&this.removeListener(h,g.fn,void 0,!0),y){case 1:return g.fn.call(g.context),!0;case 2:return g.fn.call(g.context,l),!0;case 3:return g.fn.call(g.context,l,u),!0;case 4:return g.fn.call(g.context,l,u,f),!0;case 5:return g.fn.call(g.context,l,u,f,p),!0;case 6:return g.fn.call(g.context,l,u,f,p,d),!0}for(w=1,b=new Array(y-1);w<y;w++)b[w-1]=arguments[w];g.fn.apply(g.context,b)}else{var F=g.length,x;for(w=0;w<F;w++)switch(g[w].once&&this.removeListener(h,g[w].fn,void 0,!0),y){case 1:g[w].fn.call(g[w].context);break;case 2:g[w].fn.call(g[w].context,l);break;case 3:g[w].fn.call(g[w].context,l,u);break;case 4:g[w].fn.call(g[w].context,l,u,f);break;default:if(!b)for(x=1,b=new Array(y-1);x<y;x++)b[x-1]=arguments[x];g[w].fn.apply(g[w].context,b)}}return!0},o.prototype.on=function(h,l,u){return s(this,h,l,u,!1)},o.prototype.once=function(h,l,u){return s(this,h,l,u,!0)},o.prototype.removeListener=function(h,l,u,f){var p=r?r+h:h;if(!this._events[p])return this;if(!l)return a(this,p),this;var d=this._events[p];if(d.fn)d.fn===l&&(!f||d.once)&&(!u||d.context===u)&&a(this,p);else{for(var m=0,g=[],y=d.length;m<y;m++)(d[m].fn!==l||f&&!d[m].once||u&&d[m].context!==u)&&g.push(d[m]);g.length?this._events[p]=g.length===1?g[0]:g:a(this,p)}return this},o.prototype.removeAllListeners=function(h){var l;return h?(l=r?r+h:h,this._events[l]&&a(this,l)):(this._events=new i,this._eventsCount=0),this},o.prototype.off=o.prototype.removeListener,o.prototype.addListener=o.prototype.on,o.prefixed=r,o.EventEmitter=o,e.exports=o})(uo);var rd=uo.exports;const id=Vi(rd);class fo extends Error{constructor(t){super(t),this.name="TimeoutError"}}let nd=class extends Error{constructor(t){super(),this.name="AbortError",this.message=t}};const $n=e=>globalThis.DOMException===void 0?new nd(e):new DOMException(e),Fn=e=>{const t=e.reason===void 0?$n("This operation was aborted."):e.reason;return t instanceof Error?t:$n(t)};function sd(e,t,r,i){let n;const s=new Promise((a,o)=>{if(typeof t!="number"||Math.sign(t)!==1)throw new TypeError(`Expected \`milliseconds\` to be a positive number, got \`${t}\``);if(t===Number.POSITIVE_INFINITY){a(e);return}if(i={customTimers:{setTimeout,clearTimeout},...i},i.signal){const{signal:c}=i;c.aborted&&o(Fn(c)),c.addEventListener("abort",()=>{o(Fn(c))})}n=i.customTimers.setTimeout.call(void 0,()=>{const c=`Promise timed out after ${t} milliseconds`,h=r instanceof Error?r:new fo(c);typeof e.cancel=="function"&&e.cancel(),o(h)},t),(async()=>{try{a(await e)}catch(c){o(c)}finally{i.customTimers.clearTimeout.call(void 0,n)}})()});return s.clear=()=>{clearTimeout(n),n=void 0},s}function ad(e,t,r){let i=0,n=e.length;for(;n>0;){const s=Math.trunc(n/2);let a=i+s;r(e[a],t)<=0?(i=++a,n-=s+1):n=s}return i}var lt=function(e,t,r,i){if(r==="a"&&!i)throw new TypeError("Private accessor was defined without a getter");if(typeof t=="function"?e!==t||!i:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return r==="m"?i:r==="a"?i.call(e):i?i.value:t.get(e)},We;class od{constructor(){We.set(this,[])}enqueue(t,r){r={priority:0,...r};const i={priority:r.priority,run:t};if(this.size&&lt(this,We,"f")[this.size-1].priority>=r.priority){lt(this,We,"f").push(i);return}const n=ad(lt(this,We,"f"),i,(s,a)=>a.priority-s.priority);lt(this,We,"f").splice(n,0,i)}dequeue(){const t=lt(this,We,"f").shift();return t==null?void 0:t.run}filter(t){return lt(this,We,"f").filter(r=>r.priority===t.priority).map(r=>r.run)}get size(){return lt(this,We,"f").length}}We=new WeakMap;var J=function(e,t,r,i,n){if(i==="m")throw new TypeError("Private method is not writable");if(i==="a"&&!n)throw new TypeError("Private accessor was defined without a setter");if(typeof t=="function"?e!==t||!n:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return i==="a"?n.call(e,r):n?n.value=r:t.set(e,r),r},I=function(e,t,r,i){if(r==="a"&&!i)throw new TypeError("Private accessor was defined without a getter");if(typeof t=="function"?e!==t||!i:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return r==="m"?i:r==="a"?i.call(e):i?i.value:t.get(e)},re,Qt,Gt,Je,Cr,Yt,mr,Ie,Lt,pe,vr,ge,Vt,Ve,yr,En,Rn,po,Mn,Nn,br,Zr,ei,Sr,go,wr;class mo extends Error{}class vo extends id{constructor(t){var r,i,n,s;if(super(),re.add(this),Qt.set(this,void 0),Gt.set(this,void 0),Je.set(this,0),Cr.set(this,void 0),Yt.set(this,void 0),mr.set(this,0),Ie.set(this,void 0),Lt.set(this,void 0),pe.set(this,void 0),vr.set(this,void 0),ge.set(this,0),Vt.set(this,void 0),Ve.set(this,void 0),yr.set(this,void 0),Object.defineProperty(this,"timeout",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),t={carryoverConcurrencyCount:!1,intervalCap:Number.POSITIVE_INFINITY,interval:0,concurrency:Number.POSITIVE_INFINITY,autoStart:!0,queueClass:od,...t},!(typeof t.intervalCap=="number"&&t.intervalCap>=1))throw new TypeError(`Expected \`intervalCap\` to be a number from 1 and up, got \`${(i=(r=t.intervalCap)===null||r===void 0?void 0:r.toString())!==null&&i!==void 0?i:""}\` (${typeof t.intervalCap})`);if(t.interval===void 0||!(Number.isFinite(t.interval)&&t.interval>=0))throw new TypeError(`Expected \`interval\` to be a finite number >= 0, got \`${(s=(n=t.interval)===null||n===void 0?void 0:n.toString())!==null&&s!==void 0?s:""}\` (${typeof t.interval})`);J(this,Qt,t.carryoverConcurrencyCount,"f"),J(this,Gt,t.intervalCap===Number.POSITIVE_INFINITY||t.interval===0,"f"),J(this,Cr,t.intervalCap,"f"),J(this,Yt,t.interval,"f"),J(this,pe,new t.queueClass,"f"),J(this,vr,t.queueClass,"f"),this.concurrency=t.concurrency,this.timeout=t.timeout,J(this,yr,t.throwOnTimeout===!0,"f"),J(this,Ve,t.autoStart===!1,"f")}get concurrency(){return I(this,Vt,"f")}set concurrency(t){if(!(typeof t=="number"&&t>=1))throw new TypeError(`Expected \`concurrency\` to be a number from 1 and up, got \`${t}\` (${typeof t})`);J(this,Vt,t,"f"),I(this,re,"m",Sr).call(this)}async add(t,r={}){return r={timeout:this.timeout,throwOnTimeout:I(this,yr,"f"),...r},new Promise((i,n)=>{I(this,pe,"f").enqueue(async()=>{var s,a,o;J(this,ge,(a=I(this,ge,"f"),a++,a),"f"),J(this,Je,(o=I(this,Je,"f"),o++,o),"f");try{if(!((s=r.signal)===null||s===void 0)&&s.aborted)throw new mo("The task was aborted.");let c=t({signal:r.signal});r.timeout&&(c=sd(Promise.resolve(c),r.timeout)),r.signal&&(c=Promise.race([c,I(this,re,"m",go).call(this,r.signal)]));const h=await c;i(h),this.emit("completed",h)}catch(c){if(c instanceof fo&&!r.throwOnTimeout){i();return}n(c),this.emit("error",c)}finally{I(this,re,"m",po).call(this)}},r),this.emit("add"),I(this,re,"m",br).call(this)})}async addAll(t,r){return Promise.all(t.map(async i=>this.add(i,r)))}start(){return I(this,Ve,"f")?(J(this,Ve,!1,"f"),I(this,re,"m",Sr).call(this),this):this}pause(){J(this,Ve,!0,"f")}clear(){J(this,pe,new(I(this,vr,"f")),"f")}async onEmpty(){I(this,pe,"f").size!==0&&await I(this,re,"m",wr).call(this,"empty")}async onSizeLessThan(t){I(this,pe,"f").size<t||await I(this,re,"m",wr).call(this,"next",()=>I(this,pe,"f").size<t)}async onIdle(){I(this,ge,"f")===0&&I(this,pe,"f").size===0||await I(this,re,"m",wr).call(this,"idle")}get size(){return I(this,pe,"f").size}sizeBy(t){return I(this,pe,"f").filter(t).length}get pending(){return I(this,ge,"f")}get isPaused(){return I(this,Ve,"f")}}Qt=new WeakMap,Gt=new WeakMap,Je=new WeakMap,Cr=new WeakMap,Yt=new WeakMap,mr=new WeakMap,Ie=new WeakMap,Lt=new WeakMap,pe=new WeakMap,vr=new WeakMap,ge=new WeakMap,Vt=new WeakMap,Ve=new WeakMap,yr=new WeakMap,re=new WeakSet,En=function(){return I(this,Gt,"f")||I(this,Je,"f")<I(this,Cr,"f")},Rn=function(){return I(this,ge,"f")<I(this,Vt,"f")},po=function(){var t;J(this,ge,(t=I(this,ge,"f"),t--,t),"f"),I(this,re,"m",br).call(this),this.emit("next")},Mn=function(){I(this,re,"m",ei).call(this),I(this,re,"m",Zr).call(this),J(this,Lt,void 0,"f")},Nn=function(){const t=Date.now();if(I(this,Ie,"f")===void 0){const r=I(this,mr,"f")-t;if(r<0)J(this,Je,I(this,Qt,"f")?I(this,ge,"f"):0,"f");else return I(this,Lt,"f")===void 0&&J(this,Lt,setTimeout(()=>{I(this,re,"m",Mn).call(this)},r),"f"),!0}return!1},br=function(){if(I(this,pe,"f").size===0)return I(this,Ie,"f")&&clearInterval(I(this,Ie,"f")),J(this,Ie,void 0,"f"),this.emit("empty"),I(this,ge,"f")===0&&this.emit("idle"),!1;if(!I(this,Ve,"f")){const t=!I(this,re,"a",Nn);if(I(this,re,"a",En)&&I(this,re,"a",Rn)){const r=I(this,pe,"f").dequeue();return r?(this.emit("active"),r(),t&&I(this,re,"m",Zr).call(this),!0):!1}}return!1},Zr=function(){I(this,Gt,"f")||I(this,Ie,"f")!==void 0||(J(this,Ie,setInterval(()=>{I(this,re,"m",ei).call(this)},I(this,Yt,"f")),"f"),J(this,mr,Date.now()+I(this,Yt,"f"),"f"))},ei=function(){I(this,Je,"f")===0&&I(this,ge,"f")===0&&I(this,Ie,"f")&&(clearInterval(I(this,Ie,"f")),J(this,Ie,void 0,"f")),J(this,Je,I(this,Qt,"f")?I(this,ge,"f"):0,"f"),I(this,re,"m",Sr).call(this)},Sr=function(){for(;I(this,re,"m",br).call(this););},go=async function(t){return new Promise((r,i)=>{t.addEventListener("abort",()=>{i(new mo("The task was aborted."))},{once:!0})})},wr=async function(t,r){return new Promise(i=>{const n=()=>{r&&!r()||(this.off(t,n),i())};this.on(t,n)})};var cd=function(t){for(var r=[],i=1;i<arguments.length;i++)r[i-1]=arguments[i];var n=[],s=typeof t=="string"?[t]:t.slice();s[s.length-1]=s[s.length-1].replace(/\r?\n([\t ]*)$/,"");for(var a=0;a<s.length;a++){var o=void 0;(o=s[a].match(/\n[\t ]+/g))&&n.push.apply(n,o)}if(n.length)for(var c=Math.min.apply(Math,n.map(function(u){return u.length-1})),h=new RegExp(`
+[	 ]{`+c+"}","g"),a=0;a<s.length;a++)s[a]=s[a].replace(h,`
+`);s[0]=s[0].replace(/^\r?\n/,"");for(var l=s[0],a=0;a<r.length;a++)l+=r[a]+s[a+1];return l};const ld=Vi(cd);var ue=Uint8Array,ve=Uint16Array,Ji=Int32Array,Dr=new ue([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),Lr=new ue([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),_i=new ue([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),yo=function(e,t){for(var r=new ve(31),i=0;i<31;++i)r[i]=t+=1<<e[i-1];for(var n=new Ji(r[30]),i=1;i<30;++i)for(var s=r[i];s<r[i+1];++s)n[s]=s-r[i]<<5|i;return{b:r,r:n}},bo=yo(Dr,2),wo=bo.b,Oi=bo.r;wo[28]=258,Oi[258]=28;var xo=yo(Lr,0),hd=xo.b,Dn=xo.r,Ii=new ve(32768);for(var G=0;G<32768;++G){var Ge=(G&43690)>>1|(G&21845)<<1;Ge=(Ge&52428)>>2|(Ge&13107)<<2,Ge=(Ge&61680)>>4|(Ge&3855)<<4,Ii[G]=((Ge&65280)>>8|(Ge&255)<<8)>>1}var Re=function(e,t,r){for(var i=e.length,n=0,s=new ve(t);n<i;++n)e[n]&&++s[e[n]-1];var a=new ve(t);for(n=1;n<t;++n)a[n]=a[n-1]+s[n-1]<<1;var o;if(r){o=new ve(1<<t);var c=15-t;for(n=0;n<i;++n)if(e[n])for(var h=n<<4|e[n],l=t-e[n],u=a[e[n]-1]++<<l,f=u|(1<<l)-1;u<=f;++u)o[Ii[u]>>c]=h}else for(o=new ve(i),n=0;n<i;++n)e[n]&&(o[n]=Ii[a[e[n]-1]++]>>15-e[n]);return o},it=new ue(288);for(var G=0;G<144;++G)it[G]=8;for(var G=144;G<256;++G)it[G]=9;for(var G=256;G<280;++G)it[G]=7;for(var G=280;G<288;++G)it[G]=8;var Zt=new ue(32);for(var G=0;G<32;++G)Zt[G]=5;var ud=Re(it,9,0),fd=Re(it,9,1),dd=Re(Zt,5,0),pd=Re(Zt,5,1),ti=function(e){for(var t=e[0],r=1;r<e.length;++r)e[r]>t&&(t=e[r]);return t},Oe=function(e,t,r){var i=t/8|0;return(e[i]|e[i+1]<<8)>>(t&7)&r},ri=function(e,t){var r=t/8|0;return(e[r]|e[r+1]<<8|e[r+2]<<16)>>(t&7)},Xi=function(e){return(e+7)/8|0},Co=function(e,t,r){return(r==null||r>e.length)&&(r=e.length),new ue(e.subarray(t,r))},gd=["unexpected EOF","invalid block type","invalid length/literal","invalid distance","stream finished","no stream handler",,"no callback","invalid UTF-8 data","extra field too long","date not in range 1980-2099","filename too long","stream finishing","invalid zip data"],ke=function(e,t,r){var i=new Error(t||gd[e]);if(i.code=e,Error.captureStackTrace&&Error.captureStackTrace(i,ke),!r)throw i;return i},md=function(e,t,r,i){var n=e.length,s=0;if(!n||t.f&&!t.l)return r||new ue(0);var a=!r,o=a||t.i!=2,c=t.i;a&&(r=new ue(n*3));var h=function(De){var le=r.length;if(De>le){var U=new ue(Math.max(le*2,De));U.set(r),r=U}},l=t.f||0,u=t.p||0,f=t.b||0,p=t.l,d=t.d,m=t.m,g=t.n,y=n*8;do{if(!p){l=Oe(e,u,1);var b=Oe(e,u+1,3);if(u+=3,b)if(b==1)p=fd,d=pd,m=9,g=5;else if(b==2){var A=Oe(e,u,31)+257,k=Oe(e,u+10,15)+4,C=A+Oe(e,u+5,31)+1;u+=14;for(var S=new ue(C),E=new ue(19),_=0;_<k;++_)E[_i[_]]=Oe(e,u+_*3,7);u+=k*3;for(var R=ti(E),V=(1<<R)-1,Q=Re(E,R,1),_=0;_<C;){var z=Q[Oe(e,u,V)];u+=z&15;var w=z>>4;if(w<16)S[_++]=w;else{var B=0,D=0;for(w==16?(D=3+Oe(e,u,3),u+=2,B=S[_-1]):w==17?(D=3+Oe(e,u,7),u+=3):w==18&&(D=11+Oe(e,u,127),u+=7);D--;)S[_++]=B}}var X=S.subarray(0,A),W=S.subarray(A);m=ti(X),g=ti(W),p=Re(X,m,1),d=Re(W,g,1)}else ke(1);else{var w=Xi(u)+4,F=e[w-4]|e[w-3]<<8,x=w+F;if(x>n){c&&ke(0);break}o&&h(f+F),r.set(e.subarray(w,x),f),t.b=f+=F,t.p=u=x*8,t.f=l;continue}if(u>y){c&&ke(0);break}}o&&h(f+131072);for(var Ae=(1<<m)-1,$=(1<<g)-1,q=u;;q=u){var B=p[ri(e,u)&Ae],ee=B>>4;if(u+=B&15,u>y){c&&ke(0);break}if(B||ke(2),ee<256)r[f++]=ee;else if(ee==256){q=u,p=null;break}else{var te=ee-254;if(ee>264){var _=ee-257,L=Dr[_];te=Oe(e,u,(1<<L)-1)+wo[_],u+=L}var de=d[ri(e,u)&$],_e=de>>4;de||ke(3),u+=de&15;var W=hd[_e];if(_e>3){var L=Lr[_e];W+=ri(e,u)&(1<<L)-1,u+=L}if(u>y){c&&ke(0);break}o&&h(f+131072);var Ne=f+te;if(f<W){var je=s-W,st=Math.min(W,Ne);for(je+f<0&&ke(3);f<st;++f)r[f]=i[je+f]}for(;f<Ne;++f)r[f]=r[f-W]}}t.l=p,t.p=q,t.b=f,t.f=l,p&&(l=1,t.m=m,t.d=d,t.n=g)}while(!l);return f!=r.length&&a?Co(r,0,f):r.subarray(0,f)},Le=function(e,t,r){r<<=t&7;var i=t/8|0;e[i]|=r,e[i+1]|=r>>8},Rt=function(e,t,r){r<<=t&7;var i=t/8|0;e[i]|=r,e[i+1]|=r>>8,e[i+2]|=r>>16},ii=function(e,t){for(var r=[],i=0;i<e.length;++i)e[i]&&r.push({s:i,f:e[i]});var n=r.length,s=r.slice();if(!n)return{t:Ao,l:0};if(n==1){var a=new ue(r[0].s+1);return a[r[0].s]=1,{t:a,l:1}}r.sort(function(x,A){return x.f-A.f}),r.push({s:-1,f:25001});var o=r[0],c=r[1],h=0,l=1,u=2;for(r[0]={s:-1,f:o.f+c.f,l:o,r:c};l!=n-1;)o=r[r[h].f<r[u].f?h++:u++],c=r[h!=l&&r[h].f<r[u].f?h++:u++],r[l++]={s:-1,f:o.f+c.f,l:o,r:c};for(var f=s[0].s,i=1;i<n;++i)s[i].s>f&&(f=s[i].s);var p=new ve(f+1),d=ki(r[l-1],p,0);if(d>t){var i=0,m=0,g=d-t,y=1<<g;for(s.sort(function(A,k){return p[k.s]-p[A.s]||A.f-k.f});i<n;++i){var b=s[i].s;if(p[b]>t)m+=y-(1<<d-p[b]),p[b]=t;else break}for(m>>=g;m>0;){var w=s[i].s;p[w]<t?m-=1<<t-p[w]++-1:++i}for(;i>=0&&m;--i){var F=s[i].s;p[F]==t&&(--p[F],++m)}d=t}return{t:new ue(p),l:d}},ki=function(e,t,r){return e.s==-1?Math.max(ki(e.l,t,r+1),ki(e.r,t,r+1)):t[e.s]=r},Ln=function(e){for(var t=e.length;t&&!e[--t];);for(var r=new ve(++t),i=0,n=e[0],s=1,a=function(c){r[i++]=c},o=1;o<=t;++o)if(e[o]==n&&o!=t)++s;else{if(!n&&s>2){for(;s>138;s-=138)a(32754);s>2&&(a(s>10?s-11<<5|28690:s-3<<5|12305),s=0)}else if(s>3){for(a(n),--s;s>6;s-=6)a(8304);s>2&&(a(s-3<<5|8208),s=0)}for(;s--;)a(n);s=1,n=e[o]}return{c:r.subarray(0,i),n:t}},Mt=function(e,t){for(var r=0,i=0;i<t.length;++i)r+=e[i]*t[i];return r},So=function(e,t,r){var i=r.length,n=Xi(t+2);e[n]=i&255,e[n+1]=i>>8,e[n+2]=e[n]^255,e[n+3]=e[n+1]^255;for(var s=0;s<i;++s)e[n+s+4]=r[s];return(n+4+i)*8},Wn=function(e,t,r,i,n,s,a,o,c,h,l){Le(t,l++,r),++n[256];for(var u=ii(n,15),f=u.t,p=u.l,d=ii(s,15),m=d.t,g=d.l,y=Ln(f),b=y.c,w=y.n,F=Ln(m),x=F.c,A=F.n,k=new ve(19),C=0;C<b.length;++C)++k[b[C]&31];for(var C=0;C<x.length;++C)++k[x[C]&31];for(var S=ii(k,7),E=S.t,_=S.l,R=19;R>4&&!E[_i[R-1]];--R);var V=h+5<<3,Q=Mt(n,it)+Mt(s,Zt)+a,z=Mt(n,f)+Mt(s,m)+a+14+3*R+Mt(k,E)+2*k[16]+3*k[17]+7*k[18];if(c>=0&&V<=Q&&V<=z)return So(t,l,e.subarray(c,c+h));var B,D,X,W;if(Le(t,l,1+(z<Q)),l+=2,z<Q){B=Re(f,p,0),D=f,X=Re(m,g,0),W=m;var Ae=Re(E,_,0);Le(t,l,w-257),Le(t,l+5,A-1),Le(t,l+10,R-4),l+=14;for(var C=0;C<R;++C)Le(t,l+3*C,E[_i[C]]);l+=3*R;for(var $=[b,x],q=0;q<2;++q)for(var ee=$[q],C=0;C<ee.length;++C){var te=ee[C]&31;Le(t,l,Ae[te]),l+=E[te],te>15&&(Le(t,l,ee[C]>>5&127),l+=ee[C]>>12)}}else B=ud,D=it,X=dd,W=Zt;for(var C=0;C<o;++C){var L=i[C];if(L>255){var te=L>>18&31;Rt(t,l,B[te+257]),l+=D[te+257],te>7&&(Le(t,l,L>>23&31),l+=Dr[te]);var de=L&31;Rt(t,l,X[de]),l+=W[de],de>3&&(Rt(t,l,L>>5&8191),l+=Lr[de])}else Rt(t,l,B[L]),l+=D[L]}return Rt(t,l,B[256]),l+D[256]},vd=new Ji([65540,131080,131088,131104,262176,1048704,1048832,2114560,2117632]),Ao=new ue(0),yd=function(e,t,r,i,n,s){var a=s.z||e.length,o=new ue(i+a+5*(1+Math.ceil(a/7e3))+n),c=o.subarray(i,o.length-n),h=s.l,l=(s.r||0)&7;if(t){l&&(c[0]=s.r>>3);for(var u=vd[t-1],f=u>>13,p=u&8191,d=(1<<r)-1,m=s.p||new ve(32768),g=s.h||new ve(d+1),y=Math.ceil(r/3),b=2*y,w=function(Ur){return(e[Ur]^e[Ur+1]<<y^e[Ur+2]<<b)&d},F=new Ji(25e3),x=new ve(288),A=new ve(32),k=0,C=0,S=s.i||0,E=0,_=s.w||0,R=0;S+2<a;++S){var V=w(S),Q=S&32767,z=g[V];if(m[Q]=z,g[V]=Q,_<=S){var B=a-S;if((k>7e3||E>24576)&&(B>423||!h)){l=Wn(e,c,0,F,x,A,C,E,R,S-R,l),E=k=C=0,R=S;for(var D=0;D<286;++D)x[D]=0;for(var D=0;D<30;++D)A[D]=0}var X=2,W=0,Ae=p,$=Q-z&32767;if(B>2&&V==w(S-$))for(var q=Math.min(f,B)-1,ee=Math.min(32767,S),te=Math.min(258,B);$<=ee&&--Ae&&Q!=z;){if(e[S+X]==e[S+X-$]){for(var L=0;L<te&&e[S+L]==e[S+L-$];++L);if(L>X){if(X=L,W=$,L>q)break;for(var de=Math.min($,L-2),_e=0,D=0;D<de;++D){var Ne=S-$+D&32767,je=m[Ne],st=Ne-je&32767;st>_e&&(_e=st,z=Ne)}}}Q=z,z=m[Q],$+=Q-z&32767}if(W){F[E++]=268435456|Oi[X]<<18|Dn[W];var De=Oi[X]&31,le=Dn[W]&31;C+=Dr[De]+Lr[le],++x[257+De],++A[le],_=S+X,++k}else F[E++]=e[S],++x[e[S]]}}for(S=Math.max(S,_);S<a;++S)F[E++]=e[S],++x[e[S]];l=Wn(e,c,h,F,x,A,C,E,R,S-R,l),h||(s.r=l&7|c[l/8|0]<<3,l-=7,s.h=g,s.p=m,s.i=S,s.w=_)}else{for(var S=s.w||0;S<a+h;S+=65535){var U=S+65535;U>=a&&(c[l/8|0]=h,U=a),l=So(c,l+1,e.subarray(S,U))}s.i=a}return Co(o,0,i+Xi(l)+n)},_o=function(){var e=1,t=0;return{p:function(r){for(var i=e,n=t,s=r.length|0,a=0;a!=s;){for(var o=Math.min(a+2655,s);a<o;++a)n+=i+=r[a];i=(i&65535)+15*(i>>16),n=(n&65535)+15*(n>>16)}e=i,t=n},d:function(){return e%=65521,t%=65521,(e&255)<<24|(e&65280)<<8|(t&255)<<8|t>>8}}},bd=function(e,t,r,i,n){if(!n&&(n={l:1},t.dictionary)){var s=t.dictionary.subarray(-32768),a=new ue(s.length+e.length);a.set(s),a.set(e,s.length),e=a,n.w=s.length}return yd(e,t.level==null?6:t.level,t.mem==null?n.l?Math.ceil(Math.max(8,Math.min(13,Math.log(e.length)))*1.5):20:12+t.mem,r,i,n)},Oo=function(e,t,r){for(;r;++t)e[t]=r,r>>>=8},wd=function(e,t){var r=t.level,i=r==0?0:r<6?1:r==9?3:2;if(e[0]=120,e[1]=i<<6|(t.dictionary&&32),e[1]|=31-(e[0]<<8|e[1])%31,t.dictionary){var n=_o();n.p(t.dictionary),Oo(e,2,n.d())}},xd=function(e,t){return((e[0]&15)!=8||e[0]>>4>7||(e[0]<<8|e[1])%31)&&ke(6,"invalid zlib data"),(e[1]>>5&1)==1&&ke(6,"invalid zlib data: "+(e[1]&32?"need":"unexpected")+" dictionary"),(e[1]>>3&4)+2};function Wt(e,t){t||(t={});var r=_o();r.p(e);var i=bd(e,t,t.dictionary?6:2,4);return wd(i,t),Oo(i,i.length-4,r.d()),i}function Cd(e,t){return md(e.subarray(xd(e),-4),{i:2},t,t)}var Sd=typeof TextDecoder<"u"&&new TextDecoder,Ad=0;try{Sd.decode(Ao,{stream:!0}),Ad=1}catch{}let Pe,er;typeof TextEncoder<"u"&&typeof TextDecoder<"u"?(Pe=new TextEncoder,er=new TextDecoder):(Pe=new tn.TextEncoder,er=new tn.TextDecoder);let Ar;Li()?Ar=Ho.webcrypto:Ar=crypto;const Io=(()=>{const e=new Uint8Array(4),t=new Uint32Array(e.buffer);return!((t[0]=1)&e[0])})();function Un(e){const t=new Uint8Array(e);if(Ar!==void 0)Ar.getRandomValues(t);else{const r=new Uint32Array(t.buffer);for(let i=0;i<r.length;i++)r[i]=Math.floor(Math.random()*2**32)}return t}async function ur(e){const t=e instanceof Uint8Array?e:Pe.encode(e);let r;if(Li())r=await new Promise((i,n)=>qo.deflate(t,(s,a)=>s?n(s):i(a)));else{if(typeof CompressionStream>"u")try{let s;return e instanceof Uint8Array?s=e:s=Pe.encode(e),r=Wt(s),Promise.resolve({stream:r,dict:{Length:r.length,Filter:"/FlateDecode"}})}catch(s){return O.warn(`Failed to use JS deflate implementation, data will be written uncompressed: ${s}`),Promise.resolve({stream:e,dict:{Length:e.length}})}const i=new CompressionStream("deflate"),n=new Blob([t]).stream().pipeThrough(i);r=new Uint8Array(await new Response(n).arrayBuffer())}return{dict:{Length:r.length,Filter:"/FlateDecode"},stream:r}}const zn=2;class Tt{constructor(t){v(this,"refObj");this.refObj=t}}function M(e){const t=typeof e=="number"?e:e.num;return new Tt(t)}function _d(e){for(let t=0,r=e.length;t<r;t++)if(e.charCodeAt(t)>127)return!0;return!1}function Ti(e,t=!0){const r=new Uint16Array(e.length+(t?1:0));for(let n=t?1:0;n<r.length;n++)r[n]=e.charCodeAt(n-(t?1:0));const i=new Uint8Array(r.buffer,r.byteOffset,r.byteLength);if(!Io)for(let n=t?2:0,s=i.length-1;n<s;n+=2){const a=i[n];i[n]=i[n+1],i[n+1]=a}return t&&(i[0]=254,i[1]=255),i}function Od(e){if(e>-1e21&&e<1e21)return Math.round(e*1e6)/1e6;throw new Error(`unsupported number: ${e}`)}function Se(e,t=0){if(typeof e=="string")return e[0]==="("&&e[e.length-1]===")"&&_d(e)?Se(Ti(e.substring(1,e.length-1))):e;if(e instanceof Uint8Array)return`<${Array.from(e).map(r=>r.toString(16).padStart(2,"0").toUpperCase()).join("")}>`;if(e instanceof Date)return`(${`D:${e.getUTCFullYear().toString(10).padStart(4,"0")}`+(e.getUTCMonth()+1).toString(10).padStart(2,"0")+e.getUTCDate().toString(10).padStart(2,"0")+e.getUTCHours().toString(10).padStart(2,"0")+e.getUTCMinutes().toString(10).padStart(2,"0")+e.getUTCSeconds().toString(10).padStart(2,"0")+"Z"})`;if(Array.isArray(e))return`[${e.map(r=>Se(r,t+1)).join(" ")}]`;if(e instanceof Tt){if(e.refObj===-1)throw new Error("Cannot serialize a deferred object reference");return`${e.refObj} 0 R`}else if({}.toString.call(e)==="[object Object]"){const r=" ".repeat(zn*t),i=r+" ".repeat(zn);return`<<
+${Object.entries(e).map(([n,s])=>`${i}/${n} ${Se(s,t+1)}`).join(`
+`)}
+${r}>>`}else return typeof e=="number"?Od(e).toString(10):`${e}`}class Id{constructor(t){v(this,"_writer");v(this,"bytesWritten",0);this._writer=t}write(t){return this.bytesWritten+=t.length,this._writer.write(t)}close(){return this._writer.close()}waitForDrain(){return this._writer.waitForDrain()}}class kd{constructor(t){v(this,"_writer");this._writer=t.getWriter()}write(t){return this._writer.write(t)}waitForDrain(){return this._writer.ready}close(){return this._writer.close()}}class Bn{constructor(){v(this,"_parts");v(this,"_blob");this._parts=[]}write(t){return this._blob?Promise.reject("Cannot write to closed BlobWriter."):(this._parts.push(t),Promise.resolve())}waitForDrain(){return this._blob?Promise.reject("Cannot wait on a closed BlobWriter."):Promise.resolve()}close(){return this._blob?Promise.reject("BlobWriter is already closed"):(this._blob=new Blob(this._parts),this._parts=[],Promise.resolve())}get blob(){if(!this._blob)throw"BlobWriter must be closed first!";return this._blob}}class Td{constructor(t){v(this,"_writable");v(this,"_drainWaiters",[]);this._writable=t,this._writable.on("drain",()=>{O.debug("Drained writer.");for(const r of this._drainWaiters)r();this._drainWaiters=[]}),this._writable.on("close",()=>{for(const r of this._drainWaiters)r();this._drainWaiters=[]})}async write(t){let r=!1;const i=new Promise((n,s)=>{this._writable.writable||s("Cannot write to closed NodeWriter."),r=!this._writable.write(t,a=>a?s(a):n())});return r?(O.debug("Waiting for writer to drain"),await this.waitForDrain()):await i}waitForDrain(){return new Promise(t=>this._drainWaiters.push(t))}close(){return new Promise(t=>this._writable.end(()=>t()))}}class Pd{constructor(t){v(this,"_buf");this._buf=t}read(t,r,i,n){const s=this._buf.subarray(i,i+n);return t.set(s,r),Promise.resolve(s.length)}size(){return Promise.resolve(this._buf.length)}}const kr=class kr{constructor(t){v(this,"palette");v(this,"imgData");v(this,"transparency");v(this,"text");v(this,"width");v(this,"height");v(this,"bits");v(this,"colorType");v(this,"compressionMethod");v(this,"filterMethod");v(this,"interlaceMethod");v(this,"colors");v(this,"hasAlphaChannel");v(this,"pixelBitlength");v(this,"colorSpace");v(this,"data");v(this,"pos");v(this,"decode",()=>{const t=new Uint8Array(this.width*this.height*4),r=this.decodePixels();return this.copyImageDataToBuffer(t,r),t});v(this,"copyImageDataToBuffer",(t,r)=>{let i=this.colors,n,s=this.hasAlphaChannel;this.palette.length&&(n=this.decodePalette(),i=4,s=!0);const a=t,o=a.length,c=n||r;let h=0,l=0;if(i===1)for(;h<o;){let u=n?r[h/4]*4:l;const f=c[u++];a[h++]=f,a[h++]=f,a[h++]=f,a[h++]=s?c[u++]:255,l=u}else for(;h<o;){let u=n?r[h/4]*4:l;a[h++]=c[u++],a[h++]=c[u++],a[h++]=c[u++],a[h++]=s?c[u++]:255,l=u}});v(this,"decodePixels",()=>{const t=Cd(this.imgData),r=this.width,i=this.height,n=this.pixelBitlength/8,s=n*this.width,a=new Uint8Array(s*this.height),o=t.length;let c=0;function h(l,u,f,p,d=!1){const m=Math.ceil((r-l)/f),g=Math.ceil((i-u)/p),y=n*m,b=d?a:new Uint8Array(y*g);let w=0,F=0;for(;w<g&&c<o;){switch(t[c++]){case 0:for(let x=0;x<y;x++)b[F++]=t[c++];break;case 1:for(let x=0;x<y;x++){const A=t[c++],k=x<n?0:b[F-n];b[F++]=(A+k)%256}break;case 2:for(let x=0;x<y;x++){const A=t[c++],k=(x-x%n)/n,C=(w-1)*y+k*n+x%n,S=w&&b[C];b[F++]=(S+A)%256}break;case 3:for(let x=0;x<y;x++){const A=t[c++],k=(x-x%n)/n,C=x<n?0:b[F-n],S=(w-1)*y+k*n+x%n,E=w&&b[S];b[F++]=(A+Math.floor((C+E)/2))%256}break;case 4:for(let x=0;x<y;x++){const A=t[c++],k=(x-x%n)/n,C=x<n?0:b[F-n];let S,E;if(w===0)S=E=0;else{const B=(w-1)*y+k*n+x%n,D=(w-1)*y+(k-1)*n+x%n;S=b[B],E=k&&b[D]}const _=C+S-E,R=Math.abs(_-C),V=Math.abs(_-S),Q=Math.abs(_-E);let z;R<=V&&R<=Q?z=C:V<=Q?z=S:z=E,b[F++]=(A+z)%256}break;default:throw new Error(`Invalid filter algorithm: ${t[c-1]}`)}if(!d){let x=((u+w*p)*r+l)*n,A=w*y;for(let k=0;k<m;k++){for(let C=0;C<n;C++)a[x++]=b[A++];x+=(f-1)*n}}w++}}return this.interlaceMethod===0?h(0,0,1,1,!0):(h(0,0,8,8),h(4,0,8,8),h(0,4,4,8),h(2,0,4,4),h(0,2,2,4),h(1,0,2,2),h(0,1,1,2)),a});v(this,"read",t=>{const r=[];for(let i=0;i<t;i++)r[i]=this.data[this.pos++];return r});v(this,"readUInt32",()=>{const t=this.data[this.pos++]<<24,r=this.data[this.pos++]<<16,i=this.data[this.pos++]<<8,n=this.data[this.pos++];return t|r|i|n});v(this,"decodePalette",()=>{const t=this.palette,r=this.transparency.indexed||[],i=new Uint8Array(r.length+t.length);let n=0,s=0;for(let a=0;a<t.length;a++){i[n++]=t[a],i[n++]=t[a+1],i[n++]=t[a+2];const o=r[s++];i[n++]=o!==void 0?o:255}return i});this.data=t,this.pos=8,this.palette=[];const r=[];for(this.transparency={},this.text={};;){const i=this.readUInt32();let n="";for(let s=0;s<4;s++)n+=String.fromCharCode(this.data[this.pos++]);switch(n){case"IHDR":{this.width=this.readUInt32(),this.height=this.readUInt32(),this.bits=this.data[this.pos++],this.colorType=this.data[this.pos++],this.compressionMethod=this.data[this.pos++],this.filterMethod=this.data[this.pos++],this.interlaceMethod=this.data[this.pos++];break}case"PLTE":{this.palette=this.read(i);break}case"IDAT":{for(let s=0;s<i;s++)r.push(this.data[this.pos++]);break}case"tRNS":{switch(this.transparency={},this.colorType){case 3:{if(this.transparency.indexed=this.read(i),255-this.transparency.indexed.length>0)for(let a=0;a<255;a++)this.transparency.indexed.push(255);break}case 0:{this.transparency.grayscale=this.read(i)[0];break}case 2:{this.transparency.rgb=this.read(i);break}}break}case"tEXt":{const s=this.read(i),a=s.indexOf(0),o=String.fromCharCode(...s.slice(0,a));this.text[o]=String.fromCharCode(...s.slice(a+1));break}case"IEND":{const s={0:1,3:1,4:1,2:3,6:3};this.colors=s[this.colorType],this.hasAlphaChannel=[4,6].includes(this.colorType);const a=this.colors+(this.hasAlphaChannel?1:0);this.pixelBitlength=this.bits*a,this.colorSpace={1:"DeviceGray",3:"DeviceRGB"}[this.colors],this.imgData=new Uint8Array(r);return}default:this.pos+=i}if(this.pos+=4,this.pos>this.data.length)throw new Error("Incomplete or corrupt PNG file")}}};v(kr,"load",t=>new kr(t));let Pi=kr;function Nt(e,t=0){const r=new Uint16Array(e.slice(t,t+2).buffer)[0];return Io?r:(r&255)<<8|r>>8&255}class Ki{static open(t){if(t.length>2&&t[0]===255&&t[1]===216)return new tr(t);if(t.length>8&&t[0]===137&&t[1]===80&&t[2]===78&&t[3]===71&&t[4]===13&&t[5]===10&&t[6]===26&&t[7]===10)return new jd(t);throw new Error("Unknown image format.")}}const mt=class mt extends Ki{constructor(r){super();v(this,"data");v(this,"bits");v(this,"width");v(this,"height");v(this,"colorSpace");let i;if(this.data=r,Nt(this.data,0)!==65496)throw"SOI not found in JPEG";let n=2;for(;n<this.data.length&&(i=Nt(this.data,n),n+=2,!mt.MARKERS.includes(i));)n+=Nt(this.data,n);if(!i||!mt.MARKERS.includes(i))throw"Invalid JPEG.";n+=2,this.bits=this.data[n++],this.height=Nt(this.data,n),n+=2,this.width=Nt(this.data,n),n+=2;const s=this.data[n++];if([1,3,4].indexOf(s)<0)throw"Bad number of channels, only 1, 3 or 4 are supported";this.colorSpace=mt.COLOR_SPACE_MAP[s]}toObjects(r){const i={Type:"/XObject",Subtype:"/Image",BitsPerComponent:this.bits,Width:this.width,Height:this.height,ColorSpace:`/${this.colorSpace}`,Filter:"/DCTDecode",Length:this.data.length};return this.colorSpace==="DeviceCMYK"&&(i.Decode=[1,0,1,0,1,0,1,0]),[{num:r,data:Se(i),stream:this.data}]}};v(mt,"MARKERS",[65472,65473,65474,65475,65477,65478,65479,65480,65481,65482,65483,65484,65485,65486,65487]),v(mt,"COLOR_SPACE_MAP",{1:"DeviceGray",3:"DeviceRGB",4:"DeviceCMYK"});let tr=mt;class jd extends Ki{constructor(r,i){super();v(this,"label");v(this,"image");v(this,"width");v(this,"height");v(this,"imgData");this.label=i,this.image=new Pi(r),this.width=this.image.width,this.height=this.image.height,this.imgData=this.image.imgData}toObjects(r){let i=!1;const n=this.image.hasAlphaChannel,s=this.image.interlaceMethod===1,a=[];let o=r;const c={num:o++};a.push(c);const h={Type:"/XObject",Subtype:"/Image",BitsPerComponent:n?8:this.image.bits,Width:this.width,Height:this.height,Filter:"/FlateDecode"};if(n||(h.DecodeParms={Predictor:s?1:15,Colors:this.image.colors,BitsPerComponent:this.image.bits,Columns:this.width}),this.image.palette.length===0)h.ColorSpace=`/${this.image.colorSpace}`;else{const l={num:o++,data:Se({Length:this.image.palette.length}),stream:new Uint8Array(this.image.palette)};a.push(l),h.ColorSpace=["/Indexed","/DeviceRGB",this.image.palette.length/3-1,M(l)]}if(this.image.transparency.grayscale!=null){const l=this.image.transparency.grayscale;h.Mask=[l,l]}else if(this.image.transparency.rgb){const{rgb:l}=this.image.transparency,u=[];for(let f of l)u.push(f,f);h.Mask=u}else if(this.image.transparency.indexed){const l=this.loadIndexedAlphaChannel(o++);h.SMask=M(l),a.push(l),i=!0}else if(n){const[l,u]=this.splitAlphaChannel(o++);c.stream=Wt(l),h.Length=c.stream.length,h.SMask=M(u),a.push(u)}if(s&&!i&&!c.stream?(c.stream=Wt(this.image.decodePixels()),h.Length=c.stream.length):c.stream||(c.stream=this.imgData,h.Length=c.stream.length),c.data=Se(h),a.length<3)for(let l=a.length;l<3;l++)a.push({num:o++});return a}splitAlphaChannel(r){const i=this.image.decodePixels(),n=this.image.colors,s=this.width*this.height,a=new Uint8Array(s*n),o=new Uint8Array(s);let c=0,h=0,l=0;const u=i.length,f=this.image.bits===16?1:0;for(;c<u;){for(let d=0;d<n;d++)a[l++]=i[c++],c+=f;o[h++]=i[c++],c+=f}const p=Wt(o);return[a,{num:r,data:Se({Type:"/XObject",Subtype:"/Image",Width:this.width,Height:this.height,BitsPerComponent:8,Decode:[0,1],ColorSpace:"/DeviceGray",Filter:"/FlateDecode",Length:p.length}),stream:p}]}loadIndexedAlphaChannel(r){const i=this.image.decodePixels(),n=this.image.transparency.indexed,s=new Uint8Array(this.width*this.height);let a=0;for(let c=0,h=i.length;c<h;c++)s[a++]=n[i[c]];const o=Wt(s);return{num:r,data:Se({Type:"/XObject",Subtype:"/Image",Width:this.width,Height:this.height,BitsPerComponent:8,Decode:[0,1],ColorSpace:"/DeviceGray",Filter:"/FlateDecode",Length:o.length}),stream:o}}}Uint8Array.prototype.findLastIndex||(Uint8Array.prototype.findLastIndex=function(e){let t=this.length;for(;t--;)if(e(this[t],t,this))return t;return-1});const $d={n:`
+`,r:"\r",t:"	",b:"\b",f:"\f","(":"(",")":")","\\":"\\"};async function*ko(e,t,r){const i=new Uint8Array(r);if(t+=await e.read(i,0,t,i.length),!Fe(i,0,"xref"))throw"Invalid crossreference section, did not start with `xref` line.";const n=i.findIndex((u,f)=>Fe(i,f,"trailer")),s=er.decode(i.subarray(0,n)).split(/[\r ]?\n/).slice(1);let a;for(const u of s)if(u.length===18){if(!a)throw"Invalid crossreference section, entry outside of subsection.";const f=u.trim().split(" ");a.entries.push([Number.parseInt(f[0],10),Number.parseInt(f[1],10),f[2]==="n"])}else{if(a){if(a.numObjs!==a.entries.length)throw`Invalid subsection, expected ${a.numObjs} objects, found ${a.entries.length}!`;yield a,a=void 0}if(u.length===0||u.indexOf("trailer")>=0)break;const[f,p]=u.trimEnd().split(" ").map(d=>Number.parseInt(d,10));a={startNum:f,numObjs:p,entries:[]}}a&&(yield a);const o=i.subarray(n),c=o.findIndex((u,f)=>Fe(o,f,"<<")),h=o.findIndex((u,f)=>Fe(o,f,">>")),l=new ji(o.subarray(c,h+2)).read();if(l.Prev){const u=l.Prev;yield*ko(e,u,t-u)}}function Fe(e,t,r,i=!1){if(i){for(let n=r.length-1;n>=0;n--)if(e[t+n]!==r.charCodeAt(n))return!1}else for(let n=0;n<r.length;n++)if(e[t+n]!==r.charCodeAt(n))return!1;return!0}function St(e){return!isNaN(parseInt(e,10))}function fr(e){return e>=48&&e<=57||e>=65&&e<=70||e>=97&&e<=102}class ji{constructor(t){v(this,"start",0);v(this,"current",0);v(this,"buf");this.buf=t}getChar(){return String.fromCharCode(this.buf[this.current])}matchValue(t){return er.decode(this.buf.subarray(this.current,this.current+Pe.encode(t).length))===t}matchInteger(t=!0){this.start=this.current;let r,i=!0;const n=[];for(;!this.matchWhiteSpace(r=this.getChar())&&!this.matchDelimiter(r);){if(r==="+"||r==="-"){if(this.current-this.start>0){i=!1;break}}else if(!St(r)){i=!1;break}this.current++,n.push(r)}return t&&(this.current=this.start),i?n.join(""):void 0}read(){let t=this.getChar();switch(this.matchWhiteSpace(t)&&(this.skipWhiteSpace(),t=this.getChar()),this.getChar()){case"[":return this.readArray();case"<":return this.matchValue("<<")?this.readDict():this.readHexString();case"(":return this.readLiteralString();case"/":return this.readName();case"t":if(this.matchValue("true"))return this.current+=4,!0;throw new Error("Unexpected character while parsing");case"f":if(this.matchValue("false"))return this.current+=5,!1;throw new Error("Unexpected character while parsing");case"n":if(this.matchValue("null"))return this.current+=4,null;throw new Error("Unexpected character while parsing");case".":return this.readRealNumber();default:if(this.matchIndirectObject())return this.readIndirectObject();if(this.matchRealNumber())return this.readRealNumber();if(this.matchInteger())return this.readInteger();throw new Error(`Encountered unexpected character during parsing: '${t}'`)}}matchWhiteSpace(t){return t===" "||t==="\0"||t===`
+`||t==="\r"||t===`\r
+`||t=="\f"}readInteger(){const t=this.matchInteger(!1);if(t===void 0)throw new Error("Failed to read integer.");return Number.parseInt(t,10)}readIndirectObject(){const t=this.matchIndirectObject(!1);if(t===void 0)throw new Error("Failed to read indirect object");return new Tt(Number.parseInt(t.split(" ")[0]))}matchIndirectObject(t=!0){this.start=this.current;let r=this.getChar();const i=[],n=()=>{if(!St(r))return!1;for(i.push(r),this.current++;St(r=this.getChar());)i.push(r),this.current++;return!0},s=()=>this.skipWhiteSpace(),o=!n()||!s()||(i.push(" "),r=this.getChar(),!n())||!s()||(i.push(" "),this.getChar()!=="R")?!1:(i.push("R"),this.current++,!0);if(t&&(this.current=this.start),o)return i.join("")}matchRealNumber(t=!0){this.start=this.current;let r=!0,i=!1,n=!1;const s=[];let a;for(;;){if(a=this.getChar(),a==="."){if(n){r=!1;break}n=!0}else if(St(a))i=!0;else if(a==="-"||a==="+"){if(this.current-this.start>0)break}else break;s.push(a),this.current++}if(t&&(this.current=this.start),!!r&&i&&n)return s.join("")}readRealNumber(){const t=this.matchRealNumber(!1);if(!t)throw new Error("Could not read real number.");return Number.parseFloat(t)}skipWhiteSpace(){let t=!1;for(;!this.atEnd()&&this.matchWhiteSpace(this.getChar());)this.current++,t=!0;return t}atEnd(){return this.current>=this.buf.length}readName(){const t=["/"];this.current++;let r;for(;!this.matchWhiteSpace(r=this.getChar())&&!this.matchDelimiter(r);)if(r==="#"){const i=this.buf[this.current++],n=this.buf[this.current++];if(!fr(i)||!fr(n))throw new Error("Illegal character escape in name.");t.push(String.fromCharCode(Number.parseInt(String.fromCharCode(i)+String.fromCharCode(n),16)))}else t.push(r),this.current++;return t.join("")}matchDelimiter(t){return"[]{}()<>/%".indexOf(t)>=0}readHexString(){this.current++;const t=[];for(;this.getChar()!==">";){const r=this.buf[this.current++],i=this.buf[this.current++];if(!fr(r)||!fr(i))throw new Error(`Invalid value in hex string: '${r}${i}`);t.push(Number.parseInt(String.fromCharCode(r)+String.fromCharCode(i),16))}return this.current++,new Uint8Array(t)}readLiteralString(){this.current++;const t=[];let r=0,i;for(;;){if(i=this.getChar(),i==="\\"){if(this.current++,i=this.getChar(),St(i)){let n=[i];for(this.current++;St(this.getChar());)n.push(this.getChar()),this.current++;n.length>3&&(this.current-=n.length-3,n=n.slice(0,3)),this.current--,i=String.fromCharCode(Number.parseInt(n.join(""),8))}else if(i=$d[i],i===void 0)throw new Error(`Illegal escape sequence in string literal: '\\${i}`)}else if(i==="(")r++;else if(i===")"&&(r--,r<0))return this.current++,t.join("");t.push(i),this.current++}}readDict(){this.current+=2;const t={};for(this.skipWhiteSpace();this.getChar()!==">";){const r=this.read();if(typeof r!="string"||!r.startsWith("/"))throw new Error(`Dictionary keys must be name objects, got '${r}`);this.skipWhiteSpace();const i=this.read();i!==null&&(t[r.substring(1)]=i),this.skipWhiteSpace()}return this.current+=2,t}readArray(){this.current++;const t=[];for(;this.getChar()!=="]";)t.push(this.read()),this.skipWhiteSpace();return this.current++,t}}class Zi{constructor(t,r,i,n){v(this,"reader");v(this,"objectOffsets");v(this,"sortedOffsets");v(this,"pdfSize");v(this,"objGenerations");v(this,"infoNum");v(this,"catalogNum");this.reader=t,this.objectOffsets=r,this.sortedOffsets=[...r].sort((s,a)=>s-a),this.objGenerations=i,this.catalogNum=n.Root.refObj,this.infoNum=n.Info.refObj}static async parse(t){const r=new Uint8Array(1024),n=await t.size()-r.length;await t.read(r,0,n,r.length);const s=r.length-(r[r.length-1]===70?5:6);if(!Fe(r,s,"%%EOF"))throw"Invalid PDF, missing EOF comment at end of file";const a=r.findLastIndex((p,d)=>Fe(r,d,"startxref"));if(a<0)throw"Invalid PDF, missing startxref marker in file trailer.";const o=[],c=[],h=Number.parseInt(er.decode(r.subarray(a+9,s)).trim(),10),l=r.findLastIndex((p,d)=>Fe(r,d,">>"))+2,u=r.findLastIndex((p,d)=>Fe(r,d,"<<")),f=new ji(r.subarray(u,l)).read();for await(const{startNum:p,entries:d}of ko(t,h,n+l-h))for(const[m,[g,y,b]]of d.entries()){const w=m+p;(o[w]??-1)>y||(o[w]=y,b?c[w]=g:c[w]=-1)}if(c.length!==f.Size)throw`Trailer dictionary has different number of objects than crossreference tables, ${c.length} vs. ${f.Size}`;return new Zi(t,c,o,f)}async catalog(){const t=await this.getObject(this.catalogNum);if(!t)throw`Document has no catalog object (num as per trailer: ${this.catalogNum}!`;return t.data}async info(){const t=await this.getObject(this.infoNum);if(!t)throw`Document has no info object (num as per trailer: ${this.infoNum}!`;return t.data}async*_pagesFromPagesObj(t){for(const r of t.Kids){const i=await this.getObject(r.refObj,!0);if(!i)throw`Could not find Page object with number ${r.refObj}`;const n=i.data;n.Type==="/Pages"?yield*this._pagesFromPagesObj(n):yield i}}async*pages(){const r=(await this.catalog()).Pages,i=await this.getObject(r.refObj);if(!i)throw`Could not find Pages object with number ${r.refObj}`;const n=i.data;yield*this._pagesFromPagesObj(n)}async*annotations(t){const r=t.Annots;if(r)for(const i of r){const n=await this.getObject(i.refObj);if(!n)throw`Could not find Annotation object with number ${i.refObj}`;yield n.data}}resolveRef(t){return this.getObject(t.refObj,!0)}async getObject(t,r=!1){const i=this.objectOffsets[t];if(!i)return;this.pdfSize||(this.pdfSize=await this.reader.size());const n=this.sortedOffsets[this.sortedOffsets.indexOf(i)+1]??this.pdfSize,s=new Uint8Array(n-i);await this.reader.read(s,0,i,s.length);const a=s.findIndex((f,p)=>Fe(s,p,"endobj"));let o=s.findIndex((f,p)=>Fe(s,p,"stream"));o>=0&&(o+=6,s[o]===13?o+=2:o+=1);const c=`${t} ${this.objGenerations[t]} obj`,l=new ji(s.subarray(c.length,o<0?a:o)).read();if(typeof l!="object"||l===null)throw new Error("Illegal PDF object, does not start with a dictionary.");let u;if(r&&o>0){const f=l.Length;if(f===void 0)throw new Error("Illegal stream object, missing Length entry in object dictionary.");u=s.subarray(o,o+f)}return{num:t,data:l,stream:u}}}const en="0.2.6";function Fd({creationDate:e=new Date,filename:t,data:r,compressedData:i,extraDataLength:n}){const s=e.getHours()<<11|e.getDay()<<5|Math.round(e.getSeconds()/2),a=e.getFullYear()-1980<<9|e.getMonth()+1<<5|e.getDate(),o=ss(r),c=Pe.encode(t),h=i?i.length-2:r.length;return new Uint8Array([80,75,3,4,20,0,0,0,i?8:0,0,s&255,s>>8,a&255,a>>8,o&255,o>>8&255,o>>16&255,o>>24&255,h&255,h>>8&255,h>>16&255,h>>24&255,r.length&255,r.length>>8&255,r.length>>16&255,r.length>>24&255,c.length&255,c.length>>8,n+4&255,n+4>>8,...c,255,255,n&255,n>>8])}function Ed({files:e,trailingLength:t,offset:r}){const i=e.map(Rd),n=i.reduce((s,a)=>s+a.length,0);return i.push(new Uint8Array([80,75,5,6,0,0,0,0,e.length&255,e.length>>8,e.length&255,e.length>>8,n&255,n>>8&255,n>>16&255,n>>24&255,r&255,r>>8&255,r>>16&255,r>>24&255,t&255,t>>8])),new Uint8Array(i.reduce((s,a)=>(s.push(...a),s),[]))}function Rd(e){const t=e.creationDate.getHours()<<11|e.creationDate.getMinutes()<<5|Math.round(e.creationDate.getSeconds()/2),r=e.creationDate.getFullYear()-1980<<9|e.creationDate.getMonth()+1<<5|e.creationDate.getDate(),i=Pe.encode(e.filename);return new Uint8Array([80,75,1,2,23,3,20,0,0,0,e.deflated?8:0,0,t&255,t>>8,r&255,r>>8,e.crc32&255,e.crc32>>8&255,e.crc32>>16&255,e.crc32>>24&255,e.compressedDataLength&255,e.compressedDataLength>>8&255,e.compressedDataLength>>16&255,e.compressedDataLength>>24&255,e.dataLength&255,e.dataLength>>8&255,e.dataLength>>16&255,e.dataLength>>24&255,i.length&255,i.length>>8,0,0,0,0,0,0,0,0,0,0,164,129,e.localHeaderOffset&255,e.localHeaderOffset>>8&255,e.localHeaderOffset>>16&255,e.localHeaderOffset>>24&255,...i])}var To={exports:{}},Po={aliceblue:[240,248,255],antiquewhite:[250,235,215],aqua:[0,255,255],aquamarine:[127,255,212],azure:[240,255,255],beige:[245,245,220],bisque:[255,228,196],black:[0,0,0],blanchedalmond:[255,235,205],blue:[0,0,255],blueviolet:[138,43,226],brown:[165,42,42],burlywood:[222,184,135],cadetblue:[95,158,160],chartreuse:[127,255,0],chocolate:[210,105,30],coral:[255,127,80],cornflowerblue:[100,149,237],cornsilk:[255,248,220],crimson:[220,20,60],cyan:[0,255,255],darkblue:[0,0,139],darkcyan:[0,139,139],darkgoldenrod:[184,134,11],darkgray:[169,169,169],darkgreen:[0,100,0],darkgrey:[169,169,169],darkkhaki:[189,183,107],darkmagenta:[139,0,139],darkolivegreen:[85,107,47],darkorange:[255,140,0],darkorchid:[153,50,204],darkred:[139,0,0],darksalmon:[233,150,122],darkseagreen:[143,188,143],darkslateblue:[72,61,139],darkslategray:[47,79,79],darkslategrey:[47,79,79],darkturquoise:[0,206,209],darkviolet:[148,0,211],deeppink:[255,20,147],deepskyblue:[0,191,255],dimgray:[105,105,105],dimgrey:[105,105,105],dodgerblue:[30,144,255],firebrick:[178,34,34],floralwhite:[255,250,240],forestgreen:[34,139,34],fuchsia:[255,0,255],gainsboro:[220,220,220],ghostwhite:[248,248,255],gold:[255,215,0],goldenrod:[218,165,32],gray:[128,128,128],green:[0,128,0],greenyellow:[173,255,47],grey:[128,128,128],honeydew:[240,255,240],hotpink:[255,105,180],indianred:[205,92,92],indigo:[75,0,130],ivory:[255,255,240],khaki:[240,230,140],lavender:[230,230,250],lavenderblush:[255,240,245],lawngreen:[124,252,0],lemonchiffon:[255,250,205],lightblue:[173,216,230],lightcoral:[240,128,128],lightcyan:[224,255,255],lightgoldenrodyellow:[250,250,210],lightgray:[211,211,211],lightgreen:[144,238,144],lightgrey:[211,211,211],lightpink:[255,182,193],lightsalmon:[255,160,122],lightseagreen:[32,178,170],lightskyblue:[135,206,250],lightslategray:[119,136,153],lightslategrey:[119,136,153],lightsteelblue:[176,196,222],lightyellow:[255,255,224],lime:[0,255,0],limegreen:[50,205,50],linen:[250,240,230],magenta:[255,0,255],maroon:[128,0,0],mediumaquamarine:[102,205,170],mediumblue:[0,0,205],mediumorchid:[186,85,211],mediumpurple:[147,112,219],mediumseagreen:[60,179,113],mediumslateblue:[123,104,238],mediumspringgreen:[0,250,154],mediumturquoise:[72,209,204],mediumvioletred:[199,21,133],midnightblue:[25,25,112],mintcream:[245,255,250],mistyrose:[255,228,225],moccasin:[255,228,181],navajowhite:[255,222,173],navy:[0,0,128],oldlace:[253,245,230],olive:[128,128,0],olivedrab:[107,142,35],orange:[255,165,0],orangered:[255,69,0],orchid:[218,112,214],palegoldenrod:[238,232,170],palegreen:[152,251,152],paleturquoise:[175,238,238],palevioletred:[219,112,147],papayawhip:[255,239,213],peachpuff:[255,218,185],peru:[205,133,63],pink:[255,192,203],plum:[221,160,221],powderblue:[176,224,230],purple:[128,0,128],rebeccapurple:[102,51,153],red:[255,0,0],rosybrown:[188,143,143],royalblue:[65,105,225],saddlebrown:[139,69,19],salmon:[250,128,114],sandybrown:[244,164,96],seagreen:[46,139,87],seashell:[255,245,238],sienna:[160,82,45],silver:[192,192,192],skyblue:[135,206,235],slateblue:[106,90,205],slategray:[112,128,144],slategrey:[112,128,144],snow:[255,250,250],springgreen:[0,255,127],steelblue:[70,130,180],tan:[210,180,140],teal:[0,128,128],thistle:[216,191,216],tomato:[255,99,71],turquoise:[64,224,208],violet:[238,130,238],wheat:[245,222,179],white:[255,255,255],whitesmoke:[245,245,245],yellow:[255,255,0],yellowgreen:[154,205,50]},jo={exports:{}},Md=function(t){return!t||typeof t=="string"?!1:t instanceof Array||Array.isArray(t)||t.length>=0&&(t.splice instanceof Function||Object.getOwnPropertyDescriptor(t,t.length-1)&&t.constructor.name!=="String")},Nd=Md,Dd=Array.prototype.concat,Ld=Array.prototype.slice,qn=jo.exports=function(t){for(var r=[],i=0,n=t.length;i<n;i++){var s=t[i];Nd(s)?r=Dd.call(r,Ld.call(s)):r.push(s)}return r};qn.wrap=function(e){return function(){return e(qn(arguments))}};var Wd=jo.exports,Jt=Po,nr=Wd,$o=Object.hasOwnProperty,Fo=Object.create(null);for(var ni in Jt)$o.call(Jt,ni)&&(Fo[Jt[ni]]=ni);var ye=To.exports={to:{},get:{}};ye.get=function(e){var t=e.substring(0,3).toLowerCase(),r,i;switch(t){case"hsl":r=ye.get.hsl(e),i="hsl";break;case"hwb":r=ye.get.hwb(e),i="hwb";break;default:r=ye.get.rgb(e),i="rgb";break}return r?{model:i,value:r}:null};ye.get.rgb=function(e){if(!e)return null;var t=/^#([a-f0-9]{3,4})$/i,r=/^#([a-f0-9]{6})([a-f0-9]{2})?$/i,i=/^rgba?\(\s*([+-]?\d+)(?=[\s,])\s*(?:,\s*)?([+-]?\d+)(?=[\s,])\s*(?:,\s*)?([+-]?\d+)\s*(?:[,|\/]\s*([+-]?[\d\.]+)(%?)\s*)?\)$/,n=/^rgba?\(\s*([+-]?[\d\.]+)\%\s*,?\s*([+-]?[\d\.]+)\%\s*,?\s*([+-]?[\d\.]+)\%\s*(?:[,|\/]\s*([+-]?[\d\.]+)(%?)\s*)?\)$/,s=/^(\w+)$/,a=[0,0,0,1],o,c,h;if(o=e.match(r)){for(h=o[2],o=o[1],c=0;c<3;c++){var l=c*2;a[c]=parseInt(o.slice(l,l+2),16)}h&&(a[3]=parseInt(h,16)/255)}else if(o=e.match(t)){for(o=o[1],h=o[3],c=0;c<3;c++)a[c]=parseInt(o[c]+o[c],16);h&&(a[3]=parseInt(h+h,16)/255)}else if(o=e.match(i)){for(c=0;c<3;c++)a[c]=parseInt(o[c+1],0);o[4]&&(o[5]?a[3]=parseFloat(o[4])*.01:a[3]=parseFloat(o[4]))}else if(o=e.match(n)){for(c=0;c<3;c++)a[c]=Math.round(parseFloat(o[c+1])*2.55);o[4]&&(o[5]?a[3]=parseFloat(o[4])*.01:a[3]=parseFloat(o[4]))}else return(o=e.match(s))?o[1]==="transparent"?[0,0,0,0]:$o.call(Jt,o[1])?(a=Jt[o[1]],a[3]=1,a):null:null;for(c=0;c<3;c++)a[c]=tt(a[c],0,255);return a[3]=tt(a[3],0,1),a};ye.get.hsl=function(e){if(!e)return null;var t=/^hsla?\(\s*([+-]?(?:\d{0,3}\.)?\d+)(?:deg)?\s*,?\s*([+-]?[\d\.]+)%\s*,?\s*([+-]?[\d\.]+)%\s*(?:[,|\/]\s*([+-]?(?=\.\d|\d)(?:0|[1-9]\d*)?(?:\.\d*)?(?:[eE][+-]?\d+)?)\s*)?\)$/,r=e.match(t);if(r){var i=parseFloat(r[4]),n=(parseFloat(r[1])%360+360)%360,s=tt(parseFloat(r[2]),0,100),a=tt(parseFloat(r[3]),0,100),o=tt(isNaN(i)?1:i,0,1);return[n,s,a,o]}return null};ye.get.hwb=function(e){if(!e)return null;var t=/^hwb\(\s*([+-]?\d{0,3}(?:\.\d+)?)(?:deg)?\s*,\s*([+-]?[\d\.]+)%\s*,\s*([+-]?[\d\.]+)%\s*(?:,\s*([+-]?(?=\.\d|\d)(?:0|[1-9]\d*)?(?:\.\d*)?(?:[eE][+-]?\d+)?)\s*)?\)$/,r=e.match(t);if(r){var i=parseFloat(r[4]),n=(parseFloat(r[1])%360+360)%360,s=tt(parseFloat(r[2]),0,100),a=tt(parseFloat(r[3]),0,100),o=tt(isNaN(i)?1:i,0,1);return[n,s,a,o]}return null};ye.to.hex=function(){var e=nr(arguments);return"#"+dr(e[0])+dr(e[1])+dr(e[2])+(e[3]<1?dr(Math.round(e[3]*255)):"")};ye.to.rgb=function(){var e=nr(arguments);return e.length<4||e[3]===1?"rgb("+Math.round(e[0])+", "+Math.round(e[1])+", "+Math.round(e[2])+")":"rgba("+Math.round(e[0])+", "+Math.round(e[1])+", "+Math.round(e[2])+", "+e[3]+")"};ye.to.rgb.percent=function(){var e=nr(arguments),t=Math.round(e[0]/255*100),r=Math.round(e[1]/255*100),i=Math.round(e[2]/255*100);return e.length<4||e[3]===1?"rgb("+t+"%, "+r+"%, "+i+"%)":"rgba("+t+"%, "+r+"%, "+i+"%, "+e[3]+")"};ye.to.hsl=function(){var e=nr(arguments);return e.length<4||e[3]===1?"hsl("+e[0]+", "+e[1]+"%, "+e[2]+"%)":"hsla("+e[0]+", "+e[1]+"%, "+e[2]+"%, "+e[3]+")"};ye.to.hwb=function(){var e=nr(arguments),t="";return e.length>=4&&e[3]!==1&&(t=", "+e[3]),"hwb("+e[0]+", "+e[1]+"%, "+e[2]+"%"+t+")"};ye.to.keyword=function(e){return Fo[e.slice(0,3)]};function tt(e,t,r){return Math.min(Math.max(t,e),r)}function dr(e){var t=Math.round(e).toString(16).toUpperCase();return t.length<2?"0"+t:t}var Ud=To.exports;const rr=Po,Eo={};for(const e of Object.keys(rr))Eo[rr[e]]=e;const P={rgb:{channels:3,labels:"rgb"},hsl:{channels:3,labels:"hsl"},hsv:{channels:3,labels:"hsv"},hwb:{channels:3,labels:"hwb"},cmyk:{channels:4,labels:"cmyk"},xyz:{channels:3,labels:"xyz"},lab:{channels:3,labels:"lab"},lch:{channels:3,labels:"lch"},hex:{channels:1,labels:["hex"]},keyword:{channels:1,labels:["keyword"]},ansi16:{channels:1,labels:["ansi16"]},ansi256:{channels:1,labels:["ansi256"]},hcg:{channels:3,labels:["h","c","g"]},apple:{channels:3,labels:["r16","g16","b16"]},gray:{channels:1,labels:["gray"]}};var Ro=P;for(const e of Object.keys(P)){if(!("channels"in P[e]))throw new Error("missing channels property: "+e);if(!("labels"in P[e]))throw new Error("missing channel labels property: "+e);if(P[e].labels.length!==P[e].channels)throw new Error("channel and label counts mismatch: "+e);const{channels:t,labels:r}=P[e];delete P[e].channels,delete P[e].labels,Object.defineProperty(P[e],"channels",{value:t}),Object.defineProperty(P[e],"labels",{value:r})}P.rgb.hsl=function(e){const t=e[0]/255,r=e[1]/255,i=e[2]/255,n=Math.min(t,r,i),s=Math.max(t,r,i),a=s-n;let o,c;s===n?o=0:t===s?o=(r-i)/a:r===s?o=2+(i-t)/a:i===s&&(o=4+(t-r)/a),o=Math.min(o*60,360),o<0&&(o+=360);const h=(n+s)/2;return s===n?c=0:h<=.5?c=a/(s+n):c=a/(2-s-n),[o,c*100,h*100]};P.rgb.hsv=function(e){let t,r,i,n,s;const a=e[0]/255,o=e[1]/255,c=e[2]/255,h=Math.max(a,o,c),l=h-Math.min(a,o,c),u=function(f){return(h-f)/6/l+1/2};return l===0?(n=0,s=0):(s=l/h,t=u(a),r=u(o),i=u(c),a===h?n=i-r:o===h?n=1/3+t-i:c===h&&(n=2/3+r-t),n<0?n+=1:n>1&&(n-=1)),[n*360,s*100,h*100]};P.rgb.hwb=function(e){const t=e[0],r=e[1];let i=e[2];const n=P.rgb.hsl(e)[0],s=1/255*Math.min(t,Math.min(r,i));return i=1-1/255*Math.max(t,Math.max(r,i)),[n,s*100,i*100]};P.rgb.cmyk=function(e){const t=e[0]/255,r=e[1]/255,i=e[2]/255,n=Math.min(1-t,1-r,1-i),s=(1-t-n)/(1-n)||0,a=(1-r-n)/(1-n)||0,o=(1-i-n)/(1-n)||0;return[s*100,a*100,o*100,n*100]};function zd(e,t){return(e[0]-t[0])**2+(e[1]-t[1])**2+(e[2]-t[2])**2}P.rgb.keyword=function(e){const t=Eo[e];if(t)return t;let r=1/0,i;for(const n of Object.keys(rr)){const s=rr[n],a=zd(e,s);a<r&&(r=a,i=n)}return i};P.keyword.rgb=function(e){return rr[e]};P.rgb.xyz=function(e){let t=e[0]/255,r=e[1]/255,i=e[2]/255;t=t>.04045?((t+.055)/1.055)**2.4:t/12.92,r=r>.04045?((r+.055)/1.055)**2.4:r/12.92,i=i>.04045?((i+.055)/1.055)**2.4:i/12.92;const n=t*.4124+r*.3576+i*.1805,s=t*.2126+r*.7152+i*.0722,a=t*.0193+r*.1192+i*.9505;return[n*100,s*100,a*100]};P.rgb.lab=function(e){const t=P.rgb.xyz(e);let r=t[0],i=t[1],n=t[2];r/=95.047,i/=100,n/=108.883,r=r>.008856?r**(1/3):7.787*r+16/116,i=i>.008856?i**(1/3):7.787*i+16/116,n=n>.008856?n**(1/3):7.787*n+16/116;const s=116*i-16,a=500*(r-i),o=200*(i-n);return[s,a,o]};P.hsl.rgb=function(e){const t=e[0]/360,r=e[1]/100,i=e[2]/100;let n,s,a;if(r===0)return a=i*255,[a,a,a];i<.5?n=i*(1+r):n=i+r-i*r;const o=2*i-n,c=[0,0,0];for(let h=0;h<3;h++)s=t+1/3*-(h-1),s<0&&s++,s>1&&s--,6*s<1?a=o+(n-o)*6*s:2*s<1?a=n:3*s<2?a=o+(n-o)*(2/3-s)*6:a=o,c[h]=a*255;return c};P.hsl.hsv=function(e){const t=e[0];let r=e[1]/100,i=e[2]/100,n=r;const s=Math.max(i,.01);i*=2,r*=i<=1?i:2-i,n*=s<=1?s:2-s;const a=(i+r)/2,o=i===0?2*n/(s+n):2*r/(i+r);return[t,o*100,a*100]};P.hsv.rgb=function(e){const t=e[0]/60,r=e[1]/100;let i=e[2]/100;const n=Math.floor(t)%6,s=t-Math.floor(t),a=255*i*(1-r),o=255*i*(1-r*s),c=255*i*(1-r*(1-s));switch(i*=255,n){case 0:return[i,c,a];case 1:return[o,i,a];case 2:return[a,i,c];case 3:return[a,o,i];case 4:return[c,a,i];case 5:return[i,a,o]}};P.hsv.hsl=function(e){const t=e[0],r=e[1]/100,i=e[2]/100,n=Math.max(i,.01);let s,a;a=(2-r)*i;const o=(2-r)*n;return s=r*n,s/=o<=1?o:2-o,s=s||0,a/=2,[t,s*100,a*100]};P.hwb.rgb=function(e){const t=e[0]/360;let r=e[1]/100,i=e[2]/100;const n=r+i;let s;n>1&&(r/=n,i/=n);const a=Math.floor(6*t),o=1-i;s=6*t-a,a&1&&(s=1-s);const c=r+s*(o-r);let h,l,u;switch(a){default:case 6:case 0:h=o,l=c,u=r;break;case 1:h=c,l=o,u=r;break;case 2:h=r,l=o,u=c;break;case 3:h=r,l=c,u=o;break;case 4:h=c,l=r,u=o;break;case 5:h=o,l=r,u=c;break}return[h*255,l*255,u*255]};P.cmyk.rgb=function(e){const t=e[0]/100,r=e[1]/100,i=e[2]/100,n=e[3]/100,s=1-Math.min(1,t*(1-n)+n),a=1-Math.min(1,r*(1-n)+n),o=1-Math.min(1,i*(1-n)+n);return[s*255,a*255,o*255]};P.xyz.rgb=function(e){const t=e[0]/100,r=e[1]/100,i=e[2]/100;let n,s,a;return n=t*3.2406+r*-1.5372+i*-.4986,s=t*-.9689+r*1.8758+i*.0415,a=t*.0557+r*-.204+i*1.057,n=n>.0031308?1.055*n**(1/2.4)-.055:n*12.92,s=s>.0031308?1.055*s**(1/2.4)-.055:s*12.92,a=a>.0031308?1.055*a**(1/2.4)-.055:a*12.92,n=Math.min(Math.max(0,n),1),s=Math.min(Math.max(0,s),1),a=Math.min(Math.max(0,a),1),[n*255,s*255,a*255]};P.xyz.lab=function(e){let t=e[0],r=e[1],i=e[2];t/=95.047,r/=100,i/=108.883,t=t>.008856?t**(1/3):7.787*t+16/116,r=r>.008856?r**(1/3):7.787*r+16/116,i=i>.008856?i**(1/3):7.787*i+16/116;const n=116*r-16,s=500*(t-r),a=200*(r-i);return[n,s,a]};P.lab.xyz=function(e){const t=e[0],r=e[1],i=e[2];let n,s,a;s=(t+16)/116,n=r/500+s,a=s-i/200;const o=s**3,c=n**3,h=a**3;return s=o>.008856?o:(s-16/116)/7.787,n=c>.008856?c:(n-16/116)/7.787,a=h>.008856?h:(a-16/116)/7.787,n*=95.047,s*=100,a*=108.883,[n,s,a]};P.lab.lch=function(e){const t=e[0],r=e[1],i=e[2];let n;n=Math.atan2(i,r)*360/2/Math.PI,n<0&&(n+=360);const a=Math.sqrt(r*r+i*i);return[t,a,n]};P.lch.lab=function(e){const t=e[0],r=e[1],n=e[2]/360*2*Math.PI,s=r*Math.cos(n),a=r*Math.sin(n);return[t,s,a]};P.rgb.ansi16=function(e,t=null){const[r,i,n]=e;let s=t===null?P.rgb.hsv(e)[2]:t;if(s=Math.round(s/50),s===0)return 30;let a=30+(Math.round(n/255)<<2|Math.round(i/255)<<1|Math.round(r/255));return s===2&&(a+=60),a};P.hsv.ansi16=function(e){return P.rgb.ansi16(P.hsv.rgb(e),e[2])};P.rgb.ansi256=function(e){const t=e[0],r=e[1],i=e[2];return t===r&&r===i?t<8?16:t>248?231:Math.round((t-8)/247*24)+232:16+36*Math.round(t/255*5)+6*Math.round(r/255*5)+Math.round(i/255*5)};P.ansi16.rgb=function(e){let t=e%10;if(t===0||t===7)return e>50&&(t+=3.5),t=t/10.5*255,[t,t,t];const r=(~~(e>50)+1)*.5,i=(t&1)*r*255,n=(t>>1&1)*r*255,s=(t>>2&1)*r*255;return[i,n,s]};P.ansi256.rgb=function(e){if(e>=232){const s=(e-232)*10+8;return[s,s,s]}e-=16;let t;const r=Math.floor(e/36)/5*255,i=Math.floor((t=e%36)/6)/5*255,n=t%6/5*255;return[r,i,n]};P.rgb.hex=function(e){const r=(((Math.round(e[0])&255)<<16)+((Math.round(e[1])&255)<<8)+(Math.round(e[2])&255)).toString(16).toUpperCase();return"000000".substring(r.length)+r};P.hex.rgb=function(e){const t=e.toString(16).match(/[a-f0-9]{6}|[a-f0-9]{3}/i);if(!t)return[0,0,0];let r=t[0];t[0].length===3&&(r=r.split("").map(o=>o+o).join(""));const i=parseInt(r,16),n=i>>16&255,s=i>>8&255,a=i&255;return[n,s,a]};P.rgb.hcg=function(e){const t=e[0]/255,r=e[1]/255,i=e[2]/255,n=Math.max(Math.max(t,r),i),s=Math.min(Math.min(t,r),i),a=n-s;let o,c;return a<1?o=s/(1-a):o=0,a<=0?c=0:n===t?c=(r-i)/a%6:n===r?c=2+(i-t)/a:c=4+(t-r)/a,c/=6,c%=1,[c*360,a*100,o*100]};P.hsl.hcg=function(e){const t=e[1]/100,r=e[2]/100,i=r<.5?2*t*r:2*t*(1-r);let n=0;return i<1&&(n=(r-.5*i)/(1-i)),[e[0],i*100,n*100]};P.hsv.hcg=function(e){const t=e[1]/100,r=e[2]/100,i=t*r;let n=0;return i<1&&(n=(r-i)/(1-i)),[e[0],i*100,n*100]};P.hcg.rgb=function(e){const t=e[0]/360,r=e[1]/100,i=e[2]/100;if(r===0)return[i*255,i*255,i*255];const n=[0,0,0],s=t%1*6,a=s%1,o=1-a;let c=0;switch(Math.floor(s)){case 0:n[0]=1,n[1]=a,n[2]=0;break;case 1:n[0]=o,n[1]=1,n[2]=0;break;case 2:n[0]=0,n[1]=1,n[2]=a;break;case 3:n[0]=0,n[1]=o,n[2]=1;break;case 4:n[0]=a,n[1]=0,n[2]=1;break;default:n[0]=1,n[1]=0,n[2]=o}return c=(1-r)*i,[(r*n[0]+c)*255,(r*n[1]+c)*255,(r*n[2]+c)*255]};P.hcg.hsv=function(e){const t=e[1]/100,r=e[2]/100,i=t+r*(1-t);let n=0;return i>0&&(n=t/i),[e[0],n*100,i*100]};P.hcg.hsl=function(e){const t=e[1]/100,i=e[2]/100*(1-t)+.5*t;let n=0;return i>0&&i<.5?n=t/(2*i):i>=.5&&i<1&&(n=t/(2*(1-i))),[e[0],n*100,i*100]};P.hcg.hwb=function(e){const t=e[1]/100,r=e[2]/100,i=t+r*(1-t);return[e[0],(i-t)*100,(1-i)*100]};P.hwb.hcg=function(e){const t=e[1]/100,i=1-e[2]/100,n=i-t;let s=0;return n<1&&(s=(i-n)/(1-n)),[e[0],n*100,s*100]};P.apple.rgb=function(e){return[e[0]/65535*255,e[1]/65535*255,e[2]/65535*255]};P.rgb.apple=function(e){return[e[0]/255*65535,e[1]/255*65535,e[2]/255*65535]};P.gray.rgb=function(e){return[e[0]/100*255,e[0]/100*255,e[0]/100*255]};P.gray.hsl=function(e){return[0,0,e[0]]};P.gray.hsv=P.gray.hsl;P.gray.hwb=function(e){return[0,100,e[0]]};P.gray.cmyk=function(e){return[0,0,0,e[0]]};P.gray.lab=function(e){return[e[0],0,0]};P.gray.hex=function(e){const t=Math.round(e[0]/100*255)&255,i=((t<<16)+(t<<8)+t).toString(16).toUpperCase();return"000000".substring(i.length)+i};P.rgb.gray=function(e){return[(e[0]+e[1]+e[2])/3/255*100]};const _r=Ro;function Bd(){const e={},t=Object.keys(_r);for(let r=t.length,i=0;i<r;i++)e[t[i]]={distance:-1,parent:null};return e}function qd(e){const t=Bd(),r=[e];for(t[e].distance=0;r.length;){const i=r.pop(),n=Object.keys(_r[i]);for(let s=n.length,a=0;a<s;a++){const o=n[a],c=t[o];c.distance===-1&&(c.distance=t[i].distance+1,c.parent=i,r.unshift(o))}}return t}function Hd(e,t){return function(r){return t(e(r))}}function Qd(e,t){const r=[t[e].parent,e];let i=_r[t[e].parent][e],n=t[e].parent;for(;t[n].parent;)r.unshift(t[n].parent),i=Hd(_r[t[n].parent][n],i),n=t[n].parent;return i.conversion=r,i}var Gd=function(e){const t=qd(e),r={},i=Object.keys(t);for(let n=i.length,s=0;s<n;s++){const a=i[s];t[a].parent!==null&&(r[a]=Qd(a,t))}return r};const $i=Ro,Yd=Gd,_t={},Vd=Object.keys($i);function Jd(e){const t=function(...r){const i=r[0];return i==null?i:(i.length>1&&(r=i),e(r))};return"conversion"in e&&(t.conversion=e.conversion),t}function Xd(e){const t=function(...r){const i=r[0];if(i==null)return i;i.length>1&&(r=i);const n=e(r);if(typeof n=="object")for(let s=n.length,a=0;a<s;a++)n[a]=Math.round(n[a]);return n};return"conversion"in e&&(t.conversion=e.conversion),t}Vd.forEach(e=>{_t[e]={},Object.defineProperty(_t[e],"channels",{value:$i[e].channels}),Object.defineProperty(_t[e],"labels",{value:$i[e].labels});const t=Yd(e);Object.keys(t).forEach(i=>{const n=t[i];_t[e][i]=Xd(n),_t[e][i].raw=Jd(n)})});var Kd=_t;const Ot=Ud,me=Kd,Mo=["keyword","gray","hex"],Fi={};for(const e of Object.keys(me))Fi[[...me[e].labels].sort().join("")]=e;const Or={};function ce(e,t){if(!(this instanceof ce))return new ce(e,t);if(t&&t in Mo&&(t=null),t&&!(t in me))throw new Error("Unknown model: "+t);let r,i;if(e==null)this.model="rgb",this.color=[0,0,0],this.valpha=1;else if(e instanceof ce)this.model=e.model,this.color=[...e.color],this.valpha=e.valpha;else if(typeof e=="string"){const n=Ot.get(e);if(n===null)throw new Error("Unable to parse color from string: "+e);this.model=n.model,i=me[this.model].channels,this.color=n.value.slice(0,i),this.valpha=typeof n.value[i]=="number"?n.value[i]:1}else if(e.length>0){this.model=t||"rgb",i=me[this.model].channels;const n=Array.prototype.slice.call(e,0,i);this.color=Ei(n,i),this.valpha=typeof e[i]=="number"?e[i]:1}else if(typeof e=="number")this.model="rgb",this.color=[e>>16&255,e>>8&255,e&255],this.valpha=1;else{this.valpha=1;const n=Object.keys(e);"alpha"in e&&(n.splice(n.indexOf("alpha"),1),this.valpha=typeof e.alpha=="number"?e.alpha:0);const s=n.sort().join("");if(!(s in Fi))throw new Error("Unable to parse color from object: "+JSON.stringify(e));this.model=Fi[s];const{labels:a}=me[this.model],o=[];for(r=0;r<a.length;r++)o.push(e[a[r]]);this.color=Ei(o)}if(Or[this.model])for(i=me[this.model].channels,r=0;r<i;r++){const n=Or[this.model][r];n&&(this.color[r]=n(this.color[r]))}this.valpha=Math.max(0,Math.min(1,this.valpha)),Object.freeze&&Object.freeze(this)}ce.prototype={toString(){return this.string()},toJSON(){return this[this.model]()},string(e){let t=this.model in Ot.to?this:this.rgb();t=t.round(typeof e=="number"?e:1);const r=t.valpha===1?t.color:[...t.color,this.valpha];return Ot.to[t.model](r)},percentString(e){const t=this.rgb().round(typeof e=="number"?e:1),r=t.valpha===1?t.color:[...t.color,this.valpha];return Ot.to.rgb.percent(r)},array(){return this.valpha===1?[...this.color]:[...this.color,this.valpha]},object(){const e={},{channels:t}=me[this.model],{labels:r}=me[this.model];for(let i=0;i<t;i++)e[r[i]]=this.color[i];return this.valpha!==1&&(e.alpha=this.valpha),e},unitArray(){const e=this.rgb().color;return e[0]/=255,e[1]/=255,e[2]/=255,this.valpha!==1&&e.push(this.valpha),e},unitObject(){const e=this.rgb().object();return e.r/=255,e.g/=255,e.b/=255,this.valpha!==1&&(e.alpha=this.valpha),e},round(e){return e=Math.max(e||0,0),new ce([...this.color.map(ep(e)),this.valpha],this.model)},alpha(e){return e!==void 0?new ce([...this.color,Math.max(0,Math.min(1,e))],this.model):this.valpha},red:K("rgb",0,ae(255)),green:K("rgb",1,ae(255)),blue:K("rgb",2,ae(255)),hue:K(["hsl","hsv","hsl","hwb","hcg"],0,e=>(e%360+360)%360),saturationl:K("hsl",1,ae(100)),lightness:K("hsl",2,ae(100)),saturationv:K("hsv",1,ae(100)),value:K("hsv",2,ae(100)),chroma:K("hcg",1,ae(100)),gray:K("hcg",2,ae(100)),white:K("hwb",1,ae(100)),wblack:K("hwb",2,ae(100)),cyan:K("cmyk",0,ae(100)),magenta:K("cmyk",1,ae(100)),yellow:K("cmyk",2,ae(100)),black:K("cmyk",3,ae(100)),x:K("xyz",0,ae(95.047)),y:K("xyz",1,ae(100)),z:K("xyz",2,ae(108.833)),l:K("lab",0,ae(100)),a:K("lab",1),b:K("lab",2),keyword(e){return e!==void 0?new ce(e):me[this.model].keyword(this.color)},hex(e){return e!==void 0?new ce(e):Ot.to.hex(this.rgb().round().color)},hexa(e){if(e!==void 0)return new ce(e);const t=this.rgb().round().color;let r=Math.round(this.valpha*255).toString(16).toUpperCase();return r.length===1&&(r="0"+r),Ot.to.hex(t)+r},rgbNumber(){const e=this.rgb().color;return(e[0]&255)<<16|(e[1]&255)<<8|e[2]&255},luminosity(){const e=this.rgb().color,t=[];for(const[r,i]of e.entries()){const n=i/255;t[r]=n<=.04045?n/12.92:((n+.055)/1.055)**2.4}return .2126*t[0]+.7152*t[1]+.0722*t[2]},contrast(e){const t=this.luminosity(),r=e.luminosity();return t>r?(t+.05)/(r+.05):(r+.05)/(t+.05)},level(e){const t=this.contrast(e);return t>=7?"AAA":t>=4.5?"AA":""},isDark(){const e=this.rgb().color;return(e[0]*2126+e[1]*7152+e[2]*722)/1e4<128},isLight(){return!this.isDark()},negate(){const e=this.rgb();for(let t=0;t<3;t++)e.color[t]=255-e.color[t];return e},lighten(e){const t=this.hsl();return t.color[2]+=t.color[2]*e,t},darken(e){const t=this.hsl();return t.color[2]-=t.color[2]*e,t},saturate(e){const t=this.hsl();return t.color[1]+=t.color[1]*e,t},desaturate(e){const t=this.hsl();return t.color[1]-=t.color[1]*e,t},whiten(e){const t=this.hwb();return t.color[1]+=t.color[1]*e,t},blacken(e){const t=this.hwb();return t.color[2]+=t.color[2]*e,t},grayscale(){const e=this.rgb().color,t=e[0]*.3+e[1]*.59+e[2]*.11;return ce.rgb(t,t,t)},fade(e){return this.alpha(this.valpha-this.valpha*e)},opaquer(e){return this.alpha(this.valpha+this.valpha*e)},rotate(e){const t=this.hsl();let r=t.color[0];return r=(r+e)%360,r=r<0?360+r:r,t.color[0]=r,t},mix(e,t){if(!e||!e.rgb)throw new Error('Argument to "mix" was not a Color instance, but rather an instance of '+typeof e);const r=e.rgb(),i=this.rgb(),n=t===void 0?.5:t,s=2*n-1,a=r.alpha()-i.alpha(),o=((s*a===-1?s:(s+a)/(1+s*a))+1)/2,c=1-o;return ce.rgb(o*r.red()+c*i.red(),o*r.green()+c*i.green(),o*r.blue()+c*i.blue(),r.alpha()*n+i.alpha()*(1-n))}};for(const e of Object.keys(me)){if(Mo.includes(e))continue;const{channels:t}=me[e];ce.prototype[e]=function(...r){return this.model===e?new ce(this):r.length>0?new ce(r,e):new ce([...tp(me[this.model][e].raw(this.color)),this.valpha],e)},ce[e]=function(...r){let i=r[0];return typeof i=="number"&&(i=Ei(r,t)),new ce(i,e)}}function Zd(e,t){return Number(e.toFixed(t))}function ep(e){return function(t){return Zd(t,e)}}function K(e,t,r){e=Array.isArray(e)?e:[e];for(const i of e)(Or[i]||(Or[i]=[]))[t]=r;return e=e[0],function(i){let n;return i!==void 0?(r&&(i=r(i)),n=this[e](),n.color[t]=i,n):(n=this[e]().color[t],r&&(n=r(n)),n)}}function ae(e){return function(t){return Math.max(0,Math.min(e,t))}}function tp(e){return Array.isArray(e)?e:[e]}function Ei(e,t){for(let r=0;r<t;r++)typeof e[r]!="number"&&(e[r]=0);return e}var rp=ce;const ip=Vi(rp);class ie{}v(ie,"Text",1),v(ie,"ProcessingInstruction",2),v(ie,"SGMLDeclaration",4),v(ie,"Doctype",8),v(ie,"Comment",16),v(ie,"OpenTagStart",32),v(ie,"Attribute",64),v(ie,"OpenTag",128),v(ie,"CloseTag",256),v(ie,"Cdata",512);class Wr{constructor(t,r=0){v(this,"data");v(this,"cache",{});v(this,"ptr");this.data=t,this.ptr=r}}class np{constructor(t,r){v(this,"line");v(this,"character");this.line=t,this.character=r}}var Hn;(function(e){e[e.Normal=0]="Normal",e[e.JSX=1]="JSX"})(Hn||(Hn={}));class No extends Wr{constructor(r,i=0){super(r,i);v(this,"type");v(this,"name");v(this,"value");this.type=r[i],i+=1;const n=Ce(r,i);i+=4,this.name=new $t(r,i),i+=n,this.value=new $t(r,i)}toJSON(){const{name:r,value:i,type:n}=this;return{name:r,value:i,type:n}}toString(){const{name:r,value:i}=this;return`${r}="${i}"`}}class sp extends Wr{constructor(r,i=0){super(r,i);v(this,"target");v(this,"content");i+=16;const n=Ce(r,i);i+=4,this.target=new $t(r,i),i+=n,this.content=new $t(r,i)}get start(){return this.cache.start||(this.cache.start=Ke(this.data,this.ptr))}get end(){return this.cache.end||(this.cache.end=Ke(this.data,this.ptr+8))}toJSON(){const{start:r,end:i,target:n,content:s}=this;return{start:r,end:i,target:n,content:s}}toString(){const{target:r,content:i}=this;return`<? ${r} ${i} ?>`}}class $t extends Wr{get start(){return this.cache.start||(this.cache.start=Ke(this.data,this.ptr))}get end(){return this.cache.end||(this.cache.end=Ke(this.data,this.ptr+8))}get value(){if(this.cache.value)return this.cache.value;const t=Ce(this.data,this.ptr+16);return this.cache.value=Do(this.data,this.ptr+20,t)}toJSON(){const{start:t,end:r,value:i}=this;return{start:t,end:r,value:i}}toString(){return this.value}}class ap extends Wr{get openStart(){return this.cache.openStart||(this.cache.openStart=Ke(this.data,this.ptr+8))}get openEnd(){return this.cache.openEnd||(this.cache.openEnd=Ke(this.data,this.ptr+16))}get closeStart(){return this.cache.closeStart||(this.cache.closeStart=Ke(this.data,this.ptr+24))}get closeEnd(){return this.cache.closeEnd||(this.cache.closeEnd=Ke(this.data,this.ptr+32))}get selfClosing(){return!!this.data[this.ptr+40]}get name(){if(this.cache.name)return this.cache.name;const t=Ce(this.data,this.ptr+41);return this.cache.name=Do(this.data,this.ptr+45,t)}get attributes(){if(this.cache.attributes)return this.cache.attributes;let t=Ce(this.data,this.ptr);const r=Ce(this.data,t);t+=4;const i=[];for(let n=0;n<r;n++){const s=Ce(this.data,t);t+=4,i[n]=new No(this.data,t),t+=s}return this.cache.attributes=i}get textNodes(){if(this.cache.textNodes)return this.cache.textNodes;let t=Ce(this.data,this.ptr+4);const r=Ce(this.data,t),i=[];t+=4;for(let n=0;n<r;n++){const s=Ce(this.data,t);t+=4,i[n]=new $t(this.data,t),t+=s}return this.cache.textNodes=i}toJSON(){const{openStart:t,openEnd:r,closeStart:i,closeEnd:n,name:s,attributes:a,textNodes:o,selfClosing:c}=this;return{openStart:t,openEnd:r,closeStart:i,closeEnd:n,name:s,attributes:a,textNodes:o,selfClosing:c}}get value(){return this.name}}class Ir{constructor(t=0){v(this,"events");v(this,"wasmSaxParser");v(this,"eventHandler");v(this,"writeBuffer");v(this,"eventTrap",(t,r,i)=>{if(!this.wasmSaxParser)return;const n=new Uint8Array(this.wasmSaxParser.memory.buffer,r,i),s=new Uint8Array(n);let a;switch(t){case ie.Attribute:a=new No(s);break;case ie.ProcessingInstruction:a=new sp(s);break;case ie.OpenTag:case ie.CloseTag:case ie.OpenTagStart:a=new ap(s);break;case ie.Text:case ie.Cdata:case ie.Comment:case ie.Doctype:case ie.SGMLDeclaration:a=new $t(s);break;default:throw new Error("No reader for this event type")}this.eventHandler&&this.eventHandler(t,a)});const r=this;Object.defineProperties(this,{events:{get:()=>~~t,set:i=>{t=~~i,r.wasmSaxParser&&r.wasmSaxParser.parser(t)},configurable:!1,enumerable:!0}})}async*parse(t){let r=[];for(this.eventHandler=function(i,n){r.push([i,n])};;){const i=await t.read();if(i.done)return this.end();if(this.write(i.value),r.length){for(const n of r)yield n;r.length=0}}}write(t){if(!this.wasmSaxParser)return;const{write:r,memory:i}=this.wasmSaxParser;(!this.writeBuffer||this.writeBuffer.buffer!==i.buffer)&&(this.writeBuffer=new Uint8Array(i.buffer)),this.writeBuffer.set(t,0),r(0,t.byteLength)}end(){var t;this.writeBuffer=void 0,(t=this.wasmSaxParser)==null||t.end()}async prepareWasm(t){let r;const i={memory:new WebAssembly.Memory({initial:10,shared:!0,maximum:150}),table:new WebAssembly.Table({initial:1,element:"anyfunc"}),event_listener:this.eventTrap};if(t instanceof Uint8Array?r=await WebAssembly.instantiate(t,{env:i}):r=await WebAssembly.instantiateStreaming(t,{env:i}),r&&typeof this.events=="number"){const{parser:n}=this.wasmSaxParser=r.instance.exports;return n(this.events),!0}throw new Error("Failed to instantiate the parser.")}}v(Ir,"textDecoder");const Do=(e,t,r)=>globalThis.hasOwnProperty("Buffer")?Buffer.from(e.buffer,e.byteOffset+t,r).toString():(Ir.textDecoder||(Ir.textDecoder=new TextDecoder)).decode(e.subarray(t,t+r)),Ce=(e,t)=>e[t+3]<<24|e[t+2]<<16|e[t+1]<<8|e[t],Ke=(e,t=0)=>{const r=Ce(e,t),i=Ce(e,t+4);return new np(r,i)},op=/(?<val>\d+(?:\.\d+)?)\s*(?<unit>[[a-z%]+)?/;function cp(e){const t=new Ir(ie.Text),r=[];return t.eventHandler=(i,n)=>{r.push(n.value)},t.write(Pe.encode(e)),r.join("").trim()}function si(e,t,r){if(!e.spatial)return null;const i=t-e.spatial.y,n=i-e.spatial.height;return{Subtype:"/Square",Rect:[e.spatial.x*r,i*r,(e.spatial.x+e.spatial.width)*r,n*r]}}function lp(e){return ip(e).rgb().array()}function hp(e,t,r){const i=op.exec(e);if(!i||!i.groups)return null;const n=parseFloat(i.groups.val),s=i.groups.unit;if(!s)return n*t;switch(s){case"%":return null;case"px":return t*n;default:return console.warn(`Unsupported CSS length unit: ${s}`),null}}function up(e,t){const r={};if((e.stroke||e.strokeDasharray||e.strokeWidth)&&(r.BS={Type:"/Border",W:e.strokeWidth??1,S:e.strokeDasharray?"/D":"/S"},e.strokeDasharray&&(r.BS.D=e.strokeDasharray)),e.fill){const i=lp(e.fill);i&&(r.IC=i.map(n=>n/255))}if(e.strokeWidth){const i=hp(e.strokeWidth,t);r.BS={Type:"/Border",W:i}}return r}function Qn(e,t,r){var n,s;const i=e.style?up(e.style,t):{};switch(e.type){case"BoxSelector":return{Subtype:"/Square",...si(e,r,t),...i};case"PointSelector":{const a=e;if(!a.x||!a.y)throw"Only PointSelectors with both x and y coordinates are supported!";return{Subtype:"/Circle",BS:{Type:"/Border",W:2,S:"/S"},IC:[1,1,1],Rect:[a.x*t-.5,a.y*t-.5,a.x*t+1,a.y*t+1]}}case"SvgSelector":{const a=e;switch(a.svgShape){case"rect":return{Subtype:"/Square",...si(a,r,t),...i};case"circle":case"ellipse":return{Subtype:"/Circle",Rect:si(a,r,t),...i};case"polyline":case"polygon":return{Subtype:a.svgShape==="polyline"?"/PolyLine":"/Polygon",Vertices:((n=a.points)==null?void 0:n.flatMap(([o,c])=>[o*t,(r-c)*t]))??[],...i};case"path":return{Subtype:"/Ink",InkList:((s=a.points)==null?void 0:s.flatMap(([o,c])=>[o*t,(r-c)*t]))??[],...i};default:throw new Error("not implemented yet")}}default:throw`${e.type} selector is currently not supported`}}function fp(e,t,r){const i={Type:"/Annot",NM:`(${e.id})`,Contents:`(${cp(e.markup)})`,F:4,C:[1,0,0],CA:1,Border:[0,0,5]};return e.author&&(i.T=`(${e.author})`),e.lastModified&&(i.M=e.lastModified),e.target.selector?[{...i,...Qn(e.target.selector,t,r)}]:e.target.selectors&&e.target.selectors.length>0?e.target.selectors.map(n=>({...i,...Qn(n,t,r)})):[]}const dp=`pdiiif v${en}`,ai=2,Gn=new Uint8Array([0,1,0,0,0,10,0,128,0,3,0,32,79,83,47,50,86,222,200,148,0,0,1,40,0,0,0,96,99,109,97,112,0,10,0,52,0,0,1,144,0,0,0,30,103,108,121,102,21,34,65,36,0,0,1,184,0,0,0,24,104,101,97,100,11,120,241,101,0,0,0,172,0,0,0,54,104,104,101,97,12,2,4,2,0,0,0,228,0,0,0,36,104,109,116,120,4,0,0,0,0,0,1,136,0,0,0,8,108,111,99,97,0,12,0,0,0,0,1,176,0,0,0,6,109,97,120,112,0,4,0,5,0,0,1,8,0,0,0,32,110,97,109,101,242,235,22,218,0,0,1,208,0,0,0,75,112,111,115,116,0,1,0,1,0,0,2,28,0,0,0,32,0,1,0,0,0,1,0,0,176,148,113,16,95,15,60,245,4,7,8,0,0,0,0,0,207,154,252,110,0,0,0,0,212,195,167,242,0,0,0,0,4,0,8,0,0,0,0,16,0,2,0,0,0,0,0,0,0,1,0,0,8,0,255,255,0,0,4,0,0,0,0,0,4,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,0,1,0,0,0,2,0,4,0,1,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3,0,0,1,144,0,5,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,5,0,1,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,71,79,79,71,0,64,0,0,0,0,0,1,255,255,0,0,0,1,0,1,128,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,4,0,0,0,0,0,0,2,0,1,0,0,0,0,0,20,0,3,0,0,0,0,0,20,0,6,0,10,0,0,0,0,0,0,0,0,0,0,0,0,0,12,0,0,0,1,0,0,0,0,4,0,8,0,0,3,0,0,49,33,17,33,4,0,252,0,8,0,0,0,0,3,0,42,0,0,0,3,0,0,0,5,0,22,0,0,0,1,0,0,0,0,0,5,0,11,0,22,0,3,0,1,4,9,0,5,0,22,0,0,0,86,0,101,0,114,0,115,0,105,0,111,0,110,0,32,0,49,0,46,0,48,86,101,114,115,105,111,110,32,49,46,48,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]);class pp{constructor({writer:t,metadata:r,canvasInfos:i,langPref:n,pageLabels:s,outline:a=[],readingDirection:o="left-to-right",hasText:c=!1,initialCanvas:h,manifestJson:l,zipPolyglot:u=!1,zipBaseDir:f}){v(this,"_offset",0);v(this,"_objects",[]);v(this,"_nextObjNo",1);v(this,"_objRefs",{});v(this,"_offsets",[]);v(this,"_writer");v(this,"_pagesStarted",!1);v(this,"_canvasInfos",[]);v(this,"_firstPageObjectNum");v(this,"_pageLabels");v(this,"_numCoverPages",0);v(this,"_outline",[]);v(this,"_hasText",!1);v(this,"_strucTree",[]);v(this,"_pageMCIds",new Map);v(this,"_nextStructParentId",0);v(this,"_pageParentIds",new Map);v(this,"_langPref");v(this,"_initialCanvas");v(this,"_polyglot");v(this,"_manifestJson");v(this,"_zipCatalog");v(this,"_zipBaseDir");v(this,"_readingDirection");v(this,"_deferredReferences",new Map);this._writer=t,this._canvasInfos=i,this._pageLabels=s,this._outline=a,this._hasText=c,this._readingDirection=o,this._langPref=n,this._initialCanvas=h,this._polyglot=u,this._zipBaseDir=f,this._manifestJson=l;const p={...Object.entries(r).filter((d,m)=>m!==void 0).reduce((d,[m,g])=>(d[m]=`(${g})`,d),{}),Producer:`(${dp})`};this._addObject(p,"Info")}async setup(){const t={Type:"/Catalog"};this._addObject(t,"Catalog");const r=this._addObject({Type:"/Pages",Count:this._canvasInfos.length},"Pages");if(t.Pages=M(r),this._hasText&&(t.MarkInfo={Type:"/MarkInfo",Marked:!0}),this._outline.length>0){t.PageMode="/UseOutlines";const i={Type:"/Outlines",Count:0},n=this._addObject(i);t.Outlines=M(n);let s;for(const[a,o]of this._outline.entries()){const[c,h]=this._addOutline(o,n,s);i.Count+=1+h,a===0?i.First=M(c):a===this._outline.length-1&&(i.Last=M(c)),s=c}}else t.PageMode="/UseThumbs";t.ViewerPreferences={Direction:this._readingDirection==="right-to-left"?"/R2L":"/L2R"},this._hasText&&await this._setupHiddenTextFont()}async _setupHiddenTextFont(){const t=this._addObject({Type:"/Font",Subtype:"/Type0",BaseFont:"/GlyphLessFont",Encoding:"/Identity-H"},"Type0Font"),r=this._addObject({type:"/Font",Subtype:"/CIDFontType2",BaseFont:"/GlyphLessFont",DW:1e3/ai,CIDSystemInfo:{Ordering:"(Identity)",Registry:"(Adobe)",Supplement:0}});t.data.DescendantFonts=[M(r)];const i=new Uint8Array(128*1024);for(let u=0;u<i.length;u++)i[u]=u%2?1:0;const n=await ur(i),s=this._addObject(n.dict,void 0,n.stream);r.data.CIDToGIDMap=M(s);const a=ld`
       /CIDInit /ProcSet findresource begin
         12 dict begin
         begincmap
@@ -3010,1785 +54,41 @@ var PDFGenerator = class {
               /Ordering (UCS)
               /Supplement 0
             >> def
-            /CMapName /Adobe-Identify-UCS def
+            /CMapName /Identity-H def
             /CMapType 2 def
             1 begincodespacerange
             <0000> <FFFF>
             endcodespacerange
             1 beginbfrange
-            <0000> <FFFE> <0000>
+            <0000> <FFFF> <0000>
             endbfrange
         endcmap
         CMapName currentdict /CMap defineresource pop
         end
-    end`;
-    const cmap = this._addObject(
-      {
-        Length: cmapStream.length
-      },
-      void 0,
-      cmapStream
-    );
-    typeZeroFont.data.ToUnicode = makeRef(cmap);
-    const fontDesc = this._addObject({
-      Type: "/FontDescriptor",
-      FontName: "/GlyphLessFont",
-      FontBBox: [0, 0, 1e3 / CHAR_WIDTH, 1e3],
-      Ascent: 1e3,
-      CapHeight: 1e3,
-      Descent: -1,
-      Flags: 5,
-      ItalicAngle: 0,
-      StemV: 80
-    });
-    typeTwoFont.data.FontDescriptor = makeRef(fontDesc);
-    const maybeCompressedFont = await tryDeflateStream(FONTDATA);
-    const fontDataObj = this._addObject(
-      {
-        Length1: FONTDATA.length,
-        ...maybeCompressedFont.dict
-      },
-      void 0,
-      maybeCompressedFont.stream
-    );
-    fontDesc.data.FontFile2 = makeRef(fontDataObj);
-  }
-  _registerEmbeddedFilesInCatalog() {
-    const catalog = this._objects[this._objRefs.Catalog.refObj].data;
-    const embeddedFiles = [
-      `(manifest.json)`,
-      makeRef(this._firstPageObjectNum - (this._polyglot ? 3 : 2))
-    ];
-    for (const [idx, canvas] of this._canvasInfos.entries()) {
-      if (!canvas.ocr) {
-        continue;
-      }
-      const pageObjNum = this.getCanvasObjectNumber(idx);
-      let fileObjNum = pageObjNum + this.getObjectsPerCanvas(idx) - 2;
-      if (this._polyglot) {
-        fileObjNum -= 1;
-      }
-      embeddedFiles.push(`(${canvas.ocr.id})`);
-      embeddedFiles.push(makeRef(fileObjNum));
-    }
-    if (!catalog.Names) {
-      catalog.Names = {
-        EmbeddedFiles: { Names: embeddedFiles }
-      };
-    } else {
-      const names = catalog.Names;
-      const nameTree = names.EmbeddedFiles;
-      nameTree.Names = nameTree.Names.concat(embeddedFiles);
-    }
-  }
-  _addOutline(itm, parent, prev) {
-    let dest;
-    if (typeof itm.startCanvas === "string") {
-      const destCanvasIdx = this._canvasInfos.findIndex(
-        (ci) => ci.canvas.id === itm.startCanvas
-      );
-      if (destCanvasIdx < 0) {
-        throw Error(
-          `Could not find canvas with id ${itm.startCanvas} in manifest!`
-        );
-      }
-      dest = [destCanvasIdx, "/Fit"];
-    } else {
-      const canvasId = itm.startCanvas.id;
-      const unitScale = 72 / itm.startCanvas.ppi;
-      const rect = itm.startCanvas.position;
-      const { width, height } = itm.startCanvas.dimensions;
-      const destCanvasIdx = this._canvasInfos.findIndex(
-        (ci) => ci.canvas.id === canvasId
-      );
-      if (destCanvasIdx < 0) {
-        throw Error(`Could not find canvas with id ${canvasId} in manifest!`);
-      }
-      dest = [
-        destCanvasIdx,
-        "/FitR",
-        // TODO: Thoroughly test that this is actually working!
-        unitScale * rect.x,
-        // left
-        unitScale * rect.y,
-        // bottom
-        unitScale * (width - (rect.x + rect.width)),
-        // right,
-        unitScale * (height - (rect.y + rect.height))
-        // top,
-      ];
-    }
-    const rec = {
-      Title: `( ${itm.label} )`,
-      Parent: makeRef(parent),
-      // NOTE: The first entry is a number only during setup and will later be
-      //       replaced with a reference to the actual page object, once we know
-      //       how many objects are preceding the page objects.
-      Dest: dest
-    };
-    const obj = this._addObject(rec);
-    if (prev) {
-      rec.Prev = makeRef(prev);
-      prev.data.Next = makeRef(obj);
-    }
-    if (itm.children?.length) {
-      let prev2;
-      rec.Count = 0;
-      for (const [idx, child] of itm.children.entries()) {
-        const [childObj, numChildren] = this._addOutline(child, obj, prev2);
-        if (idx === 0) {
-          rec.First = makeRef(childObj);
-        } else if (idx === itm.children.length - 1) {
-          rec.Last = makeRef(childObj);
-        }
-        rec.Count = rec.Count + 1 + numChildren;
-        prev2 = childObj;
-      }
-    }
-    return [obj, rec.Count ?? 0];
-  }
-  _addObject(val, refName, stream) {
-    const isObject = (x) => typeof x === "object" && x !== null;
-    if (stream) {
-      if (!isObject(val)) {
-        throw new Error(
-          "PDF Objects with a stream must have a dictionary as its value"
-        );
-      }
-      if (!val.Length) {
-        val.Length = stream.length;
-      }
-    }
-    const obj = {
-      num: this._nextObjNo,
-      data: val,
-      stream
-    };
-    this._nextObjNo++;
-    this._objects[obj.num] = obj;
-    if (refName) {
-      this._objRefs[refName] = makeRef(obj);
-    }
-    return obj;
-  }
-  /** Clone an object from a foreign PDF into the current PDF, adjusting
-   *  the encountered indirect object references.
-   */
-  async _transplantObject(parser, obj, seenObjects = {}) {
-    const handleValue = async (value) => {
-      if (value instanceof PdfRef) {
-        const o = await parser.resolveRef(value);
-        if (o === void 0) {
-          throw `Could not resolve reference to object '${value.refObj}'`;
-        }
-        if (seenObjects[o.num]) {
-          return seenObjects[o.num];
-        }
-        const objDict = o.data;
-        const newObj = this._addObject(objDict, void 0, o.stream);
-        const ref2 = new PdfRef(newObj.num);
-        seenObjects[o.num] = ref2;
-        newObj.data = await handleValue(objDict);
-        if (objDict.Type === "/Page") {
-          newObj.data.Parent = this._objRefs.Pages;
-        }
-        return ref2;
-      } else if (typeof value === "string" && value[0] != "/") {
-        return `(${value})`;
-      } else if (Array.isArray(value)) {
-        const out = [];
-        for (const val of value) {
-          out.push(await handleValue(val));
-        }
-        return out;
-      } else if (typeof value === "object" && value !== null) {
-        const out = {};
-        for (const [key, val] of Object.entries(value)) {
-          if (key === "StructParent" || key === "StructParents") {
-            continue;
-          }
-          out[key] = await handleValue(val);
-        }
-        return out;
-      }
-      return value;
-    };
-    const ref = new PdfRef(obj.num);
-    return await handleValue(ref);
-  }
-  async insertCoverPages(pdfData) {
-    if (this._pagesStarted) {
-      throw "Cover pages must be inserted before writing the first regular page";
-    }
-    const reader = new ArrayReader(new Uint8Array(pdfData));
-    const parser = await PdfParser.parse(reader);
-    const pagesDict = this._objects[this._objRefs.Pages.refObj].data;
-    pagesDict.Kids = [];
-    for await (const page of parser.pages()) {
-      const dict = page.data;
-      delete dict.StructParents;
-      delete dict.Parent;
-      const newPageRef = await this._transplantObject(parser, page);
-      pagesDict.Kids.push(newPageRef);
-      pagesDict.Count += 1;
-      this._numCoverPages += 1;
-    }
-    return;
-  }
-  async _embedResource(id, filename, description, mimeType, data) {
-    const fileSpec = {
-      Type: "/Filespec",
-      F: `(${filename})`,
-      UF: toUTF16BE(filename),
-      Desc: `(${description})`,
-      EF: {
-        F: makeRef(this._nextObjNo + (this._polyglot ? 2 : 1))
-      }
-    };
-    const maybeCompressed = await tryDeflateStream(data);
-    const embeddedFile = {
-      Type: "/EmbeddedFile",
-      Subtype: `(${mimeType})`,
-      ...maybeCompressed.dict
-    };
-    this._addObject(fileSpec);
-    if (this._polyglot) {
-      let zipData;
-      if (typeof data === "string") {
-        zipData = textEncoder.encode(data);
-      } else {
-        zipData = data;
-      }
-      const extraDataLength = this._getSerializedSize(
-        {
-          num: this._nextObjNo + 2,
-          data: { ...embeddedFile, ...maybeCompressed.dict },
-          stream: maybeCompressed.stream
-        },
-        true
-      );
-      this._insertZipHeaderDummyObject({
-        filename,
-        data: zipData,
-        deflatedData: maybeCompressed.dict.Filter ? maybeCompressed.stream : void 0,
-        // 2 bytes zlib header of deflated data
-        bytesUntilActualData: extraDataLength + 2
-      });
-    }
-    this._addObject(embeddedFile, void 0, maybeCompressed.stream);
-  }
-  async _embedManifest(manifestJson) {
-    let manifestMime = "application/ld+json";
-    if (Array.isArray(manifestJson["@context"])) {
-      const manifestProfile = manifestJson["@context"].find(
-        (p) => p.startsWith("http://iiif.io/api/presentation")
-      );
-      if (manifestProfile) {
-        manifestMime += `;profile="${manifestProfile}"`;
-      }
-    } else if (manifestJson["@context"]) {
-      manifestMime += `;profile="${manifestJson["@context"]}"`;
-    }
-    await this._embedResource(
-      "@id" in manifestJson ? manifestJson["@id"] : manifestJson.id,
-      "manifest.json",
-      "IIIF Manifest this PDF is based on",
-      manifestMime,
-      JSON.stringify(manifestJson)
-    );
-  }
-  async finalizePdfHeader() {
-    const catalog = this._objects[this._objRefs.Catalog.refObj].data;
-    if (this._pageLabels) {
-      catalog.PageLabels = makeRef(
-        this._addObject({
-          Nums: this._pageLabels.map(
-            (label, idx) => label ? [idx + this._numCoverPages, { P: `( ${label} )` }] : void 0
-          ).filter((x) => x !== void 0).flat()
-        })
-      );
-    }
-    const pagesObj = this._objects[this._objRefs.Pages.refObj];
-    const pageDict = pagesObj.data;
-    if (!pageDict.Kids) {
-      pageDict.Kids = [];
-    }
-    this._firstPageObjectNum = this._nextObjNo;
-    if (this._manifestJson) {
-      this._firstPageObjectNum += 2;
-      if (this._polyglot) {
-        this._firstPageObjectNum++;
-      }
-    }
-    for (const [idx] of this._canvasInfos.entries()) {
-      pageDict.Kids.push(
-        makeRef(this.getCanvasObjectNumber(idx))
-      );
-    }
-    this._objects.filter((obj) => obj.data?.Dest !== void 0).forEach((obj) => {
-      const dest = obj.data.Dest;
-      if (typeof dest[0] !== "number") {
-        return;
-      }
-      dest[0] = makeRef(this.getCanvasObjectNumber(dest[0]));
-    });
-    if (this._hasText) {
-      catalog.StructTreeRoot = makeRef(
-        this._nextObjNo + this.totalCanvasObjects
-      );
-    }
-    if (this._canvasInfos.some((ci) => ci.images.some((i) => i.choiceInfo))) {
-      const initiallyEnabledOCGs = [];
-      const initiallyDisabledOCGs = [];
-      const allOCGs = [];
-      const rbGroups = [];
-      for (const [canvasIdx, { images }] of this._canvasInfos.entries()) {
-        const pageObjNum = this.getCanvasObjectNumber(canvasIdx);
-        let ocgStart = pageObjNum + 2 + images.length;
-        if (this._polyglot) {
-          ocgStart += images.length;
-        }
-        let ocgIdx = 0;
-        const rbGroup = [];
-        for (const img of images) {
-          if (!img.choiceInfo) {
-            continue;
-          }
-          const ref = makeRef(ocgStart + ocgIdx);
-          if (img.choiceInfo.enabled) {
-            initiallyEnabledOCGs.push(ref);
-          } else {
-            initiallyDisabledOCGs.push(ref);
-          }
-          allOCGs.push(ref);
-          rbGroup.push(ref);
-          ocgIdx++;
-        }
-        rbGroups.push(rbGroup);
-      }
-      catalog.OCProperties = {
-        OCGs: allOCGs,
-        D: {
-          BaseState: "/OFF",
-          ON: initiallyEnabledOCGs,
-          OFF: initiallyDisabledOCGs,
-          RBGroups: rbGroups
-        }
-      };
-    }
-    if (typeof this._initialCanvas === "string") {
-      catalog.OpenAction = [
-        makeRef(
-          this.getCanvasObjectNumber(
-            this._canvasInfos.findIndex(
-              (ci) => ci.canvas.id === this._initialCanvas
-            )
-          )
-        )
-      ];
-    } else if (this._initialCanvas) {
-      const unitScale = 72 / this._initialCanvas.ppi;
-      const rect = this._initialCanvas.position;
-      const { width, height } = this._initialCanvas.dimensions;
-      catalog.OpenAction = [
-        makeRef(
-          this.getCanvasObjectNumber(
-            this._canvasInfos.findIndex(
-              (ci) => ci.canvas.id === this._initialCanvas
-            )
-          )
-        ),
-        "/FitR",
-        // TODO: Thoroughly test that this is actually working!
-        unitScale * rect.x,
-        // left
-        unitScale * rect.y,
-        // bottom
-        unitScale * (width - (rect.x + rect.width)),
-        // right,
-        unitScale * (height - (rect.y + rect.height))
-        // top,
-      ];
-    }
-    this._registerEmbeddedFilesInCatalog();
-    await this._flush();
-    if (this._manifestJson) {
-      await this._embedManifest(this._manifestJson);
-      await this._flush();
-    }
-  }
-  async renderPage(canvasId, {
-    width: canvasWidth,
-    height: canvasHeight
-  }, images, annotations, ocrText, ppi = 300) {
-    if (!this._pagesStarted) {
-      logger.debug("Initial page, finalizing PDF header structures.");
-      await this.finalizePdfHeader();
-      this._pagesStarted = true;
-    }
-    const unitScale = 72 / ppi;
-    const pageDict = {
-      Type: "/Page",
-      Parent: this._objRefs.Pages,
-      MediaBox: [0, 0, unitScale * canvasWidth, unitScale * canvasHeight],
-      Resources: {
-        ProcSet: ["/PDF", "/Text", "/ImageB", "/ImageI", "/ImageC"]
-      }
-    };
-    if (this._hasText) {
-      pageDict.StructParents = this._nextStructParentId;
-      this._pageParentIds.set(this._nextObjNo, this._nextStructParentId);
-      this._nextStructParentId++;
-    }
-    if (ocrText && this._objRefs.Type0Font) {
-      pageDict.Resources.Font = {
-        "f-0-0": this._objRefs.Type0Font
-      };
-    }
-    const page = this._addObject(pageDict);
-    const contentOps = [];
-    const optionalGroupIds = {};
-    for (const [idx, image] of images.entries()) {
-      if (isImageFetchFailure(image)) {
-        continue;
-      }
-      const { x, y, width, height, choiceInfo } = image;
-      const drawWidth = unitScale * width;
-      const drawHeight = unitScale * height;
-      const drawX = unitScale * x;
-      const drawY = unitScale * (canvasHeight - height - y);
-      const imageId = `/Im${idx + 1}`;
-      if (choiceInfo?.optional) {
-        const ocId = `/oc${Object.keys(optionalGroupIds).length + 1}`;
-        optionalGroupIds[imageId] = ocId;
-        contentOps.push(`/OC ${ocId} BDC`);
-      }
-      contentOps.push(`q ${drawWidth} 0 0 ${drawHeight} ${drawX} ${drawY} cm`);
-      contentOps.push(`${imageId} Do`);
-      contentOps.push("Q");
-      if (choiceInfo?.optional) {
-        contentOps.push("EMC");
-      }
-    }
-    if (ocrText) {
-      contentOps.push(this._renderOcrText(ocrText, unitScale));
-    }
-    logger.debug("Trying to compress content stream.");
-    const contentStreamComp = await tryDeflateStream(contentOps.join("\n"));
-    const contentsObj = this._addObject(
-      contentStreamComp.dict,
-      void 0,
-      contentStreamComp.stream
-    );
-    page.data.Contents = makeRef(contentsObj);
-    const imageObjectNums = [...images.keys()].map((idx) => {
-      if (this._polyglot) {
-        return this._nextObjNo + idx * 2 + 1;
-      } else {
-        return this._nextObjNo + idx;
-      }
-    });
-    const optionalGroupObjectNums = {};
-    if (images.some((i) => i.choiceInfo?.optional)) {
-      for (const [idx, img] of images.entries()) {
-        if (isImageFetchFailure(img)) {
-          continue;
-        }
-        const imageId = `/Im${idx + 1}`;
-        if (!img.choiceInfo?.optional) {
-          continue;
-        }
-        optionalGroupObjectNums[imageId] = imageObjectNums.slice(-1)[0] + idx + 1;
-      }
-    }
-    const pageResources = page.data.Resources;
-    const xObjects = {};
-    const properties = {};
-    for (const [idx, num] of imageObjectNums.entries()) {
-      if (isImageFetchFailure(images[idx])) {
-        continue;
-      }
-      const imageId = `/Im${idx + 1}`;
-      xObjects[imageId.substring(1)] = makeRef(num);
-      const ocgNum = optionalGroupObjectNums[imageId];
-      if (ocgNum !== void 0) {
-        const ocgId = optionalGroupIds[imageId];
-        properties[ocgId.substring(1)] = makeRef(ocgNum);
-      }
-    }
-    pageResources.XObject = xObjects;
-    if (Object.keys(properties).length > 0) {
-      pageResources.Properties = properties;
-    }
-    logger.debug("Creating image objects.");
-    const canvasIdx = this._canvasInfos.findIndex(
-      (ci) => ci.canvas.id === canvasId
-    );
-    for (const [imgIdx, img] of images.entries()) {
-      if (isImageFetchFailure(img)) {
-        this._addObject({});
-        if (this._polyglot) {
-          this._addObject({});
-        }
-        continue;
-      }
-      const imageData = new Uint8Array(img.data);
-      const image = image_default.open(imageData);
-      const imageObj = image.toObjects(this._nextObjNo)[0];
-      if (this._polyglot) {
-        const imgPreambleSize = this._getSerializedSize(imageObj, true);
-        const filename = `img/canvas-${canvasIdx}-${imgIdx}.jpg`;
-        this._insertZipHeaderDummyObject({
-          filename,
-          data: imageData,
-          bytesUntilActualData: imgPreambleSize
-        });
-        imageObj.num = this._nextObjNo;
-      }
-      this._nextObjNo += 1;
-      this._objects.push(imageObj);
-    }
-    if (images.some((i) => i?.choiceInfo?.optional)) {
-      logger.debug("Creating optional content groups for page");
-      for (const [idx, img] of images.entries()) {
-        const imageId = `/Im${idx + 1}`;
-        if (!img?.choiceInfo) {
-          continue;
-        }
-        if (isImageFetchFailure(img)) {
-          this._addObject({});
-          continue;
-        }
-        optionalGroupObjectNums[imageId] = this._nextObjNo;
-        this._addObject({
-          Type: "/OCG",
-          Name: img.choiceInfo.label ? `(${getI18nValue(img.choiceInfo.label, this._langPref, "/")})` : void 0,
-          Intent: "/View",
-          Usage: img.choiceInfo.visibleByDefault ? "/ON" : "/OFF"
-        });
-      }
-    }
-    const canvasInfo = this._canvasInfos[canvasIdx];
-    if (ocrText?.markup) {
-      const canvasIdx2 = this._canvasInfos.findIndex(
-        (ci) => ci.canvas.id === canvasId
-      );
-      let filename = `ocr/canvas-${canvasIdx2}`;
-      if (ocrText.mimeType.indexOf("html") >= 0) {
-        filename += ".html";
-      } else {
-        filename += ".xml";
-      }
-      await this._embedResource(
-        ocrText.id,
-        filename,
-        `OCR for canvas #${canvasIdx2}`,
-        ocrText.mimeType,
-        ocrText.markup
-      );
-    } else if (canvasInfo.ocr) {
-      this._addObject({});
-      this._addObject({});
-      if (this._polyglot) {
-        this._addObject({});
-      }
-    }
-    if (annotations && annotations.length > 0) {
-      logger.debug("Creating annotations for page");
-      pageDict.Annots = annotations.flatMap((anno) => exportPdfAnnotation(anno, unitScale, canvasHeight)).map((pdfAnno) => makeRef(this._addObject(pdfAnno)));
-    }
-    logger.debug("Flushing data for page");
-    await this._flush();
-    logger.debug("Finished rendering page");
-  }
-  /** Get PDF instructions to render a hidden text layer with the page's OCR.
-   *
-   * This owes *a lot* to Tesseract's PDF renderer[1] and the IA's `pdf-tools`[2]
-   * that ported it to Python. Accordingly, the license of this method is Apache 2.0.
-   *
-   * [1] https://github.com/tesseract-ocr/tesseract/blob/5.0.0-beta-20210916/src/api/pdfrenderer.cpp
-   * [2] https://github.com/internetarchive/archive-pdf-tools/blob/master/internetarchivepdf/pdfrenderer.py
-   *
-   *                            Apache License
-   *                     Version 2.0, January 2004
-   *                  http://www.apache.org/licenses/
-   */
-  _renderOcrText(ocr, unitScale) {
-    const pageHeight = ocr.height;
-    const ops = [];
-    ops.push("BT");
-    ops.push("3 Tr");
-    const pageObjNum = this._nextObjNo - 1;
-    let lineIdx = 0;
-    const entries = [];
-    const handleChild = (child, parent) => {
-      if (child.type === "block") {
-        entries.push({
-          type: "Sect",
-          children: [],
-          pageObjNum,
-          mcs: []
-        });
-      } else if (child.type === "paragraph") {
-        entries.push({
-          type: "P",
-          children: [],
-          pageObjNum,
-          mcs: []
-        });
-        if (parent) {
-          parent.children.push(entries.slice(-1)[0]);
-        }
-      } else if (child.type === "line") {
-        ops.push(
-          ...this.renderOcrLine(
-            child,
-            lineIdx,
-            unitScale,
-            pageHeight,
-            pageObjNum
-          )
-        );
-        if (parent) {
-          parent.children.push({
-            type: "Span",
-            children: [],
-            pageObjNum,
-            mcs: [lineIdx]
-          });
-        }
-        lineIdx++;
-        return;
-      }
-      for (const grandchild of child.children) {
-        handleChild(grandchild, entries.slice(-1)[0]);
-      }
-    };
-    handleChild(ocr);
-    this._strucTree.push(...entries);
-    ops.push("ET");
-    return ops.join("\n");
-  }
-  renderOcrLine(line, lineIdx, unitScale, pageHeight, pageObjNum) {
-    const fontRef = "/f-0-0";
-    const scaleX = 1;
-    const scaleY = 1;
-    const shearX = 0;
-    const shearY = 0;
-    const ops = [];
-    ops.push(`/Span << /MCID ${lineIdx} >> BDC`);
-    const fontSize = line.height * unitScale * 0.75;
-    ops.push(`${fontRef} ${fontSize} Tf`);
-    const xPos = line.x * unitScale;
-    const lineY = pageHeight - line.y - line.height * 0.75;
-    const yPos = lineY * unitScale;
-    ops.push(`${scaleX} ${shearX} ${shearY} ${scaleY} ${xPos} ${yPos} Tm`);
-    let xOld = 0;
-    let yOld = 0;
-    for (const word of line.words) {
-      if (!word.text) {
-        continue;
-      }
-      if (!word.width) {
-        continue;
-      }
-      const wordX = (word.x - line.x) * unitScale;
-      const wordYAbsolute = pageHeight - word.y - word.height * 0.75;
-      const wordY = (wordYAbsolute - lineY) * unitScale;
-      const wordWidth = word.width * unitScale;
-      const wordHeight = word.height * unitScale;
-      const dx = wordX - xOld;
-      const dy = wordY - yOld;
-      ops.push(`${dx * scaleX + dy * shearX} ${dx * shearY + dy * scaleY} Td`);
-      xOld = wordX;
-      yOld = wordY;
-      const wordLength = Math.pow(
-        Math.pow(wordWidth, 2) + Math.pow(wordHeight, 2),
-        0.5
-      );
-      const pdfWordLen = word.text.length;
-      ops.push(
-        `${CHAR_WIDTH * (100 * wordLength / (fontSize * pdfWordLen))} Tz`
-      );
-      const textBytes = serialize(toUTF16BE(word.text + " ", false));
-      ops.push(`[ ${textBytes} ] TJ`);
-    }
-    ops.push("EMC");
-    ops.push("");
-    if (!this._pageMCIds.has(pageObjNum)) {
-      this._pageMCIds.set(pageObjNum, []);
-    }
-    this._pageMCIds.get(pageObjNum).push(lineIdx);
-    return ops;
-  }
-  get bytesWritten() {
-    return this._offset;
-  }
-  /** Number of objects needed to render all canvases */
-  get totalCanvasObjects() {
-    return this._canvasInfos.reduce(
-      (sum, _, idx) => sum + this.getCanvasObjectNumber(idx),
-      0
-    );
-  }
-  getObjectsPerCanvas(canvasIdx) {
-    const { images, ocr, numAnnotations } = this._canvasInfos[canvasIdx];
-    let numObjects = (
-      // 1 XObject per image
-      images.length + // Page dictionary and content
-      2 + // 1 Optional Content Group per optional image
-      images.filter((i) => i.choiceInfo !== void 0).length + // 1 XObject per annotation
-      numAnnotations
-    );
-    if (this._polyglot) {
-      numObjects = numObjects + images.length + (ocr ? 1 : 0);
-    }
-    if (ocr) {
-      numObjects += 2;
-    }
-    return numObjects;
-  }
-  getCanvasObjectNumber(canvasIdx) {
-    let num = this._firstPageObjectNum;
-    for (const [idx] of this._canvasInfos.entries()) {
-      if (idx === canvasIdx) {
-        return num;
-      }
-      num += this.getObjectsPerCanvas(idx);
-    }
-    throw new Error(`Canvas #${canvasIdx} not found.`);
-  }
-  async _flush() {
-    if (this._offsets.length === 0) {
-      logger.debug("Writing PDF header");
-      await this._write(`%PDF-1.5
-%\xDE\xAD\xBE\xEF
-`);
-    }
-    for (const obj of this._objects) {
-      if (!obj) {
-        continue;
-      }
-      logger.debug(`Serializing object #${obj.num}`);
-      await this._serializeObject(obj);
-    }
-    this._objects = [];
-  }
-  _getSerializedSize({ num, data, stream }, untilStreamStart = false) {
-    let size = 0;
-    size += `${num} 0 obj
-`.length;
-    if (data) {
-      size += serialize(data).length;
-    }
-    if (stream) {
-      size += "\nstream\n".length;
-      if (untilStreamStart) {
-        return size;
-      }
-      if (typeof stream === "string") {
-        size += textEncoder.encode(stream).byteLength;
-      } else {
-        size += stream.byteLength;
-      }
-      size += "\nendstream".length;
-    }
-    size += "\nendobj\n".length;
-    return size;
-  }
-  async _serializeObject(obj) {
-    this._offsets.push(this._offset);
-    const { num, data, stream } = obj;
-    await this._write(`${num} 0 obj
-`);
-    if (data) {
-      await this._write(serialize(data));
-    }
-    if (stream) {
-      await this._write("\nstream\n");
-      await this._write(stream);
-      await this._write("\nendstream");
-    }
-    await this._write("\nendobj\n");
-  }
-  async _write(data) {
-    if (this._writer === void 0) {
-      throw new Error(
-        "Cannot perform mutating operations on an already closed PDFGenerator."
-      );
-    }
-    if (typeof data === "string") {
-      data = textEncoder.encode(data);
-    }
-    this._offset += data.byteLength;
-    await this._writer.write(data);
-  }
-  async _writeStructureTree() {
-    const parentRoot = {
-      Nums: []
-    };
-    const parentRootRef = makeRef(this._addObject(parentRoot));
-    const root = {
-      Type: "/StructTreeRoot",
-      K: [],
-      ParentTree: parentRootRef,
-      ParentTreeNextKey: this._nextStructParentId
-    };
-    const pageParents = /* @__PURE__ */ new Map();
-    const rootRef = makeRef(this._addObject(root));
-    const visitEntry = async (entry, parent, parentRef) => {
-      const obj = {
-        Type: "/StructElem",
-        S: `/${entry.type}`,
-        P: parentRef,
-        Pg: makeRef(entry.pageObjNum),
-        K: []
-      };
-      if (!pageParents.has(entry.pageObjNum)) {
-        pageParents.set(entry.pageObjNum, []);
-      }
-      const objRef = makeRef(this._addObject(obj));
-      parent.K.push(objRef);
-      if (entry.children.length > 0) {
-        for (const i of entry.children) {
-          await visitEntry(i, obj, objRef);
-        }
-      } else if (entry.mcs.length == 1) {
-        obj.K = entry.mcs[0];
-      } else if (entry.mcs.length > 0) {
-        obj.K = entry.mcs;
-      }
-      if (entry.mcs.length > 0) {
-        const parents = pageParents.get(entry.pageObjNum);
-        for (const mcId of entry.mcs) {
-          parents[mcId] = objRef;
-        }
-      }
-      if (this._objects.length > 1e3) {
-        await this._flush();
-      }
-    };
-    for (const i of this._strucTree) {
-      await visitEntry(i, root, rootRef);
-    }
-    for (const [pageObjNum, parents] of pageParents) {
-      const pidx = this._pageParentIds.get(pageObjNum);
-      parentRoot.Nums.push(
-        pidx,
-        makeRef(this._addObject(parents))
-      );
-    }
-    await this._flush();
-  }
-  async end() {
-    if (!this._writer) {
-      return;
-    }
-    logger.debug("Writing xref table");
-    const xrefEntries = [
-      [0, 65535, "f"],
-      ...this._offsets.map((offset) => [offset, 0, "n"])
-    ];
-    const xRefTable = xrefEntries.map(
-      ([off, gen, free]) => [
-        off.toString(10).padStart(10, "0"),
-        gen.toString(10).padStart(5, "0"),
-        free,
-        ""
-      ].join(" ")
-    ).join("\n");
-    const xrefOffset = this._offset;
-    await this._write(`xref
-0 ${xrefEntries.length}
-${xRefTable}
-`);
-    const trailerDict = {
-      Size: xrefEntries.length,
-      Root: this._objRefs.Catalog,
-      Info: this._objRefs.Info,
-      ID: [randomData(32), randomData(32)]
-    };
-    await this._write(`
+    end`,o=this._addObject({Length:a.length},void 0,a);t.data.ToUnicode=M(o);const c=this._addObject({Type:"/FontDescriptor",FontName:"/GlyphLessFont",FontBBox:[0,0,1e3/ai,1e3],Ascent:1e3,CapHeight:1e3,Descent:-1,Flags:5,ItalicAngle:0,StemV:80});r.data.FontDescriptor=M(c);const h=await ur(Gn),l=this._addObject({Length1:Gn.length,...h.dict},void 0,h.stream);c.data.FontFile2=M(l)}_registerEmbeddedFilesInCatalog(){const t=this._objects[this._objRefs.Catalog.refObj].data,r=["(manifest.json)",M(this._firstPageObjectNum-(this._polyglot?3:2))];for(const[i,n]of this._canvasInfos.entries()){if(!n.ocr)continue;let a=this.getCanvasObjectNumber(i)+this.getObjectsPerCanvas(i)-2;this._polyglot&&(a-=1),r.push(`(${n.ocr.id})`),r.push(M(a))}if(!t.Names)t.Names={EmbeddedFiles:{Names:r}};else{const n=t.Names.EmbeddedFiles;n.Names=n.Names.concat(r)}}_makeDeferredReference(t){if(!this._deferredReferences.has(t)){const r=M(-1);this._deferredReferences.set(t,r)}return this._deferredReferences.get(t)}_addOutline(t,r,i){var o;let n;if(typeof t.startCanvas=="string"){const c=this._canvasInfos.findIndex(h=>h.canvas.id===t.startCanvas);if(c<0)throw Error(`Could not find canvas with id ${t.startCanvas} in manifest!`);n=[c,"/Fit"]}else{const c=t.startCanvas.id,h=72/t.startCanvas.ppi,l=t.startCanvas.position,{width:u,height:f}=t.startCanvas.dimensions,p=this._canvasInfos.findIndex(d=>d.canvas.id===c);if(p<0)throw Error(`Could not find canvas with id ${c} in manifest!`);n=[p,"/FitR",h*l.x,h*l.y,h*(u-(l.x+l.width)),h*(f-(l.y+l.height))]}const s={Title:`( ${t.label} )`,Parent:M(r),Dest:n},a=this._addObject(s);if(i&&(s.Prev=M(i),i.data.Next=M(a)),(o=t.children)!=null&&o.length){let c;s.Count=0;for(const[h,l]of t.children.entries()){const[u,f]=this._addOutline(l,a,c);h===0?s.First=M(u):h===t.children.length-1&&(s.Last=M(u)),s.Count=s.Count+1+f,c=u}}return[a,s.Count??0]}_addObject(t,r,i){const n=a=>typeof a=="object"&&a!==null;if(i){if(!n(t))throw new Error("PDF Objects with a stream must have a dictionary as its value");t.Length||(t.Length=i.length)}const s={num:this._nextObjNo,data:t,stream:i};return this._nextObjNo++,this._objects[s.num]=s,r&&(this._objRefs[r]=M(s)),s}async _transplantObject(t,r,i={}){const n=async a=>{if(a instanceof Tt){const o=await t.resolveRef(a);if(o===void 0)throw`Could not resolve reference to object '${a.refObj}'`;if(i[o.num])return i[o.num];const c=o.data,h=this._addObject(c,void 0,o.stream),l=new Tt(h.num);return i[o.num]=l,h.data=await n(c),c.Type==="/Page"&&(h.data.Parent=this._objRefs.Pages),l}else{if(typeof a=="string"&&a[0]!="/")return`(${a})`;if(Array.isArray(a)){const o=[];for(const c of a)o.push(await n(c));return o}else if(typeof a=="object"&&a!==null){const o={};for(const[c,h]of Object.entries(a))c==="StructParent"||c==="StructParents"||(o[c]=await n(h));return o}}return a},s=new Tt(r.num);return await n(s)}async insertCoverPages(t){if(this._pagesStarted)throw"Cover pages must be inserted before writing the first regular page";const r=new Pd(new Uint8Array(t)),i=await Zi.parse(r),n=this._objects[this._objRefs.Pages.refObj].data;n.Kids=[];for await(const s of i.pages()){const a=s.data;delete a.StructParents,delete a.Parent;const o=await this._transplantObject(i,s);n.Kids.push(o),n.Count+=1,this._numCoverPages+=1}}async _embedResource(t,r,i,n){const s={Type:"/Filespec",F:`(${t})`,UF:Ti(t),Desc:`(${r})`,EF:{F:M(this._nextObjNo+(this._polyglot?2:1))}},a=await ur(n),o={Type:"/EmbeddedFile",Subtype:`(${i})`,...a.dict};if(this._addObject(s),this._polyglot){let c;typeof n=="string"?c=Pe.encode(n):c=n;const h=this._getSerializedSize({num:this._nextObjNo+2,data:{...o,...a.dict},stream:a.stream},!0);this._insertZipHeaderDummyObject({filename:t,data:c,deflatedData:a.dict.Filter?a.stream:void 0,bytesUntilActualData:h+2})}this._addObject(o,void 0,a.stream)}async _embedManifest(t){let r="application/ld+json";if(Array.isArray(t["@context"])){const i=t["@context"].find(n=>n.startsWith("http://iiif.io/api/presentation"));i&&(r+=`;profile="${i}"`)}else t["@context"]&&(r+=`;profile="${t["@context"]}"`);await this._embedResource("manifest.json","IIIF Manifest this PDF is based on",r,JSON.stringify(t))}async finalizePdfHeader(){const t=this._objects[this._objRefs.Catalog.refObj].data;this._pageLabels&&(t.PageLabels=M(this._addObject({Nums:this._pageLabels.map((n,s)=>n?[s+this._numCoverPages,{P:`( ${n} )`}]:void 0).filter(n=>n!==void 0).flat()})));const i=this._objects[this._objRefs.Pages.refObj].data;i.Kids||(i.Kids=[]),this._firstPageObjectNum=this._nextObjNo,this._manifestJson&&(this._firstPageObjectNum+=2,this._polyglot&&this._firstPageObjectNum++);for(const[n]of this._canvasInfos.entries())i.Kids.push(M(this.getCanvasObjectNumber(n)));if(this._objects.filter(n=>{var s;return((s=n.data)==null?void 0:s.Dest)!==void 0}).forEach(n=>{const s=n.data.Dest;typeof s[0]=="number"&&(s[0]=M(this.getCanvasObjectNumber(s[0])))}),this._hasText&&(t.StructTreeRoot=M(this._nextObjNo+this.totalCanvasObjects)),this._canvasInfos.some(n=>n.images.some(s=>s.choiceInfo))){const n=[],s=[],a=[],o=[];for(const[c,{images:h}]of this._canvasInfos.entries()){let u=this.getCanvasObjectNumber(c)+2+h.length;this._polyglot&&(u+=h.length);let f=0;const p=[];for(const d of h){if(!d.choiceInfo)continue;const m=M(u+f);d.choiceInfo.enabled?n.push(m):s.push(m),a.push(m),p.push(m),f++}o.push(p)}t.OCProperties={OCGs:a,D:{BaseState:"/OFF",ON:n,OFF:s,RBGroups:o}}}if(typeof this._initialCanvas=="string")t.OpenAction=[M(this.getCanvasObjectNumber(this._canvasInfos.findIndex(n=>n.canvas.id===this._initialCanvas)))];else if(this._initialCanvas){const n=72/this._initialCanvas.ppi,s=this._initialCanvas.position,{width:a,height:o}=this._initialCanvas.dimensions;t.OpenAction=[M(this.getCanvasObjectNumber(this._canvasInfos.findIndex(c=>c.canvas.id===this._initialCanvas))),"/FitR",n*s.x,n*s.y,n*(a-(s.x+s.width)),n*(o-(s.y+s.height))]}this._registerEmbeddedFilesInCatalog(),await this._flush(),this._manifestJson&&(await this._embedManifest(this._manifestJson),await this._flush())}async renderPage(t,{width:r,height:i},n,s,a,o=300){var F;this._pagesStarted||(O.debug("Initial page, finalizing PDF header structures."),await this.finalizePdfHeader(),this._pagesStarted=!0);const c=72/o,h={Type:"/Page",Parent:this._objRefs.Pages,MediaBox:[0,0,c*r,c*i],Resources:{ProcSet:["/PDF","/Text","/ImageB","/ImageI","/ImageC"]}};this._hasText&&(h.StructParents=this._nextStructParentId,this._pageParentIds.set(this._nextObjNo,this._nextStructParentId),this._nextStructParentId++),a&&this._objRefs.Type0Font&&(h.Resources.Font={"f-0-0":this._objRefs.Type0Font});const l=this._addObject(h),u=[],f={};for(const[x,A]of n.entries()){if(hr(A))continue;const{x:k,y:C,width:S,height:E,choiceInfo:_}=A,R=c*S,V=c*E,Q=c*k,z=c*(i-E-C),B=`/Im${x+1}`;if(_!=null&&_.optional){const D=`/oc${Object.keys(f).length+1}`;f[B]=D,u.push(`/OC ${D} BDC`)}u.push(`q ${R} 0 0 ${V} ${Q} ${z} cm`),u.push(`${B} Do`),u.push("Q"),_!=null&&_.optional&&u.push("EMC")}a&&u.push(this._renderOcrText(a,c)),O.debug("Trying to compress content stream.");const p=await ur(u.join(`
+`)),d=this._addObject(p.dict,void 0,p.stream);l.data.Contents=M(d);const m=l.data.Resources,g={},y={};for(const[x,A]of n.entries()){if(hr(A))continue;const k=`/Im${x+1}`;if(g[k.substring(1)]=this._makeDeferredReference(k),(F=A.choiceInfo)!=null&&F.optional){const C=f[k];y[C.substring(1)]=this._makeDeferredReference(C)}}m.XObject=g,Object.keys(y).length>0&&(m.Properties=y),O.debug("Creating image objects.");const b=this._canvasInfos.findIndex(x=>x.canvas.id===t);for(const[x,A]of n.entries()){if(hr(A)){this._addObject({}),this._polyglot&&this._addObject({});continue}const k=new Uint8Array(A.data),C=Ki.open(k),S=C.toObjects(this._polyglot?this._nextObjNo+1:this._nextObjNo);if(A.format!=="jpeg"&&C instanceof tr){let R=S.slice(-1)[0].num;for(let V=0;S.length<3;V++)S.push({num:R++})}const E=S[0],_=`/Im${x+1}`;if(this._deferredReferences.get(_).refObj=E.num,this._polyglot)if(C instanceof tr){const R=this._getSerializedSize(E,!0),V=`img/canvas-${b}-${x}.jpg`;this._insertZipHeaderDummyObject({filename:V,data:k,bytesUntilActualData:R})}else this._addObject({});S.forEach(R=>this._objects.push(R)),this._nextObjNo=S.slice(-1)[0].num+1}if(n.some(x=>{var A;return(A=x==null?void 0:x.choiceInfo)==null?void 0:A.optional})){O.debug("Creating optional content groups for page");for(const[x,A]of n.entries()){const k=`/Im${x+1}`;if(A!=null&&A.choiceInfo){if(hr(A)){this._addObject({});continue}this._deferredReferences.get(f[k]).refObj=this._nextObjNo,this._addObject({Type:"/OCG",Name:A.choiceInfo.label?`(${$e(A.choiceInfo.label,this._langPref,"/")})`:void 0,Intent:"/View",Usage:A.choiceInfo.visibleByDefault?"/ON":"/OFF"})}}}const w=this._canvasInfos[b];if(a!=null&&a.markup){const x=this._canvasInfos.findIndex(k=>k.canvas.id===t);let A=`ocr/canvas-${x}`;a.mimeType.indexOf("html")>=0?A+=".html":A+=".xml",await this._embedResource(A,`OCR for canvas #${x}`,a.mimeType,a.markup)}else w.ocr&&(this._addObject({}),this._addObject({}),this._polyglot&&this._addObject({}));s&&s.length>0&&(O.debug("Creating annotations for page"),h.Annots=s.flatMap(x=>fp(x,c,i)).map(x=>M(this._addObject(x)))),O.debug("Flushing data for page"),await this._flush(),O.debug("Finished rendering page")}_renderOcrText(t,r){const i=t.height,n=[];n.push("BT"),n.push("3 Tr");const s=this._nextObjNo-1;let a=0;const o=[],c=(h,l)=>{if(h.type==="block")o.push({type:"Sect",children:[],pageObjNum:s,mcs:[]});else if(h.type==="paragraph")o.push({type:"P",children:[],pageObjNum:s,mcs:[]}),l&&l.children.push(o.slice(-1)[0]);else if(h.type==="line"){n.push(...this.renderOcrLine(h,a,r,i,s)),l&&l.children.push({type:"Span",children:[],pageObjNum:s,mcs:[a]}),a++;return}for(const u of h.children)c(u,o.slice(-1)[0])};return c(t),this._strucTree.push(...o),n.push("ET"),n.join(`
+`)}renderOcrLine(t,r,i,n,s){const a="/f-0-0",u=[];u.push(`/Span << /MCID ${r} >> BDC`);const f=t.height*i*.75;u.push(`${a} ${f} Tf`);const p=t.x*i,d=n-t.y-t.height*.75,m=d*i;u.push(`1 0 0 1 ${p} ${m} Tm`);let g=0,y=0;for(const b of t.words){if(!b.text||!b.width)continue;const w=(b.x-t.x)*i,x=(n-b.y-b.height*.75-d)*i,A=b.width*i,k=b.height*i,C=w-g,S=x-y;u.push(`${C*1+S*0} ${C*0+S*1} Td`),g=w,y=x;const E=Math.pow(Math.pow(A,2)+Math.pow(k,2),.5),_=b.text.length;u.push(`${ai*(100*E/(f*_))} Tz`);const R=Se(Ti(b.text+" ",!1));u.push(`[ ${R} ] TJ`)}return u.push("EMC"),u.push(""),this._pageMCIds.has(s)||this._pageMCIds.set(s,[]),this._pageMCIds.get(s).push(r),u}get bytesWritten(){return this._offset}get totalCanvasObjects(){return this._canvasInfos.reduce((t,r,i)=>t+this.getCanvasObjectNumber(i),0)}getObjectsPerCanvas(t){const{images:r,ocr:i,numAnnotations:n}=this._canvasInfos[t];let s=r.map(a=>a.format==="jpeg"?1:3).reduce((a,o)=>a+o,0)+2+r.filter(a=>a.choiceInfo!==void 0).length+n;return this._polyglot&&(s=s+r.length+(i?1:0)),i&&(s+=2),s}getCanvasObjectNumber(t){let r=this._firstPageObjectNum;for(const[i]of this._canvasInfos.entries()){if(i===t)return r;r+=this.getObjectsPerCanvas(i)}throw new Error(`Canvas #${t} not found.`)}async _flush(){this._offsets.length===0&&(O.debug("Writing PDF header"),await this._write(`%PDF-1.5
+%
+`));for(const t of this._objects)t&&(O.debug(`Serializing object #${t.num}`),await this._serializeObject(t));this._objects=[]}_getSerializedSize({num:t,data:r,stream:i},n=!1){let s=0;if(s+=`${t} 0 obj
+`.length,r&&(s+=Se(r).length),i){if(s+=8,n)return s;typeof i=="string"?s+=Pe.encode(i).byteLength:s+=i.byteLength,s+=10}return s+=8,s}async _serializeObject(t){this._offsets.push(this._offset);const{num:r,data:i,stream:n}=t;await this._write(`${r} 0 obj
+`),i&&await this._write(Se(i)),n&&(await this._write(`
+stream
+`),await this._write(n),await this._write(`
+endstream`)),await this._write(`
+endobj
+`)}async _write(t){if(this._writer===void 0)throw new Error("Cannot perform mutating operations on an already closed PDFGenerator.");typeof t=="string"&&(t=Pe.encode(t)),this._offset+=t.byteLength,await this._writer.write(t)}async _writeStructureTree(){const t={Nums:[]},r=M(this._addObject(t)),i={Type:"/StructTreeRoot",K:[],ParentTree:r,ParentTreeNextKey:this._nextStructParentId},n=new Map,s=M(this._addObject(i)),a=async(o,c,h)=>{const l={Type:"/StructElem",S:`/${o.type}`,P:h,Pg:M(o.pageObjNum),K:[]};n.has(o.pageObjNum)||n.set(o.pageObjNum,[]);const u=M(this._addObject(l));if(c.K.push(u),o.children.length>0)for(const f of o.children)await a(f,l,u);else o.mcs.length==1?l.K=o.mcs[0]:o.mcs.length>0&&(l.K=o.mcs);if(o.mcs.length>0){const f=n.get(o.pageObjNum);for(const p of o.mcs)f[p]=u}this._objects.length>1e3&&await this._flush()};for(const o of this._strucTree)await a(o,i,s);for(const[o,c]of n){const h=this._pageParentIds.get(o);t.Nums.push(h,M(this._addObject(c)))}await this._flush()}async end(){if(!this._writer)return;O.debug("Writing xref table");const t=[[0,65535,"f"],...this._offsets.map(a=>[a,0,"n"])],r=t.map(([a,o,c])=>[a.toString(10).padStart(10,"0"),o.toString(10).padStart(5,"0"),c,""].join(" ")).join(`
+`),i=this._offset;await this._write(`xref
+0 ${t.length}
+${r}
+`);const n={Size:t.length,Root:this._objRefs.Catalog,Info:this._objRefs.Info,ID:[Un(32),Un(32)]};await this._write(`
 trailer
-${serialize(trailerDict)}`);
-    const trailer = `startxref
-${xrefOffset}
-%%EOF`;
-    if (this._polyglot && this._zipCatalog) {
-      logger.debug("Writing zip end of central directory");
-      await this._write("9990 0 obj\n<<>>\nstream\n");
-      const endObj = "\nendstream\nendobj\n";
-      await this._write(
-        buildCentralFileDirectory({
-          files: this._zipCatalog,
-          trailingLength: trailer.length + endObj.length,
-          offset: this._offset
-        })
-      );
-      await this._write(endObj);
-    }
-    await this._flush();
-    logger.debug("Writing trailer");
-    await this._write(trailer);
-    logger.debug("Flushing");
-    await this._flush();
-    logger.debug("PDF finished, closing writer");
-    await this._writer.close();
-    logger.debug("Writer closed");
-    this._writer = void 0;
-  }
-  _insertZipHeaderDummyObject({
-    filename,
-    data,
-    deflatedData,
-    bytesUntilActualData
-  }) {
-    if (this._zipBaseDir) {
-      filename = `${this._zipBaseDir}/${filename}`;
-    }
-    const zipObjOffset = this._offset + this._objects.reduce((acc, obj) => acc + this._getSerializedSize(obj), 0);
-    const creationDate = /* @__PURE__ */ new Date();
-    bytesUntilActualData += "\nendstream\nendobj\n".length;
-    const zipObj = this._addObject(
-      {},
-      void 0,
-      buildLocalZipHeader({
-        filename,
-        data,
-        compressedData: deflatedData,
-        extraDataLength: bytesUntilActualData,
-        creationDate
-      })
-    );
-    const localHeaderOffset = zipObjOffset + this._getSerializedSize(zipObj, true);
-    if (!this._zipCatalog) {
-      this._zipCatalog = [];
-    }
-    this._zipCatalog.push({
-      localHeaderOffset,
-      deflated: deflatedData?.length !== data.length,
-      creationDate: /* @__PURE__ */ new Date(),
-      crc32: crc32(data),
-      dataLength: data.length,
-      // skip 2 bytes for zlib header
-      compressedDataLength: deflatedData ? deflatedData.length - 2 : data.length,
-      filename
-    });
-  }
-};
-
-// src/res/licenses.ts
-var licenses = {
-  "http://creativecommons.org/licenses/by-nc-sa/2.0/fr/": {
-    text: "Creative Commons Attribution-NonCommercial-ShareAlike 2.0 France (CC-BY-NC-SA-2.0-FR)",
-    logo: "https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nc-sa.svg"
-  },
-  "http://creativecommons.org/licenses/by-sa/4.0/": {
-    text: "Creative Commons Attribution Share Alike 4.0 International (CC-BY-SA-4.0)",
-    logo: "https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-sa.svg"
-  },
-  "http://creativecommons.org/licenses/by/3.0/de/": {
-    text: "Creative Commons Attribution 3.0 Germany (CC-BY-3.0-DE)",
-    logo: "https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by.svg"
-  },
-  "http://creativecommons.org/licenses/by-nc-nd/3.0/": {
-    text: "Creative Commons Attribution Non Commercial No Derivatives 3.0 Unported (CC-BY-NC-ND-3.0)",
-    logo: "https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nc-nd.svg"
-  },
-  "http://creativecommons.org/licenses/by/1.0/": {
-    text: "Creative Commons Attribution 1.0 Generic (CC-BY-1.0)",
-    logo: "https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by.svg"
-  },
-  "http://creativecommons.org/licenses/by-nd/1.0/": {
-    text: "Creative Commons Attribution No Derivatives 1.0 Generic (CC-BY-ND-1.0)",
-    logo: "https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nd.svg"
-  },
-  "http://creativecommons.org/licenses/by-nc-sa/3.0/de/": {
-    text: "Creative Commons Attribution Non Commercial Share Alike 3.0 Germany (CC-BY-NC-SA-3.0-DE)",
-    logo: "https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nc-sa.svg"
-  },
-  "http://creativecommons.org/licenses/by-nc-sa/1.0/": {
-    text: "Creative Commons Attribution Non Commercial Share Alike 1.0 Generic (CC-BY-NC-SA-1.0)",
-    logo: "https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nc-sa.svg"
-  },
-  "http://creativecommons.org/licenses/by-nd/4.0/": {
-    text: "Creative Commons Attribution No Derivatives 4.0 International (CC-BY-ND-4.0)",
-    logo: "https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nd.svg"
-  },
-  "http://creativecommons.org/licenses/by-sa/3.0/at/": {
-    text: "Creative Commons Attribution Share Alike 3.0 Austria (CC-BY-SA-3.0-AT)",
-    logo: "https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-sa.svg"
-  },
-  "http://creativecommons.org/licenses/by/3.0/at/": {
-    text: "Creative Commons Attribution 3.0 Austria (CC-BY-3.0-AT)",
-    logo: "https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by.svg"
-  },
-  "http://creativecommons.org/licenses/by/3.0/": {
-    text: "Creative Commons Attribution 3.0 Unported (CC-BY-3.0)",
-    logo: "https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by.svg"
-  },
-  "http://creativecommons.org/licenses/by-nc/2.0/": {
-    text: "Creative Commons Attribution Non Commercial 2.0 Generic (CC-BY-NC-2.0)",
-    logo: "https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nc.svg"
-  },
-  "http://creativecommons.org/licenses/by-nc-sa/2.5/": {
-    text: "Creative Commons Attribution Non Commercial Share Alike 2.5 Generic (CC-BY-NC-SA-2.5)",
-    logo: "https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nc-sa.svg"
-  },
-  "http://creativecommons.org/licenses/by-nc/2.5/": {
-    text: "Creative Commons Attribution Non Commercial 2.5 Generic (CC-BY-NC-2.5)",
-    logo: "https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nc.svg"
-  },
-  "http://creativecommons.org/licenses/by-nd-nc/1.0/": {
-    text: "Creative Commons Attribution Non Commercial No Derivatives 1.0 Generic (CC-BY-NC-ND-1.0)",
-    logo: "https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nc-nd.svg"
-  },
-  "http://creativecommons.org/licenses/by-nd/3.0/": {
-    text: "Creative Commons Attribution No Derivatives 3.0 Unported (CC-BY-ND-3.0)",
-    logo: "https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nd.svg"
-  },
-  "http://creativecommons.org/licenses/by-sa/2.5/": {
-    text: "Creative Commons Attribution Share Alike 2.5 Generic (CC-BY-SA-2.5)",
-    logo: "https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-sa.svg"
-  },
-  "http://creativecommons.org/licenses/by-nc-sa/2.0/uk/": {
-    text: "Creative Commons Attribution Non Commercial Share Alike 2.0 England and Wales (CC-BY-NC-SA-2.0-UK)",
-    logo: "https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nc-sa.svg"
-  },
-  "http://creativecommons.org/licenses/by/2.0/": {
-    text: "Creative Commons Attribution 2.0 Generic (CC-BY-2.0)",
-    logo: "https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by.svg"
-  },
-  "http://creativecommons.org/licenses/by-nd/2.5/": {
-    text: "Creative Commons Attribution No Derivatives 2.5 Generic (CC-BY-ND-2.5)",
-    logo: "https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nd.svg"
-  },
-  "http://creativecommons.org/licenses/by-nc-nd/2.0/": {
-    text: "Creative Commons Attribution Non Commercial No Derivatives 2.0 Generic (CC-BY-NC-ND-2.0)",
-    logo: "https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nc-nd.svg"
-  },
-  "http://creativecommons.org/licenses/by-nc-sa/3.0/igo/": {
-    text: "Creative Commons Attribution Non Commercial Share Alike 3.0 IGO (CC-BY-NC-SA-3.0-IGO)",
-    logo: "https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nc-sa.svg"
-  },
-  "http://creativecommons.org/licenses/publicdomain//": {
-    text: "Creative Commons Public Domain Dedication and Certification (CC-PDDC)",
-    logo: "https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/publicdomain.svg"
-  },
-  "http://creativecommons.org/licenses/by-nc-sa/2.0/": {
-    text: "Creative Commons Attribution Non Commercial Share Alike 2.0 Generic (CC-BY-NC-SA-2.0)",
-    logo: "https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nc-sa.svg"
-  },
-  "http://creativecommons.org/licenses/by-nc-nd/3.0/de/": {
-    text: "Creative Commons Attribution Non Commercial No Derivatives 3.0 Germany (CC-BY-NC-ND-3.0-DE)",
-    logo: "https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nc-nd.svg"
-  },
-  "http://creativecommons.org/licenses/by-nc/3.0/": {
-    text: "Creative Commons Attribution Non Commercial 3.0 Unported (CC-BY-NC-3.0)",
-    logo: "https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nc.svg"
-  },
-  "http://creativecommons.org/licenses/by-nc/3.0/de/": {
-    text: "Creative Commons Attribution Non Commercial 3.0 Germany (CC-BY-NC-3.0-DE)",
-    logo: "https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nc.svg"
-  },
-  "http://creativecommons.org/licenses/by-sa/1.0/": {
-    text: "Creative Commons Attribution Share Alike 1.0 Generic (CC-BY-SA-1.0)",
-    logo: "https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-sa.svg"
-  },
-  "http://creativecommons.org/licenses/by-nd/3.0/de/": {
-    text: "Creative Commons Attribution No Derivatives 3.0 Germany (CC-BY-ND-3.0-DE)",
-    logo: "https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nd.svg"
-  },
-  "http://creativecommons.org/licenses/by-nc-nd/2.5/": {
-    text: "Creative Commons Attribution Non Commercial No Derivatives 2.5 Generic (CC-BY-NC-ND-2.5)",
-    logo: "https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nc-nd.svg"
-  },
-  "http://creativecommons.org/licenses/by-sa/3.0/": {
-    text: "Creative Commons Attribution Share Alike 3.0 Unported (CC-BY-SA-3.0)",
-    logo: "https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-sa.svg"
-  },
-  "http://creativecommons.org/licenses/by-nc-sa/4.0/": {
-    text: "Creative Commons Attribution Non Commercial Share Alike 4.0 International (CC-BY-NC-SA-4.0)",
-    logo: "https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nc-sa.svg"
-  },
-  "http://creativecommons.org/licenses/by-sa/2.0/": {
-    text: "Creative Commons Attribution Share Alike 2.0 Generic (CC-BY-SA-2.0)",
-    logo: "https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-sa.svg"
-  },
-  "http://creativecommons.org/licenses/by-sa/2.1/jp/": {
-    text: "Creative Commons Attribution Share Alike 2.1 Japan (CC-BY-SA-2.1-JP)",
-    logo: "https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-sa.svg"
-  },
-  "http://creativecommons.org/licenses/by/2.5/": {
-    text: "Creative Commons Attribution 2.5 Generic (CC-BY-2.5)",
-    logo: "https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by.svg"
-  },
-  "http://creativecommons.org/licenses/by-sa/2.0/uk/": {
-    text: "Creative Commons Attribution Share Alike 2.0 England and Wales (CC-BY-SA-2.0-UK)",
-    logo: "https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-sa.svg"
-  },
-  "http://creativecommons.org/licenses/by/3.0/nl/": {
-    text: "Creative Commons Attribution 3.0 Netherlands (CC-BY-3.0-NL)",
-    logo: "https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by.svg"
-  },
-  "http://creativecommons.org/licenses/by-nc-sa/3.0/": {
-    text: "Creative Commons Attribution Non Commercial Share Alike 3.0 Unported (CC-BY-NC-SA-3.0)",
-    logo: "https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nc-sa.svg"
-  },
-  "http://creativecommons.org/licenses/by/4.0/": {
-    text: "Creative Commons Attribution 4.0 International (CC-BY-4.0)",
-    logo: "https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by.svg"
-  },
-  "http://creativecommons.org/licenses/by/3.0/us/": {
-    text: "Creative Commons Attribution 3.0 United States (CC-BY-3.0-US)",
-    logo: "https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by.svg"
-  },
-  "http://creativecommons.org/licenses/by-nc-nd/4.0/": {
-    text: "Creative Commons Attribution Non Commercial No Derivatives 4.0 International (CC-BY-NC-ND-4.0)",
-    logo: "https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nc-nd.svg"
-  },
-  "http://creativecommons.org/licenses/by-sa/3.0/de/": {
-    text: "Creative Commons Attribution Share Alike 3.0 Germany (CC-BY-SA-3.0-DE)",
-    logo: "https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-sa.svg"
-  },
-  "http://creativecommons.org/licenses/by-nc-nd/3.0/igo/": {
-    text: "Creative Commons Attribution Non Commercial No Derivatives 3.0 IGO (CC-BY-NC-ND-3.0-IGO)",
-    logo: "https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nc-nd.svg"
-  },
-  "http://creativecommons.org/publicdomain/zero/1.0/": {
-    text: "Creative Commons Zero v1.0 Universal (CC0-1.0)",
-    logo: "https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/cc-zero.svg"
-  },
-  "http://creativecommons.org/publicdomain/mark/1.0/": {
-    text: "Public Domain Mark 1.0: No Copyright",
-    logo: "https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/publicdomain.svg"
-  },
-  "http://creativecommons.org/licenses/by/2.5/au/": {
-    text: "Creative Commons Attribution 2.5 Australia (CC-BY-2.5-AU)",
-    logo: "https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by.svg"
-  },
-  "http://creativecommons.org/licenses/by-nd/2.0/": {
-    text: "Creative Commons Attribution No Derivatives 2.0 Generic (CC-BY-ND-2.0)",
-    logo: "https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nd.svg"
-  },
-  "http://creativecommons.org/licenses/by-nc/1.0/": {
-    text: "Creative Commons Attribution Non Commercial 1.0 Generic (CC-BY-NC-1.0)",
-    logo: "https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nc.svg"
-  },
-  "http://creativecommons.org/licenses/by-nc/4.0/": {
-    text: "Creative Commons Attribution Non Commercial 4.0 International (CC-BY-NC-4.0)",
-    logo: "https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nc.svg"
-  },
-  "http://rightsstatements.org/vocab/InC/1.0/": {
-    text: "In Copyright",
-    logo: "https://rightsstatements.org/files/buttons/InC.dark.svg"
-  },
-  "http://rightsstatements.org/vocab/InC-OW-EU/1.0/": {
-    text: "In Copyright - EU Orphan Work",
-    logo: "https://rightsstatements.org/files/buttons/InC-OW-EU.dark.svg"
-  },
-  "http://rightsstatements.org/vocab/InC-EDU/1.0/": {
-    text: "In Copyright - Educational Use Permitted",
-    logo: "https://rightsstatements.org/files/buttons/InC-EDU.dark.svg"
-  },
-  "http://rightsstatements.org/vocab/InC-NC/1.0/": {
-    text: "In Copyright - Non-Commercial Use Permitted",
-    logo: "https://rightsstatements.org/files/buttons/InC-NC.dark.svg"
-  },
-  "http://rightsstatements.org/vocab/InC-RUU/1.0/": {
-    text: "In Copyright - Rights-holder(s) Unlocatable or Unidentifiable",
-    logo: "https://rightsstatements.org/files/buttons/InC-RUU.dark.svg"
-  },
-  "http://rightsstatements.org/vocab/NoC-CR/1.0/": {
-    text: "No Copyright - Contractual Restrictions",
-    logo: "https://rightsstatements.org/files/buttons/NoC-CR.dark.svg"
-  },
-  "http://rightsstatements.org/vocab/NoC-NC/1.0/": {
-    text: "No Copyright - Non-Commercial Use Only",
-    logo: "https://rightsstatements.org/files/buttons/NoC-NC.dark.svg"
-  },
-  "http://rightsstatements.org/vocab/NoC-OKLR/1.0/": {
-    text: "No Copyright - Other Known Legal Restrictions",
-    logo: "https://rightsstatements.org/files/buttons/NoC-OKLR.dark.svg"
-  },
-  "http://rightsstatements.org/vocab/NoC-US/1.0/": {
-    text: "No Copyright - United States",
-    logo: "https://rightsstatements.org/files/buttons/NoC-US.dark.svg"
-  },
-  "http://rightsstatements.org/vocab/CNE/1.0/": {
-    text: "Copyright Not Evaluated",
-    logo: "https://rightsstatements.org/files/buttons/CNE.dark.svg"
-  },
-  "http://rightsstatements.org/vocab/UND/1.0/": {
-    text: "Copyright Undetermined",
-    logo: "https://rightsstatements.org/files/buttons/UND.dark.svg"
-  },
-  "http://rightsstatements.org/vocab/NKC/1.0/": {
-    text: "No Known Copyright",
-    logo: "https://rightsstatements.org/files/buttons/NKC.dark.svg"
-  }
-};
-function getLicenseInfo(uri) {
-  uri = uri.replace(/^https:/, "http:").replace(/\/deed\.[a-z]{2}$/, "");
-  if (!uri.endsWith("/")) {
-    uri += "/";
-  }
-  return licenses[uri];
-}
-
-// src/convert.ts
-function getCanvasesForSampling(canvases, numSamples) {
-  if (canvases.length <= numSamples) {
-    return canvases;
-  }
-  const meanPixels = canvases.reduce(
-    (x, { width, height }) => x + width * height,
-    0
-  ) / canvases.length;
-  const candidateCanvases = canvases.filter(
-    (c) => Math.abs(meanPixels - c.width * c.height) <= 0.25 * meanPixels
-  );
-  if (candidateCanvases.length <= numSamples) {
-    return candidateCanvases;
-  }
-  const sampleCanvases = [];
-  while (sampleCanvases.length < numSamples) {
-    const candidate = candidateCanvases[Math.floor(Math.random() * candidateCanvases.length)];
-    if (sampleCanvases.indexOf(candidate) < 0) {
-      sampleCanvases.push(candidate);
-    }
-  }
-  return sampleCanvases;
-}
-async function estimatePdfSize({
-  manifest: inputManifest,
-  concurrency = 1,
-  scaleFactor,
-  filterCanvases = () => true,
-  numSamples = 8
-}) {
-  let manifestId;
-  if (typeof inputManifest === "string") {
-    manifestId = inputManifest;
-  } else {
-    manifestId = inputManifest.id ?? inputManifest["@id"];
-  }
-  const manifestJson = await fetchManifestJson(manifestId);
-  const manifest = await vault.loadManifest(manifestId, manifestJson);
-  if (!manifest) {
-    throw new Error(`Failed to load manifest from ${manifestId}`);
-  }
-  let canvasPredicate;
-  if (Array.isArray(filterCanvases)) {
-    canvasPredicate = (canvasId) => filterCanvases.indexOf(canvasId) >= 0;
-  } else {
-    canvasPredicate = filterCanvases;
-  }
-  const canvases = vault.get(
-    manifest.items.filter((c) => canvasPredicate(c.id))
-  );
-  const totalCanvasPixels = canvases.reduce(
-    (sum, canvas) => sum + canvas.width * canvas.height,
-    0
-  );
-  const sampleCanvases = getCanvasesForSampling(canvases, numSamples);
-  const samplePixels = sampleCanvases.reduce(
-    (sum, canvas) => sum + canvas.width * canvas.height,
-    0
-  );
-  const queue = new import_p_queue.default({ concurrency });
-  const canvasData = await Promise.all(
-    sampleCanvases.map(
-      (c) => queue.add(async () => {
-        const info = getCanvasInfo(c);
-        return fetchCanvasData(c, info.images, { scaleFactor, sizeOnly: true });
-      })
-    )
-  );
-  const corsSupported = canvasData.filter(isDefined).flatMap((c) => c.images).every((i) => i.corsAvailable);
-  const sampleBytes = canvasData.filter(isDefined).flatMap((c) => c.images).reduce((size, data) => size + (data?.numBytes ?? 0), 0);
-  const bpp = sampleBytes / samplePixels;
-  return {
-    size: bpp * totalCanvasPixels,
-    corsSupported
-  };
-}
-async function buildOutlineFromRanges(manifest, canvases, languagePreference) {
-  const canvasIds = canvases.map((canvas) => canvas.id);
-  const isCanvas = (ri) => typeof ri !== "string" && ri.type === "Canvas";
-  const isRange = (ri) => typeof ri !== "string" && ri.type == "Range";
-  const seenRanges = /* @__PURE__ */ new Set();
-  const handleTocRange = async (range) => {
-    if (seenRanges.has(range.id)) {
-      return;
-    }
-    const firstCanvas = range.items.filter(isCanvas).filter((c) => canvasIds.indexOf(c.id) >= 0).filter(isCanvas).sort((a, b) => canvasIds.indexOf(a.id) > canvasIds.indexOf(b.id) ? -1 : 1)[0];
-    const rangeLabel = getI18nValue(
-      range.label ?? "<untitled>",
-      languagePreference,
-      "; "
-    );
-    const childRanges = vault.get(range.items.filter(isRange));
-    const children = (await Promise.all(childRanges.map(handleTocRange))).filter(isDefined);
-    let startCanvas;
-    if (range.start) {
-      startCanvas = await fetchStartCanvasInfo(range);
-    }
-    seenRanges.add(range.id);
-    if (children.length === 0 && !firstCanvas) {
-      return;
-    } else if (!startCanvas && firstCanvas) {
-      startCanvas = firstCanvas.id;
-    } else if (!startCanvas) {
-      startCanvas = children[0].startCanvas;
-    }
-    return {
-      label: rangeLabel,
-      startCanvas,
-      children
-    };
-  };
-  let tocRanges = vault.get(manifest.structures);
-  const topRange = tocRanges.find((r) => r.behavior.indexOf("top") >= 0);
-  if (topRange) {
-    tocRanges = [topRange];
-  }
-  return (await Promise.all(
-    tocRanges.map(handleTocRange)
-  )).filter(isDefined) ?? [];
-}
-var ProgressTracker = class {
-  canvasPixels = 0;
-  pixelsWritten = 0;
-  pixelBytesFactor = 0;
-  pixelScaleFactor = 0;
-  timeStart;
-  pdfGen;
-  totalPages;
-  totalCanvasPixels = 0;
-  countingStream;
-  onProgress;
-  onNotification;
-  constructor(canvases, countingStream, pdfGen, onProgress, onNotification) {
-    this.totalCanvasPixels = canvases.reduce(
-      (sum, canvas) => sum + canvas.width * canvas.height,
-      0
-    );
-    this.totalPages = canvases.length;
-    this.pdfGen = pdfGen;
-    this.countingStream = countingStream;
-    this.onProgress = onProgress;
-    this.onNotification = onNotification;
-  }
-  /** Check if there is still data that needs to be written out. */
-  get writeOutstanding() {
-    return this.pdfGen.bytesWritten > this.countingStream.bytesWritten;
-  }
-  /** Emit a progress update, with an optional message. */
-  emitProgress(pagesWritten, messageCode) {
-    if (!this.timeStart) {
-      this.timeStart = now();
-    }
-    const bytesPushed = this.pdfGen.bytesWritten;
-    let estimatedFileSize;
-    if (pagesWritten === this.totalPages) {
-      estimatedFileSize = bytesPushed;
-    } else if (pagesWritten > 0) {
-      estimatedFileSize = Math.floor(
-        this.pixelBytesFactor * this.pixelScaleFactor * this.totalCanvasPixels
-      );
-    }
-    const bytesWritten = this.countingStream.bytesWritten;
-    const writeSpeed = bytesPushed / ((now() - this.timeStart) / 1e3);
-    let remainingDuration = Number.POSITIVE_INFINITY;
-    if (estimatedFileSize) {
-      remainingDuration = (estimatedFileSize - bytesWritten) / writeSpeed;
-    }
-    this.onProgress?.({
-      messageCode,
-      pagesWritten,
-      totalPages: this.totalPages,
-      bytesWritten,
-      bytesPushed,
-      estimatedFileSize,
-      writeSpeed,
-      remainingDuration
-    });
-  }
-  /** Emit a notification message to inform the user about unexpected stuff that
-   * happens during PDF generation */
-  emitNotification(notification) {
-    this.onNotification?.(notification);
-  }
-  /** Update how many actual pixels and 'canvas pixels' have been written. */
-  updatePixels(pixelsWritten, canvasPixels) {
-    this.pixelsWritten += pixelsWritten;
-    this.canvasPixels += canvasPixels;
-    this.pixelScaleFactor = this.pixelsWritten / this.canvasPixels;
-    this.pixelBytesFactor = this.pdfGen.bytesWritten / this.pixelsWritten;
-  }
-};
-async function getCoverPagePdf(manifest, languagePreference, endpoint, callback) {
-  const params = {
-    // NOTE: Manifest label is mandatory, i.e. safe to assert non-null
-    // eslint-disable-next-line @typescript-eslint/no-non-null-assertion
-    title: getI18nValue(
-      manifest.label ?? "<untitled>",
-      languagePreference,
-      "; "
-    ),
-    manifestUrl: manifest.id,
-    pdiiifVersion: version_default
-  };
-  const thumbUrl = await getThumbnail(manifest, 512);
-  if (thumbUrl) {
-    params.thumbnail = { url: thumbUrl };
-    const manifestThumb = vault.get(manifest.thumbnail)[0];
-    if (manifestThumb && "type" in manifestThumb) {
-      params.thumbnail.iiifImageService = manifestThumb.service?.find(
-        (s) => s?.type?.startsWith("ImageService") ?? false
-      )?.id;
-    }
-  }
-  const provider = vault.get(manifest.provider)[0];
-  const required = manifest.requiredStatement;
-  if (provider) {
-    params.provider = {
-      label: getI18nValue(provider.label, languagePreference, "; "),
-      homepage: provider.homepage?.[0]?.id,
-      logo: provider.logo?.[0]?.id
-    };
-    if (params.provider.label === "Unknown") {
-      params.provider.label = "";
-    }
-  }
-  if (required != null && required.label) {
-    params.requiredStatement = {
-      label: getI18nValue(required.label, languagePreference, "; "),
-      value: getI18nValue(required.value, languagePreference, "; ")
-    };
-  }
-  const license = manifest.rights;
-  if (license) {
-    const licenseDef = getLicenseInfo(license);
-    params.rights = {
-      text: licenseDef?.text ?? license,
-      url: license,
-      logo: licenseDef?.logo
-    };
-  }
-  params.metadata = manifest.metadata?.map((itm) => {
-    const label = getI18nValue(itm.label, languagePreference, "; ");
-    const values = getI18nValue(itm.value, languagePreference, "|||").split(
-      "|||"
-    );
-    if (!label || values.length === 0) {
-      return;
-    }
-    if (values.length === 1) {
-      return [label, values[0]];
-    } else {
-      return [label, values];
-    }
-  }).filter((x) => x !== void 0) ?? [];
-  if (callback) {
-    return await callback(params);
-  } else if (endpoint) {
-    const resp = await fetchRespectfully(endpoint, {
-      method: "POST",
-      headers: { "Content-Type": "application/json" },
-      body: JSON.stringify(params)
-    });
-    const buf = await resp.arrayBuffer();
-    return new Uint8Array(buf);
-  } else {
-    throw "Either `endpoint` or `callback` must be specified!";
-  }
-}
-async function convertManifest(inputManifest, outputStream, {
-  fetchCanvasAnnotations = () => Promise.resolve([]),
-  filterCanvases = () => true,
-  languagePreference = [Intl.DateTimeFormat().resolvedOptions().locale],
-  scaleFactor,
-  metadata = {},
-  onProgress,
-  onNotification,
-  ppi,
-  concurrency = 1,
-  abortController = new AbortController(),
-  coverPageCallback,
-  coverPageEndpoint,
-  polyglotZipPdf,
-  polyglotZipBaseDir,
-  saxWasmLoader = async () => fetch(`https://unpkg.com/sax-wasm@${ocrParser.SAX_WASM_VERSION}/lib/sax-wasm.wasm`).then((res) => res.arrayBuffer()).then((buf) => new Uint8Array(buf))
-}) {
-  if (typeof process !== "undefined") {
-    import_events.default.setMaxListeners(100, abortController.signal);
-  }
-  let writer;
-  if (!outputStream) {
-    logger.debug("Writing to Blob");
-    writer = new BlobWriter();
-  } else if (typeof outputStream.destroy === "function") {
-    logger.debug("Writing to Node writable stream");
-    writer = new NodeWriter(outputStream);
-    outputStream.on("close", () => abortController.abort());
-  } else {
-    logger.debug("Writing to file system");
-    writer = new WebWriter(outputStream);
-  }
-  const countingWriter = new CountingWriter(writer);
-  const report = {
-    fileSizeBytes: 0,
-    numPages: 0
-  };
-  let canvasPredicate;
-  if (Array.isArray(filterCanvases)) {
-    canvasPredicate = (canvasId) => filterCanvases.indexOf(canvasId) >= 0;
-  } else {
-    canvasPredicate = filterCanvases;
-  }
-  let manifestId;
-  let manifestJson;
-  if (typeof inputManifest === "string") {
-    manifestId = inputManifest;
-    manifestJson = await fetchManifestJson(manifestId);
-  } else {
-    manifestId = inputManifest["@id"] ?? inputManifest.id;
-    manifestJson = inputManifest;
-  }
-  const manifest = await vault.loadManifest(manifestId, manifestJson);
-  if (!manifest) {
-    throw new Error(`Failed to load manifest from ${manifestId}`);
-  }
-  const pdfMetadata = { ...metadata };
-  if (!pdfMetadata.Title && manifest.label) {
-    pdfMetadata.Title = getI18nValue(
-      manifest.label,
-      languagePreference,
-      "; "
-    );
-  }
-  const canvases = vault.get(
-    manifest.items.filter((c) => canvasPredicate(c.id))
-  );
-  const hasText = !!canvases.find((c) => !!getOcrReferences(c));
-  const labels = canvases.map(
-    (canvas) => canvas.label ? getI18nValue(canvas.label, languagePreference, "; ") : ""
-  );
-  if (!saxParserWasm || !ocrParser.isInitialized()) {
-    if (!saxParserWasm) {
-      const wasm = await saxWasmLoader();
-      initializeSaxParser(wasm);
-    }
-    if (!ocrParser.isInitialized()) {
-      await ocrParser.initialize(() => Promise.resolve(saxParserWasm));
-      ocrParser.setupLogging({
-        debug: logger.debug.bind(logger),
-        info: logger.info.bind(logger),
-        warn: logger.warn.bind(logger),
-        error: logger.error.bind(logger)
-      });
-    }
-  }
-  logger.debug(`Setting up queue with ${concurrency} concurrent canvas fetches.`);
-  const queue = new import_p_queue.default({ concurrency });
-  abortController.signal.addEventListener("abort", () => queue.clear(), {
-    once: true
-  });
-  const canvasInfos = canvases.map(getCanvasInfo);
-  const canvasFuts = canvases.map((c, idx) => {
-    return queue.add(() => {
-      const info = canvasInfos[idx];
-      return fetchCanvasData(c, info.images, {
-        scaleFactor,
-        ppiOverride: ppi,
-        abortSignal: abortController.signal
-      });
-    });
-  });
-  const outline = await buildOutlineFromRanges(
-    manifest,
-    canvases,
-    languagePreference
-  );
-  const pdfGen = new PDFGenerator({
-    writer: countingWriter,
-    metadata: pdfMetadata,
-    canvasInfos: canvases.map((c, idx) => ({
-      canvasIdx: idx,
-      ...canvasInfos[idx]
-    })),
-    langPref: languagePreference,
-    pageLabels: labels,
-    outline,
-    hasText,
-    initialCanvas: await fetchStartCanvasInfo(manifest),
-    readingDirection: manifest.viewingDirection === "right-to-left" ? "right-to-left" : "left-to-right",
-    manifestJson,
-    zipPolyglot: polyglotZipPdf,
-    zipBaseDir: polyglotZipBaseDir
-  });
-  logger.debug(`Initialising PDF generator.`);
-  await pdfGen.setup();
-  const progress = new ProgressTracker(
-    canvases,
-    countingWriter,
-    pdfGen,
-    onProgress,
-    onNotification
-  );
-  progress.emitProgress(0);
-  if (coverPageCallback || coverPageEndpoint) {
-    logger.debug(`Generating cover page`);
-    progress.emitProgress(0, "generate-cover-page");
-    try {
-      const coverPageData = await getCoverPagePdf(
-        manifest,
-        languagePreference,
-        coverPageEndpoint,
-        coverPageCallback
-      );
-      logger.debug("Inserting cover page into PDF");
-      await pdfGen.insertCoverPages(coverPageData);
-    } catch (err) {
-      logger.error("Error while generating cover page", err);
-      abortController.abort();
-      throw err;
-    }
-  }
-  progress.emitProgress(0, "generate-pages");
-  for (let canvasIdx = 0; canvasIdx < canvases.length; canvasIdx++) {
-    if (abortController.signal.aborted) {
-      logger.debug("Abort signalled, aborting while waiting for image data.");
-      break;
-    }
-    try {
-      logger.debug(`Waiting for data for canvas #${canvasIdx}`);
-      const canvasData = await canvasFuts[canvasIdx];
-      if (!canvasData) {
-        throw "Aborted";
-      }
-      const canvas = vault.get(canvasData.canvas);
-      const canvasInfo = canvasInfos[canvasIdx];
-      const { images, ppi: ppi2, text, annotations, imageFailures } = canvasData;
-      if (imageFailures.length > 0) {
-        if (!report.failedImages) {
-          report.failedImages = [];
-        }
-        const reportData = {
-          canvasIndex: canvasIdx,
-          numFailed: imageFailures.length,
-          numTotal: images.length + imageFailures.length,
-          details: Object.fromEntries(
-            imageFailures.map((f) => [
-              f.resource.id ?? "<unknown>",
-              f.cause instanceof Error ? f.cause.toString() : f.cause
-            ])
-          )
-        };
-        report.failedImages.push(reportData);
-        progress.emitNotification({
-          code: "image-download-failure",
-          ...reportData
-        });
-      }
-      if (canvasInfo.ocr && !text?.markup) {
-        if (!report.failedOcr) {
-          report.failedOcr = [];
-        }
-        const reportData = {
-          canvasIndex: canvasIdx,
-          ocrUrl: canvasInfo.ocr.id
-        };
-        report.failedOcr.push(reportData);
-        progress.emitNotification({
-          code: "ocr-download-failure",
-          ...reportData
-        });
-      }
-      const externalAnnotations = await fetchCanvasAnnotations(canvas.id);
-      if (externalAnnotations != null) {
-        const normalized = await Promise.all(
-          externalAnnotations.map((a) => {
-            if (!("id" in a)) {
-              a = (0, import_presentation_2.convertPresentation2)(a);
-            }
-            return vault.load(a.id, a);
-          })
-        );
-        if (normalized) {
-          normalized.filter((a) => a !== void 0).map((a) => parseAnnotation(a, languagePreference)).filter((a) => a !== void 0).forEach((a) => annotations.push(a));
-        }
-      }
-      const stopMeasuring = metrics_default?.pageGenerationDuration.startTimer();
-      logger.debug(`Rendering canvas #${canvasIdx} into PDF`);
-      await pdfGen.renderPage(
-        canvasData.canvas.id,
-        { width: canvas.width, height: canvas.height },
-        [...images, ...imageFailures],
-        annotations,
-        text,
-        ppi2
-      );
-      stopMeasuring?.();
-      progress.updatePixels(
-        images.reduce(
-          (acc, img) => acc + img.width * img.height,
-          0
-        ),
-        canvas.width * canvas.height
-      );
-      report.numPages++;
-    } catch (err) {
-      if (err !== "Aborted") {
-        logger.error("Failed to render page", err);
-      }
-      queue.clear();
-      if (!abortController.signal.aborted) {
-        abortController.abort();
-      }
-      throw err;
-    } finally {
-      delete canvasFuts[canvasIdx];
-    }
-    progress.emitProgress(canvasIdx + 1);
-  }
-  logger.debug("Finalizing PDF");
-  const endPromise = pdfGen.end();
-  if (!abortController.signal.aborted) {
-    let closed = false;
-    endPromise.then(() => closed = true);
-    const progressOnDrain = async () => {
-      if (closed) {
-        return;
-      }
-      progress.emitProgress(canvases.length, "finishing");
-      while (!closed && progress.writeOutstanding) {
-        await writer.waitForDrain();
-      }
-    };
-    if (!closed) {
-      await writer.waitForDrain();
-      await progressOnDrain();
-    }
-  }
-  logger.debug("Waiting for writer to close.");
-  await endPromise;
-  report.fileSizeBytes = countingWriter.bytesWritten;
-  if (writer instanceof BlobWriter) {
-    return { ...report, data: writer.blob };
-  } else {
-    return report;
-  }
-}
-// Annotate the CommonJS export names for ESM import in node:
-0 && (module.exports = {
-  ConsoleLogger,
-  convertManifest,
-  estimatePdfSize,
-  fetchManifestJson,
-  setLogger,
-  version
-});
+${Se(n)}`);const s=`startxref
+${i}
+%%EOF`;if(this._polyglot&&this._zipCatalog){O.debug("Writing zip end of central directory"),await this._write(`9990 0 obj
+<<>>
+stream
+`);const a=`
+endstream
+endobj
+`;await this._write(Ed({files:this._zipCatalog,trailingLength:s.length+a.length,offset:this._offset})),await this._write(a)}await this._flush(),O.debug("Writing trailer"),await this._write(s),O.debug("Flushing"),await this._flush(),O.debug("PDF finished, closing writer"),await this._writer.close(),O.debug("Writer closed"),this._writer=void 0}_insertZipHeaderDummyObject({filename:t,data:r,deflatedData:i,bytesUntilActualData:n}){this._zipBaseDir&&(t=`${this._zipBaseDir}/${t}`);const s=this._offset+this._objects.reduce((h,l)=>h+this._getSerializedSize(l),0),a=new Date;n+=18;const o=this._addObject({},void 0,Fd({filename:t,data:r,compressedData:i,extraDataLength:n,creationDate:a})),c=s+this._getSerializedSize(o,!0);this._zipCatalog||(this._zipCatalog=[]),this._zipCatalog.push({localHeaderOffset:c,deflated:(i==null?void 0:i.length)!==r.length,creationDate:new Date,crc32:ss(r),dataLength:r.length,compressedDataLength:i?i.length-2:r.length,filename:t})}}const gp={"http://creativecommons.org/licenses/by-nc-sa/2.0/fr/":{text:"Creative Commons Attribution-NonCommercial-ShareAlike 2.0 France (CC-BY-NC-SA-2.0-FR)",logo:"https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nc-sa.svg"},"http://creativecommons.org/licenses/by-sa/4.0/":{text:"Creative Commons Attribution Share Alike 4.0 International (CC-BY-SA-4.0)",logo:"https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-sa.svg"},"http://creativecommons.org/licenses/by/3.0/de/":{text:"Creative Commons Attribution 3.0 Germany (CC-BY-3.0-DE)",logo:"https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by.svg"},"http://creativecommons.org/licenses/by-nc-nd/3.0/":{text:"Creative Commons Attribution Non Commercial No Derivatives 3.0 Unported (CC-BY-NC-ND-3.0)",logo:"https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nc-nd.svg"},"http://creativecommons.org/licenses/by/1.0/":{text:"Creative Commons Attribution 1.0 Generic (CC-BY-1.0)",logo:"https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by.svg"},"http://creativecommons.org/licenses/by-nd/1.0/":{text:"Creative Commons Attribution No Derivatives 1.0 Generic (CC-BY-ND-1.0)",logo:"https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nd.svg"},"http://creativecommons.org/licenses/by-nc-sa/3.0/de/":{text:"Creative Commons Attribution Non Commercial Share Alike 3.0 Germany (CC-BY-NC-SA-3.0-DE)",logo:"https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nc-sa.svg"},"http://creativecommons.org/licenses/by-nc-sa/1.0/":{text:"Creative Commons Attribution Non Commercial Share Alike 1.0 Generic (CC-BY-NC-SA-1.0)",logo:"https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nc-sa.svg"},"http://creativecommons.org/licenses/by-nd/4.0/":{text:"Creative Commons Attribution No Derivatives 4.0 International (CC-BY-ND-4.0)",logo:"https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nd.svg"},"http://creativecommons.org/licenses/by-sa/3.0/at/":{text:"Creative Commons Attribution Share Alike 3.0 Austria (CC-BY-SA-3.0-AT)",logo:"https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-sa.svg"},"http://creativecommons.org/licenses/by/3.0/at/":{text:"Creative Commons Attribution 3.0 Austria (CC-BY-3.0-AT)",logo:"https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by.svg"},"http://creativecommons.org/licenses/by/3.0/":{text:"Creative Commons Attribution 3.0 Unported (CC-BY-3.0)",logo:"https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by.svg"},"http://creativecommons.org/licenses/by-nc/2.0/":{text:"Creative Commons Attribution Non Commercial 2.0 Generic (CC-BY-NC-2.0)",logo:"https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nc.svg"},"http://creativecommons.org/licenses/by-nc-sa/2.5/":{text:"Creative Commons Attribution Non Commercial Share Alike 2.5 Generic (CC-BY-NC-SA-2.5)",logo:"https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nc-sa.svg"},"http://creativecommons.org/licenses/by-nc/2.5/":{text:"Creative Commons Attribution Non Commercial 2.5 Generic (CC-BY-NC-2.5)",logo:"https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nc.svg"},"http://creativecommons.org/licenses/by-nd-nc/1.0/":{text:"Creative Commons Attribution Non Commercial No Derivatives 1.0 Generic (CC-BY-NC-ND-1.0)",logo:"https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nc-nd.svg"},"http://creativecommons.org/licenses/by-nd/3.0/":{text:"Creative Commons Attribution No Derivatives 3.0 Unported (CC-BY-ND-3.0)",logo:"https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nd.svg"},"http://creativecommons.org/licenses/by-sa/2.5/":{text:"Creative Commons Attribution Share Alike 2.5 Generic (CC-BY-SA-2.5)",logo:"https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-sa.svg"},"http://creativecommons.org/licenses/by-nc-sa/2.0/uk/":{text:"Creative Commons Attribution Non Commercial Share Alike 2.0 England and Wales (CC-BY-NC-SA-2.0-UK)",logo:"https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nc-sa.svg"},"http://creativecommons.org/licenses/by/2.0/":{text:"Creative Commons Attribution 2.0 Generic (CC-BY-2.0)",logo:"https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by.svg"},"http://creativecommons.org/licenses/by-nd/2.5/":{text:"Creative Commons Attribution No Derivatives 2.5 Generic (CC-BY-ND-2.5)",logo:"https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nd.svg"},"http://creativecommons.org/licenses/by-nc-nd/2.0/":{text:"Creative Commons Attribution Non Commercial No Derivatives 2.0 Generic (CC-BY-NC-ND-2.0)",logo:"https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nc-nd.svg"},"http://creativecommons.org/licenses/by-nc-sa/3.0/igo/":{text:"Creative Commons Attribution Non Commercial Share Alike 3.0 IGO (CC-BY-NC-SA-3.0-IGO)",logo:"https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nc-sa.svg"},"http://creativecommons.org/licenses/publicdomain//":{text:"Creative Commons Public Domain Dedication and Certification (CC-PDDC)",logo:"https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/publicdomain.svg"},"http://creativecommons.org/licenses/by-nc-sa/2.0/":{text:"Creative Commons Attribution Non Commercial Share Alike 2.0 Generic (CC-BY-NC-SA-2.0)",logo:"https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nc-sa.svg"},"http://creativecommons.org/licenses/by-nc-nd/3.0/de/":{text:"Creative Commons Attribution Non Commercial No Derivatives 3.0 Germany (CC-BY-NC-ND-3.0-DE)",logo:"https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nc-nd.svg"},"http://creativecommons.org/licenses/by-nc/3.0/":{text:"Creative Commons Attribution Non Commercial 3.0 Unported (CC-BY-NC-3.0)",logo:"https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nc.svg"},"http://creativecommons.org/licenses/by-nc/3.0/de/":{text:"Creative Commons Attribution Non Commercial 3.0 Germany (CC-BY-NC-3.0-DE)",logo:"https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nc.svg"},"http://creativecommons.org/licenses/by-sa/1.0/":{text:"Creative Commons Attribution Share Alike 1.0 Generic (CC-BY-SA-1.0)",logo:"https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-sa.svg"},"http://creativecommons.org/licenses/by-nd/3.0/de/":{text:"Creative Commons Attribution No Derivatives 3.0 Germany (CC-BY-ND-3.0-DE)",logo:"https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nd.svg"},"http://creativecommons.org/licenses/by-nc-nd/2.5/":{text:"Creative Commons Attribution Non Commercial No Derivatives 2.5 Generic (CC-BY-NC-ND-2.5)",logo:"https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nc-nd.svg"},"http://creativecommons.org/licenses/by-sa/3.0/":{text:"Creative Commons Attribution Share Alike 3.0 Unported (CC-BY-SA-3.0)",logo:"https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-sa.svg"},"http://creativecommons.org/licenses/by-nc-sa/4.0/":{text:"Creative Commons Attribution Non Commercial Share Alike 4.0 International (CC-BY-NC-SA-4.0)",logo:"https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nc-sa.svg"},"http://creativecommons.org/licenses/by-sa/2.0/":{text:"Creative Commons Attribution Share Alike 2.0 Generic (CC-BY-SA-2.0)",logo:"https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-sa.svg"},"http://creativecommons.org/licenses/by-sa/2.1/jp/":{text:"Creative Commons Attribution Share Alike 2.1 Japan (CC-BY-SA-2.1-JP)",logo:"https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-sa.svg"},"http://creativecommons.org/licenses/by/2.5/":{text:"Creative Commons Attribution 2.5 Generic (CC-BY-2.5)",logo:"https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by.svg"},"http://creativecommons.org/licenses/by-sa/2.0/uk/":{text:"Creative Commons Attribution Share Alike 2.0 England and Wales (CC-BY-SA-2.0-UK)",logo:"https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-sa.svg"},"http://creativecommons.org/licenses/by/3.0/nl/":{text:"Creative Commons Attribution 3.0 Netherlands (CC-BY-3.0-NL)",logo:"https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by.svg"},"http://creativecommons.org/licenses/by-nc-sa/3.0/":{text:"Creative Commons Attribution Non Commercial Share Alike 3.0 Unported (CC-BY-NC-SA-3.0)",logo:"https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nc-sa.svg"},"http://creativecommons.org/licenses/by/4.0/":{text:"Creative Commons Attribution 4.0 International (CC-BY-4.0)",logo:"https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by.svg"},"http://creativecommons.org/licenses/by/3.0/us/":{text:"Creative Commons Attribution 3.0 United States (CC-BY-3.0-US)",logo:"https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by.svg"},"http://creativecommons.org/licenses/by-nc-nd/4.0/":{text:"Creative Commons Attribution Non Commercial No Derivatives 4.0 International (CC-BY-NC-ND-4.0)",logo:"https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nc-nd.svg"},"http://creativecommons.org/licenses/by-sa/3.0/de/":{text:"Creative Commons Attribution Share Alike 3.0 Germany (CC-BY-SA-3.0-DE)",logo:"https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-sa.svg"},"http://creativecommons.org/licenses/by-nc-nd/3.0/igo/":{text:"Creative Commons Attribution Non Commercial No Derivatives 3.0 IGO (CC-BY-NC-ND-3.0-IGO)",logo:"https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nc-nd.svg"},"http://creativecommons.org/publicdomain/zero/1.0/":{text:"Creative Commons Zero v1.0 Universal (CC0-1.0)",logo:"https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/cc-zero.svg"},"http://creativecommons.org/publicdomain/mark/1.0/":{text:"Public Domain Mark 1.0: No Copyright",logo:"https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/publicdomain.svg"},"http://creativecommons.org/licenses/by/2.5/au/":{text:"Creative Commons Attribution 2.5 Australia (CC-BY-2.5-AU)",logo:"https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by.svg"},"http://creativecommons.org/licenses/by-nd/2.0/":{text:"Creative Commons Attribution No Derivatives 2.0 Generic (CC-BY-ND-2.0)",logo:"https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nd.svg"},"http://creativecommons.org/licenses/by-nc/1.0/":{text:"Creative Commons Attribution Non Commercial 1.0 Generic (CC-BY-NC-1.0)",logo:"https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nc.svg"},"http://creativecommons.org/licenses/by-nc/4.0/":{text:"Creative Commons Attribution Non Commercial 4.0 International (CC-BY-NC-4.0)",logo:"https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nc.svg"},"http://rightsstatements.org/vocab/InC/1.0/":{text:"In Copyright",logo:"https://rightsstatements.org/files/buttons/InC.dark.svg"},"http://rightsstatements.org/vocab/InC-OW-EU/1.0/":{text:"In Copyright - EU Orphan Work",logo:"https://rightsstatements.org/files/buttons/InC-OW-EU.dark.svg"},"http://rightsstatements.org/vocab/InC-EDU/1.0/":{text:"In Copyright - Educational Use Permitted",logo:"https://rightsstatements.org/files/buttons/InC-EDU.dark.svg"},"http://rightsstatements.org/vocab/InC-NC/1.0/":{text:"In Copyright - Non-Commercial Use Permitted",logo:"https://rightsstatements.org/files/buttons/InC-NC.dark.svg"},"http://rightsstatements.org/vocab/InC-RUU/1.0/":{text:"In Copyright - Rights-holder(s) Unlocatable or Unidentifiable",logo:"https://rightsstatements.org/files/buttons/InC-RUU.dark.svg"},"http://rightsstatements.org/vocab/NoC-CR/1.0/":{text:"No Copyright - Contractual Restrictions",logo:"https://rightsstatements.org/files/buttons/NoC-CR.dark.svg"},"http://rightsstatements.org/vocab/NoC-NC/1.0/":{text:"No Copyright - Non-Commercial Use Only",logo:"https://rightsstatements.org/files/buttons/NoC-NC.dark.svg"},"http://rightsstatements.org/vocab/NoC-OKLR/1.0/":{text:"No Copyright - Other Known Legal Restrictions",logo:"https://rightsstatements.org/files/buttons/NoC-OKLR.dark.svg"},"http://rightsstatements.org/vocab/NoC-US/1.0/":{text:"No Copyright - United States",logo:"https://rightsstatements.org/files/buttons/NoC-US.dark.svg"},"http://rightsstatements.org/vocab/CNE/1.0/":{text:"Copyright Not Evaluated",logo:"https://rightsstatements.org/files/buttons/CNE.dark.svg"},"http://rightsstatements.org/vocab/UND/1.0/":{text:"Copyright Undetermined",logo:"https://rightsstatements.org/files/buttons/UND.dark.svg"},"http://rightsstatements.org/vocab/NKC/1.0/":{text:"No Known Copyright",logo:"https://rightsstatements.org/files/buttons/NKC.dark.svg"}};function mp(e){return e=e.replace(/^https:/,"http:").replace(/\/deed\.[a-z]{2}$/,""),e.endsWith("/")||(e+="/"),gp[e]}function vp(e){return new Worker(""+(typeof document>"u"?require("url").pathToFileURL(__dirname+"/assets/optimization.worker-Ra1-MoAS.js").href:new URL("assets/optimization.worker-Ra1-MoAS.js",document.currentScript&&document.currentScript.tagName.toUpperCase()==="SCRIPT"&&document.currentScript.src||document.baseURI).href),{type:"module",name:e==null?void 0:e.name})}class yp{constructor(t){v(this,"workers",[]);v(this,"queue",[]);v(this,"pendingTasks",new Map);v(this,"busyWorkers",new Set);this.size=t}start(){for(let t=0;t<this.size;t++){const r=new vp;r.onmessage=this.handleMessage.bind(this,r),r.onerror=this.handleError.bind(this,r),this.workers.push(r)}}stop(){this.workers.forEach(t=>t.terminate()),this.workers=[],this.queue=[],this.busyWorkers.clear()}dispatch(t){return new Promise((r,i)=>{this.queue.push({resolve:r,reject:i,task:{id:Cc(),data:t}}),this.processQueue()})}processQueue(){if(this.queue.length===0)return;const t=this.workers.find(i=>!this.busyWorkers.has(i));if(!t)return;const r=this.queue.shift();this.pendingTasks.set(r.task.id,r),this.busyWorkers.add(t),t.postMessage(r.task)}handleMessage(t,r){O.debug("worker: received message",r.data);const i=this.pendingTasks.get(r.data.input.id);i?(i.resolve(r.data.result),O.debug("worker: resolved job",i.task.id),this.pendingTasks.delete(i.task.id),this.busyWorkers.delete(t),this.processQueue()):O.warn(`worker: unknown job, known jobs: ${[...this.pendingTasks.keys()].join(", ")}`,r.data.input.id)}handleError(t,r){const i=r.error,n=this.queue.find(s=>s.task.id===i.taskId);n&&(n.reject(i.cause),this.busyWorkers.delete(t),this.processQueue())}}let rt=null,Yn=!1;function Lo(e=navigator.hardwareConcurrency){rt===null&&(rt=new yp(e),rt.start())}async function bp(e){if(rt===null&&Lo(),Yn)return;const t=await e();let r=[];for(let i=0;i<rt.size;i++)r.push(rt.dispatch({mozjpegWasm:t}));O.debug("main: mozjpegWasm sent to workers"),await Promise.all(r),O.debug("main: workers initialized with MozJPEG encoder"),Yn=!0}async function Wo(e){return rt===null&&Lo(),rt.dispatch(e)}function wp(e,t){if(e.length<=t)return e;const r=e.reduce((s,{width:a,height:o})=>s+a*o,0)/e.length,i=e.filter(s=>Math.abs(r-s.width*s.height)<=.25*r);if(i.length<=t)return i;const n=[];for(;n.length<t;){const s=i[Math.floor(Math.random()*i.length)];n.indexOf(s)<0&&n.push(s)}return n.sort((s,a)=>e.indexOf(s)-e.indexOf(a))}async function xp({manifest:e,concurrency:t=1,scaleFactor:r,filterCanvases:i=()=>!0,numSamples:n=8,optimization:s,saxWasmLoader:a=async()=>fetch(`https://unpkg.com/sax-wasm@${Ri}/lib/sax-wasm.wasm`).then(h=>h.arrayBuffer()).then(h=>new Uint8Array(h)),mozjpegWasmLoader:o=async()=>fetch("https://unpkg.com/@jsquash/jpeg@1.5.0/codec/enc/mozjpeg_enc.wasm").then(h=>h.arrayBuffer()).then(h=>new Uint8Array(h)),sampleCanvases:c}){let h;typeof e=="string"?h=e:h=e.id??e["@id"];const l=await Yi(h),u=await H.loadManifest(h,l);if(!u)throw new Error(`Failed to load manifest from ${h}`);let f;Array.isArray(i)?f=C=>i.indexOf(C)>=0:f=i;const p=H.get(u.items.filter(C=>f(C.id)).map(C=>C.id)),d=p.reduce((C,S)=>C+S.width*S.height,0);c!=null&&c.length||(c=wp(p,n));const m=c.reduce((C,S)=>C+S.width*S.height,0);if(!yt||!Xt()){if(!yt){const C=await a();as(C)}Xt()||(await ts(()=>Promise.resolve(yt)),O.debug.bind(O),O.info.bind(O),O.warn.bind(O),O.error.bind(O),void 0)}const g=new vo({concurrency:t}),y=await Promise.all(c.map(C=>g.add(async()=>{const S=ao(C);return ho(C,S.images,{scaleFactor:r,sizeOnly:s===void 0})})));let b;if(s){s.method==="mozjpeg"&&await bp(o);const C=y.filter(_=>_!==void 0).flatMap(_=>_.images),S=C.reduce((_,R)=>_+R.data.byteLength,0);await Promise.all(C.map(async _=>{const R=await Wo({imageData:new Uint8Array(_.data),imageFormat:_.format==="jpeg"?"image/jpeg":"image/png",...s});_.data=R.jpegData.buffer,_.format="jpeg"})),b=C.reduce((_,R)=>_+R.data.byteLength,0)/S}const w=y.filter(bt).flatMap(C=>C.images).every(C=>C.corsAvailable),F=y.filter(bt).flatMap(C=>C.images).reduce((C,S)=>{var E;return C+(((E=S==null?void 0:S.data)==null?void 0:E.byteLength)??S.numBytes)},0),A=y.filter(bt).flatMap(C=>C.images)[0];return{size:F/m*d,corsSupported:w,sampleImageData:A.data?new Uint8Array(A.data):void 0,sampleImageMimeType:A.format,sampleCanvases:c,optimizationResult:b}}async function Cp(e,t,r){const i=t.map(l=>l.id),n=l=>typeof l!="string"&&l.type==="Canvas",s=l=>typeof l!="string"&&l.type=="Range",a=new Set,o=async l=>{if(a.has(l.id))return;const u=l.items.filter(n).filter(g=>i.indexOf(g.id)>=0).filter(n).sort((g,y)=>i.indexOf(g.id)>i.indexOf(y.id)?-1:1)[0],f=$e(l.label??"<untitled>",r,"; "),p=H.get(l.items.filter(s)),d=(await Promise.all(p.map(o))).filter(bt);let m;if(l.start&&(m=await lo(l)),a.add(l.id),!(d.length===0&&!u))return!m&&u?m=u.id:m||(m=d[0].startCanvas),{label:f,startCanvas:m,children:d}};let c=H.get(e.structures);const h=c.find(l=>l.behavior.indexOf("top")>=0);return h&&(c=[h]),(await Promise.all(c.map(o))).filter(bt)??[]}class Sp{constructor(t,r,i,n,s){v(this,"canvasPixels",0);v(this,"pixelsWritten",0);v(this,"pixelBytesFactor",0);v(this,"pixelScaleFactor",0);v(this,"timeStart");v(this,"pdfGen");v(this,"totalPages");v(this,"totalCanvasPixels",0);v(this,"countingStream");v(this,"onProgress");v(this,"onNotification");this.totalCanvasPixels=t.reduce((a,o)=>a+o.width*o.height,0),this.totalPages=t.length,this.pdfGen=i,this.countingStream=r,this.onProgress=n,this.onNotification=s}get writeOutstanding(){return this.pdfGen.bytesWritten>this.countingStream.bytesWritten}emitProgress(t,r){var c;this.timeStart||(this.timeStart=nn());const i=this.pdfGen.bytesWritten;let n;t===this.totalPages?n=i:t>0&&(n=Math.floor(this.pixelBytesFactor*this.pixelScaleFactor*this.totalCanvasPixels));const s=this.countingStream.bytesWritten,a=i/((nn()-this.timeStart)/1e3);let o=Number.POSITIVE_INFINITY;n&&(o=(n-s)/a),(c=this.onProgress)==null||c.call(this,{messageCode:r,pagesWritten:t,totalPages:this.totalPages,bytesWritten:s,bytesPushed:i,estimatedFileSize:n,writeSpeed:a,remainingDuration:o})}emitNotification(t){var r;(r=this.onNotification)==null||r.call(this,t)}updatePixels(t,r){this.pixelsWritten+=t,this.canvasPixels+=r,this.pixelScaleFactor=this.pixelsWritten/this.canvasPixels,this.pixelBytesFactor=this.pdfGen.bytesWritten/this.pixelsWritten}}async function Ap(e,t,r,i){var h,l,u,f,p,d,m;const n={title:$e(e.label??"<untitled>",t,"; "),manifestUrl:e.id,pdiiifVersion:en},s=await Lf(e,512);if(s){n.thumbnail={url:s};const g=H.get(e.thumbnail.map(y=>y.id))[0];g&&"type"in g&&(n.thumbnail.iiifImageService=(l=(h=g.service)==null?void 0:h.find(y=>{var b;return((b=y==null?void 0:y.type)==null?void 0:b.startsWith("ImageService"))??!1}))==null?void 0:l.id)}const a=H.get(e.provider)[0],o=e.requiredStatement;a&&(n.provider={label:$e(a.label,t,"; "),homepage:(f=(u=a.homepage)==null?void 0:u[0])==null?void 0:f.id,logo:(d=(p=a.logo)==null?void 0:p[0])==null?void 0:d.id},n.provider.label==="Unknown"&&(n.provider.label="")),o!=null&&o.label&&(n.requiredStatement={label:$e(o.label,t,"; "),value:$e(o.value,t,"; ")});const c=e.rights;if(c){const g=mp(c);n.rights={text:(g==null?void 0:g.text)??c,url:c,logo:g==null?void 0:g.logo}}if(n.metadata=((m=e.metadata)==null?void 0:m.map(g=>{const y=$e(g.label,t,"; "),b=$e(g.value,t,"|||").split("|||");if(!(!y||b.length===0))return b.length===1?[y,b[0]]:[y,b]}).filter(g=>g!==void 0))??[],i)return await i(n);if(r){const y=await(await Kt(r,{method:"POST",headers:{"Content-Type":"application/json; charset=utf-8"},body:JSON.stringify(n)})).arrayBuffer();return new Uint8Array(y)}else throw"Either `endpoint` or `callback` must be specified!"}async function _p(e,t,{fetchCanvasAnnotations:r=()=>Promise.resolve([]),filterCanvases:i=()=>!0,languagePreference:n=[Intl.DateTimeFormat().resolvedOptions().locale],scaleFactor:s,metadata:a={},onProgress:o,onNotification:c,ppi:h,concurrency:l=1,abortController:u=new AbortController,coverPageCallback:f,coverPageEndpoint:p,polyglotZipPdf:d,polyglotZipBaseDir:m,optimization:g,saxWasmLoader:y=async()=>fetch(`https://unpkg.com/sax-wasm@${Ri}/lib/sax-wasm.wasm`).then(w=>w.arrayBuffer()).then(w=>new Uint8Array(w)),mozjpegWasmLoader:b=async()=>fetch("https://unpkg.com/@jsquash/jpeg@1.5.0/codec/enc/mozjpeg_enc.wasm").then(w=>w.arrayBuffer()).then(w=>new Uint8Array(w))}){typeof process<"u"&&Bo.setMaxListeners(100,u.signal);let w;t?typeof t.destroy=="function"?(O.debug("Writing to Node writable stream"),w=new Td(t),t.on("close",()=>u.abort())):(O.debug("Writing to file system"),w=new kd(t)):(O.debug("Writing to Blob"),w=new Bn);const F=new Id(w),x={fileSizeBytes:0,numPages:0};let A;Array.isArray(i)?A=$=>i.indexOf($)>=0:A=i;let k,C;typeof e=="string"?(k=e,C=await Yi(k)):(k=e["@id"]??e.id,C=e);const S=await H.loadManifest(k,C);if(!S)throw new Error(`Failed to load manifest from ${k}`);const E={...a};!E.Title&&S.label&&(E.Title=$e(S.label,n,"; "));const _=H.get(S.items.filter($=>A($.id))),R=!!_.find($=>!!Qi($)),V=_.map($=>$.label?$e($.label,n,"; "):"");if(!yt||!Xt()){if(!yt){const $=await y();as($)}Xt()||(await ts(()=>Promise.resolve(yt)),O.debug.bind(O),O.info.bind(O),O.warn.bind(O),O.error.bind(O),void 0)}O.debug(`Setting up queue with ${l} concurrent canvas fetches.`);const Q=new vo({concurrency:l});u.signal.addEventListener("abort",()=>Q.clear(),{once:!0});const z=_.map(ao),B=_.map(($,q)=>Q.add(async()=>{const ee=z[q],te=await ho($,ee.images,{scaleFactor:s,ppiOverride:h,abortSignal:u.signal});return g&&await Promise.all((te==null?void 0:te.images.map(async L=>{const de=await Wo({imageData:new Uint8Array(L.data),imageFormat:L.format==="jpeg"?"image/jpeg":"image/png",...g});O.debug("main: Got optimized image",L.resource.id),L.data=de.jpegData,L.format="jpeg"}))??[]),te})),D=await Cp(S,_,n),X=new pp({writer:F,metadata:E,canvasInfos:_.map(($,q)=>({canvasIdx:q,...z[q]})),langPref:n,pageLabels:V,outline:D,hasText:R,initialCanvas:await lo(S),readingDirection:S.viewingDirection==="right-to-left"?"right-to-left":"left-to-right",manifestJson:C,zipPolyglot:d,zipBaseDir:m});O.debug("Initialising PDF generator."),await X.setup();const W=new Sp(_,F,X,o,c);if(W.emitProgress(0),f||p){O.debug("Generating cover page"),W.emitProgress(0,"generate-cover-page");try{const $=await Ap(S,n,p,f);O.debug("Inserting cover page into PDF"),await X.insertCoverPages($)}catch($){throw O.error("Error while generating cover page",$),u.abort(),$}}W.emitProgress(0,"generate-pages");for(let $=0;$<_.length;$++){if(u.signal.aborted){O.debug("Abort signalled, aborting while waiting for image data.");break}try{O.debug(`Waiting for data for canvas #${$}`);const q=await B[$];if(!q)throw"Aborted";const ee=H.get(q.canvas),te=z[$],{images:L,ppi:de,text:_e,annotations:Ne,imageFailures:je}=q;if(je.length>0){x.failedImages||(x.failedImages=[]);const le={canvasIndex:$,numFailed:je.length,numTotal:L.length+je.length,details:Object.fromEntries(je.map(U=>[U.resource.id??"<unknown>",U.cause instanceof Error?U.cause.toString():U.cause]))};x.failedImages.push(le),W.emitNotification({code:"image-download-failure",...le})}if(te.ocr&&!(_e!=null&&_e.markup)){x.failedOcr||(x.failedOcr=[]);const le={canvasIndex:$,ocrUrl:te.ocr.id};x.failedOcr.push(le),W.emitNotification({code:"ocr-download-failure",...le})}const st=await r(ee.id);if(st!=null){const le=await Promise.all(st.map(U=>("id"in U||(U=Al(U)),H.load(U.id,U))));le&&le.filter(U=>U!==void 0).map(U=>oo(U,n)).filter(U=>U!==void 0).forEach(U=>Ne.push(U))}const De=Ee==null?void 0:Ee.pageGenerationDuration.startTimer();O.debug(`Rendering canvas #${$} into PDF`),await X.renderPage(q.canvas.id,{width:ee.width,height:ee.height},[...L,...je],Ne,_e,de),De==null||De(),W.updatePixels(L.reduce((le,U)=>le+U.width*U.height,0),ee.width*ee.height),x.numPages++}catch(q){throw q!=="Aborted"&&O.error("Failed to render page",q),Q.clear(),u.signal.aborted||u.abort(),q}finally{delete B[$]}W.emitProgress($+1)}O.debug("Finalizing PDF");const Ae=X.end();if(!u.signal.aborted){let $=!1;Ae.then(()=>$=!0);const q=async()=>{if(!$)for(W.emitProgress(_.length,"finishing");!$&&W.writeOutstanding;)await w.waitForDrain()};$||(await w.waitForDrain(),await q())}return O.debug("Waiting for writer to close."),await Ae,x.fileSizeBytes=F.bytesWritten,w instanceof Bn?{...x,data:w.blob}:x}exports.ConsoleLogger=Vn;exports.convertManifest=_p;exports.estimatePdfSize=xp;exports.fetchManifestJson=Yi;exports.setLogger=Qo;exports.vault=H;exports.version=en;
 //# sourceMappingURL=index.cjs.map
diff --git a/node_modules/pdiiif/dist/index.cjs.map b/node_modules/pdiiif/dist/index.cjs.map
index 1aab920..034dc7b 100644
--- a/node_modules/pdiiif/dist/index.cjs.map
+++ b/node_modules/pdiiif/dist/index.cjs.map
@@ -1 +1 @@
-{"version":3,"sources":["../src/index.ts","../src/log.ts","../src/download.ts","../src/ocr.ts","../src/metrics.ts","../src/util.ts","../src/iiif.ts","../src/convert.ts","../src/pdf/generator.ts","../src/pdf/util.ts","../src/pdf/common.ts","../src/io.ts","../src/pdf/image.ts","../src/pdf/parser.ts","../src/version.ts","../src/pdf/pkzip.ts","../src/pdf/annos.ts","../src/res/licenses.ts"],"sourcesContent":["export type { Logger } from './log.js';\nexport { setLogger, ConsoleLogger } from './log.js';\nexport { fetchManifestJson } from './download.js';\nexport * from './convert.js';\nexport { default as version } from './version.js';","type LogLevel = 'debug' | 'info' | 'warn' | 'error';\n\nexport interface Logger {\n  setLevel(level: LogLevel): void;\n  debug(message: string, ...args: any[]): void;\n  info(message: string, ...args: any[]): void;\n  warn(message: string, ...args: any[]): void;\n  error(message: string, ...args: any[]): void;\n}\n\n/** Simple logger that simply outputs to the console */\nexport class ConsoleLogger implements Logger {\n  private level: LogLevel;\n  constructor(level: LogLevel = 'warn') {\n    this.level = level;\n  }\n\n  setLevel(level: LogLevel): void {\n    this.level = level;\n  }\n\n  debug(message: string, ...args: any[]): void {\n    if (this.level === 'debug') {\n      console.debug(message, ...args);\n    }\n  }\n\n  info(message: string, ...args: any[]): void {\n    if (this.level !== 'error' && this.level !== 'warn') {\n      console.info(message, ...args);\n    }\n  }\n\n  warn(message: string, ...args: any[]): void {\n    if (this.level !== 'error') {\n      console.warn(message, ...args);\n    }\n  }\n\n  error(message: string, ...args: any[]): void {\n    console.error(message, ...args);\n  }\n}\n\nlet logger: Logger = new ConsoleLogger();\n\nexport function setLogger(newLogger: Logger): void {\n  logger = newLogger;\n}\n\nexport { logger as default };\n","/* eslint-disable @typescript-eslint/no-non-null-assertion */\nimport { Mutex } from 'async-mutex';\nimport {\n  CanvasNormalized,\n  ExternalWebResource,\n  FragmentSelector,\n  IIIFExternalWebResource,\n  ImageService,\n  ImageService3,\n  ManifestNormalized,\n  RangeNormalized,\n  Reference,\n  Selector,\n  Service,\n} from '@iiif/presentation-3';\n\nimport { OcrPageWithMarkup, fetchAndParseText } from './ocr.js';\nimport metrics from './metrics.js';\nimport log from './log.js';\nimport {\n  vault,\n  isPhysicalDimensionService,\n  PhysicalDimensionService,\n  supportsScaling,\n  fetchFullImageService,\n  getCanvasAnnotations,\n  Annotation,\n  ImageInfo,\n} from './iiif.js';\nimport { isDefined } from './util.js';\n\n/// In absence of more detailed information (from physical dimensions service), use this resolution\nconst FALLBACK_PPI = 300;\n\n// HTTP Accept header to make sure we get IIIFv3, if available, via content negotiation\n// Thanks to @jcoyne:\n// https://github.com/ProjectMirador/mirador/pull/3770/files#diff-166256fe28a89c78ada7b08488a3233671fc0511fd39d323c5cfc9433026e2a1R108-R112\nconst MANIFEST_ACCEPT_HEADER = 'application/ld+json;q=0.9;profile=\"http://iiif.io/api/presentation/3/context.json\", '\n  + 'application/ld+json;q=0.7;profile=\"http://iiif.io/api/presentation/2/context.json\", '\n  + 'application/ld+json;q=0.5, '\n  + 'application/json;q=0.2';\n\n/** Maps rate-limited hosts to a mutex that limits the concurrent fetching. */\nclass RateLimitingRegistry {\n  private hostMutexes = new Map<string, Mutex>();\n  private callbacks: Array<(host: string, limited: boolean) => void> = [];\n\n  getMutex(host: string): Mutex | undefined {\n    return this.hostMutexes.get(host);\n  }\n\n  limitHost(host: string): Mutex {\n    const mutex = new Mutex();\n    this.hostMutexes.set(host, mutex);\n    this.callbacks.forEach((cb) => cb(host, true));\n    return mutex;\n  }\n\n  unlimitHost(host: string): void {\n    this.hostMutexes.delete(host);\n    this.callbacks.forEach((cb) => cb(host, false));\n  }\n\n  subscribe(cb: (host: string, limited: boolean) => void): number {\n    this.callbacks.push(cb);\n    return this.callbacks.length - 1;\n  }\n\n  unsubscribe(ticket: number) {\n    this.callbacks.splice(ticket, 1);\n  }\n\n  isLimited(url: string): boolean {\n    return this.hostMutexes.has(new URL(url).host);\n  }\n}\n\nexport const rateLimitRegistry = new RateLimitingRegistry();\n\n/** A 'respectful' wrapper around `fetch` that tries to respect rate-limiting headers.\n *\n * Will also retry with exponential backoff in case of server errors.\n */\nexport async function fetchRespectfully(\n  url: string,\n  init?: RequestInit,\n  maxRetries = 3\n): Promise<Response> {\n  const { host } = new URL(url);\n  // If the host associated with the URL is rate-limited, limit concurrency to a single\n  // fetch at a time by acquiring the mutex for the host.\n  let rateLimitMutex = rateLimitRegistry.getMutex(host);\n  let numRetries = -1;\n  let resp: Response | undefined;\n  let waitMs = 5000;\n  let lastError: unknown;\n  // If we're fetching from a rate-limited host, wait until there's no other fetch for it\n  // going on\n  const release = await rateLimitMutex?.acquire();\n  try {\n    do {\n      // Don't catch network errors, let them bubble up\n      resp = await fetch(url, init);\n      if (resp.ok) {\n        break;\n      }\n      numRetries++;\n\n      const retryAfter = resp?.headers.get('retry-after');\n      if (isDefined(retryAfter)) {\n        if (Number.isInteger(retryAfter)) {\n          waitMs = Number.parseInt(retryAfter, 10) * 1000;\n        } else {\n          const waitUntil = Date.parse(retryAfter);\n          waitMs = waitUntil - Date.now();\n        }\n      } else {\n        // Exponential backoff with a random multiplier on the base wait time\n        waitMs = Math.pow(Math.random() * 2 * waitMs, numRetries);\n      }\n\n      // Check if the server response has headers corresponding to the IETF `RateLimit Header Fiels for HTTP` spec draft[1]\n      // [1] https://www.ietf.org/archive/id/draft-polli-ratelimit-headers-05.html\n      const getHeaderValue = (ietfHeader: string): number | undefined => {\n        const headerVariants = [\n          ietfHeader,\n          `x-${ietfHeader}`,\n          `x-${ietfHeader.replace('ratelimit', 'rate-limit')}`,\n        ];\n        return headerVariants\n          .map((header) => resp?.headers.get(header))\n          .filter(isDefined<string>)\n          .map((limit) => Number.parseInt(limit, 10))\n          .find((limit) => limit != null);\n      };\n      const limit = getHeaderValue('ratelimit-limit');\n      const remaining = getHeaderValue('ratelimit-remaining');\n      const reset = getHeaderValue('ratelimit-reset');\n      if (\n        limit !== undefined &&\n        remaining !== undefined &&\n        reset !== undefined\n      ) {\n        // At this point we're pretty sure that we're being rate-limited, so let's\n        // limit concurrency from here on out.\n        rateLimitMutex = rateLimitRegistry.limitHost(host);\n\n        // We assume a sliding window implemention here\n        const secsPerQuotaUnit = reset / (limit - remaining);\n        if (remaining > 0) {\n          // If we have remaining quota units but were blocked, we wait until we have enough\n          // quota to fetch remaining*2 quota units (i.e. we assume that the units in `remaining`\n          // were not enough to fully fetch the resource)\n          waitMs = 2 * remaining * secsPerQuotaUnit * 1000;\n        } else {\n          waitMs = secsPerQuotaUnit * 1000;\n        }\n      }\n\n      // Add a 100ms buffer just to be safe and wait until the next attempt\n      await new Promise((resolve) => setTimeout(resolve, waitMs + 100));\n    } while (numRetries < maxRetries);\n  } finally {\n    if (rateLimitMutex) {\n      // We're being rate-limited, so wait some more so the next request doesn't\n      // encounter a server error on fetching\n      await new Promise((resolve) => setTimeout(resolve, waitMs + 100));\n    }\n    release?.();\n  }\n  if (!resp) {\n    throw lastError;\n  }\n  return resp;\n}\n\n/** Container for image size along with its corresponding IIIF Image API string. */\nexport type SizeInfo = {\n  iiifSize: string;\n  width: number;\n  height: number;\n};\n\n/** Calculate the image size to fetch, based on user constraints and available sizes\n *  in the Image API info.json response.\n */\nexport function getImageSize(\n  imgService: ImageService,\n  scaleFactor = 1\n): SizeInfo {\n  let sizeStr: string;\n  const isIIIFv3 = (imgService as ImageService3).id !== undefined;\n  const maxWidth = imgService.maxWidth ?? imgService.width!;\n  let requestedWidth = Math.floor(scaleFactor * maxWidth);\n  const aspectRatio = imgService.width! / imgService.height!;\n  const supportsScaleByWh = Array.isArray(imgService.profile)\n    ? imgService.profile.find(supportsScaling) !== undefined\n    : supportsScaling(imgService.profile);\n  if (scaleFactor < 1 && !supportsScaleByWh) {\n    if (imgService.sizes) {\n      // AR-compliant downscaling is not supported, find the closest available size\n      requestedWidth = Math.min(...imgService.sizes.map((dims) => Math.abs(requestedWidth - dims.width)));\n      sizeStr = `${requestedWidth},`;\n    } else {\n      // No sizes available, so we can't downscale.\n      sizeStr = `${maxWidth},`;\n    }\n  } else if (scaleFactor == 1) {\n    sizeStr =\n      isIIIFv3 || imgService.maxWidth || imgService.maxArea ? 'max' : 'full';\n    if (imgService.maxWidth) {\n      requestedWidth = imgService.maxWidth;\n    } else if (imgService.maxHeight) {\n      requestedWidth = Math.round(aspectRatio * imgService.maxHeight);\n    } else if (imgService.maxArea) {\n      const fullArea = imgService.width! * imgService.height!;\n      const scaleFactor = imgService.maxArea / fullArea;\n      requestedWidth = Math.round(scaleFactor * imgService.width!);\n    } else {\n      requestedWidth = imgService.width!;\n    }\n  } else {\n    sizeStr = `${requestedWidth},`;\n  }\n  return {\n    iiifSize: sizeStr,\n    width: requestedWidth as number,\n    height: (requestedWidth as number) / aspectRatio,\n  };\n}\n\n/** Use a IIIF Physical Dimensions service to obtain the PPI for a canvas. */\nexport function getPointsPerInch(services: Service[]): number | null {\n  const physDimService = services.find(isPhysicalDimensionService) as\n    | PhysicalDimensionService\n    | undefined;\n  if (!physDimService) {\n    return null;\n  }\n  const { physicalScale, physicalUnits } = physDimService;\n  let ppi;\n  if (physicalUnits === 'in') {\n    ppi = 1 / physicalScale;\n  } else if (physicalUnits === 'mm') {\n    ppi = 25.4 / physicalScale;\n  } else if (physicalUnits === 'cm') {\n    ppi = 2.54 / physicalScale;\n  } else {\n    ppi = FALLBACK_PPI;\n  }\n  return ppi;\n}\n\nexport function isImageFetchFailure(obj: CanvasImageData | ImageFetchFailure): obj is ImageFetchFailure {\n  return (obj as ImageFetchFailure).cause !== undefined;\n}\n\n/** All the data relevant for the canvas: images and text */\nexport type CanvasData = {\n  canvas: Reference<'Canvas'>;\n  text?: OcrPageWithMarkup;\n  images: CanvasImage[];\n  annotations: Annotation[];\n  ppi?: number;\n  imageFailures: ImageFetchFailure[];\n};\n\nexport type ImageFetchFailure = ImageInfo & {\n  cause: Error | string;\n}\n\n\n/** Data and additional information for an image on a canvas. */\nexport type CanvasImage = ImageInfo & CanvasImageData;\n\n/** Data and additional info for a canvas image, based on retrieval\n *  of external resources.\n */\nexport type CanvasImageData = {\n  data?: ArrayBuffer;\n  numBytes: number;\n  corsAvailable: boolean;\n  ppi?: number;\n  nativeWidth?: number;\n  nativeHeight?: number;\n};\n\n/** Options for fetching image */\nexport type FetchImageOptions = {\n  /// Factor to downscale the image by, number between 0.1 and 1\n  scaleFactor?: number;\n  /// PPI override, will be fetched from physical dimensions serivce by default\n  ppiOverride?: number;\n  // Optional signal to use for aborting the image fetching\n  abortSignal?: AbortSignal;\n  /// Only obtain the size of the image, don't fetch any data\n  sizeOnly?: boolean;\n};\n\n/** Download (or only determine size in bytes of) a canvas image. */\nasync function fetchCanvasImage(\n  image: IIIFExternalWebResource | ExternalWebResource,\n  { scaleFactor, abortSignal, sizeOnly = false }: FetchImageOptions\n): Promise<CanvasImageData | null> {\n  // NOTE: Here be dragons, who'd have thought downloading an image\n  //       could be so complicated?\n  if (abortSignal?.aborted) {\n    log.debug(\n      'Abort signalled, aborting before initiating image data fetching.'\n    );\n    throw new Error('Aborted due to client request', { cause: { type: 'abort' } });\n  }\n  if (image.type !== 'Image') {\n    throw new Error(`Can only fetch image resources, got ${image.type}`);\n  }\n  let imgService: ImageService | undefined;\n  if ('service' in image) {\n    imgService = image.service?.find(\n      (s: Service): s is ImageService =>\n        ((s as ImageService | undefined)?.type?.startsWith('ImageService') ??\n          false) ||\n        ((s as any)?.['@type']?.startsWith('ImageService') ?? false)\n    );\n  }\n  let ppi: number | undefined;\n  let imageUrl: string;\n  if (imgService) {\n    if (!imgService.width) {\n      imgService = await fetchFullImageService(imgService);\n    }\n    const sizeInfo = getImageSize(imgService, scaleFactor);\n    imageUrl = `${imgService.id ?? imgService['@id']}/full/${sizeInfo.iiifSize\n      }/0/default.jpg`;\n    ppi = getPointsPerInch(imgService.service ?? []) ?? undefined;\n    if (ppi) {\n      ppi = ppi * (sizeInfo.width / imgService.width!);\n    }\n  } else if (image.id && image.format === 'image/jpeg') {\n    imageUrl = image.id;\n  } else {\n    log.error(\n      `No JPEG image identifier for resource ${image.id} could be found!`\n    );\n    return null;\n  }\n\n  let data: ArrayBuffer | undefined;\n  let numBytes: number;\n  let corsAvailable = true;\n  const stopMeasuring = metrics?.imageFetchDuration.startTimer({\n    iiif_host: new URL(imageUrl).host,\n  });\n  try {\n    const imgResp = await fetchRespectfully(imageUrl, {\n      method: 'GET',\n      signal: abortSignal,\n    });\n    if (imgResp.status >= 400) {\n      throw new Error(\n        `Failed to fetch page image from ${imageUrl}, server returned status ${imgResp.status}`,\n        { cause: { type: 'http-status', status: imgResp.status } }\n      );\n    }\n    if (abortSignal?.aborted) {\n      throw new Error('Aborted due to client request', { cause: { type: 'abort' } });\n    }\n    numBytes = Number.parseInt(imgResp.headers.get('Content-Length') ?? '-1');\n    data = sizeOnly && numBytes >= 0 ? undefined : await imgResp.arrayBuffer();\n    if (numBytes < 0) {\n      numBytes = data?.byteLength ?? -1;\n    }\n    stopMeasuring?.({\n      status: 'success',\n      limited: rateLimitRegistry.isLimited(imageUrl).toString(),\n    });\n  } catch (err) {\n    // In browsers, we can't differentiate between a 'normal' network error\n    // (like an unavailable server) and a CORS error just from the response\n    // alone, so we we use a small hack involving the DOM\n    const isCorsError = typeof document !== 'undefined' && await isImageUnavailableDueToCors(imageUrl);\n    // No CORS error or CORS error, but need data? Can't continue\n    if (!isCorsError) {\n      log.error(`Failed to fetch image data from ${imageUrl}: ${err}`);\n      stopMeasuring?.({\n        status: 'error',\n        limited: rateLimitRegistry.isLimited(imageUrl).toString(),\n        cause: err instanceof Error ? (err.cause as any).type : err\n      });\n      throw err;\n    } else if (!sizeOnly) {\n      throw new Error('Data requested, but no CORS for the image endpoint', { cause: { type: 'no-cors' } });\n    }\n    corsAvailable = false;\n    log.warn(\n      `Failed to fetch image data from ${imageUrl}: CORS headers missing!`\n    );\n    // We can get the size without CORS\n    const imgResp = await fetchRespectfully(imageUrl, {\n      method: 'GET',\n      signal: abortSignal,\n      mode: 'no-cors',\n    });\n    numBytes = Number.parseInt(imgResp.headers.get('Content-Length') ?? '-1');\n  }\n\n  return {\n    data,\n    ppi,\n    numBytes,\n    corsAvailable,\n  };\n}\n\n/** Check if an image is unavailable due to missing CORS headers. */\nasync function isImageUnavailableDueToCors(imageUrl: string): Promise<boolean> {\n  const imgElem = document.createElement('img');\n  imgElem.src = imageUrl;\n  return new Promise((resolve) => {\n    // Image loads fine for element => Unavailable due to missing CORS headers\n    imgElem.onload = () => resolve(true);\n    // Image also errors when loading via element => Server can't be reached\n    imgElem.onerror = () => resolve(false);\n  });\n}\n\n/** Information about the starting canvas of a Manifet or a Range.\n * Can point to a whole canvas or to a part of it. */\nexport type StartCanvasInfo =\n  | string\n  | {\n    id: string;\n    ppi: number;  // Needed to create link in PDF\n    dimensions: { width: number; height: number };\n    position: {\n      x: number;\n      y: number;\n      width: number;\n      height: number;\n    };\n  };\n\n/** Fetch all of the information needed for a start canvas. */\nexport async function fetchStartCanvasInfo(\n  resource: ManifestNormalized | RangeNormalized\n): Promise<StartCanvasInfo | undefined> {\n  const startRef = resource.start;\n  if (!startRef) {\n    return;\n  }\n  let canvasId: string | undefined;\n  let fragment: string | undefined;\n  if (typeof startRef === 'string') {\n    const [ident, selectorStr] = (startRef as string).split('#xywh=');\n    if (!selectorStr) {\n      return ident;\n    }\n    canvasId = ident;\n    fragment = `xywh=${selectorStr}`;\n  } else if (startRef.type === 'Canvas') {\n    return startRef.id;\n  } else {\n    const selector = vault.get<Selector>(startRef);\n    if (typeof selector === 'string' || selector.type !== 'FragmentSelector') {\n      console.warn(\n        `Unsupported selector type, cannot determine start canvas for ${resource.id}`\n      );\n      return;\n    }\n    const fragSel = selector as FragmentSelector;\n    if (fragSel.conformsTo !== 'http://www.w3.org/TR/media-frags/') {\n      console.warn(\n        `Unsupported selector type, cannot determine start canvas for ${resource.id} (fragment selector type was ${fragSel.conformsTo})`\n      );\n      return;\n    }\n    canvasId = fragSel.value;\n  }\n  if (!fragment || !canvasId) {\n    console.error(\n      `Couldn't parse either canvas identifier or selector for ${resource.id} start canvas.`\n    );\n    return;\n  }\n  const [selX, selY, selWidth, selHeight] = fragment\n    .substring(5)\n    .split(',')\n    .map((v) => Number.parseInt(v, 10));\n  const canvas = vault.get<CanvasNormalized>(canvasId);\n  const ppi = getPointsPerInch(canvas.service) ?? FALLBACK_PPI;\n  return {\n    id: canvasId,\n    ppi,\n    dimensions: { width: canvas.width, height: canvas.height },\n    position: {\n      x: selX,\n      y: selY,\n      width: selWidth,\n      height: selHeight,\n    },\n  };\n}\n\n/** Fetch all of the data associated with a canvas, including external services. */\nexport async function fetchCanvasData(\n  canvas: CanvasNormalized,\n  imageInfos: ImageInfo[],\n  { scaleFactor, ppiOverride, abortSignal, sizeOnly = false }: FetchImageOptions\n): Promise<CanvasData | undefined> {\n  const imagePromises = imageInfos.map(i => i.resource).map(r => fetchCanvasImage(r, { scaleFactor, abortSignal, sizeOnly }));\n  const results = await Promise.allSettled(imagePromises);\n  const canvasImages = results\n    .reduce((acc, x, idx) => {\n      if (x.status !== 'fulfilled' || x.value === null) {\n        return acc;\n      }\n      const imgInfo = imageInfos[idx];\n      acc.push({\n        ...imgInfo,\n        ...x.value,\n        // FIXME: How can we get rid of the cast?\n      } as CanvasImage);\n      return acc;\n    }, [] as CanvasImage[])\n  const failures: ImageFetchFailure[] = results\n    .filter((x): x is PromiseRejectedResult => x.status === 'rejected')\n    .map((x, idx) => {\n      const info = imageInfos[idx];\n      return {\n        ...info,\n        cause: x.reason,\n      }\n    });\n  const ppi = ppiOverride;\n  if (!ppiOverride) {\n    let ppi = getPointsPerInch(canvas.service) ?? undefined;\n    if (ppi && scaleFactor) {\n      ppi = ppi * scaleFactor;\n    }\n  }\n  let text;\n  if (!sizeOnly) {\n    try {\n      text = await fetchAndParseText(canvas, undefined);\n    } catch (err) {\n      log.warn(`Failed to fetch text for canvas ${canvas.id}: ${err}`);\n    }\n  }\n  return {\n    canvas,\n    images: canvasImages,\n    imageFailures: failures,\n    ppi,\n    text,\n    annotations: getCanvasAnnotations(canvas),\n  };\n}\n\n/** Download the JSON data for a manifest, handling stuff like broken CORS implementations\n *  and Content-Negotiation for IIIFv3 */\nexport async function fetchManifestJson(manifestUrl: string): Promise<any> {\n  try {\n    const resp = await fetch(manifestUrl, {\n      headers: {\n        Accept: MANIFEST_ACCEPT_HEADER\n      }\n    });\n    return await resp.json();\n  } catch (err) {\n    // Check if fetching failed due to CORS by downgrading the request to a\n    // 'simple' request by removing the `Accept` header, which makes the\n    // request CORS-unsafe due to double quotes and the colon in the URL\n    const resp = await fetch(manifestUrl);\n    return await resp.json();\n  }\n}","/* eslint-disable @typescript-eslint/no-non-null-assertion */\n/* eslint-disable complexity */\n/// Utilities for parsing OCR text from hOCR, ALTO and IIIF Annotations\nimport {\n  Annotation,\n  AnnotationNormalized,\n  CanvasNormalized,\n  ContentResource,\n} from '@iiif/presentation-3';\nimport {\n  parseAltoPages,\n  parseHocrPages,\n  type OcrPage,\n  type OcrLine,\n  Dimensions,\n} from 'ocr-parser';\n\nimport metrics from './metrics.js';\nimport { fetchRespectfully, rateLimitRegistry } from './download.js';\nimport {\n  isExternalWebResourceWithProfile,\n  ExternalWebResourceWithProfile,\n  vault,\n} from './iiif.js';\n\nexport type OcrPageWithMarkup = OcrPage & {\n  id: string;\n  markup: string;\n  mimeType: string;\n};\n\n/** Helper to calculate a rough fallback image size from the line coordinates\n *\n * @param {array} lines the parsed OCR lines\n * @returns {object} the page size estimated from the line coordinates\n */\nfunction getFallbackImageSize(lines: OcrLine[]): Dimensions {\n  return {\n    width: Math.max(...lines.map(({ x, width }) => x + (width ?? 0))) ?? 0,\n    height: Math.max(...lines.map(({ y, height }) => y + height)) ?? 0,\n  };\n}\n\n/**\n * Parse an OCR document (currently hOCR or ALTO)\n *\n * @param {string} ocrText  ALTO or hOCR markup\n * @param {object} referenceSize Reference size to scale coordinates to\n * @returns {OcrPage} the parsed OCR page\n */\nexport async function parseOcr(\n  id: string,\n  ocrText: string,\n  referenceSize: Dimensions\n): Promise<OcrPageWithMarkup | null> {\n  let pageIter: AsyncGenerator<OcrPage>;\n  const isAlto = ocrText.indexOf('<alto') >= 0;\n  if (isAlto) {\n    pageIter = parseAltoPages(ocrText, [referenceSize]);\n  } else {\n    pageIter = parseHocrPages(ocrText, [referenceSize]);\n  }\n  const page = (await pageIter.next()).value as OcrPage | undefined;\n  if (!page) {\n    return null;\n  }\n  return {\n    ...page,\n    id,\n    markup: ocrText,\n    mimeType: isAlto ? 'application/xml+alto' : 'text/vnd.hocr+html',\n  };\n}\n\n/** Parse OCR data from IIIF annotations.\n *\n * Annotations should be pre-filtered so that they all refer to a single canvas/page.\n * Annotations should only contain a single text granularity, that is either line or word.\n *\n * @param {object} annos IIIF annotations with a plaintext body and line or word granularity\n * @param {Dimensions} imgSize Reference width and height of the rendered target image\n * @returns {OcrPage} parsed OCR boxes\n */\nexport function parseIiifAnnotations(\n  annos: Array<Annotation>,\n  imgSize: Dimensions\n): OcrPage {\n  throw 'Currently not supported';\n}\n\n/** Checks if a given resource points to an ALTO OCR document */\nconst isAlto = (resource: ExternalWebResourceWithProfile) =>\n  resource.format === 'application/xml+alto' ||\n  resource.profile?.startsWith('http://www.loc.gov/standards/alto/');\n\n/** Checks if a given resource points to an hOCR document */\nconst isHocr = (resource: ExternalWebResourceWithProfile) =>\n  resource.format === 'text/vnd.hocr+html' ||\n  resource.profile ===\n    'https://github.com/kba/hocr-spec/blob/master/hocr-spec.md' ||\n  resource.profile?.startsWith('http://kba.cloud/hocr-spec/') ||\n  resource.profile?.startsWith('http://kba.github.io/hocr-spec/');\n\n/** Wrapper around fetch() that returns the content as text */\nasync function fetchOcrMarkup(url: string): Promise<string | undefined> {\n  const resp = await fetch(url);\n  if (resp.status === 404) {\n    return undefined;\n  }\n  if (resp.status != 200) {\n    throw new Error(\n      `Could not fetch OCR markup from ${url}, got status code ${resp.status}`\n    );\n  }\n  return resp.text();\n}\n\n/** Fetch external annotation resource JSON */\nexport async function fetchAnnotationResource(url: string): Promise<any> {\n  const resp = await fetchRespectfully(url);\n  return resp.json();\n}\n\n/** Retrieve a supported OCR references from a Canvas' `seeAlso` or `rendering`, if present.\n *\n * 'Supported' currently means external ALTO or hOCR markup.\n */\nexport function getOcrReferences(\n  canvas: CanvasNormalized\n): ExternalWebResourceWithProfile | undefined {\n  const refs = vault.get<ContentResource>(canvas.seeAlso);\n  refs.push(...vault.get<ContentResource>(canvas.rendering));\n  return refs\n    .filter(isExternalWebResourceWithProfile)\n    .find((r) => isAlto(r) || isHocr(r));\n}\n\nexport async function fetchAndParseText(\n  canvas: CanvasNormalized,\n  annotations?: AnnotationNormalized[]\n): Promise<OcrPageWithMarkup | undefined> {\n  // TODO: Annotations are a major PITA due to all the indirection and multiple\n  //       levels of fetching of external resources that might be neccessary,\n  //       save for later once text rendering is properly done.\n  const ocrRefs = getOcrReferences(canvas);\n  if (ocrRefs) {\n    const stopMeasuring = metrics?.ocrFetchDuration.startTimer({\n      ocr_host: new URL(ocrRefs.id!).host,\n    });\n    let markup;\n    try {\n      markup = await fetchOcrMarkup(ocrRefs.id!);\n      stopMeasuring?.({\n        status: 'success',\n        limited: rateLimitRegistry.isLimited(ocrRefs.id!).toString(),\n      });\n      if (!markup) {\n        return undefined;\n      }\n    } catch (err) {\n      stopMeasuring?.({\n        status: 'error',\n        limited: rateLimitRegistry.isLimited(ocrRefs.id!).toString(),\n      });\n      throw err;\n    }\n    return (\n      (await parseOcr(ocrRefs.id!, markup, {\n        width: canvas.width,\n        height: canvas.height,\n      })) ?? undefined\n    );\n  }\n}\n","import type { Histogram } from 'prom-client';\nimport prometheus from 'prom-client';\n\nimport { runningInNode } from './util.js';\n\ntype Metrics =\n  | {\n      pageGenerationDuration: Histogram<string>;\n      imageFetchDuration: Histogram<string>;\n      imageInfoDuration: Histogram<string>;\n      ocrFetchDuration: Histogram<string>;\n    }\n  | undefined;\n\nlet metrics: Metrics;\n\n// Prometheus metrics are only defined when running in node\nif (runningInNode()) {\n  metrics = {\n    pageGenerationDuration: new prometheus.Histogram({\n      name: 'pdiiif_page_generation_duration_seconds',\n      help: 'Latency for generating the PDF for a single page',\n      buckets: [0.001, 0.005, 0.015, 0.05, 0.1, 0.5, 1, 2],\n      labelNames: ['status'],\n    }),\n    imageFetchDuration: new prometheus.Histogram({\n      name: 'pdiiif_image_fetch_duration_seconds',\n      help: 'Latency for fetching data from IIIF Image API endpoints',\n      buckets: [0.01, 0.05, 0.15, 0.5, 1, 5, 10],\n      labelNames: ['status', 'iiif_host', 'limited'],\n    }),\n    imageInfoDuration: new prometheus.Histogram({\n      name: 'pdiiif_image_info_duration_seconds',\n      help: 'Latency for fetching info from IIIF Image API endpoints',\n      buckets: [0.01, 0.05, 0.15, 0.5, 1, 5, 10],\n      labelNames: ['status', 'iiif_host', 'limited'],\n    }),\n    ocrFetchDuration: new prometheus.Histogram({\n      name: 'pdiiif_ocr_fetch_duration_seconds',\n      help: 'Latency for fetching OCR data',\n      buckets: [0.01, 0.05, 0.15, 0.5, 1, 5, 10],\n      labelNames: ['status', 'ocr_host', 'limited'],\n    }),\n  };\n}\n\nexport default metrics;\n","export let saxParserWasm: Uint8Array | null = null;\n\n/** Get a timestamp in milliseconds, prefereably high-resolution */\nexport function now(): number {\n  if (typeof window !== 'undefined' && window.performance) {\n    return window.performance.now();\n  } else {\n    return Date.now();\n  }\n}\n\nexport function isDefined<T>(val: T | undefined | null | void): val is T {\n  return val != undefined && val !== null && val !== void 0;\n}\n\nconst CRC_TABLE = (() => {\n  const t = new Int32Array(256);\n  for (let i = 0; i < 256; ++i) {\n    let c = i, k = 9;\n    while (--k) c = ((c & 1) && -306674912) ^ (c >>> 1);\n    t[i] = c;\n  }\n  return t;\n})();\n\nexport function crc32(data: Uint8Array): number {\n  let c = -1;\n  for (let i = 0; i < data.length; ++i) {\n    c = CRC_TABLE[(c & 255) ^ data[i]] ^ (c >>> 8);\n  }\n  return ~c;\n}\n\nexport function runningInNode(): boolean {\n  return typeof process !== 'undefined' && typeof process.versions?.node !== 'undefined';\n}\n\nexport function initializeSaxParser(parserWasm: Uint8Array): void {\n  saxParserWasm = parserWasm;\n}","import {\n  InternationalString,\n  ManifestNormalized,\n  ExternalWebResource,\n  IIIFExternalWebResource,\n  ContentResource,\n  ImageProfile,\n  ImageService,\n  CanvasNormalized,\n  Reference,\n  AnnotationPageNormalized,\n  AnnotationNormalized,\n  Creator,\n  Agent,\n} from '@iiif/presentation-3';\nimport { globalVault, Vault } from '@iiif/vault';\nimport {\n  buildLocaleString,\n  createPaintingAnnotationsHelper,\n  createThumbnailHelper,\n  expandTarget,\n  SupportedTarget,\n} from '@iiif/vault-helpers';\nimport { ImageServiceLoader as ImageServiceLoader_ } from '@atlas-viewer/iiif-image-api';\n\nimport { getOcrReferences } from './ocr.js';\nimport log from './log.js';\n\nconst PURPOSE_ORDER = ['commenting', 'describing', 'tagging', 'no-purpose'];\nconst PURPOSE_LABELS: { [purpose: string]: string } = {\n  commenting: 'Comment',\n  describing: 'Description',\n  tagging: 'Tags',\n};\n\nexport const vault = globalVault() as Vault;\n\n/** Given a language preference in descending order,\n * determine the best set of strings from the\n * internationalized string.\n */\nexport function getI18nValue(\n  val: string | InternationalString,\n  languagePreference: readonly string[]\n): string[];\nexport function getI18nValue(\n  val: string | InternationalString,\n  languagePreference: readonly string[],\n  separator: string\n): string;\nexport function getI18nValue(\n  val: string | InternationalString,\n  languagePreference: readonly string[],\n  separator?: string\n): string | string[] {\n  let splitAfter = false;\n  if (!separator) {\n    separator = '<<<SNIP>>>';\n    splitAfter = true;\n  }\n  const localized = buildLocaleString(val, languagePreference[0] ?? 'none', {\n    defaultText: '',\n    fallbackLanguages: languagePreference.slice(1),\n    separator,\n  });\n  if (splitAfter) {\n    return localized.split(separator).filter((s) => s.length > 0);\n  } else {\n    return localized;\n  }\n}\n\n\n/** Custom image loader to deal with browser + node intercompatibility.\n *\n * Used for the thumbnail helper.\n */\nclass ImageServiceLoader extends ImageServiceLoader_ {\n  async fetch(input: RequestInfo, init?: RequestInit): Promise<Response> {\n    return fetch(input as any, init as any) as any;\n  }\n}\n\nconst thumbHelper = createThumbnailHelper(vault, {\n  imageServiceLoader: new ImageServiceLoader(),\n});\n\n// A few helpers to deal with painting annotations\nexport const {\n  getPaintables,\n  getAllPaintingAnnotations,\n  extractChoices\n} = createPaintingAnnotationsHelper(vault);\n\n/** Determine best thumbnail image for the manifest. */\nexport async function getThumbnail(\n  manifest: ManifestNormalized,\n  maxDimension: number\n): Promise<string | undefined> {\n  const thumb = await thumbHelper.getBestThumbnailAtSize(manifest, {\n    maxWidth: maxDimension,\n    maxHeight: maxDimension,\n  });\n  return thumb.best?.id;\n}\n\n/** Like a regular external web resource, but with an associated\n profile URI, needed for OCR discovery */\nexport interface ExternalWebResourceWithProfile extends ExternalWebResource {\n  profile: string;\n}\n\n/** Check if a resource is an external resource with an\n * associated profile. */\nexport function isExternalWebResourceWithProfile(\n  res: ContentResource\n): res is ExternalWebResourceWithProfile {\n  return (\n    res.type !== undefined &&\n    ['Dataset', 'Image', 'Video', 'Sound', 'Text', 'unknown'].indexOf(\n      res.type\n    ) >= 0 &&\n    (res as ExternalWebResourceWithProfile).profile !== undefined\n  );\n}\n\n/** See https://iiif.io/api/annex/services/#physical-dimensions */\nexport interface PhysicalDimensionService {\n  '@context': 'http://iiif.io/api/annex/services/physdim/1/context.json';\n  profile: 'http://iiif.io/api/annex/services/physdim';\n  '@id': string;\n  physicalScale: number;\n  physicalUnits: 'in' | 'cm' | 'mm';\n}\n\n/** Check if a service is a IIIF Physical Dimensions service */\nexport function isPhysicalDimensionService(\n  service: any // eslint-disable-line @typescript-eslint/explicit-module-boundary-types\n): service is PhysicalDimensionService {\n  return (\n    typeof service.profile === 'string' &&\n    service.profile === 'http://iiif.io/api/annex/services/physdim'\n  );\n}\n\n\n/** Check if a IIIF Image endpoint supports arbitrary downscaling. */\nexport function supportsScaling(profile: ImageProfile): boolean {\n  if (typeof profile === 'string') {\n    return profile.indexOf('level2') >= 0;\n  } else {\n    return (profile.supports?.indexOf('sizeByWh') ?? -1) >= 0;\n  }\n}\n\n/** Fetch the full IIIF Image service definition from\n * its info.json endpoint. */\nexport async function fetchFullImageService(\n  serviceRef: ImageService\n): Promise<ImageService> {\n  const serviceUrl = `${serviceRef['@id'] ?? serviceRef.id}/info.json`;\n  const resp = await fetch(serviceUrl);\n  const res = await resp.json();\n  return res as ImageService;\n}\n\nexport type ImageInfo = {\n  // The 'Image' content resource\n  resource: (ExternalWebResource | IIIFExternalWebResource) & { type: 'Image' };\n  // Where to draw on the corresponding canvas\n  x: number;\n  y: number\n  // At what size to draw on the canvas?\n  width: number;\n  height: number;\n  // What is the image's size, if available?\n  nativeWidth?: number;\n  nativeHeight?: number;\n  ppi?: number;\n  choiceInfo?: {\n    enabled: boolean;\n    optional: boolean;\n    visibleByDefault: boolean;\n    label?: InternationalString;\n  }\n}\n\n/** Information about a canvas that can be obtained without\n *  fetching any external resources */\nexport type CanvasInfo = {\n  canvas: Reference<'Canvas'>;\n  ocr?: {\n    id: string;\n  };\n  images: ImageInfo[];\n  numAnnotations: number;\n};\n\n/** Extract all non-painting annotations that are of interest for PDF generation\n * from a canvas */\nexport function getCanvasAnnotations(canvas: CanvasNormalized): Annotation[] {\n  return vault\n    .get<AnnotationPageNormalized>(canvas.annotations)\n    .flatMap((p) => vault.get<AnnotationNormalized>(p.items))\n    .filter((a) =>\n      Array.isArray(a.motivation)\n        ? a.motivation.find((m) => PURPOSE_LABELS[m] !== undefined) !==\n        undefined\n        : PURPOSE_LABELS[a.motivation ?? 'invalid'] !== undefined\n    )\n    .map((a) => parseAnnotation(a, []))\n    .filter((a): a is Annotation => a !== undefined);\n}\n\n/** Obtain all information about a canvas and its images\n * without hitting any external endpoints.\n */\nexport function getCanvasInfo(canvas: CanvasNormalized): CanvasInfo {\n  const imageInfos = getImageInfos(canvas);\n  const text = getOcrReferences(canvas);\n  return {\n    canvas: { id: canvas.id, type: 'Canvas' },\n    images: imageInfos,\n    // eslint-disable-next-line @typescript-eslint/no-non-null-assertion\n    ocr: text ? { id: text.id! } : undefined,\n    numAnnotations: getCanvasAnnotations(canvas).length,\n  };\n}\n\n/** A annotation prepared for rendering to PDF. */\nexport interface Annotation {\n  id: string;\n  target: SupportedTarget;\n  markup: string;\n  lastModified?: Date;\n  author?: string;\n}\n\n/** Format an annotation agent to a human readable string. */\nfunction agentToString(agent: Agent): string {\n  let name = Array.isArray(agent.name) ? agent.name.join('; ') : agent.name;\n  if (!name) {\n    name = agent.nickname ?? 'unknown';\n  }\n  if (agent.email) {\n    return `${name} <${agent.email}>`;\n  }\n  return name;\n}\n\n/** Format a annotation creator definition to a human readable\n * string. */\nfunction creatorToString(creator: Creator): string {\n  if (Array.isArray(creator)) {\n    if (typeof creator[0] === 'string') {\n      return creator.join('; ');\n    } else {\n      return creator.map((a) => agentToString(a as Agent)).join('; ');\n    }\n  }\n  if (typeof creator === 'string') {\n    return creator;\n  }\n  return agentToString(creator);\n}\n\n/** Parse a IIIF annotation into a format that is more\n *  suitable for rendering to a PDF. */\nexport function parseAnnotation(\n  anno: AnnotationNormalized,\n  langPrefs: readonly string[]\n): Annotation | undefined {\n  if (!anno.target) {\n    return;\n  }\n  // TODO: i18n?\n  const annoBody = anno.body.map((bodyRef) =>\n    vault.get<ContentResource>(bodyRef)\n  );\n  const creatorNames: Array<string> = annoBody\n    .map((body) => body.creator)\n    .filter((v: Creator | undefined): v is Creator => v !== undefined)\n    .map(creatorToString);\n  const modifiedDates: Array<number> = annoBody\n    .map((body) => body.modified)\n    .filter((v: string | undefined): v is string => v !== undefined)\n    .map((v: string) => new Date(v).getTime());\n  const target = expandTarget(anno.target);\n  const markup = buildAnnotationMarkup(annoBody);\n  if (!markup) {\n    // TODO: Log?\n    throw `No valid textual content in annotation.`;\n  }\n  return {\n    id: anno.id,\n    target,\n    markup,\n    lastModified:\n      modifiedDates.length > 0\n        ? new Date(Math.max(...modifiedDates))\n        : undefined,\n    author: creatorNames.length > 0 ? creatorNames.join('; ') : undefined,\n  };\n}\n\n/** Convert Annotation HTML to PDF Markup */\nfunction buildAnnotationMarkup(\n  bodies: Array<ContentResource>\n): string | undefined {\n  const parts: { [purpose: string]: Array<string> } = {};\n  for (const body of bodies) {\n    if (\n      body.type !== 'TextualBody' ||\n      (body.format !== 'text/plain' && body.format !== 'text/html') ||\n      body.value === undefined\n    ) {\n      continue;\n    }\n    let { purpose } = body;\n    if (Array.isArray(purpose)) {\n      purpose = purpose[0];\n    } else if (!purpose) {\n      purpose = 'no-purpose';\n    }\n    if (!parts[purpose]) {\n      parts[purpose] = [];\n    }\n    parts[purpose].push(body.value);\n  }\n  if (Object.keys(parts).length === 0) {\n    return undefined;\n  }\n  const out: Array<string> = [];\n  for (const purpose of PURPOSE_ORDER) {\n    const purposeLabel = PURPOSE_LABELS[purpose];\n    if (!parts[purpose]) {\n      continue;\n    }\n    if (parts[purpose].length > 1) {\n      if (purposeLabel) {\n        out.push(`<p><b>${purposeLabel}:</b></p>`);\n      }\n      for (const part of parts[purpose]) {\n        // TODO: Convert HTML to PDF rich text\n        out.push(`<p>${part}</p>`);\n      }\n    } else {\n      out.push('<p>');\n      if (purposeLabel) {\n        out.push(`<b>${purposeLabel}:</b> `);\n      }\n      out.push(`${parts[purpose][0]}</p>`);\n    }\n  }\n  if (out.length === 0) {\n    return undefined;\n  }\n  return out.join('\\n');\n}\n\nexport interface CompatibilityReport {\n  compatibility: 'compatible' | 'incompatible' | 'degraded';\n  incompatibleElements: {\n    [canvasId: string]: Set<\n      | 'no-jpeg' // At least one image doesn't have a JPEG representation\n      | 'no-image' // Canvas does not have a single image annotation\n      | 'annotations' // Canvas has non-painting annotations\n      | 'unsupported-painting'\n    >;\n  };\n}\n\nexport function checkCompatibility(\n  manifest: ManifestNormalized\n): CompatibilityReport | undefined {\n  const report = {\n    compatibility: 'compatible',\n    incompatibleElements: {},\n  };\n  for (const canvas of vault.get<CanvasNormalized>(manifest.items)) {\n    const paintingResources = vault\n      .get<AnnotationPageNormalized>(canvas.items)\n      .flatMap((ap) => vault.get<AnnotationNormalized>(ap.items))\n      .flatMap((a) => vault.get<ContentResource>(a.body));\n    const nonPaintingAnnos = manifest.annotations;\n    // TODO: Check if canvas has an image\n    // TODO: Check if every painting annotation is an image with a JPEG available\n    // TODO: Check for the presence of non-painting annotations\n  }\n  return undefined;\n}\n\n/** Parse a IIIF target specification */\nexport function parseTarget(targetStr: string): { x: number; y: number, width: number, height: number } {\n  const [canvasId, fragment] = targetStr.split('#xywh=');\n  if (fragment) {\n    const [x, y, width, height] = fragment\n      .split(',')\n      .map((x) => parseInt(x, 10));\n    return { x, y, width, height };\n  } else {\n    const canvas = vault.get<CanvasNormalized>(canvasId);\n    // Draw to fit canvas\n    return { x: 0, y: 0, width: canvas.width, height: canvas.height };\n  }\n}\n\n/** Get information about images on a Canvas. */\nexport function getImageInfos(canvas: CanvasNormalized): ImageInfo[] {\n  const imageInfos: ImageInfo[] = [];\n  const paintingAnnos = getAllPaintingAnnotations(canvas);\n  for (const anno of paintingAnnos) {\n    if (typeof anno.target !== 'string') {\n      log.error(`Annotation ${anno.id} has a non-string target, currently not supported.`);\n      continue;\n    }\n    const target = parseTarget(anno.target);\n\n    const body = vault.get<ContentResource>(anno.body);\n    for (const resource of body) {\n      if (resource.type !== 'Image') {\n        continue;\n      }\n      imageInfos.push({\n        resource: resource as (ExternalWebResource | IIIFExternalWebResource) & { type: 'Image' },\n        ...target,\n        nativeWidth: (resource as any).width as number | undefined,\n        nativeHeight: (resource as any).height as number | undefined,\n      });\n    }\n  }\n\n  const choice = extractChoices(paintingAnnos);\n  if (choice?.type !== 'single-choice') {\n    // Return early if there are no choices available\n    return imageInfos;\n  }\n\n  for (const choiceItem of choice.items) {\n    const resource = vault.get<ContentResource>(choiceItem.id);\n    if (resource.type !== 'Image') {\n      continue;\n    }\n    imageInfos.push({\n      resource: resource as (ExternalWebResource | IIIFExternalWebResource) & { type: 'Image' },\n      // FIXME: Can't choice images have a location and rendering dimensions?\n      x: 0,\n      y: 0,\n      width: canvas.width,\n      height: canvas.height,\n      nativeWidth: (resource as any).width as number | undefined,\n      nativeHeight: (resource as any).height as number | undefined,\n      choiceInfo: {\n        enabled: choiceItem.selected ?? false,\n        optional: true,\n        label: (resource as any).label,\n        visibleByDefault: choiceItem.selected ?? false,\n      }\n    });\n  }\n\n  return imageInfos;\n}","/// <reference types=\"wicg-file-system-access\"/>\nimport type { Writable } from 'stream';\nimport {\n  Manifest,\n  RangeItems,\n  ManifestNormalized,\n  CanvasNormalized,\n  RangeNormalized,\n  Reference,\n  IIIFExternalWebResource,\n  ContentResource,\n  Service,\n  ImageService,\n  AnnotationNormalized,\n  ResourceProviderNormalized,\n  Annotation as IIIF3Annotation,\n} from '@iiif/presentation-3';\nimport Presentation2 from '@iiif/presentation-2';\nimport { convertPresentation2 } from '@iiif/parser/presentation-2';\nimport PQueue from 'p-queue';\nimport events from 'events';\nimport * as ocrParser from 'ocr-parser';\n\nimport PDFGenerator from './pdf/generator.js';\nimport {\n  CountingWriter,\n  WebWriter,\n  NodeWriter,\n  Writer,\n  BlobWriter,\n} from './io.js';\nimport { TocItem } from './pdf/util.js';\nimport { getLicenseInfo } from './res/licenses.js';\nimport { getOcrReferences } from './ocr.js';\nimport pdiiifVersion from './version.js';\nimport {\n  fetchCanvasData,\n  fetchRespectfully,\n  CanvasData,\n  fetchStartCanvasInfo,\n  StartCanvasInfo,\n  fetchManifestJson,\n} from './download.js';\nimport metrics from './metrics.js';\nimport { initializeSaxParser, isDefined, now, saxParserWasm } from './util.js';\nimport log from './log.js';\nimport {\n  getI18nValue,\n  getThumbnail,\n  getCanvasInfo,\n  vault,\n  parseAnnotation,\n  Annotation,\n} from './iiif.js';\n\n/** Progress information for rendering a progress bar or similar UI elements. */\nexport interface ProgressStatus {\n  /** Message code that should be mapped to a human readable description in a UI. */\n  messageCode?: ProgressMessageCode;\n  /** Expected total number of pages in the PDF */\n  totalPages: number;\n  /** Number of pages that were submitted for writing */\n  pagesWritten: number;\n  /** Number of bytes that were submitted for writing to the output stream */\n  bytesPushed: number;\n  /** Number of bytes that were written to the output stream so far */\n  bytesWritten: number;\n  /** Predicted size of the final file in bytes */\n  estimatedFileSize?: number;\n  /** Write speed in bytes per second */\n  writeSpeed: number;\n  /** Estimated time in seconds until PDF has finished generating */\n  remainingDuration: number;\n}\n\n/** Parameters for rendering a cover page, parsed from IIIF manifest. */\nexport interface CoverPageParams {\n  title: string;\n  manifestUrl: string;\n  thumbnail?: {\n    url: string;\n    iiifImageService?: string;\n  };\n  provider?: {\n    label: string;\n    homepage?: string;\n    logo?: string;\n  };\n  requiredStatement?: {\n    label: string;\n    value: string;\n  };\n  rights?: {\n    text: string;\n    url?: string;\n    logo?: string;\n  };\n  metadata?: Array<[string, string | Array<string>]>;\n  pdiiifVersion: string;\n}\n\n/** Options for converting a IIIF Manifest to a PDF. */\nexport interface ConvertOptions {\n  /** Callback to provide annotations for a given canvas identifier.\n   * Should return either a `sc:AnnotationList` (IIIF2) or an `AnnotationPage` (IIIF3).\n   */\n  fetchCanvasAnnotations?: (\n    canvasId: string\n  ) => Promise<Array<IIIF3Annotation> | Array<Presentation2.Annotation>>;\n  /** Pixels per inch to assume for the full resolution version of each canvas.\n      If not set, the conversion will use an available IIIF Physical Dimensions\n      service to calculate the page dimensions instead. */\n  ppi?: number;\n  /** Set of canvas ids to include in PDF, or a predicate to filter canvas identifiers\n      by. By default, all canvases are included in the PDF. */\n  filterCanvases?: readonly string[] | ((canvasId: string) => boolean);\n  /** List of languages to use for metadata, page labels and table of contents, in\n      descending order of preference. Will use the environment's locale settings by\n      default. */\n  languagePreference?: readonly string[];\n  /** Restrict the image size to include in the PDF by downscaling by a fixed factor.\n   * The value must be a number between 0.1 and 1.\n   * Only works with Level 2 Image API services that allow arbitrary downscaling, the\n   * conversion will not perform downscaling itself.\n   * For Level 1 endpoints, the closest available lower width will be selected. */\n  scaleFactor?: number;\n  /** Number of maximum concurrent IIIF Image API requests to be performed, defaults to 1 */\n  concurrency?: number;\n  /** Callback that gets called whenever a page has finished, useful to render a\n      progress bar. */\n  onProgress?: (status: ProgressStatus) => void;\n  /** Callback that gets called with a notification when an error occurs during PDF generation\n   *  that does not cause the conversion to fail. */\n  onNotification?: (notification: ProgressNotification) => void;\n  /** Controller that allows aborting the PDF generation. All pending\n      downloads will be terminated. The caller is responsible for\n      removing underlying partial files and/or other user signaling. */\n  abortController?: AbortController;\n  /** Set PDF metadata, by default `Title` will be the manifest's label. */\n  metadata?: {\n    CreationDate?: Date;\n    Title?: string;\n    Author?: string;\n    Keywords?: string;\n  };\n  /** Endpoint to contact for retrieving PDF data with one or more cover pages\n      to insert before the canvas pages */\n  coverPageEndpoint?: string;\n  /** Callback to call for retrieving PDF data with one or more cover pages\n      to insert before the canvas pages */\n  coverPageCallback?: (params: CoverPageParams) => Promise<Uint8Array>;\n  /** Generate the PDF in a way that the resulting file is also a valid\n   *  ZIP file that contains the manifest, all of the images and, if present,\n   *  the OCR files referenced in the manifest. */\n  polyglotZipPdf?: boolean;\n  /** Base directory in the polyglot ZIP archive. If not set, all resource\n   * directories will be to-level in the archive. */\n  polyglotZipBaseDir?: string;\n  /** Custom loader callback that fetches the WASM binary for the `sax-wasm`\n   *  dependency (v2.2.4). By default, the dependency will be loaded from\n   *  `https://unpkg.com/sax-wasm/dist/sax-wasm.wasm`. Override if you want\n   *  to provide your own payload. Loader will not be called if {@link initialize}\n   *  from `ocr-parser` has been called before.\n   */\n  saxWasmLoader?: () => Promise<Uint8Array>;\n}\n\n/** Parameters for size estimation */\nexport interface EstimationParams {\n  /** The manifest to determine the PDF size for */\n  manifest: string | Manifest | Presentation2.Manifest;\n  /** Restrict the image size to include in the PDF by downscaling by a fixed factor.\n   * The value must be a number between 0.1 and 1.\n   * Only works with Level 2 Image API services that allow arbitrary downscaling, the\n   * conversion will not perform downscaling itself.\n   * For Level 1 endpoints, the closest available lower width will be selected. */\n  scaleFactor?: number;\n  /** Set of canvas ids to include in PDF, or a predicate to filter canvas identifiers\n      by. By default, all canvases are included in the PDF. */\n  filterCanvases?: readonly string[] | ((canvasId: string) => boolean);\n  /** Number of canvses to sample for estimation, defaults to 8 */\n  numSamples?: number;\n  /** Number of maximum concurrent IIIF Image API requests to be performed, defaults to 1 */\n  concurrency?: number;\n}\n\nexport type Estimation = {\n  /** Estimated size of the PDF in bytes */\n  size: number;\n  /** If CORS is enabled for all of the images referenced in the sample canvases */\n  corsSupported: boolean;\n\n}\n\nfunction getCanvasesForSampling(canvases: CanvasNormalized[], numSamples: number): CanvasNormalized[] {\n  if (canvases.length <= numSamples) {\n    return canvases;\n  }\n  const meanPixels = canvases.reduce(\n    (x, { width, height }) => x + width * height, 0) / canvases.length;\n  const candidateCanvases = canvases.filter(\n    (c) => Math.abs(meanPixels - c.width * c.height) <= 0.25 * meanPixels\n  );\n  if (candidateCanvases.length <= numSamples) {\n    return candidateCanvases;\n  }\n  const sampleCanvases: CanvasNormalized[] = []\n  while (sampleCanvases.length < numSamples) {\n    const candidate = candidateCanvases[Math.floor(Math.random() * candidateCanvases.length)]\n    if (sampleCanvases.indexOf(candidate) < 0) {\n      sampleCanvases.push(candidate)\n    }\n  }\n  return sampleCanvases;\n}\n\n/** Estimate the final size of the PDF for a given manifest.\n *\n * This will randomly sample a few representative canvases from the manifest,\n * check their size in bytes and extrapolate from that to all canvases.\n *\n * @throws {Error} if the manifest cannot be loaded\n */\nexport async function estimatePdfSize({\n  manifest: inputManifest,\n  concurrency = 1,\n  scaleFactor,\n  filterCanvases = () => true,\n  numSamples = 8,\n}: EstimationParams): Promise<Estimation> {\n  let manifestId;\n  if (typeof inputManifest === 'string') {\n    manifestId = inputManifest;\n  } else {\n    manifestId =\n      (inputManifest as Manifest).id ??\n      (inputManifest as Presentation2.Manifest)['@id'];\n  }\n  const manifestJson = await fetchManifestJson(manifestId);\n  const manifest = await vault.loadManifest(manifestId, manifestJson);\n  if (!manifest) {\n    throw new Error(`Failed to load manifest from ${manifestId}`);\n  }\n  let canvasPredicate: (canvasId: string) => boolean;\n  if (Array.isArray(filterCanvases)) {\n    canvasPredicate = (canvasId) => filterCanvases.indexOf(canvasId) >= 0;\n  } else {\n    canvasPredicate = filterCanvases as (id: string) => boolean;\n  }\n\n  const canvases = vault.get<CanvasNormalized>(\n    manifest.items.filter((c) => canvasPredicate(c.id))\n  );\n\n  // Select some representative canvases that are close to the mean in terms\n  // of their pixel area to avoid small images distorting the estimate too much\n  const totalCanvasPixels = canvases.reduce(\n    (sum, canvas) => sum + canvas.width * canvas.height,\n    0\n  );\n  const sampleCanvases = getCanvasesForSampling(canvases, numSamples);\n  const samplePixels = sampleCanvases.reduce(\n    (sum, canvas) => sum + canvas.width * canvas.height,\n    0\n  );\n  const queue = new PQueue({ concurrency });\n  const canvasData = await Promise.all(\n    sampleCanvases.map((c) =>\n      queue.add(async () => {\n        const info = getCanvasInfo(c);\n        return fetchCanvasData(c, info.images, { scaleFactor, sizeOnly: true });\n      })\n    )\n  );\n  const corsSupported = canvasData\n    .filter(isDefined<CanvasData>)\n    .flatMap((c) => c.images)\n    .every(i => i.corsAvailable);\n  const sampleBytes = canvasData\n    .filter(isDefined<CanvasData>)\n    .flatMap((c) => c.images)\n    .reduce((size: number, data) => size + (data?.numBytes ?? 0), 0);\n  const bpp = sampleBytes / samplePixels;\n  return {\n    size: bpp * totalCanvasPixels,\n    corsSupported,\n  };\n}\n\nasync function buildOutlineFromRanges(\n  manifest: ManifestNormalized,\n  canvases: CanvasNormalized[],\n  languagePreference: string[]\n): Promise<Array<TocItem>> {\n  // ToC generation: IIIF's `Range` construct is so open, doing anything useful with it is a pain :-/\n  // In our case, the pain comes from multiple directions:\n  // - PDFs can only connect an outline node to a *single* page (IIIF connects ranges of pages)\n  // - IIIF doesn't prescribe an order for the ranges or the canvases contained in them\n  // Our approach is to pre-generate the range associated with each canvas and a hierarchy\n  // of parent-child relationships for ranges.\n\n  // All canvas identifiers in the order they appear as in the sequence\n  // Note that this is a *filtered* list of canvases, i.e. if the user only selected a subset of the\n  // canvases for PDF generation, not every Range in the manifest will have all of its canvases in here\n  const canvasIds = canvases.map((canvas) => canvas.id);\n\n  // We have to recurse, this small closure handles each node in the tree\n  const isCanvas = (ri: RangeItems): ri is Reference<'Canvas'> =>\n    typeof ri !== 'string' && ri.type === 'Canvas';\n  const isRange = (ri: RangeItems): ri is Reference<'Range'> =>\n    typeof ri !== 'string' && ri.type == 'Range';\n\n  const seenRanges: Set<string> = new Set();\n  const handleTocRange = async (\n    range: RangeNormalized\n  ): Promise<TocItem | undefined> => {\n    if (seenRanges.has(range.id)) {\n      return;\n    }\n    // Double filtering with `isCanvas` is necessary because of TS limitations\n    const firstCanvas = range.items\n      .filter(isCanvas)\n      .filter(c => canvasIds.indexOf(c.id) >= 0)\n      .filter(isCanvas)\n      .sort((a, b) => canvasIds.indexOf(a.id) > canvasIds.indexOf(b.id) ? -1 : 1)[0];\n    const rangeLabel = getI18nValue(\n      range.label ?? '<untitled>',\n      languagePreference,\n      '; '\n    );\n    const childRanges = vault.get<RangeNormalized>(range.items.filter(isRange));\n    const children = (\n      await Promise.all(childRanges.map(handleTocRange))\n    ).filter(isDefined<TocItem>);\n\n    let startCanvas: StartCanvasInfo | undefined;\n    if (range.start) {\n      startCanvas = await fetchStartCanvasInfo(range);\n    }\n    seenRanges.add(range.id);\n    if (children.length === 0 && !firstCanvas) {\n      // Range with no canvases and no child ranges, ignore\n      // This usually happens when the user filtered the canvases to be included in the\n      // PDF and the range and its children only contains canvases that were filtered out\n      return;\n    } else if (!startCanvas && firstCanvas) {\n      startCanvas = firstCanvas.id;\n    } else if (!startCanvas) {\n      startCanvas = children[0].startCanvas;\n    }\n    return {\n      label: rangeLabel,\n      startCanvas,\n      children,\n    };\n  };\n\n  let tocRanges = vault.get<RangeNormalized>(manifest.structures);\n  const topRange = tocRanges.find(r => (r.behavior as string[]).indexOf(\"top\") >= 0);\n  // If there's a 'top' range, only use that as the single top-level ToC node\n  if (topRange) {\n    tocRanges = [topRange];\n  }\n\n  return (\n    (\n      await Promise.all(tocRanges.map(handleTocRange)\n      )\n    ).filter(isDefined<TocItem>) ?? []\n  );\n}\n\nexport type ProgressMessageCode =\n  'generate-cover-page' |\n  'generate-pages' |\n  'finishing';\n\nexport type ProgressNotification =\n  ImageDownloadFailureNotification |\n  OcrDownloadFailureNotification;\n\nexport type ImageDownloadFailureNotification = {\n  code: 'image-download-failure';\n  canvasIndex: number;\n  numFailed: number;\n  numTotal: number;\n  details: {\n    [imageUrl: string]: string;\n  }\n}\nexport type OcrDownloadFailureNotification = {\n  code: 'ocr-download-failure';\n  canvasIndex: number;\n  ocrUrl: string;\n}\n\n/** Tracks PDF generation progress and various statistics related to that. */\nclass ProgressTracker {\n  canvasPixels = 0;\n  pixelsWritten = 0;\n  pixelBytesFactor = 0;\n  pixelScaleFactor = 0;\n  timeStart: number | undefined;\n\n  pdfGen: PDFGenerator;\n  totalPages: number;\n  totalCanvasPixels = 0;\n  countingStream: CountingWriter;\n  onProgress?: (status: ProgressStatus) => void;\n  onNotification?: (notification: ProgressNotification) => void;\n\n  constructor(\n    canvases: CanvasNormalized[],\n    countingStream: CountingWriter,\n    pdfGen: PDFGenerator,\n    onProgress?: (status: ProgressStatus) => void,\n    onNotification?: (notification: ProgressNotification) => void\n  ) {\n    this.totalCanvasPixels = canvases.reduce(\n      (sum, canvas) => sum + canvas.width * canvas.height,\n      0\n    );\n    this.totalPages = canvases.length;\n    this.pdfGen = pdfGen;\n    this.countingStream = countingStream;\n    this.onProgress = onProgress;\n    this.onNotification = onNotification;\n  }\n\n  /** Check if there is still data that needs to be written out. */\n  get writeOutstanding(): boolean {\n    return this.pdfGen.bytesWritten > this.countingStream.bytesWritten;\n  }\n\n  /** Emit a progress update, with an optional message. */\n  emitProgress(pagesWritten: number, messageCode?: ProgressMessageCode): void {\n    if (!this.timeStart) {\n      this.timeStart = now();\n    }\n    const bytesPushed = this.pdfGen.bytesWritten;\n    let estimatedFileSize;\n    if (pagesWritten === this.totalPages) {\n      estimatedFileSize = bytesPushed;\n    } else if (pagesWritten > 0) {\n      estimatedFileSize = Math.floor(\n        this.pixelBytesFactor * this.pixelScaleFactor * this.totalCanvasPixels\n      );\n    }\n    const bytesWritten = this.countingStream.bytesWritten;\n    const writeSpeed = bytesPushed / ((now() - this.timeStart) / 1000);\n    let remainingDuration = Number.POSITIVE_INFINITY;\n    if (estimatedFileSize) {\n      remainingDuration = (estimatedFileSize - bytesWritten) / writeSpeed;\n    }\n    this.onProgress?.({\n      messageCode,\n      pagesWritten,\n      totalPages: this.totalPages,\n      bytesWritten,\n      bytesPushed,\n      estimatedFileSize,\n      writeSpeed,\n      remainingDuration,\n    });\n  }\n\n  /** Emit a notification message to inform the user about unexpected stuff that\n   * happens during PDF generation */\n  emitNotification(notification: ProgressNotification) {\n    this.onNotification?.(notification);\n  }\n\n  /** Update how many actual pixels and 'canvas pixels' have been written. */\n  updatePixels(pixelsWritten: number, canvasPixels: number) {\n    this.pixelsWritten += pixelsWritten;\n    this.canvasPixels += canvasPixels;\n    this.pixelScaleFactor = this.pixelsWritten / this.canvasPixels;\n    this.pixelBytesFactor = this.pdfGen.bytesWritten / this.pixelsWritten;\n  }\n}\n\n/** Generate a cover page PDF, either via user-provided callback, or by fetching\n * it from a remote endpoint. */\nasync function getCoverPagePdf(\n  manifest: ManifestNormalized,\n  languagePreference: Array<string>,\n  endpoint?: string,\n  callback?: (params: CoverPageParams) => Promise<Uint8Array>\n): Promise<Uint8Array> {\n  const params: CoverPageParams = {\n    // NOTE: Manifest label is mandatory, i.e. safe to assert non-null\n    // eslint-disable-next-line @typescript-eslint/no-non-null-assertion\n    title: getI18nValue(\n      manifest.label ?? '<untitled>',\n      languagePreference,\n      '; '\n    ),\n    manifestUrl: manifest.id,\n    pdiiifVersion,\n  };\n  const thumbUrl = await getThumbnail(manifest, 512);\n  if (thumbUrl) {\n    params.thumbnail = { url: thumbUrl };\n    const manifestThumb = vault.get<ContentResource>(manifest.thumbnail)[0];\n    if (manifestThumb && 'type' in manifestThumb) {\n      params.thumbnail.iiifImageService = (\n        manifestThumb as IIIFExternalWebResource\n      ).service?.find(\n        (s: Service): s is ImageService =>\n          (s as ImageService | undefined)?.type?.startsWith('ImageService') ??\n          false\n      )?.id;\n    }\n  }\n\n  const provider = vault.get<ResourceProviderNormalized>(manifest.provider)[0];\n  const required = manifest.requiredStatement;\n  if (provider) {\n    params.provider = {\n      label: getI18nValue(provider.label, languagePreference, '; '),\n      homepage: provider.homepage?.[0]?.id,\n      logo: provider.logo?.[0]?.id,\n    };\n    // FIXME: Currently this is assigned by @iiif/parser when converting from v2 to v3\n    if (params.provider.label === 'Unknown') {\n      params.provider.label = '';\n    }\n  }\n  if (required != null && required.label) {\n    params.requiredStatement = {\n      label: getI18nValue(required.label, languagePreference, '; '),\n      value: getI18nValue(required.value, languagePreference, '; '),\n    };\n  }\n  const license = manifest.rights;\n  if (license) {\n    const licenseDef = getLicenseInfo(license);\n    params.rights = {\n      text: licenseDef?.text ?? license,\n      url: license,\n      logo: licenseDef?.logo,\n    };\n  }\n  params.metadata =\n    manifest.metadata\n      ?.map((itm) => {\n        const label = getI18nValue(itm.label, languagePreference, '; ');\n        const values = getI18nValue(itm.value, languagePreference, '|||').split(\n          '|||'\n        );\n        if (!label || values.length === 0) {\n          return;\n        }\n        if (values.length === 1) {\n          return [label, values[0]];\n        } else {\n          return [label, values];\n        }\n      })\n      .filter((x): x is [string, string | string[]] => x !== undefined) ?? [];\n  if (callback) {\n    return await callback(params);\n  } else if (endpoint) {\n    const resp = await fetchRespectfully(endpoint, {\n      method: 'POST',\n      headers: { 'Content-Type': 'application/json' },\n      body: JSON.stringify(params),\n    });\n    const buf = await resp.arrayBuffer();\n    return new Uint8Array(buf);\n  } else {\n    throw 'Either `endpoint` or `callback` must be specified!';\n  }\n}\n\nexport type ConversionReport = {\n  fileSizeBytes: number;\n  numPages: number;\n  fileName?: string;\n  failedImages?: Array<{\n    canvasIndex: number;\n    numFailed: number;\n    numTotal: number;\n    details: {\n      [imageUrl: string]: string;\n    }\n  }>;\n  failedOcr?: Array<{\n    canvasIndex: number;\n    ocrUrl: string;\n  }>;\n}\n\nexport type ConversionReportWithData = ConversionReport & { data: Blob };\n\nexport async function convertManifest(\n  inputManifest: string | Manifest | Presentation2.Manifest,\n  outputStream: Writable | WritableStream,\n  options: ConvertOptions\n): Promise<ConversionReport>;\nexport async function convertManifest(\n  inputManifest: string | Manifest | Presentation2.Manifest,\n  outputStream: undefined,\n  options: ConvertOptions\n): Promise<ConversionReportWithData>;\n/** Convert a IIIF manifest to a PDF,  */\nexport async function convertManifest(\n  /* eslint-disable  @typescript-eslint/explicit-module-boundary-types */\n  inputManifest: string | Manifest | Presentation2.Manifest,\n  outputStream: Writable | WritableStream | undefined,\n  {\n    fetchCanvasAnnotations = () => Promise.resolve([]),\n    filterCanvases = () => true,\n    languagePreference = [Intl.DateTimeFormat().resolvedOptions().locale],\n    scaleFactor,\n    metadata = {},\n    onProgress,\n    onNotification,\n    ppi,\n    concurrency = 1,\n    abortController = new AbortController(),\n    coverPageCallback,\n    coverPageEndpoint,\n    polyglotZipPdf,\n    polyglotZipBaseDir,\n    saxWasmLoader = async () =>\n      fetch(`https://unpkg.com/sax-wasm@${ocrParser.SAX_WASM_VERSION}/lib/sax-wasm.wasm`)\n        .then((res) => res.arrayBuffer())\n        .then((buf) => new Uint8Array(buf)),\n  }: ConvertOptions\n): Promise<ConversionReport | ConversionReportWithData> {\n  // Prevent warning when running in Node.js\n  if (typeof process !== \"undefined\") {\n    events.setMaxListeners(100, abortController.signal);\n  }\n  let writer: Writer;\n  if (!outputStream) {\n    log.debug('Writing to Blob');\n    writer = new BlobWriter();\n    // Can't use `instanceof` since we don't have the Node class in the\n    // browser and vice versa, so examine the shape of the object\n  } else if (typeof (outputStream as Writable).destroy === 'function') {\n    log.debug('Writing to Node writable stream');\n    writer = new NodeWriter(outputStream as Writable);\n    // Cancel further processing once the underlying stream has been closed\n    // This will only have an effect if the PDF has not finished generating\n    // yet (i.e. when the client terminates the connection prematurely),\n    // otherwise all processing will long have stopped\n    (outputStream as Writable).on('close', () => abortController.abort());\n  } else {\n    log.debug('Writing to file system');\n    writer = new WebWriter(outputStream as WritableStream);\n  }\n  const countingWriter = new CountingWriter(writer);\n  const report = {\n    fileSizeBytes: 0,\n    numPages: 0,\n  } as ConversionReport;\n\n  // Build a canvas predicate function from a list of identifiers, if needed\n  let canvasPredicate: (canvasId: string) => boolean;\n  if (Array.isArray(filterCanvases)) {\n    canvasPredicate = (canvasId) => filterCanvases.indexOf(canvasId) >= 0;\n  } else {\n    canvasPredicate = filterCanvases as (id: string) => boolean;\n  }\n\n  let manifestId: string;\n  let manifestJson: Manifest | Presentation2.Manifest;\n  if (typeof inputManifest === 'string') {\n    manifestId = inputManifest;\n    manifestJson = await fetchManifestJson(manifestId) as\n      | Manifest\n      | Presentation2.Manifest;\n  } else {\n    manifestId =\n      (inputManifest as Presentation2.Manifest)['@id'] ??\n      (inputManifest as Manifest).id;\n    manifestJson = inputManifest;\n  }\n  const manifest = await vault.loadManifest(manifestId, manifestJson);\n  if (!manifest) {\n    throw new Error(`Failed to load manifest from ${manifestId}`);\n  }\n\n  const pdfMetadata = { ...metadata };\n  if (!pdfMetadata.Title && manifest.label) {\n    pdfMetadata.Title = getI18nValue(\n      manifest.label,\n      languagePreference as string[],\n      '; '\n    );\n  }\n\n  const canvases = vault.get<CanvasNormalized>(\n    manifest.items.filter((c) => canvasPredicate(c.id))\n  );\n  const hasText = !!canvases.find((c) => !!getOcrReferences(c));\n  const labels = canvases.map((canvas) =>\n    canvas.label ? getI18nValue(canvas.label, languagePreference, '; ') : ''\n  );\n\n  // Initialize XML parsers\n  if (!saxParserWasm || !ocrParser.isInitialized()) {\n    if (!saxParserWasm) {\n      const wasm = await saxWasmLoader();\n      initializeSaxParser(wasm);\n    }\n    if (!ocrParser.isInitialized()) {\n      await ocrParser.initialize(() => Promise.resolve(saxParserWasm!));\n      ocrParser.setupLogging({\n        debug: log.debug.bind(log),\n        info: log.info.bind(log),\n        warn: log.warn.bind(log),\n        error: log.error.bind(log),\n      });\n    }\n  }\n\n  // Fetch images concurrently, within limits specified by user\n  log.debug(`Setting up queue with ${concurrency} concurrent canvas fetches.`);\n  const queue = new PQueue({ concurrency });\n  abortController.signal.addEventListener('abort', () => queue.clear(), {\n    once: true,\n  });\n  const canvasInfos = canvases.map(getCanvasInfo);\n  const canvasFuts = canvases.map((c, idx) => {\n    return queue.add(() => {\n      const info = canvasInfos[idx];\n      return fetchCanvasData(c, info.images, {\n        scaleFactor,\n        ppiOverride: ppi,\n        abortSignal: abortController.signal,\n      });\n    });\n  });\n\n  const outline = await buildOutlineFromRanges(\n    manifest,\n    canvases,\n    languagePreference as string[]\n  );\n  const pdfGen = new PDFGenerator({\n    writer: countingWriter,\n    metadata: pdfMetadata,\n    canvasInfos: canvases.map((c, idx) => ({\n      canvasIdx: idx,\n      ...canvasInfos[idx]\n    })),\n    langPref: languagePreference,\n    pageLabels: labels,\n    outline,\n    hasText,\n    initialCanvas: await fetchStartCanvasInfo(manifest),\n    readingDirection:\n      manifest.viewingDirection === 'right-to-left'\n        ? 'right-to-left'\n        : 'left-to-right',\n    manifestJson,\n    zipPolyglot: polyglotZipPdf,\n    zipBaseDir: polyglotZipBaseDir,\n  });\n  log.debug(`Initialising PDF generator.`);\n  await pdfGen.setup();\n  const progress = new ProgressTracker(\n    canvases,\n    countingWriter,\n    pdfGen,\n    onProgress,\n    onNotification,\n  );\n  progress.emitProgress(0);\n\n  if (coverPageCallback || coverPageEndpoint) {\n    log.debug(`Generating cover page`);\n    progress.emitProgress(0, 'generate-cover-page');\n    try {\n      const coverPageData = await getCoverPagePdf(\n        manifest,\n        languagePreference as string[],\n        coverPageEndpoint,\n        coverPageCallback\n      );\n      log.debug('Inserting cover page into PDF');\n      await pdfGen.insertCoverPages(coverPageData);\n    } catch (err) {\n      log.error('Error while generating cover page', err);\n      abortController.abort();\n      throw err;\n    }\n  }\n\n  progress.emitProgress(0, 'generate-pages');\n  for (let canvasIdx = 0; canvasIdx < canvases.length; canvasIdx++) {\n    if (abortController.signal.aborted) {\n      log.debug('Abort signalled, aborting while waiting for image data.');\n      break;\n    }\n    try {\n      log.debug(`Waiting for data for canvas #${canvasIdx}`);\n      const canvasData = await canvasFuts[canvasIdx];\n      // This means the task was aborted, do nothing\n      // FIXME: Doesn't this also happen in case of an error?\n      if (!canvasData) {\n        throw 'Aborted';\n      }\n      const canvas = vault.get<CanvasNormalized>(canvasData.canvas);\n      const canvasInfo = canvasInfos[canvasIdx];\n      const { images, ppi, text, annotations, imageFailures } = canvasData;\n      if (imageFailures.length > 0) {\n        if (!report.failedImages) {\n          report.failedImages = [];\n        }\n        const reportData = {\n          canvasIndex: canvasIdx,\n          numFailed: imageFailures.length,\n          numTotal: images.length + imageFailures.length,\n          details: Object.fromEntries(\n            imageFailures.map((f) => [\n              f.resource.id ?? '<unknown>',\n              f.cause instanceof Error ? f.cause.toString() : f.cause\n            ]))\n        };\n        report.failedImages.push(reportData);\n        progress.emitNotification({\n          code: 'image-download-failure',\n          ...reportData\n        });\n      }\n      if (canvasInfo.ocr && !text?.markup) {\n        if (!report.failedOcr) {\n          report.failedOcr = [];\n        }\n        const reportData = {\n          canvasIndex: canvasIdx,\n          ocrUrl: canvasInfo.ocr.id,\n        }\n        report.failedOcr.push(reportData);\n        progress.emitNotification({\n          code: 'ocr-download-failure',\n          ...reportData,\n        });\n      }\n      const externalAnnotations = await fetchCanvasAnnotations(canvas.id);\n      if (externalAnnotations != null) {\n        const normalized = await Promise.all(\n          externalAnnotations.map((a) => {\n            if (!('id' in a)) {\n              a = convertPresentation2(a) as IIIF3Annotation;\n            }\n            return vault.load<AnnotationNormalized>(a.id, a);\n          })\n        );\n        if (normalized) {\n          normalized\n            .filter((a): a is AnnotationNormalized => a !== undefined)\n            .map((a) => parseAnnotation(a, languagePreference))\n            .filter((a): a is Annotation => a !== undefined)\n            .forEach((a) => annotations.push(a));\n        }\n      }\n      // eslint-disable-next-line @typescript-eslint/no-non-null-assertion\n      const stopMeasuring = metrics?.pageGenerationDuration.startTimer();\n      log.debug(`Rendering canvas #${canvasIdx} into PDF`);\n      await pdfGen.renderPage(\n        canvasData.canvas.id,\n        { width: canvas.width, height: canvas.height },\n        [...images, ...imageFailures],\n        annotations,\n        text,\n        ppi\n      );\n      stopMeasuring?.();\n      progress.updatePixels(\n        images.reduce(\n          (acc, img) => acc + img.width * img.height,\n          0\n        ),\n        canvas.width * canvas.height\n      );\n      report.numPages++;\n    } catch (err) {\n      // Clear queue, cancel all ongoing image fetching\n      if (err !== 'Aborted') {\n        log.error('Failed to render page', err);\n      }\n      queue.clear();\n      if (!abortController.signal.aborted) {\n        abortController.abort();\n      }\n      throw err;\n    } finally {\n      delete canvasFuts[canvasIdx];\n    }\n    progress.emitProgress(canvasIdx + 1);\n  }\n\n  // Finish writing PDF, resulting Promise is resolved once the writer is closed\n  log.debug('Finalizing PDF');\n  const endPromise = pdfGen.end();\n\n  // At this point the PDF data might still be incomplete, so we wait for\n  // drain events on the writer and continue updating our progress tracker\n  // until the writer is actually closed\n  if (!abortController.signal.aborted) {\n    let closed = false;\n    endPromise.then(() => (closed = true));\n    const progressOnDrain = async () => {\n      if (closed) {\n        return;\n      }\n      progress.emitProgress(canvases.length, 'finishing');\n      while (!closed && progress.writeOutstanding) {\n        await writer.waitForDrain();\n      }\n    };\n\n    // Wait for initial drainage event in case the writer isn't already closed\n    if (!closed) {\n      await writer.waitForDrain();\n      await progressOnDrain();\n    }\n  }\n\n  // Wait for the writer to be closed\n  log.debug('Waiting for writer to close.');\n  await endPromise;\n\n  report.fileSizeBytes = countingWriter.bytesWritten;\n  if (writer instanceof BlobWriter) {\n    return {...report, data: writer.blob };\n  } else {\n    return report;\n  }\n}\n","/* eslint-disable no-new-wrappers */\n/* eslint-disable @typescript-eslint/no-non-null-assertion */\n\n/// PDF generation code\n// FIXME: This is currently one hell of a mess, learning about PDF and coming up\n// with good abstractions at the same time was too much of a challenge for me \nimport dedent from 'dedent-js';\nimport { Manifest } from '@iiif/presentation-3';\nimport { Manifest as ManifestV2 } from '@iiif/presentation-2';\nimport { OcrPage, OcrBlock, OcrParagraph, OcrLine, OcrWord } from 'ocr-parser';\n\nimport {\n  Metadata,\n  PdfObject,\n  PdfDictionary,\n  makeRef,\n  PdfArray,\n  PdfRef,\n  serialize,\n  PdfValue,\n  toUTF16BE,\n  StructTreeEntry,\n} from './common.js';\nimport { TocItem, textEncoder, randomData, tryDeflateStream } from './util.js';\nimport { ArrayReader, Writer } from '../io.js';\nimport { OcrPageWithMarkup } from '../ocr.js';\nimport PdfImage from './image.js';\nimport { PdfParser } from './parser.js';\nimport pdiiifVersion from '../version.js';\nimport log from '../log.js';\nimport {\n  CanvasImage,\n  ImageFetchFailure,\n  StartCanvasInfo,\n  isImageFetchFailure,\n} from '../download.js';\nimport { Annotation, CanvasInfo, getI18nValue } from '../iiif.js';\nimport {\n  buildCentralFileDirectory,\n  buildLocalZipHeader,\n  CentralDirectoryFileSpec,\n} from './pkzip.js';\nimport { crc32 } from '../util.js';\nimport { exportPdfAnnotation } from './annos.js';\n\nconst PRODUCER = `pdiiif v${pdiiifVersion}`;\n\n/// If the font is 10 pts, nominal character width is 5 pts\nconst CHAR_WIDTH = 2;\n\n/// Taken from tesseract@2d6f38eebf9a14d9fbe65d785f0d7bd898ff46cb, tessdata/pdf.ttf\n/// Created by Ken Sharp\n/// (C) Copyright 2011, Google Inc.\n/// Licensed under the Apache License, Version 2.0 (the \"License\");\n/// you may not use this file except in compliance with the License.\n/// You may obtain a copy of the License at http://www.apache.org/licenses/LICENSE-2.0\n/// Unless required by applicable law or agreed to in writing, software\n/// distributed under the License is distributed on an \"AS IS\" BASIS,\n/// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n/// See the License for the specific language governing permissions and\n/// limitations under the License.\nconst FONTDATA = new Uint8Array([\n  0, 1, 0, 0, 0, 10, 0, 128, 0, 3, 0, 32, 79, 83, 47, 50, 86, 222, 200, 148, 0,\n  0, 1, 40, 0, 0, 0, 96, 99, 109, 97, 112, 0, 10, 0, 52, 0, 0, 1, 144, 0, 0, 0,\n  30, 103, 108, 121, 102, 21, 34, 65, 36, 0, 0, 1, 184, 0, 0, 0, 24, 104, 101,\n  97, 100, 11, 120, 241, 101, 0, 0, 0, 172, 0, 0, 0, 54, 104, 104, 101, 97, 12,\n  2, 4, 2, 0, 0, 0, 228, 0, 0, 0, 36, 104, 109, 116, 120, 4, 0, 0, 0, 0, 0, 1,\n  136, 0, 0, 0, 8, 108, 111, 99, 97, 0, 12, 0, 0, 0, 0, 1, 176, 0, 0, 0, 6, 109,\n  97, 120, 112, 0, 4, 0, 5, 0, 0, 1, 8, 0, 0, 0, 32, 110, 97, 109, 101, 242,\n  235, 22, 218, 0, 0, 1, 208, 0, 0, 0, 75, 112, 111, 115, 116, 0, 1, 0, 1, 0, 0,\n  2, 28, 0, 0, 0, 32, 0, 1, 0, 0, 0, 1, 0, 0, 176, 148, 113, 16, 95, 15, 60,\n  245, 4, 7, 8, 0, 0, 0, 0, 0, 207, 154, 252, 110, 0, 0, 0, 0, 212, 195, 167,\n  242, 0, 0, 0, 0, 4, 0, 8, 0, 0, 0, 0, 16, 0, 2, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0,\n  8, 0, 255, 255, 0, 0, 4, 0, 0, 0, 0, 0, 4, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0,\n  0, 0, 0, 0, 0, 0, 2, 0, 1, 0, 0, 0, 2, 0, 4, 0, 1, 0, 0, 0, 0, 0, 1, 0, 0, 0,\n  0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 0, 0, 1, 144, 0, 5, 0, 0, 0, 0,\n  0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 0, 1, 0, 1, 0,\n  0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 71, 79, 79, 71, 0,\n  64, 0, 0, 0, 0, 0, 1, 255, 255, 0, 0, 0, 1, 0, 1, 128, 0, 0, 0, 0, 0, 0, 0, 0,\n  0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 4, 0, 0, 0, 0, 0, 0, 2, 0, 1, 0, 0, 0,\n  0, 0, 20, 0, 3, 0, 0, 0, 0, 0, 20, 0, 6, 0, 10, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,\n  0, 0, 0, 12, 0, 0, 0, 1, 0, 0, 0, 0, 4, 0, 8, 0, 0, 3, 0, 0, 49, 33, 17, 33,\n  4, 0, 252, 0, 8, 0, 0, 0, 0, 3, 0, 42, 0, 0, 0, 3, 0, 0, 0, 5, 0, 22, 0, 0, 0,\n  1, 0, 0, 0, 0, 0, 5, 0, 11, 0, 22, 0, 3, 0, 1, 4, 9, 0, 5, 0, 22, 0, 0, 0, 86,\n  0, 101, 0, 114, 0, 115, 0, 105, 0, 111, 0, 110, 0, 32, 0, 49, 0, 46, 0, 48,\n  86, 101, 114, 115, 105, 111, 110, 32, 49, 46, 48, 0, 0, 1, 0, 0, 0, 0, 0, 0,\n  0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,\n]);\n\ntype ZipDummyObjectSpec = {\n  filename: string;\n  data: Uint8Array;\n  deflatedData?: Uint8Array;\n  bytesUntilActualData: number;\n};\n\nexport type GeneratorParams = {\n  // Writer to output the PDF to\n  writer: Writer;\n  // Metadata to include in the PDF\n  metadata: Metadata;\n  // Information about canvases included in the PDF\n  canvasInfos: CanvasInfo[];\n  // List of languages to use for rendering labels, in descending order of preference\n  langPref: readonly string[];\n  // Labels for pages, every position corresponds to the canvas in the same position\n  pageLabels?: string[];\n  // Outline tree for the PDF\n  outline: TocItem[];\n  // Whether the PDF should include a hidden text layer\n  hasText?: boolean;\n  // Reading direction of the PDF\n  readingDirection?: 'right-to-left' | 'left-to-right';\n  // Information about the canvas (or canvas region) that should be displayed initially\n  initialCanvas?: StartCanvasInfo;\n  // The manifest to build the PDF from\n  manifestJson?: Manifest | ManifestV2;\n  // If this is enabled, the PDF will also be a valid ZIP archive of all the resources\n  // included in the PDF\n  zipPolyglot?: boolean;\n  // Base directory name for the polyglot ZIP archive, if not set the resources will be\n  // top-level in the archive\n  zipBaseDir?: string;\n};\n\nexport default class PDFGenerator {\n  // Keep track of how many bytes have been written so far\n  _offset = 0;\n  // PDF objects that are scheduled for writing, will be written on _flush()\n  _objects: Array<PdfObject> = [];\n  // Number of the next PDF object\n  _nextObjNo = 1;\n  // References to various central objects\n  _objRefs: Record<string, PdfRef> = {};\n  // Tracks offset of every XObject\n  _offsets: number[] = [];\n  // Writer used for outputting the PDF\n  _writer: Writer | undefined;\n  // Have we already started writing the IIIF pages?\n  _pagesStarted = false;\n  // Information about each canvas, needed for pre-allocating objects\n  _canvasInfos: Array<CanvasInfo> = [];\n  // Object number of the first page\n  _firstPageObjectNum: number | undefined;\n  // Labels for every page in the PDF\n  _pageLabels?: string[];\n  // Number of cover pages inserted at the beginning of the PDF\n  _numCoverPages = 0;\n  // PDF outline\n  _outline: TocItem[] = [];\n  // Is the PDF supposed to have a hidden text layer?\n  _hasText = false;\n  // List of top-level entries in the PDF's logical structure tree\n  _strucTree: StructTreeEntry[] = [];\n  // Maps a page's object number to the marked content sequence IDs its content\n  // stream has\n  _pageMCIds: Map<number, Array<number>> = new Map();\n  // Identifier of the next structure parent entry\n  _nextStructParentId = 0;\n  // For every page, its corresponding parent ID for the parent tree\n  _pageParentIds: Map<number, number> = new Map();\n  // Language preference\n  _langPref: readonly string[];\n  _initialCanvas?: StartCanvasInfo;\n  private _polyglot: boolean;\n  private _manifestJson?: Manifest | ManifestV2;\n  private _zipCatalog?: Array<CentralDirectoryFileSpec>;\n  private _zipBaseDir?: string;\n  private _readingDirection: 'right-to-left' | 'left-to-right';\n\n  constructor({\n    writer,\n    metadata,\n    canvasInfos,\n    langPref,\n    pageLabels,\n    outline = [],\n    readingDirection = 'left-to-right',\n    hasText = false,\n    initialCanvas,\n    manifestJson,\n    zipPolyglot = false,\n    zipBaseDir,\n  }: GeneratorParams) {\n    this._writer = writer;\n    this._canvasInfos = canvasInfos;\n    this._pageLabels = pageLabels;\n    this._outline = outline;\n    this._hasText = hasText;\n    this._readingDirection = readingDirection;\n    this._langPref = langPref;\n    this._initialCanvas = initialCanvas;\n    this._polyglot = zipPolyglot;\n    this._zipBaseDir = zipBaseDir;\n    this._manifestJson = manifestJson;\n\n    const pdfMetadata: PdfDictionary = {\n      ...Object.entries(metadata)\n        .filter((k, v) => v !== undefined)\n        .reduce((prev, [k, v]) => {\n          prev[k] = `(${v})`;\n          return prev;\n        }, {} as PdfDictionary),\n      Producer: `(${PRODUCER})`,\n    };\n    this._addObject(pdfMetadata, 'Info');\n  }\n\n  async setup(): Promise<void> {\n    const catalog: PdfDictionary = {\n      Type: '/Catalog',\n    };\n    this._addObject(catalog, 'Catalog');\n\n    const pagesObj = this._addObject(\n      {\n        Type: '/Pages',\n        Count: this._canvasInfos.length,\n      },\n      'Pages'\n    );\n    catalog.Pages = makeRef(pagesObj);\n\n    if (this._hasText) {\n      catalog.MarkInfo = {\n        Type: '/MarkInfo',\n        Marked: true,\n      };\n    }\n\n    if (this._outline.length > 0) {\n      catalog.PageMode = '/UseOutlines';\n      const outlines: PdfDictionary = {\n        Type: '/Outlines',\n        Count: 0,\n      };\n      const outlinesObj = this._addObject(outlines);\n      catalog.Outlines = makeRef(outlinesObj);\n      let prev: PdfObject | undefined;\n      for (const [idx, itm] of this._outline.entries()) {\n        const [childObj, numKids] = this._addOutline(itm, outlinesObj, prev);\n        (outlines.Count as number) += 1 + numKids;\n        if (idx === 0) {\n          outlines.First = makeRef(childObj);\n        } else if (idx === this._outline.length - 1) {\n          outlines.Last = makeRef(childObj);\n        }\n        prev = childObj;\n      }\n    } else {\n      catalog.PageMode = '/UseThumbs';\n    }\n    catalog.ViewerPreferences = {\n      Direction: this._readingDirection === 'right-to-left' ? '/R2L' : '/L2R',\n    };\n    if (this._hasText) {\n      await this._setupHiddenTextFont();\n    }\n  }\n\n  async _setupHiddenTextFont(): Promise<void> {\n    const typeZeroFont = this._addObject(\n      {\n        Type: '/Font',\n        Subtype: '/Type0',\n        BaseFont: '/GlyphLessFont',\n        Encoding: '/Identity-H',\n      },\n      'Type0Font'\n    );\n\n    const typeTwoFont = this._addObject({\n      type: '/Font',\n      Subtype: '/CIDFontType2',\n      BaseFont: '/GlyphLessFont',\n      DW: 1000 / CHAR_WIDTH,\n      CIDSystemInfo: {\n        Ordering: '(Identity)',\n        Registry: '(Adobe)',\n        Supplement: 0,\n      },\n    });\n    (typeZeroFont.data as PdfDictionary).DescendantFonts = [\n      makeRef(typeTwoFont),\n    ];\n\n    const cidtoGidMapData = new Uint8Array(128 * 1024);\n    for (let i = 0; i < cidtoGidMapData.length; i++) {\n      cidtoGidMapData[i] = i % 2 ? 1 : 0;\n    }\n    const comp = await tryDeflateStream(cidtoGidMapData);\n    const cidToGidMap = this._addObject(comp.dict, undefined, comp.stream);\n    (typeTwoFont.data as PdfDictionary).CIDToGIDMap = makeRef(cidToGidMap);\n\n    const cmapStream = dedent`\n      /CIDInit /ProcSet findresource begin\n        12 dict begin\n        begincmap\n            /CIDSystemInfo\n            <<\n              /Registry (Adobe)\n              /Ordering (UCS)\n              /Supplement 0\n            >> def\n            /CMapName /Adobe-Identify-UCS def\n            /CMapType 2 def\n            1 begincodespacerange\n            <0000> <FFFF>\n            endcodespacerange\n            1 beginbfrange\n            <0000> <FFFE> <0000>\n            endbfrange\n        endcmap\n        CMapName currentdict /CMap defineresource pop\n        end\n    end`;\n    const cmap = this._addObject(\n      {\n        Length: cmapStream.length,\n      },\n      undefined,\n      cmapStream\n    );\n    (typeZeroFont.data as PdfDictionary).ToUnicode = makeRef(cmap);\n\n    const fontDesc = this._addObject({\n      Type: '/FontDescriptor',\n      FontName: '/GlyphLessFont',\n      FontBBox: [0, 0, 1000 / CHAR_WIDTH, 1000],\n      Ascent: 1000,\n      CapHeight: 1000,\n      Descent: -1,\n      Flags: 5,\n      ItalicAngle: 0,\n      StemV: 80,\n    });\n    (typeTwoFont.data as PdfDictionary).FontDescriptor = makeRef(fontDesc);\n\n    const maybeCompressedFont = await tryDeflateStream(FONTDATA);\n    const fontDataObj = this._addObject(\n      {\n        Length1: FONTDATA.length,\n        ...maybeCompressedFont.dict,\n      },\n      undefined,\n      maybeCompressedFont.stream\n    );\n    (fontDesc.data as PdfDictionary).FontFile2 = makeRef(fontDataObj);\n  }\n\n  _registerEmbeddedFilesInCatalog() {\n    const catalog = this._objects[this._objRefs.Catalog.refObj]\n      .data as PdfDictionary;\n    const embeddedFiles: PdfArray = [\n      `(manifest.json)`,\n      makeRef(this._firstPageObjectNum! - (this._polyglot ? 3 : 2)),\n    ];\n    for (const [idx, canvas] of this._canvasInfos.entries()) {\n      if (!canvas.ocr) {\n        continue;\n      }\n      const pageObjNum = this.getCanvasObjectNumber(idx);\n      // The file spec for embedded OCR file is the previous to last XObject for a given canvas\n      let fileObjNum = pageObjNum + this.getObjectsPerCanvas(idx) - 2;\n      if (this._polyglot) {\n        // Except if the PDF is polyglot, then it's the second to last XObject\n        fileObjNum -= 1;\n      }\n      embeddedFiles.push(`(${canvas.ocr.id})`);\n      embeddedFiles.push(makeRef(fileObjNum));\n    }\n    if (!catalog.Names) {\n      catalog.Names = {\n        EmbeddedFiles: { Names: embeddedFiles },\n      };\n    } else {\n      const names = catalog.Names as PdfDictionary;\n      const nameTree = names.EmbeddedFiles as PdfDictionary;\n      nameTree.Names = (nameTree.Names as PdfArray).concat(embeddedFiles);\n    }\n  }\n\n  _addOutline(\n    itm: TocItem,\n    parent: PdfObject,\n    prev?: PdfObject\n  ): [PdfObject, number] {\n    let dest: PdfArray;\n    if (typeof itm.startCanvas === 'string') {\n      const destCanvasIdx = this._canvasInfos.findIndex(\n        (ci) => ci.canvas.id === itm.startCanvas\n      );\n      if (destCanvasIdx < 0) {\n        throw Error(\n          `Could not find canvas with id ${itm.startCanvas} in manifest!`\n        );\n      }\n      dest = [destCanvasIdx, '/Fit'];\n    } else {\n      const canvasId = itm.startCanvas.id;\n      const unitScale = 72 / itm.startCanvas.ppi;\n      const rect = itm.startCanvas.position;\n      const { width, height } = itm.startCanvas.dimensions;\n      const destCanvasIdx = this._canvasInfos.findIndex(\n        (ci) => ci.canvas.id === canvasId\n      );\n      if (destCanvasIdx < 0) {\n        throw Error(`Could not find canvas with id ${canvasId} in manifest!`);\n      }\n      dest = [\n        destCanvasIdx,\n        '/FitR',\n        // TODO: Thoroughly test that this is actually working!\n        unitScale * rect.x, // left\n        unitScale * rect.y, // bottom\n        unitScale * (width - (rect.x + rect.width)), // right,\n        unitScale * (height - (rect.y + rect.height)), // top,\n      ];\n    }\n    const rec: PdfDictionary = {\n      Title: `( ${itm.label} )`,\n      Parent: makeRef(parent),\n      // NOTE: The first entry is a number only during setup and will later be\n      //       replaced with a reference to the actual page object, once we know\n      //       how many objects are preceding the page objects.\n      Dest: dest,\n    };\n    const obj = this._addObject(rec);\n    if (prev) {\n      rec.Prev = makeRef(prev);\n      (prev.data as PdfDictionary).Next = makeRef(obj);\n    }\n    if (itm.children?.length) {\n      let prev: PdfObject | undefined;\n      rec.Count = 0;\n      for (const [idx, child] of itm.children.entries()) {\n        const [childObj, numChildren] = this._addOutline(child, obj, prev);\n        if (idx === 0) {\n          rec.First = makeRef(childObj);\n        } else if (idx === itm.children.length - 1) {\n          rec.Last = makeRef(childObj);\n        }\n        rec.Count = rec.Count + 1 + numChildren;\n        prev = childObj;\n      }\n    }\n    return [obj, (rec.Count as number) ?? 0];\n  }\n\n  _addObject(\n    val: PdfValue,\n    refName?: string,\n    stream?: Uint8Array | string\n  ): PdfObject {\n    const isObject = (x: unknown): x is object =>\n      typeof x === 'object' && x !== null;\n    if (stream) {\n      if (!isObject(val)) {\n        throw new Error(\n          'PDF Objects with a stream must have a dictionary as its value'\n        );\n      }\n      if (!(val as PdfDictionary).Length) {\n        (val as PdfDictionary).Length = stream.length;\n      }\n    }\n    const obj = {\n      num: this._nextObjNo,\n      data: val,\n      stream,\n    };\n    this._nextObjNo++;\n    this._objects[obj.num] = obj;\n    if (refName) {\n      this._objRefs[refName] = makeRef(obj);\n    }\n    return obj;\n  }\n\n  /** Clone an object from a foreign PDF into the current PDF, adjusting\n   *  the encountered indirect object references.\n   */\n  private async _transplantObject(\n    parser: PdfParser,\n    obj: PdfObject,\n    seenObjects: Record<number, PdfRef> = {}\n  ): Promise<PdfRef> {\n    const handleValue = async (value: PdfValue): Promise<PdfValue> => {\n      if (value instanceof PdfRef) {\n        const o = await parser.resolveRef(value);\n        if (o === undefined) {\n          throw `Could not resolve reference to object '${value.refObj}'`;\n        }\n        // Check if we've already transplanted the object\n        if (seenObjects[o.num]) {\n          return seenObjects[o.num];\n        }\n        const objDict = o.data as PdfDictionary;\n        const newObj = this._addObject(objDict, undefined, o.stream);\n        const ref = new PdfRef(newObj.num);\n        seenObjects[o.num] = ref;\n        newObj.data = await handleValue(objDict);\n        if (objDict.Type === '/Page') {\n          // Redirect to our own Pages object\n          (newObj.data as PdfDictionary).Parent = this._objRefs.Pages;\n        }\n        return ref;\n      } else if (typeof value === 'string' && value[0] != '/') {\n        return `(${value})`;\n      } else if (Array.isArray(value)) {\n        const out = [];\n        for (const val of value) {\n          out.push(await handleValue(val));\n        }\n        return out;\n      } else if (typeof value === 'object' && value !== null) {\n        const out: PdfDictionary = {};\n        for (const [key, val] of Object.entries(value)) {\n          // Ignore structure keys for now\n          if (key === 'StructParent' || key === 'StructParents') {\n            continue;\n          }\n          out[key] = await handleValue(val as PdfDictionary);\n        }\n        return out;\n      }\n      return value;\n    };\n    const ref = new PdfRef(obj.num);\n    // TODO: Special case: if the object is a page, we need to check for\n    //       a /StructParents key, check for the /StructTreeRoot key in\n    //       the catalog, and then transplant that to our _strucTree\n    //       and _pageMCIDs structures. Quite the handful!!\n    //\n    return (await handleValue(ref)) as PdfRef;\n  }\n\n  async insertCoverPages(pdfData: ArrayBuffer): Promise<void> {\n    if (this._pagesStarted) {\n      throw 'Cover pages must be inserted before writing the first regular page';\n    }\n    const reader = new ArrayReader(new Uint8Array(pdfData));\n    const parser = await PdfParser.parse(reader);\n    const pagesDict = this._objects[this._objRefs.Pages.refObj]\n      .data as PdfDictionary;\n    pagesDict.Kids = [];\n    // TODO: Parse and transplant the section and parent trees from\n    //       the catalog into our own structures.\n    for await (const page of parser.pages()) {\n      const dict = page.data as PdfDictionary;\n      // Ignore associated structured content for now\n      delete dict.StructParents;\n      delete dict.Parent;\n      const newPageRef = await this._transplantObject(parser, page);\n      (pagesDict.Kids as PdfArray).push(newPageRef);\n      (pagesDict.Count as number) += 1;\n      this._numCoverPages += 1;\n    }\n    return;\n  }\n\n  private async _embedResource(\n    id: string,\n    filename: string,\n    description: string,\n    mimeType: string,\n    data: string\n  ) {\n    // TODO: Add check that the file is actually pre-registered in\n    //       the catalog!\n    const fileSpec: PdfDictionary = {\n      Type: '/Filespec',\n      F: `(${filename})`,\n      UF: toUTF16BE(filename),\n      Desc: `(${description})`,\n      EF: {\n        F: makeRef(this._nextObjNo + (this._polyglot ? 2 : 1)),\n      },\n    };\n\n    const maybeCompressed = await tryDeflateStream(data);\n    const embeddedFile = {\n      Type: '/EmbeddedFile',\n      Subtype: `(${mimeType})`,\n      ...maybeCompressed.dict,\n    };\n\n    this._addObject(fileSpec);\n    if (this._polyglot) {\n      let zipData: Uint8Array;\n      if (typeof data === 'string') {\n        zipData = textEncoder.encode(data);\n      } else {\n        zipData = data;\n      }\n      const extraDataLength = this._getSerializedSize(\n        {\n          num: this._nextObjNo + 2,\n          data: { ...embeddedFile, ...maybeCompressed.dict },\n          stream: maybeCompressed.stream,\n        },\n        true\n      );\n      this._insertZipHeaderDummyObject({\n        filename,\n        data: zipData,\n        deflatedData: maybeCompressed.dict.Filter\n          ? (maybeCompressed.stream as Uint8Array)\n          : undefined,\n        // 2 bytes zlib header of deflated data\n        bytesUntilActualData: extraDataLength + 2,\n      });\n    }\n    this._addObject(embeddedFile, undefined, maybeCompressed.stream);\n  }\n\n  private async _embedManifest(\n    manifestJson: ManifestV2 | Manifest\n  ): Promise<void> {\n    let manifestMime = 'application/ld+json';\n    if (Array.isArray(manifestJson['@context'])) {\n      const manifestProfile = manifestJson['@context'].find((p) =>\n        p.startsWith('http://iiif.io/api/presentation')\n      );\n      if (manifestProfile) {\n        manifestMime += `;profile=\"${manifestProfile}\"`;\n      }\n    } else if (manifestJson['@context']) {\n      manifestMime += `;profile=\"${manifestJson['@context']}\"`;\n    }\n    await this._embedResource(\n      '@id' in manifestJson ? manifestJson['@id'] : manifestJson.id,\n      'manifest.json',\n      'IIIF Manifest this PDF is based on',\n      manifestMime,\n      JSON.stringify(manifestJson)\n    );\n  }\n\n  async finalizePdfHeader(): Promise<void> {\n    const catalog = this._objects[this._objRefs.Catalog.refObj]\n      .data as PdfDictionary;\n\n    // Create page tree with page labels\n    if (this._pageLabels) {\n      catalog.PageLabels = makeRef(\n        this._addObject({\n          Nums: this._pageLabels\n            .map((label, idx) =>\n              label\n                ? [idx + this._numCoverPages, { P: `( ${label} )` }]\n                : undefined\n            )\n            .filter((x) => x !== undefined)\n            .flat() as PdfArray,\n        })\n      );\n    }\n\n    const pagesObj = this._objects[this._objRefs.Pages.refObj];\n\n    // Now that we know from which object number the pages start, we can set the\n    // /Kids entry in the Pages object and update the outline destinations.\n    const pageDict = pagesObj.data as PdfDictionary;\n    if (!pageDict.Kids) {\n      pageDict.Kids = [];\n    }\n    this._firstPageObjectNum = this._nextObjNo;\n    if (this._manifestJson) {\n      this._firstPageObjectNum += 2;\n      if (this._polyglot) {\n        this._firstPageObjectNum++;\n      }\n    }\n    for (const [idx] of this._canvasInfos.entries()) {\n      (pageDict.Kids as PdfArray).push(\n        makeRef(this.getCanvasObjectNumber(idx))\n      );\n    }\n    this._objects\n      // Get ToC entry object, the first destination will be the canvas index\n      .filter((obj) => (obj.data as PdfDictionary)?.Dest !== undefined)\n      .forEach((obj: PdfObject) => {\n        const dest = (obj.data as PdfDictionary).Dest as PdfArray;\n        if (typeof dest[0] !== 'number') {\n          return;\n        }\n        dest[0] = makeRef(this.getCanvasObjectNumber(dest[0]));\n      });\n\n    // Register the structural content tree root\n    if (this._hasText) {\n      catalog.StructTreeRoot = makeRef(\n        this._nextObjNo + this.totalCanvasObjects\n      );\n    }\n\n    if (this._canvasInfos.some((ci) => ci.images.some((i) => i.choiceInfo))) {\n      // We're *very* explicit with the visibility of the various OCGs to\n      // ensure as broad a viewer support as possible (especially pdf.js\n      // needed it...)\n      const initiallyEnabledOCGs: PdfRef[] = [];\n      const initiallyDisabledOCGs: PdfRef[] = [];\n      const allOCGs: PdfRef[] = [];\n      const rbGroups: PdfRef[][] = [];\n      for (const [canvasIdx, { images }] of this._canvasInfos.entries()) {\n        const pageObjNum = this.getCanvasObjectNumber(canvasIdx);\n        let ocgStart = pageObjNum + 2 + images.length;\n        if (this._polyglot) {\n          // Take 'dummy' objects for ZIP polyglot into account\n          ocgStart += images.length;\n        }\n        let ocgIdx = 0;\n        const rbGroup = [];\n        for (const img of images) {\n          if (!img.choiceInfo) {\n            continue;\n          }\n          const ref = makeRef(ocgStart + ocgIdx);\n          if (img.choiceInfo.enabled) {\n            initiallyEnabledOCGs.push(ref);\n          } else {\n            initiallyDisabledOCGs.push(ref);\n          }\n          allOCGs.push(ref);\n          rbGroup.push(ref);\n          ocgIdx++;\n        }\n        rbGroups.push(rbGroup);\n      }\n      catalog.OCProperties = {\n        OCGs: allOCGs,\n        D: {\n          BaseState: '/OFF',\n          ON: initiallyEnabledOCGs,\n          OFF: initiallyDisabledOCGs,\n          RBGroups: rbGroups,\n        },\n      };\n    }\n\n    if (typeof this._initialCanvas === 'string') {\n      catalog.OpenAction = [\n        makeRef(\n          this.getCanvasObjectNumber(\n            this._canvasInfos.findIndex(\n              (ci) => ci.canvas.id === this._initialCanvas\n            )\n          )\n        ),\n      ];\n    } else if (this._initialCanvas) {\n      const unitScale = 72 / this._initialCanvas.ppi;\n      const rect = this._initialCanvas.position;\n      const { width, height } = this._initialCanvas.dimensions;\n      catalog.OpenAction = [\n        makeRef(\n          this.getCanvasObjectNumber(\n            this._canvasInfos.findIndex(\n              (ci) => ci.canvas.id === this._initialCanvas\n            )\n          )\n        ),\n        '/FitR',\n        // TODO: Thoroughly test that this is actually working!\n        unitScale * rect.x, // left\n        unitScale * rect.y, // bottom\n        unitScale * (width - (rect.x + rect.width)), // right,\n        unitScale * (height - (rect.y + rect.height)), // top,\n      ];\n    }\n\n    this._registerEmbeddedFilesInCatalog();\n\n    await this._flush();\n\n    if (this._manifestJson) {\n      await this._embedManifest(this._manifestJson);\n      await this._flush();\n    }\n  }\n\n  async renderPage(\n    canvasId: string,\n    {\n      width: canvasWidth,\n      height: canvasHeight,\n    }: { width: number; height: number },\n    images: (CanvasImage | ImageFetchFailure)[],\n    annotations: Annotation[],\n    ocrText?: OcrPageWithMarkup,\n    ppi = 300\n  ): Promise<void> {\n    if (!this._pagesStarted) {\n      log.debug('Initial page, finalizing PDF header structures.');\n      await this.finalizePdfHeader();\n      this._pagesStarted = true;\n    }\n    // Factor to multiply pixels by to get equivalent PDF units (72 pdf units === 1 inch)\n    const unitScale = 72 / ppi;\n    const pageDict: PdfDictionary = {\n      Type: '/Page',\n      Parent: this._objRefs.Pages,\n      MediaBox: [0, 0, unitScale * canvasWidth, unitScale * canvasHeight],\n      Resources: {\n        ProcSet: ['/PDF', '/Text', '/ImageB', '/ImageI', '/ImageC'],\n      },\n    };\n    if (this._hasText) {\n      pageDict.StructParents = this._nextStructParentId;\n      this._pageParentIds.set(this._nextObjNo, this._nextStructParentId);\n      this._nextStructParentId++;\n    }\n    if (ocrText && this._objRefs.Type0Font) {\n      (pageDict.Resources as PdfDictionary).Font = {\n        'f-0-0': this._objRefs.Type0Font,\n      };\n    }\n    const page = this._addObject(pageDict);\n\n    const contentOps: string[] = [];\n    const optionalGroupIds: { [imgId: string]: string } = {};\n    for (const [idx, image] of images.entries()) {\n      if (isImageFetchFailure(image)) {\n        continue;\n      }\n      const { x, y, width, height, choiceInfo } = image;\n      const drawWidth = unitScale * width;\n      const drawHeight = unitScale * height;\n      const drawX = unitScale * x;\n      const drawY = unitScale * (canvasHeight - height - y);\n      const imageId = `/Im${idx + 1}`;\n\n      if (choiceInfo?.optional) {\n        const ocId = `/oc${Object.keys(optionalGroupIds).length + 1}`;\n        optionalGroupIds[imageId] = ocId;\n        contentOps.push(`/OC ${ocId} BDC`);\n      }\n      contentOps.push(`q ${drawWidth} 0 0 ${drawHeight} ${drawX} ${drawY} cm`);\n      contentOps.push(`${imageId} Do`);\n      contentOps.push('Q');\n      if (choiceInfo?.optional) {\n        contentOps.push('EMC');\n      }\n    }\n    if (ocrText) {\n      contentOps.push(this._renderOcrText(ocrText, unitScale));\n    }\n    log.debug('Trying to compress content stream.');\n    const contentStreamComp = await tryDeflateStream(contentOps.join('\\n'));\n    const contentsObj = this._addObject(\n      contentStreamComp.dict,\n      undefined,\n      contentStreamComp.stream\n    );\n    (page.data as PdfDictionary).Contents = makeRef(contentsObj);\n\n    // Since we need the finalized page dictionary in order to determine\n    // the offset for the the local zip header, we pre-generate all the\n    // relevant information\n    const imageObjectNums = [...images.keys()].map((idx) => {\n      if (this._polyglot) {\n        return this._nextObjNo + idx * 2 + 1;\n      } else {\n        return this._nextObjNo + idx;\n      }\n    });\n    const optionalGroupObjectNums: { [imgId: string]: number } = {};\n    if (images.some((i) => i.choiceInfo?.optional)) {\n      for (const [idx, img] of images.entries()) {\n        if (isImageFetchFailure(img)) {\n          continue;\n        }\n        const imageId = `/Im${idx + 1}`;\n        if (!img.choiceInfo?.optional) {\n          continue;\n        }\n        // FIXME: This is broken for the layers example!\n        optionalGroupObjectNums[imageId] =\n          imageObjectNums.slice(-1)[0] + idx + 1;\n      }\n    }\n    const pageResources = (page.data as PdfDictionary)\n      .Resources as PdfDictionary;\n    const xObjects: PdfDictionary = {};\n    const properties: PdfDictionary = {};\n    for (const [idx, num] of imageObjectNums.entries()) {\n      if (isImageFetchFailure(images[idx])) {\n        continue;\n      }\n      const imageId = `/Im${idx + 1}`;\n      xObjects[imageId.substring(1)] = makeRef(num);\n      const ocgNum = optionalGroupObjectNums[imageId];\n      if (ocgNum !== undefined) {\n        const ocgId = optionalGroupIds[imageId];\n        properties[ocgId.substring(1)] = makeRef(ocgNum);\n      }\n    }\n    pageResources.XObject = xObjects;\n    if (Object.keys(properties).length > 0) {\n      pageResources.Properties = properties;\n    }\n\n    log.debug('Creating image objects.');\n    const canvasIdx = this._canvasInfos.findIndex(\n      (ci) => ci.canvas.id === canvasId\n    );\n    for (const [imgIdx, img] of images.entries()) {\n      if (isImageFetchFailure(img)) {\n        // Dummy image data object\n        this._addObject({});\n        if (this._polyglot) {\n          // Dummy dummy zip header object\n          this._addObject({});\n        }\n        continue;\n      }\n      const imageData = new Uint8Array(img.data!);\n      const image = PdfImage.open(imageData);\n      // TODO: Currently we only support JPEG, if we expand to other\n      //       file types we need to consider multiple objects pe rimage\n      const imageObj = image.toObjects(this._nextObjNo)[0];\n      if (this._polyglot) {\n        const imgPreambleSize = this._getSerializedSize(imageObj, true);\n        const filename = `img/canvas-${canvasIdx}-${imgIdx}.jpg`;\n        this._insertZipHeaderDummyObject({\n          filename,\n          data: imageData,\n          bytesUntilActualData: imgPreambleSize,\n        });\n        imageObj.num = this._nextObjNo;\n      }\n      this._nextObjNo += 1;\n      this._objects.push(imageObj);\n    }\n\n    if (images.some((i) => i?.choiceInfo?.optional)) {\n      log.debug('Creating optional content groups for page');\n      for (const [idx, img] of images.entries()) {\n        const imageId = `/Im${idx + 1}`;\n        if (!img?.choiceInfo) {\n          continue;\n        }\n        if (isImageFetchFailure(img)) {\n          // Dummy object to maintain precalculated object numbers\n          this._addObject({});\n          continue;\n        }\n        optionalGroupObjectNums[imageId] = this._nextObjNo;\n        this._addObject({\n          Type: '/OCG',\n          Name: img.choiceInfo.label\n            ? `(${getI18nValue(img.choiceInfo.label, this._langPref, '/')})`\n            : undefined,\n          Intent: '/View',\n          Usage: img.choiceInfo.visibleByDefault ? '/ON' : '/OFF',\n        } as PdfDictionary);\n      }\n    }\n\n    const canvasInfo = this._canvasInfos[canvasIdx];\n    if (ocrText?.markup) {\n      const canvasIdx = this._canvasInfos.findIndex(\n        (ci) => ci.canvas.id === canvasId\n      );\n      let filename = `ocr/canvas-${canvasIdx}`;\n      if (ocrText.mimeType.indexOf('html') >= 0) {\n        filename += '.html';\n      } else {\n        filename += '.xml';\n      }\n\n      await this._embedResource(\n        ocrText.id,\n        filename,\n        `OCR for canvas #${canvasIdx}`,\n        ocrText.mimeType,\n        ocrText.markup\n      );\n    } else if (canvasInfo.ocr) {\n      // Canvas Info says we have OCR, but none was passed, possible\n      // when he OCR doesn't have CORS or fetching failed for another reason\n      // Add two empty objects so object references are still valid\n      this._addObject({});\n      this._addObject({});\n      // Add one more if we have a polyglot PDF/ZIP\n      if (this._polyglot) {\n        this._addObject({});\n      }\n    }\n\n    // Add annotations, if present\n    if (annotations && annotations.length > 0) {\n      log.debug('Creating annotations for page');\n      pageDict.Annots = annotations\n        .flatMap((anno) => exportPdfAnnotation(anno, unitScale, canvasHeight))\n        .map((pdfAnno) => makeRef(this._addObject(pdfAnno)));\n    }\n\n    // Write out all of the objects\n    log.debug('Flushing data for page');\n    await this._flush();\n    log.debug('Finished rendering page');\n  }\n\n  /** Get PDF instructions to render a hidden text layer with the page's OCR.\n   *\n   * This owes *a lot* to Tesseract's PDF renderer[1] and the IA's `pdf-tools`[2]\n   * that ported it to Python. Accordingly, the license of this method is Apache 2.0.\n   *\n   * [1] https://github.com/tesseract-ocr/tesseract/blob/5.0.0-beta-20210916/src/api/pdfrenderer.cpp\n   * [2] https://github.com/internetarchive/archive-pdf-tools/blob/master/internetarchivepdf/pdfrenderer.py\n   *\n   *                            Apache License\n   *                     Version 2.0, January 2004\n   *                  http://www.apache.org/licenses/\n   */\n  _renderOcrText(ocr: OcrPageWithMarkup, unitScale: number): string {\n    // TODO: Handle changes in writing direction!\n    // TODO: Handle baselines, at least the simple ``cx+d` skewed-line-type, proper polyline support\n    //       requires a per-character transformation matrix, which is a bit much for the current\n    //       MVP-ish state\n    const pageHeight = ocr.height;\n    const ops: Array<string> = [];\n    ops.push('BT'); // Begin text rendering\n    ops.push('3 Tr'); // Use \"invisible ink\" (no fill, no stroke)\n    const pageObjNum = this._nextObjNo - 1;\n    let lineIdx = 0;\n    const entries: StructTreeEntry[] = [];\n    const handleChild = (\n      child: OcrPage | OcrBlock | OcrParagraph | OcrLine,\n      parent?: StructTreeEntry\n    ) => {\n      if (child.type === 'block') {\n        entries.push({\n          type: 'Sect',\n          children: [],\n          pageObjNum,\n          mcs: [],\n        });\n      } else if (child.type === 'paragraph') {\n        entries.push({\n          type: 'P',\n          children: [],\n          pageObjNum,\n          mcs: [],\n        });\n        if (parent) {\n          parent.children.push(entries.slice(-1)[0]);\n        }\n      } else if (child.type === 'line') {\n        ops.push(\n          ...this.renderOcrLine(\n            child,\n            lineIdx,\n            unitScale,\n            pageHeight,\n            pageObjNum\n          )\n        );\n        if (parent) {\n          parent.children.push({\n            type: 'Span',\n            children: [],\n            pageObjNum,\n            mcs: [lineIdx],\n          });\n        }\n        lineIdx++;\n        return;\n      }\n      for (const grandchild of child.children) {\n        handleChild(grandchild, entries.slice(-1)[0]);\n      }\n    };\n    handleChild(ocr);\n    this._strucTree.push(...entries);\n    ops.push('ET');\n    return ops.join('\\n');\n  }\n\n  renderOcrLine(\n    line: OcrLine,\n    lineIdx: number,\n    unitScale: number,\n    pageHeight: number,\n    pageObjNum: number\n  ): string[] {\n    const fontRef = '/f-0-0';\n    const scaleX = 1;\n    const scaleY = 1;\n    const shearX = 0;\n    const shearY = 0;\n    const ops: Array<string> = [];\n    // Begin of marked content sequence that wraps the line in a Span\n    ops.push(`/Span << /MCID ${lineIdx} >> BDC`);\n    // Approximated font size for western scripts, PDF font size is specified in multiples of\n    // 'user units', which default to 1/72inch. The `userScale` gives us the units per pixel.\n    const fontSize = line.height * unitScale * 0.75;\n    //const fontSize = 8; // TODO: This is what Tesseract uses, why does this work?\n    ops.push(`${fontRef} ${fontSize} Tf`);\n    // We use a text matrix for every line. Tesseract uses a per-paragraph matrix, but we don't\n    // neccesarily have block/paragraph information available, so we'll use the next-closest\n    // thing. This means that every word on the line is positioned relative to the line, not\n    // relative to the page as in the markup.\n    const xPos = line.x * unitScale;\n    const lineY = pageHeight - line.y - line.height * 0.75;\n    const yPos = lineY * unitScale;\n    ops.push(`${scaleX} ${shearX} ${shearY} ${scaleY} ${xPos} ${yPos} Tm`);\n    let xOld = 0;\n    let yOld = 0;\n    // TODO: What to do if non-word line content?\n    for (const word of line.words) {\n      if (!word.text) {\n        continue;\n      }\n      if (!word.width) {\n        continue;\n      }\n      // Position drawing with relative moveto\n      const wordX = (word.x - line.x) * unitScale;\n      // Convert beween different y-origins in OCR and PDF\n      const wordYAbsolute = pageHeight - word.y - word.height * 0.75;\n      const wordY = (wordYAbsolute - lineY) * unitScale;\n      const wordWidth = word.width * unitScale;\n      const wordHeight = word.height * unitScale;\n      const dx = wordX - xOld;\n      const dy = wordY - yOld;\n      ops.push(`${dx * scaleX + dy * shearX} ${dx * shearY + dy * scaleY} Td`);\n      xOld = wordX;\n      yOld = wordY;\n      // Calculate horizontal stretch\n      // TODO: This is ripped straight from Tesseract, I have no clue what it does\n      // FIXME: The end of the line seems to be too far to the left sometimes,\n      // while the start seems to match\n      const wordLength = Math.pow(\n        Math.pow(wordWidth, 2) + Math.pow(wordHeight, 2),\n        0.5\n      );\n      const pdfWordLen = word.text.length;\n      ops.push(\n        `${CHAR_WIDTH * ((100 * wordLength) / (fontSize * pdfWordLen))} Tz`\n      );\n      // TODO: Account for trailing space in width calculation to prevent readers\n      //       from inserting a line break\n      const textBytes = serialize(toUTF16BE(word.text + ' ', false));\n      ops.push(`[ ${textBytes} ] TJ`);\n    }\n    ops.push('EMC');\n    // Add a newline to visually group together all statements belonging to a line\n    ops.push('');\n    if (!this._pageMCIds.has(pageObjNum)) {\n      this._pageMCIds.set(pageObjNum, []);\n    }\n    this._pageMCIds.get(pageObjNum)!.push(lineIdx);\n    return ops;\n  }\n\n  get bytesWritten(): number {\n    return this._offset;\n  }\n\n  /** Number of objects needed to render all canvases */\n  get totalCanvasObjects(): number {\n    // Every canvas needs 1 object per image, 1 for the content stream and 1 for the page definition.\n    return this._canvasInfos.reduce(\n      (sum, _, idx) => sum + this.getCanvasObjectNumber(idx),\n      0\n    );\n  }\n\n  getObjectsPerCanvas(canvasIdx: number): number {\n    const { images, ocr, numAnnotations } = this._canvasInfos[canvasIdx];\n    let numObjects =\n      // 1 XObject per image\n      images.length +\n      // Page dictionary and content\n      2 +\n      // 1 Optional Content Group per optional image\n      images.filter((i) => i.choiceInfo !== undefined).length +\n      // 1 XObject per annotation\n      numAnnotations;\n    if (this._polyglot) {\n      // For a polyglot PDF, we need to precede every XObject that we'd like\n      // to expose as a file in the ZIP with a separate XObject that contains\n      // the local ZIP header for that file. Currently this concerns the\n      // images and the OCR data\n      numObjects = numObjects + images.length + (ocr ? 1 : 0);\n    }\n    if (ocr) {\n      numObjects += 2;\n    }\n    return numObjects;\n  }\n\n  getCanvasObjectNumber(canvasIdx: number): number {\n    let num = this._firstPageObjectNum!;\n    for (const [idx] of this._canvasInfos.entries()) {\n      if (idx === canvasIdx) {\n        return num;\n      }\n      num += this.getObjectsPerCanvas(idx);\n    }\n    throw new Error(`Canvas #${canvasIdx} not found.`);\n  }\n\n  async _flush(): Promise<void> {\n    if (this._offsets.length === 0) {\n      log.debug('Writing PDF header');\n      await this._write(`%PDF-1.5\\n%\\xde\\xad\\xbe\\xef\\n`);\n    }\n    for (const obj of this._objects) {\n      if (!obj) {\n        continue;\n      }\n      log.debug(`Serializing object #${obj.num}`);\n      await this._serializeObject(obj);\n    }\n    this._objects = [];\n  }\n\n  _getSerializedSize(\n    { num, data, stream }: PdfObject,\n    untilStreamStart = false\n  ): number {\n    let size = 0;\n    size += `${num} 0 obj\\n`.length;\n\n    if (data) {\n      size += serialize(data).length;\n    }\n    if (stream) {\n      size += '\\nstream\\n'.length;\n      if (untilStreamStart) {\n        return size;\n      }\n      if (typeof stream === 'string') {\n        size += textEncoder.encode(stream).byteLength;\n      } else {\n        size += stream.byteLength;\n      }\n      size += '\\nendstream'.length;\n    }\n    size += '\\nendobj\\n'.length;\n    return size;\n  }\n\n  async _serializeObject(obj: PdfObject): Promise<void> {\n    this._offsets.push(this._offset);\n    const { num, data, stream } = obj;\n    await this._write(`${num} 0 obj\\n`);\n    if (data) {\n      await this._write(serialize(data));\n    }\n    if (stream) {\n      await this._write('\\nstream\\n');\n      await this._write(stream);\n      await this._write('\\nendstream');\n    }\n    await this._write('\\nendobj\\n');\n  }\n\n  async _write(data: Uint8Array | string): Promise<void> {\n    if (this._writer === undefined) {\n      throw new Error(\n        'Cannot perform mutating operations on an already closed PDFGenerator.'\n      );\n    }\n    if (typeof data === 'string') {\n      data = textEncoder.encode(data);\n    }\n    this._offset += data.byteLength;\n    await this._writer.write(data);\n  }\n\n  async _writeStructureTree(): Promise<void> {\n    const parentRoot: PdfDictionary = {\n      Nums: [],\n    };\n    const parentRootRef = makeRef(this._addObject(parentRoot));\n    const root: PdfDictionary = {\n      Type: '/StructTreeRoot',\n      K: [],\n      ParentTree: parentRootRef,\n      ParentTreeNextKey: this._nextStructParentId,\n    };\n    const pageParents: Map<number, Array<PdfRef>> = new Map();\n    const rootRef = makeRef(this._addObject(root));\n    const visitEntry = async (\n      entry: StructTreeEntry,\n      parent: PdfDictionary,\n      parentRef: PdfRef\n    ): Promise<void> => {\n      const obj: PdfDictionary = {\n        Type: '/StructElem',\n        S: `/${entry.type}`,\n        P: parentRef,\n        Pg: makeRef(entry.pageObjNum),\n        K: [],\n      };\n      if (!pageParents.has(entry.pageObjNum)) {\n        pageParents.set(entry.pageObjNum, []);\n      }\n      const objRef = makeRef(this._addObject(obj));\n      (parent.K as PdfRef[]).push(objRef);\n      if (entry.children.length > 0) {\n        for (const i of entry.children) {\n          await visitEntry(i, obj, objRef);\n        }\n      } else if (entry.mcs.length == 1) {\n        obj.K = entry.mcs[0];\n      } else if (entry.mcs.length > 0) {\n        obj.K = entry.mcs;\n      }\n      if (entry.mcs.length > 0) {\n        const parents = pageParents.get(entry.pageObjNum)!;\n        for (const mcId of entry.mcs) {\n          parents[mcId] = objRef;\n        }\n      }\n      if (this._objects.length > 1000) {\n        await this._flush();\n      }\n    };\n    for (const i of this._strucTree) {\n      await visitEntry(i, root, rootRef);\n    }\n    for (const [pageObjNum, parents] of pageParents) {\n      const pidx = this._pageParentIds.get(pageObjNum)!;\n      (parentRoot.Nums as PdfArray).push(\n        pidx,\n        makeRef(this._addObject(parents))\n      );\n    }\n    await this._flush();\n  }\n\n  async end(): Promise<void> {\n    if (!this._writer) {\n      return;\n    }\n    /* FIXME: Disabled due to poor performance on large volumes and a strange\n     *        interaction with streamsaver, where the PDF would be prematurely\n     *        closed in the middle of writing out the structure tree.\n    console.debug(\"Writing structure tree\");\n    if (this._strucTree.length > 0) {\n      await this._writeStructureTree();\n    }\n    */\n    log.debug('Writing xref table');\n    type XrefEntry = [number, number, 'f' | 'n'];\n    const xrefEntries: Array<XrefEntry> = [\n      [0, 65535, 'f'],\n      ...this._offsets.map((offset): XrefEntry => [offset, 0, 'n']),\n    ];\n    const xRefTable = xrefEntries\n      .map(([off, gen, free]) =>\n        [\n          off.toString(10).padStart(10, '0'),\n          gen.toString(10).padStart(5, '0'),\n          free,\n          '',\n        ].join(' ')\n      )\n      .join('\\n');\n    const xrefOffset = this._offset;\n    await this._write(`xref\\n0 ${xrefEntries.length}\\n${xRefTable}\\n`);\n    const trailerDict: PdfDictionary = {\n      Size: xrefEntries.length,\n      Root: this._objRefs.Catalog,\n      Info: this._objRefs.Info,\n      ID: [randomData(32), randomData(32)],\n    };\n    await this._write(`\\ntrailer\\n${serialize(trailerDict)}`);\n    const trailer = `startxref\\n${xrefOffset}\\n%%EOF`;\n    if (this._polyglot && this._zipCatalog) {\n      log.debug('Writing zip end of central directory');\n      await this._write('9990 0 obj\\n<<>>\\nstream\\n');\n      const endObj = '\\nendstream\\nendobj\\n';\n      await this._write(\n        buildCentralFileDirectory({\n          files: this._zipCatalog,\n          trailingLength: trailer.length + endObj.length,\n          offset: this._offset,\n        })\n      );\n      await this._write(endObj);\n    }\n    await this._flush();\n    log.debug('Writing trailer');\n    await this._write(trailer);\n    log.debug('Flushing');\n    await this._flush();\n    // FIXME: Never resolves on Node.js, is it really\n    // needed in browsers?\n    //log.debug('Waiting for drainage');\n    //await this._writer.waitForDrain();\n    log.debug('PDF finished, closing writer');\n    await this._writer.close();\n    log.debug('Writer closed');\n    this._writer = undefined;\n  }\n\n  private _insertZipHeaderDummyObject({\n    filename,\n    data,\n    deflatedData,\n    bytesUntilActualData,\n  }: ZipDummyObjectSpec): void {\n    if (this._zipBaseDir) {\n      filename = `${this._zipBaseDir}/${filename}`;\n    }\n    const zipObjOffset =\n      this._offset +\n      this._objects.reduce((acc, obj) => acc + this._getSerializedSize(obj), 0);\n    const creationDate = new Date();\n    bytesUntilActualData += '\\nendstream\\nendobj\\n'.length;\n    const zipObj = this._addObject(\n      {},\n      undefined,\n      buildLocalZipHeader({\n        filename,\n        data,\n        compressedData: deflatedData,\n        extraDataLength: bytesUntilActualData,\n        creationDate,\n      })\n    );\n    const localHeaderOffset =\n      zipObjOffset + this._getSerializedSize(zipObj, true);\n    if (!this._zipCatalog) {\n      this._zipCatalog = [];\n    }\n    this._zipCatalog.push({\n      localHeaderOffset,\n      deflated: deflatedData?.length !== data.length,\n      creationDate: new Date(),\n      crc32: crc32(data),\n      dataLength: data.length,\n      // skip 2 bytes for zlib header\n      compressedDataLength: deflatedData\n        ? deflatedData.length - 2\n        : data.length,\n      filename,\n    });\n  }\n}\n","import util from 'util';\nimport zlib from 'zlib';\nimport { zlibSync } from 'fflate';\nimport nodeCrypto from 'crypto';\n\nimport { StartCanvasInfo } from '../download.js';\nimport { PdfDictionary } from './common.js';\nimport log from '../log.js';\nimport { runningInNode } from '../util.js';\n\n// Browsers have native encoders/decoders in the global namespace, use these\nexport let textEncoder: TextEncoder | util.TextEncoder;\nexport let textDecoder: TextDecoder | util.TextDecoder;\nif (typeof TextEncoder !== 'undefined' && typeof TextDecoder !== 'undefined') {\n  textEncoder = new TextEncoder();\n  textDecoder = new TextDecoder();\n} else {\n  textEncoder = new util.TextEncoder();\n  textDecoder = new util.TextDecoder();\n}\n\n// If running in node, use the web compatible crypto implementation\nlet cryptoImpl: Crypto;\nif (runningInNode()) {\n  cryptoImpl = nodeCrypto.webcrypto as Crypto;\n} else {\n  cryptoImpl = crypto;\n}\n\nexport const IS_BIG_ENDIAN = (() => {\n  const array = new Uint8Array(4);\n  const view = new Uint32Array(array.buffer);\n  return !((view[0] = 1) & array[0]);\n})();\n\nexport interface TocItem {\n  label: string;\n  children?: Array<TocItem>;\n  startCanvas: StartCanvasInfo;\n}\n\nexport function getNumChildren(itm: TocItem): number {\n  const children = itm.children ?? [];\n  return (\n    children.length + children.map(getNumChildren).reduce((a, b) => a + b, 0)\n  );\n}\n\nexport function randomData(length: number): Uint8Array {\n  if (length > 2 ** 16) {\n    length = 2 ** 16;\n  }\n  const buf = new Uint8Array(length);\n  if (cryptoImpl !== undefined) {\n    cryptoImpl.getRandomValues(buf);\n  } else {\n    const u32View = new Uint32Array(buf.buffer);\n    for (let i = 0; i < u32View.length; i++) {\n      u32View[i] = Math.floor(Math.random() * 2 ** 32);\n    }\n  }\n  return buf;\n}\n\nexport async function tryDeflateStream(\n  pdfStream: Uint8Array | string\n): Promise<{ stream: Uint8Array | string; dict: PdfDictionary }> {\n  const data =\n    pdfStream instanceof Uint8Array ? pdfStream : textEncoder.encode(pdfStream);\n  let compressed: Uint8Array;\n  if (!runningInNode()) {\n    if (typeof CompressionStream === 'undefined') {\n      // Browser doesn't support CompressionStream API, try to use the JS implementation\n      try {\n        let bytes: Uint8Array;\n        if (pdfStream instanceof Uint8Array) {\n          bytes = pdfStream;\n        } else {\n          bytes = textEncoder.encode(pdfStream);\n        }\n        compressed = zlibSync(bytes);\n        return Promise.resolve({\n          stream: compressed,\n          dict: { Length: compressed.length, Filter: '/FlateDecode' },\n        });\n      } catch (err) {\n        log.warn(\n          `Failed to use JS deflate implementation, data will be written uncompressed: ${err}`\n        );\n        return Promise.resolve({\n          stream: pdfStream,\n          dict: { Length: pdfStream.length },\n        });\n      }\n    }\n    const compStream = new CompressionStream('deflate');\n    const c = new Blob([data]).stream().pipeThrough(compStream);\n    compressed = new Uint8Array(await new Response(c).arrayBuffer());\n  } else {\n    compressed = await new Promise((resolve, reject) =>\n      zlib.deflate(data, (err, buf) => (err ? reject(err) : resolve(buf)))\n    );\n  }\n  return {\n    dict: {\n      Length: compressed.length,\n      Filter: '/FlateDecode',\n    },\n    stream: compressed,\n  };\n}\n","import { IS_BIG_ENDIAN } from './util.js';\n\nconst PDF_INDENTATION = 2;\n\nexport interface Metadata {\n  Producer?: string;\n  Creator?: string;\n  CreationDate?: Date;\n  Title?: string;\n  Author?: string;\n  Keywords?: string;\n  ModDate?: Date;\n}\n\nexport interface PdfObject {\n  num: number;\n  data?: PdfValue;\n  stream?: Uint8Array | string;\n}\n\nexport class PdfRef {\n  refObj: number;\n\n  constructor(num: number) {\n    this.refObj = num;\n  }\n}\nexport type PdfPrimitive =\n  | string\n  | number\n  | boolean\n  | Uint8Array\n  | null\n  | Date\n  | PdfRef;\nexport interface PdfDictionary {\n  [member: string]: PdfPrimitive | PdfArray | PdfDictionary;\n}\nexport type PdfArray = Array<PdfPrimitive | PdfArray | PdfDictionary>;\nexport type PdfValue = PdfPrimitive | PdfDictionary | PdfArray | null;\n\nexport interface PdfAnnotation {\n  Type: 'Annot';\n  Subtype: string;\n  Rect: [number, number, number, number];\n  Contents: string | undefined;\n  P?: PdfRef;\n  NM?: string;\n  M?: Date;\n  F?: number;\n  AP?: PdfDictionary;\n  AS?: string;\n  Border?: [number, number, number] | [number, number, number, number];\n  C?:\n    | []\n    | [number]\n    | [number, number, number]\n    | [number, number, number, number];\n}\n\nexport interface StructTreeEntry {\n  type: 'Sect' | 'P' | 'Span';\n  children: Array<StructTreeEntry>; // Only for `Sect` and `P` entries\n  pageObjNum: number;\n  mcs: Array<number>; // Only for `Span` entries\n}\n\nexport function makeRef(target: number | PdfObject): PdfRef {\n  const num = typeof target === 'number' ? target : target.num;\n  return new PdfRef(num);\n}\n\nfunction isUnicode(str: string): boolean {\n  for (let i = 0, end = str.length; i < end; i++) {\n    if (str.charCodeAt(i) > 0x7f) {\n      return true;\n    }\n  }\n  return false;\n}\n\n/** Convert a JS UTF8 string to a UTF16 Big Endian string */\nexport function toUTF16BE(str: string, includeBom = true): Uint8Array {\n  const buf = new Uint16Array(str.length + (includeBom ? 1 : 0));\n  for (let i = includeBom ? 1 : 0; i < buf.length; i++) {\n    buf[i] = str.charCodeAt(i - (includeBom ? 1 : 0));\n  }\n  const outBuf = new Uint8Array(buf.buffer, buf.byteOffset, buf.byteLength);\n  if (!IS_BIG_ENDIAN) {\n    // PDF needs UTF16-BE, so in little endian systems we need to swap each\n    // codepoint's byte pair\n    for (let i = includeBom ? 2 : 0, end = outBuf.length - 1; i < end; i += 2) {\n      const a = outBuf[i];\n      outBuf[i] = outBuf[i + 1];\n      outBuf[i + 1] = a;\n    }\n  }\n  // UTF16BE BOM\n  if (includeBom) {\n    outBuf[0] = 254;\n    outBuf[1] = 255;\n  }\n  return outBuf;\n}\n\nfunction safeNumber(num: number): number {\n  if (num > -1e21 && num < 1e21) {\n    return Math.round(num * 1e6) / 1e6;\n  }\n  throw new Error(`unsupported number: ${num}`);\n}\n\nexport function serialize(value: PdfValue, dictIndent = 0): string {\n  if (typeof value === 'string') {\n    if (\n      value[0] === '(' &&\n      value[value.length - 1] === ')' &&\n      isUnicode(value)\n    ) {\n      return serialize(toUTF16BE(value.substring(1, value.length - 1)));\n    }\n    return value;\n  } else if (value instanceof Uint8Array) {\n    return `<${Array.from(value)\n      .map((x) => x.toString(16).padStart(2, '0').toUpperCase())\n      .join('')}>`;\n  } else if (value instanceof Date) {\n    const dateString =\n      `D:${value.getUTCFullYear().toString(10).padStart(4, '0')}` +\n      (value.getUTCMonth() + 1).toString(10).padStart(2, '0') +\n      value.getUTCDate().toString(10).padStart(2, '0') +\n      value.getUTCHours().toString(10).padStart(2, '0') +\n      value.getUTCMinutes().toString(10).padStart(2, '0') +\n      value.getUTCSeconds().toString(10).padStart(2, '0') +\n      'Z';\n    return `(${dateString})`;\n  } else if (Array.isArray(value)) {\n    return `[${value.map((v) => serialize(v, dictIndent + 1)).join(' ')}]`;\n  } else if (value instanceof PdfRef) {\n    return `${value.refObj} 0 R`;\n  } else if ({}.toString.call(value) === '[object Object]') {\n    const outsideIndent = ' '.repeat(PDF_INDENTATION * dictIndent);\n    const insideIndent = outsideIndent + ' '.repeat(PDF_INDENTATION);\n    return `<<\\n${Object.entries(value as any)\n      .map(\n        ([k, v]) =>\n          `${insideIndent}/${k} ${serialize(v as any, dictIndent + 1)}`\n      )\n      .join('\\n')}\\n${outsideIndent}>>`;\n  } else if (typeof value === 'number') {\n    return safeNumber(value).toString(10);\n  } else {\n    return `${value}`;\n  }\n}\n","/** Types for writing to an output stream, with support for Node and Browsers. */\nimport type { Writable as NodeWritable } from 'stream';\nimport type nodeFs from 'fs';\n\nimport log from './log.js';\n\n/** Base interface to be implemented by all readers.  */\nexport interface Reader {\n  read(\n    dst: Uint8Array,\n    offset: number,\n    position: number,\n    length: number\n  ): Promise<number>;\n  size(): Promise<number>;\n}\n\n/** Base interface to be implemented by all writers. */\nexport interface Writer {\n  /** Write a chunk to the writer */\n  write(buffer: Uint8Array | string): Promise<void>;\n\n  /** Close the writer */\n  close(): Promise<void>;\n\n  /** Wait for the next drainage/flush event */\n  waitForDrain(): Promise<void>;\n}\n\n/** Reader implementation using the Web `File` API.  */\nexport class WebReader implements Reader {\n  private file: File;\n\n  constructor(file: File) {\n    this.file = file;\n  }\n\n  async read(\n    dst: Uint8Array,\n    offset: number,\n    position: number,\n    length: number\n  ): Promise<number> {\n    const blob = this.file.slice(position, position + length);\n    const buf = await blob.arrayBuffer();\n    dst.set(new Uint8Array(buf), offset);\n    return buf.byteLength;\n  }\n\n  size(): Promise<number> {\n    return new Promise((resolve) => resolve(this.file.size));\n  }\n}\n\n/** Wraps a writer and counts the bytes written to it. */\nexport class CountingWriter implements Writer {\n  private _writer: Writer;\n  bytesWritten = 0;\n\n  constructor(writer: Writer) {\n    this._writer = writer;\n  }\n\n  write(buffer: string | Uint8Array): Promise<void> {\n    this.bytesWritten += buffer.length;\n    return this._writer.write(buffer);\n  }\n\n  close(): Promise<void> {\n    return this._writer.close();\n  }\n\n  waitForDrain(): Promise<void> {\n    return this._writer.waitForDrain();\n  }\n}\n\n/** A Writer implemented using the `File System Access API` available in\n *  recent Chrome, Edge and Opera browsers. */\nexport class WebWriter implements Writer {\n  private _writer: WritableStreamDefaultWriter<any>;\n\n  constructor(stream: WritableStream) {\n    this._writer = stream.getWriter();\n  }\n\n  write(buffer: string | Uint8Array): Promise<void> {\n    return this._writer.write(buffer);\n  }\n\n  waitForDrain(): Promise<void> {\n    return this._writer.ready;\n  }\n\n  close(): Promise<void> {\n    return this._writer.close();\n  }\n}\n\n\n/** Writer implementation using the `Blob` API available in all browsers. */\nexport class BlobWriter implements Writer {\n  // TODO: A good reference seems to be the mega.nz implementation, which has always worked great for me on desktops at least:\n  // https://github.com/meganz/webclient/blob/f19289127b68ceaf19a5e884f2f48f15078304da/js/transfers/meths/memory.js\n  private _parts: Array<Uint8Array | string>;\n  private _blob?: Blob;\n\n  constructor() {\n    this._parts = [];\n  }\n\n  write(buffer: string | Uint8Array): Promise<void> {\n    if (this._blob) {\n      return Promise.reject('Cannot write to closed BlobWriter.');\n    }\n    this._parts.push(buffer);\n    return Promise.resolve();\n  }\n\n  waitForDrain(): Promise<void> {\n    if (this._blob) {\n      return Promise.reject('Cannot wait on a closed BlobWriter.');\n    }\n    return Promise.resolve();\n  }\n\n  close(): Promise<void> {\n    if (this._blob) {\n      return Promise.reject('BlobWriter is already closed');\n    }\n    this._blob = new Blob(this._parts);\n    this._parts = [];\n    return Promise.resolve();\n  }\n\n  get blob(): Blob {\n    if (!this._blob) {\n      throw 'BlobWriter must be closed first!';\n    }\n    return this._blob;\n  }\n}\n\n/** Reader implentation using the node.js filesystem API. */\nexport class NodeReader implements Reader {\n  private fileHandle: nodeFs.promises.FileHandle;\n\n  constructor(handle: nodeFs.promises.FileHandle) {\n    this.fileHandle = handle;\n  }\n\n  async read(\n    dst: Uint8Array,\n    offset: number,\n    position: number,\n    length: number\n  ): Promise<number> {\n    const { bytesRead } = await this.fileHandle.read(\n      dst,\n      offset,\n      length,\n      position\n    );\n    return bytesRead;\n  }\n\n  async size(): Promise<number> {\n    const stat = await this.fileHandle.stat();\n    return stat.size;\n  }\n}\n/** Writer implementation using the node.js filesystem API. */\nexport class NodeWriter implements Writer {\n  _writable: NodeWritable;\n  _drainWaiters: Array<() => void> = [];\n\n  constructor(writable: NodeWritable) {\n    this._writable = writable;\n    this._writable.on('drain', () => {\n      log.debug('Drained writer.');\n      for (const waiter of this._drainWaiters) {\n        waiter();\n      }\n      this._drainWaiters = [];\n    });\n    this._writable.on('close', () => {\n      for (const waiter of this._drainWaiters) {\n        waiter();\n      }\n      this._drainWaiters = [];\n    });\n  }\n\n  async write(buffer: string | Uint8Array): Promise<void> {\n    let waitForDrain = false;\n    const out = new Promise<void>((resolve, reject) => {\n      if (!this._writable.writable) {\n        reject('Cannot write to closed NodeWriter.');\n      }\n      waitForDrain = !this._writable.write(buffer, (err) =>\n        err ? reject(err) : resolve()\n      );\n    });\n    if (waitForDrain) {\n      log.debug('Waiting for writer to drain');\n      return await this.waitForDrain();\n    } else {\n      return await out;\n    }\n  }\n\n  waitForDrain(): Promise<void> {\n    return new Promise((resolve) => this._drainWaiters.push(resolve));\n  }\n\n  close(): Promise<void> {\n    return new Promise((resolve) => this._writable.end(() => resolve()));\n  }\n}\n\n/** Very basic Reader implementation using an Array. */\nexport class ArrayReader implements Reader {\n  _buf: Uint8Array;\n\n  constructor(buf: Uint8Array) {\n    this._buf = buf;\n  }\n\n  read(\n    dst: Uint8Array,\n    offset: number,\n    position: number,\n    length: number\n  ): Promise<number> {\n    const sub = this._buf.subarray(position, position + length);\n    dst.set(sub, offset);\n    return Promise.resolve(sub.length);\n  }\n\n  size(): Promise<number> {\n    return Promise.resolve(this._buf.length);\n  }\n}\n","/* Based on the `images` modules in `pdfkit` by Devon Govett, licensed under MIT.\n *\n * Ported to TypeScript and modified to better fit a web use case, by using  Uint8Array\n * instead of Buffer.\n *\n * https://github.com/foliojs/pdfkit/blob/master/lib/image/jpeg.js\n *\n * MIT LICENSE\n * Copyright (c) 2011 Devon Govett\n *\n * Permission is hereby granted, free of charge, to any person obtaining a copy of this\n * software and associated documentation files (the \"Software\"), to deal in the Software\n * without restriction, including without limitation the rights to use, copy, modify, merge,\n * publish, distribute, sublicense, and/or sell copies of the Software, and to permit persons\n * to whom the Software is furnished to do so, subject to the following conditions:\n *\n * The above copyright notice and this permission notice shall be included in all copies or\n * substantial portions of the Software.\n *\n * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING\n * BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND\n * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM,\n * DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.\n */\nimport { PdfDictionary, serialize, PdfObject } from './common.js';\nimport { IS_BIG_ENDIAN } from './util.js';\n\nfunction readUint16BE(buf: Uint8Array, pos = 0): number {\n  const val = new Uint16Array(buf.slice(pos, pos + 2).buffer)[0];\n  if (IS_BIG_ENDIAN) {\n    return val;\n  } else {\n    // system is little endian, swap bytes in value from buffer\n    return ((val & 0xff) << 8) | ((val >> 8) & 0xff);\n  }\n}\n\nabstract class PdfImage {\n  static open(data: Uint8Array): PdfImage {\n    if (data[0] === 0xff && data[1] === 0xd8) {\n      return new JPEGImage(data);\n    } else {\n      throw new Error('Unknown image format.');\n    }\n  }\n\n  abstract toObjects(\n    startNum: number,\n    isOptional?: boolean,\n    optionalTitle?: string,\n    optionalDefaultState?: boolean\n  ): Array<PdfObject>;\n}\n\nclass JPEGImage extends PdfImage {\n  static MARKERS = [\n    0xffc0, 0xffc1, 0xffc2, 0xffc3, 0xffc5, 0xffc6, 0xffc7, 0xffc8, 0xffc9,\n    0xffca, 0xffcb, 0xffcc, 0xffcd, 0xffce, 0xffcf,\n  ];\n  static COLOR_SPACE_MAP = {\n    1: 'DeviceGray',\n    3: 'DeviceRGB',\n    4: 'DeviceCMYK',\n  };\n  data: Uint8Array;\n\n  bits: number;\n  width: number;\n  height: number;\n  colorSpace: string;\n\n  constructor(data: Uint8Array) {\n    super();\n    let marker;\n    this.data = data;\n    if (readUint16BE(this.data, 0) !== 0xffd8) {\n      throw 'SOI not found in JPEG';\n    }\n\n    let pos = 2;\n    while (pos < this.data.length) {\n      marker = readUint16BE(this.data, pos);\n      pos += 2;\n      if (JPEGImage.MARKERS.includes(marker)) {\n        break;\n      }\n      pos += readUint16BE(this.data, pos);\n    }\n\n    if (!marker || !JPEGImage.MARKERS.includes(marker)) {\n      throw 'Invalid JPEG.';\n    }\n    pos += 2;\n\n    this.bits = this.data[pos++];\n    this.height = readUint16BE(this.data, pos);\n    pos += 2;\n\n    this.width = readUint16BE(this.data, pos);\n    pos += 2;\n\n    const channels = this.data[pos++];\n    if ([1, 3, 4].indexOf(channels) < 0) {\n      throw 'Bad number of channels, only 1, 3 or 4 are supported';\n    }\n    this.colorSpace = JPEGImage.COLOR_SPACE_MAP[channels as 1 | 3 | 4];\n  }\n\n  toObjects(startNum: number): Array<PdfObject> {\n    const obj: PdfDictionary = {\n      Type: '/XObject',\n      Subtype: '/Image',\n      BitsPerComponent: this.bits,\n      Width: this.width,\n      Height: this.height,\n      ColorSpace: `/${this.colorSpace}`,\n      Filter: '/DCTDecode',\n      Length: this.data.length,\n    };\n\n    // add extra decode params for CMYK images. By swapping the\n    // min and max values from the default, we invert the colors. See\n    // section 4.8.4 of the spec.\n    if (this.colorSpace === 'DeviceCMYK') {\n      obj.Decode = [1.0, 0.0, 1.0, 0.0, 1.0, 0.0, 1.0, 0.0];\n    }\n    return [{ num: startNum, data: serialize(obj), stream: this.data }];\n  }\n}\n\nexport default PdfImage;\n","import { Reader } from '../io.js';\nimport { PdfObject, PdfValue, PdfDictionary, PdfRef } from './common.js';\nimport { textDecoder, textEncoder } from './util.js';\n\n// Polyfill Uint8Array.findLastIndex for older browsers\nif (!Uint8Array.prototype.findLastIndex) {\n  Uint8Array.prototype.findLastIndex = function (\n    predicate: (value: number, index: number, obj: Uint8Array) => boolean\n  ): number {\n    let l = this.length;\n    while (l--) {\n      if (predicate(this[l], l, this)) return l;\n    }\n    return -1;\n  };\n}\n\nconst ESCAPE_CHARS: Record<string, string> = {\n  n: '\\n',\n  r: '\\r',\n  t: '\\t',\n  b: '\\b',\n  f: '\\f',\n  '(': '(',\n  ')': ')',\n  '\\\\': '\\\\',\n};\n\n//          offset/nextFree|generation|inUse?\n//                                     \ntype CrossRefEntry = [number, number, boolean];\ninterface CrossRefSubSection {\n  startNum: number;\n  numObjs: number;\n  entries: Array<CrossRefEntry>;\n}\n\n/** Parse a section of the x-ref table, yielding `CrossRefSubSection` objects as\n *  we encounter them.\n *\n * @param reader The reader to read from.\n * @param offset The offset of the x-ref section in the file.\n * @param length The length of the x-ref section.\n */\nasync function* parseCrossRefSection(\n  reader: Reader,\n  offset: number,\n  length: number\n): AsyncGenerator<CrossRefSubSection> {\n  const buf = new Uint8Array(length);\n  offset += await reader.read(buf, 0, offset, buf.length);\n  if (!testForString(buf, 0, 'xref')) {\n    throw 'Invalid crossreference section, did not start with `xref` line.';\n  }\n  const trailerIdx = buf.findIndex((_x, idx) =>\n    testForString(buf, idx, 'trailer')\n  );\n  // Split into lines and skip first line (`xref`)\n  const parts = textDecoder\n    .decode(buf.subarray(0, trailerIdx))\n    .split(/[\\r ]?\\n/)\n    .slice(1);\n  let currentSection: CrossRefSubSection | undefined;\n  for (const part of parts) {\n    // Entries have length 18 (we stripped the newline already)\n    if (part.length === 18) {\n      if (!currentSection) {\n        throw 'Invalid crossreference section, entry outside of subsection.';\n      }\n      const entryParts = part.trim().split(' ');\n      currentSection.entries.push([\n        Number.parseInt(entryParts[0], 10),\n        Number.parseInt(entryParts[1], 10),\n        entryParts[2] === 'n',\n      ]);\n    } else {\n      if (currentSection) {\n        if (currentSection.numObjs !== currentSection.entries.length) {\n          throw `Invalid subsection, expected ${currentSection.numObjs} objects, found ${currentSection.entries.length}!`;\n        }\n        yield currentSection;\n        currentSection = undefined;\n      }\n      if (part.length === 0 || part.indexOf('trailer') >= 0) {\n        break;\n      }\n      const [startNum, numObjs] = part\n        .trimEnd()\n        .split(' ')\n        .map((p) => Number.parseInt(p, 10));\n      currentSection = {\n        startNum,\n        numObjs,\n        entries: [],\n      };\n    }\n  }\n  if (currentSection) {\n    yield currentSection;\n  }\n  const trailerBuf = buf.subarray(trailerIdx);\n  const trailerStartIdx = trailerBuf.findIndex((_x, idx) =>\n    testForString(trailerBuf, idx, '<<')\n  );\n  const trailerEndIdx = trailerBuf.findIndex((_x, idx) =>\n    testForString(trailerBuf, idx, '>>')\n  );\n\n  const trailerDict = new PdfValueParser(\n    trailerBuf.subarray(trailerStartIdx, trailerEndIdx + 2)\n  ).read() as PdfDictionary;\n  if (trailerDict.Prev) {\n    const previousXrefOffset = trailerDict.Prev as number;\n    yield* parseCrossRefSection(\n      reader,\n      previousXrefOffset,\n      offset - previousXrefOffset\n    );\n  }\n}\n\n/** Look for a string from a given location in a buffer. */\nfunction testForString(\n  buf: Uint8Array,\n  offset: number,\n  value: string,\n  backwards = false\n): boolean {\n  if (backwards) {\n    for (let idx = value.length - 1; idx >= 0; idx--) {\n      if (buf[offset + idx] !== value.charCodeAt(idx)) {\n        return false;\n      }\n    }\n  } else {\n    for (let idx = 0; idx < value.length; idx++) {\n      if (buf[offset + idx] !== value.charCodeAt(idx)) {\n        return false;\n      }\n    }\n  }\n  return true;\n}\n\n/** Check if a string is the representation of an integer digit */\nfunction isDigit(c: string): boolean {\n  return !isNaN(parseInt(c, 10));\n}\n\n/** Check if a character is a hexadecimal digit ([0-9a-fA-F])  */\nfunction isHex(c: number): boolean {\n  return (\n    (c >= 0x30 && c <= 0x39) ||\n    (c >= 0x41 && c <= 0x46) ||\n    (c >= 0x61 && c <= 0x66)\n  );\n}\n\n/** Parse a PDF \"value\", which can be one of:\n * - number (integer or float)\n * - string\n * - name (represented as a JS string starting with `/`)\n * - boolean\n * - null\n * - date\n * - XRef\n * - Array\n * - Dictionary\n *\n * API walkthrough:\n * - `read()` is the main entry point, it will read the next value from the\n *   buffer and advance the cursor\n *  - `match*` methods check if the buffer at the current offset matches a\n *    certain type of value, either returning a boolean or the section of the\n *    buffer containing the value as a string.\n *  - `read*` methods read a value of a specific type from the buffer and\n *    advance the cursor\n */\nexport class PdfValueParser {\n  start = 0;\n  current = 0;\n  private readonly buf: Uint8Array;\n\n  /** Construct a parser for a buffer containing one or more PDF values. */\n  constructor(buf: Uint8Array) {\n    this.buf = buf;\n  }\n\n  /** Get the buffer content at the current offset as a character. */\n  private getChar(): string {\n    return String.fromCharCode(this.buf[this.current]);\n  }\n\n  /** Compares the buffer contents at the current offset against a string value. */\n  private matchValue(value: string): boolean {\n    const valueRead = textDecoder.decode(\n      this.buf.subarray(\n        this.current,\n        this.current + textEncoder.encode(value).length\n      )\n    );\n    return valueRead === value;\n  }\n\n  /** Checks if the buffer at the current offset contains a number.\n   *\n   * See ISO32000-2:2020 section 7.3.3.\n   */\n  private matchInteger(resetAfter = true): string | undefined {\n    this.start = this.current;\n    let chr: string;\n    let isInt = true;\n    const chars: string[] = [];\n    while (\n      !this.matchWhiteSpace((chr = this.getChar())) &&\n      !this.matchDelimiter(chr)\n    ) {\n      if (chr === '+' || chr === '-') {\n        if (this.current - this.start > 0) {\n          isInt = false;\n          break;\n        }\n      } else if (!isDigit(chr)) {\n        isInt = false;\n        break;\n      }\n      this.current++;\n      chars.push(chr);\n    }\n    if (resetAfter) {\n      this.current = this.start;\n    }\n    return isInt ? chars.join('') : undefined;\n  }\n\n  /** Read a PDF value from the current offset, advancing the cursor. */\n  read(): PdfValue {\n    let c = this.getChar();\n    if (this.matchWhiteSpace(c)) {\n      this.skipWhiteSpace();\n      c = this.getChar();\n    }\n    switch (this.getChar()) {\n      case '[':\n        return this.readArray();\n      case '<':\n        return this.matchValue('<<') ? this.readDict() : this.readHexString();\n      case '(':\n        return this.readLiteralString();\n      case '/':\n        return this.readName();\n      case 't':\n        if (this.matchValue('true')) {\n          this.current += 'true'.length;\n          return true;\n        }\n        throw new Error('Unexpected character while parsing');\n      case 'f':\n        if (this.matchValue('false')) {\n          this.current += 'false'.length;\n          return false;\n        }\n        throw new Error('Unexpected character while parsing');\n      case 'n':\n        if (this.matchValue('null')) {\n          this.current += 'null'.length;\n          return null;\n        }\n        throw new Error('Unexpected character while parsing');\n      case '.':\n        return this.readRealNumber();\n      default:\n        if (this.matchIndirectObject()) {\n          return this.readIndirectObject();\n        }\n        if (this.matchRealNumber()) {\n          return this.readRealNumber();\n        }\n        if (this.matchInteger()) {\n          return this.readInteger();\n        }\n        throw new Error(\n          `Encountered unexpected character during parsing: '${c}'`\n        );\n    }\n  }\n\n  /** Check if the input string contains PDF whitespace.\n   *\n   * See ISO32000-2:2020 section 7.2.3, Table 1.\n   */\n  matchWhiteSpace(c: string): boolean {\n    return (\n      c === ' ' ||\n      c === '\\x00' ||\n      c === '\\n' ||\n      c === '\\r' ||\n      c === '\\r\\n' ||\n      c == '\\x0C'\n    );\n  }\n\n  /** Read an integer from the current offset. */\n  readInteger(): number {\n    const intStr = this.matchInteger(false);\n    if (intStr === undefined) {\n      throw new Error('Failed to read integer.');\n    }\n    return Number.parseInt(intStr, 10);\n  }\n\n  /** Read an indirect object from the current offset. */\n  readIndirectObject(): PdfRef {\n    const match = this.matchIndirectObject(false);\n    if (match === undefined) {\n      throw new Error('Failed to read indirect object');\n    }\n    return new PdfRef(Number.parseInt(match.split(' ')[0]));\n  }\n\n  /** Check if the buffer contains an indirect object at the current offset.\n   *\n   * See ISO32000-2:2020 section 7.3.10.\n   */\n  matchIndirectObject(resetAfter = true): string | undefined {\n    this.start = this.current;\n    let c = this.getChar();\n    const chars: string[] = [];\n    const matchNumber = (): boolean => {\n      if (!isDigit(c)) {\n        return false;\n      }\n      chars.push(c);\n      this.current++;\n      while (isDigit((c = this.getChar()))) {\n        chars.push(c);\n        this.current++;\n      }\n      return true;\n    };\n    const matchWhitespace = (): boolean => this.skipWhiteSpace();\n    // Using a closure makes resetting afterwards less verbose\n    const match = (): boolean => {\n      // Object number\n      if (!matchNumber()) {\n        return false;\n      }\n      if (!matchWhitespace()) {\n        return false;\n      }\n      chars.push(' ');\n      c = this.getChar();\n      // Generation number\n      if (!matchNumber()) {\n        return false;\n      }\n      if (!matchWhitespace()) {\n        return false;\n      }\n      chars.push(' ');\n      if (this.getChar() !== 'R') {\n        return false;\n      }\n      chars.push('R');\n      this.current++;\n      return true;\n    };\n    const doesMatch = match();\n    if (resetAfter) {\n      this.current = this.start;\n    }\n    if (doesMatch) {\n      return chars.join('');\n    }\n  }\n\n  /** Check if the buffer contains a real number at the current offset.\n   *\n   * See ISO32000-2:2020 section 7.3.3.\n   */\n  matchRealNumber(resetAfter = true): string | undefined {\n    this.start = this.current;\n    let isRealNumber = true;\n    let digitSeen = false;\n    let separatorSeen = false;\n    const chars: string[] = [];\n    let c: string;\n    // eslint-disable-next-line no-constant-condition\n    while (true) {\n      c = this.getChar();\n      if (c === '.') {\n        if (separatorSeen) {\n          isRealNumber = false;\n          break;\n        }\n        separatorSeen = true;\n      } else if (isDigit(c)) {\n        digitSeen = true;\n      } else if (c === '-' || c === '+') {\n        if (this.current - this.start > 0) {\n          break;\n        }\n      } else {\n        break;\n      }\n      chars.push(c);\n      this.current++;\n    }\n    if (resetAfter) {\n      this.current = this.start;\n    }\n    if (!isRealNumber) {\n      return undefined;\n    }\n    if (digitSeen && separatorSeen) {\n      return chars.join('');\n    }\n    return undefined;\n  }\n\n  /** Read a real number from the current offset. */\n  readRealNumber(): number {\n    const str = this.matchRealNumber(false);\n    if (!str) {\n      throw new Error('Could not read real number.');\n    }\n    return Number.parseFloat(str);\n  }\n\n  /** Skip a contiguous sequence of whitespae, advancing the cursor. */\n  skipWhiteSpace(): boolean {\n    let skipped = false;\n    while (!this.atEnd() && this.matchWhiteSpace(this.getChar())) {\n      this.current++;\n      skipped = true;\n    }\n    return skipped;\n  }\n\n  /** Check if we're at the end of the buffer. */\n  atEnd(): boolean {\n    return this.current >= this.buf.length;\n  }\n\n  /** Read a name from the current offset.\n   *\n   * See ISO32000-2:2020 section 7.3.5.\n   */\n  readName(): PdfValue {\n    const chars: string[] = ['/'];\n    this.current++;\n    let c: string;\n    while (\n      !this.matchWhiteSpace((c = this.getChar())) &&\n      !this.matchDelimiter(c)\n    ) {\n      if (c === '#') {\n        const a = this.buf[this.current++];\n        const b = this.buf[this.current++];\n        if (!isHex(a) || !isHex(b)) {\n          throw new Error('Illegal character escape in name.');\n        }\n        chars.push(\n          String.fromCharCode(\n            Number.parseInt(String.fromCharCode(a) + String.fromCharCode(b), 16)\n          )\n        );\n      } else {\n        chars.push(c);\n        this.current++;\n      }\n    }\n    return chars.join('');\n  }\n\n  /** Check if the current offset contains a delimiter.\n   *\n   * See ISO32000-2:2020 section 7.2.3, Table 2\n   */\n  matchDelimiter(c: string): boolean {\n    return '[]{}()<>/%'.indexOf(c) >= 0;\n  }\n\n  /** Read a hex string from the current offset.\n   *\n   * See ISO32000-2:2020 section 7.3.4.3\n   */\n  readHexString(): PdfValue {\n    this.current++;\n    const vals: Array<number> = [];\n    while (this.getChar() !== '>') {\n      const a = this.buf[this.current++];\n      const b = this.buf[this.current++];\n      if (!isHex(a) || !isHex(b)) {\n        throw new Error(`Invalid value in hex string: '${a}${b}`);\n      }\n      vals.push(\n        Number.parseInt(String.fromCharCode(a) + String.fromCharCode(b), 16)\n      );\n    }\n    this.current++;\n    return new Uint8Array(vals);\n  }\n\n  /** Read a literal string from the current offset.\n   *\n   * See ISO32000-2:2020 section 7.3.4.2\n   */\n  readLiteralString(): PdfValue {\n    this.current++;\n    const chars: string[] = [];\n    let openParens = 0;\n    let c: string;\n    // eslint-disable-next-line no-constant-condition\n    while (true) {\n      c = this.getChar();\n      if (c === '\\\\') {\n        this.current++;\n        c = this.getChar();\n        if (isDigit(c)) {\n          let cs = [c];\n          this.current++;\n          while (isDigit(this.getChar())) {\n            cs.push(this.getChar());\n            this.current++;\n          }\n          if (cs.length > 3) {\n            this.current -= cs.length - 3;\n            cs = cs.slice(0, 3);\n          }\n          this.current--;\n          c = String.fromCharCode(Number.parseInt(cs.join(''), 8));\n        } else {\n          c = ESCAPE_CHARS[c];\n          if (c === undefined) {\n            throw new Error(\n              `Illegal escape sequence in string literal: '\\\\${c}`\n            );\n          }\n        }\n      } else if (c === '(') {\n        openParens++;\n      } else if (c === ')') {\n        openParens--;\n        if (openParens < 0) {\n          this.current++;\n          return chars.join('');\n        }\n      }\n      chars.push(c);\n      this.current++;\n    }\n  }\n\n  /** Read a dictionary from the current offset.\n   *\n   * See ISO32000-2:2020 section 7.3.7\n   */\n  readDict(): PdfValue {\n    this.current += 2;\n    const obj: Record<string, PdfValue> = {};\n    this.skipWhiteSpace();\n    while (this.getChar() !== '>') {\n      const name = this.read();\n      if (typeof name !== 'string' || !name.startsWith('/')) {\n        throw new Error(`Dictionary keys must be name objects, got '${name}`);\n      }\n      this.skipWhiteSpace();\n      const val = this.read();\n      if (val !== null) {\n        obj[name.substring(1)] = val;\n      }\n      this.skipWhiteSpace();\n    }\n    this.current += 2;\n    return obj;\n  }\n\n  /** Read an array from the current offset.\n   *\n   * See ISO32000-2:2020 section 7.3.6\n   */\n  readArray(): Array<PdfValue> {\n    this.current++;\n    const arr: Array<PdfValue> = [];\n    while (this.getChar() !== ']') {\n      arr.push(this.read());\n      this.skipWhiteSpace();\n    }\n    this.current++;\n    return arr;\n  }\n}\n\n/** Minimalist low-level PDF parser operating on a Reader object.\n *\n * Currently only supports discovering page objects and annotation objects, as well\n * as obtaining arbitrary objects given the object number and generation.\n */\nexport class PdfParser {\n  private reader: Reader;\n  private objectOffsets: Array<number>;\n  private sortedOffsets: Array<number>;\n  pdfSize: any;\n  objGenerations: number[];\n  infoNum: number;\n  catalogNum: number;\n\n  /** Construct a new parser from a Reader.\n   *\n   * Used instead of the constructor to allow for async initialization.\n   */\n  static async parse(reader: Reader): Promise<PdfParser> {\n    const trailerBuf = new Uint8Array(1024);\n    const pdfSize = await reader.size();\n    const bufStart = pdfSize - trailerBuf.length;\n    await reader.read(trailerBuf, 0, bufStart, trailerBuf.length);\n    const eofIdx =\n      trailerBuf.length - (trailerBuf[trailerBuf.length - 1] === 0x46 ? 5 : 6);\n    if (!testForString(trailerBuf, eofIdx, '%%EOF')) {\n      throw 'Invalid PDF, missing EOF comment at end of file';\n    }\n    const startXrefPos = trailerBuf.findLastIndex((_x, idx) =>\n      testForString(trailerBuf, idx, 'startxref')\n    );\n    if (startXrefPos < 0) {\n      throw 'Invalid PDF, missing startxref marker in file trailer.';\n    }\n    const objGenerations: Array<number> = [];\n    const objsDeleted: Array<boolean> = [];\n    const objOffsets: Array<number> = [];\n    const xrefStartOffset = Number.parseInt(\n      textDecoder.decode(trailerBuf.subarray(startXrefPos + 9, eofIdx)).trim(),\n      10\n    );\n    const dictEnd =\n      trailerBuf.findLastIndex((_x, idx) =>\n        testForString(trailerBuf, idx, '>>')\n      ) + 2;\n    const dictStart = trailerBuf.findLastIndex((_x, idx) =>\n      testForString(trailerBuf, idx, '<<')\n    );\n    const trailerDict = new PdfValueParser(\n      trailerBuf.subarray(dictStart, dictEnd)\n    ).read() as PdfDictionary;\n    for await (const { startNum, entries } of parseCrossRefSection(\n      reader,\n      xrefStartOffset,\n      bufStart + dictEnd - xrefStartOffset\n    )) {\n      for (const [idx, [offset, gen, inUse]] of entries.entries()) {\n        const objNum = idx + startNum;\n        if ((objGenerations[objNum] ?? -1) > gen) {\n          // Outdated entry, don't consider\n          continue;\n        }\n        objGenerations[objNum] = gen;\n        if (inUse) {\n          objOffsets[objNum] = offset;\n          objsDeleted[objNum] = false;\n        } else {\n          objOffsets[objNum] = -1;\n          objsDeleted[objNum] = true;\n        }\n      }\n    }\n    if (objOffsets.length !== trailerDict.Size) {\n      throw `Trailer dictionary has different number of objects than crossreference tables, ${objOffsets.length} vs. ${trailerDict.Size}`;\n    }\n    return new PdfParser(reader, objOffsets, objGenerations, trailerDict);\n  }\n\n  /** Private constructor, use factory method above. */\n  private constructor(\n    reader: Reader,\n    objOffsets: Array<number>,\n    objGenerations: Array<number>,\n    trailerDict: PdfDictionary\n  ) {\n    this.reader = reader;\n    this.objectOffsets = objOffsets;\n    this.sortedOffsets = [...objOffsets].sort((a, b) => a - b);\n    this.objGenerations = objGenerations;\n    this.catalogNum = (trailerDict.Root as PdfRef).refObj;\n    this.infoNum = (trailerDict.Info as PdfRef).refObj;\n  }\n\n  /** Retrieve the catalog dictionary. */\n  async catalog(): Promise<PdfDictionary> {\n    const obj = await this.getObject(this.catalogNum);\n    if (!obj) {\n      throw `Document has no catalog object (num as per trailer: ${this.catalogNum}!`;\n    }\n    return obj.data as PdfDictionary;\n  }\n\n  /** Retrieve the info dictionary. */\n  async info(): Promise<PdfDictionary> {\n    const obj = await this.getObject(this.infoNum);\n    if (!obj) {\n      throw `Document has no info object (num as per trailer: ${this.infoNum}!`;\n    }\n    return obj.data as PdfDictionary;\n  }\n\n  /** Yield all pages referenced in the given page dictionary. */\n  async *_pagesFromPagesObj(\n    pagesObj: PdfDictionary\n  ): AsyncGenerator<PdfObject> {\n    for (const pageRef of pagesObj.Kids as Array<PdfRef>) {\n      const page = await this.getObject(pageRef.refObj, true);\n      if (!page) {\n        throw `Could not find Page object with number ${pageRef.refObj}`;\n      }\n      const pageDict = page.data as PdfDictionary;\n      if (pageDict.Type === '/Pages') {\n        yield* this._pagesFromPagesObj(pageDict);\n      } else {\n        yield page;\n      }\n    }\n  }\n\n  /** Yield all pages in the PDF. */\n  async *pages(): AsyncGenerator<PdfObject> {\n    const catalog = await this.catalog();\n    const pagesRef = catalog.Pages as PdfRef;\n    const pagesRoot = await this.getObject(pagesRef.refObj);\n    if (!pagesRoot) {\n      throw `Could not find Pages object with number ${pagesRef.refObj}`;\n    }\n    const pagesDict = pagesRoot.data as PdfDictionary;\n    yield* this._pagesFromPagesObj(pagesDict);\n  }\n\n  /** Yield all annotations for the given page dictionary. */\n  async *annotations(pageDict: PdfDictionary): AsyncGenerator<PdfDictionary> {\n    const annots = pageDict.Annots;\n    if (!annots) {\n      return;\n    }\n    for (const annoRef of annots as Array<PdfRef>) {\n      const anno = await this.getObject(annoRef.refObj);\n      if (!anno) {\n        throw `Could not find Annotation object with number ${annoRef.refObj}`;\n      }\n      yield anno.data as PdfDictionary;\n    }\n  }\n\n  /** Resolve a PDF reference to the corresponding object. */\n  resolveRef(ref: PdfRef): Promise<PdfObject | undefined> {\n    return this.getObject(ref.refObj, true);\n  }\n\n  /** Get an object from the PDF from its number. */\n  async getObject(\n    num: number,\n    withStream = false\n  ): Promise<PdfObject | undefined> {\n    const offset = this.objectOffsets[num];\n    if (!offset) {\n      return;\n    }\n    if (!this.pdfSize) {\n      this.pdfSize = await this.reader.size();\n    }\n    const nextOffset =\n      this.sortedOffsets[this.sortedOffsets.indexOf(offset) + 1] ??\n      this.pdfSize;\n    const buf = new Uint8Array(nextOffset - offset);\n    await this.reader.read(buf, 0, offset, buf.length);\n    const objEndIdx = buf.findIndex((_x, idx) =>\n      testForString(buf, idx, 'endobj')\n    );\n    let streamIdx = buf.findIndex((_x, idx) =>\n      testForString(buf, idx, 'stream')\n    );\n    if (streamIdx >= 0) {\n      streamIdx += 'stream'.length;\n      if (buf[streamIdx] === '\\r'.charCodeAt(0)) {\n        streamIdx += 2;\n      } else {\n        streamIdx += 1;\n      }\n    }\n    const objSig = `${num} ${this.objGenerations[num]} obj`;\n    const objParser = new PdfValueParser(\n      buf.subarray(objSig.length, streamIdx < 0 ? objEndIdx : streamIdx)\n    );\n    const data = objParser.read();\n    if (typeof data !== 'object' || data === null) {\n      throw new Error('Illegal PDF object, does not start with a dictionary.');\n    }\n    let stream: Uint8Array | undefined;\n    if (withStream && streamIdx > 0) {\n      const streamLength = (data as PdfDictionary).Length as number | undefined;\n      if (streamLength === undefined) {\n        throw new Error(\n          'Illegal stream object, missing Length entry in object dictionary.'\n        );\n      }\n      stream = buf.subarray(streamIdx, streamIdx + streamLength);\n    }\n    return {\n      num,\n      data,\n      stream,\n    };\n  }\n}\n","export default '0.2.3';\n","import { crc32 } from '../util.js';\nimport { textEncoder } from './util.js';\n\nexport type LocalHeaderParams = {\n  creationDate?: Date;\n  filename: string;\n  data: Uint8Array;\n  compressedData?: Uint8Array;\n  extraDataLength: number;\n};\n\nexport type CentralDirectoryFileSpec = {\n  localHeaderOffset: number;\n  deflated: boolean;\n  creationDate: Date;\n  crc32: number;\n  dataLength: number;\n  compressedDataLength: number;\n  filename: string;\n};\n\nexport type CentralFileDirectorySpec = {\n  files: CentralDirectoryFileSpec[];\n  trailingLength: number;\n  offset: number;\n};\n\nexport function buildLocalZipHeader({\n  creationDate = new Date(),\n  filename,\n  data,\n  compressedData,\n  extraDataLength,\n}: LocalHeaderParams): Uint8Array {\n  const creationTimeZip =\n    (creationDate.getHours() << 11) |\n    (creationDate.getDay() << 5) |\n    Math.round(creationDate.getSeconds() / 2);\n  const creationDateZip =\n    ((creationDate.getFullYear() - 1980) << 9) |\n    ((creationDate.getMonth() + 1) << 5) |\n    creationDate.getDate();\n  const dataCrc = crc32(data);\n  const filenameEncoded = textEncoder.encode(filename);\n  // 2 bytes for zlib header\n  const compressedLength = compressedData ? (compressedData.length - 2) : data.length;\n  return new Uint8Array([\n    // PKZIP magic number\n    0x50,\n    0x4b,\n    // Local File Header magic\n    0x03,\n    0x04,\n    // Required PKZip version\n    0x14,\n    0x00,\n    // General purpose bit flag, 2 bytes\n    0b00000000,\n    0b00000000,\n    // Compression method, 2 bytes little endian\n    compressedData ? 0x08 : 0x00,\n    0x00,\n    // Creation time, 2 bytes little endian\n    creationTimeZip & 0xff,\n    creationTimeZip >> 8,\n    // Creation date, 2 bytes little endian\n    creationDateZip & 0xff,\n    creationDateZip >> 8,\n    // CRC32 of data, 4 bytes little endian\n    dataCrc & 0xff,\n    (dataCrc >> 8) & 0xff,\n    (dataCrc >> 16) & 0xff,\n    (dataCrc >> 24) & 0xff,\n    // Compressed size, 4 bytes little endian\n    compressedLength & 0xff,\n    (compressedLength >> 8) & 0xff,\n    (compressedLength >> 16) & 0xff,\n    (compressedLength >> 24) & 0xff,\n    // Uncompressed size, 4 bytes little endian\n    data.length & 0xff,\n    (data.length >> 8) & 0xff,\n    (data.length >> 16) & 0xff,\n    (data.length >> 24) & 0xff,\n    // Filename length, 2 bytes little endian\n    filenameEncoded.length & 0xff,\n    filenameEncoded.length >> 8, // Filename length in little endian\n    // Extra field length, 2 bytes little endian\n    (extraDataLength + 4) & 0xff,\n    (extraDataLength + 4) >> 8,\n    // Encoded file name\n    ...filenameEncoded,\n    // Beginning of extra field: identifier, 2 bytes\n    0xff,\n    0xff,\n    // Beginning of extra field: length, 2 bytes little endian\n    extraDataLength & 0xff,\n    extraDataLength >> 8,\n  ]);\n}\n\nexport function buildCentralFileDirectory({\n  files,\n  trailingLength,\n  offset\n}: CentralFileDirectorySpec): Uint8Array {\n  const chunks = files.map(buildCentralDirectoryFileHeader);\n  const cdSize =  chunks.reduce((acc, chunk) => acc + chunk.length, 0);\n  chunks.push(new Uint8Array([\n    // PKZIP magic number\n    0x50,\n    0x4b,\n    // End of central directory magic\n    0x05,\n    0x06,\n    // Disk number\n    0x00,\n    0x00,\n    // Disk with central directory\n    0x00,\n    0x00,\n    // Disk entries\n    files.length & 0xff,\n    files.length >> 8,\n    // Total entries\n    files.length & 0xff,\n    files.length >> 8,\n    // Central directory size,\n    cdSize & 0xff,\n    (cdSize >> 8) & 0xff,\n    (cdSize >> 16) & 0xff,\n    (cdSize >> 24) & 0xff,\n    // Offset of central directory in file\n    offset & 0xff,\n    (offset >> 8) & 0xff,\n    (offset >> 16) & 0xff,\n    (offset >> 24) & 0xff,\n    // Length of trailing comment\n    trailingLength & 0xff,\n    trailingLength >> 8,\n  ]));\n  return new Uint8Array(\n    chunks.reduce((acc: number[], curr) => {\n      acc.push(...curr);\n      return acc;\n    }, [])\n  );\n}\n\nfunction buildCentralDirectoryFileHeader(\n  spec: CentralDirectoryFileSpec\n): Uint8Array {\n  const creationTimeZip =\n    (spec.creationDate.getHours() << 11) |\n    (spec.creationDate.getMinutes() << 5) |\n    Math.round(spec.creationDate.getSeconds() / 2);\n  const creationDateZip =\n    ((spec.creationDate.getFullYear() - 1980) << 9) |\n    ((spec.creationDate.getMonth() +1) << 5) |\n    spec.creationDate.getDate();\n  const filenameEncoded = textEncoder.encode(spec.filename);\n  return new Uint8Array([\n    // PKZIP magic number\n    0x50,\n    0x4b,\n    // Central directory file header magic\n    0x01,\n    0x02,\n    // Version\n    0x17,\n    0x03,\n    //  Version needed\n    0x14,\n    0x00,\n    // Flags, none set\n    0x00,\n    0x00,\n    // Compression method, 2 bytes little endian\n    spec.deflated ? 0x08 : 0x00,\n    0x00,\n    // Creation time, 2 bytes little endian\n    creationTimeZip & 0xff,\n    creationTimeZip >> 8,\n    // Creation date, 2 bytes little endian\n    creationDateZip & 0xff,\n    creationDateZip >> 8,\n    // CRC32 of data, 4 bytes little endian\n    spec.crc32 & 0xff,\n    (spec.crc32 >> 8) & 0xff,\n    (spec.crc32 >> 16) & 0xff,\n    (spec.crc32 >> 24) & 0xff,\n    // Compressed size, 4 bytes little endian\n    spec.compressedDataLength & 0xff,\n    (spec.compressedDataLength >> 8) & 0xff,\n    (spec.compressedDataLength >> 16) & 0xff,\n    (spec.compressedDataLength >> 24) & 0xff,\n    // Uncompressed size, 4 bytes little endian\n    spec.dataLength & 0xff,\n    (spec.dataLength >> 8) & 0xff,\n    (spec.dataLength >> 16) & 0xff,\n    (spec.dataLength >> 24) & 0xff,\n    // Filename length, 2 bytes little endian\n    filenameEncoded.length & 0xff,\n    filenameEncoded.length >> 8, // Filename length in little endian\n    // Extra field length, 2 bytes little endian\n    0x00,\n    0x00,\n    // File comment length, 2 bytes little endian\n    0x00,\n    0x00,\n    // Disk # start, 2 bytes little endian\n    0x00,\n    0x00,\n    // Internal Attribute, 2 bytes little endian\n    0x00,\n    0x00,\n    // External Attribute, 4 bytes little endian\n    0x00,\n    0x00,\n    0xa4,\n    0x81,\n    // Offset of local header, 4 bytes little endian\n    spec.localHeaderOffset & 0xff,\n    (spec.localHeaderOffset >> 8) &0xff,\n    (spec.localHeaderOffset >> 16) &0xff,\n    (spec.localHeaderOffset >> 24) &0xff,\n    ...filenameEncoded,\n  ]);\n}\n","import { PdfDictionary } from './common.js';\nimport { Annotation } from '../iiif.js';\nimport {\n  BoxSelector,\n  SelectorStyle,\n  SupportedSelector,\n  SvgSelector,\n} from '@iiif/vault-helpers/annotation-targets';\nimport { PointSelector } from '@iiif/presentation-3';\nimport Color from 'color';\nimport { SAXParser, SaxEventType, Text } from 'sax-wasm';\nimport { textEncoder } from './util.js';\n\nconst ALLOWED_CSS_RULES = [\n  'text-align',\n  'vertical-align',\n  'font-size',\n  'font-weight',\n  'font-style',\n  'font-family',\n  'font',\n  'color',\n  'text-decoration',\n  'font-stretch',\n];\nconst CSS_PAT = /\\s*(?<attrib>[^:]+)\\s*:\\s*(?<val>[^;]+)(?:;|$)/gm;\nconst RGB_PAT = /rgb\\((?<r>\\d+)\\s*,\\s*(?<g>\\d+)\\s*,\\s*(?<b>\\d+)\\)/;\nconst CSS_LENGTH_PAT = /(?<val>\\d+(?:\\.\\d+)?)\\s*(?<unit>[[a-z%]+)?/;\n\nfunction sanitizeCssForPdf(styleAttrib: string): string {\n  let parts: RegExpExecArray | null;\n  const out: Array<string> = [];\n  while ((parts = CSS_PAT.exec(styleAttrib)) !== null) {\n    const [, attrib, value] = parts;\n    if (!ALLOWED_CSS_RULES.includes(attrib)) {\n      continue;\n    }\n    out.push(`${attrib}: ${value}`);\n  }\n  return out.join('; ');\n}\n\nfunction htmlToPlainText(html: string): string {\n  const parser = new SAXParser(SaxEventType.Text, { highWaterMark: 1024 });\n  const txt: string[] = [];\n  parser.eventHandler = (ev, data) => {\n    txt.push((data as Text).value);\n  }\n  parser.write(textEncoder.encode(html));\n  return txt.join('').trim();\n}\n\nfunction toPdfRect(\n  selector: BoxSelector | SvgSelector,\n  pageHeight: number,\n  unitScale: number\n): PdfDictionary | null {\n  if (!selector.spatial) {\n    return null;\n  }\n  const lly = pageHeight - selector.spatial.y;\n  const ury = lly - selector.spatial.height;\n  return {\n    Subtype: '/Square',\n    Rect: [\n      selector.spatial.x * unitScale,\n      lly * unitScale,\n      (selector.spatial.x + selector.spatial.width) * unitScale,\n      ury * unitScale,\n    ],\n  };\n}\n\nfunction cssColorToRgb(cssColor: string): [number, number, number] | null {\n  return Color(cssColor).rgb().array() as [number, number, number];\n}\n\nfunction cssLengthToPdfUserspace(\n  cssLength: string,\n  unitScale: number,\n  referenceDimensionPx?: number\n): number | null {\n  const match = CSS_LENGTH_PAT.exec(cssLength);\n  if (!match || !match.groups) {\n    return null;\n  }\n  const val = parseFloat(match.groups.val);\n  const unit = match.groups.unit;\n  if (!unit) {\n    return val * unitScale;\n  }\n  switch (unit) {\n    case '%':\n      if (!referenceDimensionPx) {\n        return null;\n      }\n      return (val / 100) * referenceDimensionPx * unitScale;\n    case 'px':\n      return unitScale * val;\n    default:\n      console.warn(`Unsupported CSS length unit: ${unit}`);\n      return null;\n  }\n}\n\nfunction selectorStyleToPdf(\n  style: SelectorStyle,\n  unitScale: number\n): PdfDictionary {\n  const pdfStyle: PdfDictionary = {};\n  if (style.stroke || style.strokeDasharray || style.strokeWidth) {\n    pdfStyle.BS = {\n      Type: '/Border',\n      W: style.strokeWidth ?? 1,\n      S: style.strokeDasharray ? '/D' : '/S',\n    };\n    if (style.strokeDasharray) {\n      pdfStyle.BS.D = style.strokeDasharray;\n    }\n  }\n  if (style.fill) {\n    const rgb = cssColorToRgb(style.fill);\n    if (rgb) {\n      pdfStyle.IC = rgb.map((c) => c / 255);\n    }\n  }\n  // TODO: Check if fill-opacity is desired and use an Apperance Stream instead of IC\n  if (style.strokeWidth) {\n    const width = cssLengthToPdfUserspace(style.strokeWidth, unitScale);\n    pdfStyle.BS = {\n      Type: '/Border',\n      W: width,\n    };\n  }\n  return pdfStyle;\n}\n\nfunction selectorToPdf(\n  selector: SupportedSelector,\n  unitScale: number,\n  pageHeight: number\n): PdfDictionary {\n  const styleDict = selector.style\n    ? selectorStyleToPdf(selector.style, unitScale)\n    : {};\n  switch (selector.type) {\n    case 'BoxSelector':\n      return {\n        Subtype: '/Square',\n        ...toPdfRect(selector as BoxSelector, pageHeight, unitScale),\n        ...styleDict,\n      };\n    case 'PointSelector': {\n      // TODO: Use a /Stamp with a custom icon (flag?)\n      //       This is a bit complicated since we need to povide\n      //       an /AP dictionary with a custom /Form that\n      //       renders our icon. Luckily, this can be reused, so\n      //       we store it once and just reference it in all point-type\n      //       annotations.\n      const point = selector as PointSelector;\n      if (!point.x || !point.y) {\n        throw `Only PointSelectors with both x and y coordinates are supported!`;\n      }\n      return {\n        Subtype: '/Circle',\n        BS: {\n          Type: '/Border',\n          W: 2,\n          S: '/S',\n        },\n        IC: [1.0, 1.0, 1.0],\n        Rect: [\n          point.x * unitScale - 0.5,\n          point.y * unitScale - 0.5,\n          point.x * unitScale + 1.0,\n          point.y * unitScale + 1.0,\n        ],\n      };\n    }\n    case 'SvgSelector': {\n      const svgSel = selector as SvgSelector;\n      switch (svgSel.svgShape) {\n        case 'rect':\n          return {\n            Subtype: '/Square',\n            ...toPdfRect(svgSel, pageHeight, unitScale),\n            ...styleDict,\n          };\n        case 'circle':\n        case 'ellipse':\n          return {\n            Subtype: '/Circle',\n            Rect: toPdfRect(svgSel, pageHeight, unitScale),\n            ...styleDict,\n          };\n        case 'polyline':\n        case 'polygon':\n          return {\n            Subtype: svgSel.svgShape === 'polyline' ? '/PolyLine' : '/Polygon',\n            Vertices:\n              svgSel.points?.flatMap(([x, y]) => [\n                x * unitScale,\n                (pageHeight - y) * unitScale,\n              ]) ?? [],\n            ...styleDict,\n          };\n        case 'path':\n          return {\n            Subtype: '/Ink',\n            InkList:\n              svgSel.points?.flatMap(([x, y]) => [\n                x * unitScale,\n                (pageHeight - y) * unitScale,\n              ]) ?? [],\n            ...styleDict,\n          };\n        default:\n          throw new Error('not implemented yet');\n      }\n    }\n    default:\n      throw `${selector.type} selector is currently not supported`;\n  }\n}\n\nexport function exportPdfAnnotation(\n  anno: Annotation,\n  unitScale: number,\n  pageHeight: number\n): Array<PdfDictionary> {\n  const annoDict: PdfDictionary = {\n    Type: '/Annot',\n    NM: `(${anno.id})`,\n    Contents: `(${htmlToPlainText(anno.markup)})`,\n    F: 4,\n    C: [1, 0, 0], // Red title bar\n    CA: 1, // Constant opacity of 1\n    Border: [0, 0, 5],\n    //RC: `(${htmlToPdfRichText(anno.markup)})`,\n  };\n  if (anno.author) {\n    annoDict.T = `(${anno.author})`;\n  }\n  if (anno.lastModified) {\n    annoDict.M = anno.lastModified;\n  }\n  if (anno.target.selector) {\n    return [\n      {\n        ...annoDict,\n        ...selectorToPdf(anno.target.selector, unitScale, pageHeight),\n      },\n    ] as PdfDictionary[];\n  } else if (anno.target.selectors && anno.target.selectors.length > 0) {\n    return anno.target.selectors.map((s) => ({\n      ...annoDict,\n      ...selectorToPdf(s, unitScale, pageHeight),\n    })) as PdfDictionary[];\n  }\n  return [];\n}\n","export interface LicenseDescription {\n  text: string;\n  logo: string;\n}\nexport type LicenseList = Record<string, LicenseDescription>;\n\n// TODO: Re-generate this list based on the official CC RDF files:\n//  https://github.com/creativecommons/cc-licenses-data/blob/main/legacy/rdf-licenses\nexport const licenses: LicenseList = {\n  'http://creativecommons.org/licenses/by-nc-sa/2.0/fr/': {\n    text: 'Creative Commons Attribution-NonCommercial-ShareAlike 2.0 France (CC-BY-NC-SA-2.0-FR)',\n    logo: 'https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nc-sa.svg',\n  },\n  'http://creativecommons.org/licenses/by-sa/4.0/': {\n    text: 'Creative Commons Attribution Share Alike 4.0 International (CC-BY-SA-4.0)',\n    logo: 'https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-sa.svg',\n  },\n  'http://creativecommons.org/licenses/by/3.0/de/': {\n    text: 'Creative Commons Attribution 3.0 Germany (CC-BY-3.0-DE)',\n    logo: 'https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by.svg',\n  },\n  'http://creativecommons.org/licenses/by-nc-nd/3.0/': {\n    text: 'Creative Commons Attribution Non Commercial No Derivatives 3.0 Unported (CC-BY-NC-ND-3.0)',\n    logo: 'https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nc-nd.svg',\n  },\n  'http://creativecommons.org/licenses/by/1.0/': {\n    text: 'Creative Commons Attribution 1.0 Generic (CC-BY-1.0)',\n    logo: 'https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by.svg',\n  },\n  'http://creativecommons.org/licenses/by-nd/1.0/': {\n    text: 'Creative Commons Attribution No Derivatives 1.0 Generic (CC-BY-ND-1.0)',\n    logo: 'https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nd.svg',\n  },\n  'http://creativecommons.org/licenses/by-nc-sa/3.0/de/': {\n    text: 'Creative Commons Attribution Non Commercial Share Alike 3.0 Germany (CC-BY-NC-SA-3.0-DE)',\n    logo: 'https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nc-sa.svg',\n  },\n  'http://creativecommons.org/licenses/by-nc-sa/1.0/': {\n    text: 'Creative Commons Attribution Non Commercial Share Alike 1.0 Generic (CC-BY-NC-SA-1.0)',\n    logo: 'https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nc-sa.svg',\n  },\n  'http://creativecommons.org/licenses/by-nd/4.0/': {\n    text: 'Creative Commons Attribution No Derivatives 4.0 International (CC-BY-ND-4.0)',\n    logo: 'https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nd.svg',\n  },\n  'http://creativecommons.org/licenses/by-sa/3.0/at/': {\n    text: 'Creative Commons Attribution Share Alike 3.0 Austria (CC-BY-SA-3.0-AT)',\n    logo: 'https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-sa.svg',\n  },\n  'http://creativecommons.org/licenses/by/3.0/at/': {\n    text: 'Creative Commons Attribution 3.0 Austria (CC-BY-3.0-AT)',\n    logo: 'https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by.svg',\n  },\n  'http://creativecommons.org/licenses/by/3.0/': {\n    text: 'Creative Commons Attribution 3.0 Unported (CC-BY-3.0)',\n    logo: 'https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by.svg',\n  },\n  'http://creativecommons.org/licenses/by-nc/2.0/': {\n    text: 'Creative Commons Attribution Non Commercial 2.0 Generic (CC-BY-NC-2.0)',\n    logo: 'https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nc.svg',\n  },\n  'http://creativecommons.org/licenses/by-nc-sa/2.5/': {\n    text: 'Creative Commons Attribution Non Commercial Share Alike 2.5 Generic (CC-BY-NC-SA-2.5)',\n    logo: 'https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nc-sa.svg',\n  },\n  'http://creativecommons.org/licenses/by-nc/2.5/': {\n    text: 'Creative Commons Attribution Non Commercial 2.5 Generic (CC-BY-NC-2.5)',\n    logo: 'https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nc.svg',\n  },\n  'http://creativecommons.org/licenses/by-nd-nc/1.0/': {\n    text: 'Creative Commons Attribution Non Commercial No Derivatives 1.0 Generic (CC-BY-NC-ND-1.0)',\n    logo: 'https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nc-nd.svg',\n  },\n  'http://creativecommons.org/licenses/by-nd/3.0/': {\n    text: 'Creative Commons Attribution No Derivatives 3.0 Unported (CC-BY-ND-3.0)',\n    logo: 'https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nd.svg',\n  },\n  'http://creativecommons.org/licenses/by-sa/2.5/': {\n    text: 'Creative Commons Attribution Share Alike 2.5 Generic (CC-BY-SA-2.5)',\n    logo: 'https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-sa.svg',\n  },\n  'http://creativecommons.org/licenses/by-nc-sa/2.0/uk/': {\n    text: 'Creative Commons Attribution Non Commercial Share Alike 2.0 England and Wales (CC-BY-NC-SA-2.0-UK)',\n    logo: 'https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nc-sa.svg',\n  },\n  'http://creativecommons.org/licenses/by/2.0/': {\n    text: 'Creative Commons Attribution 2.0 Generic (CC-BY-2.0)',\n    logo: 'https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by.svg',\n  },\n  'http://creativecommons.org/licenses/by-nd/2.5/': {\n    text: 'Creative Commons Attribution No Derivatives 2.5 Generic (CC-BY-ND-2.5)',\n    logo: 'https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nd.svg',\n  },\n  'http://creativecommons.org/licenses/by-nc-nd/2.0/': {\n    text: 'Creative Commons Attribution Non Commercial No Derivatives 2.0 Generic (CC-BY-NC-ND-2.0)',\n    logo: 'https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nc-nd.svg',\n  },\n  'http://creativecommons.org/licenses/by-nc-sa/3.0/igo/': {\n    text: 'Creative Commons Attribution Non Commercial Share Alike 3.0 IGO (CC-BY-NC-SA-3.0-IGO)',\n    logo: 'https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nc-sa.svg',\n  },\n  'http://creativecommons.org/licenses/publicdomain//': {\n    text: 'Creative Commons Public Domain Dedication and Certification (CC-PDDC)',\n    logo: 'https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/publicdomain.svg',\n  },\n  'http://creativecommons.org/licenses/by-nc-sa/2.0/': {\n    text: 'Creative Commons Attribution Non Commercial Share Alike 2.0 Generic (CC-BY-NC-SA-2.0)',\n    logo: 'https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nc-sa.svg',\n  },\n  'http://creativecommons.org/licenses/by-nc-nd/3.0/de/': {\n    text: 'Creative Commons Attribution Non Commercial No Derivatives 3.0 Germany (CC-BY-NC-ND-3.0-DE)',\n    logo: 'https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nc-nd.svg',\n  },\n  'http://creativecommons.org/licenses/by-nc/3.0/': {\n    text: 'Creative Commons Attribution Non Commercial 3.0 Unported (CC-BY-NC-3.0)',\n    logo: 'https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nc.svg',\n  },\n  'http://creativecommons.org/licenses/by-nc/3.0/de/': {\n    text: 'Creative Commons Attribution Non Commercial 3.0 Germany (CC-BY-NC-3.0-DE)',\n    logo: 'https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nc.svg',\n  },\n  'http://creativecommons.org/licenses/by-sa/1.0/': {\n    text: 'Creative Commons Attribution Share Alike 1.0 Generic (CC-BY-SA-1.0)',\n    logo: 'https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-sa.svg',\n  },\n  'http://creativecommons.org/licenses/by-nd/3.0/de/': {\n    text: 'Creative Commons Attribution No Derivatives 3.0 Germany (CC-BY-ND-3.0-DE)',\n    logo: 'https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nd.svg',\n  },\n  'http://creativecommons.org/licenses/by-nc-nd/2.5/': {\n    text: 'Creative Commons Attribution Non Commercial No Derivatives 2.5 Generic (CC-BY-NC-ND-2.5)',\n    logo: 'https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nc-nd.svg',\n  },\n  'http://creativecommons.org/licenses/by-sa/3.0/': {\n    text: 'Creative Commons Attribution Share Alike 3.0 Unported (CC-BY-SA-3.0)',\n    logo: 'https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-sa.svg',\n  },\n  'http://creativecommons.org/licenses/by-nc-sa/4.0/': {\n    text: 'Creative Commons Attribution Non Commercial Share Alike 4.0 International (CC-BY-NC-SA-4.0)',\n    logo: 'https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nc-sa.svg',\n  },\n  'http://creativecommons.org/licenses/by-sa/2.0/': {\n    text: 'Creative Commons Attribution Share Alike 2.0 Generic (CC-BY-SA-2.0)',\n    logo: 'https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-sa.svg',\n  },\n  'http://creativecommons.org/licenses/by-sa/2.1/jp/': {\n    text: 'Creative Commons Attribution Share Alike 2.1 Japan (CC-BY-SA-2.1-JP)',\n    logo: 'https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-sa.svg',\n  },\n  'http://creativecommons.org/licenses/by/2.5/': {\n    text: 'Creative Commons Attribution 2.5 Generic (CC-BY-2.5)',\n    logo: 'https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by.svg',\n  },\n  'http://creativecommons.org/licenses/by-sa/2.0/uk/': {\n    text: 'Creative Commons Attribution Share Alike 2.0 England and Wales (CC-BY-SA-2.0-UK)',\n    logo: 'https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-sa.svg',\n  },\n  'http://creativecommons.org/licenses/by/3.0/nl/': {\n    text: 'Creative Commons Attribution 3.0 Netherlands (CC-BY-3.0-NL)',\n    logo: 'https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by.svg',\n  },\n  'http://creativecommons.org/licenses/by-nc-sa/3.0/': {\n    text: 'Creative Commons Attribution Non Commercial Share Alike 3.0 Unported (CC-BY-NC-SA-3.0)',\n    logo: 'https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nc-sa.svg',\n  },\n  'http://creativecommons.org/licenses/by/4.0/': {\n    text: 'Creative Commons Attribution 4.0 International (CC-BY-4.0)',\n    logo: 'https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by.svg',\n  },\n  'http://creativecommons.org/licenses/by/3.0/us/': {\n    text: 'Creative Commons Attribution 3.0 United States (CC-BY-3.0-US)',\n    logo: 'https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by.svg',\n  },\n  'http://creativecommons.org/licenses/by-nc-nd/4.0/': {\n    text: 'Creative Commons Attribution Non Commercial No Derivatives 4.0 International (CC-BY-NC-ND-4.0)',\n    logo: 'https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nc-nd.svg',\n  },\n  'http://creativecommons.org/licenses/by-sa/3.0/de/': {\n    text: 'Creative Commons Attribution Share Alike 3.0 Germany (CC-BY-SA-3.0-DE)',\n    logo: 'https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-sa.svg',\n  },\n  'http://creativecommons.org/licenses/by-nc-nd/3.0/igo/': {\n    text: 'Creative Commons Attribution Non Commercial No Derivatives 3.0 IGO (CC-BY-NC-ND-3.0-IGO)',\n    logo: 'https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nc-nd.svg',\n  },\n  'http://creativecommons.org/publicdomain/zero/1.0/': {\n    text: 'Creative Commons Zero v1.0 Universal (CC0-1.0)',\n    logo: 'https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/cc-zero.svg',\n  },\n  'http://creativecommons.org/publicdomain/mark/1.0/': {\n    text: 'Public Domain Mark 1.0: No Copyright',\n    logo: 'https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/publicdomain.svg',\n  },\n  'http://creativecommons.org/licenses/by/2.5/au/': {\n    text: 'Creative Commons Attribution 2.5 Australia (CC-BY-2.5-AU)',\n    logo: 'https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by.svg',\n  },\n  'http://creativecommons.org/licenses/by-nd/2.0/': {\n    text: 'Creative Commons Attribution No Derivatives 2.0 Generic (CC-BY-ND-2.0)',\n    logo: 'https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nd.svg',\n  },\n  'http://creativecommons.org/licenses/by-nc/1.0/': {\n    text: 'Creative Commons Attribution Non Commercial 1.0 Generic (CC-BY-NC-1.0)',\n    logo: 'https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nc.svg',\n  },\n  'http://creativecommons.org/licenses/by-nc/4.0/': {\n    text: 'Creative Commons Attribution Non Commercial 4.0 International (CC-BY-NC-4.0)',\n    logo: 'https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nc.svg',\n  },\n  'http://rightsstatements.org/vocab/InC/1.0/': {\n    text: 'In Copyright',\n    logo: 'https://rightsstatements.org/files/buttons/InC.dark.svg',\n  },\n  'http://rightsstatements.org/vocab/InC-OW-EU/1.0/': {\n    text: 'In Copyright - EU Orphan Work',\n    logo: 'https://rightsstatements.org/files/buttons/InC-OW-EU.dark.svg',\n  },\n  'http://rightsstatements.org/vocab/InC-EDU/1.0/': {\n    text: 'In Copyright - Educational Use Permitted',\n    logo: 'https://rightsstatements.org/files/buttons/InC-EDU.dark.svg',\n  },\n  'http://rightsstatements.org/vocab/InC-NC/1.0/': {\n    text: 'In Copyright - Non-Commercial Use Permitted',\n    logo: 'https://rightsstatements.org/files/buttons/InC-NC.dark.svg',\n  },\n  'http://rightsstatements.org/vocab/InC-RUU/1.0/': {\n    text: 'In Copyright - Rights-holder(s) Unlocatable or Unidentifiable',\n    logo: 'https://rightsstatements.org/files/buttons/InC-RUU.dark.svg',\n  },\n  'http://rightsstatements.org/vocab/NoC-CR/1.0/': {\n    text: 'No Copyright - Contractual Restrictions',\n    logo: 'https://rightsstatements.org/files/buttons/NoC-CR.dark.svg',\n  },\n  'http://rightsstatements.org/vocab/NoC-NC/1.0/': {\n    text: 'No Copyright - Non-Commercial Use Only',\n    logo: 'https://rightsstatements.org/files/buttons/NoC-NC.dark.svg',\n  },\n  'http://rightsstatements.org/vocab/NoC-OKLR/1.0/': {\n    text: 'No Copyright - Other Known Legal Restrictions',\n    logo: 'https://rightsstatements.org/files/buttons/NoC-OKLR.dark.svg',\n  },\n  'http://rightsstatements.org/vocab/NoC-US/1.0/': {\n    text: 'No Copyright - United States',\n    logo: 'https://rightsstatements.org/files/buttons/NoC-US.dark.svg',\n  },\n  'http://rightsstatements.org/vocab/CNE/1.0/': {\n    text: 'Copyright Not Evaluated',\n    logo: 'https://rightsstatements.org/files/buttons/CNE.dark.svg',\n  },\n  'http://rightsstatements.org/vocab/UND/1.0/': {\n    text: 'Copyright Undetermined',\n    logo: 'https://rightsstatements.org/files/buttons/UND.dark.svg',\n  },\n  'http://rightsstatements.org/vocab/NKC/1.0/': {\n    text: 'No Known Copyright',\n    logo: 'https://rightsstatements.org/files/buttons/NKC.dark.svg',\n  },\n};\n\nexport function getLicenseInfo(uri: string): LicenseDescription | null {\n  uri = uri.replace(/^https:/, 'http:').replace(/\\/deed\\.[a-z]{2}$/, '');\n  if (!uri.endsWith('/')) {\n    uri += '/';\n  }\n  return licenses[uri];\n}\n"],"mappings":"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;AAAA,EAAG;AAAA,EAAI;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAK;AAAA,EAAG;AAAA,EAAG;AAAA,EAC3E;AAAA,EAAI;AAAA,EAAK;AAAA,EAAK;AAAA,EAAK;AAAA,EAAK;AAAA,EAAI;AAAA,EAAI;AAAA,EAAI;AAAA,EAAI;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAK;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAI;AAAA,EAAK;AAAA,EACxE;AAAA,EAAI;AAAA,EAAK;AAAA,EAAI;AAAA,EAAK;AAAA,EAAK;AAAA,EAAK;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAK;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAI;AAAA,EAAK;AAAA,EAAK;AAAA,EAAK;AAAA,EAAI;AAAA,EAC1E;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAK;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAI;AAAA,EAAK;AAAA,EAAK;AAAA,EAAK;AAAA,EAAK;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAC1E;AAAA,EAAK;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAK;AAAA,EAAK;AAAA,EAAI;AAAA,EAAI;AAAA,EAAG;AAAA,EAAI;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAK;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAC1E;AAAA,EAAI;AAAA,EAAK;AAAA,EAAK;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAI;AAAA,EAAK;AAAA,EAAI;AAAA,EAAK;AAAA,EAAK;AAAA,EACtE;AAAA,EAAK;AAAA,EAAI;AAAA,EAAK;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAK;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAI;AAAA,EAAK;AAAA,EAAK;AAAA,EAAK;AAAA,EAAK;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAC5E;AAAA,EAAG;AAAA,EAAI;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAI;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAK;AAAA,EAAK;AAAA,EAAK;AAAA,EAAI;AAAA,EAAI;AAAA,EAAI;AAAA,EACvE;AAAA,EAAK;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAK;AAAA,EAAK;AAAA,EAAK;AAAA,EAAK;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAK;AAAA,EAAK;AAAA,EACvE;AAAA,EAAK;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAI;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAC3E;AAAA,EAAG;AAAA,EAAG;AAAA,EAAK;AAAA,EAAK;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAC5E;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAC3E;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAK;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAC1E;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAC3E;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAI;AAAA,EAAI;AAAA,EAAI;AAAA,EAAI;AAAA,EAC5E;AAAA,EAAI;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAK;AAAA,EAAK;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAK;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAC5E;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAC3E;AAAA,EAAG;AAAA,EAAG;AAAA,EAAI;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAI;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAI;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAC3E;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAI;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAI;AAAA,EAAI;AAAA,EAAI;AAAA,EACzE;AAAA,EAAG;AAAA,EAAG;AAAA,EAAK;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAI;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAI;AAAA,EAAG;AAAA,EAAG;AAAA,EAC5E;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAI;AAAA,EAAG;AAAA,EAAI;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAI;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAC3E;AAAA,EAAG;AAAA,EAAK;AAAA,EAAG;AAAA,EAA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","names":["prometheus","ImageServiceLoader_","x","isAlto","limit","scaleFactor","ppi","import_util","util","nodeCrypto","zlib","Color","dedent","prev","ref","canvasIdx","PQueue","events","ppi"]}
\ No newline at end of file
+{"version":3,"file":"index.cjs","sources":["../src/log.ts","../../node_modules/.pnpm/async-mutex@0.4.1/node_modules/async-mutex/index.mjs","../../node_modules/.pnpm/sax-wasm@2.2.4/node_modules/sax-wasm/lib/module/index.js","../../node_modules/.pnpm/ocr-parser@0.2.5/node_modules/ocr-parser/dist/index.js","../src/util.ts","../src/metrics.ts","../../node_modules/.pnpm/@iiif+helpers@1.3.1_@iiif+parser@2.1.8/node_modules/@iiif/helpers/dist/chunk-2I7FN7JX.js","../../node_modules/.pnpm/@iiif+parser@2.1.8/node_modules/@iiif/parser/dist/chunk-J657UVVW.js","../../node_modules/.pnpm/@iiif+parser@2.1.8/node_modules/@iiif/parser/dist/chunk-NJNTZ6QT.js","../../node_modules/.pnpm/@iiif+parser@2.1.8/node_modules/@iiif/parser/dist/chunk-D22QKJZO.js","../../node_modules/.pnpm/@iiif+parser@2.1.8/node_modules/@iiif/parser/dist/chunk-MQ6FX5SL.js","../../node_modules/.pnpm/@iiif+parser@2.1.8/node_modules/@iiif/parser/dist/upgrader.js","../../node_modules/.pnpm/@iiif+helpers@1.3.1_@iiif+parser@2.1.8/node_modules/@iiif/helpers/dist/chunk-LVD5NUFB.js","../../node_modules/.pnpm/@iiif+helpers@1.3.1_@iiif+parser@2.1.8/node_modules/@iiif/helpers/dist/chunk-CVU7FGC7.js","../../node_modules/.pnpm/@iiif+parser@2.1.8/node_modules/@iiif/parser/dist/chunk-W3DWL6UZ.js","../../node_modules/.pnpm/@iiif+parser@2.1.8/node_modules/@iiif/parser/dist/chunk-HF3WYIOE.js","../../node_modules/.pnpm/@iiif+helpers@1.3.1_@iiif+parser@2.1.8/node_modules/@iiif/helpers/dist/chunk-F2Q2OM3J.js","../../node_modules/.pnpm/@iiif+helpers@1.3.1_@iiif+parser@2.1.8/node_modules/@iiif/helpers/dist/chunk-EIMQCVDV.js","../../node_modules/.pnpm/@iiif+helpers@1.3.1_@iiif+parser@2.1.8/node_modules/@iiif/helpers/dist/chunk-YAISZCRN.js","../../node_modules/.pnpm/@iiif+helpers@1.3.1_@iiif+parser@2.1.8/node_modules/@iiif/helpers/dist/chunk-DU2KF6VF.js","../../node_modules/.pnpm/@iiif+helpers@1.3.1_@iiif+parser@2.1.8/node_modules/@iiif/helpers/dist/chunk-OFD6EF4T.js","../../node_modules/.pnpm/@iiif+helpers@1.3.1_@iiif+parser@2.1.8/node_modules/@iiif/helpers/dist/chunk-6NZ5BWVI.js","../../node_modules/.pnpm/@iiif+helpers@1.3.1_@iiif+parser@2.1.8/node_modules/@iiif/helpers/dist/chunk-G7A32JAG.js","../../node_modules/.pnpm/@iiif+helpers@1.3.1_@iiif+parser@2.1.8/node_modules/@iiif/helpers/dist/chunk-CWG5H2NE.js","../../node_modules/.pnpm/@iiif+helpers@1.3.1_@iiif+parser@2.1.8/node_modules/@iiif/helpers/dist/chunk-JVB4PJ27.js","../../node_modules/.pnpm/@iiif+helpers@1.3.1_@iiif+parser@2.1.8/node_modules/@iiif/helpers/dist/chunk-UTVB4AT4.js","../../node_modules/.pnpm/@iiif+parser@2.1.8/node_modules/@iiif/parser/dist/image-3.js","../../node_modules/.pnpm/@iiif+helpers@1.3.1_@iiif+parser@2.1.8/node_modules/@iiif/helpers/dist/chunk-4I45SZTR.js","../../node_modules/.pnpm/@iiif+helpers@1.3.1_@iiif+parser@2.1.8/node_modules/@iiif/helpers/dist/chunk-724OMJFL.js","../../node_modules/.pnpm/@iiif+helpers@1.3.1_@iiif+parser@2.1.8/node_modules/@iiif/helpers/dist/chunk-MQJNRTOE.js","../../node_modules/.pnpm/@atlas-viewer+iiif-image-api@2.2.2/node_modules/@atlas-viewer/iiif-image-api/dist/index.js","../src/iiif.ts","../src/ocr.ts","../src/download.ts","../../node_modules/.pnpm/eventemitter3@5.0.1/node_modules/eventemitter3/index.js","../../node_modules/.pnpm/p-timeout@5.1.0/node_modules/p-timeout/index.js","../../node_modules/.pnpm/p-queue@7.4.1/node_modules/p-queue/dist/lower-bound.js","../../node_modules/.pnpm/p-queue@7.4.1/node_modules/p-queue/dist/priority-queue.js","../../node_modules/.pnpm/p-queue@7.4.1/node_modules/p-queue/dist/index.js","../../node_modules/.pnpm/dedent-js@1.0.1/node_modules/dedent-js/lib/index.js","../../node_modules/.pnpm/fflate@0.8.2/node_modules/fflate/esm/browser.js","../src/pdf/util.ts","../src/pdf/common.ts","../src/io.ts","../src/pdf/png.ts","../src/pdf/image.ts","../src/pdf/parser.ts","../src/version.ts","../src/pdf/pkzip.ts","../../node_modules/.pnpm/color-name@1.1.4/node_modules/color-name/index.js","../../node_modules/.pnpm/is-arrayish@0.3.2/node_modules/is-arrayish/index.js","../../node_modules/.pnpm/simple-swizzle@0.2.2/node_modules/simple-swizzle/index.js","../../node_modules/.pnpm/color-string@1.9.1/node_modules/color-string/index.js","../../node_modules/.pnpm/color-convert@2.0.1/node_modules/color-convert/conversions.js","../../node_modules/.pnpm/color-convert@2.0.1/node_modules/color-convert/route.js","../../node_modules/.pnpm/color-convert@2.0.1/node_modules/color-convert/index.js","../../node_modules/.pnpm/color@4.2.3/node_modules/color/index.js","../../node_modules/.pnpm/sax-wasm@2.3.2/node_modules/sax-wasm/lib/esm/saxWasm.js","../src/pdf/annos.ts","../src/pdf/generator.ts","../src/res/licenses.ts","../src/optimization.ts","../src/convert.ts"],"sourcesContent":["type LogLevel = 'debug' | 'info' | 'warn' | 'error';\n\nexport interface Logger {\n  setLevel(level: LogLevel): void;\n  debug(message: string, ...args: any[]): void;\n  info(message: string, ...args: any[]): void;\n  warn(message: string, ...args: any[]): void;\n  error(message: string, ...args: any[]): void;\n}\n\n/** Simple logger that simply outputs to the console */\nexport class ConsoleLogger implements Logger {\n  private level: LogLevel;\n  constructor(level: LogLevel = 'warn') {\n    this.level = level;\n  }\n\n  setLevel(level: LogLevel): void {\n    this.level = level;\n  }\n\n  debug(message: string, ...args: any[]): void {\n    if (this.level === 'debug') {\n      console.debug(message, ...args);\n    }\n  }\n\n  info(message: string, ...args: any[]): void {\n    if (this.level !== 'error' && this.level !== 'warn') {\n      console.info(message, ...args);\n    }\n  }\n\n  warn(message: string, ...args: any[]): void {\n    if (this.level !== 'error') {\n      console.warn(message, ...args);\n    }\n  }\n\n  error(message: string, ...args: any[]): void {\n    console.error(message, ...args);\n  }\n}\n\nlet logger: Logger = new ConsoleLogger();\n\nexport function setLogger(newLogger: Logger): void {\n  logger = newLogger;\n}\n\nexport { logger as default };\n","const E_TIMEOUT = new Error('timeout while waiting for mutex to become available');\nconst E_ALREADY_LOCKED = new Error('mutex already locked');\nconst E_CANCELED = new Error('request for lock canceled');\n\nvar __awaiter$2 = (undefined && undefined.__awaiter) || function (thisArg, _arguments, P, generator) {\n    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }\n    return new (P || (P = Promise))(function (resolve, reject) {\n        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\n        function rejected(value) { try { step(generator[\"throw\"](value)); } catch (e) { reject(e); } }\n        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }\n        step((generator = generator.apply(thisArg, _arguments || [])).next());\n    });\n};\nclass Semaphore {\n    constructor(_value, _cancelError = E_CANCELED) {\n        this._value = _value;\n        this._cancelError = _cancelError;\n        this._weightedQueues = [];\n        this._weightedWaiters = [];\n    }\n    acquire(weight = 1) {\n        if (weight <= 0)\n            throw new Error(`invalid weight ${weight}: must be positive`);\n        return new Promise((resolve, reject) => {\n            if (!this._weightedQueues[weight - 1])\n                this._weightedQueues[weight - 1] = [];\n            this._weightedQueues[weight - 1].push({ resolve, reject });\n            this._dispatch();\n        });\n    }\n    runExclusive(callback, weight = 1) {\n        return __awaiter$2(this, void 0, void 0, function* () {\n            const [value, release] = yield this.acquire(weight);\n            try {\n                return yield callback(value);\n            }\n            finally {\n                release();\n            }\n        });\n    }\n    waitForUnlock(weight = 1) {\n        if (weight <= 0)\n            throw new Error(`invalid weight ${weight}: must be positive`);\n        return new Promise((resolve) => {\n            if (!this._weightedWaiters[weight - 1])\n                this._weightedWaiters[weight - 1] = [];\n            this._weightedWaiters[weight - 1].push(resolve);\n            this._dispatch();\n        });\n    }\n    isLocked() {\n        return this._value <= 0;\n    }\n    getValue() {\n        return this._value;\n    }\n    setValue(value) {\n        this._value = value;\n        this._dispatch();\n    }\n    release(weight = 1) {\n        if (weight <= 0)\n            throw new Error(`invalid weight ${weight}: must be positive`);\n        this._value += weight;\n        this._dispatch();\n    }\n    cancel() {\n        this._weightedQueues.forEach((queue) => queue.forEach((entry) => entry.reject(this._cancelError)));\n        this._weightedQueues = [];\n    }\n    _dispatch() {\n        var _a;\n        for (let weight = this._value; weight > 0; weight--) {\n            const queueEntry = (_a = this._weightedQueues[weight - 1]) === null || _a === void 0 ? void 0 : _a.shift();\n            if (!queueEntry)\n                continue;\n            const previousValue = this._value;\n            const previousWeight = weight;\n            this._value -= weight;\n            weight = this._value + 1;\n            queueEntry.resolve([previousValue, this._newReleaser(previousWeight)]);\n        }\n        this._drainUnlockWaiters();\n    }\n    _newReleaser(weight) {\n        let called = false;\n        return () => {\n            if (called)\n                return;\n            called = true;\n            this.release(weight);\n        };\n    }\n    _drainUnlockWaiters() {\n        for (let weight = this._value; weight > 0; weight--) {\n            if (!this._weightedWaiters[weight - 1])\n                continue;\n            this._weightedWaiters[weight - 1].forEach((waiter) => waiter());\n            this._weightedWaiters[weight - 1] = [];\n        }\n    }\n}\n\nvar __awaiter$1 = (undefined && undefined.__awaiter) || function (thisArg, _arguments, P, generator) {\n    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }\n    return new (P || (P = Promise))(function (resolve, reject) {\n        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\n        function rejected(value) { try { step(generator[\"throw\"](value)); } catch (e) { reject(e); } }\n        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }\n        step((generator = generator.apply(thisArg, _arguments || [])).next());\n    });\n};\nclass Mutex {\n    constructor(cancelError) {\n        this._semaphore = new Semaphore(1, cancelError);\n    }\n    acquire() {\n        return __awaiter$1(this, void 0, void 0, function* () {\n            const [, releaser] = yield this._semaphore.acquire();\n            return releaser;\n        });\n    }\n    runExclusive(callback) {\n        return this._semaphore.runExclusive(() => callback());\n    }\n    isLocked() {\n        return this._semaphore.isLocked();\n    }\n    waitForUnlock() {\n        return this._semaphore.waitForUnlock();\n    }\n    release() {\n        if (this._semaphore.isLocked())\n            this._semaphore.release();\n    }\n    cancel() {\n        return this._semaphore.cancel();\n    }\n}\n\nvar __awaiter = (undefined && undefined.__awaiter) || function (thisArg, _arguments, P, generator) {\n    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }\n    return new (P || (P = Promise))(function (resolve, reject) {\n        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\n        function rejected(value) { try { step(generator[\"throw\"](value)); } catch (e) { reject(e); } }\n        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }\n        step((generator = generator.apply(thisArg, _arguments || [])).next());\n    });\n};\nfunction withTimeout(sync, timeout, timeoutError = E_TIMEOUT) {\n    return {\n        acquire: (weight) => {\n            if (weight !== undefined && weight <= 0) {\n                throw new Error(`invalid weight ${weight}: must be positive`);\n            }\n            return new Promise((resolve, reject) => __awaiter(this, void 0, void 0, function* () {\n                let isTimeout = false;\n                const handle = setTimeout(() => {\n                    isTimeout = true;\n                    reject(timeoutError);\n                }, timeout);\n                try {\n                    const ticket = yield sync.acquire(weight);\n                    if (isTimeout) {\n                        const release = Array.isArray(ticket) ? ticket[1] : ticket;\n                        release();\n                    }\n                    else {\n                        clearTimeout(handle);\n                        resolve(ticket);\n                    }\n                }\n                catch (e) {\n                    if (!isTimeout) {\n                        clearTimeout(handle);\n                        reject(e);\n                    }\n                }\n            }));\n        },\n        runExclusive(callback, weight) {\n            return __awaiter(this, void 0, void 0, function* () {\n                let release = () => undefined;\n                try {\n                    const ticket = yield this.acquire(weight);\n                    if (Array.isArray(ticket)) {\n                        release = ticket[1];\n                        return yield callback(ticket[0]);\n                    }\n                    else {\n                        release = ticket;\n                        return yield callback();\n                    }\n                }\n                finally {\n                    release();\n                }\n            });\n        },\n        release(weight) {\n            sync.release(weight);\n        },\n        cancel() {\n            return sync.cancel();\n        },\n        waitForUnlock: (weight) => {\n            if (weight !== undefined && weight <= 0) {\n                throw new Error(`invalid weight ${weight}: must be positive`);\n            }\n            return new Promise((resolve, reject) => {\n                const handle = setTimeout(() => reject(timeoutError), timeout);\n                sync.waitForUnlock(weight).then(() => {\n                    clearTimeout(handle);\n                    resolve();\n                });\n            });\n        },\n        isLocked: () => sync.isLocked(),\n        getValue: () => sync.getValue(),\n        setValue: (value) => sync.setValue(value),\n    };\n}\n\n// eslint-disable-next-lisne @typescript-eslint/explicit-module-boundary-types\nfunction tryAcquire(sync, alreadyAcquiredError = E_ALREADY_LOCKED) {\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\n    return withTimeout(sync, 0, alreadyAcquiredError);\n}\n\nexport { E_ALREADY_LOCKED, E_CANCELED, E_TIMEOUT, Mutex, Semaphore, tryAcquire, withTimeout };\n","class SaxEventType {\n    // 1\n    static Text = 0b1;\n    // 2\n    static ProcessingInstruction = 0b10;\n    // 4\n    static SGMLDeclaration = 0b100;\n    // 8\n    static Doctype = 0b1000;\n    // 16\n    static Comment = 0b10000;\n    // 32\n    static OpenTagStart = 0b100000;\n    // 64\n    static Attribute = 0b1000000;\n    // 128\n    static OpenTag = 0b10000000;\n    // 256\n    static CloseTag = 0b100000000;\n    // 512\n    static Cdata = 0b1000000000;\n}\nclass Reader {\n    data;\n    cache = {};\n    ptr;\n    constructor(data, ptr = 0) {\n        this.data = data;\n        this.ptr = ptr;\n    }\n}\nclass Position {\n    line;\n    character;\n    constructor(line, character) {\n        this.line = line;\n        this.character = character;\n    }\n}\nvar AttributeType;\n(function (AttributeType) {\n    AttributeType[AttributeType[\"Normal\"] = 0] = \"Normal\";\n    AttributeType[AttributeType[\"JSX\"] = 1] = \"JSX\";\n})(AttributeType || (AttributeType = {}));\nclass Attribute extends Reader {\n    type;\n    name;\n    value;\n    constructor(buffer, ptr = 0) {\n        super(buffer, ptr);\n        this.type = buffer[ptr];\n        ptr += 1;\n        const len = readU32(buffer, ptr);\n        ptr += 4;\n        this.name = new Text(buffer, ptr);\n        ptr += len;\n        this.value = new Text(buffer, ptr);\n    }\n    toJSON() {\n        const { name, value, type } = this;\n        return { name, value, type };\n    }\n    toString() {\n        const { name, value } = this;\n        return `${name}=\"${value}\"`;\n    }\n}\nclass ProcInst extends Reader {\n    target;\n    content;\n    constructor(buffer, ptr = 0) {\n        super(buffer, ptr);\n        ptr += 16;\n        const len = readU32(buffer, ptr);\n        ptr += 4;\n        this.target = new Text(buffer, ptr);\n        ptr += len;\n        this.content = new Text(buffer, ptr);\n    }\n    get start() {\n        return this.cache.start || (this.cache.start = readPosition(this.data, this.ptr));\n    }\n    get end() {\n        return this.cache.end || (this.cache.end = readPosition(this.data, this.ptr + 8));\n    }\n    toJSON() {\n        const { start, end, target, content } = this;\n        return { start, end, target, content };\n    }\n    toString() {\n        const { target, content } = this;\n        return `<? ${target} ${content} ?>`;\n    }\n}\nclass Text extends Reader {\n    get start() {\n        return this.cache.start || (this.cache.start = readPosition(this.data, this.ptr));\n    }\n    get end() {\n        return this.cache.end || (this.cache.end = readPosition(this.data, this.ptr + 8));\n    }\n    get value() {\n        if (this.cache.value) {\n            return this.cache.value;\n        }\n        const valueLen = readU32(this.data, this.ptr + 16);\n        return (this.cache.value = readString(this.data, this.ptr + 20, valueLen));\n    }\n    toJSON() {\n        const { start, end, value } = this;\n        return { start, end, value };\n    }\n    toString() {\n        return this.value;\n    }\n}\nclass Tag extends Reader {\n    get openStart() {\n        return this.cache.openStart || (this.cache.openStart = readPosition(this.data, this.ptr + 8));\n    }\n    get openEnd() {\n        return this.cache.openEnd || (this.cache.openEnd = readPosition(this.data, this.ptr + 16));\n    }\n    get closeStart() {\n        return this.cache.closeStart || (this.cache.closeStart = readPosition(this.data, this.ptr + 24));\n    }\n    get closeEnd() {\n        return this.cache.closeEnd || (this.cache.closeEnd = readPosition(this.data, this.ptr + 32));\n    }\n    get selfClosing() {\n        return !!this.data[this.ptr + 40];\n    }\n    get name() {\n        if (this.cache.name) {\n            return this.cache.name;\n        }\n        const nameLen = readU32(this.data, this.ptr + 41);\n        return (this.cache.name = readString(this.data, this.ptr + 45, nameLen));\n    }\n    get attributes() {\n        if (this.cache.attributes) {\n            return this.cache.attributes;\n        }\n        // starting location of the attribute block\n        let ptr = readU32(this.data, this.ptr);\n        const numAttrs = readU32(this.data, ptr);\n        ptr += 4;\n        const attributes = [];\n        for (let i = 0; i < numAttrs; i++) {\n            const attrLen = readU32(this.data, ptr);\n            ptr += 4;\n            attributes[i] = new Attribute(this.data, ptr);\n            ptr += attrLen;\n        }\n        return (this.cache.attributes = attributes);\n    }\n    get textNodes() {\n        if (this.cache.textNodes) {\n            return this.cache.textNodes;\n        }\n        // starting location of the text nodes block\n        let ptr = readU32(this.data, this.ptr + 4);\n        const numTextNodes = readU32(this.data, ptr);\n        const textNodes = [];\n        ptr += 4;\n        for (let i = 0; i < numTextNodes; i++) {\n            const textLen = readU32(this.data, ptr);\n            ptr += 4;\n            textNodes[i] = new Text(this.data, ptr);\n            ptr += textLen;\n        }\n        return (this.cache.textNodes = textNodes);\n    }\n    toJSON() {\n        const { openStart, openEnd, closeStart, closeEnd, name, attributes, textNodes, selfClosing } = this;\n        return { openStart, openEnd, closeStart, closeEnd, name, attributes, textNodes, selfClosing };\n    }\n    get value() {\n        return this.name;\n    }\n}\nclass SAXParser {\n    static textDecoder; // Web only\n    events;\n    wasmSaxParser;\n    eventHandler;\n    options;\n    writeBuffer;\n    constructor(events = 0, options = { highWaterMark: 32 * 1024 }) {\n        this.options = options;\n        const self = this;\n        Object.defineProperties(this, {\n            events: {\n                get: () => ~~events,\n                set: (value) => {\n                    events = ~~value;\n                    if (self.wasmSaxParser) {\n                        self.wasmSaxParser.parser(events);\n                    }\n                }, configurable: false, enumerable: true\n            }\n        });\n    }\n    write(chunk) {\n        if (!this.wasmSaxParser) {\n            return;\n        }\n        const { write, memory } = this.wasmSaxParser;\n        // Allocations within the WASM process\n        // invalidate reference to the memory buffer.\n        // We check for this and create a new Uint8Array\n        // with the new memory buffer reference if needed.\n        // **NOTE** These allocations can slow down parsing\n        // if they become excessive. Consider adjusting the\n        // highWaterMark in the options up or down to find the optimal\n        // memory allocation to prevent too many new Uint8Array instances.\n        if (!this.writeBuffer || this.writeBuffer.buffer !== memory.buffer) {\n            this.writeBuffer = new Uint8Array(memory.buffer);\n        }\n        this.writeBuffer.set(chunk, 0);\n        write(0, chunk.byteLength);\n    }\n    end() {\n        this.writeBuffer = undefined;\n        this.wasmSaxParser?.end();\n    }\n    async prepareWasm(saxWasm) {\n        let result;\n        if (saxWasm instanceof Uint8Array) {\n            result = await WebAssembly.instantiate(saxWasm, {\n                env: {\n                    memoryBase: 0,\n                    tableBase: 0,\n                    memory: new WebAssembly.Memory({ initial: 10 }),\n                    table: new WebAssembly.Table({ initial: 1, element: 'anyfunc' }),\n                    event_listener: this.eventTrap\n                }\n            });\n        }\n        else {\n            result = await WebAssembly.instantiateStreaming(saxWasm);\n        }\n        if (result && typeof this.events === 'number') {\n            const { parser } = this.wasmSaxParser = result.instance.exports;\n            parser(this.events);\n            return true;\n        }\n        throw new Error(`Failed to instantiate the parser.`);\n    }\n    eventTrap = (event, ptr, len) => {\n        if (!this.wasmSaxParser) {\n            return;\n        }\n        const uint8array = new Uint8Array(this.wasmSaxParser.memory.buffer, ptr, len).slice();\n        let detail;\n        switch (event) {\n            case SaxEventType.Attribute:\n                detail = new Attribute(uint8array);\n                break;\n            case SaxEventType.ProcessingInstruction:\n                detail = new ProcInst(uint8array);\n                break;\n            case SaxEventType.OpenTag:\n            case SaxEventType.CloseTag:\n            case SaxEventType.OpenTagStart:\n                detail = new Tag(uint8array);\n                break;\n            case SaxEventType.Text:\n            case SaxEventType.Cdata:\n            case SaxEventType.Comment:\n            case SaxEventType.Doctype:\n            case SaxEventType.SGMLDeclaration:\n                detail = new Text(uint8array);\n                break;\n            default:\n                throw new Error('No reader for this event type');\n        }\n        if (this.eventHandler) {\n            this.eventHandler(event, detail);\n        }\n    };\n}\nconst readString = (data, offset, length) => {\n    // Node\n    if (globalThis.hasOwnProperty('Buffer')) {\n        return Buffer.from(data.buffer, data.byteOffset + offset, length).toString();\n    }\n    // Web\n    return (SAXParser.textDecoder || (SAXParser.textDecoder = new TextDecoder()))\n        .decode(data.subarray(offset, offset + length));\n};\nconst readU32 = (uint8Array, ptr) => (uint8Array[ptr + 3] << 24) | (uint8Array[ptr + 2] << 16) | (uint8Array[ptr + 1] << 8) | uint8Array[ptr];\nconst readPosition = (uint8Array, ptr = 0) => {\n    const line = readU32(uint8Array, ptr);\n    const character = readU32(uint8Array, ptr + 4);\n    return new Position(line, character);\n};\n\nexport { Attribute, AttributeType, Position, ProcInst, Reader, SAXParser, SaxEventType, Tag, Text };\n","// src/hocr.ts\nimport { SaxEventType as SaxEventType2 } from \"sax-wasm\";\n\n// src/model.ts\nfunction makeLine(spec) {\n  return {\n    ...spec,\n    type: \"line\",\n    children: [],\n    get words() {\n      return this.children.filter((c) => typeof c !== \"string\");\n    },\n    get text() {\n      return this.children.map((c) => typeof c === \"string\" ? c : c.text).join(\"\");\n    }\n  };\n}\nfunction makeParagraph(spec) {\n  return {\n    ...spec,\n    type: \"paragraph\",\n    children: [],\n    get lines() {\n      return this.children;\n    },\n    get words() {\n      return this.children.flatMap((l) => l.words);\n    },\n    get text() {\n      var _a;\n      const out = [];\n      for (const [idx, child] of this.children.entries()) {\n        out.push(child.text);\n        if (idx < this.children.length - 1 && !((_a = child.words.slice(-1)[0]) == null ? void 0 : _a.hyphenStart)) {\n          out.push(\" \");\n        }\n      }\n      return out.join(\"\");\n    }\n  };\n}\nfunction makeBlock(spec) {\n  return {\n    ...spec,\n    type: \"block\",\n    children: [],\n    get paragraphs() {\n      return this.children.filter((c) => \"lines\" in c);\n    },\n    get lines() {\n      return this.children.reduce((acc, c) => {\n        if (\"lines\" in c) {\n          acc.push(...c.lines);\n        } else if (\"words\" in c) {\n          acc.push(c);\n        }\n        return acc;\n      }, []);\n    },\n    get words() {\n      return this.lines.flatMap((l) => l.words);\n    },\n    get text() {\n      var _a;\n      const out = [];\n      for (const [idx, child] of this.children.entries()) {\n        out.push(child.text);\n        if (idx < this.children.length - 1 && !((_a = child.words.slice(-1)[0]) == null ? void 0 : _a.hyphenStart)) {\n          if (child.type === \"line\") {\n            out.push(\" \");\n          } else {\n            out.push(\"\\n\");\n          }\n        }\n      }\n      return out.join(\"\");\n    }\n  };\n}\nfunction makePage(spec) {\n  return {\n    ...spec,\n    type: \"page\",\n    children: [],\n    get blocks() {\n      return this.children.filter((c) => \"paragraphs\" in c);\n    },\n    get paragraphs() {\n      return this.children.reduce((acc, c) => {\n        if (\"paragraphs\" in c) {\n          acc.push(...c.paragraphs);\n        } else if (\"lines\" in c) {\n          acc.push(c);\n        }\n        return acc;\n      }, []);\n    },\n    get lines() {\n      return this.children.reduce((acc, c) => {\n        if (\"lines\" in c) {\n          acc.push(...c.lines);\n        } else if (\"words\" in c) {\n          acc.push(c);\n        }\n        return acc;\n      }, []);\n    },\n    get words() {\n      return this.children.flatMap((l) => l.words);\n    },\n    get text() {\n      var _a;\n      const out = [];\n      for (const [idx, child] of this.children.entries()) {\n        out.push(child.text);\n        if (idx < this.children.length - 1 && !((_a = child.words.slice(-1)[0]) == null ? void 0 : _a.hyphenStart)) {\n          if (child.type === \"line\") {\n            out.push(\" \");\n          } else {\n            out.push(\"\\n\");\n          }\n        }\n      }\n      return out.join(\"\");\n    }\n  };\n}\n\n// src/util.ts\nimport {\n  SAXParser,\n  SaxEventType\n} from \"sax-wasm\";\nvar SAX_WASM_VERSION = \"2.2.4\";\nvar xmlParserWasm = null;\nvar logger = {\n  debug: console.debug,\n  info: console.info,\n  warn: console.warn,\n  error: console.error\n};\nasync function initialize(loadSaxWasm = () => fetch(`https://unpkg.com/sax-wasm@${SAX_WASM_VERSION}/lib/sax-wasm.wasm`).then((res) => res.arrayBuffer()).then((buf) => new Uint8Array(buf))) {\n  xmlParserWasm = await loadSaxWasm();\n}\nfunction isInitialized() {\n  return xmlParserWasm !== null;\n}\nasync function getParser(readable, events) {\n  const parser = new StaxParser(\n    readable,\n    events != null ? events : /* @__PURE__ */ new Set([\n      SaxEventType.OpenTag,\n      SaxEventType.Text,\n      SaxEventType.CloseTag\n    ]),\n    {\n      highWaterMark: 64 * 1024\n    }\n  );\n  if (!isInitialized()) {\n    throw new Error(\n      \"XML parser WASM not initialized, call initialize() first!\"\n    );\n  }\n  const ready = await parser.prepareWasm(xmlParserWasm);\n  if (!ready) {\n    throw new Error(\"Failed to initialize parser with WASM\");\n  }\n  return parser;\n}\nvar NUMERIC_ENTITY_REGEX = /&#(\\d+);/g;\nvar HEX_ENTITY_REGEX = /&#x([A-Fa-f0-9]+);/g;\nvar ENTITY_MAP = {\n  amp: \"&\",\n  apos: \"'\",\n  quot: '\"',\n  lt: \"<\",\n  gt: \">\"\n};\nvar ENTITY_REGEX = new RegExp(\n  `&(${Object.keys(ENTITY_MAP).join(\"|\")});`,\n  \"g\"\n);\nfunction resolveXmlEntities(str) {\n  str = str.replace(ENTITY_REGEX, function(match, entity) {\n    return ENTITY_MAP[entity];\n  });\n  str = str.replace(NUMERIC_ENTITY_REGEX, function(match, entityCode) {\n    const decimalCode = parseInt(entityCode, 10);\n    return String.fromCharCode(decimalCode);\n  });\n  str = str.replace(HEX_ENTITY_REGEX, function(match, entityCode) {\n    const decimalCode = parseInt(entityCode, 16);\n    return String.fromCharCode(decimalCode);\n  });\n  return str;\n}\nfunction toReadableStream(data) {\n  const encoder = new TextEncoder();\n  return new ReadableStream({\n    start(controller) {\n      controller.enqueue(\n        data instanceof Uint8Array ? data : encoder.encode(data)\n      );\n      controller.close();\n    }\n  });\n}\nfunction getAttributeValue(tag, attrName) {\n  var _a;\n  const attr = tag.attributes.find((a) => a.name.value === attrName);\n  return (_a = attr == null ? void 0 : attr.value) == null ? void 0 : _a.value;\n}\nfunction getAllAttributes(tag) {\n  return Object.fromEntries(\n    tag.attributes.map((a) => [a.name.value, a.value.value])\n  );\n}\nvar StaxParser = class {\n  constructor(readable, events, options) {\n    this.accumulator = [];\n    this.readable = readable;\n    let eventMask;\n    if (events) {\n      eventMask = 0;\n      for (const event of events) {\n        eventMask |= event;\n      }\n    }\n    this.saxParser = new SAXParser(eventMask, options);\n    this.saxParser.eventHandler = (type, detail) => this.accumulator.push([type, detail]);\n  }\n  prepareWasm(wasm) {\n    return this.saxParser.prepareWasm(xmlParserWasm);\n  }\n  [Symbol.asyncIterator]() {\n    return this.iterate();\n  }\n  async *iterate() {\n    const reader = this.readable.getReader();\n    try {\n      while (true) {\n        const chunk = await reader.read();\n        if (chunk.done) {\n          break;\n        }\n        this.saxParser.write(chunk.value);\n        while (this.accumulator.length > 0) {\n          yield this.accumulator.shift();\n        }\n      }\n    } finally {\n      reader.releaseLock();\n    }\n    while (this.accumulator.length > 0) {\n      yield this.accumulator.shift();\n    }\n  }\n};\nfunction setupLogging(l) {\n  if (l) {\n    logger = l;\n  } else {\n    logger = {\n      debug: () => {\n      },\n      info: () => {\n      },\n      warn: () => {\n      },\n      error: console.error\n    };\n  }\n}\nfunction logWithPosition(msg, level = \"log\", tag) {\n  console[level](\n    `At line ${tag.openStart.line}, column ${tag.openStart.character}: ${msg}`\n  );\n}\n\n// src/hocr.ts\nfunction parseHocrAttribs(tag) {\n  const titleAttrib = getAttributeValue(tag, \"title\");\n  if (!titleAttrib) {\n    return {};\n  }\n  const vals = titleAttrib.split(\";\").map((x) => x.trim());\n  return vals.reduce((acc, val) => {\n    const key = val.split(\" \")[0];\n    if (key === \"bbox\") {\n      acc[key] = val.split(\" \").slice(1, 5).map((x) => Number.parseInt(x, 10));\n    } else {\n      acc[key] = val.split(\" \").slice(1, 5).join(\" \");\n      if (acc[key].startsWith('\"') && acc[key].endsWith('\"')) {\n        acc[key] = acc[key].slice(1, -1);\n      }\n    }\n    return acc;\n  }, {});\n}\nfunction parsePolygon(polyAttr, scaleFactor) {\n  return polyAttr.split(\" \").map((x) => Number.parseFloat(x)).reduce((acc, c) => {\n    const last = acc.slice(-1)[0];\n    if (!last || last.length === 2) {\n      acc.push([c]);\n    } else {\n      last.push(c);\n    }\n    return acc;\n  }, []).map(([x, y]) => ({ x: scaleFactor * x, y: scaleFactor * y }));\n}\nasync function handleChildren(eventIter, allowedTypes, ctx) {\n  let openTags = 0;\n  let result;\n  while (openTags >= 0 && !(result = await eventIter.next()).done) {\n    const [evt, data] = result.value;\n    if (evt === SaxEventType2.Text && allowedTypes.has(\"text\")) {\n      const parentElem = ctx.elementStack.slice(-1)[0];\n      if (typeof parentElem !== \"string\" && parentElem.type === \"line\") {\n        const txt = data.value.replace(/\\s+/g, \" \");\n        const whitespaceOnly = txt === \" \";\n        if ((parentElem.children.length > 0 || !whitespaceOnly) && !(parentElem.children.slice(-1)[0] === \" \" && whitespaceOnly)) {\n          parentElem.children.push(txt);\n        }\n      }\n    }\n    if (evt === SaxEventType2.CloseTag) {\n      openTags--;\n    }\n    if (evt !== SaxEventType2.OpenTag) {\n      continue;\n    }\n    openTags++;\n    const tag = data;\n    const hocrType = getHocrType(tag);\n    if (hocrType === null) {\n      continue;\n    }\n    if (!allowedTypes.has(hocrType)) {\n      logWithPosition(\n        `Unexpected hOCR element type: ${hocrType}, expected one of [${Array.from(\n          allowedTypes\n        ).join(\", \")}]`,\n        \"warn\",\n        tag\n      );\n      continue;\n    }\n    switch (hocrType) {\n      case \"block\":\n        await handleBlock(eventIter, tag, ctx);\n        openTags--;\n        break;\n      case \"paragraph\":\n        await handleParagraph(eventIter, tag, ctx);\n        openTags--;\n        break;\n      case \"line\":\n        await handleLine(eventIter, tag, ctx);\n        openTags--;\n        break;\n      case \"word\":\n        await handleWord(eventIter, tag, ctx);\n        openTags--;\n        break;\n      default:\n        break;\n    }\n  }\n  ctx.elementStack.pop();\n}\nasync function handlePage(eventIter, tag, ctx, referenceSize) {\n  var _a;\n  const hocrAttribs = parseHocrAttribs(tag);\n  const pageSize = hocrAttribs.bbox;\n  ctx.scaleFactor = referenceSize ? determineScaleFactor(pageSize, referenceSize) : 1;\n  const page = makePage({\n    features: [],\n    width: pageSize[2] * ctx.scaleFactor,\n    height: pageSize[3] * ctx.scaleFactor\n  });\n  if (\"ppageno\" in hocrAttribs) {\n    page.physicalPageNumber = Number.parseInt(hocrAttribs.ppageno, 10);\n  }\n  if (\"lpageno\" in hocrAttribs) {\n    page.logicalPageNumber = hocrAttribs.lpageno;\n  }\n  if (\"image\" in hocrAttribs) {\n    page.imageSource = {\n      fileName: hocrAttribs.image\n    };\n  }\n  if (\"x_source\" in hocrAttribs) {\n    if (!page.imageSource) {\n      page.imageSource = {};\n    }\n    page.imageSource.documentIdentifier = hocrAttribs.x_source;\n  }\n  if (\"imagemd5\" in hocrAttribs) {\n    if (!page.imageSource) {\n      page.imageSource = {};\n    }\n    page.imageSource.checksum = hocrAttribs.imagemd5;\n    page.imageSource.checksumType = \"MD5\";\n  }\n  if (\"scan_res\" in hocrAttribs) {\n    if (!page.imageSource) {\n      page.imageSource = {};\n    }\n    page.imageSource.ppi = Number.parseInt(hocrAttribs.scan_res.split(\" \")[0], 10);\n  }\n  ctx.elementStack.push(page);\n  await handleChildren(\n    eventIter,\n    /* @__PURE__ */ new Set([\"block\", \"paragraph\", \"line\"]),\n    ctx\n  );\n  for (const elem of [\"blocks\", \"paragraphs\", \"lines\"]) {\n    if (((_a = page[elem]) != null ? _a : []).some((e) => e.polygon !== void 0)) {\n      page.features.push(\"POLYGONS\");\n    }\n  }\n  if (page.words.some((w) => w.choices !== void 0)) {\n    page.features.push(\"CHOICES\");\n  }\n  if (page.words.some((w) => w.hyphenStart)) {\n    page.features.push(\"HYPHEN\");\n  }\n  if (page.words.some((w) => w.confidence !== void 0)) {\n    page.features.push(\"CONFIDENCE\");\n  }\n  return page;\n}\nasync function handleBlock(eventIter, tag, ctx) {\n  const hocrAttribs = parseHocrAttribs(tag);\n  const [ulx, uly, lrx, lry] = hocrAttribs.bbox.map(\n    (dim) => dim * ctx.scaleFactor\n  );\n  const block = makeBlock({\n    x: ulx,\n    y: uly,\n    width: lrx - ulx,\n    height: lry - uly\n  });\n  if (\"poly\" in hocrAttribs) {\n    block.polygon = parsePolygon(hocrAttribs.poly, ctx.scaleFactor);\n  }\n  ctx.elementStack.slice(-1)[0].children.push(block);\n  ctx.elementStack.push(block);\n  await handleChildren(eventIter, /* @__PURE__ */ new Set([\"paragraph\", \"line\"]), ctx);\n}\nasync function handleParagraph(eventIter, tag, ctx) {\n  const hocrAttribs = parseHocrAttribs(tag);\n  let x;\n  let y;\n  let width;\n  let height;\n  if (hocrAttribs.bbox) {\n    const coords = hocrAttribs.bbox.map(\n      (dim) => dim * ctx.scaleFactor\n    );\n    x = coords[0];\n    y = coords[1];\n    width = coords[2] - x;\n    height = coords[3] - y;\n  }\n  const paragraph = makeParagraph({\n    x,\n    y,\n    width,\n    height\n  });\n  if (\"poly\" in hocrAttribs) {\n    paragraph.polygon = parsePolygon(hocrAttribs.poly, ctx.scaleFactor);\n  }\n  const parentElem = ctx.elementStack.slice(-1)[0];\n  parentElem.children.push(paragraph);\n  ctx.elementStack.push(paragraph);\n  await handleChildren(eventIter, /* @__PURE__ */ new Set([\"line\"]), ctx);\n}\nasync function handleLine(eventIter, tag, ctx) {\n  const parsedAttribs = parseHocrAttribs(tag);\n  if (!(\"bbox\" in parsedAttribs)) {\n    logWithPosition(\"Missing bbox attribute on line element\", \"warn\", tag);\n    return;\n  }\n  const [ulx, uly, lrx, lry] = parsedAttribs.bbox.map(\n    (dim) => dim * ctx.scaleFactor\n  );\n  const line = makeLine({\n    x: ulx,\n    y: uly,\n    width: lrx - ulx,\n    height: lry - uly\n  });\n  if (\"poly\" in parsedAttribs) {\n    line.polygon = parsePolygon(parsedAttribs.poly, ctx.scaleFactor);\n  }\n  if (\"baseline\" in parsedAttribs) {\n    const parts = parsedAttribs.baseline.split(\" \");\n    const slope = Number.parseFloat(parts[0]);\n    const intercept = Number.parseInt(parts[1], 10);\n    const ulx2 = line.x;\n    const uly2 = line.y;\n    line.baseline = [\n      { x: ulx2, y: uly2 + intercept },\n      { x: ulx2 + line.width, y: uly2 + intercept + line.width * slope }\n    ];\n  }\n  const parentElem = ctx.elementStack.slice(-1)[0];\n  parentElem.children.push(line);\n  ctx.elementStack.push(line);\n  await handleChildren(eventIter, /* @__PURE__ */ new Set([\"word\", \"text\"]), ctx);\n  if (line.children.slice(-1)[0] === \" \") {\n    line.children = line.children.slice(0, -1);\n  }\n  const needsNormalization = line.words.some(\n    (w) => w.confidence !== void 0 && w.confidence > 1\n  );\n  if (needsNormalization) {\n    for (const word of line.words) {\n      if (word.confidence !== void 0) {\n        word.confidence /= 100;\n      }\n    }\n  }\n}\nasync function handleWord(eventIter, tag, ctx) {\n  const parsedAttribs = parseHocrAttribs(tag);\n  const [ulx, uly, lrx, lry] = parsedAttribs.bbox.map(\n    (dim) => dim * ctx.scaleFactor\n  );\n  let wordText = \"\";\n  let wordChoices;\n  let openTags = 0;\n  while (openTags >= 0) {\n    const result = await eventIter.next();\n    if (result.done) {\n      throw new Error(\"Unexpected end of stream while parsing word\");\n    }\n    const [evt, data] = result.value;\n    if (evt === SaxEventType2.OpenTag) {\n      openTags++;\n      const tag2 = data;\n      if (tag2.name === \"span\" && getHocrType(tag2) === \"alternatives\") {\n        wordChoices = [];\n      }\n    } else if (evt === SaxEventType2.CloseTag) {\n      openTags--;\n      const tag2 = data;\n      if (wordChoices && tag2.name === \"ins\") {\n        wordText = tag2.textNodes.map((t) => t.value.trim()).join(\"\");\n      } else if (wordChoices && tag2.name === \"del\") {\n        const nlp = getAttributeValue(tag2, \"nlp\");\n        const choice = {\n          text: tag2.textNodes.map((t) => t.value.trim()).join(\"\")\n        };\n        if (choice.text.includes(\"&\")) {\n          choice.text = resolveXmlEntities(choice.text);\n        }\n        if (nlp) {\n          choice.probability = Math.exp(-Number.parseFloat(nlp));\n        }\n        wordChoices.push(choice);\n      }\n    } else if (evt === SaxEventType2.Text && !wordChoices) {\n      const txt = data.value;\n      wordText += txt.trim();\n    }\n  }\n  if (!wordText.length) {\n    logWithPosition(\"Word element has no text, skipping.\", \"debug\", tag);\n    return;\n  }\n  const word = {\n    type: \"word\",\n    x: ulx,\n    y: uly,\n    width: lrx - ulx,\n    height: lry - uly,\n    text: wordText\n  };\n  if (wordChoices == null ? void 0 : wordChoices.length) {\n    word.choices = wordChoices;\n  }\n  word.hyphenStart = word.text.endsWith(\"\\xAD\");\n  if (word.hyphenStart) {\n    word.text = word.text.slice(0, -1);\n  }\n  if (word.text.includes(\"&\")) {\n    word.text = resolveXmlEntities(word.text);\n  }\n  if (\"poly\" in parsedAttribs) {\n    word.polygon = parsePolygon(parsedAttribs.poly, ctx.scaleFactor);\n  }\n  if (\"x_wconf\" in parsedAttribs) {\n    word.confidence = Number.parseFloat(parsedAttribs.x_wconf);\n  }\n  ctx.elementStack.slice(-1)[0].children.push(word);\n}\nfunction determineScaleFactor(pageSize, referenceSize) {\n  if (pageSize[2] === referenceSize.width && pageSize[3] === referenceSize.height) {\n    return 1;\n  }\n  const scaleFactorX = referenceSize.width / pageSize[2];\n  const scaleFactorY = referenceSize.height / pageSize[3];\n  const scaledWidth = Math.round(scaleFactorY * pageSize[2]);\n  const scaledHeight = Math.round(scaleFactorX * pageSize[3]);\n  if (scaledWidth !== referenceSize.width || scaledHeight !== referenceSize.height) {\n    console.warn(\n      `Differing scale factors for x and y axis while parsing hOCR, will use X factor: x=${scaleFactorX}, y=${scaleFactorY}`\n    );\n  }\n  return scaleFactorX;\n}\nfunction getHocrType(tag) {\n  const hocrType = getAttributeValue(tag, \"class\");\n  switch (hocrType) {\n    case \"ocr_page\":\n      return \"page\";\n    case \"ocr_carea\":\n    case \"ocrx_block\":\n      return \"block\";\n    case \"ocr_par\":\n      return \"paragraph\";\n    case \"ocr_line\":\n    case \"ocrx_line\":\n      return \"line\";\n    case \"ocrx_word\":\n      return \"word\";\n    case \"ocrx_cinfo\":\n      return \"char\";\n    case \"alternatives\":\n      return \"alternatives\";\n    case \"alt\":\n      return \"alt\";\n    default:\n      return null;\n  }\n}\nasync function* parseHocrPages(hocr, referenceSizes) {\n  var _a;\n  if (Array.isArray(referenceSizes)) {\n    const sizeArr = referenceSizes;\n    referenceSizes = (idx) => {\n      var _a2;\n      return (_a2 = sizeArr[idx]) != null ? _a2 : null;\n    };\n  }\n  const readable = typeof hocr === \"string\" || hocr instanceof Uint8Array ? toReadableStream(hocr) : hocr;\n  const parser = await getParser(readable);\n  const ctx = {\n    scaleFactor: 1,\n    elementStack: []\n  };\n  let pageIdx = 0;\n  const eventIter = parser.iterate();\n  let result;\n  while (!(result = await eventIter.next()).done) {\n    const [evt, data] = result.value;\n    if (evt !== SaxEventType2.OpenTag || data.name !== \"div\" || getHocrType(data) !== \"page\") {\n      continue;\n    }\n    const page = await handlePage(\n      eventIter,\n      data,\n      ctx,\n      (_a = referenceSizes == null ? void 0 : referenceSizes(pageIdx, getAllAttributes(data))) != null ? _a : void 0\n    );\n    if (!page) {\n      continue;\n    }\n    yield page;\n  }\n}\n\n// src/alto.ts\nimport { SaxEventType as SaxEventType3 } from \"sax-wasm\";\nvar NUMERIC_ATTRIBS = [\"HEIGHT\", \"WIDTH\", \"HPOS\", \"VPOS\", \"WC\"];\nfunction getAttributes(data, names) {\n  return Object.fromEntries(\n    data.attributes.filter((attr) => !names || names.includes(attr.name.value)).map((attr) => [\n      attr.name.value,\n      NUMERIC_ATTRIBS.includes(attr.name.value) ? Number.parseFloat(attr.value.value) : attr.value.value\n    ])\n  );\n}\nfunction getCoordinates(data) {\n  const attrs = getAttributes(data, [\"HEIGHT\", \"WIDTH\", \"HPOS\", \"VPOS\"]);\n  return {\n    height: attrs.HEIGHT,\n    width: attrs.WIDTH,\n    x: attrs.HPOS,\n    y: attrs.VPOS\n  };\n}\nasync function handlePage2(eventIter, ctx, tag, referenceSize) {\n  var _a;\n  const dims = getCoordinates(tag);\n  if (!dims.width || !dims.height) {\n    throw new Error(\"Could not get Page dimensions\");\n  }\n  const scaleFactorX = referenceSize ? referenceSize.width / dims.width : 1;\n  const scaleFactorY = referenceSize ? referenceSize.height / dims.height : 1;\n  if (scaleFactorX !== scaleFactorY) {\n    console.warn(\n      `Scale factors differ: x=${scaleFactorX} vs y=${scaleFactorY}, using X scale factor.`\n    );\n  }\n  ctx.scaleFactor = scaleFactorX;\n  const page = makePage({\n    features: [],\n    width: dims.width * scaleFactorX,\n    height: dims.height * scaleFactorX\n  });\n  ctx.elementStack.push(page);\n  const pageAttribs = getAllAttributes(tag);\n  if (\"PHYSICAL_IMG_NR\" in pageAttribs) {\n    page.physicalPageNumber = Number.parseInt(pageAttribs.PHYSICAL_IMG_NR);\n  }\n  if (\"PRINTED_IMG_NR\" in pageAttribs) {\n    page.logicalPageNumber = pageAttribs.PRINTED_IMG_NR;\n  }\n  let openTags = 0;\n  let result;\n  while (openTags >= 0 && !(result = await eventIter.next()).done) {\n    const [evt, data] = result.value;\n    if (evt === SaxEventType3.CloseTag) {\n      openTags--;\n    } else if (evt !== SaxEventType3.OpenTag) {\n      continue;\n    }\n    openTags++;\n    const tag2 = data;\n    if (tag2.name === \"TextBlock\") {\n      await handleBlock2(eventIter, ctx, data);\n    }\n  }\n  ctx.elementStack.pop();\n  for (const elem of [\"blocks\", \"paragraphs\", \"lines\"]) {\n    if (((_a = page[elem]) != null ? _a : []).some((e) => e.polygon !== void 0)) {\n      page.features.push(\"POLYGONS\");\n    }\n  }\n  if (page.words.some((w) => w.choices !== void 0)) {\n    page.features.push(\"CHOICES\");\n  }\n  if (page.words.some((w) => w.hyphenStart)) {\n    page.features.push(\"HYPHEN\");\n  }\n  if (page.words.some((w) => w.confidence !== void 0)) {\n    page.features.push(\"CONFIDENCE\");\n  }\n  if (ctx.sourceImageInformation) {\n    page.imageSource = ctx.sourceImageInformation;\n    ctx.sourceImageInformation = void 0;\n  }\n  return page;\n}\nasync function handleBlock2(eventIter, ctx, tag) {\n  const dims = getCoordinates(tag);\n  const block = makeBlock({\n    x: dims.x ? dims.x * ctx.scaleFactor : -1,\n    y: dims.y ? dims.y * ctx.scaleFactor : -1,\n    width: dims.width ? dims.width * ctx.scaleFactor : -1,\n    height: dims.height ? dims.height * ctx.scaleFactor : -1\n  });\n  ctx.elementStack.slice(-1)[0].children.push(block);\n  ctx.elementStack.push(block);\n  let openTags = 0;\n  let result;\n  while (openTags >= 0 && !(result = await eventIter.next()).done) {\n    const [evt, data] = result.value;\n    if (evt === SaxEventType3.CloseTag) {\n      openTags--;\n    } else if (evt !== SaxEventType3.OpenTag) {\n      continue;\n    }\n    openTags++;\n    const tag2 = data;\n    if (tag2.name === \"TextLine\") {\n      await handleLine2(eventIter, ctx, data);\n    } else if (tag2.name === \"Shape\") {\n      const polygon = await handleShape(eventIter, ctx, tag2);\n      if (polygon != null) {\n        block.polygon = polygon;\n      }\n    }\n  }\n  ctx.elementStack.pop();\n}\nasync function handleLine2(eventIter, ctx, tag) {\n  const dims = getCoordinates(tag);\n  const line = makeLine({\n    x: dims.x ? dims.x * ctx.scaleFactor : -1,\n    y: dims.y ? dims.y * ctx.scaleFactor : -1,\n    width: dims.width ? dims.width * ctx.scaleFactor : -1,\n    height: dims.height ? dims.height * ctx.scaleFactor : -1\n  });\n  ctx.elementStack.slice(-1)[0].children.push(line);\n  ctx.elementStack.push(line);\n  let openTags = 0;\n  let result;\n  while (openTags >= 0 && !(result = await eventIter.next()).done) {\n    const [evt, data] = result.value;\n    if (evt === SaxEventType3.CloseTag) {\n      openTags--;\n    }\n    if (evt !== SaxEventType3.OpenTag) {\n      continue;\n    }\n    openTags++;\n    const tag2 = data;\n    if (tag2.name === \"String\") {\n      await handleWord2(eventIter, ctx, data);\n      openTags--;\n    } else if (tag2.name === \"SP\") {\n      line.children.push(\" \");\n    } else if (tag2.name === \"Shape\") {\n      const polygon = await handleShape(eventIter, ctx, tag2);\n      if (polygon != null) {\n        line.polygon = polygon;\n      }\n    }\n  }\n  ctx.elementStack.pop();\n  if (!line.children.find((c) => c === \" \")) {\n    line.children = line.children.flatMap(\n      (c, i) => i === line.children.length - 1 ? [c] : [c, \" \"]\n    );\n  }\n}\nasync function handleShape(eventIter, ctx, tag) {\n  let polygon = null;\n  let openTags = 0;\n  let result;\n  while (openTags >= 0 && !(result = await eventIter.next()).done) {\n    const [evt, data] = result.value;\n    if (evt === SaxEventType3.CloseTag) {\n      openTags--;\n    }\n    if (evt !== SaxEventType3.OpenTag) {\n      continue;\n    }\n    openTags++;\n    const tag2 = data;\n    if (tag2.name === \"Polygon\") {\n      const points = getAttributeValue(tag2, \"POINTS\");\n      if (!points) {\n        logWithPosition(\n          \"<Polygon> without POINTS attribute, ignoring\",\n          \"warn\",\n          tag2\n        );\n        continue;\n      }\n      polygon = points.split(\" \").map((p) => p.split(/(,| )/).map((c) => Number.parseFloat(c))).reduce((acc, [c]) => {\n        const lastElem = acc.slice(-1)[0];\n        if (!lastElem || lastElem.length === 2) {\n          acc.push([c]);\n        } else {\n          lastElem.push(c);\n        }\n        return acc;\n      }, []).map(([x, y]) => ({ x: x * ctx.scaleFactor, y: y * ctx.scaleFactor }));\n    }\n  }\n  const parent = ctx.elementStack.slice(-1)[0];\n  if (parent.x < 0 || parent.y < 0 || parent.width < 0 || parent.height < 0) {\n    if (polygon) {\n      parent.x = Math.min(...polygon.map((p) => p.x));\n      parent.y = Math.min(...polygon.map((p) => p.y));\n      parent.width = Math.max(...polygon.map((p) => p.x)) - parent.x;\n      parent.height = Math.max(...polygon.map((p) => p.y)) - parent.y;\n    } else {\n      throw new Error(\n        `Could not get dimensions for ${parent.type}, no HPOS/VPOS/WIDTH/HEIGHT attribs and no associated Shape`\n      );\n    }\n  }\n  return polygon;\n}\nasync function handleWord2(eventIter, ctx, tag) {\n  const dims = getCoordinates(tag);\n  let text = getAttributeValue(tag, \"CONTENT\");\n  if (!text) {\n    throw new Error(\"Could not get String text\");\n  }\n  if (text.includes(\"&\")) {\n    text = resolveXmlEntities(text);\n  }\n  const word = {\n    type: \"word\",\n    x: dims.x ? dims.x * ctx.scaleFactor : -1,\n    y: dims.y ? dims.y * ctx.scaleFactor : -1,\n    width: dims.width ? dims.width * ctx.scaleFactor : -1,\n    height: dims.height ? dims.height * ctx.scaleFactor : -1,\n    text\n  };\n  ctx.elementStack.push(word);\n  const subsType = getAttributeValue(tag, \"SUBS_TYPE\");\n  if (subsType === \"HypPart1\") {\n    word.hyphenStart = true;\n  }\n  const wordConfidence = getAttributeValue(tag, \"WC\");\n  if (wordConfidence !== void 0) {\n    word.confidence = Number.parseFloat(wordConfidence);\n  }\n  let openTags = 0;\n  let result;\n  while (openTags >= 0 && !(result = await eventIter.next()).done) {\n    const [evt, data] = result.value;\n    if (evt === SaxEventType3.CloseTag) {\n      openTags--;\n      if (data.name === \"ALTERNATIVE\") {\n        if (!(\"choices\" in word)) {\n          word.choices = [];\n        }\n        let altText = data.textNodes.filter((t) => t.value.trim() !== \"\").map((t) => t.value.trim()).join(\"\");\n        if (altText.includes(\"&\")) {\n          altText = resolveXmlEntities(altText);\n        }\n        word.choices.push({\n          text: altText\n        });\n      }\n    } else if (evt === SaxEventType3.OpenTag) {\n      openTags++;\n      if (data.name === \"Shape\") {\n        const polygon = await handleShape(eventIter, ctx, tag);\n        openTags--;\n        if (polygon != null) {\n          word.polygon = polygon;\n        }\n      }\n    }\n  }\n  const line = ctx.elementStack.slice(-2)[0];\n  line.children.push(word);\n  ctx.elementStack.pop();\n}\nasync function handleSourceImageInformation(eventIter, ctx, _tag) {\n  let openTags = 0;\n  let result;\n  ctx.sourceImageInformation = {};\n  while (openTags >= 0 && !(result = await eventIter.next()).done) {\n    const [evt, data] = result.value;\n    const tag = data;\n    if (evt === SaxEventType3.CloseTag) {\n      openTags--;\n      if (tag.name === \"fileName\") {\n        ctx.sourceImageInformation.fileName = tag.textNodes.map((t) => t.value).join(\"\");\n      } else if (tag.name === \"fileIdentifier\") {\n        let ident = tag.textNodes.map((t) => t.value).join(\"\");\n        const location = getAttributeValue(tag, \"fileIdentifierLocation\");\n        if (location) {\n          ident = `${location}:${ident}`;\n        }\n        ctx.sourceImageInformation.fileIdentifier = ident;\n      } else if (tag.name === \"documentIdentifier\") {\n        let ident = tag.textNodes.map((t) => t.value).join(\"\");\n        const location = getAttributeValue(tag, \"documentIdentifierLocation\");\n        if (location) {\n          ident = `${location}:${ident}`;\n        }\n        ctx.sourceImageInformation.documentIdentifier = ident;\n      }\n    } else if (evt === SaxEventType3.OpenTag) {\n      openTags++;\n    }\n  }\n}\nasync function* parseAltoPages(alto, referenceSizes) {\n  var _a;\n  if (Array.isArray(referenceSizes)) {\n    const sizeArr = referenceSizes;\n    referenceSizes = (idx) => {\n      var _a2;\n      return (_a2 = sizeArr[idx]) != null ? _a2 : null;\n    };\n  }\n  const readable = typeof alto === \"string\" || alto instanceof Uint8Array ? toReadableStream(alto) : alto;\n  const parser = await getParser(readable);\n  const ctx = {\n    scaleFactor: 1,\n    elementStack: []\n  };\n  const eventIter = parser.iterate();\n  let result;\n  let pageIdx = 0;\n  while (!(result = await eventIter.next()).done) {\n    const [evt, data] = result.value;\n    if (evt === SaxEventType3.CloseTag && data.name === \"MeasurementUnit\") {\n      const unit = data.textNodes[0].value.trim();\n      if (unit !== \"pixel\" && !referenceSizes) {\n        throw new Error(`Measurement unit ${unit} requires a reference size.`);\n      }\n    }\n    if (evt !== SaxEventType3.OpenTag) {\n      continue;\n    }\n    const tag = data;\n    if (tag.name === \"Page\") {\n      const page = await handlePage2(\n        eventIter,\n        ctx,\n        data,\n        (_a = referenceSizes == null ? void 0 : referenceSizes(pageIdx, getAllAttributes(data))) != null ? _a : void 0\n      );\n      if (page) {\n        yield page;\n        pageIdx++;\n      }\n    } else if (tag.name === \"sourceImageInformation\") {\n      await handleSourceImageInformation(eventIter, ctx, tag);\n    }\n  }\n}\n\n// src/index.ts\nasync function parseOcrPage(markup, format, referenceSize) {\n  if (!isInitialized()) {\n    throw new Error(\n      \"XML parser WASM not initialized, call initialize() first!\"\n    );\n  }\n  let page;\n  if (format === \"hocr\") {\n    page = (await parseHocrPages(\n      markup,\n      referenceSize ? [referenceSize] : void 0\n    ).next()).value;\n  } else if (format === \"alto\") {\n    page = (await parseAltoPages(\n      markup,\n      referenceSize ? [referenceSize] : void 0\n    ).next()).value;\n  } else {\n    throw new Error(`Unsupported format: ${format}`);\n  }\n  if (!page) {\n    throw new Error(\"Failed to parse page\");\n  }\n  return page;\n}\nasync function* parseOcrPages(markup, format, referenceSizes) {\n  if (!isInitialized()) {\n    throw new Error(\n      \"XML parser WASM not initialized, call initialize() first!\"\n    );\n  }\n  if (!(markup instanceof ReadableStream)) {\n    markup = toReadableStream(markup);\n  }\n  switch (format) {\n    case \"hocr\":\n      yield* parseHocrPages(markup, referenceSizes);\n      break;\n    case \"alto\":\n      yield* parseAltoPages(markup, referenceSizes);\n      break;\n  }\n}\nexport {\n  SAX_WASM_VERSION,\n  initialize,\n  isInitialized,\n  parseAltoPages,\n  parseHocrPages,\n  parseOcrPage,\n  parseOcrPages,\n  setupLogging\n};\n//# sourceMappingURL=index.js.map","export let saxParserWasm: Uint8Array | null = null;\n\n/** Get a timestamp in milliseconds, prefereably high-resolution */\nexport function now(): number {\n  if (typeof window !== 'undefined' && window.performance) {\n    return window.performance.now();\n  } else {\n    return Date.now();\n  }\n}\n\nexport function isDefined<T>(val: T | undefined | null | void): val is T {\n  return val != undefined && val !== null && val !== void 0;\n}\n\nconst CRC_TABLE = (() => {\n  const t = new Int32Array(256);\n  for (let i = 0; i < 256; ++i) {\n    let c = i, k = 9;\n    while (--k) c = ((c & 1) && -306674912) ^ (c >>> 1);\n    t[i] = c;\n  }\n  return t;\n})();\n\nexport function crc32(data: Uint8Array): number {\n  let c = -1;\n  for (let i = 0; i < data.length; ++i) {\n    c = CRC_TABLE[(c & 255) ^ data[i]] ^ (c >>> 8);\n  }\n  return ~c;\n}\n\nexport function runningInNode(): boolean {\n  return typeof process !== 'undefined' && typeof process.versions?.node !== 'undefined';\n}\n\nexport function initializeSaxParser(parserWasm: Uint8Array): void {\n  saxParserWasm = parserWasm;\n}\n\nexport function randomUUIDv4() {\n  if (typeof crypto !== 'undefined' && crypto.randomUUID) {\n    return crypto.randomUUID();\n  }\n\n  return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {\n    if (c !== 'x') {\n      return c;\n    }\n    const randomInteger = (Math.random() * 16) | 0;\n    const encoded = (randomInteger & 0x3) | 0x8;\n    return encoded.toString(16);\n  });\n}\n","import type { Histogram } from 'prom-client';\nimport prometheus from 'prom-client';\n\nimport { runningInNode } from './util.js';\n\ntype Metrics =\n  | {\n      pageGenerationDuration: Histogram<string>;\n      imageFetchDuration: Histogram<string>;\n      imageInfoDuration: Histogram<string>;\n      ocrFetchDuration: Histogram<string>;\n    }\n  | undefined;\n\nlet metrics: Metrics;\n\n// Prometheus metrics are only defined when running in node\nif (runningInNode()) {\n  metrics = {\n    pageGenerationDuration: new prometheus.Histogram({\n      name: 'pdiiif_page_generation_duration_seconds',\n      help: 'Latency for generating the PDF for a single page',\n      buckets: [0.001, 0.005, 0.015, 0.05, 0.1, 0.5, 1, 2],\n      labelNames: ['status'],\n    }),\n    imageFetchDuration: new prometheus.Histogram({\n      name: 'pdiiif_image_fetch_duration_seconds',\n      help: 'Latency for fetching data from IIIF Image API endpoints',\n      buckets: [0.01, 0.05, 0.15, 0.5, 1, 5, 10],\n      labelNames: ['status', 'iiif_host', 'limited'],\n    }),\n    imageInfoDuration: new prometheus.Histogram({\n      name: 'pdiiif_image_info_duration_seconds',\n      help: 'Latency for fetching info from IIIF Image API endpoints',\n      buckets: [0.01, 0.05, 0.15, 0.5, 1, 5, 10],\n      labelNames: ['status', 'iiif_host', 'limited'],\n    }),\n    ocrFetchDuration: new prometheus.Histogram({\n      name: 'pdiiif_ocr_fetch_duration_seconds',\n      help: 'Latency for fetching OCR data',\n      buckets: [0.01, 0.05, 0.15, 0.5, 1, 5, 10],\n      labelNames: ['status', 'ocr_host', 'limited'],\n    }),\n  };\n}\n\nexport default metrics;\n","// node_modules/.pnpm/zustand@4.5.2_react@18.2.0/node_modules/zustand/esm/vanilla.mjs\nvar createStoreImpl = (createState) => {\n  let state;\n  const listeners = /* @__PURE__ */ new Set();\n  const setState = (partial, replace) => {\n    const nextState = typeof partial === \"function\" ? partial(state) : partial;\n    if (!Object.is(nextState, state)) {\n      const previousState = state;\n      state = (replace != null ? replace : typeof nextState !== \"object\" || nextState === null) ? nextState : Object.assign({}, state, nextState);\n      listeners.forEach((listener) => listener(state, previousState));\n    }\n  };\n  const getState = () => state;\n  const getInitialState = () => initialState;\n  const subscribe = (listener) => {\n    listeners.add(listener);\n    return () => listeners.delete(listener);\n  };\n  const destroy = () => {\n    if ((import.meta.env ? import.meta.env.MODE : void 0) !== \"production\") {\n      console.warn(\n        \"[DEPRECATED] The `destroy` method will be unsupported in a future version. Instead use unsubscribe function returned by subscribe. Everything will be garbage-collected if store is garbage-collected.\"\n      );\n    }\n    listeners.clear();\n  };\n  const api = { setState, getState, getInitialState, subscribe, destroy };\n  const initialState = state = createState(setState, getState, api);\n  return api;\n};\nvar createStore = (createState) => createState ? createStoreImpl(createState) : createStoreImpl;\n\nexport {\n  createStore\n};\n","var e=\"http://library.stanford.edu/iiif/image-api/compliance.html#level0\",i=\"http://library.stanford.edu/iiif/image-api/compliance.html#level1\",t=\"http://library.stanford.edu/iiif/image-api/compliance.html#level2\",o=\"http://library.stanford.edu/iiif/image-api/conformance.html#level0\",r=\"http://library.stanford.edu/iiif/image-api/conformance.html#level1\",a=\"http://library.stanford.edu/iiif/image-api/conformance.html#level2\",_=\"http://library.stanford.edu/iiif/image-api/1.1/compliance.html#level0\",I=\"http://library.stanford.edu/iiif/image-api/1.1/compliance.html#level1\",l=\"http://library.stanford.edu/iiif/image-api/1.1/compliance.html#level2\",p=\"http://library.stanford.edu/iiif/image-api/1.1/conformance.html#level0\",s=\"http://library.stanford.edu/iiif/image-api/1.1/conformance.html#level1\",n=\"http://library.stanford.edu/iiif/image-api/1.1/conformance.html#level2\",E=\"http://iiif.io/api/image/1/level0.json\",c=\"http://iiif.io/api/image/1/profiles/level0.json\",F=\"http://iiif.io/api/image/1/level1.json\",m=\"http://iiif.io/api/image/1/profiles/level1.json\",f=\"http://iiif.io/api/image/1/level2.json\",x=\"http://iiif.io/api/image/1/profiles/level2.json\",A=\"http://iiif.io/api/image/2/level0.json\",L=\"http://iiif.io/api/image/2/profiles/level0.json\",h=\"http://iiif.io/api/image/2/level1.json\",y=\"http://iiif.io/api/image/2/profiles/level1.json\",d=\"http://iiif.io/api/image/2/level2.json\",g=\"http://iiif.io/api/image/2/profiles/level2.json\",M=\"level0\",O=\"level1\",v=\"level2\",u=\"http://iiif.io/api/image/2/level0\",N=\"http://iiif.io/api/image/2/level1\",G=\"http://iiif.io/api/image/2/level2\",R=[G,t,a,l,n,f,x,d,g,v],C=[...R,N,i,r,I,s,F,m,h,y,O],B=[u,N,G,e,i,t,o,r,a,_,I,l,p,s,n,E,c,F,m,f,x,A,L,h,y,d,g,M,O,v],P=B,S=[u,e,o,_,p,E,c,A,L,M],z={extraFormats:[\"jpg\"],extraQualities:[\"default\"],extraFeatures:[\"sizeByWhListed\"]},b={extraFormats:[\"jpg\"],extraQualities:[\"default\"],extraFeatures:[\"baseUriRedirect\",\"cors\",\"jsonldMediaType\",\"regionByPx\",\"regionSquare\",\"sizeByWhListed\",\"sizeByH\",\"sizeByW\",\"sizeByWh\"]},j={extraFormats:[\"jpg\",\"png\"],extraQualities:[\"default\"],extraFeatures:[\"baseUriRedirect\",\"cors\",\"jsonldMediaType\",\"regionByPct\",\"regionByPx\",\"regionSquare\",\"rotationBy90s\",\"sizeByWhListed\",\"sizeByConfinedWh\",\"sizeByH\",\"sizeByPct\",\"sizeByW\",\"sizeByWh\"]},V=[\"baseUriRedirect\",\"canonicalLinkHeader\",\"cors\",\"jsonldMediaType\",\"mirroring\",\"profileLinkHeader\",\"regionByPct\",\"regionByPx\",\"regionSquare\",\"rotationArbitrary\",\"rotationBy90s\",\"sizeByConfinedWh\",\"sizeByH\",\"sizeByPct\",\"sizeByW\",\"sizeByWh\",\"sizeUpscaling\",\"sizeByWhListed\",\"sizeByDistortedWh\",\"sizeByForcedWh\"];export{e as a,i as b,t as c,o as d,r as e,a as f,_ as g,I as h,l as i,p as j,s as k,n as l,E as m,c as n,F as o,m as p,f as q,x as r,A as s,L as t,h as u,y as v,d as w,g as x,M as y,O as z,v as A,u as B,N as C,G as D,R as E,C as F,B as G,P as H,S as I,z as J,b as K,j as L,V as M};\n","function r(e){for(let n in e)(typeof e[n]>\"u\"||e[n]===null)&&delete e[n];return e}function i(e){return Array.isArray(e)?e:e?[e]:[]}export{i as a,r as b};\n","var d=Object.defineProperty;var e=(b,a,c)=>a in b?d(b,a,{enumerable:!0,configurable:!0,writable:!0,value:c}):b[a]=c;var f=(b,a,c)=>(e(b,typeof a!=\"symbol\"?a+\"\":a,c),c);export{f as a};\n","import{E as C,H as A}from\"./chunk-J657UVVW.js\";import{a as m,b as o}from\"./chunk-NJNTZ6QT.js\";import{a as v}from\"./chunk-D22QKJZO.js\";var I=[\"sc:Collection\",\"sc:Manifest\",\"sc:Canvas\",\"sc:AnnotationList\",\"oa:Annotation\",\"sc:Range\",\"sc:Layer\",\"sc:Sequence\",\"oa:Choice\",\"Service\",\"ContentResource\"];function S(t){if(typeof t>\"u\"||t===null)throw new Error(\"Null or undefined is not a valid entity.\");if(Array.isArray(t))throw new Error(\"Array is not a valid entity\");if(typeof t!=\"object\")throw new Error(`${typeof t} is not a valid entity`);if(typeof t[\"@type\"]==\"string\"){let e=I.indexOf(t[\"@type\"]);if(e!==-1)return I[e]}if(t.profile)return\"Service\";if(t.format||t[\"@type\"])return\"ContentResource\";throw new Error(\"Resource type is not known\")}var u=class t{constructor(e,n={}){v(this,\"traversals\");v(this,\"options\");this.traversals={collection:[],manifest:[],canvas:[],annotationList:[],sequence:[],annotation:[],contentResource:[],choice:[],range:[],service:[],layer:[],...e},this.options={convertPropsToArray:!0,mergeMemberProperties:!0,allowUndefinedReturn:!1,...n}}static all(e){return new t({collection:[e],manifest:[e],canvas:[e],annotationList:[e],sequence:[e],annotation:[e],contentResource:[e],choice:[e],range:[e],service:[e],layer:[e]})}traverseCollection(e){return this.traverseType(this.traverseDescriptive(this.traverseLinking(this.traverseCollectionItems(e))),this.traversals.collection)}traverseCollectionItems(e){if(this.options.mergeMemberProperties){let n=[...(e.manifests||[]).map(i=>typeof i==\"string\"?{\"@id\":i,\"@type\":\"sc:Manifest\"}:i),...(e.collections||[]).map(i=>typeof i==\"string\"?{\"@id\":i,\"@type\":\"sc:Collection\"}:i),...e.members||[]];delete e.collections,delete e.manifests,e.members=n}return e.manifests&&(e.manifests=e.manifests.map(n=>this.traverseManifest(typeof n==\"string\"?{\"@id\":n,\"@type\":\"sc:Manifest\"}:n))),e.collections&&(e.collections=e.collections.map(n=>this.traverseCollection(typeof n==\"string\"?{\"@id\":n,\"@type\":\"sc:Collection\"}:n))),e.members&&(e.members=e.members.map(n=>typeof n==\"string\"?n:this.traverseUnknown(n))),e}traverseManifest(e){return this.traverseType(this.traverseDescriptive(this.traverseLinking(this.traverseManifestItems(e))),this.traversals.manifest)}traverseManifestItems(e){return e.sequences&&(e.sequences=e.sequences.map(n=>this.traverseSequence(n))),e.structures&&(e.structures=e.structures.map(n=>this.traverseRange(n))),e}traverseSequence(e){return this.traverseType(this.traverseDescriptive(this.traverseLinking(this.traverseSequenceItems(e))),this.traversals.sequence)}traverseSequenceItems(e){return e.canvases&&(e.canvases=e.canvases.map(n=>this.traverseCanvas(n))),e}traverseCanvas(e){return this.traverseType(this.traverseDescriptive(this.traverseLinking(this.traverseCanvasItems(e))),this.traversals.canvas)}traverseCanvasItems(e){return e.images&&(e.images=e.images.map(n=>this.traverseAnnotation(n))),e.otherContent&&(e.otherContent=e.otherContent.map(n=>this.traverseAnnotationList(n))),e}traverseRange(e){return this.traverseType(this.traverseDescriptive(this.traverseLinking(this.traverseRangeItems(e))),this.traversals.range)}traverseRangeItems(e){if(this.options.mergeMemberProperties){let n=[...(e.ranges||[]).map(i=>typeof i==\"string\"?{\"@id\":i,\"@type\":\"sc:Range\"}:i),...(e.canvases||[]).map(i=>typeof i==\"string\"?{\"@id\":i,\"@type\":\"sc:Canvas\"}:i),...e.members||[]];delete e.ranges,delete e.canvases,e.members=n.length?n.map(i=>this.traverseUnknown(i)):void 0}return e}traverseAnnotationList(e){let n=typeof e==\"string\"?{\"@id\":e,\"@type\":\"sc:AnnotationList\"}:e;return this.traverseType(this.traverseDescriptive(this.traverseAnnotationListItems(n)),this.traversals.annotationList)}traverseAnnotationListItems(e){return e.resources&&(e.resources=e.resources.map(n=>this.traverseAnnotation(n))),e}traverseAnnotation(e){return this.traverseType(this.traverseDescriptive(this.traverseLinking(this.traverseAnnotationItems(e))),this.traversals.annotation)}traverseAnnotationItems(e){return e.resource&&(Array.isArray(e.resource)?e.resource=e.resource.map(n=>this.traverseContentResource(n)):e.resource=this.traverseContentResource(e.resource)),e.on,e}traverseLayer(e){return this.traverseType(this.traverseLinking(this.traverseLayerItems(e)),this.traversals.layer)}traverseLayerItems(e){return e.otherContent&&(e.otherContent=e.otherContent.map(n=>this.traverseAnnotationList(n))),e}traverseChoice(e){return this.traverseType(this.traverseChoiceItems(e),this.traversals.choice)}traverseChoiceItems(e){return e.default&&e.default!==\"rdf:nil\"&&(e.default=this.traverseContentResource(e.default)),e.item&&e.item!==\"rdf:nil\"&&(e.item=e.item.map(n=>this.traverseContentResource(n))),e}traverseService(e){return this.traverseType(this.traverseLinking(e),this.traversals.service)}traverseContentResource(e){return e[\"@type\"]===\"oa:Choice\"?this.traverseChoice(e):this.traverseType(this.traverseDescriptive(this.traverseLinking(e)),this.traversals.contentResource)}traverseUnknown(e){if(!e[\"@type\"]||typeof e==\"string\")return e;switch(S(e)){case\"sc:Collection\":return this.traverseCollection(e);case\"sc:Manifest\":return this.traverseManifest(e);case\"sc:Canvas\":return this.traverseCanvas(e);case\"sc:Sequence\":return this.traverseSequence(e);case\"sc:Range\":return this.traverseRange(e);case\"oa:Annotation\":return this.traverseAnnotation(e);case\"sc:AnnotationList\":return this.traverseAnnotationList(e);case\"sc:Layer\":return this.traverseLayer(e);case\"Service\":return this.traverseService(e);case\"oa:Choice\":return this.traverseChoice(e);case\"ContentResource\":return this.traverseContentResource(e)}return e.profile?this.traverseService(e):e}traverseImageResource(e){let n=Array.isArray(e),i=Array.isArray(e)?e:[e],a=[];for(let r of i)typeof r==\"string\"?a.push(this.traverseContentResource({\"@id\":r,\"@type\":\"dctypes:Image\"})):a.push(this.traverseContentResource(r));return!n&&!this.options.convertPropsToArray?a[0]:a}traverseDescriptive(e){return e.thumbnail&&(e.thumbnail=this.traverseImageResource(e.thumbnail)),e.logo&&(e.logo=this.traverseImageResource(e.logo)),e}traverseOneOrMoreServices(e){let n=Array.isArray(e),i=Array.isArray(e)?e:[e],a=[];for(let r of i)a.push(this.traverseService(r));return!n&&!this.options.convertPropsToArray?a[0]:a}traverseLinking(e){return e.related&&(e.related=this.traverseOneOrManyType(e.related,this.traversals.contentResource)),e.rendering&&(e.rendering=this.traverseOneOrManyType(e.rendering,this.traversals.contentResource)),e.service&&(e.service=this.traverseOneOrMoreServices(e.service)),e.seeAlso&&(e.seeAlso=this.traverseOneOrManyType(e.seeAlso,this.traversals.contentResource)),e.within&&(typeof e.within==\"string\"||(e.within=this.traverseOneOrManyType(e.within,this.traversals.contentResource))),e.startCanvas&&(typeof e.startCanvas==\"string\"?e.startCanvas=this.traverseType({\"@id\":e.startCanvas,\"@type\":\"sc:Canvas\"},this.traversals.canvas):e.startCanvas&&this.traverseType(e.startCanvas,this.traversals.canvas)),e.contentLayer&&(typeof e.contentLayer==\"string\"?e.contentLayer=this.traverseLayer({\"@id\":e.contentLayer,\"@type\":\"sc:Layer\"}):e.contentLayer=this.traverseLayer(e.contentLayer)),e}traverseOneOrManyType(e,n){if(!Array.isArray(e))if(this.options.convertPropsToArray)e=[e];else return this.traverseType(e,n);return e.map(i=>this.traverseType(i,n))}traverseType(e,n){return n.reduce((i,a)=>{let r=a(i);return typeof r>\"u\"&&!this.options.allowUndefinedReturn?i:r},e)}};var M=\"http://library.stanford.edu/iiif/image-api/compliance.html#level1\",O=\"http://library.stanford.edu/iiif/image-api/compliance.html#level2\";var b=\"http://library.stanford.edu/iiif/image-api/conformance.html#level1\",w=\"http://library.stanford.edu/iiif/image-api/conformance.html#level2\";var F=\"http://library.stanford.edu/iiif/image-api/1.1/compliance.html#level1\",D=\"http://library.stanford.edu/iiif/image-api/1.1/compliance.html#level2\";var N=\"http://library.stanford.edu/iiif/image-api/1.1/conformance.html#level1\",k=\"http://library.stanford.edu/iiif/image-api/1.1/conformance.html#level2\";var j=\"http://iiif.io/api/image/1/level1.json\",G=\"http://iiif.io/api/image/1/profiles/level1.json\",q=\"http://iiif.io/api/image/1/level2.json\",V=\"http://iiif.io/api/image/1/profiles/level2.json\";var U=\"http://iiif.io/api/image/2/level1.json\",$=\"http://iiif.io/api/image/2/profiles/level1.json\",W=\"http://iiif.io/api/image/2/level2.json\",B=\"http://iiif.io/api/image/2/profiles/level2.json\";var H=\"level1\",J=\"level2\";var z=\"http://iiif.io/api/image/2/level1\",K=\"http://iiif.io/api/image/2/level2\",P=[z,K,M,O,b,w,F,D,N,k,j,G,q,V,U,$,W,B,H,J];var d={attributionLabel:\"Attribution\",lang:\"none\",providerId:\"http://example.org/provider\",providerName:\"Unknown\"};function Q(t){if(typeof t==\"string\")return[t];if(!t)return[];let e=Array.isArray(t)?t:[t],n=[];for(let i of e){if(typeof i==\"string\"){n.push(i);continue}n.push({\"@language\":i[\"@language\"]||i.language,\"@value\":i[\"@value\"]||i.value})}return n}function h(t,e=\"none\"){if(!t)return{none:[\"\"]};let n=Q(t),i={};for(let a of n){if(typeof a==\"string\"){i[e]=i[e]?i[e]:[],i[e].push(a||\"\");continue}if(!a[\"@language\"]){i[e]=i[e]?i[e]:[],i[e].push(a[\"@value\"]||\"\");continue}let r=a[\"@language\"];i[r]=i[r]?i[r]:[],i[r].push(a[\"@value\"]||\"\")}return Object.keys(i).length===0?{none:[\"\"]}:i}function L(t){if(Array.isArray(t))return L(t.find(e=>typeof e==\"string\"));if(C.indexOf(t)!==-1)return\"level2\";if(P.indexOf(t)!==-1)return\"level1\";if(A.indexOf(t)!==-1)return\"level0\";if(typeof t==\"string\")return t}function X(t){let e=Array.isArray(t)?t:[t];for(let n of e)switch(n){case\"http://iiif.io/api/image/2/context.json\":case\"http://library.stanford.edu/iiif/image-api/1.1/compliance.html#level2\":return\"ImageService2\";case\"http://iiif.io/api/image/1/context.json\":case\"http://library.stanford.edu/iiif/image-api/1.1/context.json\":return\"ImageService1\";case\"http://iiif.io/api/annex/openannotation/context.json\":return\"ImageApiSelector\"}}function Y(t){switch(t){case\"http://iiif.io/api/image/2/level0.json\":case\"http://iiif.io/api/image/2/level1.json\":case\"http://iiif.io/api/image/2/level2.json\":return\"ImageService2\";case\"http://iiif.io/api/auth/1/kiosk\":case\"http://iiif.io/api/auth/1/login\":case\"http://iiif.io/api/auth/1/clickthrough\":case\"http://iiif.io/api/auth/1/external\":case\"http://iiif.io/api/auth/0/kiosk\":case\"http://iiif.io/api/auth/0/login\":case\"http://iiif.io/api/auth/0/clickthrough\":case\"http://iiif.io/api/auth/0/external\":return\"AuthCookieService1\";case\"http://iiif.io/api/auth/1/token\":case\"http://iiif.io/api/auth/0/token\":return\"AuthTokenService1\";case\"http://iiif.io/api/auth/1/logout\":case\"http://iiif.io/api/auth/0/logout\":return\"AuthLogoutService1\";case\"http://iiif.io/api/search/1/search\":case\"http://iiif.io/api/search/0/search\":return\"SearchService1\";case\"http://iiif.io/api/search/1/autocomplete\":case\"http://iiif.io/api/search/0/autocomplete\":return\"AutoCompleteService1\"}}function _(t){for(let e of[\"sc\",\"oa\",\"dcterms\",\"dctypes\",\"iiif\"])if(t.startsWith(`${e}:`))return t.slice(e.length+1);return t}var Z=[\"Collection\",\"Manifest\",\"Annotation\",\"AnnotationPage\",\"Range\",\"Service\"];function g(t){let e=t[\"@id\"]||t.id,n=t[\"@type\"]||t.type,i=t.profile||void 0,a=t[\"@context\"]||void 0;if(i){let r=Y(i);if(r)return r}if(a){let r=X(a);if(r)return r}if(n){if(Array.isArray(n)){if(n.indexOf(\"oa:CssStylesheet\")!==-1)return\"CssStylesheet\";if(n.indexOf(\"cnt:ContentAsText\")!==-1)return\"TextualBody\";n=n[0]}for(let r of[\"sc\",\"oa\",\"dcterms\",\"dctypes\",\"iiif\"])if(n.startsWith(`${r}:`)){n=n.slice(r.length+1);break}switch(n){case\"Layer\":return\"AnnotationCollection\";case\"AnnotationList\":return\"AnnotationPage\";case\"cnt:ContentAsText\":return\"TextualBody\"}}if(n&&Z.indexOf(n)!==-1)return n;if(t.format){if(t.format.startsWith(\"image/\"))return\"Image\";if(t.format.startsWith(\"text/\")||t.format===\"application/pdf\")return\"Text\";if(t.format.startsWith(\"application/\"))return\"Dataset\"}return e&&(e.endsWith(\".jpg\")||e.endsWith(\".png\")||e.endsWith(\".jpeg\"))?\"Image\":n||\"unknown\"}var ee=/http(s)?:\\/\\/(creativecommons.org|rightsstatements.org)[^\"'\\\\<\\n]+/gm;function te(t){let e=t.match(ee);return e?e[0]:t}function ne(t,e=\"Rights/License\",n=\"none\"){let i=null,a=[],r=Array.isArray(t)?t:[t];for(let s of r){let c=s?te(s):void 0;if(c&&(c.indexOf(\"creativecommons.org\")!==-1||c.indexOf(\"rightsstatements.org\")!==-1)){c.startsWith(\"https://\")?i=`http://${c.slice(8)}`:i=c;continue}c&&a.push({label:{[n]:[e]},value:{[n]:[c]}})}return[i,a]}var ie=[\"http://iiif.io/api/presentation/2/context.json\",\"http://iiif.io/api/image/2/context.json\",\"http://iiif.io/api/image/1/context.json\",\"http://library.stanford.edu/iiif/image-api/1.1/context.json\",\"http://iiif.io/api/search/1/context.json\",\"http://iiif.io/api/search/0/context.json\",\"http://iiif.io/api/auth/1/context.json\",\"http://iiif.io/api/auth/0/context.json\",\"http://iiif.io/api/annex/openannotation/context.json\"];function re(t){if(t){let e=Array.isArray(t)?t:[t],n=[];for(let i of e)i===\"http://iiif.io/api/presentation/2/context.json\"&&n.push(\"http://iiif.io/api/presentation/3/context.json\"),ie.indexOf(i)===-1&&n.push(i);if(e.length)return n.length===1?n[0]:n}}function ae(t){return t?t.map(e=>({label:h(e.label),value:h(e.value)})):[]}var R=0;function x(t,e){let n=encodeURI(t.id||t[\"@id\"]||\"\").trim();return n&&e?`${n}/${e}`:n||(R++,`http://example.org/${t[\"@type\"]}${e?`/${e}`:\"\"}/${R}`)}function p(t){let e=[...t.behavior||[]];t.viewingHint&&e.push(t.viewingHint);let n;return Array.isArray(t.motivation)?n=t.motivation.map(_):t.motivation&&(n=_(t.motivation)),{\"@context\":t[\"@context\"]?re(t[\"@context\"]):void 0,id:(t[\"@id\"]||x(t)).trim(),type:g(t),behavior:e.length?e:void 0,height:t.height?t.height:void 0,width:t.width?t.width:void 0,motivation:n,viewingDirection:t.viewingDirection,profile:t.profile,format:t.format?t.format:void 0,duration:void 0,timeMode:void 0}}function f(t){let[e,n]=ne(t.license),i=[...t.metadata?ae(t.metadata):[],...n];return{rights:e,metadata:i.length?i:void 0,label:t.label?h(t.label):void 0,requiredStatement:t.attribution?{label:h(d.attributionLabel),value:h(t.attribution)}:void 0,navDate:t.navDate,summary:t.description?h(t.description):void 0,thumbnail:se(t.thumbnail)}}function se(t){return t&&(Array.isArray(t)?t:[t]).map(n=>typeof n==\"string\"?{id:n,type:\"Image\"}:(n.type===\"unknown\"&&(n.type=\"Image\"),n))}function oe(t){if(!t.within)return;let e=Array.isArray(t.within)?t.within:[t.within],n=[];for(let i of e)if(typeof i==\"string\"){if(i)switch(t[\"@type\"]){case\"sc:Manifest\":n.push({id:i,type:\"Collection\"});break}}else i[\"@id\"]&&n.push({id:i[\"@id\"],type:g(i)});return n.length?n:void 0}function l(t){let e=t.related?Array.isArray(t.related)?t.related:[t.related]:[],n=t.contentLayer;return{provider:t.logo||e.length?[{id:d.providerId,type:\"Agent\",homepage:e.length?[e[0]]:void 0,logo:t.logo?Array.isArray(t.logo)?t.logo:[t.logo]:void 0,label:h(d.providerName)}]:void 0,partOf:oe(t),rendering:t.rendering,seeAlso:t.seeAlso,start:t.startCanvas,service:t.service?m(t.service):void 0,supplementary:n?[n]:void 0}}function pe(t){return{chars:t.chars,format:t.format?t.format:void 0,language:t.language}}function fe(t){return o({...p(t),...f(t),...l(t),items:t.members})}function ce(t){let e=[],n=[],i,a;for(let s of t.sequences||[])console.log(s),s.canvases.length&&e.push(...s.canvases),s.behavior&&n.push(...s.behavior),s.viewingDirection&&(a=s.viewingDirection),s.startCanvas&&(i=s.startCanvas);let r=p(t);return n.length&&(r.behavior?r.behavior.push(...n):r.behavior=n),o({...r,...f(t),...l(t),viewingDirection:a,start:i,items:e,structures:le(t.structures)})}function le(t){if(!t)return t;let e=new Map;for(let i of t)e.set(i.id,i);let n=[];for(let i of t)if(i.items){let a=i.items.map(r=>typeof r==\"string\"?(n.push(r),e.get(r)||r):r&&r.id?(n.push(r.id),e.get(r.id)||r):r);i.items=a}return t.filter(i=>n.indexOf(i.id)===-1)}function he(t){return o({...p(t),...f(t),...l(t),annotations:t.otherContent&&t.otherContent.length?t.otherContent:void 0,items:t.images&&t.images.length?[{id:x(t,\"annotation-page\"),type:\"AnnotationPage\",items:t.images}]:void 0})}function ue(t){return o({...p(t),...f(t),...l(t),items:t.resources&&t.resources.length?t.resources:void 0})}function ve(t){return!t.canvases||t.canvases.length===0?{canvases:[],behavior:[]}:{canvases:t.canvases,behavior:t.viewingHint?[t.viewingHint]:[],viewingDirection:t.viewingDirection,startCanvas:t.startCanvas}}function de(t){function e(n){if(Array.isArray(n)){if(n.length>1)return{type:\"List\",items:n.map(e)};n=n[0]}if(typeof n==\"string\")return encodeURI(n).trim();if(\"@type\"in n){let i;if(typeof n.full==\"string\")i=n.full;else if(n.full[\"@type\"]===\"dctypes:Image\")i={id:n.full[\"@id\"],type:\"Image\"};else if(n.full[\"@type\"]===\"sc:Canvas\")i={id:n.full[\"@id\"],type:\"Canvas\"};else throw new Error(`Unsupported source type on annotation: ${n.full[\"@type\"]}`);return{type:\"SpecificResource\",source:i,selector:y(n.selector)}}else return encodeURI(n[\"@id\"]).trim()}return o({...p(t),...f(t),...l(t),target:e(t.on),body:Array.isArray(t.resource)?t.resource.map(T):T(t.resource)})}function T(t){return t.type===\"Choice\"?t:E(t)}function E(t){let e=t;return o({...p(e),...f(e),...l(e),...pe(e)})}function ye(t){let e=[];return t.default&&t.default!==\"rdf:nil\"&&e.push(t.default),t.item&&t.item!==\"rdf:nil\"&&e.push(...t.item),o({...p(t),...f(t),items:e})}function ge(t){return o({...p(t),...f(t),...l(t),items:t.members})}function me(t){let{\"@id\":e,\"@type\":n,\"@context\":i,profile:a,...r}=t,s={};return e&&(s[\"@id\"]=e),s[\"@type\"]=g(t),s[\"@type\"]===\"unknown\"&&(i&&i.length&&(s[\"@context\"]=i),s[\"@type\"]=\"Service\"),a&&(s.profile=L(a)),o({...s,...r})}function Ce(t){return o({...p(t),...f(t),...l(t)})}var Ae=new u({collection:[fe],manifest:[ce],canvas:[he],annotationList:[ue],sequence:[ve],annotation:[de],contentResource:[E],choice:[ye],range:[ge],service:[me],layer:[Ce]});function Me(t){return t&&t[\"@context\"]&&(t[\"@context\"]===\"http://iiif.io/api/presentation/2/context.json\"||t[\"@context\"].indexOf(\"http://iiif.io/api/presentation/2/context.json\")!==-1||t[\"@context\"]===\"http://www.shared-canvas.org/ns/context.json\")||t[\"@context\"]===\"http://iiif.io/api/image/2/context.json\"?Ae.traverseUnknown(t):t}function y(t){if((Array.isArray(t[\"@type\"])&&t[\"@type\"].includes(\"oa:SvgSelector\")||t[\"@type\"]==\"oa:SvgSelector\")&&(\"chars\"in t||\"value\"in t))return{type:\"SvgSelector\",value:\"chars\"in t?t.chars:t.value};if(t[\"@type\"]===\"oa:FragmentSelector\")return{type:\"FragmentSelector\",value:t.value};if(t[\"@type\"]===\"oa:Choice\")return[y(t.default),...(Array.isArray(t.item)?t.item:[t.item]).map(y)];if(t[\"@type\"]==\"iiif:ImageApiSelector\")return{type:\"ImageApiSelector\",region:\"region\"in t?t.region:void 0,rotation:\"rotation\"in t?t.rotation:void 0};throw new Error(`Unsupported selector type: ${t[\"@type\"]}`)}export{I as a,S as b,u as c,h as d,L as e,X as f,Ae as g,Me as h};\n","import{h as o}from\"./chunk-MQ6FX5SL.js\";import\"./chunk-J657UVVW.js\";import\"./chunk-NJNTZ6QT.js\";import\"./chunk-D22QKJZO.js\";var t=o;export{t as upgrade};\n","// src/compat.ts\nvar metaState = {};\nvar compatVault = {\n  get(nonRef) {\n    return nonRef;\n  },\n  setMetaValue([id, meta, key], value) {\n    const oldValue = compatVault.getResourceMeta(id, meta);\n    const oldValueItem = oldValue ? oldValue[key] : void 0;\n    const newValue = typeof value === \"function\" ? value(oldValueItem) : value;\n    metaState[id] = {\n      ...metaState[id] || {},\n      [meta]: {\n        ...(metaState[id] || {})[meta] || {},\n        [key]: newValue\n      }\n    };\n  },\n  getResourceMeta: (resource, metaKey) => {\n    const resourceMeta = metaState[resource];\n    if (!resourceMeta) {\n      return void 0;\n    }\n    if (!metaKey) {\n      return resourceMeta;\n    }\n    return resourceMeta[metaKey];\n  },\n  async load(id) {\n    const idToLoad = typeof id === \"string\" ? id : id.id;\n    return fetch(idToLoad).then((response) => response.json());\n  },\n  requestStatus(id) {\n    return void 0;\n  }\n};\n\nexport {\n  compatVault\n};\n","import {\n  compatVault\n} from \"./chunk-LVD5NUFB.js\";\n\n// src/painting-annotations/parse-specific-resource.ts\nfunction parseSpecificResource(resource) {\n  if (resource.type === \"SpecificResource\") {\n    return [resource.source, { selector: resource.selector }];\n  }\n  return [resource, { selector: null }];\n}\n\n// src/painting-annotations/helper.ts\nfunction createPaintingAnnotationsHelper(vault = compatVault) {\n  function getAllPaintingAnnotations(canvasOrId) {\n    const canvas = canvasOrId ? typeof canvasOrId === \"string\" ? vault.get(canvasOrId) : canvasOrId : null;\n    if (!canvas) {\n      return [];\n    }\n    const annotationPages = vault.get(canvas.items, { parent: canvas });\n    const flatAnnotations = [];\n    for (const page of annotationPages) {\n      flatAnnotations.push(...vault.get(page.items, { parent: page }));\n    }\n    return flatAnnotations;\n  }\n  function getPaintables(paintingAnnotationsOrCanvas, enabledChoices = []) {\n    const paintingAnnotations = Array.isArray(paintingAnnotationsOrCanvas) ? paintingAnnotationsOrCanvas : getAllPaintingAnnotations(paintingAnnotationsOrCanvas);\n    const types = [];\n    let choices = {\n      items: [],\n      type: \"complex-choice\"\n    };\n    const items = [];\n    for (const annotation of paintingAnnotations) {\n      if (annotation.type !== \"Annotation\") {\n        throw new Error(`getPaintables() accept either a canvas or list of annotations`);\n      }\n      const references = Array.from(Array.isArray(annotation.body) ? annotation.body : [annotation.body]);\n      for (const reference of references) {\n        const [ref, { selector }] = parseSpecificResource(reference);\n        const body = vault.get(ref);\n        const type = (body.type || \"unknown\").toLowerCase();\n        if (type === \"choice\") {\n          const nestedBodies = vault.get(body.items, { parent: body.id });\n          const selected = enabledChoices.length ? enabledChoices.map((cid) => nestedBodies.find((b) => b.id === cid)).filter(Boolean) : [nestedBodies[0]];\n          if (selected.length === 0) {\n            selected.push(nestedBodies[0]);\n          }\n          choices.items.push({\n            type: \"single-choice\",\n            items: nestedBodies.map((b) => ({\n              id: b.id,\n              label: b.label,\n              selected: selected.indexOf(b) !== -1\n            })),\n            label: ref.label\n          });\n          references.push(...selected);\n          continue;\n        }\n        if (types.indexOf(type) === -1) {\n          types.push(type);\n        }\n        items.push({\n          type,\n          annotationId: annotation.id,\n          annotation,\n          resource: body,\n          target: annotation.target,\n          selector\n        });\n      }\n    }\n    return {\n      types,\n      items,\n      choice: choices.items.length < 2 ? choices.items[0] || null : choices,\n      allChoices: choices.items.length ? choices : null\n    };\n  }\n  function extractChoices(paintingAnnotationsOrCanvas) {\n    const { choice } = getPaintables(paintingAnnotationsOrCanvas);\n    return choice;\n  }\n  return {\n    getAllPaintingAnnotations,\n    getPaintables,\n    extractChoices\n  };\n}\n\nexport {\n  parseSpecificResource,\n  createPaintingAnnotationsHelper\n};\n","import{a as i}from\"./chunk-NJNTZ6QT.js\";import{a as r}from\"./chunk-D22QKJZO.js\";function v(a){return typeof a==\"string\"?!1:a&&!a.type&&\"source\"in a?(a.type=\"SpecificResource\",!0):!!a&&a.type===\"SpecificResource\"}function o(...a){return e=>a.reduce((t,n)=>n(t),e)}var p=[\"Collection\",\"Manifest\",\"Canvas\",\"AnnotationPage\",\"AnnotationCollection\",\"Annotation\",\"ContentResource\",\"Range\",\"Service\",\"Selector\",\"Agent\"];function y(a,e){if(typeof a>\"u\"||a===null)throw new Error(\"Null or undefined is not a valid entity.\");if(Array.isArray(a))throw new Error(\"Array is not a valid entity\");if(typeof a!=\"object\"){if(e)return e;throw new Error(`${typeof a} is not a valid entity`)}if(typeof a.type==\"string\"){let t=p.indexOf(a.type);if(t!==-1)return p[t]}if(a.profile)return\"Service\";throw new Error(\"Resource type is not known\")}var l=class a{constructor(e,t={}){r(this,\"traversals\");r(this,\"options\");r(this,\"_traverseManifest\",o(this.traverseManifestItems.bind(this),this.traverseLinking.bind(this),this.traverseDescriptive.bind(this),this.traverseLinkedCanvases.bind(this),this.traverseManifestStructures.bind(this),this.traverseInlineAnnotationPages.bind(this)));r(this,\"_traverseCanvas\",o(this.traverseCanvasItems.bind(this),this.traverseLinking.bind(this),this.traverseDescriptive.bind(this),this.traverseLinkedCanvases.bind(this),this.traverseInlineAnnotationPages.bind(this)));r(this,\"_traverseAnnotationPage\",o(this.traverseAnnotationPageItems.bind(this),this.traverseLinking.bind(this),this.traverseDescriptive.bind(this)));r(this,\"_traverseRange\",o(this.traverseRangeRanges.bind(this),this.traverseLinking.bind(this),this.traverseDescriptive.bind(this),this.traverseLinkedCanvases.bind(this)));this.traversals={collection:[],manifest:[],canvas:[],annotationCollection:[],annotationPage:[],annotation:[],contentResource:[],choice:[],range:[],service:[],agent:[],specificResource:[],geoJson:[],...e},this.options={allowUndefinedReturn:!1,...t}}static all(e){return new a({collection:[e],manifest:[e],canvas:[e],annotationCollection:[e],annotationPage:[e],annotation:[e],contentResource:[e],choice:[e],range:[e],service:[e],geoJson:[e],specificResource:[e],agent:[e]})}traverseDescriptive(e){return e.thumbnail&&(e.thumbnail=i(e.thumbnail).map(t=>this.traverseType(t,{parent:e},this.traversals.contentResource))),e.provider&&(e.provider=e.provider.map(t=>this.traverseAgent(t,e))),e}traverseLinking(e){return e.seeAlso&&(e.seeAlso=e.seeAlso.map(t=>this.traverseType(t,{parent:e},this.traversals.contentResource))),e.service&&(e.service=i(e.service).map(t=>this.traverseService(t))),e.services&&(e.services=i(e.services).map(t=>this.traverseService(t,e))),e.logo&&(e.logo=e.logo.map(t=>this.traverseType(t,{parent:e},this.traversals.contentResource))),e.homepage&&(e.homepage=i(e.homepage).map(t=>this.traverseType(t,{parent:e},this.traversals.contentResource))),e.partOf&&(e.partOf=e.partOf.map(t=>typeof t==\"string\"||!t.type?this.traverseType(t,{parent:e},this.traversals.contentResource):t.type===\"Canvas\"?this.traverseType(t,{parent:e},this.traversals.canvas):t.type===\"AnnotationCollection\"?this.traverseType(t,{parent:e},this.traversals.annotationCollection):t.type===\"Collection\"?this.traverseType(t,{parent:e},this.traversals.collection):this.traverseType(t,{parent:e},this.traversals.contentResource))),e.start&&(v(e.start)?e.start=this.traverseSpecificResource(e.start,\"Canvas\",e):e.start=this.traverseType(e.start,{parent:e},this.traversals.canvas)),e.rendering&&(e.rendering=e.rendering.map(t=>this.traverseType(t,{parent:e},this.traversals.contentResource))),e.supplementary&&(e.supplementary=e.supplementary.map(t=>this.traverseType(t,{parent:e},this.traversals.contentResource))),e}traverseCollectionItems(e){return e.items&&e.items.map(t=>t.type===\"Collection\"?this.traverseCollection(t):this.traverseManifest(t)),e}traverseCollection(e,t){return this.traverseType(this.traverseDescriptive(this.traverseInlineAnnotationPages(this.traverseLinking(this.traverseLinkedCanvases(this.traverseCollectionItems(e))))),{parent:t},this.traversals.collection)}traverseGeoJson(e,t){return this.traverseType(e,{parent:t},this.traversals.geoJson)}traverseNavPlace(e){return e.navPlace&&(e.navPlace=this.traverseGeoJson(e.navPlace,e)),e}traverseManifestItems(e){return e.items&&(e.items=e.items.map(t=>this.traverseCanvas(t))),e}traverseManifestStructures(e){return e.structures&&(e.structures=e.structures.map(t=>this.traverseRange(t))),e}traverseManifest(e,t){return this.traverseType(this._traverseManifest(e),{parent:t},this.traversals.manifest)}traverseCanvasItems(e){return e.items=(e.items||[]).map(t=>this.traverseAnnotationPage(t,e)),e}traverseInlineAnnotationPages(e){return typeof e==\"string\"||!e||e.annotations&&(e.annotations=e.annotations.map(t=>this.traverseAnnotationPage(t,e))),e}traverseCanvas(e,t){return this.traverseType(this._traverseCanvas(e),{parent:t},this.traversals.canvas)}traverseAnnotationPageItems(e){return e.items&&(e.items=e.items.map(t=>this.traverseAnnotation(t,e))),e}traverseAnnotationPage(e,t){return this.traverseType(this._traverseAnnotationPage(e),{parent:t},this.traversals.annotationPage)}traverseAnnotationBody(e){return Array.isArray(e.body)?e.body=e.body.map(t=>this.traverseContentResource(t,e)):e.body&&(e.body=this.traverseContentResource(e.body,e)),e}traverseLinkedCanvases(e){return e.placeholderCanvas&&(e.placeholderCanvas=this.traverseCanvas(e.placeholderCanvas)),e.accompanyingCanvas&&(e.accompanyingCanvas=this.traverseCanvas(e.accompanyingCanvas)),e}traverseAnnotation(e,t){return this.traverseType(this.traverseLinking(this.traverseAnnotationBody(this.traverseDescriptive(e))),{parent:t},this.traversals.annotation)}traverseContentResourceLinking(e){return typeof e==\"string\"||!e||e&&e.service&&(e.service=i(e.service||[]).map(t=>this.traverseService(t,e))),e}traverseContentResource(e,t){return e.type===\"Choice\"&&(e.items=e.items.map(n=>this.traverseContentResource(n,e))),v(e)?this.traverseSpecificResource(e,\"ContentResource\"):this.traverseType(this.traverseInlineAnnotationPages(this.traverseContentResourceLinking(e)),{parent:t},this.traversals.contentResource)}traverseSpecificResource(e,t,n){let s=e.source;return typeof e.source==\"string\"&&(s={id:e.source,type:t||\"unknown\"}),this.traverseType({...e,source:t===\"Canvas\"||s.type===\"Canvas\"?this.traverseType(s,{parent:n},this.traversals.canvas):t===\"ContentResource\"?this.traverseContentResource(s,{parent:n}):this.traverseUnknown(s,{parent:n,typeHint:t})},{parent:n},this.traversals.specificResource)}traverseRangeRanges(e){return e.items&&(e.items=e.items.map(t=>typeof t==\"string\"?this.traverseCanvas({id:t,type:\"Canvas\"},e):v(t)?this.traverseSpecificResource(t,\"Canvas\",e):t.type===\"Manifest\"?this.traverseManifest(t,e):this.traverseRange(t,e))),e}traverseRange(e,t){return this.traverseType(this._traverseRange(e),{parent:t},this.traversals.range)}traverseAgent(e,t){return this.traverseType(this.traverseDescriptive(this.traverseLinking(e)),{parent:t},this.traversals.agent)}traverseType(e,t,n){return n.reduce((s,c)=>{let h=c(s,t);return typeof h>\"u\"&&!this.options.allowUndefinedReturn?s:h},e)}traverseService(e,t){let n=Object.assign({},e);return n&&n.service&&(n.service=i(n.service).map(s=>this.traverseService(s))),this.traverseType(n,{parent:t},this.traversals.service)}traverseUnknown(e,{parent:t,typeHint:n}={}){let s=y(e,n);switch(s){case\"Collection\":return this.traverseCollection(e,t);case\"Manifest\":return this.traverseManifest(e,t);case\"Canvas\":return this.traverseCanvas(e,t);case\"AnnotationPage\":return this.traverseAnnotationPage(e,t);case\"Annotation\":return this.traverseAnnotation(e,t);case\"ContentResource\":return this.traverseContentResource(e,t);case\"Range\":return this.traverseRange(e,t);case\"Service\":return this.traverseService(e,t);case\"Agent\":return this.traverseAgent(e,t);default:throw new Error(`Unknown or unsupported resource type of ${s}`)}}};export{v as a,p as b,y as c,l as d};\n","import{h as V}from\"./chunk-MQ6FX5SL.js\";import{a as z,d as H}from\"./chunk-W3DWL6UZ.js\";function L(e,n){let i=n||\"unknown\";if(!e)return;if(typeof e==\"string\")return{id:e,type:i};if(z(e))return L(e.source,n);let r=i&&i!==\"unknown\"?i:e.type||e[\"@type\"],t=e.id||e[\"@id\"];if(r&&r.indexOf(\":\")!==-1&&(r=r.split(\":\").pop()),t&&r)return{id:t,type:r}}var w={},f=\"iiif-parser:hasPart\",g=\"iiif-parser:partOf\",T=\"iiif-parser:isExternal\",m=\"__$UNSET$__\",I=\"__$UNWRAP$__\",o=[];Object.freeze(o);Object.freeze(w);function te(e){if(e===w||Object.keys(e).length===0)return!0;for(let n in e)return!1;return!0}function oe(e,n){if(n&&n[\"@explicit\"]){let i={},r=Object.keys(n);for(let t of r)t===g||t===\"@explicit\"||(te(n[t])?i[t]=e[t]:i[t]=n[t]);return i}return e}function F(e,n,i){let r=L(n);if(!r)return[void 0,void 0];let t=e.requests[r.id],a=r.type||e.mapping[r.id];if(!a||t&&t.resourceUri&&(!e.entities[a]||!e.entities[a][t.resourceUri]))return[void 0,void 0];let s=e.entities[a][t?t.resourceUri:r.id];if(r.type&&!s)return F(e,{id:r.id},i);if(s&&s[f]){let c=s[f].find(l=>i?l[g]===i.id:l[g]===s.id);return[oe(s,c),s]}return[s,s]}var xe={id:\"https://iiif-parser/annotation\",type:\"Annotation\",behavior:o,label:null,thumbnail:o,summary:null,requiredStatement:null,metadata:o,seeAlso:o,homepage:o,rendering:o,service:o,accessibility:o,audience:o,body:o,bodyValue:null,canonical:null,created:null,creator:o,generated:null,generator:o,modified:null,motivation:o,rights:null,stylesheet:null,target:o,timeMode:void 0,via:o,partOf:o},K={id:\"https://iiif-parser/annotation-page\",type:\"AnnotationPage\",behavior:o,label:null,thumbnail:o,summary:null,requiredStatement:null,metadata:o,rights:null,provider:o,items:o,seeAlso:o,homepage:o,rendering:o,service:o},G={id:\"https://iiif-parser/empty-canvas\",type:\"Canvas\",label:null,behavior:o,thumbnail:o,accompanyingCanvas:null,placeholderCanvas:null,summary:null,requiredStatement:null,metadata:o,rights:null,navDate:null,provider:o,items:o,annotations:o,seeAlso:o,homepage:o,partOf:o,rendering:o,service:o,duration:0,height:0,width:0},X={id:\"https://iiif-parser/empty-collection\",type:\"Collection\",label:null,viewingDirection:\"left-to-right\",behavior:o,thumbnail:o,accompanyingCanvas:null,placeholderCanvas:null,summary:null,requiredStatement:null,metadata:o,rights:null,navDate:null,provider:o,items:o,annotations:o,seeAlso:o,homepage:o,partOf:o,rendering:o,service:o,services:o},Y={id:\"https://iiif-parser/empty-manifest\",type:\"Manifest\",annotations:o,behavior:o,homepage:o,items:o,label:null,metadata:o,navDate:null,provider:o,partOf:o,accompanyingCanvas:null,placeholderCanvas:null,rendering:o,requiredStatement:null,rights:null,seeAlso:o,service:o,services:o,start:null,structures:o,summary:null,thumbnail:o,viewingDirection:\"left-to-right\"},J={id:\"https://iiif-parser/empty-canvas\",type:\"Range\",label:null,behavior:o,thumbnail:o,accompanyingCanvas:null,placeholderCanvas:null,summary:null,requiredStatement:null,metadata:o,rights:null,navDate:null,provider:o,items:o,annotations:o,seeAlso:o,homepage:o,partOf:o,rendering:o,service:o,start:null,supplementary:null,viewingDirection:\"left-to-right\"},B={id:\"https://iiif-parser/empty-agent\",type:\"Agent\",label:{},logo:o,seeAlso:o,homepage:o},Q={id:\"https://iiif-parser/empty-service\",type:\"UnknownService\"};function _(e,n={}){if(Array.isArray(e))return _(e[0]);if(typeof e==\"string\"){let[i,r]=e.split(\"#\");return r?{type:\"SpecificResource\",source:{id:i,type:n.typeHint||\"Unknown\"},selector:{type:\"FragmentSelector\",value:r}}:{type:\"SpecificResource\",source:{id:i,type:n.typeMap&&n.typeMap[i]||n.typeHint||\"Unknown\"}}}if(e.type===\"Choice\"||e.type===\"List\"||e.type===\"Composite\"||e.type===\"Independents\")return _(e.items[0]);if(!e.type&&\"source\"in e&&(e.type=\"SpecificResource\"),e.type===\"SpecificResource\")return e.source.type===\"Canvas\"&&e.source.partOf&&typeof e.source.partOf==\"string\"&&(e.source.partOf=[{id:e.source.partOf,type:\"Manifest\"}]),e.selector?{type:\"SpecificResource\",source:e.source,selector:e.selector}:{type:\"SpecificResource\",source:e.source};if(e.id){e.type===\"Canvas\"&&e.partOf&&typeof e.partOf==\"string\"&&(e.partOf=[{id:e.partOf,type:\"Manifest\"}]);let[i,r]=e.id.split(\"#\");return r?{type:\"SpecificResource\",source:{...e,id:i},selector:{type:\"FragmentSelector\",value:r}}:{type:\"SpecificResource\",source:{...e,id:i}}}return{type:\"SpecificResource\",source:e}}var Le={Collection:{},Manifest:{},Canvas:{},AnnotationPage:{},AnnotationCollection:{},Annotation:{},ContentResource:{},Range:{},Service:{},Selector:{},Agent:{}};function ae(){return{Collection:{},Manifest:{},Canvas:{},AnnotationPage:{},AnnotationCollection:{},Annotation:{},ContentResource:{},Range:{},Service:{},Selector:{},Agent:{}}}function Z(e,n){if(typeof e==\"string\")return{id:e,type:n};if(!e.id)throw new Error(`Invalid resource does not have an ID (${JSON.stringify(e)}, ${n})`);return e}function se(e,n){return(i,r)=>{let t=e[i]?e[i]:{};return(a,s)=>{let c=Z(a,r||i);return c&&c.id&&i?(t[c.id]=t[c.id]?W(t[c.id],c,{parent:s.parent,isTopLevel:n.id===c.id}):W({id:c.id,type:c.type},c,{parent:s.parent,isTopLevel:n.id===c.id}),{id:c.id,type:i===\"ContentResource\"?i:c.type}):c}}}function $(e,n,i){if(!n)return e;if(Array.isArray(e)){if(!Array.isArray(n))throw new Error(\"Cannot merge array with non-array\");let r=[...e];for(let t of n)if(t[\"@id\"]&&!t.id&&(t.id=t[\"@id\"]),t[\"@type\"]&&!t.type&&(t.type=t[\"@type\"]),t!=null)if(Array.isArray(t))r.push(t);else if(typeof t==\"object\"&&t.id&&t.type){let a=r.findIndex(s=>s.id===t.id&&s.type===t.type);a>=0&&(r[a]=$(r[a],t))}else e.indexOf(t)===-1&&r.push(t);return r}else if(typeof e==\"object\"){if(Array.isArray(n)||typeof n!=\"object\")throw new Error(\"Cannot merge object with non-object\");let r={...e},t=[],a=[],s=Object.keys(e).filter(l=>l!==f&&l!==\"id\"&&l!==\"type\"),c={},A={};for(let[l,u]of Object.entries(n)){if(l===f||l===\"id\"||l===\"type\")continue;let y=r[l];y===u?a.push(l):y===o||!y?(t.push(l),r[l]=u):(y&&u&&(c[l]=y,A[l]=u),r[l]=$(y,u),r[l]===c[l]&&(a.push(l),delete c[l]))}if(i&&(i.parent&&i.parent.id||i.isTopLevel)){let l=[],u={};if(i.parent?u[g]=i.parent.id:i.isTopLevel&&(u[g]=e.id),r[f]&&r[f].length){let y=!(r[f]||[]).find(v=>v[\"@explicit\"]),C=t.length>0||a.length!==s.length;if(y&&C)for(let v of r[f]){let p={...v},j=Object.keys(c);if(p){p[\"@explicit\"]=!0;for(let M of s)M!==f&&(p[M]=w);for(let M of j)p[M]=c[M]}l.push(p)}else l.push(...r[f]);if(C){let v=Object.keys(A);u[\"@explicit\"]=!0;for(let p of t)u[p]=w;for(let p of a)u[p]=w;for(let p of v)u[p]=A[p]}}u.id=r.id,u.type=r.type,l.push(u),r[f]=l}return r}else if(e)return e;return n}function W(e,n,i){if(typeof e==\"string\")return e;if(n.id!==e.id||n.type!==e.type){if(n.type===\"ImageService3\")return n;if(e.type===\"ImageService3\")return e;throw new Error(`Can only merge entities with identical identifiers and type! ${n.type}(${n.id}) => ${e.type}(${e.id})`)}return $({...e},n,i)}function le(e){return(n,i)=>r=>{let{id:t,type:a}=Z(r,i||n);if(typeof t>\"u\")throw new Error(\"Found invalid entity without an ID.\");return n===\"ContentResource\"||n===\"Service\"?e[t]=n:e[t]=a,r}}function ce(e){let n=Object.assign({},e);if(n[\"@id\"]&&(n.id=n[\"@id\"]),n[\"@type\"]&&(n.type=n[\"@type\"]),n.service){let i=[];n.service=Array.isArray(n.service)?n.service:[n.service];for(let r of n.service)i.push({id:r[\"@id\"]||r.id,type:r[\"@type\"]||r.type});n.service=i}return Object.assign({},Q,n)}function de(e){return n=>{e.Service=e.Service?e.Service:{};let i=n.id||n[\"@id\"],r=ce(n);return r&&r.id&&(e.Service[r.id]?e.Service[i]=W(e.Service[i],r):e.Service[i]=r),n}}function ue(e){let n=JSON.stringify(e),i=5381,r=n.length;for(;r;)i=i*33^n.charCodeAt(--r);let a=(i>>>0).toString(16);return a.length%2?\"0\"+a:a}function U(e){return n=>typeof n==\"string\"?{id:n,type:e}:n.id?n.type?n:{type:e,...n}:{id:`vault://${ue(n)}`,type:e,...n}}function E(e){return n=>({...e,...n})}function D(e){return Array.isArray(e)?e:[e]}function fe(e){return e.body&&(e.body=D(e.body)),e.seeAlso&&(e.seeAlso=D(e.seeAlso)),e.audience&&(e.audience=D(e.audience)),e.accessibility&&(e.accessibility=D(e.accessibility)),e.motivation&&(e.motivation=D(e.motivation)),e}function ee(e,{typeHint:n,partOfTypeHint:i}={}){if(typeof e==\"string\"&&(e={id:e,type:n||\"unknown\"}),z(e))return typeof e.source==\"string\"&&(e.source={id:e.source,type:n||\"unknown\"}),e.source.type===\"Canvas\"&&e.source.partOf&&typeof e.source.partOf==\"string\"&&(e.source.partOf=[{id:e.source.partOf,type:i||\"Manifest\"}]),e;let r;if((e.id||\"\").indexOf(\"#\")!==-1){let[t,a]=(e.id||\"\").split(\"#\");e.id=t,a&&(r={type:\"FragmentSelector\",value:a})}return{type:\"SpecificResource\",source:e,selector:r}}function pe(e){let n=Object.assign({},e);return e&&e.items&&(n.items=e.items.map(i=>typeof i==\"string\"||i.type===\"Canvas\"?ee(i):i)),n}function ye(e){let n=Object.assign({},e);return n.start?(n.start=ee(n.start,{typeHint:\"Canvas\"}),n):e}function me(e){let n=Object.assign({},e);return n.target?(n.target=_(n.target,{typeHint:\"Canvas\"}),n):e}function ve(e){return e}function q(e){return typeof e.items>\"u\"&&(e[T]=!0),e}function Fe(e){let n=V(e),i=ae(),r={},t=se(i,n),a=le(r),c=new H({collection:[q,E(X),a(\"Collection\"),t(\"Collection\")],manifest:[q,E(Y),ye,a(\"Manifest\"),t(\"Manifest\")],canvas:[E(G),a(\"Canvas\"),t(\"Canvas\")],annotationPage:[q,U(\"AnnotationPage\"),E(K),a(\"AnnotationPage\"),t(\"AnnotationPage\")],annotation:[U(\"Annotation\"),fe,me,a(\"Annotation\"),t(\"Annotation\")],contentResource:[U(\"ContentResource\"),a(\"ContentResource\"),t(\"ContentResource\")],range:[E(J),pe,a(\"Range\",\"Canvas\"),t(\"Range\",\"Canvas\")],agent:[E(B),a(\"Agent\"),t(\"Agent\")],specificResource:[ve],service:[de(i)]}).traverseUnknown(n);return{entities:i,resource:c,mapping:r}}function ge(e){let n={};for(let[i,r]of e){if(i===I&&r!==m)return r;r!==m&&typeof r<\"u\"&&r!==null&&(n[i]=r)}return n}function $e(e,n,i){if(!n.type||!n.id)throw new Error(\"Unknown entity\");if(!i[n.type])throw new Error(`Serializer not found for ${n.type}`);function r(t,a,s=0){let c=i[t.type];if(!c)return m;if(s>20)throw new Error(\"Circular reference: \"+t.id+\" \"+t.type);let[A,l]=F(e,t.type?t:t.id,a)||(t.id&&t.type?t:null);if(!A)return m;let u=c(A,e,{parent:a,isTopLevel:n.id===t.id,fullResource:l}),y=u.next();for(;!y.done;){let C=y.value,v=m;if(C)if(Array.isArray(C)){let p=[];for(let j of C)p.push(r(j,t,s+1));v=p}else v=r(C,t,s+1);y=u.next(v)}return y.value===m?m:ge(y.value)}return r(n)}function P(e,{allowSourceString:n=!0,allowString:i=!1,allowedStringType:r}={}){let t=a=>{if(n&&a&&a.source&&typeof a.source!=\"string\"){let s=Object.keys(a.source);if(a.source.id&&a.source.type&&s.length===2)return{...a,source:a.source.id}}return a};if(e){if(e.source&&e.source.partOf)return t(e);let a=Object.keys(e);if(a.length===2&&e.type&&e.source||a.length===3&&e.type&&e.source&&a.indexOf(\"selector\")!==-1&&!e.selector)return i&&(!r||r===e.source.type)?e.source.id:e.source.type===\"ContentResource\"?{type:\"SpecificResource\",source:e.source.id}:e.source;if(e.selector&&!Array.isArray(e.selector)&&typeof e.selector!=\"string\"&&e.selector.type===\"FragmentSelector\"){let s=`${e.source.id}#${e.selector.value}`;return i?s:{id:s,type:e.source.type}}}return t(e)}function O(e){if(!e)return;let n=Object.keys(e);if(n.length!==0){if(n.length===1){let i=n[0];if(!i)return\"\";let r=(e[i]||[]).join(\"\");return i===\"@none\"||i===\"none\"||i===\"en\"?r:{\"@language\":i,\"@value\":r}}return n.map(i=>({\"@language\":i,\"@value\":(e[i]||[]).join(\"\")}))}}function ne(e){return Array.isArray(e)?e.map(n=>ne(n)):typeof e==\"string\"?e:e.type&&e.type===\"Canvas\"?e.id:e}function h(e,n=!1){if(e)return e.length>1&&!n?e:e[0]||void 0}function he(e){if(e){if(typeof e==\"string\")return{\"@id\":e};if(\"@id\"in e){let n={...e};return delete n[\"@type\"],n}return{\"@context\":\"http://iiif.io/api/image/2/context.json\",\"@id\":e.id,profile:`http://iiif.io/api/image/2/profiles/${e.profile}.json`}}}function N(e,n){return[[\"@id\",e.id],[\"@type\",n],[\"format\",e.format],[\"height\",e.height],[\"width\",e.width],[\"viewingDirection\",e.viewingDirection!==\"left-to-right\"?e.viewingDirection:void 0],[\"license\",e.license?e.license:void 0]]}function*b(e){let n=e.provider?yield e.provider[0]:void 0;return[[\"label\",O(e.label)],[\"metadata\",e.metadata&&e.metadata.length?e.metadata.map(i=>({label:O(i.label)||\"\",value:O(i.value)||\"\"})):void 0],[\"description\",O(e.summary)],[\"thumbnail\",h(yield e.thumbnail)],[\"navDate\",e.navDate],[\"logo\",n?h(n.logo):void 0],[\"homepage\",n?n.homepage:void 0],[\"attribution\",e.requiredStatement?O(e.requiredStatement.value):void 0]]}function*k(e){let n=e.start&&e.start.type&&e.start.type===\"SpecificResource\"?P(e.start):e.start;return[[\"seeAlso\",h(yield e.seeAlso)],[\"service\",h((e.service||[]).map(he))],[\"rendering\",h(yield e.rendering)],[\"startCanvas\",n?n.id:void 0]]}function Se(e){return e.type===\"SpecificResource\"}function Re(e){return e&&e.type===\"FragmentSelector\"}function Ae(e){if(e&&Se(e)){let n=e.id,i=e.selector?Array.isArray(e.selector)?e.selector[0]:e.selector:void 0;return Re(i)&&(n+=\"#\"+i.value),n}return e?.id}var Ke={Manifest:function*(e,n,{isTopLevel:i}){return[...i?[[\"@context\",\"http://iiif.io/api/presentation/2/context.json\"]]:[],...N(e,\"sc:Manifest\"),...yield*b(e),...yield*k(e),[\"sequences\",[{\"@id\":`${e.id}/sequence0`,\"@type\":\"sc:Sequence\",canvases:yield e.items}]],[\"structures\",yield e.structures]]},Canvas:function*(e){let i=(yield e.items)[0];return[...N(e,\"sc:Canvas\"),...yield*b(e),...yield*k(e),[\"images\",i?[i.resources]:void 0],[\"annotations\",e.annotations&&e.annotations.length?h(yield e.annotations):void 0]]},AnnotationPage:function*(e){return[...N(e,\"sc:AnnotationList\"),...yield*b(e),[\"resources\",e.items&&e.items.length?h(yield e.items):void 0]]},Annotation:function*(e){return[[\"@id\",e.id],[\"@type\",\"oa:Annotation\"],[\"motivation\",\"sc:painting\"],[\"on\",ne(e.target)],[\"resource\",h(yield e.body,!0)]]},ContentResource:function*(e){switch(e.type){case\"Image\":return[...N(e,\"dctypes:Image\"),...yield*b(e),...yield*k(e)];case\"Text\":case\"Dataset\":default:return[...N(e,void 0),...yield*b(e)]}},AnnotationCollection:function*(e){return[[\"@id\",e.id],[\"@type\",\"sc:Layer\"],[\"label\",O(e.label)]]},Collection:function*(e){return[...N(e,\"sc:Collection\"),...yield*b(e),...yield*k(e),[\"members\",yield*e.items]]},Range:function*(e){let n=[],i=[];if(e.items)for(let r of e.items){let t=r.type===\"SpecificResource\"?r.source:r;if(t){let a=yield t;n.push({\"@id\":Ae(r),\"@type\":t.type,label:a?a.label:void 0,within:e.id}),t.type===\"Canvas\"&&i.push(t.id)}}return[...N(e,\"sc:Range\"),...yield*b(e),...yield*k(e),[\"canvases\",i.length===n.length?i:void 0],[\"members\",i.length!==n.length?n:void 0]]}};function x(e){return[[\"id\",e.id?.startsWith(\"vault://\")?void 0:e.id],[\"type\",e.type],[\"format\",e.format],[\"profile\",e.profile],[\"height\",e.height||void 0],[\"width\",e.width||void 0],[\"duration\",e.duration||void 0],[\"viewingDirection\",e.viewingDirection!==\"left-to-right\"?e.viewingDirection:void 0],[\"behavior\",e.behavior&&e.behavior.length?e.behavior:void 0],[\"timeMode\",e.timeMode],[\"motivation\",Array.isArray(e.motivation)?e.motivation[0]:e.motivation],[f,m]]}function d(e){if(e===m||!e||e.length===0)return;let n=e.filter(i=>i!==m);if(n.length!==0)return n}function re(e){if(e&&e.type&&e.type===\"ImageService2\"){let{id:n,type:i,profile:r,...t}=e,a=typeof r==\"string\"?r:Array.isArray(r)?r.find(s=>typeof s==\"string\"):\"\";return{\"@id\":n,\"@type\":i,profile:a?a.startsWith(\"http\")?a:`http://iiif.io/api/image/2/${a}.json`:\"http://iiif.io/api/image/2/level0.json\",...t}}return e}function ie(e){if(Array.isArray(e)||(e=e?[e]:[]),!(!e||e.length===0))return e.map(re)}function*S(e){return[[\"label\",e.label],[\"metadata\",d(e.metadata)],[\"summary\",e.summary],[\"requiredStatement\",e.requiredStatement],[\"rights\",Array.isArray(e.rights)?e.rights[0]||void 0:e.rights||void 0],[\"navDate\",e.navDate],[\"language\",e.language],[\"thumbnail\",d(yield e.thumbnail)],[\"placeholderCanvas\",yield e.placeholderCanvas],[\"accompanyingCanvas\",yield e.accompanyingCanvas],[\"provider\",d(yield e.provider)]]}function*R(e,n){let i=[];for(let r of e.partOf||[])r.type===\"Manifest\"&&n.type===\"Manifest\"||i.push(yield r);return[[\"seeAlso\",d(yield e.seeAlso)],[\"service\",d(ie(e.service))],[\"services\",d(ie(e.services))],[\"rendering\",d(yield e.rendering)],[\"supplementary\",d(yield e.supplementary)],[\"homepage\",d(yield e.homepage)],[\"logo\",d(yield e.logo)],[\"partOf\",d(i)],[\"start\",e.start?P(e.start):e.start]]}var Be={Manifest:function*(e,n,{isTopLevel:i}){return i?[[\"@context\",e[\"@context\"]?e[\"@context\"]:\"http://iiif.io/api/presentation/3/context.json\"],...x(e),...yield*S(e),...yield*R(e),[\"items\",yield e.items],[\"structures\",d(yield e.structures)],[\"annotations\",d(yield e.annotations)],[\"navPlace\",e.navPlace]]:[...x(e),...yield*S(e)]},Canvas:function*(e,n,{parent:i}){return i&&i.type!==\"Manifest\"&&i.type!==\"Canvas\"?[[\"id\",e.id]]:[...x(e),...yield*S(e),...yield*R(e,i),[\"items\",yield e.items],[\"annotations\",d(yield e.annotations)],[\"navPlace\",e.navPlace]]},Agent:function*(e){return[[\"id\",e.id],[\"type\",\"Agent\"],[\"label\",e.label],...yield*R(e)]},AnnotationPage:function*(e){let n=Object.entries(e).map(([r,t])=>[r,Array.isArray(t)?d(t):t]).filter(([r,t])=>r!==\"items\"&&r!==\"id\"&&r!==f&&r!==g&&r!==T),i=yield e.items;return[[\"id\",e.id?.startsWith(\"vault://\")?void 0:e.id],...n,...yield*R(e),[\"items\",i.length||e[T]===!1?i:m]]},Service:function*(e){return[[I,re(e)]]},Annotation:function*(e){let n=Object.entries(e).map(([r,t])=>r===\"motivation\"?[r,Array.isArray(t)?t[0]:t]:r===\"target\"?[r,P(t,{allowString:!0,allowSourceString:!0,allowedStringType:\"Canvas\"})]:[r,Array.isArray(t)?d(t):t]).filter(([r])=>r!==\"body\"&&r!==f&&r!==T),i;if(Array.isArray(e.body)){let r=[];for(let t of e.body)if(t&&z(t)){let a={...t};t.source.type!==\"Canvas\"?a.source=yield t.source:a.source=t.source,r.push(P(a,{allowSourceString:!0}))}else r.push(yield t);i=r}else e.body&&z(e.body)?(i={...e.body},i.source=yield e.body.source):i=yield e.body;return[...n,...yield*S(e),...yield*R(e),[\"body\",i.length===1?i[0]:i]]},ContentResource:function*(e){return Ce([...x(e),...yield*S(e),...yield*R(e),[\"annotations\",d(yield e.annotations)],[\"items\",d(yield e.items)]],e)},AnnotationCollection:function*(e){return[[\"id\",e.id],[\"type\",\"AnnotationCollection\"],[\"label\",e.label]]},Collection:function*(e,n,{isTopLevel:i}){return i?[[\"@context\",\"http://iiif.io/api/presentation/3/context.json\"],...x(e),...yield*S(e),...yield*R(e),[\"items\",d(yield e.items)],[\"navPlace\",e.navPlace]]:[...x(e),...yield*S(e)]},Range:function*(e){let n=[];for(let i of e.items)i.type===\"Range\"?n.push(yield i):i&&i.type===\"SpecificResource\"?n.push(P(i)):n.push(i);return[...x(e),...yield*S(e),...yield*R(e),[\"items\",n],[\"annotations\",d(yield e.annotations)],[\"navPlace\",e.navPlace]]}};function Ce(e,n){let i=Object.keys(n),r=e.map(([t])=>t);for(let t of i)t===f||t===T||r.indexOf(t)===-1&&typeof n[t]<\"u\"&&e.push([t,n[t]]);return e}export{L as a,w as b,f as c,g as d,T as e,m as f,I as g,o as h,te as i,oe as j,F as k,xe as l,K as m,G as n,X as o,Y as p,J as q,B as r,Q as s,Le as t,ae as u,$ as v,W as w,ve as x,q as y,Fe as z,ge as A,$e as B,P as C,O as D,Ke as E,Be as F};\n","// src/vault/utility/typesafe-actions-runtime.ts\nvar createAction = function createAction2(type) {\n  return function() {\n    const base = { type, getType: () => type, toString: () => type };\n    return (payload, meta) => ({\n      ...base,\n      ...payload !== void 0 && { payload },\n      ...meta !== void 0 && { meta }\n    });\n  };\n};\n\n// src/vault/actions/entity-actions.ts\nvar IMPORT_ENTITIES = \"@iiif/IMPORT_ENTITIES\";\nvar MODIFY_ENTITY_FIELD = \"@iiif/MODIFY_ENTITY_FIELD\";\nvar REORDER_ENTITY_FIELD = \"@iiif/REORDER_ENTITY_FIELD\";\nvar ADD_REFERENCE = \"@iiif/ADD_REFERENCE\";\nvar UPDATE_REFERENCE = \"@iiif/UPDATE_REFERENCE\";\nvar REMOVE_REFERENCE = \"@iiif/REMOVE_REFERENCE\";\nvar ADD_METADATA = \"@iiif/ADD_METADATA\";\nvar REMOVE_METADATA = \"@iiif/REMOVE_METADATA\";\nvar UPDATE_METADATA = \"@iiif/UPDATE_METADATA\";\nvar REORDER_METADATA = \"@iiif/REORDER_METADATA\";\nvar importEntities = createAction(IMPORT_ENTITIES)();\nvar modifyEntityField = createAction(MODIFY_ENTITY_FIELD)();\nvar reorderEntityField = createAction(REORDER_ENTITY_FIELD)();\nvar addReference = createAction(ADD_REFERENCE)();\nvar removeReference = createAction(REMOVE_REFERENCE)();\nvar updateReference = createAction(UPDATE_REFERENCE)();\nvar addMetadata = createAction(ADD_METADATA)();\nvar updateMetadata = createAction(UPDATE_METADATA)();\nvar removeMetadata = createAction(REMOVE_METADATA)();\nvar reorderMetadata = createAction(REORDER_METADATA)();\nvar entityActions = {\n  importEntities,\n  modifyEntityField,\n  reorderEntityField,\n  addReference,\n  removeReference,\n  updateReference,\n  addMetadata,\n  removeMetadata,\n  updateMetadata,\n  reorderMetadata\n};\n\n// src/vault/actions/mapping-actions.ts\nvar ADD_MAPPING = \"@iiif/ADD_MAPPING\";\nvar ADD_MAPPINGS = \"@iiif/ADD_MAPPINGS\";\nvar addMapping = createAction(ADD_MAPPING)();\nvar addMappings = createAction(ADD_MAPPINGS)();\nvar mappingActions = { addMapping, addMappings };\n\n// src/vault/actions/request-actions.ts\nvar RESOURCE_ERROR = \"RESOURCE_ERROR\";\nvar RESOURCE_LOADING = \"RESOURCE_LOADING\";\nvar RESOURCE_READY = \"RESOURCE_READY\";\nvar REQUEST_RESOURCE = \"@iiif/REQUEST_RESOURCE\";\nvar REQUEST_ERROR = \"@iiif/REQUEST_ERROR\";\nvar REQUEST_MISMATCH = \"@iiif/REQUEST_MISMATCH\";\nvar REQUEST_COMPLETE = \"@iiif/REQUEST_COMPLETE\";\nvar REQUEST_OFFLINE_RESOURCE = \"@iiif/REQUEST_OFFLINE_RESOURCE\";\nvar requestResource = createAction(REQUEST_RESOURCE)();\nvar requestError = createAction(REQUEST_ERROR)();\nvar requestMismatch = createAction(REQUEST_MISMATCH)();\nvar requestComplete = createAction(REQUEST_COMPLETE)();\nvar requestOfflineResource = createAction(REQUEST_OFFLINE_RESOURCE)();\nvar requestActions = {\n  requestResource,\n  requestError,\n  requestMismatch,\n  requestComplete,\n  requestOfflineResource\n};\n\n// src/vault/actions/batch-actions.ts\nvar BATCH_ACTIONS = \"@iiif/BATCH\";\nvar BATCH_IMPORT = \"@iiif/BATCH_IMPORT\";\nvar batchActions = createAction(BATCH_ACTIONS)();\nvar batchImport = createAction(BATCH_IMPORT)();\n\nexport {\n  createAction,\n  IMPORT_ENTITIES,\n  MODIFY_ENTITY_FIELD,\n  REORDER_ENTITY_FIELD,\n  ADD_REFERENCE,\n  UPDATE_REFERENCE,\n  REMOVE_REFERENCE,\n  ADD_METADATA,\n  REMOVE_METADATA,\n  UPDATE_METADATA,\n  REORDER_METADATA,\n  importEntities,\n  modifyEntityField,\n  reorderEntityField,\n  addReference,\n  removeReference,\n  updateReference,\n  addMetadata,\n  updateMetadata,\n  removeMetadata,\n  reorderMetadata,\n  entityActions,\n  ADD_MAPPING,\n  ADD_MAPPINGS,\n  addMapping,\n  addMappings,\n  mappingActions,\n  RESOURCE_ERROR,\n  RESOURCE_LOADING,\n  RESOURCE_READY,\n  REQUEST_RESOURCE,\n  REQUEST_ERROR,\n  REQUEST_MISMATCH,\n  REQUEST_COMPLETE,\n  REQUEST_OFFLINE_RESOURCE,\n  requestResource,\n  requestError,\n  requestMismatch,\n  requestComplete,\n  requestOfflineResource,\n  requestActions,\n  BATCH_ACTIONS,\n  BATCH_IMPORT,\n  batchActions,\n  batchImport\n};\n","import {\n  RESOURCE_ERROR,\n  RESOURCE_LOADING,\n  RESOURCE_READY,\n  addMapping,\n  addMappings,\n  batchActions,\n  importEntities,\n  requestComplete,\n  requestError,\n  requestMismatch,\n  requestResource\n} from \"./chunk-F2Q2OM3J.js\";\n\n// src/vault/utility/action-list-from-resource.ts\nimport { normalize } from \"@iiif/parser\";\nvar actionListFromResource = (id, response) => {\n  const { entities, resource, mapping } = normalize(response);\n  if (resource.id === void 0) {\n    return [requestError({ id, message: \"ID is not defined in resource.\" })];\n  }\n  const actions = [importEntities({ entities }), addMappings({ mapping })];\n  if (resource.id !== id) {\n    actions.push(addMapping({ id, type: resource.type }));\n    actions.push(requestMismatch({ requestId: id, actualId: resource.id }));\n  }\n  actions.push(requestComplete({ id }));\n  return actions;\n};\n\n// src/vault/utility/are-inputs-equal.ts\nvar safeIsNaN = Number.isNaN || function ponyfill(value) {\n  return typeof value === \"number\" && value !== value;\n};\nfunction isEqual(first, second) {\n  if (first === second) {\n    return true;\n  }\n  if (safeIsNaN(first) && safeIsNaN(second)) {\n    return true;\n  }\n  return false;\n}\nfunction areInputsEqual(newInputs, lastInputs) {\n  if (!Array.isArray(newInputs) || !Array.isArray(lastInputs)) {\n    return newInputs === lastInputs;\n  }\n  if (newInputs.length !== lastInputs.length) {\n    return false;\n  }\n  for (let i = 0; i < newInputs.length; i++) {\n    if (!isEqual(newInputs[i], lastInputs[i])) {\n      return false;\n    }\n  }\n  return true;\n}\n\n// src/vault/utility/resolve-if-exists.ts\nimport { frameResource, HAS_PART, PART_OF } from \"@iiif/parser\";\nfunction resolveIfExists(state, url, parent) {\n  const request = state.iiif.requests[url];\n  const resourceType = state.iiif.mapping[url];\n  if (!resourceType || !state.iiif.entities[resourceType][request.resourceUri]) {\n    return void 0;\n  }\n  const fullEntity = state.iiif.entities[resourceType][request.resourceUri];\n  if (fullEntity && fullEntity[HAS_PART]) {\n    const framing = fullEntity[HAS_PART].find((t) => {\n      return parent ? t[PART_OF] === parent.id : t[PART_OF] === fullEntity.id;\n    });\n    return frameResource(fullEntity, framing);\n  }\n  return fullEntity;\n}\n\n// src/vault/utility/is-promise.ts\nfunction isPromise(value) {\n  return value && typeof value.then === \"function\";\n}\n\n// src/vault/utility/create-fetch-helper.ts\nfunction createFetchHelper(vault, fetcher, { waitTimeout = 30 } = {}) {\n  return (url, options) => {\n    const store = vault.getStore();\n    const state = store.getState();\n    const request = state.iiif.requests[url];\n    if (request) {\n      if (request.loadingState === RESOURCE_READY) {\n        const resolvedEntity = resolveIfExists(state, url);\n        if (resolvedEntity) {\n          return resolvedEntity;\n        }\n      }\n      switch (request.loadingState) {\n        case RESOURCE_ERROR:\n          break;\n        case RESOURCE_LOADING: {\n          return (async () => {\n            let cleanupSubscription;\n            let didContinue = false;\n            try {\n              const resolvedEntity = await Promise.race([\n                new Promise((resolve, reject) => {\n                  if (didContinue) {\n                    return;\n                  }\n                  cleanupSubscription = store.subscribe(() => {\n                    const latestState = store.getState();\n                    if (latestState.iiif.requests[url].loadingState === RESOURCE_ERROR) {\n                      reject();\n                      return;\n                    }\n                    if (latestState.iiif.requests[url].loadingState === RESOURCE_READY) {\n                      const maybeResolvedEntity = resolveIfExists(latestState, url);\n                      if (maybeResolvedEntity) {\n                        resolve(maybeResolvedEntity);\n                      } else {\n                        reject();\n                      }\n                    }\n                  });\n                }),\n                new Promise(\n                  (resolve, reject) => setTimeout(\n                    () => {\n                      didContinue = true;\n                      reject();\n                    },\n                    waitTimeout * 60 * 1e3\n                  )\n                )\n              ]);\n              if (cleanupSubscription) {\n                cleanupSubscription();\n              }\n              if (resolvedEntity) {\n                return resolvedEntity;\n              }\n            } catch (e) {\n              if (cleanupSubscription) {\n                cleanupSubscription();\n              }\n            }\n          })();\n        }\n      }\n    }\n    vault.dispatch(requestResource({ id: url }));\n    const importResource = (resource) => {\n      if (!resource) {\n        return void 0;\n      }\n      if (!resource.id && !resource[\"@id\"]) {\n        if (resource[\"@type\"]) {\n          resource[\"@id\"] = url;\n          resource.id = url;\n        } else {\n          resource.id = url;\n        }\n      }\n      const toDispatch = actionListFromResource(url, resource);\n      vault.dispatch(batchActions({ actions: toDispatch }));\n      return resolveIfExists(store.getState(), url);\n    };\n    try {\n      const resourceOrPromise = fetcher(url, options);\n      if (isPromise(resourceOrPromise)) {\n        return (async () => {\n          try {\n            return importResource(await resourceOrPromise);\n          } catch (err) {\n            vault.dispatch(requestError({ id: url, message: err.toString() }));\n            throw err;\n          }\n        })();\n      }\n      return importResource(resourceOrPromise);\n    } catch (err) {\n      vault.dispatch(requestError({ id: url, message: err.toString() }));\n      throw err;\n    }\n  };\n}\n\nexport {\n  actionListFromResource,\n  areInputsEqual,\n  resolveIfExists,\n  createFetchHelper\n};\n","import {\n  createAction\n} from \"./chunk-F2Q2OM3J.js\";\n\n// src/vault/actions/meta-actions.ts\nvar SET_META_VALUE = \"@iiif/SET_META_VALUE\";\nvar SET_META_VALUE_DYNAMIC = \"@iiif/SET_META_VALUE_DYNAMIC\";\nvar UNSET_META_VALUE = \"@iiif/UNSET_META_VALUE\";\nvar setMetaValue = createAction(SET_META_VALUE)();\nvar setMetaValueDynamic = createAction(SET_META_VALUE_DYNAMIC)();\nvar unsetMetaValue = createAction(UNSET_META_VALUE)();\nvar metaActions = {\n  setMetaValue,\n  setMetaValueDynamic,\n  unsetMetaValue\n};\n\nexport {\n  SET_META_VALUE,\n  SET_META_VALUE_DYNAMIC,\n  UNSET_META_VALUE,\n  metaActions\n};\n","// src/vault/utility/get-default-entities.ts\nfunction getDefaultEntities() {\n  return {\n    Collection: {},\n    Manifest: {},\n    Canvas: {},\n    AnnotationPage: {},\n    AnnotationCollection: {},\n    Annotation: {},\n    ContentResource: {},\n    Range: {},\n    Service: {},\n    Selector: {},\n    Agent: {}\n  };\n}\n\nexport {\n  getDefaultEntities\n};\n","import {\n  SET_META_VALUE,\n  SET_META_VALUE_DYNAMIC,\n  UNSET_META_VALUE\n} from \"./chunk-YAISZCRN.js\";\nimport {\n  getDefaultEntities\n} from \"./chunk-DU2KF6VF.js\";\nimport {\n  ADD_MAPPING,\n  ADD_MAPPINGS,\n  ADD_METADATA,\n  ADD_REFERENCE,\n  BATCH_ACTIONS,\n  BATCH_IMPORT,\n  IMPORT_ENTITIES,\n  MODIFY_ENTITY_FIELD,\n  REMOVE_METADATA,\n  REMOVE_REFERENCE,\n  REORDER_ENTITY_FIELD,\n  REORDER_METADATA,\n  REQUEST_COMPLETE,\n  REQUEST_ERROR,\n  REQUEST_MISMATCH,\n  REQUEST_OFFLINE_RESOURCE,\n  REQUEST_RESOURCE,\n  RESOURCE_ERROR,\n  RESOURCE_LOADING,\n  RESOURCE_READY,\n  UPDATE_METADATA,\n  UPDATE_REFERENCE\n} from \"./chunk-F2Q2OM3J.js\";\nimport {\n  createStore\n} from \"./chunk-2I7FN7JX.js\";\n\n// node_modules/.pnpm/zustand@4.5.2_react@18.2.0/node_modules/zustand/esm/middleware.mjs\nvar reduxImpl = (reducer, initial) => (set, _get, api) => {\n  api.dispatch = (action) => {\n    set((state) => reducer(state, action), false, action);\n    return action;\n  };\n  api.dispatchFromDevtools = true;\n  return { dispatch: (...a) => api.dispatch(...a), ...initial };\n};\nvar redux = reduxImpl;\nvar trackedConnections = /* @__PURE__ */ new Map();\nvar getTrackedConnectionState = (name) => {\n  const api = trackedConnections.get(name);\n  if (!api)\n    return {};\n  return Object.fromEntries(\n    Object.entries(api.stores).map(([key, api2]) => [key, api2.getState()])\n  );\n};\nvar extractConnectionInformation = (store, extensionConnector, options) => {\n  if (store === void 0) {\n    return {\n      type: \"untracked\",\n      connection: extensionConnector.connect(options)\n    };\n  }\n  const existingConnection = trackedConnections.get(options.name);\n  if (existingConnection) {\n    return { type: \"tracked\", store, ...existingConnection };\n  }\n  const newConnection = {\n    connection: extensionConnector.connect(options),\n    stores: {}\n  };\n  trackedConnections.set(options.name, newConnection);\n  return { type: \"tracked\", store, ...newConnection };\n};\nvar devtoolsImpl = (fn, devtoolsOptions = {}) => (set, get, api) => {\n  const { enabled, anonymousActionType, store, ...options } = devtoolsOptions;\n  let extensionConnector;\n  try {\n    extensionConnector = (enabled != null ? enabled : (import.meta.env ? import.meta.env.MODE : void 0) !== \"production\") && window.__REDUX_DEVTOOLS_EXTENSION__;\n  } catch (e) {\n  }\n  if (!extensionConnector) {\n    if ((import.meta.env ? import.meta.env.MODE : void 0) !== \"production\" && enabled) {\n      console.warn(\n        \"[zustand devtools middleware] Please install/enable Redux devtools extension\"\n      );\n    }\n    return fn(set, get, api);\n  }\n  const { connection, ...connectionInformation } = extractConnectionInformation(store, extensionConnector, options);\n  let isRecording = true;\n  api.setState = (state, replace, nameOrAction) => {\n    const r = set(state, replace);\n    if (!isRecording)\n      return r;\n    const action = nameOrAction === void 0 ? { type: anonymousActionType || \"anonymous\" } : typeof nameOrAction === \"string\" ? { type: nameOrAction } : nameOrAction;\n    if (store === void 0) {\n      connection == null ? void 0 : connection.send(action, get());\n      return r;\n    }\n    connection == null ? void 0 : connection.send(\n      {\n        ...action,\n        type: `${store}/${action.type}`\n      },\n      {\n        ...getTrackedConnectionState(options.name),\n        [store]: api.getState()\n      }\n    );\n    return r;\n  };\n  const setStateFromDevtools = (...a) => {\n    const originalIsRecording = isRecording;\n    isRecording = false;\n    set(...a);\n    isRecording = originalIsRecording;\n  };\n  const initialState = fn(api.setState, get, api);\n  if (connectionInformation.type === \"untracked\") {\n    connection == null ? void 0 : connection.init(initialState);\n  } else {\n    connectionInformation.stores[connectionInformation.store] = api;\n    connection == null ? void 0 : connection.init(\n      Object.fromEntries(\n        Object.entries(connectionInformation.stores).map(([key, store2]) => [\n          key,\n          key === connectionInformation.store ? initialState : store2.getState()\n        ])\n      )\n    );\n  }\n  if (api.dispatchFromDevtools && typeof api.dispatch === \"function\") {\n    let didWarnAboutReservedActionType = false;\n    const originalDispatch = api.dispatch;\n    api.dispatch = (...a) => {\n      if ((import.meta.env ? import.meta.env.MODE : void 0) !== \"production\" && a[0].type === \"__setState\" && !didWarnAboutReservedActionType) {\n        console.warn(\n          '[zustand devtools middleware] \"__setState\" action type is reserved to set state from the devtools. Avoid using it.'\n        );\n        didWarnAboutReservedActionType = true;\n      }\n      originalDispatch(...a);\n    };\n  }\n  connection.subscribe((message) => {\n    var _a;\n    switch (message.type) {\n      case \"ACTION\":\n        if (typeof message.payload !== \"string\") {\n          console.error(\n            \"[zustand devtools middleware] Unsupported action format\"\n          );\n          return;\n        }\n        return parseJsonThen(\n          message.payload,\n          (action) => {\n            if (action.type === \"__setState\") {\n              if (store === void 0) {\n                setStateFromDevtools(action.state);\n                return;\n              }\n              if (Object.keys(action.state).length !== 1) {\n                console.error(\n                  `\n                    [zustand devtools middleware] Unsupported __setState action format. \n                    When using 'store' option in devtools(), the 'state' should have only one key, which is a value of 'store' that was passed in devtools(),\n                    and value of this only key should be a state object. Example: { \"type\": \"__setState\", \"state\": { \"abc123Store\": { \"foo\": \"bar\" } } }\n                    `\n                );\n              }\n              const stateFromDevtools = action.state[store];\n              if (stateFromDevtools === void 0 || stateFromDevtools === null) {\n                return;\n              }\n              if (JSON.stringify(api.getState()) !== JSON.stringify(stateFromDevtools)) {\n                setStateFromDevtools(stateFromDevtools);\n              }\n              return;\n            }\n            if (!api.dispatchFromDevtools)\n              return;\n            if (typeof api.dispatch !== \"function\")\n              return;\n            api.dispatch(action);\n          }\n        );\n      case \"DISPATCH\":\n        switch (message.payload.type) {\n          case \"RESET\":\n            setStateFromDevtools(initialState);\n            if (store === void 0) {\n              return connection == null ? void 0 : connection.init(api.getState());\n            }\n            return connection == null ? void 0 : connection.init(getTrackedConnectionState(options.name));\n          case \"COMMIT\":\n            if (store === void 0) {\n              connection == null ? void 0 : connection.init(api.getState());\n              return;\n            }\n            return connection == null ? void 0 : connection.init(getTrackedConnectionState(options.name));\n          case \"ROLLBACK\":\n            return parseJsonThen(message.state, (state) => {\n              if (store === void 0) {\n                setStateFromDevtools(state);\n                connection == null ? void 0 : connection.init(api.getState());\n                return;\n              }\n              setStateFromDevtools(state[store]);\n              connection == null ? void 0 : connection.init(getTrackedConnectionState(options.name));\n            });\n          case \"JUMP_TO_STATE\":\n          case \"JUMP_TO_ACTION\":\n            return parseJsonThen(message.state, (state) => {\n              if (store === void 0) {\n                setStateFromDevtools(state);\n                return;\n              }\n              if (JSON.stringify(api.getState()) !== JSON.stringify(state[store])) {\n                setStateFromDevtools(state[store]);\n              }\n            });\n          case \"IMPORT_STATE\": {\n            const { nextLiftedState } = message.payload;\n            const lastComputedState = (_a = nextLiftedState.computedStates.slice(-1)[0]) == null ? void 0 : _a.state;\n            if (!lastComputedState)\n              return;\n            if (store === void 0) {\n              setStateFromDevtools(lastComputedState);\n            } else {\n              setStateFromDevtools(lastComputedState[store]);\n            }\n            connection == null ? void 0 : connection.send(\n              null,\n              // FIXME no-any\n              nextLiftedState\n            );\n            return;\n          }\n          case \"PAUSE_RECORDING\":\n            return isRecording = !isRecording;\n        }\n        return;\n    }\n  });\n  return initialState;\n};\nvar devtools = devtoolsImpl;\nvar parseJsonThen = (stringified, f) => {\n  let parsed;\n  try {\n    parsed = JSON.parse(stringified);\n  } catch (e) {\n    console.error(\n      \"[zustand devtools middleware] Could not parse the received json\",\n      e\n    );\n  }\n  if (parsed !== void 0)\n    f(parsed);\n};\nvar subscribeWithSelectorImpl = (fn) => (set, get, api) => {\n  const origSubscribe = api.subscribe;\n  api.subscribe = (selector, optListener, options) => {\n    let listener = selector;\n    if (optListener) {\n      const equalityFn = (options == null ? void 0 : options.equalityFn) || Object.is;\n      let currentSlice = selector(api.getState());\n      listener = (state) => {\n        const nextSlice = selector(state);\n        if (!equalityFn(currentSlice, nextSlice)) {\n          const previousSlice = currentSlice;\n          optListener(currentSlice = nextSlice, previousSlice);\n        }\n      };\n      if (options == null ? void 0 : options.fireImmediately) {\n        optListener(currentSlice, currentSlice);\n      }\n    }\n    return origSubscribe(listener);\n  };\n  const initialState = fn(set, get, api);\n  return initialState;\n};\nvar subscribeWithSelector = subscribeWithSelectorImpl;\n\n// src/vault/store/reducers/mapping-reducer.ts\nvar mappingReducer = (state = {}, action) => {\n  switch (action.type) {\n    case ADD_MAPPING:\n      return {\n        ...state,\n        [action.payload.id]: action.payload.type\n      };\n    case ADD_MAPPINGS:\n      return {\n        ...state,\n        ...action.payload.mapping\n      };\n    default:\n      return state;\n  }\n};\n\n// src/vault/utility/is-reference-list.ts\nfunction isReferenceList(state, id, type, key) {\n  return !(!state[type] || !state[type][id] || !state[type][id][key] || !Array.isArray(state[type][id][key]));\n}\n\n// src/vault/utility/quick-merge.ts\nfunction quickMerge(a, b) {\n  const newResource = {};\n  const added = [];\n  for (const [key, value] of Object.entries(a || {})) {\n    added.push(key);\n    const bValue = (b || {})[key];\n    if (!bValue || bValue.length === 0) {\n      newResource[key] = value;\n      continue;\n    }\n    newResource[key] = bValue;\n  }\n  for (const [key, value] of Object.entries(b || {})) {\n    if (added.indexOf(key) !== -1) {\n      continue;\n    }\n    newResource[key] = value;\n  }\n  return newResource;\n}\n\n// src/vault/store/reducers/entities-reducer.ts\nfunction payload(action) {\n  return action.payload;\n}\nfunction numberOr(a, b) {\n  return typeof a === \"undefined\" ? b : a;\n}\nvar entitiesReducer = (state = getDefaultEntities(), action) => {\n  const updateField = (entity, values) => {\n    return {\n      ...state,\n      [payload(action).type]: {\n        ...state[payload(action).type],\n        [payload(action).id]: {\n          ...entity,\n          ...values\n        }\n      }\n    };\n  };\n  switch (action.type) {\n    case MODIFY_ENTITY_FIELD: {\n      if (!state[payload(action).type] || !state[payload(action).type][payload(action).id]) {\n        return state;\n      }\n      const entity = state[payload(action).type][payload(action).id];\n      if (typeof entity === \"string\") {\n        return state;\n      }\n      return updateField(entity, { [payload(action).key]: payload(action).value });\n    }\n    case REORDER_ENTITY_FIELD: {\n      if (!isReferenceList(state, payload(action).id, payload(action).type, payload(action).key)) {\n        return state;\n      }\n      const entity = state[payload(action).type][payload(action).id];\n      if (typeof entity === \"string\") {\n        return state;\n      }\n      const result = Array.from(entity[payload(action).key]);\n      const [removed] = result.splice(payload(action).startIndex, 1);\n      result.splice(payload(action).endIndex, 0, removed);\n      return updateField(entity, { [payload(action).key]: result });\n    }\n    case IMPORT_ENTITIES: {\n      const keys = Object.keys(payload(action).entities);\n      const toReturn = { ...state };\n      for (const key of keys) {\n        const entities = payload(action).entities[key];\n        const newEntities = { ...state[key] || {} };\n        let changed = false;\n        const ids = Object.keys(entities || {}) || [];\n        if (entities && ids) {\n          for (const id of ids) {\n            changed = true;\n            newEntities[id] = state[key][id] ? quickMerge(state[key][id], entities[id]) : entities[id];\n          }\n          if (changed) {\n            toReturn[key] = newEntities;\n          }\n        }\n      }\n      return toReturn;\n    }\n    case ADD_REFERENCE: {\n      if (!isReferenceList(state, payload(action).id, payload(action).type, payload(action).key)) {\n        return state;\n      }\n      const entity = state[payload(action).type][payload(action).id];\n      const result = Array.from(entity[payload(action).key]);\n      result.splice(numberOr(payload(action).index, result.length + 1), 0, payload(action).reference);\n      return updateField(entity, { [payload(action).key]: result });\n    }\n    case UPDATE_REFERENCE:\n    case REMOVE_REFERENCE: {\n      if (!isReferenceList(state, payload(action).id, payload(action).type, payload(action).key)) {\n        return state;\n      }\n      const entity = state[payload(action).type][payload(action).id];\n      const result = Array.from(entity[payload(action).key]);\n      const indexToRemove = numberOr(\n        payload(action).index,\n        result.findIndex((e) => e && e.id === payload(action).reference.id)\n      );\n      if (indexToRemove === -1 || result[indexToRemove]?.id !== payload(action).reference.id) {\n        return state;\n      }\n      if (action.type === UPDATE_REFERENCE) {\n        result.splice(indexToRemove, 1, payload(action).reference);\n      } else {\n        result.splice(indexToRemove, 1);\n      }\n      return updateField(entity, { [payload(action).key]: result });\n    }\n    case ADD_METADATA: {\n      const entity = state[payload(action).type][payload(action).id];\n      if (!entity) {\n        return state;\n      }\n      const metadata = Array.from(entity.metadata || []);\n      const actionPayload = payload(action);\n      metadata.splice(numberOr(action.payload.beforeIndex, metadata.length + 1), 0, {\n        label: actionPayload.label,\n        value: actionPayload.label\n      });\n      return updateField(entity, { metadata });\n    }\n    case REORDER_METADATA: {\n      const entity = state[payload(action).type][payload(action).id];\n      if (typeof entity === \"string\" || !entity) {\n        return state;\n      }\n      const metadata = Array.from(entity.metadata || []);\n      const [removed] = metadata.splice(payload(action).startIndex, 1);\n      metadata.splice(payload(action).endIndex, 0, removed);\n      return updateField(entity, { metadata });\n    }\n    case UPDATE_METADATA:\n    case REMOVE_METADATA: {\n      const entity = state[payload(action).type][payload(action).id];\n      const metadata = Array.from(entity.metadata || []);\n      const indexToRemove = payload(action).atIndex;\n      if (typeof indexToRemove === \"undefined\" || indexToRemove === -1 || !metadata[indexToRemove]) {\n        return state;\n      }\n      if (action.type === UPDATE_METADATA) {\n        metadata.splice(indexToRemove, 1, { label: payload(action).label, value: payload(action).value });\n      } else {\n        metadata.splice(indexToRemove, 1);\n      }\n      return updateField(entity, { metadata });\n    }\n    default:\n      return state;\n  }\n};\n\n// src/vault/store/reducers/request-reducer.ts\nvar requestReducer = (state = {}, action) => {\n  switch (action.type) {\n    case REQUEST_RESOURCE:\n    case REQUEST_OFFLINE_RESOURCE:\n      return {\n        ...state,\n        [action.payload.id]: {\n          requestUri: action.payload.id,\n          loadingState: RESOURCE_LOADING,\n          uriMismatch: false,\n          resourceUri: action.payload.id\n        }\n      };\n    case REQUEST_MISMATCH:\n      return {\n        ...state,\n        [action.payload.requestId]: {\n          ...state[action.payload.requestId] || {},\n          uriMismatch: true,\n          resourceUri: action.payload.actualId\n        },\n        [action.payload.actualId]: {\n          requestUri: action.payload.requestId,\n          loadingState: state[action.payload.requestId].loadingState,\n          uriMismatch: true,\n          resourceUri: action.payload.actualId\n        }\n      };\n    case REQUEST_ERROR:\n      return {\n        ...state,\n        [action.payload.id]: {\n          ...state[action.payload.id] || {},\n          loadingState: RESOURCE_ERROR,\n          error: action.payload.message\n        }\n      };\n    case REQUEST_COMPLETE:\n      return {\n        ...state,\n        [action.payload.id]: {\n          ...state[action.payload.id] || {},\n          loadingState: RESOURCE_READY,\n          error: void 0\n        }\n      };\n  }\n  return state;\n};\n\n// src/vault/store/reducers/meta-reducer.ts\nvar metaReducer = (state = {}, action) => {\n  const { id, updateValue, value, meta, key } = action && action.payload || {};\n  switch (action.type) {\n    case SET_META_VALUE: {\n      return {\n        ...state,\n        [id]: {\n          ...state[id] || {},\n          [meta]: {\n            ...state[id] ? state[id][meta] || {} : {},\n            [key]: value\n          }\n        }\n      };\n    }\n    case SET_META_VALUE_DYNAMIC: {\n      return {\n        ...state,\n        [id]: {\n          ...state[id] || {},\n          [meta]: {\n            ...state[id] ? state[id][meta] || {} : {},\n            [key]: state[id] && state[id][meta] ? updateValue(state[id][meta][key]) : updateValue(void 0)\n          }\n        }\n      };\n    }\n    case UNSET_META_VALUE: {\n      if (state[id] && state[id][meta] && state[id][meta][key]) {\n        return {\n          ...state,\n          [id]: {\n            ...state[id] || {},\n            [meta]: {\n              ...state[id] ? state[id][meta] || {} : {},\n              [key]: void 0\n            }\n          }\n        };\n      }\n      return state;\n    }\n    default:\n      return state;\n  }\n};\n\n// src/vault/utility/combine-reducers.ts\nfunction combineReducers(reducers2 = {}) {\n  const reducerKeys = Object.keys(reducers2);\n  return function combination(state = {}, action) {\n    let hasChanged = false;\n    const nextState = {};\n    for (let i = 0; i < reducerKeys.length; i++) {\n      const key = reducerKeys[i];\n      nextState[key] = reducers2[key](state[key], action);\n      hasChanged = hasChanged || nextState[key] !== state[key];\n    }\n    return hasChanged ? nextState : state;\n  };\n}\n\n// src/vault/store/reducers/batch-reducer.ts\nfunction createBatchReducer(rootReducer) {\n  return (state, action) => {\n    if (action && action.type === BATCH_ACTIONS) {\n      return action.payload.actions.reduce(rootReducer, state);\n    }\n    if (action && action.type === BATCH_IMPORT) {\n      return {\n        ...state,\n        iiif: {\n          ...state.iiif,\n          ...action.payload.state\n        }\n      };\n    }\n    return rootReducer(state, action);\n  };\n}\n\n// src/vault/store/index.ts\nvar reducers = combineReducers({\n  mapping: mappingReducer,\n  entities: entitiesReducer,\n  requests: requestReducer,\n  meta: metaReducer\n});\nfunction getDefaultState() {\n  return {\n    iiif: {\n      entities: getDefaultEntities(),\n      meta: {},\n      mapping: {},\n      requests: {}\n    }\n  };\n}\nfunction createStore2(options = {}) {\n  const {\n    enableDevtools = false,\n    iiifStoreName = \"iiif\",\n    defaultState = getDefaultState(),\n    customReducers = {}\n  } = options;\n  const rootReducer = createBatchReducer(combineReducers({ [iiifStoreName]: reducers, ...customReducers }));\n  const enabled = Boolean(typeof window !== \"undefined\" && window.__REDUX_DEVTOOLS_EXTENSION__);\n  const dv = !enabled || false ? (a, r) => a : devtools;\n  return createStore(\n    //\n    subscribeWithSelector(\n      //\n      dv(\n        //\n        redux(rootReducer, defaultState),\n        { enabled: enableDevtools }\n      )\n    )\n  );\n}\n\nexport {\n  reducers,\n  createStore2 as createStore\n};\n","// node_modules/.pnpm/mitt@3.0.1/node_modules/mitt/dist/mitt.mjs\nfunction mitt_default(n) {\n  return { all: n = n || /* @__PURE__ */ new Map(), on: function(t, e) {\n    var i = n.get(t);\n    i ? i.push(e) : n.set(t, [e]);\n  }, off: function(t, e) {\n    var i = n.get(t);\n    i && (e ? i.splice(i.indexOf(e) >>> 0, 1) : n.set(t, []));\n  }, emit: function(t, e) {\n    var i = n.get(t);\n    i && i.slice().map(function(n2) {\n      n2(e);\n    }), (i = n.get(\"*\")) && i.slice().map(function(n2) {\n      n2(t, e);\n    });\n  } };\n}\n\nexport {\n  mitt_default\n};\n","var __create = Object.create;\nvar __defProp = Object.defineProperty;\nvar __getOwnPropDesc = Object.getOwnPropertyDescriptor;\nvar __getOwnPropNames = Object.getOwnPropertyNames;\nvar __getProtoOf = Object.getPrototypeOf;\nvar __hasOwnProp = Object.prototype.hasOwnProperty;\nvar __defNormalProp = (obj, key, value) => key in obj ? __defProp(obj, key, { enumerable: true, configurable: true, writable: true, value }) : obj[key] = value;\nvar __commonJS = (cb, mod) => function __require() {\n  return mod || (0, cb[__getOwnPropNames(cb)[0]])((mod = { exports: {} }).exports, mod), mod.exports;\n};\nvar __copyProps = (to, from, except, desc) => {\n  if (from && typeof from === \"object\" || typeof from === \"function\") {\n    for (let key of __getOwnPropNames(from))\n      if (!__hasOwnProp.call(to, key) && key !== except)\n        __defProp(to, key, { get: () => from[key], enumerable: !(desc = __getOwnPropDesc(from, key)) || desc.enumerable });\n  }\n  return to;\n};\nvar __toESM = (mod, isNodeMode, target) => (target = mod != null ? __create(__getProtoOf(mod)) : {}, __copyProps(\n  // If the importer is in node compatibility mode or this is not an ESM\n  // file that has been converted to a CommonJS file using a Babel-\n  // compatible transform (i.e. \"__esModule\" has not been set), then set\n  // \"default\" to the CommonJS \"module.exports\" for node compatibility.\n  isNodeMode || !mod || !mod.__esModule ? __defProp(target, \"default\", { value: mod, enumerable: true }) : target,\n  mod\n));\nvar __publicField = (obj, key, value) => {\n  __defNormalProp(obj, typeof key !== \"symbol\" ? key + \"\" : key, value);\n  return value;\n};\n\nexport {\n  __commonJS,\n  __toESM,\n  __publicField\n};\n","import {\n  areInputsEqual,\n  createFetchHelper\n} from \"./chunk-EIMQCVDV.js\";\nimport {\n  createStore\n} from \"./chunk-OFD6EF4T.js\";\nimport {\n  metaActions\n} from \"./chunk-YAISZCRN.js\";\nimport {\n  BATCH_ACTIONS,\n  batchActions,\n  entityActions\n} from \"./chunk-F2Q2OM3J.js\";\nimport {\n  mitt_default\n} from \"./chunk-6NZ5BWVI.js\";\nimport {\n  __publicField\n} from \"./chunk-G7A32JAG.js\";\n\n// src/vault/vault.ts\nimport {\n  frameResource,\n  HAS_PART,\n  isSpecificResource,\n  PART_OF,\n  serialize,\n  serializeConfigPresentation2,\n  serializeConfigPresentation3\n} from \"@iiif/parser\";\n\n// src/vault/utility/objects.ts\nfunction defineProperty(name, prototype, vault, enumerable = true) {\n  prototype[DEFINED] = prototype[DEFINED] || [];\n  prototype[DEFINED].push(name);\n  const cache = /* @__PURE__ */ new Map();\n  Object.defineProperty(prototype, name, {\n    enumerable,\n    get() {\n      if (typeof prototype[REFS][name] === \"undefined\") {\n        return void 0;\n      }\n      const ref = prototype[REFS][name];\n      if (!ref) {\n        return ref;\n      }\n      const object = vault.get(prototype[REFS][name], {\n        parent: this.id ? { id: this.id, type: this.type } : void 0\n      });\n      if (!cache.has(object)) {\n        cache.clear();\n        cache.set(object, wrapObject(object, vault));\n      }\n      return cache.get(object);\n    },\n    set(items) {\n      const existing = prototype[REFS][name];\n      if (existing !== items) {\n        if (this[REACTIVE]) {\n          vault.modifyEntityField({ id: this.id, type: this.type }, name, unwrapObject(items));\n        } else {\n          this[REFS][name] = items;\n        }\n      }\n    }\n  });\n}\nvar REFS = Symbol.for(\"_refs_\");\nvar REACTIVE = Symbol.for(\"_reactive_\");\nvar DEFINED = Symbol.for(\"_defined_\");\nvar PARENT = Symbol.for(\"_parent_\");\nfunction createPrototype(vault, reactive = false, parent) {\n  const prototype = {\n    id: \"\",\n    type: \"unknown\",\n    [DEFINED]: [],\n    [REFS]: {},\n    [PARENT]: parent || null,\n    [REACTIVE]: null,\n    is(refOrObject) {\n      if (typeof refOrObject === \"string\") {\n        return this.id === refOrObject;\n      }\n      if (refOrObject.id) {\n        return refOrObject.id === this.id;\n      }\n      return false;\n    },\n    reactive() {\n      if (this[REACTIVE]) {\n        return;\n      }\n      this[REACTIVE] = this.subscribe(() => this.refresh(), true);\n      return () => {\n        this.unreactive();\n      };\n    },\n    refresh() {\n      if (this.id) {\n        const fresh = this.unwrap();\n        for (const key of Object.keys(fresh || {})) {\n          if (this[DEFINED].includes(key)) {\n            this[REFS][key] = fresh[key];\n          } else {\n            this[key] = fresh[key];\n          }\n        }\n      }\n    },\n    unreactive() {\n      if (this[REACTIVE]) {\n        this[REACTIVE]();\n        this[REACTIVE] = null;\n      }\n    },\n    unwrap() {\n      if (!this.id) {\n        throw new Error(\"Invalid object\");\n      }\n      const parent2 = this[PARENT];\n      return vault.get(this.id, { parent: parent2 ? { id: parent2, type: \"unknown\" } : void 0 });\n    },\n    toPresentation3() {\n      return vault.toPresentation3(this.unwrap());\n    },\n    toPresentation2() {\n      return vault.toPresentation2(this.unwrap());\n    },\n    valueOf() {\n      return this.unwrap();\n    },\n    toJSON() {\n      const that = this;\n      return {\n        ...that,\n        items: that.items,\n        annotations: that.annotations,\n        structures: that.structures,\n        seeAlso: that.seeAlso,\n        service: that.service,\n        services: that.services,\n        rendering: that.rendering,\n        partOf: that.partOf,\n        start: that.start,\n        supplementary: that.supplementary,\n        homepage: that.homepage,\n        thumbnail: that.thumbnail,\n        placeholderCanvas: that.placeholderCanvas,\n        accompanyingCanvas: that.accompanyingCanvas,\n        provider: that.provider\n      };\n    },\n    subscribe(subscription, skipInitial = true) {\n      return vault.subscribe(\n        () => {\n          return this.id ? vault.get(this.id) : null;\n        },\n        subscription,\n        skipInitial\n      );\n    }\n  };\n  defineProperty(\"items\", prototype, vault);\n  defineProperty(\"annotations\", prototype, vault);\n  defineProperty(\"structures\", prototype, vault);\n  defineProperty(\"seeAlso\", prototype, vault);\n  defineProperty(\"rendering\", prototype, vault);\n  defineProperty(\"partOf\", prototype, vault);\n  defineProperty(\"start\", prototype, vault, false);\n  defineProperty(\"supplementary\", prototype, vault);\n  defineProperty(\"homepage\", prototype, vault);\n  defineProperty(\"thumbnail\", prototype, vault);\n  defineProperty(\"placeholderCanvas\", prototype, vault, false);\n  defineProperty(\"accompanyingCanvas\", prototype, vault, false);\n  defineProperty(\"provider\", prototype, vault);\n  defineProperty(\"body\", prototype, vault);\n  defineProperty(\"logo\", prototype, vault);\n  return prototype;\n}\nfunction isWrapped(object) {\n  return !!object[DEFINED];\n}\nfunction unwrapObject(object) {\n  if (Array.isArray(object)) {\n    return object.map((o) => unwrapObject(o));\n  }\n  if (!object || !object.type) {\n    return object;\n  }\n  return { id: object.id, type: object.type };\n}\nfunction wrapObject(object, vault, reactive = false, parent) {\n  if (Array.isArray(object)) {\n    return object.map((o) => wrapObject(o, vault, reactive));\n  }\n  if (!object || !object.type || !object.id) {\n    return object;\n  }\n  const prototype = createPrototype(vault, reactive);\n  const newObject = Object.create(prototype);\n  const wrapped = Object.assign(newObject, object);\n  if (reactive) {\n    wrapped.reactive();\n  }\n  return wrapped;\n}\n\n// src/vault/utility/resolve-type.ts\nfunction resolveType(type) {\n  switch (type) {\n    case \"Image\":\n    case \"Video\":\n    case \"Sound\":\n    case \"Dataset\":\n    case \"Text\":\n    case \"Composite\":\n    case \"List\":\n    case \"Independents\":\n    case \"Audience\":\n      return \"ContentResource\";\n    case \"ImageService1\":\n    case \"ImageService2\":\n    case \"ImageService3\":\n      return \"Service\";\n  }\n  return type;\n}\n\n// src/vault/vault.ts\nvar Vault = class {\n  constructor(options, store) {\n    __publicField(this, \"options\");\n    __publicField(this, \"store\");\n    __publicField(this, \"emitter\");\n    __publicField(this, \"isBatching\", false);\n    __publicField(this, \"batchQueue\", []);\n    __publicField(this, \"remoteFetcher\");\n    __publicField(this, \"staticFetcher\");\n    __publicField(this, \"defaultFetcher\", (url) => {\n      return fetch(url).then((r) => {\n        if (r.status === 200) {\n          return r.json();\n        } else {\n          const err = new Error(`${r.status} ${r.statusText}`);\n          err.name = `HTTPError`;\n          throw err;\n        }\n      });\n    });\n    this.options = Object.assign(\n      {\n        reducers: {},\n        customFetcher: this.defaultFetcher,\n        enableDevtools: true\n      },\n      options || {}\n    );\n    this.store = store || createStore({\n      customReducers: this.options.reducers,\n      defaultState: this.options.defaultState,\n      enableDevtools: this.options.enableDevtools\n    });\n    this.emitter = mitt_default();\n    this.remoteFetcher = createFetchHelper(this, this.options.customFetcher);\n    this.staticFetcher = createFetchHelper(this, (id, json) => json);\n  }\n  batch(cb) {\n    this.isBatching = true;\n    try {\n      cb(this);\n      this.isBatching = false;\n      this.dispatch(batchActions({ actions: this.batchQueue }));\n    } catch (e) {\n      this.batchQueue = [];\n      this.isBatching = false;\n      throw e;\n    }\n    this.batchQueue = [];\n  }\n  async asyncBatch(cb) {\n    this.isBatching = true;\n    try {\n      await cb(this);\n      this.isBatching = false;\n      this.dispatch(batchActions({ actions: this.batchQueue }));\n    } catch (e) {\n      this.batchQueue = [];\n      this.isBatching = false;\n      throw e;\n    }\n    this.batchQueue = [];\n  }\n  modifyEntityField(entity, key, value) {\n    this.dispatch(\n      entityActions.modifyEntityField({\n        id: entity.id,\n        type: entity.type,\n        key,\n        value\n      })\n    );\n  }\n  dispatch(action) {\n    if (!this.isBatching) {\n      if (action.type === BATCH_ACTIONS) {\n        for (const realAction of action.payload.actions) {\n          this.emitter.emit(realAction.type, { action: realAction, state: this.store.getState() });\n        }\n        this.store.dispatch(action);\n        const state2 = this.getState();\n        for (const realAction of action.payload.actions) {\n          this.emitter.emit(`after:${realAction.type}`, { action: realAction, state: state2 });\n        }\n        return;\n      }\n      this.emitter.emit(action.type, { action, state: this.store.getState() });\n      this.store.dispatch(action);\n      const state = this.store.getState();\n      this.emitter.emit(`after:${action.type}`, { action, state });\n      return;\n    } else {\n      this.batchQueue.push(action);\n    }\n  }\n  on(event, handler) {\n    this.emitter.on(event, handler);\n    return () => {\n      this.emitter.off(event, handler);\n    };\n  }\n  serialize(entity, config) {\n    return serialize(this.getState().iiif, entity, config);\n  }\n  toPresentation2(entity) {\n    return this.serialize(entity, serializeConfigPresentation2);\n  }\n  toPresentation3(entity) {\n    return this.serialize(entity, serializeConfigPresentation3);\n  }\n  hydrate(reference, type, options = {}) {\n    return this.get(reference, type, { ...options, skipSelfReturn: false });\n  }\n  get(reference, type, options = {}) {\n    if (typeof type !== \"string\") {\n      options = type || {};\n      type = void 0;\n    }\n    const { skipSelfReturn = true } = options || {};\n    let parent = options.parent ? typeof options.parent === \"string\" ? options.parent : options.parent.id : void 0;\n    if (Array.isArray(reference)) {\n      return reference.map((i) => this.get(i, options));\n    }\n    const state = this.getState();\n    if (isSpecificResource(reference) && !options.preserveSpecificResources) {\n      reference = reference.source;\n    }\n    if (typeof reference === \"string\") {\n      const _type2 = resolveType(type ? type : state.iiif.mapping[reference]);\n      if (!_type2) {\n        if (skipSelfReturn) {\n          return null;\n        }\n        return { id: reference, type: \"unknown\" };\n      }\n      reference = { id: reference, type: _type2 };\n    }\n    if (reference && reference.partOf && !parent && !options.skipPartOfCheck) {\n      const first = Array.isArray(reference.partOf) ? reference.partOf[0] : reference.partOf;\n      if (first) {\n        if (typeof first === \"string\") {\n          parent = first;\n        }\n        if (typeof first.id === \"string\") {\n          parent = first.id;\n        }\n      }\n    }\n    const _type = resolveType(type ? type : reference?.type);\n    const _id = reference?.id;\n    const entities = state.iiif.entities[_type];\n    if (!entities) {\n      const request = state.iiif.requests[_id];\n      if (request && request.resourceUri !== _id) {\n        return this.get(request.resourceUri, options);\n      }\n      if (skipSelfReturn) {\n        return null;\n      }\n      return reference;\n    }\n    const found = entities[reference.id];\n    if (found && found[HAS_PART]) {\n      const framing = found[HAS_PART].find((t) => {\n        return parent ? t[PART_OF] === parent : t[PART_OF] === found.id;\n      });\n      return frameResource(found, framing);\n    }\n    return entities[reference.id] || (skipSelfReturn ? null : reference);\n  }\n  select(selector) {\n    return selector(this.getState());\n  }\n  getStore() {\n    return this.store;\n  }\n  getState() {\n    return this.store.getState();\n  }\n  deep(input, prev) {\n    if (typeof input === \"undefined\") {\n      return this.get(prev, { skipSelfReturn: false });\n    }\n    if (typeof input === \"function\") {\n      try {\n        const next = input(this.get(prev, { skipSelfReturn: false }));\n        const fn2 = (newInput) => this.deep(newInput, next);\n        fn2.size = Array.isArray(next) ? next.length : 1;\n        return fn2;\n      } catch (e) {\n        const fn2 = (newInput) => this.deep(newInput, void 0);\n        fn2.size = 0;\n        return fn2;\n      }\n    }\n    const fn = (newInput) => this.deep(newInput, input);\n    fn.size = Array.isArray(input) ? input.length : 1;\n    return fn;\n  }\n  loadManifest(id, json) {\n    const _id = typeof id === \"string\" ? id : id.id;\n    return this.load(_id, json);\n  }\n  loadCollection(id, json) {\n    const _id = typeof id === \"string\" ? id : id.id;\n    return this.load(_id, json);\n  }\n  load(id, json) {\n    const _id = typeof id === \"string\" ? id : id.id;\n    if (json) {\n      return Promise.resolve(this.staticFetcher(_id, json));\n    }\n    return Promise.resolve(this.remoteFetcher(_id));\n  }\n  loadSync(id, json) {\n    const _id = typeof id === \"string\" ? id : id.id;\n    return this.staticFetcher(_id, json);\n  }\n  loadManifestSync(id, json) {\n    const _id = typeof id === \"string\" ? id : id.id;\n    return this.loadSync(_id, json);\n  }\n  loadCollectionSync(id, json) {\n    const _id = typeof id === \"string\" ? id : id.id;\n    return this.loadSync(_id, json);\n  }\n  areInputsEqual(newInputs, lastInputs) {\n    return areInputsEqual(newInputs, lastInputs);\n  }\n  subscribe(selector, subscription, skipInitial) {\n    if (typeof skipInitial === \"undefined\" && (typeof subscription === \"undefined\" || subscription === false || subscription === true)) {\n      skipInitial = subscription;\n      subscription = selector;\n      selector = (a) => a;\n    }\n    return this.store.subscribe(selector, (s) => subscription(s, this), {\n      equalityFn: areInputsEqual,\n      fireImmediately: !skipInitial\n    });\n  }\n  async ensureLoaded(_id) {\n    const id = typeof _id === \"string\" ? _id : _id.id;\n    if (!this.requestStatus(id)) {\n      await this.load(id);\n    }\n  }\n  requestStatus(id) {\n    return this.select((state) => {\n      return state.iiif.requests[id];\n    });\n  }\n  getResourceMeta(resource, metaKey) {\n    const resourceMeta = this.getState().iiif.meta[resource];\n    if (!resourceMeta) {\n      return void 0;\n    }\n    if (!metaKey) {\n      return resourceMeta;\n    }\n    return resourceMeta[metaKey];\n  }\n  getObject(reference, type, options = {}) {\n    const { reactive, ...otherOptions } = options;\n    return wrapObject(this.get(reference, type, otherOptions), this, reactive);\n  }\n  async loadObject(id, json) {\n    return wrapObject(await this.load(id, json), this);\n  }\n  async loadManifestObject(id, json) {\n    return wrapObject(await this.loadManifest(id, json), this);\n  }\n  async loadCollectionObject(id, json) {\n    return wrapObject(await this.loadCollection(id, json), this);\n  }\n  wrapObject(objectType) {\n    return wrapObject(this.get(objectType, { skipSelfReturn: false }), this);\n  }\n  isWrapped(object) {\n    return isWrapped(object);\n  }\n  setMetaValue([id, meta, key], newValueOrUpdate) {\n    this.dispatch(\n      typeof newValueOrUpdate === \"function\" ? metaActions.setMetaValueDynamic({\n        id,\n        meta,\n        key,\n        updateValue: newValueOrUpdate\n      }) : metaActions.setMetaValue({\n        id,\n        meta,\n        key,\n        value: newValueOrUpdate\n      })\n    );\n  }\n};\n\n// src/vault/utility/get-global.ts\nfunction getGlobal() {\n  if (typeof self !== \"undefined\") {\n    return self;\n  }\n  if (typeof window !== \"undefined\") {\n    return window;\n  }\n  if (typeof global !== \"undefined\") {\n    return global;\n  }\n  return {};\n}\n\nexport {\n  Vault,\n  getGlobal\n};\n","import {\n  Vault,\n  getGlobal\n} from \"./chunk-CWG5H2NE.js\";\n\n// src/vault/global-vault.ts\nfunction globalVault(options) {\n  const g = getGlobal();\n  try {\n    const gv = g[\"IIIF_VAULT\"];\n    if (gv) {\n      return gv;\n    }\n  } catch (e) {\n  }\n  const newVault = new Vault(options);\n  try {\n    g[\"IIIF_VAULT\"] = newVault;\n  } catch (e) {\n  }\n  return newVault;\n}\n\nexport {\n  globalVault\n};\n","// src/i18n.ts\nimport { Traverse } from \"@iiif/parser\";\nfunction getClosestLanguage(i18nLanguage, languages, i18nLanguages = [], strictFallback = false, skipLanguages = []) {\n  if (skipLanguages.length) {\n    languages = languages.filter((l) => skipLanguages.indexOf(l) === -1);\n  }\n  if (!languages || languages.length === 0) {\n    return void 0;\n  }\n  if (languages.length === 1) {\n    return languages[0];\n  }\n  if (!i18nLanguage) {\n    if (languages.indexOf(\"none\") !== -1) {\n      return \"none\";\n    }\n    return languages[0];\n  }\n  if (languages.indexOf(i18nLanguage) !== -1) {\n    return i18nLanguage;\n  }\n  const root = i18nLanguage.indexOf(\"-\") !== -1 ? i18nLanguage.slice(0, i18nLanguage.indexOf(\"-\")) : null;\n  if (root && languages.indexOf(root) !== -1) {\n    return root;\n  }\n  for (const lang of i18nLanguages) {\n    if (languages.indexOf(lang) !== -1) {\n      return lang;\n    }\n  }\n  if (!strictFallback && i18nLanguage) {\n    const inverseRoot = languages.map((l) => l.indexOf(\"-\") !== -1 ? l.slice(0, l.indexOf(\"-\")) : null);\n    const inverseIdx = inverseRoot.indexOf(i18nLanguage);\n    if (inverseIdx !== -1) {\n      return languages[inverseIdx];\n    }\n    for (const lang of i18nLanguages) {\n      const root2 = lang.indexOf(\"-\") !== -1 ? lang.slice(0, lang.indexOf(\"-\")) : null;\n      const inverseIdx2 = root2 ? languages.indexOf(root2) : -1;\n      if (inverseIdx2 !== -1) {\n        return languages[inverseIdx2];\n      }\n    }\n  }\n  if (languages.indexOf(\"none\") !== -1) {\n    return \"none\";\n  }\n  if (languages.indexOf(\"@none\") !== -1) {\n    return \"@none\";\n  }\n  return languages[0];\n}\nfunction buildLocaleString(inputText, i18nLanguage, options = {}) {\n  const {\n    strictFallback = false,\n    defaultText = \"\",\n    separator = \"\\n\",\n    fallbackLanguages = [],\n    closest,\n    skipLanguages\n  } = options;\n  const languages = Object.keys(inputText || {});\n  const language = closest ? i18nLanguage : getClosestLanguage(i18nLanguage, languages, fallbackLanguages, strictFallback, skipLanguages);\n  if (!inputText) {\n    return defaultText;\n  }\n  if (typeof inputText === \"string\") {\n    return inputText;\n  }\n  const candidateText = language ? inputText[language] : void 0;\n  if (candidateText && language) {\n    if (typeof candidateText === \"string\") {\n      return candidateText;\n    }\n    if (candidateText.length === 1 && candidateText[0] === \"\") {\n      const skip = options.skipLanguages || [];\n      return buildLocaleString(inputText, i18nLanguage, {\n        ...options,\n        skipLanguages: [...skip, language]\n      });\n    }\n    return candidateText.join(separator);\n  }\n  return \"\";\n}\nfunction getValue(inputText, options = {}) {\n  return buildLocaleString(\n    inputText,\n    options.language || (typeof navigator !== \"undefined\" ? navigator.language : \"en\"),\n    options\n  );\n}\nfunction getLanguagesFromLanguageMap(languageMap) {\n  if (!languageMap)\n    return [];\n  if (typeof languageMap === \"string\")\n    return [];\n  if (Array.isArray(languageMap))\n    return [];\n  return Object.keys(languageMap).filter((l) => l !== \"none\");\n}\nfunction getAvailableLanguagesFromResource(item) {\n  const foundLanguages = /* @__PURE__ */ new Set();\n  const findLanguages = Traverse.all((resource) => {\n    if (\"label\" in resource) {\n      const languages = getLanguagesFromLanguageMap(resource.label);\n      languages.forEach((l) => foundLanguages.add(l));\n    }\n    if (\"summary\" in resource) {\n      const languages = getLanguagesFromLanguageMap(resource.summary);\n      languages.forEach((l) => foundLanguages.add(l));\n    }\n    if (\"language\" in resource) {\n      if (typeof resource.language === \"string\") {\n        foundLanguages.add(resource.language);\n      }\n    }\n    if (\"requiredStatement\" in resource) {\n      if (resource.requiredStatement && !Array.isArray(resource.requiredStatement)) {\n        if (\"label\" in resource.requiredStatement) {\n          const languages = getLanguagesFromLanguageMap(resource.requiredStatement.label);\n          languages.forEach((l) => foundLanguages.add(l));\n        }\n        if (\"value\" in resource.requiredStatement) {\n          const languages = getLanguagesFromLanguageMap(resource.requiredStatement.value);\n          languages.forEach((l) => foundLanguages.add(l));\n        }\n      }\n    }\n    if (\"metadata\" in resource) {\n      if (Array.isArray(resource.metadata)) {\n        resource.metadata.forEach((m) => {\n          if (\"label\" in m) {\n            const languages = getLanguagesFromLanguageMap(m.label);\n            languages.forEach((l) => foundLanguages.add(l));\n          }\n          if (\"value\" in m) {\n            const languages = getLanguagesFromLanguageMap(m.value);\n            languages.forEach((l) => foundLanguages.add(l));\n          }\n        });\n      }\n    }\n  });\n  findLanguages.traverseUnknown(item);\n  return Array.from(foundLanguages);\n}\n\nexport {\n  getClosestLanguage,\n  buildLocaleString,\n  getValue,\n  getAvailableLanguagesFromResource\n};\n","import{A as le,B as xe,C as ge,D as ce,E as g,F as u,G as I,H as he,I as c,J as v,K as w,L as F,M as z,a as U,b as N,c as C,d as k,e as Z,f as D,g as G,h as J,i as K,j as V,k as X,l as Y,m as _,n as q,o as ee,p as ie,q as te,r as re,s as oe,t as ae,u as ne,v as fe,w as se,x as me,y as ue,z as pe}from\"./chunk-J657UVVW.js\";import\"./chunk-D22QKJZO.js\";function de(i){let e=i.replace(/(https?:\\/\\/)?(www.)?/i,\"\");return e.indexOf(\"/\")!==-1?e.split(\"/\")[0]:e}function A(i){try{if(i===\"full\")return{full:!0};if(i===\"square\")return{square:!0};let e=i.startsWith(\"pct:\"),o=i.substr(e?4:0).split(\",\").map(r=>parseFloat(r));return{x:o[0],y:o[1],w:o[2],h:o[3],percent:e}}catch{throw new Error(\"Expected 'full', 'square' or 'x,y,w,h'. Found \"+i)}}function P(i){let e={upscaled:!1,max:!1,confined:!1};if(i[0]===\"^\"&&(e.upscaled=!0,i=i.slice(1)),i===\"max\"||i===\"full\")return e.max=!0,e.serialiseAsFull=i===\"full\",e;if(i[0]===\"!\"&&(e.confined=!0,i=i.slice(1)),i[0]===\"p\")return e.percentScale=parseFloat(i.slice(4)),e;let t=i.split(\",\").map(o=>o.trim());return t.length&&(t[0]!==\"\"&&(e.width=parseInt(t[0],10)),t[1]!==\"\"&&(e.height=parseInt(t[1],10))),e}function $(i){let e={angle:0};if(i[0]===\"!\"&&(e.mirror=!0,i=i.substr(1)),e.angle=parseFloat(i)%360,Number.isNaN(e.angle))throw new Error(`Invalid rotation ${i}`);return e}function R(i,e=\"\"){let t=i.match(/^(([a-zA-Z]+):\\/\\/([^/]+))?((.*)+)/);if(!t)throw new Error(`Invalid or unknown input ${i}`);let o=t[2],r=t[3],a=t[4];if(a[0]===\"/\"&&(a=a.substring(1)),e.length>0){if(e[0]===\"/\"&&(e=e.substring(1)),e!==a.substring(0,e.length))throw new Error(`Path does not start with prefix (path: ${a}, prefix: ${e})`);a=a.substring(e.length)}return{scheme:o,server:r,path:a,prefix:e}}function O(i,e=\"\"){let{path:t,scheme:o,server:r,prefix:a}=R(i,e),n=t.split(\"/\").reverse(),[s,f,p,l,...y]=n,x=y.reverse().filter(Boolean).join(\"/\");if(n.length===1||s===\"\")return{type:\"base\",scheme:o,server:r,prefix:a,identifier:x};if(s===\"info.json\"){let[,...E]=n;return{type:\"info\",scheme:o,server:r,prefix:a,identifier:E.reverse().filter(Boolean).join(\"/\")}}if(typeof o>\"u\"||typeof r>\"u\"||typeof t>\"u\"||typeof l>\"u\"||typeof p>\"u\"||typeof f>\"u\"||typeof s>\"u\")throw new Error(\"Invalid image service URL\");let[M=\"\",T=\"\"]=s.split(\".\");return{type:\"image\",scheme:o,server:r,prefix:a,identifier:x,originalPath:t,region:A(l),size:P(p),rotation:$(f),quality:M,format:T}}function b(i){return g.indexOf(i)!==-1?F:u.indexOf(i)!==-1?w:v}function h(i){let e=i?Array.isArray(i.profile)?i.profile:[i.profile]:[],t={extraQualities:[],extraFormats:[],extraFeatures:[]};for(let o of e)if(typeof o==\"string\"&&(o=b(o)),!!o){if(o.formats)for(let r of o.formats)t.extraFormats.indexOf(r)===-1&&t.extraFormats.push(r);if(o.qualities)for(let r of o.qualities)t.extraQualities.indexOf(r)===-1&&t.extraQualities.push(r);if(o.supports)for(let r of o.supports)t.extraFeatures.indexOf(r)===-1&&t.extraFeatures.push(r);if(o.maxHeight&&(t.maxHeight=o.maxHeight),o.maxWidth&&(t.maxWidth=o.maxWidth),o.maxArea&&(t.maxArea=o.maxArea),o.extraFormats)for(let r of o.extraFormats)t.extraFormats.indexOf(r)===-1&&t.extraFormats.push(r);if(o.extraQualities)for(let r of o.extraQualities)t.extraQualities.indexOf(r)===-1&&t.extraQualities.push(r);if(o.extraFeatures)for(let r of o.extraFeatures)t.extraFeatures.indexOf(r)===-1&&t.extraFeatures.push(r);o.maxHeight&&(t.maxHeight=o.maxHeight),o.maxWidth&&(t.maxWidth=o.maxWidth),o.maxArea&&(t.maxArea=o.maxArea)}if(i.extraFormats)for(let o of i.extraFormats)t.extraFormats.indexOf(o)===-1&&t.extraFormats.push(o);if(i.extraFeatures)for(let o of i.extraFeatures)t.extraFeatures.indexOf(o)===-1&&t.extraFeatures.push(o);if(i.extraQualities)for(let o of i.extraQualities)t.extraQualities.indexOf(o)===-1&&t.extraQualities.push(o);return t}function Qe(i){let e=Array.isArray(i.profile)?i.profile:[i.profile];for(let t of e)if(typeof t==\"string\"&&c.indexOf(t)!==-1)return!0;return!1}function W(i){if(i[\"@id\"])return i[\"@id\"];if(i.id)return i.id}function m(i){if(!i||!i.profile||!W(i))return!1;let e=Array.isArray(i.profile)?i.profile:[i.profile];for(let t of e)if(typeof t==\"string\"&&I.indexOf(t)!==-1)return!0;return!1}function d(i,e){if(!m(i))return[!1,\"Not a valid image service\"];e.extraFeatures=e.extraFeatures?e.extraFeatures:[];let t=h(i);if(e.exactSize){let o=!1;if(i.sizes)for(let r of i.sizes)r.width&&r.width===e.exactSize.width&&(z.indexOf(\"sizeByW\")!==-1||r.height&&r.height===e.exactSize.height)&&(o=!0),r.height&&r.height===e.exactSize.height&&(z.indexOf(\"sizeByH\")!==-1||r.width&&r.width===e.exactSize.width)&&(o=!0);o||(e.maxWidth=Math.max(e.maxWidth||0,e.exactSize.width||0)||void 0,e.maxHeight=Math.max(e.maxHeight||0,e.exactSize.height||0)||void 0,e.maxArea=Math.max(e.maxArea||0,(e.exactSize.width&&e.exactSize.height?e.exactSize.width*e.exactSize.height:e.maxArea)||0)||void 0,!e.exactSize.height&&e.exactSize.width?e.extraFeatures.indexOf(\"sizeByW\")===-1&&e.extraFeatures.push(\"sizeByW\"):!e.exactSize.width&&e.exactSize.height&&e.extraFeatures.indexOf(\"sizeByH\")===-1&&e.extraFeatures.push(\"sizeByH\"))}if(e.maxArea&&t.maxArea&&e.maxArea>t.maxArea)return[!1,`Max area is ${t.maxArea}`];if(e.maxWidth&&t.maxWidth&&e.maxWidth>t.maxWidth)return[!1,`Max width is ${t.maxWidth}`];if(e.maxHeight&&t.maxHeight&&e.maxHeight>t.maxHeight)return[!1,`Max height is ${t.maxHeight}`];if(e.extraFeatures){let o=[];for(let r of e.extraFeatures)t.extraFeatures.indexOf(r)===-1&&o.push(r);if(o.length)return[!1,`Missing features: ${o.join(\", \")}`]}if(e.extraFormats){let o=[];for(let r of e.extraFormats)t.extraFormats.indexOf(r)===-1&&o.push(r);if(o.length)return[!1,`Missing formats: ${o.join(\", \")}`]}if(e.extraQualities){let o=[];for(let r of e.extraQualities)t.extraQualities.indexOf(r)===-1&&o.push(r);if(o.length)return[!1,`Missing qualities: ${o.join(\", \")}`]}return[!0]}function Ke(i){if(!m(i))return!1;let e=Array.isArray(i.profile)?i.profile:[i.profile];for(let t of e)if(typeof t==\"string\"){if(u.indexOf(t)!==-1)return!0}else{let o=[...t.supports||[],...t.extraFeatures||[]];if(o.indexOf(\"regionByPx\")!==-1&&(o.indexOf(\"sizeByW\")!==-1||o.indexOf(\"sizeByWh\")!==-1))return!0}return!1}function Ye(i,e){return d(i,{extraFormats:[e]})}function ei(i,e){if(e.type!==\"image\")return[!0];let t=[];e.rotation.mirror&&t.push(\"mirroring\"),e.region.percent&&t.push(\"regionByPct\"),e.region.square?t.push(\"regionSquare\"):e.region.full||t.push(\"regionByPx\"),e.rotation.angle&&(e.rotation.angle%90?t.push(\"rotationArbitrary\"):t.push(\"rotationBy90s\")),e.size.confined&&t.push(\"sizeByConfinedWh\"),!e.size.width&&e.size.height&&t.push(\"sizeByH\"),e.size.percentScale&&t.push(\"sizeByPct\"),(i.sizes||[]).find(n=>n.width===e.size.width&&!e.size.height||n.height===e.size.height&&!e.size.width||n.height===e.size.height&&n.width===e.size.width)?t.push(\"sizeByWhListed\"):(e.size.width&&!e.size.height&&t.push(\"sizeByW\"),e.size.width&&e.size.height&&t.push(\"sizeByWh\")),e.size.upscaled&&t.push(\"sizeUpscaling\");let[r,a]=d(i,{extraFeatures:t,extraQualities:[e.quality],extraFormats:[e.format],exactSize:e.size});return r?[!0]:[!1,a]}function B({x:i=0,y:e=0,w:t,h:o,full:r,square:a,percent:n}){if(r)return\"full\";if(a)return\"square\";if(typeof t>\"u\"||typeof o>\"u\")throw new Error(\"RegionParameter: invalid region\");let s=`${i},${e},${t},${o}`;return n?`pct:${s}`:s}function j({max:i,percentScale:e,upscaled:t,confined:o,width:r,height:a,serialiseAsFull:n,version:s}){let f=[];return t&&f.push(\"^\"),i?(f.push(n?\"full\":\"max\"),f.join(\"\")):(o&&f.push(\"!\"),e&&f.push(`pct:${e}`),r&&f.push(`${r}`),f.push(\",\"),a&&s===3&&f.push(`${a}`),f.join(\"\"))}function Q(i){return`${i.mirror?\"!\":\"\"}${(i.angle||0)%360}`}function H(i,e){let t=i.prefix.startsWith(\"/\")?i.prefix.substring(1):i.prefix,o=`${i.scheme}://${i.server}/${t?`${t}/`:\"\"}${i.identifier}`;if(i.type===\"base\")return o;if(i.type===\"info\")return`${o}/info.json`;let{size:r}=i,{region:a,rotation:n,format:s,quality:f}=i;if(e){let p=e[\"@context\"]?Array.isArray(e[\"@context\"])?e[\"@context\"]:[e[\"@context\"]]:[],l=p.indexOf(\"http://iiif.io/api/image/2/context.json\")!==-1,y=p.indexOf(\"http://iiif.io/api/image/3/context.json\")!==-1;if((r.width===e.width&&!r.height||r.height===e.height&&!r.width||r.width===e.width&&r.height===e.height)&&(r={...r,max:!0}),l&&(r.max&&!r.serialiseAsFull&&(r={...r,serialiseAsFull:!0}),!r.max&&r.width&&r.height&&(r={...r,height:void 0}),r={...r,version:2}),y){if(r.max&&r.serialiseAsFull&&(r={...r,serialiseAsFull:!1}),r.width&&!r.height&&e.width&&e.height){let x=e.height/e.width;r={...r,height:Math.ceil(r.width*x)}}r={...r,version:3}}}return[o,B(a),j(r),Q(n),`${f}.${s}`].filter(Boolean).join(\"/\")}function ui(i,e){return H({...i,type:\"info\"},e)}function L(i){return i.endsWith(\"info.json\")?i:i.endsWith(\"/\")?`${i}info.json`:`${i}/info.json`}function hi(i){let e=O(L(i.id));if(e.type!==\"info\")throw new Error(\"Invalid service URL\");let t=h(i);return{identifier:e.identifier,originalPath:\"\",server:e.server,prefix:e.prefix,scheme:e.scheme,type:\"image\",quality:t.extraQualities.indexOf(\"default\")===-1?t.extraQualities[0]:\"default\",region:{full:!0},size:{max:!0,upscaled:!1,confined:!1},format:\"jpg\",rotation:{angle:0}}}function Si(i,e,t){let o=t.length,r=[];for(let a=0;a<o;a++){let n=t[a];if(!n)continue;let s=n.width;r.push(i/s)}return r}function zi(i,e,t){let o=t.length,r=[];for(let a=0;a<o;a++){let n=t[a];n&&r.push({width:Math.floor(i/n),height:Math.floor(e/n)})}return r}function S(i,e){if(e&&e.profile){let t=e.profile;if(t){let o=Array.isArray(t)?t:[t];if(o.includes(`level${i}`)||o.includes(`http://iiif.io/api/image/2/level${i}.json`)||o.includes(`http://iiif.io/api/image/1/level${i}.json`)||o.includes(`http://iiif.io/api/image/1/profiles/level${i}.json`))return!0;if(i===2){for(let r of o)if(g.includes(r))return!0}if(i===1){for(let r of o)if(u.includes(r))return!0}if(i===0){for(let r of o)if(c.includes(r))return!0}}}return!1}function Pi(i){return m(i)?S(0,i)?0:S(1,i)?1:S(2,i)?2:null:null}function Oi(i){let e=i.service?Array.isArray(i.service)?i.service:[i.service]:[],t=e.length,o=[];for(let r=0;r<t;r++)m(e[r])&&o.push(e[r]);return o}function Wi(i){if(i[\"@type\"])return i[\"@type\"];if(i.type)return i.type}function ji(i){let e=i.replace(/(https?:\\/\\/)?(www.)?/i,\"\");return e.indexOf(\"/\")!==-1?e.split(\"/\")[0]:e}export{_ as IIIF_1_IMAGE_LEVEL_0,q as IIIF_1_IMAGE_LEVEL_0_PROFILE,ee as IIIF_1_IMAGE_LEVEL_1,ie as IIIF_1_IMAGE_LEVEL_1_PROFILE,te as IIIF_1_IMAGE_LEVEL_2,re as IIIF_1_IMAGE_LEVEL_2_PROFILE,oe as IIIF_2_IMAGE_LEVEL_0,xe as IIIF_2_IMAGE_LEVEL_0_NO_JSON,ae as IIIF_2_IMAGE_LEVEL_0_PROFILE,ne as IIIF_2_IMAGE_LEVEL_1,ge as IIIF_2_IMAGE_LEVEL_1_NO_JSON,fe as IIIF_2_IMAGE_LEVEL_1_PROFILE,se as IIIF_2_IMAGE_LEVEL_2,ce as IIIF_2_IMAGE_LEVEL_2_NO_JSON,me as IIIF_2_IMAGE_LEVEL_2_PROFILE,ue as IIIF_3_IMAGE_LEVEL_0,pe as IIIF_3_IMAGE_LEVEL_1,le as IIIF_3_IMAGE_LEVEL_2,G as STANFORD_IIIF_1_IMAGE_COMPLIANCE_0,J as STANFORD_IIIF_1_IMAGE_COMPLIANCE_1,K as STANFORD_IIIF_1_IMAGE_COMPLIANCE_2,V as STANFORD_IIIF_1_IMAGE_CONFORMANCE_0,X as STANFORD_IIIF_1_IMAGE_CONFORMANCE_1,Y as STANFORD_IIIF_1_IMAGE_CONFORMANCE_2,U as STANFORD_IIIF_IMAGE_COMPLIANCE_0,N as STANFORD_IIIF_IMAGE_COMPLIANCE_1,C as STANFORD_IIIF_IMAGE_COMPLIANCE_2,k as STANFORD_IIIF_IMAGE_CONFORMANCE_0,Z as STANFORD_IIIF_IMAGE_CONFORMANCE_1,D as STANFORD_IIIF_IMAGE_CONFORMANCE_2,L as canonicalServiceUrl,h as combineProfiles,hi as createImageServiceRequest,z as extraFeatures,Si as extractFixedSizeScales,zi as fixedSizesFromScales,W as getId,Pi as getImageServiceLevel,Oi as getImageServices,Wi as getType,ji as identifyImageServer,I as imageServiceProfiles,ui as imageServiceRequestInfo,H as imageServiceRequestToString,Ye as imageServiceSupportsFormat,ei as imageServiceSupportsRequest,m as isImageService,S as isImageServiceLevel,Qe as isLevel0,v as level0,he as level0Support,w as level1,u as level1Support,F as level2,g as level2Support,b as levelToProfile,c as onlyLevel0,de as parseImageServerFromId,O as parseImageServiceRequest,R as parseImageServiceUrl,A as parseRegionParameter,$ as parseRotationParameter,P as parseSizeParameter,B as regionParameterToString,Q as rotationParameterToString,j as sizeParameterToString,d as supports,Ke as supportsCustomSizes};\n","import {\n  mitt_default\n} from \"./chunk-6NZ5BWVI.js\";\nimport {\n  createStore\n} from \"./chunk-2I7FN7JX.js\";\nimport {\n  __publicField\n} from \"./chunk-G7A32JAG.js\";\n\n// src/image-service/image-service-loader.ts\nimport {\n  isLevel0,\n  getId as getId6,\n  canonicalServiceUrl as canonicalServiceUrl2,\n  extractFixedSizeScales,\n  fixedSizesFromScales,\n  getImageServices as getImageServices2\n} from \"@iiif/parser/image-3\";\n\n// src/image-service/get-image-server-from-id.ts\nfunction getImageServerFromId(url) {\n  const id = url.replace(/(https?:\\/\\/)?(www.)?/i, \"\");\n  if (id.indexOf(\"/\") !== -1) {\n    return id.split(\"/\")[0];\n  }\n  return id;\n}\n\n// src/image-service/sampled-tiles-to-tiles.ts\nfunction sampledTilesToTiles(width, height, sampledTiles) {\n  const maxDim = width > height ? width : height;\n  const len = sampledTiles.length;\n  const newTiles = [];\n  for (let i = 0; i < len; i++) {\n    const tile = sampledTiles[i];\n    if (!tile)\n      continue;\n    if (tile.scaleFactors.length === 0)\n      continue;\n    let lastSize = tile.scaleFactors[0];\n    if (!lastSize)\n      continue;\n    let curWidth = maxDim / lastSize;\n    const scaleFactors = [lastSize];\n    while (curWidth >= tile.width) {\n      lastSize = lastSize * 2;\n      scaleFactors.push(lastSize);\n      curWidth = curWidth / 2;\n    }\n    newTiles.push({\n      ...tile,\n      scaleFactors\n    });\n  }\n  return newTiles;\n}\n\n// src/image-service/get-image-from-tile-source.ts\nimport {\n  canonicalServiceUrl,\n  createImageServiceRequest,\n  getId,\n  imageServiceRequestToString\n} from \"@iiif/parser/image-3\";\nfunction getImageFromTileSource(image, targetWidth, targetHeight) {\n  const req = createImageServiceRequest({\n    \"@context\": image.version === 3 ? \"http://iiif.io/api/image/3/context.json\" : \"http://iiif.io/api/image/2/context.json\",\n    id: canonicalServiceUrl(getId(image)),\n    profile: image.level === null || typeof image.level === \"undefined\" ? \"level0\" : `level${image.level}`,\n    type: image.version === 3 ? \"ImageService3\" : \"ImageService2\"\n  });\n  if (req.type !== \"image\") {\n    throw new Error(\"Invalid service\");\n  }\n  req.size.max = false;\n  req.size.width = targetWidth;\n  req.size.height = targetHeight;\n  const url = imageServiceRequestToString(req);\n  return {\n    id: url,\n    type: \"fixed\",\n    width: targetWidth,\n    height: targetHeight || image.height / (image.width || 1) * targetWidth,\n    unsafe: image.width > targetWidth\n  };\n}\n\n// src/image-service/is-best-match.ts\nfunction isBestMatch(request, current, candidate) {\n  const width = !request.width ? request.maxWidth : request.width;\n  return candidate.height <= request.maxHeight && candidate.width <= request.maxWidth && candidate.height >= request.minHeight && candidate.width >= request.minWidth && (!current || Math.abs(candidate.width - width) < Math.abs(current.width - width));\n}\n\n// src/image-service/pick-best-from-candidates.ts\nfunction pickBestFromCandidates(inputRequest, candidates) {\n  const log = [];\n  const request = Object.assign(\n    {\n      unsafeImageService: false,\n      atAnyCost: true,\n      fallback: true,\n      minHeight: 64,\n      minWidth: 64,\n      maxHeight: Infinity,\n      maxWidth: Infinity,\n      returnAllOptions: false,\n      preferFixedSize: false,\n      allowUnsafe: false,\n      explain: false,\n      height: 0,\n      width: 0\n    },\n    inputRequest\n  );\n  const explain = (text, indent = 0) => request.explain ? log.push(\n    new Array(indent).fill(0).map((e) => \"    \").join(\"\") + text().trim()\n  ) : void 0;\n  const lastResorts = [];\n  const fallback = [];\n  let currentChoice = null;\n  explain(() => `Using configuration: ${JSON.stringify(request, null, 2)}`);\n  const swapChoice = (candidate, current) => {\n    explain(() => \"Swapping choice\", 3);\n    if (isBestMatch(request, current, candidate)) {\n      if (request.preferFixedSize && candidate.unsafe) {\n        explain(() => `We found an image that was marked as unsafe, but it was the best size. (${candidate.id})`, 4);\n        fallback.push(candidate);\n        return;\n      }\n      if (request.returnAllOptions && current) {\n        fallback.push(current);\n      }\n      explain(() => `We found a new image that was the best size. (${candidate.id})`, 4);\n      currentChoice = candidate;\n    } else if (request.returnAllOptions) {\n      fallback.push(candidate);\n    }\n  };\n  explain(() => `The input shows we have ${candidates.length} list(s) of candidates to choose from.`);\n  const candidateGroups = candidates.length;\n  for (let x = 0; x < candidateGroups; x++) {\n    const group = candidates[x]();\n    explain(() => `Candidate group ${x}: ${JSON.stringify(group, null, 2)}`, 1);\n    const candidatesLength = group.length;\n    explain(\n      () => `Checking candidate list number ${x} and found ${candidatesLength} potential ways of creating image(s)`,\n      1\n    );\n    for (let y = 0; y < candidatesLength; y++) {\n      const candidate = group[y];\n      explain(() => `-> Checking candidate ${y}`, 1);\n      if (candidate.type === \"unknown\" && request.atAnyCost) {\n        explain(() => `We've found an unknown image type, adding this to the \"last resort\" list`, 2);\n        lastResorts.push(candidate);\n      }\n      if (candidate.type === \"fixed\") {\n        if (candidate.unsafe) {\n          explain(() => `We've found an unsafe fixed image type, adding this to the \"last resort\" list`, 2);\n          lastResorts.push(candidate);\n        } else {\n          explain(() => `We've found a fixed size image, checking if it matches the request`, 2);\n          swapChoice(candidate, currentChoice);\n        }\n      }\n      if (candidate.type === \"fixed-service\") {\n        if (request.unsafeImageService) {\n          explain(\n            () => `Checking for an image from the tile source, without calculating the right height and width (unsafeImageService)`,\n            2\n          );\n          const choice = getImageFromTileSource(candidate, request.width, request.height);\n          swapChoice(choice, currentChoice);\n        } else {\n          explain(() => `Checking for an image from the tile source 3`, 2);\n          const choice = getImageFromTileSource(candidate, candidate.width, candidate.height);\n          swapChoice(choice, currentChoice);\n        }\n      }\n      if (candidate.type === \"variable\") {\n        if (candidate.maxWidth) {\n          const choice = getImageFromTileSource(\n            {\n              id: candidate.id,\n              type: \"fixed-service\",\n              width: candidate.maxWidth,\n              height: candidate.maxWidth,\n              level: candidate.level,\n              version: candidate.version\n            },\n            candidate.maxWidth\n          );\n          swapChoice(choice, currentChoice);\n        }\n      }\n    }\n    if (currentChoice && !request.returnAllOptions) {\n      if (currentChoice.unsafe || request.allowUnsafe) {\n        continue;\n      }\n      explain(() => `We found a match in choice list number ${x}, no searching any more`);\n      break;\n    }\n  }\n  if (request.atAnyCost && fallback.length === 0) {\n    explain(\n      () => currentChoice ? `We found an image! ${currentChoice.id} of type ${currentChoice.type}` : `We found no images, but \"atAnyCost\" is set, so returning that`\n    );\n    return {\n      best: currentChoice || lastResorts[0] || null,\n      fallback: lastResorts.slice(1),\n      log\n    };\n  }\n  if (request.returnAllOptions) {\n    explain(() => `Returning all options that we have found`);\n    return {\n      best: (request.atAnyCost ? currentChoice || fallback[0] || lastResorts[0] : currentChoice || fallback[0]) || null,\n      fallback: [...fallback, ...lastResorts],\n      log\n    };\n  }\n  explain(() => `Returning the best image that we found, and a fallback`);\n  return {\n    best: currentChoice || fallback[0] || null,\n    fallback: currentChoice ? fallback : fallback.slice(1),\n    log\n  };\n}\n\n// src/image-service/get-fixed-sizes-from-service.ts\nimport { getId as getId2, isImageService, getImageServiceLevel } from \"@iiif/parser/image-3\";\n\n// src/image-service/is-image-3.ts\nfunction isImage3(service) {\n  const context = service[\"@context\"] ? Array.isArray(service[\"@context\"]) ? service[\"@context\"] : [service[\"@context\"]] : [];\n  return context.indexOf(\"http://iiif.io/api/image/3/context.json\") !== -1;\n}\n\n// src/image-service/get-fixed-sizes-from-service.ts\nfunction getFixedSizesFromService(service) {\n  if (!isImageService(service)) {\n    return [];\n  }\n  return (service && service.sizes ? service.sizes : []).map((size) => {\n    return {\n      id: getId2(service),\n      type: \"fixed-service\",\n      height: size.height,\n      width: size.width,\n      level: getImageServiceLevel(service),\n      version: isImage3(service) ? 3 : 2\n    };\n  });\n}\n\n// src/image-service/get-custom-size-from-service.ts\nimport { getId as getId3, supportsCustomSizes, getImageServiceLevel as getImageServiceLevel2 } from \"@iiif/parser/image-3\";\nfunction getCustomSizeFromService(service) {\n  if (!supportsCustomSizes(service)) {\n    return [];\n  }\n  const imagesSizes = [];\n  const profiles = Array.isArray(service.profile) ? service.profile : [service.profile];\n  const pLen = profiles.length;\n  for (let x = 0; x < pLen; x++) {\n    const profile = profiles[x];\n    if (profile && typeof profile !== \"string\") {\n      if (profile.maxHeight || profile.maxWidth) {\n        return [\n          {\n            id: getId3(service),\n            type: \"variable\",\n            minWidth: 0,\n            minHeight: 0,\n            maxHeight: profile.maxHeight || profile.maxWidth,\n            maxWidth: profile.maxWidth || profile.maxHeight,\n            level: getImageServiceLevel2(service),\n            version: service[\"@context\"] === \"http://iiif.io/api/image/3/context.json\" ? 3 : 2\n          }\n        ];\n      }\n    }\n  }\n  if (service.tiles) {\n    const len = service.tiles.length;\n    for (let y = 0; y < len; y++) {\n      const tile = service.tiles[y];\n      if (tile && (tile.height || tile.width)) {\n        imagesSizes.push({\n          id: getId3(service),\n          type: \"variable\",\n          minHeight: 0,\n          minWidth: 0,\n          maxHeight: tile.height || tile.width,\n          maxWidth: tile.width,\n          level: getImageServiceLevel2(service),\n          version: isImage3(service) ? 3 : 2\n        });\n      }\n    }\n  }\n  return imagesSizes;\n}\n\n// src/image-service/get-image-candidates-from-service.ts\nfunction getImageCandidatesFromService(service) {\n  const candidates = [];\n  const totalServices = service.length;\n  for (let s = 0; s < totalServices; s++) {\n    const single = service[s];\n    if (!single)\n      continue;\n    const fixedSizes = getFixedSizesFromService(single);\n    if (fixedSizes.length) {\n      candidates.push(...fixedSizes);\n    }\n    const customSizes = getCustomSizeFromService(single);\n    if (customSizes.length) {\n      candidates.push(...customSizes);\n    }\n  }\n  return candidates;\n}\n\n// src/image-service/infer-size-from-url.ts\nfunction inferImageSizeFromUrl(image) {\n  const regex = /^.*\\/(full)\\/(((\\d+),(\\d+)?)|max)\\/(\\d+)\\/default\\.(jpg|png|jpeg)$/;\n  const match = image.match(regex);\n  if (match && match[4] && match[5]) {\n    const region = match[1];\n    const width = parseInt(match[4], 10);\n    const height = parseInt(match[5], 10);\n    const format = match[7];\n    if ((region === \"max\" || region === \"full\") && width && height && format) {\n      return {\n        type: \"fixed\",\n        id: image,\n        height,\n        width\n      };\n    }\n  }\n  return { type: \"unknown\", id: image };\n}\n\n// src/image-service/get-fixed-size-from-image.ts\nimport { getId as getId4, getType } from \"@iiif/parser/image-3\";\nfunction getFixedSizeFromImage(contentResource) {\n  if (typeof contentResource === \"string\") {\n    return inferImageSizeFromUrl(contentResource);\n  }\n  const type = getType(contentResource);\n  if (type !== \"Image\" && type !== \"sc:Image\") {\n    return null;\n  }\n  const image = contentResource;\n  const id = getId4(image);\n  if (!id) {\n    return null;\n  }\n  if (id && image.width && image.height) {\n    return {\n      id,\n      type: \"fixed\",\n      width: image.width,\n      height: image.height,\n      unsafe: true\n    };\n  }\n  return inferImageSizeFromUrl(id);\n}\n\n// src/image-service/get-image-candidates.ts\nimport { getId as getId5, getImageServices } from \"@iiif/parser/image-3\";\nfunction getImageCandidates(unknownResource, dereference = true, loader) {\n  const candidates = [];\n  const fixedSizeFromImage = getFixedSizeFromImage(unknownResource);\n  if (fixedSizeFromImage === null) {\n    return candidates;\n  }\n  const resource = unknownResource;\n  candidates.push(fixedSizeFromImage);\n  if (dereference && resource && resource.width && resource.height) {\n    const refCandidates = [];\n    const imageServices2 = getImageServices(resource);\n    for (const service of imageServices2) {\n      const request = {\n        id: getId5(service),\n        width: resource.width,\n        height: resource.height\n      };\n      if (loader.canLoadSync(request)) {\n        const externalService = loader.loadServiceSync(request);\n        if (externalService) {\n          if (!externalService.height) {\n            externalService.height = resource.height;\n          }\n          if (!externalService.width) {\n            externalService.width = resource.width;\n          }\n          refCandidates.push(...getImageCandidatesFromService([externalService]));\n        }\n      }\n    }\n    if (refCandidates.length) {\n      candidates.push(...refCandidates);\n      return candidates;\n    }\n  }\n  if (resource.service) {\n    candidates.push(...getImageCandidatesFromService(resource.service));\n  }\n  return candidates;\n}\n\n// src/image-service/image-sizes-match.ts\nfunction imageSizesMatch(sizesA, sizesB) {\n  if (sizesA.length !== sizesB.length) {\n    return false;\n  }\n  if (sizesA.length === 0 && sizesB.length === 0) {\n    return true;\n  }\n  const len = sizesA.length;\n  let matchOrder = true;\n  for (let i = 0; i < len; i++) {\n    const a = sizesA[i];\n    const b = sizesB[i];\n    if (a.width !== b.width || a.height !== b.height) {\n      matchOrder = false;\n      break;\n    }\n  }\n  if (matchOrder) {\n    return true;\n  }\n  let matching = 0;\n  for (let a = 0; a < len; a++) {\n    for (let b = 0; b < len; b++) {\n      if (sizesA[a].width === sizesB[b].width && sizesA[a].height === sizesB[b].height) {\n        matching++;\n        break;\n      }\n    }\n  }\n  return matching === len;\n}\n\n// src/image-service/image-service-loader.ts\nvar ImageServiceLoader = class {\n  constructor(options = {}) {\n    __publicField(this, \"config\", {\n      verificationsRequired: 1,\n      approximateServices: false,\n      enableFetching: true,\n      disableThrottling: false\n    });\n    __publicField(this, \"fetchingCount\", 0);\n    __publicField(this, \"imageServices\", {});\n    __publicField(this, \"knownImageServers\", {});\n    this.config = Object.assign(this.config, options);\n  }\n  /**\n   * Preload image service\n   *\n   * This will preload an image service, fetching details and recording the image server that served\n   * the request. Based on this it will make a template for predicting other image sources from this\n   * server. You can optionally pass in other ids to verify that the prediction is accurate.\n   *\n   */\n  // async preload(id: string, verify?: string[]): Promise<void> {}\n  setConfig(config) {\n    Object.assign(this.config, config);\n  }\n  /**\n   * Sample pre-fetched service\n   *\n   * If you have already fetched an image service, or are creating a viewer that only talks to a single\n   * image server and want to avoid calls, you can sample a service up-front. This will allow you to make\n   * completely synchronous calls to `loadServiceSync` and avoid any network calls for image services.\n   *\n   * @param service\n   * @param preLoaded Mark this as being pre-loaded (default: true)\n   */\n  sample(service, imageServiceRequest, preLoaded = true) {\n    const server = getImageServerFromId(getId6(service));\n    const serviceUrl = canonicalServiceUrl2(getId6(service));\n    const existing = this.knownImageServers[server];\n    this.imageServices[serviceUrl] = Object.assign(service, { real: true });\n    if (!existing && service.tiles && !isLevel0(service)) {\n      this.knownImageServers[server] = {\n        verifications: 0,\n        malformed: false,\n        root: server,\n        preLoaded,\n        sampledId: getId6(service),\n        verified: false,\n        server: null,\n        result: {\n          context: service[\"@context\"] || [],\n          sampledProfile: service.profile,\n          resourceServiceRatio: imageServiceRequest && service.height ? imageServiceRequest.height / service.height : 1,\n          sampledSizes: service.sizes || [],\n          sizeRatios: extractFixedSizeScales(service.width, service.height, service.sizes || []),\n          sampledTiles: service.tiles || []\n        }\n      };\n      return true;\n    }\n    return this.verify(service);\n  }\n  /**\n   * Preload an image server\n   *\n   * Similar to sample, but faster. This will bypass any checks and the logic contained in this implementation\n   * allowing you to correct mistakes this implementation might have made.\n   *\n   * @param server\n   * @param forceVerify\n   */\n  preLoad(server, forceVerify = true) {\n    this.knownImageServers[server.root] = server;\n    if (forceVerify) {\n      this.knownImageServers[server.root].malformed = false;\n      this.knownImageServers[server.root].verifications = this.config.verificationsRequired;\n    }\n  }\n  /**\n   * Predict\n   *\n   * Predicts what the image service will be for a content resource.\n   *\n   * @param resource\n   * @param verify\n   * @param force\n   */\n  predict(resource, verify = false, force = false) {\n    const source = resource?.source;\n    const serverId = getImageServerFromId(getId6(resource));\n    const imageServer = this.knownImageServers[serverId];\n    const serviceUrl = canonicalServiceUrl2(getId6(resource));\n    if (this.imageServices[serviceUrl]) {\n      return this.imageServices[serviceUrl] || null;\n    }\n    if (!this.config.approximateServices) {\n      return null;\n    }\n    if (!imageServer || !imageServer.result || !(source?.height || resource.height) || !(source?.width || resource.width) || !force && (imageServer.malformed || imageServer.verifications < this.config.verificationsRequired) || resource.source && isLevel0(resource.source)) {\n      return null;\n    }\n    if (!this.imageServices[serviceUrl]) {\n      this.imageServices[serviceUrl] = {\n        \"@context\": imageServer.result.context,\n        \"@id\": getId6(resource),\n        id: getId6(resource),\n        protocol: \"http://iiif.io/api/image\",\n        tiles: source?.tiles || sampledTilesToTiles(resource.width, resource.height, imageServer.result.sampledTiles),\n        sizes: source?.sizes || fixedSizesFromScales(\n          Math.round(resource.width / imageServer.result.resourceServiceRatio),\n          Math.round(resource.height / imageServer.result.resourceServiceRatio),\n          imageServer.result.sizeRatios\n        ),\n        profile: source?.profile || imageServer.result.sampledProfile,\n        height: source?.height || resource.height,\n        width: source?.width || resource.width,\n        real: false\n      };\n    }\n    return this.imageServices[serviceUrl] || null;\n  }\n  async getThumbnailFromResource(unknownResource, request, dereference = true, otherCandidates = []) {\n    const candidates = unknownResource ? await this.getImageCandidates(unknownResource, dereference) : [];\n    return pickBestFromCandidates(request, [() => otherCandidates, () => candidates]);\n  }\n  async getImageCandidates(unknownResource, dereference = true) {\n    const resource = unknownResource;\n    if (dereference && resource && resource.height && resource.width) {\n      const imageServices2 = getImageServices2(resource);\n      for (const service of imageServices2) {\n        const request = {\n          id: getId6(service),\n          width: service.width ? service.width : resource.width,\n          height: service.height ? service.height : resource.height,\n          source: service\n        };\n        await this.loadService(request);\n      }\n    }\n    return getImageCandidates(unknownResource, dereference, this);\n  }\n  /**\n   * Verify approximation\n   *\n   * Given an image service, it will dereference that image service and compare the result with what\n   * would have been generated if we used internal guessing.\n   *\n   * @param resource\n   * @return Promise<boolean>\n   */\n  async verify(resource) {\n    const prediction = this.predict(resource, false, true);\n    const imageService = await this.fetchService(getId6(resource));\n    if (!prediction) {\n      return false;\n    }\n    const isValid = prediction.height === imageService.height && prediction.width === imageService.width && prediction[\"@context\"] === imageService[\"@context\"] && imageSizesMatch(prediction.sizes || [], imageService.sizes || []);\n    if (isValid) {\n      const serverId = getImageServerFromId(getId6(resource));\n      const server = this.knownImageServers[serverId];\n      if (server) {\n        server.verifications += 1;\n        if (server.verifications >= this.config.verificationsRequired) {\n          server.verified = true;\n        }\n      }\n    }\n    return isValid;\n  }\n  canLoadSync(service) {\n    const serviceId = typeof service === \"string\" ? service : getId6(service);\n    const canonical = canonicalServiceUrl2(serviceId);\n    if (this.imageServices[canonical]) {\n      return true;\n    }\n    const server = this.knownImageServers[getImageServerFromId(serviceId)];\n    return !!(server && !server.malformed && server.verifications >= this.config.verificationsRequired);\n  }\n  /**\n   * Mark image service as malformed\n   *\n   * If you run into issues requesting images, you can mark an image service as malformed, and it will\n   * return you a new one. Future image services will also be requested fresh, and the system will have\n   * failed. Report a bug if this happens.\n   *\n   * @param resource\n   */\n  async markAsMalformed(resource) {\n    this.knownImageServers[getImageServerFromId(getId6(resource))].malformed = true;\n    return this.loadService(resource, true);\n  }\n  /**\n   * Fetch an image service (use loadService instead)\n   *\n   * @param serviceId\n   * @param forceFresh\n   */\n  async fetchService(serviceId, forceFresh = false) {\n    const serviceUrl = canonicalServiceUrl2(serviceId);\n    const service = this.imageServices[serviceUrl];\n    if (service && (!forceFresh || service.real)) {\n      return service;\n    }\n    if (!this.config.enableFetching) {\n      throw new Error(\"Fetching is not enabled\");\n    }\n    const json = await this.fetch(serviceUrl).then((service2) => service2.json());\n    if (!json.id && json[\"@id\"]) {\n      json.id = json[\"@id\"];\n    }\n    if (json.id !== serviceId) {\n      json.id = serviceId;\n      if (json[\"@id\"]) {\n        json[\"@id\"] = serviceId;\n      }\n    }\n    this.imageServices[serviceUrl] = Object.assign(json, { real: true });\n    return this.imageServices[serviceUrl];\n  }\n  async fetch(input, init) {\n    return fetch(input, init);\n  }\n  /**\n   * Load an image service\n   *\n   * @param resource\n   * @param forceFresh\n   *\n   * @todo make this batched, so only the maximum required can be done at once, to allow\n   *       for the prediction engine to kick in.\n   */\n  async loadService(resource, forceFresh = false) {\n    if (!this.config.disableThrottling) {\n      let running = true;\n      while (running) {\n        if (this.fetchingCount >= this.config.verificationsRequired) {\n          await new Promise((resolve) => setTimeout(resolve, 500));\n        } else {\n          running = false;\n          break;\n        }\n      }\n    }\n    const imageServer = this.knownImageServers[getImageServerFromId(getId6(resource))];\n    if (imageServer && !imageServer.malformed && !forceFresh) {\n      await imageServer.result;\n      const service = this.loadServiceSync(resource);\n      if (service) {\n        return service;\n      }\n    }\n    this.fetchingCount++;\n    const serviceJson = await this.fetchService(getId6(resource), forceFresh);\n    this.fetchingCount--;\n    if (serviceJson.real) {\n      this.sample(serviceJson, resource);\n    }\n    return serviceJson;\n  }\n  /**\n   * Load service synchronously\n   *\n   * If you know that the image service you are\n   * @param resource\n   */\n  loadServiceSync(resource) {\n    const serviceId = canonicalServiceUrl2(getId6(resource));\n    if (this.imageServices[serviceId]) {\n      return this.imageServices[serviceId];\n    }\n    if (!this.config.approximateServices) {\n      return null;\n    }\n    return this.predict(resource);\n  }\n};\n\n// src/image-service/image-service-store.ts\nimport { getId as getId7 } from \"@iiif/parser/image-3\";\nfunction createImageServiceStore(options = {}) {\n  const events = options.events || mitt_default();\n  const loader = options.loader || new ImageServiceLoader();\n  const store = createStore((set, get) => ({\n    loaded: {},\n    loadServiceSync: (service, detail, backgroundRequest) => {\n      const id = service.id || service[\"@id\"];\n      const existing = get().loaded[id];\n      if (existing && existing.status === \"done\") {\n        return existing.service;\n      }\n      if (existing && existing.status === \"loading\") {\n        return null;\n      }\n      if (existing && existing.status === \"error\") {\n        throw new Error(\"Failed to load image service\");\n      }\n      const request = {\n        id: getId7(service),\n        width: service.width || detail?.width || 0,\n        height: service.height || detail?.height || 0,\n        source: service\n      };\n      const loaded = loader.loadServiceSync(request);\n      if (loaded) {\n        set((state) => ({\n          loaded: {\n            ...state.loaded,\n            [id]: {\n              status: \"done\",\n              service: loaded,\n              real: true\n            }\n          }\n        }));\n        events.emit(\"image-service.loaded\", { id, service: loaded });\n      } else {\n        if (backgroundRequest) {\n          get().loadService(service, detail).then(() => {\n          });\n        }\n      }\n      return loaded;\n    },\n    loadService: async (service, detail) => {\n      const id = service.id || service[\"@id\"];\n      const existing = get().loaded[id];\n      if (existing && existing.status === \"done\") {\n        return existing.service;\n      }\n      if (existing && existing.status === \"loading\") {\n        return new Promise((resolve, reject) => {\n          const handler = (e) => {\n            if (e.id === id) {\n              events.off(\"image-service.loaded\", handler);\n              resolve(e.service || service);\n            }\n          };\n          events.on(\"image-service.loaded\", handler);\n        });\n      }\n      if (existing && existing.status === \"error\" && !detail?.force) {\n        throw new Error(\"Failed to load image service\");\n      }\n      events.emit(\"image-service.loading\", { id });\n      try {\n        const request = {\n          id: getId7(service),\n          width: service.width || 0,\n          height: service.height || 0,\n          source: service\n        };\n        const loaded = await loader.loadService(request, detail?.force);\n        set((state) => ({\n          loaded: {\n            ...state.loaded,\n            [id]: {\n              status: \"done\",\n              service: loaded,\n              real: loaded.real\n            }\n          }\n        }));\n        events.emit(\"image-service.loaded\", { id, service: loaded });\n        return loaded;\n      } catch (error) {\n        events.emit(\"image-service.error\", { id, error });\n        throw error;\n      }\n    }\n  }));\n  return {\n    store,\n    events\n  };\n}\nvar imageServices = createImageServiceStore();\n\n// src/image-service/get-smallest-scale-factor-as-single-image.ts\nimport { getId as getId8, getImageServiceLevel as getImageServiceLevel3 } from \"@iiif/parser/image-3\";\nfunction getSmallestScaleFactorAsSingleImage(service) {\n  if (!service.width || !service.height) {\n    return null;\n  }\n  if (service.tiles) {\n    const tiles = service.tiles.sort((a, b) => {\n      return Math.max(...b.scaleFactors) - Math.max(...a.scaleFactors);\n    });\n    const len = tiles.length;\n    for (let i = 0; i < len; i++) {\n      const tile = tiles[i];\n      if (!tile)\n        continue;\n      const targetSize = tile.width;\n      if (!targetSize) {\n        continue;\n      }\n      const sizeLen = tile.scaleFactors.length;\n      const sortedScales = tile.scaleFactors.sort();\n      for (let j = 0; j < sizeLen; j++) {\n        const size = sortedScales[j];\n        if (!size)\n          continue;\n        if (service.width / size <= targetSize && service.height / size <= targetSize) {\n          return {\n            id: getId8(service),\n            type: \"fixed-service\",\n            width: service.width / size | 0,\n            height: service.height / size | 0,\n            level: getImageServiceLevel3(service),\n            version: isImage3(service) ? 3 : 2\n          };\n        }\n      }\n    }\n  }\n  return null;\n}\n\nexport {\n  getImageServerFromId,\n  sampledTilesToTiles,\n  getImageFromTileSource,\n  isBestMatch,\n  pickBestFromCandidates,\n  isImage3,\n  getFixedSizesFromService,\n  getCustomSizeFromService,\n  getImageCandidatesFromService,\n  inferImageSizeFromUrl,\n  getFixedSizeFromImage,\n  getImageCandidates,\n  imageSizesMatch,\n  ImageServiceLoader,\n  createImageServiceStore,\n  imageServices,\n  getSmallestScaleFactorAsSingleImage\n};\n","import {\n  ImageServiceLoader,\n  getFixedSizeFromImage\n} from \"./chunk-4I45SZTR.js\";\nimport {\n  compatVault\n} from \"./chunk-LVD5NUFB.js\";\n\n// src/thumbnail.ts\nvar imageServiceLoader = new ImageServiceLoader();\nvar helpers = /* @__PURE__ */ new Map();\nfunction getThumbnail(input, {\n  vault = compatVault,\n  dereference = false,\n  ...options\n} = {}) {\n  let helper = helpers.get(vault);\n  if (!helper) {\n    helper = createThumbnailHelper(vault);\n    helpers.set(vault, helper);\n  }\n  return helper.getBestThumbnailAtSize(input, options, dereference);\n}\nfunction createThumbnailHelper(vault = compatVault, dependencies = {}) {\n  const loader = dependencies.imageServiceLoader || imageServiceLoader;\n  async function getBestThumbnailAtSize(input, request, dereference = false, candidates = [], dimensions) {\n    const thumbnailNotFound = () => loader.getThumbnailFromResource(void 0, request, dereference, candidates);\n    if (!input) {\n      return await loader.getThumbnailFromResource(void 0, request, dereference, candidates);\n    }\n    if (typeof input === \"string\") {\n      const fixed = getFixedSizeFromImage(input);\n      if (fixed) {\n        candidates.push(fixed);\n      }\n      return await loader.getThumbnailFromResource(void 0, request, dereference, candidates);\n    }\n    const fullInput = vault.get(input, { skipSelfReturn: false });\n    if (typeof fullInput === \"string\") {\n      return { best: getFixedSizeFromImage(fullInput), fallback: [], log: [] };\n    }\n    if (!fullInput) {\n      return await thumbnailNotFound();\n    }\n    const parseThumbnail = async (resource) => {\n      if (resource && resource.thumbnail && resource.thumbnail.length) {\n        const thumbnail = vault.get(resource.thumbnail[0]);\n        const potentialThumbnails = await loader.getImageCandidates(thumbnail, dereference);\n        if (potentialThumbnails && potentialThumbnails.length) {\n          candidates.push(...potentialThumbnails);\n        }\n      }\n    };\n    await parseThumbnail(fullInput);\n    switch (fullInput.type) {\n      case \"Annotation\": {\n        const contentResources = Array.isArray(fullInput.body) ? fullInput.body : [fullInput.body];\n        const firstContentResources = vault.get(contentResources[0]);\n        if (dimensions && !firstContentResources.width) {\n          firstContentResources.width = dimensions.width;\n          firstContentResources.height = dimensions.height;\n        }\n        return await loader.getThumbnailFromResource(firstContentResources, request, dereference, candidates);\n      }\n      case \"Canvas\": {\n        const canvas = fullInput;\n        return getBestThumbnailAtSize(canvas.items[0], request, dereference, candidates, {\n          width: canvas.width,\n          height: canvas.height\n        });\n      }\n      case \"AnnotationPage\": {\n        const annotationPage = fullInput;\n        return getBestThumbnailAtSize(annotationPage.items[0], request, dereference, candidates, dimensions);\n      }\n      case \"Choice\": {\n        const choice = fullInput;\n        if (!choice.items || choice.items[0]) {\n          return await thumbnailNotFound();\n        }\n        return getBestThumbnailAtSize(choice.items[0], request, dereference, candidates, dimensions);\n      }\n      case \"Collection\": {\n        const collection = fullInput;\n        const firstManifest = collection.items[0];\n        if (!firstManifest) {\n          return await thumbnailNotFound();\n        }\n        return getBestThumbnailAtSize(firstManifest, request, dereference, candidates, dimensions);\n      }\n      case \"Manifest\": {\n        const manifest = fullInput;\n        const firstCanvas = manifest.items[0];\n        if (!firstCanvas) {\n          return await thumbnailNotFound();\n        }\n        return getBestThumbnailAtSize(firstCanvas, request, dereference, candidates, dimensions);\n      }\n      case \"SpecificResource\":\n      case \"Image\":\n      case \"Dataset\":\n      case \"Sound\":\n      case \"Text\":\n      case \"TextualBody\":\n      case \"Video\":\n        if (dimensions && !fullInput.width) {\n          fullInput.width = dimensions.width;\n          fullInput.height = dimensions.height;\n        }\n        return loader.getThumbnailFromResource(fullInput, request, dereference, candidates);\n    }\n    return await thumbnailNotFound();\n  }\n  return {\n    getBestThumbnailAtSize\n  };\n}\n\nexport {\n  imageServiceLoader,\n  getThumbnail,\n  createThumbnailHelper\n};\n","import {\n  __commonJS,\n  __publicField,\n  __toESM\n} from \"./chunk-G7A32JAG.js\";\n\n// node_modules/.pnpm/parse-svg-path@0.1.2/node_modules/parse-svg-path/index.js\nvar require_parse_svg_path = __commonJS({\n  \"node_modules/.pnpm/parse-svg-path@0.1.2/node_modules/parse-svg-path/index.js\"(exports, module) {\n    \"use strict\";\n    module.exports = parse;\n    var length = { a: 7, c: 6, h: 1, l: 2, m: 2, q: 4, s: 4, t: 2, v: 1, z: 0 };\n    var segment = /([astvzqmhlc])([^astvzqmhlc]*)/ig;\n    function parse(path) {\n      var data = [];\n      path.replace(segment, function(_, command, args) {\n        var type = command.toLowerCase();\n        args = parseValues(args);\n        if (type == \"m\" && args.length > 2) {\n          data.push([command].concat(args.splice(0, 2)));\n          type = \"l\";\n          command = command == \"m\" ? \"l\" : \"L\";\n        }\n        while (true) {\n          if (args.length == length[type]) {\n            args.unshift(command);\n            return data.push(args);\n          }\n          if (args.length < length[type])\n            throw new Error(\"malformed path data\");\n          data.push([command].concat(args.splice(0, length[type])));\n        }\n      });\n      return data;\n    }\n    var number = /-?[0-9]*\\.?[0-9]+(?:e[-+]?\\d+)?/ig;\n    function parseValues(args) {\n      var numbers = args.match(number);\n      return numbers ? numbers.map(Number) : [];\n    }\n  }\n});\n\n// node_modules/.pnpm/abs-svg-path@0.1.1/node_modules/abs-svg-path/index.js\nvar require_abs_svg_path = __commonJS({\n  \"node_modules/.pnpm/abs-svg-path@0.1.1/node_modules/abs-svg-path/index.js\"(exports, module) {\n    \"use strict\";\n    module.exports = absolutize;\n    function absolutize(path) {\n      var startX = 0;\n      var startY = 0;\n      var x = 0;\n      var y = 0;\n      return path.map(function(seg) {\n        seg = seg.slice();\n        var type = seg[0];\n        var command = type.toUpperCase();\n        if (type != command) {\n          seg[0] = command;\n          switch (type) {\n            case \"a\":\n              seg[6] += x;\n              seg[7] += y;\n              break;\n            case \"v\":\n              seg[1] += y;\n              break;\n            case \"h\":\n              seg[1] += x;\n              break;\n            default:\n              for (var i = 1; i < seg.length; ) {\n                seg[i++] += x;\n                seg[i++] += y;\n              }\n          }\n        }\n        switch (command) {\n          case \"Z\":\n            x = startX;\n            y = startY;\n            break;\n          case \"H\":\n            x = seg[1];\n            break;\n          case \"V\":\n            y = seg[1];\n            break;\n          case \"M\":\n            x = startX = seg[1];\n            y = startY = seg[2];\n            break;\n          default:\n            x = seg[seg.length - 2];\n            y = seg[seg.length - 1];\n        }\n        return seg;\n      });\n    }\n  }\n});\n\n// node_modules/.pnpm/svg-arc-to-cubic-bezier@3.2.0/node_modules/svg-arc-to-cubic-bezier/modules/index.js\nvar _slicedToArray = /* @__PURE__ */ function() {\n  function sliceIterator(arr, i) {\n    var _arr = [];\n    var _n = true;\n    var _d = false;\n    var _e = void 0;\n    try {\n      for (var _i = arr[Symbol.iterator](), _s; !(_n = (_s = _i.next()).done); _n = true) {\n        _arr.push(_s.value);\n        if (i && _arr.length === i)\n          break;\n      }\n    } catch (err) {\n      _d = true;\n      _e = err;\n    } finally {\n      try {\n        if (!_n && _i[\"return\"])\n          _i[\"return\"]();\n      } finally {\n        if (_d)\n          throw _e;\n      }\n    }\n    return _arr;\n  }\n  return function(arr, i) {\n    if (Array.isArray(arr)) {\n      return arr;\n    } else if (Symbol.iterator in Object(arr)) {\n      return sliceIterator(arr, i);\n    } else {\n      throw new TypeError(\"Invalid attempt to destructure non-iterable instance\");\n    }\n  };\n}();\nvar TAU = Math.PI * 2;\nvar mapToEllipse = function mapToEllipse2(_ref, rx, ry, cosphi, sinphi, centerx, centery) {\n  var x = _ref.x, y = _ref.y;\n  x *= rx;\n  y *= ry;\n  var xp = cosphi * x - sinphi * y;\n  var yp = sinphi * x + cosphi * y;\n  return {\n    x: xp + centerx,\n    y: yp + centery\n  };\n};\nvar approxUnitArc = function approxUnitArc2(ang1, ang2) {\n  var a = ang2 === 1.5707963267948966 ? 0.551915024494 : ang2 === -1.5707963267948966 ? -0.551915024494 : 4 / 3 * Math.tan(ang2 / 4);\n  var x1 = Math.cos(ang1);\n  var y1 = Math.sin(ang1);\n  var x2 = Math.cos(ang1 + ang2);\n  var y2 = Math.sin(ang1 + ang2);\n  return [{\n    x: x1 - y1 * a,\n    y: y1 + x1 * a\n  }, {\n    x: x2 + y2 * a,\n    y: y2 - x2 * a\n  }, {\n    x: x2,\n    y: y2\n  }];\n};\nvar vectorAngle = function vectorAngle2(ux, uy, vx, vy) {\n  var sign = ux * vy - uy * vx < 0 ? -1 : 1;\n  var dot = ux * vx + uy * vy;\n  if (dot > 1) {\n    dot = 1;\n  }\n  if (dot < -1) {\n    dot = -1;\n  }\n  return sign * Math.acos(dot);\n};\nvar getArcCenter = function getArcCenter2(px, py, cx, cy, rx, ry, largeArcFlag, sweepFlag, sinphi, cosphi, pxp, pyp) {\n  var rxsq = Math.pow(rx, 2);\n  var rysq = Math.pow(ry, 2);\n  var pxpsq = Math.pow(pxp, 2);\n  var pypsq = Math.pow(pyp, 2);\n  var radicant = rxsq * rysq - rxsq * pypsq - rysq * pxpsq;\n  if (radicant < 0) {\n    radicant = 0;\n  }\n  radicant /= rxsq * pypsq + rysq * pxpsq;\n  radicant = Math.sqrt(radicant) * (largeArcFlag === sweepFlag ? -1 : 1);\n  var centerxp = radicant * rx / ry * pyp;\n  var centeryp = radicant * -ry / rx * pxp;\n  var centerx = cosphi * centerxp - sinphi * centeryp + (px + cx) / 2;\n  var centery = sinphi * centerxp + cosphi * centeryp + (py + cy) / 2;\n  var vx1 = (pxp - centerxp) / rx;\n  var vy1 = (pyp - centeryp) / ry;\n  var vx2 = (-pxp - centerxp) / rx;\n  var vy2 = (-pyp - centeryp) / ry;\n  var ang1 = vectorAngle(1, 0, vx1, vy1);\n  var ang2 = vectorAngle(vx1, vy1, vx2, vy2);\n  if (sweepFlag === 0 && ang2 > 0) {\n    ang2 -= TAU;\n  }\n  if (sweepFlag === 1 && ang2 < 0) {\n    ang2 += TAU;\n  }\n  return [centerx, centery, ang1, ang2];\n};\nvar arcToBezier = function arcToBezier2(_ref2) {\n  var px = _ref2.px, py = _ref2.py, cx = _ref2.cx, cy = _ref2.cy, rx = _ref2.rx, ry = _ref2.ry, _ref2$xAxisRotation = _ref2.xAxisRotation, xAxisRotation = _ref2$xAxisRotation === void 0 ? 0 : _ref2$xAxisRotation, _ref2$largeArcFlag = _ref2.largeArcFlag, largeArcFlag = _ref2$largeArcFlag === void 0 ? 0 : _ref2$largeArcFlag, _ref2$sweepFlag = _ref2.sweepFlag, sweepFlag = _ref2$sweepFlag === void 0 ? 0 : _ref2$sweepFlag;\n  var curves = [];\n  if (rx === 0 || ry === 0) {\n    return [];\n  }\n  var sinphi = Math.sin(xAxisRotation * TAU / 360);\n  var cosphi = Math.cos(xAxisRotation * TAU / 360);\n  var pxp = cosphi * (px - cx) / 2 + sinphi * (py - cy) / 2;\n  var pyp = -sinphi * (px - cx) / 2 + cosphi * (py - cy) / 2;\n  if (pxp === 0 && pyp === 0) {\n    return [];\n  }\n  rx = Math.abs(rx);\n  ry = Math.abs(ry);\n  var lambda = Math.pow(pxp, 2) / Math.pow(rx, 2) + Math.pow(pyp, 2) / Math.pow(ry, 2);\n  if (lambda > 1) {\n    rx *= Math.sqrt(lambda);\n    ry *= Math.sqrt(lambda);\n  }\n  var _getArcCenter = getArcCenter(px, py, cx, cy, rx, ry, largeArcFlag, sweepFlag, sinphi, cosphi, pxp, pyp), _getArcCenter2 = _slicedToArray(_getArcCenter, 4), centerx = _getArcCenter2[0], centery = _getArcCenter2[1], ang1 = _getArcCenter2[2], ang2 = _getArcCenter2[3];\n  var ratio = Math.abs(ang2) / (TAU / 4);\n  if (Math.abs(1 - ratio) < 1e-7) {\n    ratio = 1;\n  }\n  var segments = Math.max(Math.ceil(ratio), 1);\n  ang2 /= segments;\n  for (var i = 0; i < segments; i++) {\n    curves.push(approxUnitArc(ang1, ang2));\n    ang1 += ang2;\n  }\n  return curves.map(function(curve) {\n    var _mapToEllipse = mapToEllipse(curve[0], rx, ry, cosphi, sinphi, centerx, centery), x1 = _mapToEllipse.x, y1 = _mapToEllipse.y;\n    var _mapToEllipse2 = mapToEllipse(curve[1], rx, ry, cosphi, sinphi, centerx, centery), x2 = _mapToEllipse2.x, y2 = _mapToEllipse2.y;\n    var _mapToEllipse3 = mapToEllipse(curve[2], rx, ry, cosphi, sinphi, centerx, centery), x = _mapToEllipse3.x, y = _mapToEllipse3.y;\n    return { x1, y1, x2, y2, x, y };\n  });\n};\nvar modules_default = arcToBezier;\n\n// src/annotation-targets/normalize-svg.ts\nvar import_parse_svg_path = __toESM(require_parse_svg_path(), 1);\nvar import_abs_svg_path = __toESM(require_abs_svg_path(), 1);\nfunction parseAndNormalizeSvgPath(path) {\n  const parsed = (0, import_parse_svg_path.default)(path);\n  const absolute = (0, import_abs_svg_path.default)(parsed);\n  let prevCmd;\n  let startX = 0;\n  let startY = 0;\n  let bezierX = 0;\n  let bezierY = 0;\n  let quadX;\n  let quadY;\n  let x = 0;\n  let y = 0;\n  const out = [];\n  for (let i = 0; i < absolute.length; i++) {\n    let seg = absolute[i];\n    const cmd = seg[0];\n    switch (cmd) {\n      case \"M\":\n        startX = seg[1];\n        startY = seg[2];\n        break;\n      case \"H\":\n        seg = [\"L\", seg[1], startY];\n        break;\n      case \"V\":\n        seg = [\"L\", startX, seg[1]];\n        break;\n      case \"S\":\n        {\n          let cx = x;\n          let cy = y;\n          if (prevCmd === \"C\" || prevCmd == \"S\") {\n            cx += cx - bezierX;\n            cy += cy - bezierY;\n          }\n          seg = [\"C\", cx, cy, seg[1], seg[2], seg[3], seg[4]];\n        }\n        break;\n      case \"T\":\n        if (prevCmd === \"Q\" || prevCmd == \"T\") {\n          quadX = x * 2 - quadX;\n          quadY = y * 2 - quadY;\n        } else {\n          quadX = x;\n          quadY = y;\n        }\n        seg = [\"Q\", quadX, quadY, seg[1], seg[2]];\n        break;\n      case \"Q\":\n        quadX = seg[1];\n        quadY = seg[2];\n        break;\n      case \"A\":\n        {\n          const curves = modules_default({\n            px: x,\n            py: y,\n            cx: seg[6],\n            cy: seg[7],\n            rx: seg[1],\n            ry: seg[2],\n            xAxisRotation: seg[3],\n            largeArcFlag: seg[4],\n            sweepFlag: seg[5]\n          });\n          if (!curves.length) {\n            continue;\n          }\n          for (const [j, curve] of curves.entries()) {\n            seg = [\"C\", curve.x1, curve.y1, curve.x2, curve.y2, curve.x, curve.y];\n            if (j < curves.length - 1) {\n              out.push(seg);\n            }\n          }\n          seg = seg;\n        }\n        break;\n      case \"Z\":\n        seg = [\"L\", startX, startY];\n        break;\n    }\n    prevCmd = cmd;\n    x = seg[seg.length - 2];\n    y = seg[seg.length - 1];\n    if ([\"C\", \"Q\", \"A\"].indexOf(cmd) > -1) {\n      bezierX = seg[seg.length - 4];\n      bezierY = seg[seg.length - 3];\n    } else {\n      bezierX = x;\n      bezierY = y;\n    }\n    out.push(seg);\n  }\n  return out;\n}\n\n// src/annotation-targets/bezier.ts\nfunction flattenQuadraticBezier(start, control, end, tolerance = 1) {\n  return new QuadraticBezier(start, control, end).subdivide(tolerance);\n}\nfunction flattenCubicBezier(start, startControl, end, endControl, tolerance = 1) {\n  return new CubicBezier(\n    new Float64Array([start.x, start.y, startControl.x, startControl.y, end.x, end.y, endControl.x, endControl.y])\n  ).subdivide(tolerance);\n}\nfunction hypot2(p) {\n  return p.x * p.x + p.y * p.y;\n}\nfunction approx_myint(x) {\n  const d = 0.67;\n  return x / (1 - d + Math.pow(Math.pow(d, 4) + 0.25 * x * x, 0.25));\n}\nfunction approx_inv_myint(x) {\n  const b = 0.39;\n  return x * (1 - b + Math.sqrt(b * b + 0.25 * x * x));\n}\nvar QuadraticBezier = class {\n  constructor(start, control, end) {\n    __publicField(this, \"start\");\n    __publicField(this, \"control\");\n    __publicField(this, \"end\");\n    this.start = start;\n    this.control = control;\n    this.end = end;\n  }\n  eval(t) {\n    const mt = 1 - t;\n    return {\n      x: this.start.x * mt * mt + 2 * this.control.x * mt * t + this.end.x * t * t,\n      y: this.start.y * mt * mt + 2 * this.control.y * mt * t + this.end.y * t * t\n    };\n  }\n  mapToBasic() {\n    const { x: x0, y: y0 } = this.start;\n    const { x: x1, y: y1 } = this.control;\n    const { x: x2, y: y2 } = this.end;\n    const ddx = 2 * x1 - x0 - x2;\n    const ddy = 2 * y1 - y0 - y2;\n    const u0 = (x1 - x0) * ddx + (y1 - y0) * ddy;\n    const u2 = (x2 - x1) * ddx + (y2 - y1) * ddy;\n    const cross = (x2 - x0) * ddy - (y2 - y0) * ddx;\n    const paramX0 = u0 / cross;\n    const paramX2 = u2 / cross;\n    const scale = Math.abs(cross) / (Math.hypot(ddx, ddy) * Math.abs(paramX2 - paramX0));\n    return { x0, x2, scale, cross };\n  }\n  subdivide(tolerance) {\n    const params = this.mapToBasic();\n    const a0 = approx_myint(params.x0);\n    const a2 = approx_myint(params.x2);\n    const count = 0.5 * Math.abs(a2 - a0) * Math.sqrt(params.scale / tolerance);\n    const n = Math.ceil(count);\n    const u0 = approx_inv_myint(a0);\n    const u2 = approx_inv_myint(a2);\n    const tValues = [0];\n    for (let i = 1; i < n; i++) {\n      const u = approx_inv_myint(a0 + (a2 - a0) * i / n);\n      const t = (u - u0) / (u2 - u0);\n      tValues.push(t);\n    }\n    tValues.push(1);\n    return tValues.map((t) => this.eval(t));\n  }\n};\nvar CubicBezier = class _CubicBezier {\n  /// Argument is array of coordinate values [x0, y0, x1, y1, x2, y2, x3, y3].\n  constructor(coords) {\n    __publicField(this, \"c\");\n    this.c = coords;\n  }\n  weightsum(c0, c1, c2, c3) {\n    const x = c0 * this.c[0] + c1 * this.c[2] + c2 * this.c[4] + c3 * this.c[6];\n    const y = c0 * this.c[1] + c1 * this.c[3] + c2 * this.c[5] + c3 * this.c[7];\n    return { x, y };\n  }\n  eval(t) {\n    const mt = 1 - t;\n    const c0 = mt * mt * mt;\n    const c1 = 3 * mt * mt * t;\n    const c2 = 3 * mt * t * t;\n    const c3 = t * t * t;\n    return this.weightsum(c0, c1, c2, c3);\n  }\n  deriv(t) {\n    const mt = 1 - t;\n    const c0 = -3 * mt * mt;\n    const c3 = 3 * t * t;\n    const c1 = -6 * t * mt - c0;\n    const c2 = 6 * t * mt - c3;\n    return this.weightsum(c0, c1, c2, c3);\n  }\n  // quadratic bezier with matching endpoints and minimum max vector error\n  midpoint_quadbez() {\n    const p1 = this.weightsum(-0.25, 0.75, 0.75, -0.25);\n    return new QuadraticBezier({ x: this.c[0], y: this.c[1] }, p1, { x: this.c[6], y: this.c[7] });\n  }\n  subsegment(t0, t1) {\n    const c = new Float64Array(8);\n    const p0 = this.eval(t0);\n    const p3 = this.eval(t1);\n    c[0] = p0.x;\n    c[1] = p0.y;\n    const scale = (t1 - t0) / 3;\n    const d1 = this.deriv(t0);\n    c[2] = p0.x + scale * d1.x;\n    c[3] = p0.y + scale * d1.y;\n    const d2 = this.deriv(t1);\n    c[4] = p3.x - scale * d2.x;\n    c[5] = p3.y - scale * d2.y;\n    c[6] = p3.x;\n    c[7] = p3.y;\n    return new _CubicBezier(c);\n  }\n  // Very fancy subdivision scheme\n  subdivide(tol) {\n    const tol1 = 0.1 * tol;\n    const tol2 = tol - tol1;\n    const sqrt_tol2 = Math.sqrt(tol2);\n    const err2 = hypot2(this.weightsum(1, -3, 3, -1));\n    const n_quads = Math.ceil(Math.pow(err2 / (432 * tol1 * tol1), 1 / 6));\n    const quads = [];\n    let sum = 0;\n    for (let i2 = 0; i2 < n_quads; i2++) {\n      const t0 = i2 / n_quads;\n      const t1 = (i2 + 1) / n_quads;\n      const quad = this.subsegment(t0, t1).midpoint_quadbez();\n      const params = quad.mapToBasic();\n      const a0 = approx_myint(params.x0);\n      const a2 = approx_myint(params.x2);\n      const scale = Math.sqrt(params.scale);\n      let val2 = Math.abs(a2 - a0) * scale;\n      if (Math.sign(params.x0) != Math.sign(params.x2)) {\n        const xmin = sqrt_tol2 / scale;\n        const cusp_val = sqrt_tol2 * Math.abs(a2 - a0) / approx_myint(xmin);\n        val2 = Math.max(val2, cusp_val);\n      }\n      quads.push({\n        quad,\n        a0,\n        a2,\n        val: val2\n      });\n      sum += val2;\n    }\n    const count = 0.5 * sum / sqrt_tol2;\n    const n = Math.ceil(count);\n    const result = [{ x: this.c[0], y: this.c[1] }];\n    let val = 0;\n    let i = 0;\n    for (let j = 1; j < n; j++) {\n      const target = sum * j / n;\n      while (val + quads[i].val < target) {\n        val += quads[i].val;\n        i++;\n      }\n      const a0 = quads[i].a0;\n      const a2 = quads[i].a2;\n      const u0 = approx_inv_myint(a0);\n      const u2 = approx_inv_myint(a2);\n      const a = a0 + (a2 - a0) * (target - val) / quads[i].val;\n      const u = approx_inv_myint(a);\n      const t = (u - u0) / (u2 - u0);\n      result.push(quads[i].quad.eval(t));\n    }\n    result.push({ x: this.c[6], y: this.c[7] });\n    return result;\n  }\n};\n\n// src/annotation-targets/parse-selector.ts\nvar BOX_SELECTOR = /&?(xywh=)?(pixel:|percent:|pct:)?([0-9]+(?:\\.[0-9]+)?),([0-9]+(?:\\.[0-9]+)?),([0-9]+(?:\\.[0-9]+)?),([0-9]+(?:\\.[0-9]+)?)/;\nvar TEMPORAL_SELECTOR = /&?(t=)(npt:)?([0-9]+(\\.[0-9]+)?)?(,([0-9]+(\\.[0-9]+)?))?/;\nvar RGBA_COLOR = /^rgba\\((\\d+),(\\d+),(\\d+),([0-9.]+)\\)$/;\nfunction parseSelector(source, {\n  domParser,\n  svgPreprocessor,\n  iiifRenderingHints\n} = {}) {\n  if (Array.isArray(source)) {\n    return resolveHints(\n      source.reduce(\n        (data, nextSource) => {\n          const {\n            selector,\n            selectors,\n            iiifRenderingHints: newIiifRenderingHints\n          } = parseSelector(nextSource, { domParser, svgPreprocessor, iiifRenderingHints });\n          if (selector) {\n            if (!data.selector) {\n              data.selector = selector;\n            }\n            data.selectors.push(...selectors);\n          }\n          if (newIiifRenderingHints) {\n            data.iiifRenderingHints = data.iiifRenderingHints || { type: \"ImageApiSelector\" };\n            Object.assign(data.iiifRenderingHints, newIiifRenderingHints);\n          }\n          return data;\n        },\n        {\n          selector: null,\n          selectors: [],\n          iiifRenderingHints\n        }\n      )\n    );\n  }\n  if (!source) {\n    return resolveHints({\n      selector: null,\n      selectors: [],\n      iiifRenderingHints\n    });\n  }\n  if (typeof source === \"string\") {\n    const [id, fragment] = source.split(\"#\");\n    if (!fragment) {\n      return resolveHints({\n        selector: null,\n        selectors: [],\n        iiifRenderingHints\n      });\n    }\n    return parseSelector(\n      { type: \"FragmentSelector\", value: fragment },\n      { svgPreprocessor, iiifRenderingHints, domParser }\n    );\n  }\n  if (source.type) {\n    if (source.type === \"PointSelector\" && (source.t || source.t === 0)) {\n      const selector = {\n        type: \"TemporalSelector\",\n        temporal: {\n          startTime: source.t\n        }\n      };\n      return resolveHints({\n        selector,\n        selectors: [selector],\n        iiifRenderingHints\n      });\n    }\n    if (source.type === \"PointSelector\" && source.x && source.y) {\n      const selector = {\n        type: \"PointSelector\",\n        spatial: {\n          x: source.x,\n          y: source.y\n        }\n      };\n      return resolveHints({\n        selector,\n        selectors: [selector],\n        iiifRenderingHints\n      });\n    }\n  }\n  if (isImageApiSelector(source)) {\n    const selectors = [];\n    if (source.region) {\n      const parsedRegion = parseSelector(\n        { type: \"FragmentSelector\", value: \"xywh=\" + source.region },\n        { domParser, svgPreprocessor, iiifRenderingHints }\n      );\n      selectors.push(...parsedRegion.selectors);\n    }\n    return resolveHints({\n      selector: selectors[0],\n      selectors,\n      iiifRenderingHints: iiifRenderingHints ? { ...iiifRenderingHints, ...source } : source\n    });\n  }\n  if (source.type === \"FragmentSelector\") {\n    const matchBoxSelector = BOX_SELECTOR.exec(source.value);\n    if (matchBoxSelector) {\n      let selector = {\n        type: \"BoxSelector\",\n        spatial: {\n          unit: matchBoxSelector[2] === \"percent:\" || matchBoxSelector[2] === \"pct:\" ? \"percent\" : \"pixel\",\n          x: parseFloat(matchBoxSelector[3]),\n          y: parseFloat(matchBoxSelector[4]),\n          width: parseFloat(matchBoxSelector[5]),\n          height: parseFloat(matchBoxSelector[6])\n        }\n      };\n      const matchBoxTimeSelector = source.value.match(TEMPORAL_SELECTOR);\n      if (matchBoxTimeSelector) {\n        selector = {\n          type: \"TemporalBoxSelector\",\n          spatial: selector.spatial,\n          temporal: {\n            startTime: matchBoxTimeSelector[3] ? parseFloat(matchBoxTimeSelector[3]) : 0,\n            endTime: matchBoxTimeSelector[6] ? parseFloat(matchBoxTimeSelector[6]) : void 0\n          }\n        };\n      }\n      return resolveHints({\n        selector,\n        selectors: [selector],\n        iiifRenderingHints\n      });\n    }\n    const matchTimeSelector = source.value.match(TEMPORAL_SELECTOR);\n    if (matchTimeSelector) {\n      const selector = {\n        type: \"TemporalSelector\",\n        temporal: {\n          startTime: matchTimeSelector[3] ? parseFloat(matchTimeSelector[3]) : 0,\n          endTime: matchTimeSelector[6] ? parseFloat(matchTimeSelector[6]) : void 0\n        }\n      };\n      return resolveHints({\n        selector,\n        selectors: [selector],\n        iiifRenderingHints\n      });\n    }\n    return resolveHints({\n      selector: null,\n      selectors: [],\n      iiifRenderingHints\n    });\n  }\n  if (source.type === \"SvgSelector\" && \"value\" in source) {\n    if (!domParser) {\n      if (typeof window !== \"undefined\") {\n        domParser = new window.DOMParser();\n      } else {\n        console.warn(\n          \"No DOMParser available, cannot parse SVG selector, `points`, `spatial` and `style` will be unavailable and the SVG will not be normalized.\"\n        );\n      }\n    }\n    let points = [];\n    let rect;\n    let style;\n    let svg = svgPreprocessor?.(source.value) ?? source.value;\n    let svgShape;\n    if (domParser) {\n      const svgElement = domParser.parseFromString(source.value, \"image/svg+xml\").querySelector(\"svg\");\n      if (!svgElement) {\n        console.warn(`Illegal SVG selector: ${source.value}`);\n        return resolveHints({\n          selector: null,\n          selectors: [],\n          iiifRenderingHints\n        });\n      }\n      const selectorElem = getSelectorElement(svgElement);\n      if (selectorElem) {\n        points = selectorElem.points;\n        svgShape = selectorElem.shapeType;\n        rect = [\n          Math.min(...points.map((p) => p[0])),\n          // llx\n          Math.min(...points.map((p) => p[1])),\n          // lly\n          Math.max(...points.map((p) => p[0])),\n          // urx\n          Math.max(...points.map((p) => p[1]))\n          // ury\n        ];\n        ({ style, svg } = extractStyles(selectorElem.element) ?? { svg });\n      }\n    }\n    const sel = {\n      type: \"SvgSelector\",\n      svg,\n      svgShape,\n      style,\n      points: points.length ? points : void 0,\n      spatial: rect ? { unit: \"pixel\", x: rect[0], y: rect[1], width: rect[2] - rect[0], height: rect[3] - rect[1] } : void 0\n    };\n    return resolveHints({\n      selector: sel,\n      selectors: [sel],\n      iiifRenderingHints\n    });\n  }\n  return resolveHints({\n    selector: null,\n    selectors: [],\n    iiifRenderingHints\n  });\n}\nfunction getShapeTypeFromPath(svgPath) {\n  const cmdFrequencies = svgPath.map((seg) => seg[0]).reduce(\n    (acc, cmd) => {\n      acc[cmd] += 1;\n      return acc;\n    },\n    { C: 0, Q: 0, L: 0, M: 0 }\n  );\n  const cmdTypes = new Set(svgPath.map((seg) => seg[0]));\n  if (cmdFrequencies.C > 0 || cmdFrequencies.Q > 0) {\n    return \"path\";\n  }\n  if (cmdFrequencies.L > 0 && (cmdTypes.size === 1 || cmdTypes.size === 2 && cmdTypes.has(\"M\"))) {\n    if (cmdFrequencies.L === 4) {\n      return \"rect\";\n    }\n    const lastSeg = svgPath.slice(-1)[0];\n    if (svgPath[0][0] === \"M\" && lastSeg[0] === \"L\" && lastSeg[1] == svgPath[0][1] && lastSeg[2] === svgPath[0][2] || lastSeg[1] === 0 && lastSeg[2] === 0) {\n      return \"polygon\";\n    } else {\n      return \"polyline\";\n    }\n  }\n  return \"path\";\n}\nfunction getSelectorElement(svgElem) {\n  for (const element of Array.from(svgElem.children)) {\n    switch (element?.tagName.toLowerCase()) {\n      case \"g\":\n        {\n          const res = getSelectorElement(element);\n          if (res) {\n            return res;\n          }\n        }\n        continue;\n      case \"path\": {\n        const p = element.getAttribute(\"d\");\n        if (!p) {\n          continue;\n        }\n        const normalized = parseAndNormalizeSvgPath(p);\n        return { element, points: pathToPoints(normalized), shapeType: getShapeTypeFromPath(normalized) };\n      }\n      case \"circle\": {\n        const cx = parseFloat(element.getAttribute(\"cx\") ?? \"0\");\n        const cy = parseFloat(element.getAttribute(\"cy\") ?? \"0\");\n        const r = parseFloat(element.getAttribute(\"r\") ?? \"0\");\n        if (!r) {\n          continue;\n        }\n        const points = [];\n        for (let angle = 0; angle <= 360; angle += 12) {\n          const rad = angle * Math.PI / 180;\n          points.push([cx + r * Math.cos(rad), cy + r * Math.sin(rad)]);\n        }\n        return { element, points, shapeType: \"circle\" };\n      }\n      case \"ellipse\": {\n        const cx = parseFloat(element.getAttribute(\"cx\") ?? \"0\");\n        const cy = parseFloat(element.getAttribute(\"cy\") ?? \"0\");\n        const rx = parseFloat(element.getAttribute(\"rx\") ?? \"0\");\n        const ry = parseFloat(element.getAttribute(\"ry\") ?? \"0\");\n        if (!rx && !ry) {\n          continue;\n        }\n        const points = [];\n        for (let angle = 0; angle <= 360; angle += 12) {\n          const t = Math.tan(angle / 360 * Math.PI);\n          const px = rx * (1 - t ** 2) / (1 + t ** 2);\n          const py = ry * 2 * t / (1 + t ** 2);\n          points.push([cx + px, cy + py]);\n        }\n        return { element, points, shapeType: \"ellipse\" };\n      }\n      case \"line\": {\n        const x0 = parseFloat(element.getAttribute(\"x0\") ?? \"0\");\n        const y0 = parseFloat(element.getAttribute(\"y0\") ?? \"0\");\n        const x1 = parseFloat(element.getAttribute(\"x1\") ?? \"0\");\n        const y1 = parseFloat(element.getAttribute(\"y1\") ?? \"0\");\n        if (x0 === x1 && y0 === y1) {\n          continue;\n        }\n        return {\n          element,\n          points: [\n            [x0, y0],\n            [x1, y1]\n          ],\n          shapeType: \"polyline\"\n        };\n      }\n      case \"polygon\":\n      case \"polyline\": {\n        const points = element.getAttribute(\"points\")?.split(\" \").map((ps) => ps.split(\",\").map(parseFloat)) ?? [];\n        if (!points.length) {\n          continue;\n        }\n        let shapeType = \"polyline\";\n        if (element.tagName.toLowerCase() === \"polygon\") {\n          points.push(points[0]);\n          shapeType = \"polygon\";\n        }\n        return { element, points, shapeType };\n      }\n      case \"rect\": {\n        const x = parseFloat(element.getAttribute(\"x\") ?? \"0\");\n        const y = parseFloat(element.getAttribute(\"y\") ?? \"0\");\n        const width = parseFloat(element.getAttribute(\"width\") ?? \"0\");\n        const height = parseFloat(element.getAttribute(\"height\") ?? \"0\");\n        if (!width || !height) {\n          continue;\n        }\n        return {\n          element,\n          points: [\n            [x, y],\n            [x + width, y],\n            [x + width, y + height],\n            [x, y + height],\n            [x, y]\n          ],\n          shapeType: \"rect\"\n        };\n      }\n      default:\n        continue;\n    }\n  }\n  return null;\n}\nfunction pathToPoints(normalizedPath) {\n  const out = [];\n  for (let i = 0; i < normalizedPath.length; i++) {\n    const startPoint = out[out.length - 1] ?? [0, 0];\n    const seg = normalizedPath[i];\n    switch (seg[0]) {\n      case \"M\":\n      case \"L\":\n        out.push([seg[1], seg[2]]);\n        continue;\n      case \"C\":\n        out.push(\n          ...flattenCubicBezier(\n            { x: startPoint[0], y: startPoint[1] },\n            { x: seg[1], y: seg[2] },\n            { x: seg[3], y: seg[4] },\n            { x: seg[5], y: seg[6] }\n          ).map((p) => [p.x, p.y]).slice(1)\n          // skip first point, already part of output\n        );\n        continue;\n      case \"Q\":\n        out.push(\n          ...flattenQuadraticBezier(\n            { x: startPoint[0], y: startPoint[1] },\n            { x: seg[1], y: seg[2] },\n            { x: seg[3], y: seg[4] }\n          ).map((p) => [p.x, p.y]).slice(1)\n          // skip first point, already part of output\n        );\n        continue;\n    }\n  }\n  return out;\n}\nfunction extractStyles(selectorElement) {\n  const style = {};\n  if (selectorElement.hasAttribute(\"fill\")) {\n    style.fill = selectorElement.getAttribute(\"fill\");\n    selectorElement.removeAttribute(\"fill\");\n  } else if (selectorElement.style && selectorElement.style.fill) {\n    style.fill = selectorElement.style.fill;\n  }\n  if (style.fill) {\n    const rgbaMatch = RGBA_COLOR.exec(style.fill);\n    if (rgbaMatch) {\n      style.fillOpacity = parseFloat(rgbaMatch[4]);\n      style.fill = `rgb(${rgbaMatch[1]}, ${rgbaMatch[2]}, ${rgbaMatch[3]})`;\n    }\n  }\n  if (selectorElement.hasAttribute(\"fill-opacity\")) {\n    style.fillOpacity = parseFloat(selectorElement.getAttribute(\"fill-opacity\"));\n    selectorElement.removeAttribute(\"fill-opacity\");\n  } else if (selectorElement.style && selectorElement.style.fillOpacity) {\n    style.fillOpacity = parseFloat(selectorElement.style.fillOpacity);\n  }\n  if (selectorElement.hasAttribute(\"stroke\")) {\n    style.stroke = selectorElement.getAttribute(\"stroke\");\n    selectorElement.removeAttribute(\"stroke\");\n  } else if (selectorElement.style && selectorElement.style.stroke) {\n    style.stroke = selectorElement.style.stroke;\n  }\n  if (style.stroke) {\n    const rgbaMatch = RGBA_COLOR.exec(style.stroke);\n    if (rgbaMatch) {\n      style.strokeOpacity = parseFloat(rgbaMatch[4]);\n      style.stroke = `rgb(${rgbaMatch[1]}, ${rgbaMatch[2]}, ${rgbaMatch[3]})`;\n    }\n  }\n  if (selectorElement.hasAttribute(\"stroke-opacity\")) {\n    style.strokeOpacity = parseFloat(selectorElement.getAttribute(\"stroke-opacity\"));\n    selectorElement.removeAttribute(\"stroke-opacity\");\n  } else if (selectorElement.style && selectorElement.style.strokeOpacity) {\n    style.strokeOpacity = parseFloat(selectorElement.style.strokeOpacity);\n  }\n  if (selectorElement.hasAttribute(\"stroke-width\")) {\n    style.strokeWidth = selectorElement.getAttribute(\"stroke-width\");\n    selectorElement.removeAttribute(\"stroke-width\");\n  } else if (selectorElement.style && selectorElement.style.strokeWidth) {\n    style.strokeWidth = selectorElement.style.strokeWidth;\n  }\n  if (selectorElement.hasAttribute(\"stroke-dasharray\")) {\n    style.strokeDasharray = selectorElement.getAttribute(\"stroke-dasharray\");\n    selectorElement.removeAttribute(\"stroke-dasharray\");\n  } else if (selectorElement.style && selectorElement.style.strokeDasharray) {\n    style.strokeDasharray = selectorElement.style.strokeDasharray;\n  }\n  let rootElem = selectorElement;\n  while (rootElem.tagName.toLowerCase() !== \"svg\") {\n    rootElem = rootElem.parentElement;\n    if (rootElem === null) {\n      throw new Error(\"Could not find root SVG element\");\n    }\n  }\n  return { svg: rootElem.outerHTML, style: Object.keys(style).length > 0 ? style : void 0 };\n}\nfunction isImageApiSelector(t) {\n  return !!t && t.type === \"iiif:ImageApiSelector\" && t.type === \"iiif:ImageApiSelector\";\n}\nfunction resolveHints(supported) {\n  if (supported.iiifRenderingHints) {\n    const source = supported.iiifRenderingHints;\n    if (source.rotation) {\n      const parsedRotation = parseRotation(`${source.rotation}`);\n      if (parsedRotation) {\n        if (supported.selectors.length) {\n          for (const selector of supported.selectors) {\n            selector.rotation = parsedRotation;\n          }\n        } else {\n          supported.selectors.push({\n            type: \"RotationSelector\",\n            rotation: parsedRotation\n          });\n        }\n      }\n    }\n  } else {\n    delete supported.iiifRenderingHints;\n  }\n  return supported;\n}\nfunction parseRotation(input) {\n  let num = parseFloat(input);\n  if (num && input.startsWith(\"!\")) {\n    num = 360 - num;\n  }\n  if (num) {\n    num = num % 360;\n  }\n  if (num !== num) {\n    return 0;\n  }\n  return num || 0;\n}\n\n// src/annotation-targets/expand-target.ts\nfunction expandTarget(target, options = {}) {\n  if (Array.isArray(target)) {\n    return expandTarget(target[0]);\n  }\n  if (typeof target === \"string\") {\n    const [id, fragment] = target.split(\"#\");\n    if (!fragment) {\n      return {\n        type: \"SpecificResource\",\n        source: { id, type: options.typeMap && options.typeMap[id] || \"Unknown\" },\n        selector: null,\n        selectors: []\n      };\n    }\n    return expandTarget({\n      type: \"SpecificResource\",\n      source: { id, type: \"Unknown\" },\n      selector: {\n        type: \"FragmentSelector\",\n        value: fragment\n      }\n    });\n  }\n  if (target.type === \"Choice\" || target.type === \"List\" || target.type === \"Composite\" || target.type === \"Independents\") {\n    return expandTarget(target.items[0]);\n  }\n  if (!target.type && \"source\" in target) {\n    target.type = \"SpecificResource\";\n  }\n  if (target.type === \"SpecificResource\") {\n    if (target.source.type === \"Canvas\" && target.source.partOf && typeof target.source.partOf === \"string\") {\n      target.source.partOf = [\n        {\n          id: target.source.partOf,\n          type: \"Manifest\"\n        }\n      ];\n    }\n    const { selector, selectors } = target.selector ? parseSelector(target.selector, options) : { selector: null, selectors: [] };\n    return {\n      type: \"SpecificResource\",\n      source: target.source,\n      selector,\n      selectors\n    };\n  }\n  if (target.id) {\n    if (target.type === \"Canvas\" && target.partOf && typeof target.partOf === \"string\") {\n      target.partOf = [\n        {\n          id: target.partOf,\n          type: \"Manifest\"\n        }\n      ];\n    }\n    const [id, fragment] = target.id.split(\"#\");\n    if (!fragment) {\n      return {\n        type: \"SpecificResource\",\n        source: {\n          ...target,\n          id\n        },\n        selector: null,\n        selectors: []\n      };\n    }\n    return expandTarget({\n      type: \"SpecificResource\",\n      source: {\n        ...target,\n        id\n      },\n      selector: {\n        type: \"FragmentSelector\",\n        value: fragment\n      }\n    });\n  }\n  return {\n    type: \"SpecificResource\",\n    source: target,\n    selector: null,\n    selectors: []\n  };\n}\n\nexport {\n  parseSelector,\n  isImageApiSelector,\n  parseRotation,\n  expandTarget\n};\n/** Code to \"flatten\" quadratic and cubic Bzier curves to polylines.\n *\n * All code in this module is based on JavaScript code by Raph Levien, published on his blog at\n * https://raphlinus.github.io/.\n * I merely changed the structure a bit, removed some unneeded parts and added some comments and type hints.\n *\n * Flattening of quadratic Bzier curves:\n * - Article: https://raphlinus.github.io/graphics/curves/2019/12/23/flatten-quadbez.html\n * - Code: https://github.com/raphlinus/raphlinus.github.io/blob/master/_posts/2019-12-23-flatten-quadbez.md?plain=1#L73-L212\n *\n * Flattening of cubic Bzier curves: https://levien.com/tmp/flatten.html\n *\n * Note that the code in this module has a different license than the rest of the package,\n * due to the inclusion of Apache-licensed third party code.\n *\n * @license\n * Copyright 2022 Johannes Baiter <johannes.baiter@gmail.com>\n * Copyright 2019, 2022 Raph Levien <raph.levien@gmail.com>\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n","var Ce=Object.defineProperty;var Le=(i,e,t)=>e in i?Ce(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t;var w=(i,e,t)=>(Le(i,typeof e!=\"symbol\"?e+\"\":e,t),t);function u(i){return i.endsWith(\"info.json\")?i:i.endsWith(\"/\")?`${i}info.json`:`${i}/info.json`}var Oe=\"http://library.stanford.edu/iiif/image-api/compliance.html#level0\",j=\"http://library.stanford.edu/iiif/image-api/compliance.html#level1\",T=\"http://library.stanford.edu/iiif/image-api/compliance.html#level2\",Pe=\"http://library.stanford.edu/iiif/image-api/conformance.html#level0\",$=\"http://library.stanford.edu/iiif/image-api/conformance.html#level1\",B=\"http://library.stanford.edu/iiif/image-api/conformance.html#level2\",Me=\"http://library.stanford.edu/iiif/image-api/1.1/compliance.html#level0\",N=\"http://library.stanford.edu/iiif/image-api/1.1/compliance.html#level1\",k=\"http://library.stanford.edu/iiif/image-api/1.1/compliance.html#level2\",We=\"http://library.stanford.edu/iiif/image-api/1.1/conformance.html#level0\",G=\"http://library.stanford.edu/iiif/image-api/1.1/conformance.html#level1\",H=\"http://library.stanford.edu/iiif/image-api/1.1/conformance.html#level2\",je=\"http://iiif.io/api/image/1/level0.json\",Te=\"http://iiif.io/api/image/1/profiles/level0.json\",U=\"http://iiif.io/api/image/1/level1.json\",V=\"http://iiif.io/api/image/1/profiles/level1.json\",Q=\"http://iiif.io/api/image/1/level2.json\",D=\"http://iiif.io/api/image/1/profiles/level2.json\",$e=\"http://iiif.io/api/image/2/level0.json\",Be=\"http://iiif.io/api/image/2/profiles/level0.json\",J=\"http://iiif.io/api/image/2/level1.json\",Z=\"http://iiif.io/api/image/2/profiles/level1.json\",K=\"http://iiif.io/api/image/2/level2.json\",X=\"http://iiif.io/api/image/2/profiles/level2.json\",Ne=\"level0\",Y=\"level1\",q=\"level2\",ke=\"http://iiif.io/api/image/2/level0\",ee=\"http://iiif.io/api/image/2/level1\",ie=\"http://iiif.io/api/image/2/level2\",Ge=\"https://iiif.io/api/image/1.1/compliance/#level0\",te=\"https://iiif.io/api/image/1.1/compliance/#level1\",re=\"https://iiif.io/api/image/1.1/compliance/#level2\",R=[ie,T,B,k,H,Q,D,K,X,q,re],_=[...R,ee,j,$,N,G,U,V,J,Z,Y,te],C=[ke,ee,ie,Oe,j,T,Pe,$,B,Me,N,k,We,G,H,je,Te,U,V,Q,D,$e,Be,J,Z,K,X,Ne,Y,q,Ge,te,re],Ve=C,oe={extraFormats:[\"jpg\"],extraQualities:[\"default\"],extraFeatures:[\"sizeByWhListed\"]},ae={extraFormats:[\"jpg\"],extraQualities:[\"default\"],extraFeatures:[\"baseUriRedirect\",\"cors\",\"jsonldMediaType\",\"regionByPx\",\"regionSquare\",\"sizeByWhListed\",\"sizeByH\",\"sizeByW\",\"sizeByWh\"]},ne={extraFormats:[\"jpg\",\"png\"],extraQualities:[\"default\"],extraFeatures:[\"baseUriRedirect\",\"cors\",\"jsonldMediaType\",\"regionByPct\",\"regionByPx\",\"regionSquare\",\"rotationBy90s\",\"sizeByWhListed\",\"sizeByConfinedWh\",\"sizeByH\",\"sizeByPct\",\"sizeByW\",\"sizeByWh\"]},L=[\"baseUriRedirect\",\"canonicalLinkHeader\",\"cors\",\"jsonldMediaType\",\"mirroring\",\"profileLinkHeader\",\"regionByPct\",\"regionByPx\",\"regionSquare\",\"rotationArbitrary\",\"rotationBy90s\",\"sizeByConfinedWh\",\"sizeByH\",\"sizeByPct\",\"sizeByW\",\"sizeByWh\",\"sizeUpscaling\",\"sizeByWhListed\",\"sizeByDistortedWh\",\"sizeByForcedWh\"];function se(i){return R.indexOf(i)!==-1?ne:_.indexOf(i)!==-1?ae:oe}function z(i){let e=i?Array.isArray(i.profile)?i.profile:[i.profile]:[],t={extraQualities:[],extraFormats:[],extraFeatures:[]};for(let r of e)if(typeof r==\"string\"&&(r=se(r)),!!r){if(r.formats)for(let o of r.formats)t.extraFormats.indexOf(o)===-1&&t.extraFormats.push(o);if(r.qualities)for(let o of r.qualities)t.extraQualities.indexOf(o)===-1&&t.extraQualities.push(o);if(r.supports)for(let o of r.supports)t.extraFeatures.indexOf(o)===-1&&t.extraFeatures.push(o);if(r.maxHeight&&(t.maxHeight=r.maxHeight),r.maxWidth&&(t.maxWidth=r.maxWidth),r.maxArea&&(t.maxArea=r.maxArea),r.extraFormats)for(let o of r.extraFormats)t.extraFormats.indexOf(o)===-1&&t.extraFormats.push(o);if(r.extraQualities)for(let o of r.extraQualities)t.extraQualities.indexOf(o)===-1&&t.extraQualities.push(o);if(r.extraFeatures)for(let o of r.extraFeatures)t.extraFeatures.indexOf(o)===-1&&t.extraFeatures.push(o);r.maxHeight&&(t.maxHeight=r.maxHeight),r.maxWidth&&(t.maxWidth=r.maxWidth),r.maxArea&&(t.maxArea=r.maxArea)}if(i.extraFormats)for(let r of i.extraFormats)t.extraFormats.indexOf(r)===-1&&t.extraFormats.push(r);if(i.extraFeatures)for(let r of i.extraFeatures)t.extraFeatures.indexOf(r)===-1&&t.extraFeatures.push(r);if(i.extraQualities)for(let r of i.extraQualities)t.extraQualities.indexOf(r)===-1&&t.extraQualities.push(r);return t}function fe(i){try{if(i===\"full\")return{full:!0};if(i===\"square\")return{square:!0};let e=i.startsWith(\"pct:\"),r=i.substr(e?4:0).split(\",\").map(o=>parseFloat(o));return{x:r[0],y:r[1],w:r[2],h:r[3],percent:e}}catch{throw new Error(\"Expected 'full', 'square' or 'x,y,w,h'. Found \"+i)}}function me(i){let e={upscaled:!1,max:!1,confined:!1};if(i[0]===\"^\"&&(e.upscaled=!0,i=i.slice(1)),i===\"max\"||i===\"full\")return e.max=!0,e.serialiseAsFull=i===\"full\",e;if(i[0]===\"!\"&&(e.confined=!0,i=i.slice(1)),i[0]===\"p\")return e.percentScale=parseFloat(i.slice(4)),e;let t=i.split(\",\").map(r=>r.trim());return t.length&&typeof t[0]<\"u\"&&(t[0]!==\"\"&&(e.width=parseInt(t[0],10)),typeof t[1]<\"u\"&&t[1]!==\"\"?(e.height=parseInt(t[1],10),e.version=2):e.version=3),e}function le(i){let e={angle:0};if(i[0]===\"!\"&&(e.mirror=!0,i=i.substr(1)),e.angle=parseFloat(i)%360,Number.isNaN(e.angle))throw new Error(`Invalid rotation ${i}`);return e}function pe(i,e=\"\"){let t=i.match(/^(([a-zA-Z]+):\\/\\/([^/]+))?((.*)+)/);if(!t)throw new Error(`Invalid or unknown input ${i}`);let r=t[2],o=t[3],a=t[4];if(a[0]===\"/\"&&(a=a.substring(1)),e.length>0){if(e[0]===\"/\"&&(e=e.substring(1)),e!==a.substring(0,e.length))throw new Error(`Path does not start with prefix (path: ${a}, prefix: ${e})`);a=a.substring(e.length)}return{scheme:r,server:o,path:a,prefix:e}}function ce(i,e=\"\"){let{path:t,scheme:r,server:o,prefix:a}=pe(i,e),n=(t||\"\").split(\"/\").reverse(),[s,f,c,m,...h]=n,x=h.reverse().filter(Boolean).join(\"/\");if(n.length===1||s===\"\")return{type:\"base\",scheme:r,server:o,prefix:a,identifier:x};if(s===\"info.json\"){let[,...p]=n;return{type:\"info\",scheme:r,server:o,prefix:a,identifier:p.reverse().filter(Boolean).join(\"/\")}}let g=(s||\"\").split(\".\");if(typeof g[1]>\"u\"||typeof g[0]>\"u\"||typeof m>\"u\"||typeof c>\"u\"||typeof f>\"u\")throw new Error(\"Invalid image request\");return{type:\"image\",scheme:r,server:o,prefix:a,identifier:x,originalPath:t,region:fe(m),size:me(c),rotation:le(f),quality:g[0],format:g[1]}}function he(i){let e=ce(u(i.id));if(e.type!==\"info\")throw new Error(\"Invalid service URL\");let t=z(i);return{identifier:e.identifier,originalPath:\"\",server:e.server,prefix:e.prefix,scheme:e.scheme,type:\"image\",quality:t.extraQualities.indexOf(\"default\")===-1?t.extraQualities[0]:\"default\",region:{full:!0},size:{max:!0,upscaled:!1,confined:!1},format:\"jpg\",rotation:{angle:0}}}function ge(i,e,t){let r=t.length,o=[];for(let a=0;a<r;a++){let n=t[a];if(n){let s=n.width;o.push(i/s)}}return o}function ue(i,e,t){let r=t.length,o=[];for(let a=0;a<r;a++){let n=t[a];n&&o.push({width:Math.floor(i/n),height:Math.floor(e/n)})}return o}function l(i){if(i[\"@id\"])return i[\"@id\"];if(i.id)return i.id}function d(i){if(!i||!i.profile||!l(i))return!1;let e=Array.isArray(i.profile)?i.profile:[i.profile];for(let t of e)if(typeof t==\"string\"&&C.indexOf(t)!==-1)return!0;return!1}function de(i){if(!d(i))return!1;let e=Array.isArray(i.profile)?i.profile:[i.profile];for(let t of e)if(typeof t==\"string\"){if(_.indexOf(t)!==-1)return!0}else{let r=[...t.supports||[],...t.extraFeatures||[]];if(r.indexOf(\"regionByPx\")!==-1&&(r.indexOf(\"sizeByW\")!==-1||r.indexOf(\"sizeByWh\")!==-1))return!0}return!1}function v(i,e){if(e&&e.profile){let t=e.profile;if(t){let r=Array.isArray(t)?t:[t];return r.includes(`level${i}`)||r.includes(`http://iiif.io/api/image/2/level${i}.json`)||r.includes(`http://iiif.io/api/image/1/level${i}.json`)||r.includes(`http://iiif.io/api/image/1/profiles/level${i}.json`)}}return!1}function I(i){return d(i)?v(0,i)?0:v(1,i)?1:v(2,i)?2:null:null}function y(i){return(i[\"@context\"]?Array.isArray(i[\"@context\"])?i[\"@context\"]:[i[\"@context\"]]:[]).indexOf(\"http://iiif.io/api/image/3/context.json\")!==-1}function xe(i){if(!de(i))return[];let e=[],t=Array.isArray(i.profile)?i.profile:[i.profile],r=t.length;for(let o=0;o<r;o++){let a=t[o];if(a&&typeof a!=\"string\"&&(a.maxHeight||a.maxWidth))return[{id:l(i),type:\"variable\",minWidth:0,minHeight:0,maxHeight:a.maxHeight||a.maxWidth,maxWidth:a.maxWidth||a.maxHeight,level:I(i),version:i[\"@context\"]===\"http://iiif.io/api/image/3/context.json\"?3:2}]}if(i.tiles){let o=i.tiles.length;for(let a=0;a<o;a++){let n=i.tiles[a];n&&(n.height||n.width)&&e.push({id:l(i),type:\"variable\",minHeight:0,minWidth:0,maxHeight:n.height||n.width,maxWidth:n.width,level:I(i),version:y(i)?3:2})}}return e}function O(i){let e=/^.*\\/(full)\\/(((\\d+),(\\d+)?)|max)\\/(\\d+)\\/default\\.(jpg|png|jpeg)$/,t=i.match(e);if(t&&t[4]&&t[5]){let r=t[1],o=parseInt(t[4],10),a=parseInt(t[5],10),n=t[7];if((r===\"max\"||r===\"full\")&&o&&a&&n)return{type:\"fixed\",id:i,height:a,width:o}}return{type:\"unknown\",id:i}}function Ie(i){if(i[\"@type\"])return i[\"@type\"];if(i.type)return i.type}function Se(i){if(typeof i==\"string\")return O(i);let e=Ie(i);if(e!==\"Image\"&&e!==\"sc:Image\")return null;let t=i,r=l(t);return r?r&&t.width&&t.height?{id:r,type:\"fixed\",width:t.width,height:t.height,unsafe:!0}:O(r):null}function ve(i){return d(i)?(i&&i.sizes?i.sizes:[]).map(e=>({id:l(i),type:\"fixed-service\",height:e.height,width:e.width,level:I(i),version:y(i)?3:2})):[]}function P(i){let e=[],t=i.length;for(let r=0;r<t;r++){let o=i[r];if(!o)continue;let a=ve(o);a.length&&e.push(...a);let n=xe(o);n.length&&e.push(...n)}return e}function b(i){let e=i.service?Array.isArray(i.service)?i.service:[i.service]:[],t=e.length,r=[];for(let o=0;o<t;o++)d(e[o])&&r.push(e[o]);return r}function ye(i,e=!0,t){let r=[],o=Se(i);if(o===null)return r;let a=i;if(r.push(o),e&&a&&a.width&&a.height){let n=[],s=b(a);for(let f of s){let c={id:l(f),width:a.width,height:a.height};if(t.canLoadSync(c)){let m=t.loadServiceSync(c);m&&(m.height||(m.height=a.height),m.width||(m.width=a.width),n.push(...P([m])))}}if(n.length)return r.push(...n),r}return a.service&&r.push(...P(a.service)),r}function Fe({x:i=0,y:e=0,w:t,h:r,full:o,square:a,percent:n}){if(o)return\"full\";if(a)return\"square\";if(typeof t>\"u\"||typeof r>\"u\")throw new Error(\"RegionParameter: invalid region\");let s=`${i},${e},${t},${r}`;return n?`pct:${s}`:s}function we({max:i,percentScale:e,upscaled:t,confined:r,width:o,height:a,serialiseAsFull:n,version:s}){let f=[];return t&&f.push(\"^\"),i?(f.push(n?\"full\":\"max\"),f.join(\"\")):(r&&f.push(\"!\"),e&&f.push(`pct:${e}`),o&&f.push(`${o}`),f.push(\",\"),a&&s===3&&f.push(`${a}`),f.join(\"\"))}function _e(i){return`${i.mirror?\"!\":\"\"}${(i.angle||0)%360}`}function ze(i,e){let t=i.prefix.startsWith(\"/\")?i.prefix.substr(1):i.prefix,r=`${i.scheme}://${i.server}/${t?`${t}/`:\"\"}${i.identifier}`;if(i.type===\"base\")return r;if(i.type===\"info\")return`${r}/info.json`;let{size:o}=i,{region:a,rotation:n,format:s,quality:f}=i;if(e){let c=e[\"@context\"]?Array.isArray(e[\"@context\"])?e[\"@context\"]:[e[\"@context\"]]:[],m=e.profile,h=c.indexOf(\"http://iiif.io/api/image/2/context.json\")!==-1||m===\"level2\",x=c.indexOf(\"http://iiif.io/api/image/3/context.json\")!==-1;if((o.width===e.width&&!o.height||o.height===e.height&&!o.width||o.width===e.width&&o.height===e.height)&&(o={...o,max:!0}),h&&(o.max&&!o.serialiseAsFull&&(o={...o,serialiseAsFull:!0}),!o.max&&o.width&&o.height&&(o={...o,height:void 0}),o={...o,version:2}),x){if(o.max&&o.serialiseAsFull&&(o={...o,serialiseAsFull:!1}),o.width&&!o.height&&e.width&&e.height){let g=e.height/e.width;o={...o,height:Math.ceil(o.width*g)}}o={...o,version:3}}}return[r,Fe(a),we(o),_e(n),`${f}.${s}`].filter(Boolean).join(\"/\")}function E(i,e,t){let r=he({\"@context\":i.version===3?\"http://iiif.io/api/image/3/context.json\":\"http://iiif.io/api/image/2/context.json\",id:u(l(i)),profile:i.level===null||typeof i.level>\"u\"?\"level0\":`level${i.level}`,type:i.version===3?\"ImageService3\":\"ImageService2\"});if(r.type!==\"image\")throw new Error(\"Invalid service\");return r.size.max=!1,r.size.width=e,r.size.height=t,{id:ze(r),type:\"fixed\",width:e,height:t||i.height/(i.width||1)*e,unsafe:i.width>e}}function S(i){let e=i.replace(/(https?:\\/\\/)?(www.)?/i,\"\");return e.indexOf(\"/\")!==-1?e.split(\"/\")[0]:e}function gt(i){if(!i.width||!i.height)return null;if(i.tiles){let e=i.tiles.sort((r,o)=>Math.max(...o.scaleFactors)-Math.max(...r.scaleFactors)),t=e.length;for(let r=0;r<t;r++){let o=e[r];if(!o)continue;let a=o.width;if(!a)continue;let n=o.scaleFactors.length,s=o.scaleFactors.sort();for(let f=0;f<n;f++){let c=s[f];if(c&&i.width/c<=a&&i.height/c<=a)return{id:l(i),type:\"fixed-service\",width:i.width/c|0,height:i.height/c|0,level:I(i),version:y(i)?3:2}}}}return null}function A(i,e){if(!d(i))return[!1,\"Not a valid image service\"];e.extraFeatures=e.extraFeatures?e.extraFeatures:[];let t=z(i);if(e.exactSize){let r=!1;if(i.sizes)for(let o of i.sizes)o.width&&o.width===e.exactSize.width&&(L.indexOf(\"sizeByW\")!==-1||o.height&&o.height===e.exactSize.height)&&(r=!0),o.height&&o.height===e.exactSize.height&&(L.indexOf(\"sizeByH\")!==-1||o.width&&o.width===e.exactSize.width)&&(r=!0);r||(e.maxWidth=Math.max(e.maxWidth||0,e.exactSize.width||0)||void 0,e.maxHeight=Math.max(e.maxHeight||0,e.exactSize.height||0)||void 0,e.maxArea=Math.max(e.maxArea||0,(e.exactSize.width&&e.exactSize.height?e.exactSize.width*e.exactSize.height:e.maxArea)||0)||void 0,!e.exactSize.height&&e.exactSize.width?e.extraFeatures.indexOf(\"sizeByW\")===-1&&e.extraFeatures.push(\"sizeByW\"):!e.exactSize.width&&e.exactSize.height&&e.extraFeatures.indexOf(\"sizeByH\")===-1&&e.extraFeatures.push(\"sizeByH\"))}if(e.maxArea&&t.maxArea&&e.maxArea>t.maxArea)return[!1,`Max area is ${t.maxArea}`];if(e.maxWidth&&t.maxWidth&&e.maxWidth>t.maxWidth)return[!1,`Max width is ${t.maxWidth}`];if(e.maxHeight&&t.maxHeight&&e.maxHeight>t.maxHeight)return[!1,`Max height is ${t.maxHeight}`];if(e.extraFeatures){let r=[];for(let o of e.extraFeatures)t.extraFeatures.indexOf(o)===-1&&r.push(o);if(r.length)return[!1,`Missing features: ${r.join(\", \")}`]}if(e.extraFormats){let r=[];for(let o of e.extraFormats)t.extraFormats.indexOf(o)===-1&&r.push(o);if(r.length)return[!1,`Missing formats: ${r.join(\", \")}`]}if(e.extraQualities){let r=[];for(let o of e.extraQualities)t.extraQualities.indexOf(o)===-1&&r.push(o);if(r.length)return[!1,`Missing qualities: ${r.join(\", \")}`]}return[!0]}function Ft(i,e){return A(i,{extraFormats:[e]})}function zt(i,e){if(e.type!==\"image\")return[!0];let t=[];e.rotation.mirror&&t.push(\"mirroring\"),e.region.percent&&t.push(\"regionByPct\"),e.region.square?t.push(\"regionSquare\"):e.region.full||t.push(\"regionByPx\"),e.rotation.angle&&(e.rotation.angle%90?t.push(\"rotationArbitrary\"):t.push(\"rotationBy90s\")),e.size.confined&&t.push(\"sizeByConfinedWh\"),!e.size.width&&e.size.height&&t.push(\"sizeByH\"),e.size.percentScale&&t.push(\"sizeByPct\"),(i.sizes||[]).find(n=>n.width===e.size.width&&!e.size.height||n.height===e.size.height&&!e.size.width||n.height===e.size.height&&n.width===e.size.width)?t.push(\"sizeByWhListed\"):(e.size.width&&!e.size.height&&t.push(\"sizeByW\"),e.size.width&&e.size.height&&t.push(\"sizeByWh\")),e.size.upscaled&&t.push(\"sizeUpscaling\");let[o,a]=A(i,{extraFeatures:t,extraQualities:[e.quality],extraFormats:[e.format],exactSize:e.size});return o?[!0]:[!1,a]}function be(i,e,t){let r=i.width?i.width:i.maxWidth;return t.height<=i.maxHeight&&t.width<=i.maxWidth&&t.height>=i.minHeight&&t.width>=i.minWidth&&(!e||Math.abs(t.width-r)<Math.abs(e.width-r))}function Ee(i,e){let t=[],r=Object.assign({unsafeImageService:!1,atAnyCost:!0,fallback:!0,minHeight:64,minWidth:64,maxHeight:1/0,maxWidth:1/0,returnAllOptions:!1,preferFixedSize:!1,allowUnsafe:!1,explain:!1,height:0,width:0},i),o=(m,h=0)=>r.explain?t.push(new Array(h).fill(0).map(x=>\"    \").join(\"\")+m().trim()):void 0,a=[],n=[],s=null;o(()=>`Using configuration: ${JSON.stringify(r,null,2)}`);let f=(m,h)=>{if(o(()=>\"Swapping choice\",3),be(r,h,m)){if(r.preferFixedSize&&m.unsafe){o(()=>`We found an image that was marked as unsafe, but it was the best size. (${m.id})`,4),n.push(m);return}r.returnAllOptions&&h&&n.push(h),o(()=>`We found a new image that was the best size. (${m.id})`,4),s=m}else r.returnAllOptions&&n.push(m)};o(()=>`The input shows we have ${e.length} list(s) of candidates to choose from.`);let c=e.length;for(let m=0;m<c;m++){let h=e[m]();o(()=>`Candidate group ${m}: ${JSON.stringify(h,null,2)}`,1);let x=h.length;o(()=>`Checking candidate list number ${m} and found ${x} potential ways of creating image(s)`,1);for(let g=0;g<x;g++){let p=h[g];if(o(()=>`-> Checking candidate ${g}`,1),p.type===\"unknown\"&&r.atAnyCost&&(o(()=>`We've found an unknown image type, adding this to the \"last resort\" list`,2),a.push(p)),p.type===\"fixed\"&&(p.unsafe?(o(()=>`We've found an unsafe fixed image type, adding this to the \"last resort\" list`,2),a.push(p)):(o(()=>\"We've found a fixed size image, checking if it matches the request\",2),f(p,s))),p.type===\"fixed-service\")if(r.unsafeImageService){o(()=>\"Checking for an image from the tile source, without calculating the right height and width (unsafeImageService)\",2);let F=E(p,r.width,r.height);f(F,s)}else{o(()=>\"Checking for an image from the tile source 3\",2);let F=E(p,p.width,p.height);f(F,s)}if(p.type===\"variable\"&&p.maxWidth){let F=E({id:p.id,type:\"fixed-service\",width:p.maxWidth,height:p.maxWidth,level:p.level,version:p.version},p.maxWidth);f(F,s)}}if(s&&!r.returnAllOptions){if(s.unsafe||r.allowUnsafe)continue;o(()=>`We found a match in choice list number ${m}, no searching any more`);break}}return r.atAnyCost&&n.length===0?(o(()=>s?`We found an image! ${s.id} of type ${s.type}`:'We found no images, but \"atAnyCost\" is set, so returning that'),{best:s||a[0]||null,fallback:a.slice(1),log:t}):r.returnAllOptions?(o(()=>\"Returning all options that we have found\"),{best:(r.atAnyCost?s||n[0]||a[0]:s||n[0])||null,fallback:[...n,...a],log:t}):(o(()=>\"Returning the best image that we found, and a fallback\"),{best:s||n[0]||null,fallback:s?n:n.slice(1),log:t})}function Ae(i,e,t){let r=i>e?i:e,o=t.length,a=[];for(let n=0;n<o;n++){let s=t[n];if(!s||s.scaleFactors.length===0)continue;let f=s.scaleFactors[0];if(!f)continue;let c=r/f,m=[f];for(;c>=s.width;)f=f*2,m.push(f),c=c/2;a.push({...s,scaleFactors:m})}return a}function Re(i,e){if(i.length!==e.length)return!1;if(i.length===0&&e.length===0)return!0;let t=i.length,r=!0;for(let a=0;a<t;a++){let n=i[a],s=e[a];if(n.width!==s.width||n.height!==s.height){r=!1;break}}if(r)return!0;let o=0;for(let a=0;a<t;a++)for(let n=0;n<t;n++)if(i[a].width===e[n].width&&i[a].height===e[n].height){o++;break}return o===t}function M(i){return v(0,i)}var W=class{constructor(e={}){w(this,\"config\",{verificationsRequired:1,approximateServices:!1,enableFetching:!0,disableThrottling:!1});w(this,\"fetchingCount\",0);w(this,\"imageServices\",{});w(this,\"knownImageServers\",{});this.config=Object.assign(this.config,e)}setConfig(e){Object.assign(this.config,e)}sample(e,t,r=!0){let o=S(l(e)),a=u(l(e)),n=this.knownImageServers[o];return this.imageServices[a]=Object.assign(e,{real:!0}),!n&&e.tiles&&!M(e)?(this.knownImageServers[o]={verifications:0,malformed:!1,root:o,preLoaded:r,sampledId:l(e),verified:!1,server:null,result:{context:e[\"@context\"]||[],sampledProfile:e.profile,resourceServiceRatio:t&&e.height?t.height/e.height:1,sampledSizes:e.sizes||[],sizeRatios:ge(e.width,e.height,e.sizes||[]),sampledTiles:e.tiles||[]}},!0):this.verify(e)}preLoad(e,t=!0){this.knownImageServers[e.root]=e,t&&(this.knownImageServers[e.root].malformed=!1,this.knownImageServers[e.root].verifications=this.config.verificationsRequired)}predict(e,t=!1,r=!1){let o=e?.source,a=S(l(e)),n=this.knownImageServers[a],s=u(l(e));return this.imageServices[s]?this.imageServices[s]||null:!this.config.approximateServices||!n||!n.result||!(o?.height||e.height)||!(o?.width||e.width)||!r&&(n.malformed||n.verifications<this.config.verificationsRequired)||M(e.source)?null:(this.imageServices[s]||(this.imageServices[s]={\"@context\":n.result.context,\"@id\":l(e),id:l(e),protocol:\"http://iiif.io/api/image\",tiles:o?.tiles||Ae(e.width,e.height,n.result.sampledTiles),sizes:o?.sizes||ue(Math.round(e.width/n.result.resourceServiceRatio),Math.round(e.height/n.result.resourceServiceRatio),n.result.sizeRatios),profile:o?.profile||n.result.sampledProfile,height:o?.height||e.height,width:o?.width||e.width,real:!1}),this.imageServices[s]||null)}async getThumbnailFromResource(e,t,r=!0,o=[]){let a=e?await this.getImageCandidates(e,r):[];return Ee(t,[()=>o,()=>a])}async getImageCandidates(e,t=!0){let r=e;if(t&&r&&r.height&&r.width){let o=b(r);for(let a of o){let n={id:l(a),width:a.width?a.width:r.width,height:a.height?a.height:r.height,source:a};await this.loadService(n)}}return ye(e,t,this)}async verify(e){let t=this.predict(e,!1,!0),r=await this.fetchService(l(e));if(!t)return!1;let o=t.height===r.height&&t.width===r.width&&t[\"@context\"]===r[\"@context\"]&&Re(t.sizes||[],r.sizes||[]);if(o){let a=S(l(e)),n=this.knownImageServers[a];n&&(n.verifications+=1,n.verifications>=this.config.verificationsRequired&&(n.verified=!0))}return o}canLoadSync(e){let t=typeof e==\"string\"?e:l(e),r=u(t);if(this.imageServices[r])return!0;let o=this.knownImageServers[S(t)];return!!(o&&!o.malformed&&o.verifications>=this.config.verificationsRequired)}async markAsMalformed(e){return this.knownImageServers[S(l(e))].malformed=!0,this.loadService(e,!0)}async fetchService(e,t=!1){let r=u(e),o=this.imageServices[r];if(o&&(!t||o.real))return o;if(!this.config.enableFetching)throw new Error(\"Fetching is not enabled\");let a=await this.fetch(r).then(n=>n.json());return!a.id&&a[\"@id\"]&&(a.id=a[\"@id\"]),a.id!==e&&(a.id=e,a[\"@id\"]&&(a[\"@id\"]=e)),this.imageServices[r]=Object.assign(a,{real:!0}),this.imageServices[r]}async fetch(e,t){return fetch(e,t)}async loadService(e,t=!1){if(!this.config.disableThrottling){let a=!0;for(;a;)if(this.fetchingCount>=this.config.verificationsRequired)await new Promise(n=>setTimeout(n,500));else{a=!1;break}}let r=this.knownImageServers[S(l(e))];if(r&&!r.malformed&&!t){await r.result;let a=this.loadServiceSync(e);if(a)return a}this.fetchingCount++;let o=await this.fetchService(l(e),t);return this.fetchingCount--,o.real&&this.sample(o,e),o}loadServiceSync(e){let t=u(l(e));return this.imageServices[t]?this.imageServices[t]:this.config.approximateServices?this.predict(e):null}},Qt=new W;export{je as IIIF_1_IMAGE_LEVEL_0,Ge as IIIF_1_IMAGE_LEVEL_0_COMPLIANCE,Te as IIIF_1_IMAGE_LEVEL_0_PROFILE,U as IIIF_1_IMAGE_LEVEL_1,te as IIIF_1_IMAGE_LEVEL_1_COMPLIANCE,V as IIIF_1_IMAGE_LEVEL_1_PROFILE,Q as IIIF_1_IMAGE_LEVEL_2,re as IIIF_1_IMAGE_LEVEL_2_COMPLIANCE,D as IIIF_1_IMAGE_LEVEL_2_PROFILE,$e as IIIF_2_IMAGE_LEVEL_0,ke as IIIF_2_IMAGE_LEVEL_0_NO_JSON,Be as IIIF_2_IMAGE_LEVEL_0_PROFILE,J as IIIF_2_IMAGE_LEVEL_1,ee as IIIF_2_IMAGE_LEVEL_1_NO_JSON,Z as IIIF_2_IMAGE_LEVEL_1_PROFILE,K as IIIF_2_IMAGE_LEVEL_2,ie as IIIF_2_IMAGE_LEVEL_2_NO_JSON,X as IIIF_2_IMAGE_LEVEL_2_PROFILE,Ne as IIIF_3_IMAGE_LEVEL_0,Y as IIIF_3_IMAGE_LEVEL_1,q as IIIF_3_IMAGE_LEVEL_2,W as ImageServiceLoader,Me as STANFORD_IIIF_1_IMAGE_COMPLIANCE_0,N as STANFORD_IIIF_1_IMAGE_COMPLIANCE_1,k as STANFORD_IIIF_1_IMAGE_COMPLIANCE_2,We as STANFORD_IIIF_1_IMAGE_CONFORMANCE_0,G as STANFORD_IIIF_1_IMAGE_CONFORMANCE_1,H as STANFORD_IIIF_1_IMAGE_CONFORMANCE_2,Oe as STANFORD_IIIF_IMAGE_COMPLIANCE_0,j as STANFORD_IIIF_IMAGE_COMPLIANCE_1,T as STANFORD_IIIF_IMAGE_COMPLIANCE_2,Pe as STANFORD_IIIF_IMAGE_CONFORMANCE_0,$ as STANFORD_IIIF_IMAGE_CONFORMANCE_1,B as STANFORD_IIIF_IMAGE_CONFORMANCE_2,u as canonicalServiceUrl,z as combineProfiles,he as createImageServiceRequest,L as extraFeatures,ge as extractFixedSizeScales,ue as fixedSizesFromScales,xe as getCustomSizeFromService,Se as getFixedSizeFromImage,ve as getFixedSizesFromService,l as getId,ye as getImageCandidates,P as getImageCandidatesFromService,E as getImageFromTileSource,S as getImageServerFromId,b as getImageServices,gt as getSmallestScaleFactorAsSingleImage,Ie as getType,Qt as imageServiceLoader,C as imageServiceProfiles,ze as imageServiceRequestToString,Ft as imageServiceSupportsFormat,zt as imageServiceSupportsRequest,O as inferSizeFromUrl,be as isBestMatch,d as isImageService,oe as level0,Ve as level0Support,ae as level1,_ as level1Support,ne as level2,R as level2Support,se as levelToProfile,ce as parseImageServiceRequest,pe as parseImageServiceUrl,fe as parseRegionParameter,le as parseRotationParameter,me as parseSizeParameter,Ee as pickBestFromCandidates,Fe as regionParameterToString,_e as rotationParameterToString,Ae as sampledTilesToTiles,we as sizeParameterToString,Re as sizesMatch,A as supports,de as supportsCustomSizes};\n","import {\n  InternationalString,\n  ExternalWebResource,\n  IIIFExternalWebResource,\n  ContentResource,\n  ImageProfile,\n  ImageService,\n  Reference,\n  Creator,\n  Agent,\n  W3CAnnotationTarget,\n} from '@iiif/presentation-3';\nimport {\n  ManifestNormalized,\n  CanvasNormalized,\n  AnnotationPageNormalized,\n  AnnotationNormalized,\n} from '@iiif/presentation-3-normalized';\nimport {\n  globalVault, Vault,\n  buildLocaleString,\n  createPaintingAnnotationsHelper,\n  createThumbnailHelper,\n  expandTarget,\n  SupportedTarget,\n} from '@iiif/helpers';\nimport { ImageServiceLoader as ImageServiceLoader_ } from '@atlas-viewer/iiif-image-api';\n\nimport { getOcrReferences } from './ocr.js';\nimport log from './log.js';\nimport { fetchRespectfully } from './download.js';\n\nconst PURPOSE_ORDER = ['commenting', 'describing', 'tagging', 'no-purpose'];\nconst PURPOSE_LABELS: { [purpose: string]: string } = {\n  commenting: 'Comment',\n  describing: 'Description',\n  tagging: 'Tags',\n};\n\nexport const vault = globalVault() as Vault;\n\n/** Given a language preference in descending order,\n * determine the best set of strings from the\n * internationalized string.\n */\nexport function getI18nValue(\n  val: string | InternationalString,\n  languagePreference: readonly string[]\n): string[];\nexport function getI18nValue(\n  val: string | InternationalString,\n  languagePreference: readonly string[],\n  separator: string\n): string;\nexport function getI18nValue(\n  val: string | InternationalString,\n  languagePreference: readonly string[],\n  separator?: string\n): string | string[] {\n  let splitAfter = false;\n  if (!separator) {\n    separator = '<<<SNIP>>>';\n    splitAfter = true;\n  }\n  const localized = buildLocaleString(val, languagePreference[0] ?? 'none', {\n    defaultText: '',\n    fallbackLanguages: languagePreference.slice(1),\n    separator,\n  });\n  if (splitAfter) {\n    return localized.split(separator).filter((s) => s.length > 0);\n  } else {\n    return localized;\n  }\n}\n\n/** Custom image loader to deal with browser + node intercompatibility.\n *\n * Used for the thumbnail helper.\n */\nclass ImageServiceLoader extends ImageServiceLoader_ {\n  async fetch(input: RequestInfo, init?: RequestInit): Promise<Response> {\n    return fetchRespectfully(input as any, init as any) as any;\n  }\n}\n\nconst thumbHelper = createThumbnailHelper(vault, {\n  imageServiceLoader: new ImageServiceLoader(),\n});\n\n// A few helpers to deal with painting annotations\nexport const { getPaintables, getAllPaintingAnnotations, extractChoices } =\n  createPaintingAnnotationsHelper(vault);\n\n/** Determine best thumbnail image for the manifest. */\nexport async function getThumbnail(\n  manifest: ManifestNormalized,\n  maxDimension: number\n): Promise<string | undefined> {\n  const thumb = await thumbHelper.getBestThumbnailAtSize(manifest, {\n    maxWidth: maxDimension,\n    maxHeight: maxDimension,\n  });\n  return thumb.best?.id;\n}\n\n/** Like a regular external web resource, but with an associated\n profile URI, needed for OCR discovery */\nexport interface ExternalWebResourceWithProfile extends ExternalWebResource {\n  profile: string;\n}\n\n/** Check if a resource is an external resource with an\n * associated profile. */\nexport function isExternalWebResourceWithProfile(\n  res: ContentResource\n): res is ExternalWebResourceWithProfile {\n  return (\n    res.type !== undefined &&\n    ['Dataset', 'Image', 'Video', 'Sound', 'Text', 'unknown'].indexOf(\n      res.type\n    ) >= 0 &&\n    (res as ExternalWebResourceWithProfile).profile !== undefined\n  );\n}\n\n/** See https://iiif.io/api/annex/services/#physical-dimensions */\nexport interface PhysicalDimensionService {\n  '@context': 'http://iiif.io/api/annex/services/physdim/1/context.json';\n  profile: 'http://iiif.io/api/annex/services/physdim';\n  '@id': string;\n  physicalScale: number;\n  physicalUnits: 'in' | 'cm' | 'mm';\n}\n\n/** Check if a service is a IIIF Physical Dimensions service */\nexport function isPhysicalDimensionService(\n  service: any // eslint-disable-line @typescript-eslint/explicit-module-boundary-types\n): service is PhysicalDimensionService {\n  return (\n    typeof service.profile === 'string' &&\n    service.profile === 'http://iiif.io/api/annex/services/physdim'\n  );\n}\n\n/** Check if a IIIF Image endpoint supports arbitrary downscaling. */\nexport function supportsScaling(profile: ImageProfile): boolean {\n  if (typeof profile === 'string') {\n    return profile.indexOf('level2') >= 0;\n  } else {\n    return (profile.supports?.indexOf('sizeByWh') ?? -1) >= 0;\n  }\n}\n\nexport type ImageInfo = {\n  // The 'Image' content resource\n  resource: (ExternalWebResource | IIIFExternalWebResource) & { type: 'Image' };\n  // Where to draw on the corresponding canvas\n  x: number;\n  y: number;\n  // At what size to draw on the canvas?\n  width: number;\n  height: number;\n  // What is the image's size, if available?\n  nativeWidth?: number;\n  nativeHeight?: number;\n  ppi?: number;\n  format?: 'jpeg' | 'png' | 'unsupported';\n  choiceInfo?: {\n    enabled: boolean;\n    optional: boolean;\n    visibleByDefault: boolean;\n    label?: InternationalString;\n  };\n};\n\n/** Information about a canvas that can be obtained without\n *  fetching any external resources */\nexport type CanvasInfo = {\n  canvas: Reference<'Canvas'>;\n  ocr?: {\n    id: string;\n  };\n  images: ImageInfo[];\n  numAnnotations: number;\n};\n\n/** Extract all non-painting annotations that are of interest for PDF generation\n * from a canvas */\nexport function getCanvasAnnotations(canvas: CanvasNormalized): Annotation[] {\n  return vault\n    .get<AnnotationPageNormalized>(canvas.annotations)\n    .flatMap((p) => vault.get<AnnotationNormalized>(p.items))\n    .filter((a) =>\n      Array.isArray(a.motivation)\n        ? a.motivation.find((m) => PURPOSE_LABELS[m] !== undefined) !==\n          undefined\n        : PURPOSE_LABELS[a.motivation ?? 'invalid'] !== undefined\n    )\n    .map((a) => parseAnnotation(a, []))\n    .filter((a): a is Annotation => a !== undefined);\n}\n\n/** Obtain all information about a canvas and its images\n * without hitting any external endpoints.\n */\nexport function getCanvasInfo(canvas: CanvasNormalized): CanvasInfo {\n  const imageInfos = getImageInfos(canvas);\n  const text = getOcrReferences(canvas);\n  return {\n    canvas: { id: canvas.id, type: 'Canvas' },\n    images: imageInfos,\n    // eslint-disable-next-line @typescript-eslint/no-non-null-assertion\n    ocr: text ? { id: text.id! } : undefined,\n    numAnnotations: getCanvasAnnotations(canvas).length,\n  };\n}\n\n/** A annotation prepared for rendering to PDF. */\nexport interface Annotation {\n  id: string;\n  target: SupportedTarget;\n  markup: string;\n  lastModified?: Date;\n  author?: string;\n}\n\n/** Format an annotation agent to a human readable string. */\nfunction agentToString(agent: Agent): string {\n  let name = Array.isArray(agent.name) ? agent.name.join('; ') : agent.name;\n  if (!name) {\n    name = agent.nickname ?? 'unknown';\n  }\n  if (agent.email) {\n    return `${name} <${agent.email}>`;\n  }\n  return name;\n}\n\n/** Format a annotation creator definition to a human readable\n * string. */\nfunction creatorToString(creator: Creator): string {\n  if (Array.isArray(creator)) {\n    if (typeof creator[0] === 'string') {\n      return creator.join('; ');\n    } else {\n      return creator.map((a) => agentToString(a as Agent)).join('; ');\n    }\n  }\n  if (typeof creator === 'string') {\n    return creator;\n  }\n  return agentToString(creator);\n}\n\n/** Parse a IIIF annotation into a format that is more\n *  suitable for rendering to a PDF. */\nexport function parseAnnotation(\n  anno: AnnotationNormalized,\n  langPrefs: readonly string[]\n): Annotation | undefined {\n  if (!anno.target) {\n    return;\n  }\n  // TODO: i18n?\n  const annoBody = anno.body.map((bodyRef) =>\n    vault.get<ContentResource>(bodyRef.id)\n  );\n  const creatorNames: Array<string> = annoBody\n    .map((body) => body.creator)\n    .filter((v: Creator | undefined): v is Creator => v !== undefined)\n    .map(creatorToString);\n  const modifiedDates: Array<number> = annoBody\n    .map((body) => body.modified)\n    .filter((v: string | undefined): v is string => v !== undefined)\n    .map((v: string) => new Date(v).getTime());\n  if (typeof anno.target === 'string') {\n    return;\n  }\n  const targets = vault.get<Exclude<W3CAnnotationTarget, string>>(anno.target.map(t => t.id));\n  const target = expandTarget(targets);\n  const markup = buildAnnotationMarkup(annoBody);\n  if (!markup) {\n    // TODO: Log?\n    throw `No valid textual content in annotation.`;\n  }\n  return {\n    id: anno.id,\n    target,\n    markup,\n    lastModified:\n      modifiedDates.length > 0\n        ? new Date(Math.max(...modifiedDates))\n        : undefined,\n    author: creatorNames.length > 0 ? creatorNames.join('; ') : undefined,\n  };\n}\n\n/** Convert Annotation HTML to PDF Markup */\nfunction buildAnnotationMarkup(\n  bodies: Array<ContentResource>\n): string | undefined {\n  const parts: { [purpose: string]: Array<string> } = {};\n  for (const body of bodies) {\n    if (\n      body.type !== 'TextualBody' ||\n      (body.format !== 'text/plain' && body.format !== 'text/html') ||\n      body.value === undefined\n    ) {\n      continue;\n    }\n    let { purpose } = body;\n    if (Array.isArray(purpose)) {\n      purpose = purpose[0];\n    } else if (!purpose) {\n      purpose = 'no-purpose';\n    }\n    if (!parts[purpose]) {\n      parts[purpose] = [];\n    }\n    parts[purpose].push(body.value);\n  }\n  if (Object.keys(parts).length === 0) {\n    return undefined;\n  }\n  const out: Array<string> = [];\n  for (const purpose of PURPOSE_ORDER) {\n    const purposeLabel = PURPOSE_LABELS[purpose];\n    if (!parts[purpose]) {\n      continue;\n    }\n    if (parts[purpose].length > 1) {\n      if (purposeLabel) {\n        out.push(`<p><b>${purposeLabel}:</b></p>`);\n      }\n      for (const part of parts[purpose]) {\n        // TODO: Convert HTML to PDF rich text\n        out.push(`<p>${part}</p>`);\n      }\n    } else {\n      out.push('<p>');\n      if (purposeLabel) {\n        out.push(`<b>${purposeLabel}:</b> `);\n      }\n      out.push(`${parts[purpose][0]}</p>`);\n    }\n  }\n  if (out.length === 0) {\n    return undefined;\n  }\n  return out.join('\\n');\n}\n\nexport interface CompatibilityReport {\n  compatibility: 'compatible' | 'incompatible' | 'degraded';\n  incompatibleElements: {\n    [canvasId: string]: Set<\n      | 'no-jpeg' // At least one image doesn't have a JPEG representation\n      | 'no-image' // Canvas does not have a single image annotation\n      | 'annotations' // Canvas has non-painting annotations\n      | 'unsupported-painting'\n    >;\n  };\n}\n\nexport function checkCompatibility(\n  manifest: ManifestNormalized\n): CompatibilityReport | undefined {\n  const report = {\n    compatibility: 'compatible',\n    incompatibleElements: {},\n  };\n  for (const canvas of vault.get<CanvasNormalized>(manifest.items)) {\n    const paintingResources = vault\n      .get<AnnotationPageNormalized>(canvas.items)\n      .flatMap((ap) => vault.get<AnnotationNormalized>(ap.items))\n      .flatMap((a) => vault.get<ContentResource>(a.body.map(b => b.id)));\n    const nonPaintingAnnos = manifest.annotations;\n    // TODO: Check if canvas has an image\n    // TODO: Check if every painting annotation is an image with a JPEG available\n    // TODO: Check for the presence of non-painting annotations\n  }\n  return undefined;\n}\n\n/** Parse a IIIF target specification */\nexport function parseTarget(targetStr: string): {\n  x: number;\n  y: number;\n  width: number;\n  height: number;\n} {\n  const [canvasId, fragment] = targetStr.split('#xywh=');\n  if (fragment) {\n    const [x, y, width, height] = fragment\n      .split(',')\n      .map((x) => parseInt(x, 10));\n    return { x, y, width, height };\n  } else {\n    const canvas = vault.get<CanvasNormalized>(canvasId);\n    // Draw to fit canvas\n    return { x: 0, y: 0, width: canvas.width, height: canvas.height };\n  }\n}\n\nexport function getImageFormat(\n  image: ExternalWebResource | IIIFExternalWebResource\n): 'jpeg' | 'png' | 'unsupported' | undefined {\n  if (image.format === 'image/jpeg') {\n    return 'jpeg';\n  } else if (image.format === 'image/png') {\n    return 'png';\n  } else if (image.format === undefined) {\n    if (image.id?.endsWith('.jpg') || image.id?.endsWith('.jpeg')) {\n      return 'jpeg';\n    } else if (image.id?.endsWith('.png')) {\n      return 'png';\n    }\n  } else {\n    return 'unsupported';\n  }\n}\n\n/** Get information about images on a Canvas. */\nexport function getImageInfos(canvas: CanvasNormalized): ImageInfo[] {\n  const imageInfos: ImageInfo[] = [];\n  const paintingAnnos = vault.get<AnnotationPageNormalized>(canvas.items)\n    .flatMap((ap) => vault.get<AnnotationNormalized>(ap.items));\n  for (const anno of paintingAnnos) {\n    const annoTarget = anno.target as any;\n    let target;\n    if (typeof annoTarget === 'string') {\n      target = parseTarget(annoTarget);\n    } else if (annoTarget.type === 'SpecificResource') {\n      target = parseTarget(annoTarget.source.id);\n    } else {\n      console.error(`Unsupported target type for annotation on canvas ${canvas.id}: '${annoTarget.type}'`);\n      continue;\n    }\n\n\n    const body = vault.get<ContentResource>(anno.body.map(b => b.id));\n    for (const resource of body) {\n      if (resource.type !== 'Image') {\n        continue;\n      }\n      imageInfos.push({\n        resource: resource as (\n          | ExternalWebResource\n          | IIIFExternalWebResource\n        ) & { type: 'Image' },\n        ...target,\n        format: getImageFormat(resource),\n        nativeWidth: (resource as any).width as number | undefined,\n        nativeHeight: (resource as any).height as number | undefined,\n      });\n    }\n  }\n\n  const choice = extractChoices(paintingAnnos);\n  if (choice?.type !== 'single-choice') {\n    // Return early if there are no choices available\n    return imageInfos;\n  }\n\n  for (const choiceItem of choice.items) {\n    const resource = vault.get<ContentResource>(choiceItem.id);\n    if (resource.type !== 'Image') {\n      continue;\n    }\n    imageInfos.push({\n      resource: resource as (ExternalWebResource | IIIFExternalWebResource) & {\n        type: 'Image';\n      },\n      // FIXME: Can't choice images have a location and rendering dimensions?\n      x: 0,\n      y: 0,\n      width: canvas.width,\n      height: canvas.height,\n      nativeWidth: (resource as any).width as number | undefined,\n      nativeHeight: (resource as any).height as number | undefined,\n      format: getImageFormat(resource),\n      choiceInfo: {\n        enabled: choiceItem.selected ?? false,\n        optional: true,\n        label: (resource as any).label,\n        visibleByDefault: choiceItem.selected ?? false,\n      },\n    });\n  }\n\n  return imageInfos;\n}\n","/* eslint-disable @typescript-eslint/no-non-null-assertion */\n/* eslint-disable complexity */\n/// Utilities for parsing OCR text from hOCR, ALTO and IIIF Annotations\nimport {\n  Annotation,\n  ContentResource,\n} from '@iiif/presentation-3';\nimport {\n  AnnotationNormalized,\n  CanvasNormalized,\n} from '@iiif/presentation-3-normalized';\nimport {\n  parseAltoPages,\n  parseHocrPages,\n  type OcrPage,\n  type OcrLine,\n  Dimensions,\n} from 'ocr-parser';\n\nimport metrics from './metrics.js';\nimport { fetchRespectfully, rateLimitRegistry } from './download.js';\nimport {\n  isExternalWebResourceWithProfile,\n  ExternalWebResourceWithProfile,\n  vault,\n} from './iiif.js';\n\nexport type OcrPageWithMarkup = OcrPage & {\n  id: string;\n  markup: string;\n  mimeType: string;\n};\n\n/** Helper to calculate a rough fallback image size from the line coordinates\n *\n * @param {array} lines the parsed OCR lines\n * @returns {object} the page size estimated from the line coordinates\n */\nfunction getFallbackImageSize(lines: OcrLine[]): Dimensions {\n  return {\n    width: Math.max(...lines.map(({ x, width }) => x + (width ?? 0))) ?? 0,\n    height: Math.max(...lines.map(({ y, height }) => y + height)) ?? 0,\n  };\n}\n\n/**\n * Parse an OCR document (currently hOCR or ALTO)\n *\n * @param {string} ocrText  ALTO or hOCR markup\n * @param {object} referenceSize Reference size to scale coordinates to\n * @returns {OcrPage} the parsed OCR page\n */\nexport async function parseOcr(\n  id: string,\n  ocrText: string,\n  referenceSize: Dimensions\n): Promise<OcrPageWithMarkup | null> {\n  let pageIter: AsyncGenerator<OcrPage>;\n  const isAlto = ocrText.indexOf('<alto') >= 0;\n  if (isAlto) {\n    pageIter = parseAltoPages(ocrText, [referenceSize]);\n  } else {\n    pageIter = parseHocrPages(ocrText, [referenceSize]);\n  }\n  const page = (await pageIter.next()).value as OcrPage | undefined;\n  if (!page) {\n    return null;\n  }\n  return {\n    ...page,\n    id,\n    markup: ocrText,\n    mimeType: isAlto ? 'application/xml+alto' : 'text/vnd.hocr+html',\n  };\n}\n\n/** Parse OCR data from IIIF annotations.\n *\n * Annotations should be pre-filtered so that they all refer to a single canvas/page.\n * Annotations should only contain a single text granularity, that is either line or word.\n *\n * @param {object} annos IIIF annotations with a plaintext body and line or word granularity\n * @param {Dimensions} imgSize Reference width and height of the rendered target image\n * @returns {OcrPage} parsed OCR boxes\n */\nexport function parseIiifAnnotations(\n  annos: Array<Annotation>,\n  imgSize: Dimensions\n): OcrPage {\n  throw 'Currently not supported';\n}\n\n/** Checks if a given resource points to an ALTO OCR document */\nconst isAlto = (resource: ExternalWebResourceWithProfile) =>\n  resource.format === 'application/xml+alto' ||\n  resource.profile?.startsWith('http://www.loc.gov/standards/alto/');\n\n/** Checks if a given resource points to an hOCR document */\nconst isHocr = (resource: ExternalWebResourceWithProfile) =>\n  resource.format === 'text/vnd.hocr+html' ||\n  resource.profile ===\n    'https://github.com/kba/hocr-spec/blob/master/hocr-spec.md' ||\n  resource.profile?.startsWith('http://kba.cloud/hocr-spec/') ||\n  resource.profile?.startsWith('http://kba.github.io/hocr-spec/');\n\n/** Wrapper around fetch() that returns the content as text */\nasync function fetchOcrMarkup(url: string): Promise<string | undefined> {\n  const resp = await fetchRespectfully(url);\n  if (resp.status === 404) {\n    return undefined;\n  }\n  if (resp.status != 200) {\n    throw new Error(\n      `Could not fetch OCR markup from ${url}, got status code ${resp.status}`\n    );\n  }\n  return resp.text();\n}\n\n/** Fetch external annotation resource JSON */\nexport async function fetchAnnotationResource(url: string): Promise<any> {\n  const resp = await fetchRespectfully(url);\n  return resp.json();\n}\n\n/** Retrieve a supported OCR references from a Canvas' `seeAlso` or `rendering`, if present.\n *\n * 'Supported' currently means external ALTO or hOCR markup.\n */\nexport function getOcrReferences(\n  canvas: CanvasNormalized\n): ExternalWebResourceWithProfile | undefined {\n  const refs = vault.get<ContentResource>(canvas.seeAlso.map((r) => r.id));\n  refs.push(...vault.get<ContentResource>(canvas.rendering.map((r) => r.id)));\n  return refs\n    .filter(isExternalWebResourceWithProfile)\n    .find((r) => isAlto(r) || isHocr(r));\n}\n\nexport async function fetchAndParseText(\n  canvas: CanvasNormalized,\n  annotations?: AnnotationNormalized[]\n): Promise<OcrPageWithMarkup | undefined> {\n  // TODO: Annotations are a major PITA due to all the indirection and multiple\n  //       levels of fetching of external resources that might be neccessary,\n  //       save for later once text rendering is properly done.\n  const ocrRefs = getOcrReferences(canvas);\n  if (ocrRefs) {\n    const stopMeasuring = metrics?.ocrFetchDuration.startTimer({\n      ocr_host: new URL(ocrRefs.id!).host,\n    });\n    let markup;\n    try {\n      markup = await fetchOcrMarkup(ocrRefs.id!);\n      stopMeasuring?.({\n        status: 'success',\n        limited: rateLimitRegistry.isLimited(ocrRefs.id!).toString(),\n      });\n      if (!markup) {\n        return undefined;\n      }\n    } catch (err) {\n      stopMeasuring?.({\n        status: 'error',\n        limited: rateLimitRegistry.isLimited(ocrRefs.id!).toString(),\n      });\n      throw err;\n    }\n    return (\n      (await parseOcr(ocrRefs.id!, markup, {\n        width: canvas.width,\n        height: canvas.height,\n      })) ?? undefined\n    );\n  }\n}\n","/* eslint-disable @typescript-eslint/no-non-null-assertion */\nimport { Mutex } from 'async-mutex';\nimport {\n  ExternalWebResource,\n  FragmentSelector,\n  IIIFExternalWebResource,\n  ImageService,\n  ImageService3,\n  Reference,\n  Selector,\n  Service,\n} from '@iiif/presentation-3';\nimport {\n  CanvasNormalized,\n  ManifestNormalized,\n  RangeNormalized,\n} from '@iiif/presentation-3-normalized'\n\nimport { OcrPageWithMarkup, fetchAndParseText } from './ocr.js';\nimport metrics from './metrics.js';\nimport log from './log.js';\nimport {\n  vault,\n  isPhysicalDimensionService,\n  PhysicalDimensionService,\n  supportsScaling,\n  getCanvasAnnotations,\n  Annotation,\n  ImageInfo,\n} from './iiif.js';\nimport { isDefined } from './util.js';\n\n/// In absence of more detailed information (from physical dimensions service), use this resolution\nconst FALLBACK_PPI = 300;\n\n// HTTP Accept header to make sure we get IIIFv3, if available, via content negotiation\n// Thanks to @jcoyne:\n// https://github.com/ProjectMirador/mirador/pull/3770/files#diff-166256fe28a89c78ada7b08488a3233671fc0511fd39d323c5cfc9433026e2a1R108-R112\nconst MANIFEST_ACCEPT_HEADER = 'application/ld+json;q=0.9;profile=\"http://iiif.io/api/presentation/3/context.json\", '\n  + 'application/ld+json;q=0.7;profile=\"http://iiif.io/api/presentation/2/context.json\", '\n  + 'application/ld+json;q=0.5, '\n  + 'application/json;q=0.2';\n\n/** Maps rate-limited hosts to a mutex that limits the concurrent fetching. */\nclass RateLimitingRegistry {\n  private hostMutexes = new Map<string, Mutex>();\n  private callbacks: Array<(host: string, limited: boolean) => void> = [];\n\n  getMutex(host: string): Mutex | undefined {\n    return this.hostMutexes.get(host);\n  }\n\n  limitHost(host: string): Mutex {\n    const mutex = new Mutex();\n    this.hostMutexes.set(host, mutex);\n    this.callbacks.forEach((cb) => cb(host, true));\n    return mutex;\n  }\n\n  unlimitHost(host: string): void {\n    this.hostMutexes.delete(host);\n    this.callbacks.forEach((cb) => cb(host, false));\n  }\n\n  subscribe(cb: (host: string, limited: boolean) => void): number {\n    this.callbacks.push(cb);\n    return this.callbacks.length - 1;\n  }\n\n  unsubscribe(ticket: number) {\n    this.callbacks.splice(ticket, 1);\n  }\n\n  isLimited(url: string): boolean {\n    return this.hostMutexes.has(new URL(url).host);\n  }\n}\n\nexport const rateLimitRegistry = new RateLimitingRegistry();\n\n/** Tracks for which domains we need and safely can include credentials for */\nconst includedCredentialsHosts = new Set<string>();\n\n/** Check if requests to the given host should include credentials */\nexport function requestsShouldIncludeCredentials(host: string): boolean {\n  return includedCredentialsHosts.has(host);\n}\n\n/** A 'respectful' wrapper around `fetch` that tries to respect rate-limiting headers.\n *\n * Will also retry with exponential backoff in case of server errors.\n */\nexport async function fetchRespectfully(\n  url: string,\n  init: RequestInit = {},\n  maxRetries = 3\n): Promise<Response> {\n  const { host } = new URL(url);\n  // If the host associated with the URL is rate-limited, limit concurrency to a single\n  // fetch at a time by acquiring the mutex for the host.\n  let rateLimitMutex = rateLimitRegistry.getMutex(host);\n  let numRetries = -1;\n  let resp: Response | undefined;\n  let waitMs = 5000;\n  let fetchOptions = { ...init };\n  if (includedCredentialsHosts.has(host)) {\n    fetchOptions.credentials = 'include';\n  }\n  // If we're fetching from a rate-limited host, wait until there's no other fetch for it\n  // going on\n  const release = await rateLimitMutex?.acquire();\n  try {\n    do {\n      resp = await fetch(url, fetchOptions);\n      if (resp.ok) {\n        if (fetchOptions.credentials === 'include') {\n          // If we successfully fetched with credentials, remember that for next request to that host\n          includedCredentialsHosts.add(host);\n        }\n        break;\n      }\n\n      if ((resp.status == 401 || resp.status == 403) && fetchOptions.credentials !== 'include') {\n        // Retry with included credentials and don't increment counter\n        fetchOptions.credentials = 'include';\n        continue;\n      }\n\n\n      numRetries++;\n\n      const retryAfter = resp?.headers.get('retry-after');\n      if (isDefined(retryAfter)) {\n        if (Number.isInteger(retryAfter)) {\n          waitMs = Number.parseInt(retryAfter, 10) * 1000;\n        } else {\n          const waitUntil = Date.parse(retryAfter);\n          waitMs = waitUntil - Date.now();\n        }\n      } else {\n        // Exponential backoff with a random multiplier on the base wait time\n        waitMs = Math.pow(Math.random() * 2 * waitMs, numRetries);\n      }\n\n      // Check if the server response has headers corresponding to the IETF `RateLimit Header Fiels for HTTP` spec draft[1]\n      // [1] https://www.ietf.org/archive/id/draft-polli-ratelimit-headers-05.html\n      const getHeaderValue = (ietfHeader: string): number | undefined => {\n        const headerVariants = [\n          ietfHeader,\n          `x-${ietfHeader}`,\n          `x-${ietfHeader.replace('ratelimit', 'rate-limit')}`,\n        ];\n        return headerVariants\n          .map((header) => resp?.headers.get(header))\n          .filter(isDefined<string>)\n          .map((limit) => Number.parseInt(limit, 10))\n          .find((limit) => limit != null);\n      };\n      const limit = getHeaderValue('ratelimit-limit');\n      const remaining = getHeaderValue('ratelimit-remaining');\n      const reset = getHeaderValue('ratelimit-reset');\n      if (\n        limit !== undefined &&\n        remaining !== undefined &&\n        reset !== undefined\n      ) {\n        // At this point we're pretty sure that we're being rate-limited, so let's\n        // limit concurrency from here on out.\n        rateLimitMutex = rateLimitRegistry.limitHost(host);\n\n        // We assume a sliding window implemention here\n        const secsPerQuotaUnit = reset / (limit - remaining);\n        if (remaining > 0) {\n          // If we have remaining quota units but were blocked, we wait until we have enough\n          // quota to fetch remaining*2 quota units (i.e. we assume that the units in `remaining`\n          // were not enough to fully fetch the resource)\n          waitMs = 2 * remaining * secsPerQuotaUnit * 1000;\n        } else {\n          waitMs = secsPerQuotaUnit * 1000;\n        }\n      }\n\n      // Add a 100ms buffer just to be safe and wait until the next attempt\n      await new Promise((resolve) => setTimeout(resolve, waitMs + 100));\n    } while (numRetries < maxRetries);\n  } finally {\n    if (rateLimitMutex) {\n      // We're being rate-limited, so wait some more so the next request doesn't\n      // encounter a server error on fetching\n      await new Promise((resolve) => setTimeout(resolve, waitMs + 100));\n    }\n    release?.();\n  }\n  return resp;\n}\n\n/** Container for image size along with its corresponding IIIF Image API string. */\nexport type SizeInfo = {\n  iiifSize: string;\n  width: number;\n  height: number;\n};\n\n/** Calculate the image size to fetch, based on user constraints and available sizes\n *  in the Image API info.json response.\n */\nexport function getImageSize(\n  imgService: ImageService,\n  scaleFactor = 1\n): SizeInfo {\n  let sizeStr: string;\n  const isIIIFv3 = (imgService as ImageService3).id !== undefined;\n  const maxWidth = imgService.maxWidth ?? imgService.width!;\n  let requestedWidth = Math.floor(scaleFactor * maxWidth);\n  const aspectRatio = imgService.width! / imgService.height!;\n  const supportsScaleByWh = Array.isArray(imgService.profile)\n    ? imgService.profile.find(supportsScaling) !== undefined\n    : supportsScaling(imgService.profile);\n  if (scaleFactor < 1 && !supportsScaleByWh) {\n    if (imgService.sizes) {\n      // AR-compliant downscaling is not supported, find the closest available size\n      requestedWidth = Math.min(...imgService.sizes.map((dims) => Math.abs(requestedWidth - dims.width)));\n      sizeStr = `${requestedWidth},`;\n    } else {\n      // No sizes available, so we can't downscale.\n      sizeStr = `${maxWidth},`;\n    }\n  } else if (scaleFactor == 1) {\n    sizeStr =\n      isIIIFv3 || imgService.maxWidth || imgService.maxArea ? 'max' : 'full';\n    if (imgService.maxWidth) {\n      requestedWidth = imgService.maxWidth;\n    } else if (imgService.maxHeight) {\n      requestedWidth = Math.round(aspectRatio * imgService.maxHeight);\n    } else if (imgService.maxArea) {\n      const fullArea = imgService.width! * imgService.height!;\n      const scaleFactor = imgService.maxArea / fullArea;\n      requestedWidth = Math.round(scaleFactor * imgService.width!);\n    } else {\n      requestedWidth = imgService.width!;\n    }\n  } else {\n    sizeStr = `${requestedWidth},`;\n  }\n  return {\n    iiifSize: sizeStr,\n    width: requestedWidth as number,\n    height: (requestedWidth as number) / aspectRatio,\n  };\n}\n\n/** Use a IIIF Physical Dimensions service to obtain the PPI for a canvas. */\nexport function getPointsPerInch(services: Service[]): number | null {\n  const physDimService = services.find(isPhysicalDimensionService) as\n    | PhysicalDimensionService\n    | undefined;\n  if (!physDimService) {\n    return null;\n  }\n  const { physicalScale, physicalUnits } = physDimService;\n  let ppi;\n  if (physicalUnits === 'in') {\n    ppi = 1 / physicalScale;\n  } else if (physicalUnits === 'mm') {\n    ppi = 25.4 / physicalScale;\n  } else if (physicalUnits === 'cm') {\n    ppi = 2.54 / physicalScale;\n  } else {\n    ppi = FALLBACK_PPI;\n  }\n  return ppi;\n}\n\nexport function isImageFetchFailure(obj: CanvasImageData | ImageFetchFailure): obj is ImageFetchFailure {\n  return (obj as ImageFetchFailure).cause !== undefined;\n}\n\n/** All the data relevant for the canvas: images and text */\nexport type CanvasData = {\n  canvas: Reference<'Canvas'>;\n  text?: OcrPageWithMarkup;\n  images: CanvasImage[];\n  annotations: Annotation[];\n  ppi?: number;\n  imageFailures: ImageFetchFailure[];\n};\n\nexport type ImageFetchFailure = ImageInfo & {\n  cause: Error | string;\n}\n\n\n/** Data and additional information for an image on a canvas. */\nexport type CanvasImage = ImageInfo & CanvasImageData;\n\n/** Data and additional info for a canvas image, based on retrieval\n *  of external resources.\n */\nexport type CanvasImageData = {\n  data?: ArrayBuffer;\n  numBytes: number;\n  format: 'jpeg' | 'png';\n  corsAvailable: boolean;\n  ppi?: number;\n  nativeWidth?: number;\n  nativeHeight?: number;\n  downscaled?: boolean;\n};\n\n/** Options for fetching image */\nexport type FetchImageOptions = {\n  /// Factor to downscale the image by, number between 0.1 and 1\n  scaleFactor?: number;\n  /// PPI override, will be fetched from physical dimensions serivce by default\n  ppiOverride?: number;\n  // Optional signal to use for aborting the image fetching\n  abortSignal?: AbortSignal;\n  /// Only obtain the size of the image, don't fetch any data\n  sizeOnly?: boolean;\n};\n\n/** Download (or only determine size in bytes of) a canvas image. */\nasync function fetchCanvasImage(\n  image: IIIFExternalWebResource | ExternalWebResource,\n  { scaleFactor, abortSignal, sizeOnly = false }: FetchImageOptions\n): Promise<CanvasImageData | null> {\n  // NOTE: Here be dragons, who'd have thought downloading an image\n  //       could be so complicated?\n  if (abortSignal?.aborted) {\n    log.debug(\n      'Abort signalled, aborting before initiating image data fetching.'\n    );\n    throw new Error('Aborted due to client request', { cause: { type: 'abort' } });\n  }\n  if (image.type !== 'Image') {\n    throw new Error(`Can only fetch image resources, got ${image.type}`);\n  }\n  let imgService: ImageService | undefined;\n  if ('service' in image) {\n    imgService = image.service?.find(\n      (s: Service): s is ImageService =>\n        ((s as ImageService | undefined)?.type?.startsWith('ImageService') ??\n          false) ||\n        ((s as any)?.['@type']?.startsWith('ImageService') ?? false)\n    );\n  }\n  let ppi: number | undefined;\n  let imageUrl: string;\n  let downscaled = false;\n  if (imgService) {\n    if (!imgService.width) {\n      imgService = await fetchFullImageService(imgService);\n    }\n    const sizeInfo = getImageSize(imgService, scaleFactor);\n    imageUrl = `${imgService.id ?? imgService['@id']}/full/${sizeInfo.iiifSize\n      }/0/default.jpg`;\n    ppi = getPointsPerInch(imgService.service ?? []) ?? undefined;\n    if (ppi) {\n      ppi = ppi * (sizeInfo.width / imgService.width!);\n    }\n    if (sizeInfo.width < imgService.width!) {\n      downscaled = true;\n    }\n  } else if (image.id && ['image/jpeg', 'image/png'].indexOf(image.format ?? 'unknown') >= 0) {\n    imageUrl = image.id;\n  } else {\n    log.error(\n      `No JPEG or PNG image identifier for resource ${image.id} could be found!`\n    );\n    return null;\n  }\n\n  let data: ArrayBuffer | undefined;\n  let numBytes: number;\n  let corsAvailable = true;\n  let format: 'jpeg' | 'png' | null = null;\n  const stopMeasuring = metrics?.imageFetchDuration.startTimer({\n    iiif_host: new URL(imageUrl).host,\n  });\n  try {\n    const imgResp = await fetchRespectfully(imageUrl, {\n      method: 'GET',\n      signal: abortSignal,\n    });\n    if (imgResp.status >= 400) {\n      throw new Error(\n        `Failed to fetch page image from ${imageUrl}, server returned status ${imgResp.status}`,\n        { cause: { type: 'http-status', status: imgResp.status } }\n      );\n    }\n    if (abortSignal?.aborted) {\n      throw new Error('Aborted due to client request', { cause: { type: 'abort' } });\n    }\n    numBytes = Number.parseInt(imgResp.headers.get('Content-Length') ?? '-1');\n    data = sizeOnly && numBytes >= 0 ? undefined : await imgResp.arrayBuffer();\n    if (imgResp.headers.get('Content-Type')?.startsWith('image/jpeg')) {\n      format = 'jpeg';\n    } else if (imgResp.headers.get('Content-Type')?.startsWith('image/png')) {\n      format = 'png';\n    } else {\n      throw new Error('Unsupported image content type', { cause: { type: 'content-type' } });\n    }\n    if (numBytes < 0) {\n      numBytes = data?.byteLength ?? -1;\n    }\n    stopMeasuring?.({\n      status: 'success',\n      limited: rateLimitRegistry.isLimited(imageUrl).toString(),\n    });\n  } catch (err) {\n    // In browsers, we can't differentiate between a 'normal' network error\n    // (like an unavailable server) and a CORS error just from the response\n    // alone, so we we use a small hack involving the DOM\n    const isCorsError = typeof document !== 'undefined' && await isImageUnavailableDueToCors(imageUrl);\n    // No CORS error or CORS error, but need data? Can't continue\n    if (!isCorsError) {\n      log.error(`Failed to fetch image data from ${imageUrl}: ${err}`);\n      stopMeasuring?.({\n        status: 'error',\n        limited: rateLimitRegistry.isLimited(imageUrl).toString(),\n        cause: err instanceof Error ? (err.cause as any).type : err\n      });\n      throw err;\n    } else if (!sizeOnly) {\n      throw new Error('Data requested, but no CORS for the image endpoint', { cause: { type: 'no-cors' } });\n    }\n    corsAvailable = false;\n    log.warn(\n      `Failed to fetch image data from ${imageUrl}: CORS headers missing!`\n    );\n    // We can get the size without CORS\n    const imgResp = await fetchRespectfully(imageUrl, {\n      method: 'GET',\n      signal: abortSignal,\n      mode: 'no-cors',\n    });\n    numBytes = Number.parseInt(imgResp.headers.get('Content-Length') ?? '-1');\n  }\n\n  return {\n    data,\n    ppi,\n    numBytes,\n    corsAvailable,\n    format: format!,\n    downscaled,\n  };\n}\n\n/** Check if an image is unavailable due to missing CORS headers. */\nasync function isImageUnavailableDueToCors(imageUrl: string): Promise<boolean> {\n  const imgElem = document.createElement('img');\n  imgElem.src = imageUrl;\n  return new Promise((resolve) => {\n    // Image loads fine for element => Unavailable due to missing CORS headers\n    imgElem.onload = () => resolve(true);\n    // Image also errors when loading via element => Server can't be reached\n    imgElem.onerror = () => resolve(false);\n  });\n}\n\n/** Information about the starting canvas of a Manifet or a Range.\n * Can point to a whole canvas or to a part of it. */\nexport type StartCanvasInfo =\n  | string\n  | {\n    id: string;\n    ppi: number;  // Needed to create link in PDF\n    dimensions: { width: number; height: number };\n    position: {\n      x: number;\n      y: number;\n      width: number;\n      height: number;\n    };\n  };\n\n/** Fetch all of the information needed for a start canvas. */\nexport async function fetchStartCanvasInfo(\n  resource: ManifestNormalized | RangeNormalized\n): Promise<StartCanvasInfo | undefined> {\n  const startRef = resource.start;\n  if (!startRef) {\n    return;\n  }\n  let canvasId: string | undefined;\n  let fragment: string | undefined;\n  if (typeof startRef === 'string') {\n    const [ident, selectorStr] = (startRef as string).split('#xywh=');\n    if (!selectorStr) {\n      return ident;\n    }\n    canvasId = ident;\n    fragment = `xywh=${selectorStr}`;\n  } else if (startRef.type === 'SpecificResource') {\n    return startRef.id;\n  } else {\n    const selector = vault.get<Exclude<Selector, string>>(startRef.id!);\n    if (typeof selector === 'string' || selector.type !== 'FragmentSelector') {\n      log.warn(\n        `Unsupported selector type, cannot determine start canvas for ${resource.id}`\n      );\n      return;\n    }\n    const fragSel = selector as FragmentSelector;\n    if (fragSel.conformsTo !== 'http://www.w3.org/TR/media-frags/') {\n      log.warn(\n        `Unsupported selector type, cannot determine start canvas for ${resource.id} (fragment selector type was ${fragSel.conformsTo})`\n      );\n      return;\n    }\n    canvasId = fragSel.value;\n  }\n  if (!fragment || !canvasId) {\n    log.error(\n      `Couldn't parse either canvas identifier or selector for ${resource.id} start canvas.`\n    );\n    return;\n  }\n  const [selX, selY, selWidth, selHeight] = fragment\n    .substring(5)\n    .split(',')\n    .map((v) => Number.parseInt(v, 10));\n  const canvas = vault.get<CanvasNormalized>(canvasId);\n  const ppi = getPointsPerInch(canvas.service) ?? FALLBACK_PPI;\n  return {\n    id: canvasId,\n    ppi,\n    dimensions: { width: canvas.width, height: canvas.height },\n    position: {\n      x: selX,\n      y: selY,\n      width: selWidth,\n      height: selHeight,\n    },\n  };\n}\n\n/** Fetch all of the data associated with a canvas, including external services. */\nexport async function fetchCanvasData(\n  canvas: CanvasNormalized,\n  imageInfos: ImageInfo[],\n  { scaleFactor, ppiOverride, abortSignal, sizeOnly = false }: FetchImageOptions\n): Promise<CanvasData | undefined> {\n  const imagePromises = imageInfos.map(i => i.resource).map(r => fetchCanvasImage(r, { scaleFactor, abortSignal, sizeOnly }));\n  const results = await Promise.allSettled(imagePromises);\n  const canvasImages = results\n    .reduce((acc, x, idx) => {\n      if (x.status !== 'fulfilled' || x.value === null) {\n        return acc;\n      }\n      const imgInfo = imageInfos[idx];\n      acc.push({\n        ...imgInfo,\n        ...x.value,\n        // FIXME: How can we get rid of the cast?\n      } as CanvasImage);\n      return acc;\n    }, [] as CanvasImage[])\n  const failures: ImageFetchFailure[] = results\n    .filter((x): x is PromiseRejectedResult => x.status === 'rejected')\n    .map((x, idx) => {\n      const info = imageInfos[idx];\n      return {\n        ...info,\n        cause: x.reason,\n      }\n    });\n  const ppi = ppiOverride;\n  if (!ppiOverride) {\n    let ppi = getPointsPerInch(canvas.service) ?? undefined;\n    if (ppi && scaleFactor) {\n      ppi = ppi * scaleFactor;\n    }\n  }\n  let text;\n  if (!sizeOnly) {\n    try {\n      text = await fetchAndParseText(canvas, undefined);\n    } catch (err) {\n      log.warn(`Failed to fetch text for canvas ${canvas.id}: ${err}`);\n    }\n  }\n  return {\n    canvas,\n    images: canvasImages,\n    imageFailures: failures,\n    ppi,\n    text,\n    annotations: getCanvasAnnotations(canvas),\n  };\n}\n\n/** Download the JSON data for a manifest, handling stuff like broken CORS implementations\n *  and Content-Negotiation for IIIFv3 */\nexport async function fetchManifestJson(manifestUrl: string): Promise<any> {\n  try {\n    const resp = await fetch(manifestUrl, {\n      headers: {\n        Accept: MANIFEST_ACCEPT_HEADER\n      }\n    });\n    return await resp.json();\n  } catch (err) {\n    // Check if fetching failed due to CORS by downgrading the request to a\n    // 'simple' request by removing the `Accept` header, which makes the\n    // request CORS-unsafe due to double quotes and the colon in the URL\n    const resp = await fetch(manifestUrl);\n    return await resp.json();\n  }\n}\n\n/** Fetch the full IIIF Image service definition from\n * its info.json endpoint. */\nexport async function fetchFullImageService(\n  serviceRef: ImageService\n): Promise<ImageService> {\n  const serviceUrl = `${serviceRef['@id'] ?? serviceRef.id}/info.json`;\n  const resp = await fetch(serviceUrl);\n  const res = await resp.json();\n  return res as ImageService;\n}","'use strict';\n\nvar has = Object.prototype.hasOwnProperty\n  , prefix = '~';\n\n/**\n * Constructor to create a storage for our `EE` objects.\n * An `Events` instance is a plain object whose properties are event names.\n *\n * @constructor\n * @private\n */\nfunction Events() {}\n\n//\n// We try to not inherit from `Object.prototype`. In some engines creating an\n// instance in this way is faster than calling `Object.create(null)` directly.\n// If `Object.create(null)` is not supported we prefix the event names with a\n// character to make sure that the built-in object properties are not\n// overridden or used as an attack vector.\n//\nif (Object.create) {\n  Events.prototype = Object.create(null);\n\n  //\n  // This hack is needed because the `__proto__` property is still inherited in\n  // some old browsers like Android 4, iPhone 5.1, Opera 11 and Safari 5.\n  //\n  if (!new Events().__proto__) prefix = false;\n}\n\n/**\n * Representation of a single event listener.\n *\n * @param {Function} fn The listener function.\n * @param {*} context The context to invoke the listener with.\n * @param {Boolean} [once=false] Specify if the listener is a one-time listener.\n * @constructor\n * @private\n */\nfunction EE(fn, context, once) {\n  this.fn = fn;\n  this.context = context;\n  this.once = once || false;\n}\n\n/**\n * Add a listener for a given event.\n *\n * @param {EventEmitter} emitter Reference to the `EventEmitter` instance.\n * @param {(String|Symbol)} event The event name.\n * @param {Function} fn The listener function.\n * @param {*} context The context to invoke the listener with.\n * @param {Boolean} once Specify if the listener is a one-time listener.\n * @returns {EventEmitter}\n * @private\n */\nfunction addListener(emitter, event, fn, context, once) {\n  if (typeof fn !== 'function') {\n    throw new TypeError('The listener must be a function');\n  }\n\n  var listener = new EE(fn, context || emitter, once)\n    , evt = prefix ? prefix + event : event;\n\n  if (!emitter._events[evt]) emitter._events[evt] = listener, emitter._eventsCount++;\n  else if (!emitter._events[evt].fn) emitter._events[evt].push(listener);\n  else emitter._events[evt] = [emitter._events[evt], listener];\n\n  return emitter;\n}\n\n/**\n * Clear event by name.\n *\n * @param {EventEmitter} emitter Reference to the `EventEmitter` instance.\n * @param {(String|Symbol)} evt The Event name.\n * @private\n */\nfunction clearEvent(emitter, evt) {\n  if (--emitter._eventsCount === 0) emitter._events = new Events();\n  else delete emitter._events[evt];\n}\n\n/**\n * Minimal `EventEmitter` interface that is molded against the Node.js\n * `EventEmitter` interface.\n *\n * @constructor\n * @public\n */\nfunction EventEmitter() {\n  this._events = new Events();\n  this._eventsCount = 0;\n}\n\n/**\n * Return an array listing the events for which the emitter has registered\n * listeners.\n *\n * @returns {Array}\n * @public\n */\nEventEmitter.prototype.eventNames = function eventNames() {\n  var names = []\n    , events\n    , name;\n\n  if (this._eventsCount === 0) return names;\n\n  for (name in (events = this._events)) {\n    if (has.call(events, name)) names.push(prefix ? name.slice(1) : name);\n  }\n\n  if (Object.getOwnPropertySymbols) {\n    return names.concat(Object.getOwnPropertySymbols(events));\n  }\n\n  return names;\n};\n\n/**\n * Return the listeners registered for a given event.\n *\n * @param {(String|Symbol)} event The event name.\n * @returns {Array} The registered listeners.\n * @public\n */\nEventEmitter.prototype.listeners = function listeners(event) {\n  var evt = prefix ? prefix + event : event\n    , handlers = this._events[evt];\n\n  if (!handlers) return [];\n  if (handlers.fn) return [handlers.fn];\n\n  for (var i = 0, l = handlers.length, ee = new Array(l); i < l; i++) {\n    ee[i] = handlers[i].fn;\n  }\n\n  return ee;\n};\n\n/**\n * Return the number of listeners listening to a given event.\n *\n * @param {(String|Symbol)} event The event name.\n * @returns {Number} The number of listeners.\n * @public\n */\nEventEmitter.prototype.listenerCount = function listenerCount(event) {\n  var evt = prefix ? prefix + event : event\n    , listeners = this._events[evt];\n\n  if (!listeners) return 0;\n  if (listeners.fn) return 1;\n  return listeners.length;\n};\n\n/**\n * Calls each of the listeners registered for a given event.\n *\n * @param {(String|Symbol)} event The event name.\n * @returns {Boolean} `true` if the event had listeners, else `false`.\n * @public\n */\nEventEmitter.prototype.emit = function emit(event, a1, a2, a3, a4, a5) {\n  var evt = prefix ? prefix + event : event;\n\n  if (!this._events[evt]) return false;\n\n  var listeners = this._events[evt]\n    , len = arguments.length\n    , args\n    , i;\n\n  if (listeners.fn) {\n    if (listeners.once) this.removeListener(event, listeners.fn, undefined, true);\n\n    switch (len) {\n      case 1: return listeners.fn.call(listeners.context), true;\n      case 2: return listeners.fn.call(listeners.context, a1), true;\n      case 3: return listeners.fn.call(listeners.context, a1, a2), true;\n      case 4: return listeners.fn.call(listeners.context, a1, a2, a3), true;\n      case 5: return listeners.fn.call(listeners.context, a1, a2, a3, a4), true;\n      case 6: return listeners.fn.call(listeners.context, a1, a2, a3, a4, a5), true;\n    }\n\n    for (i = 1, args = new Array(len -1); i < len; i++) {\n      args[i - 1] = arguments[i];\n    }\n\n    listeners.fn.apply(listeners.context, args);\n  } else {\n    var length = listeners.length\n      , j;\n\n    for (i = 0; i < length; i++) {\n      if (listeners[i].once) this.removeListener(event, listeners[i].fn, undefined, true);\n\n      switch (len) {\n        case 1: listeners[i].fn.call(listeners[i].context); break;\n        case 2: listeners[i].fn.call(listeners[i].context, a1); break;\n        case 3: listeners[i].fn.call(listeners[i].context, a1, a2); break;\n        case 4: listeners[i].fn.call(listeners[i].context, a1, a2, a3); break;\n        default:\n          if (!args) for (j = 1, args = new Array(len -1); j < len; j++) {\n            args[j - 1] = arguments[j];\n          }\n\n          listeners[i].fn.apply(listeners[i].context, args);\n      }\n    }\n  }\n\n  return true;\n};\n\n/**\n * Add a listener for a given event.\n *\n * @param {(String|Symbol)} event The event name.\n * @param {Function} fn The listener function.\n * @param {*} [context=this] The context to invoke the listener with.\n * @returns {EventEmitter} `this`.\n * @public\n */\nEventEmitter.prototype.on = function on(event, fn, context) {\n  return addListener(this, event, fn, context, false);\n};\n\n/**\n * Add a one-time listener for a given event.\n *\n * @param {(String|Symbol)} event The event name.\n * @param {Function} fn The listener function.\n * @param {*} [context=this] The context to invoke the listener with.\n * @returns {EventEmitter} `this`.\n * @public\n */\nEventEmitter.prototype.once = function once(event, fn, context) {\n  return addListener(this, event, fn, context, true);\n};\n\n/**\n * Remove the listeners of a given event.\n *\n * @param {(String|Symbol)} event The event name.\n * @param {Function} fn Only remove the listeners that match this function.\n * @param {*} context Only remove the listeners that have this context.\n * @param {Boolean} once Only remove one-time listeners.\n * @returns {EventEmitter} `this`.\n * @public\n */\nEventEmitter.prototype.removeListener = function removeListener(event, fn, context, once) {\n  var evt = prefix ? prefix + event : event;\n\n  if (!this._events[evt]) return this;\n  if (!fn) {\n    clearEvent(this, evt);\n    return this;\n  }\n\n  var listeners = this._events[evt];\n\n  if (listeners.fn) {\n    if (\n      listeners.fn === fn &&\n      (!once || listeners.once) &&\n      (!context || listeners.context === context)\n    ) {\n      clearEvent(this, evt);\n    }\n  } else {\n    for (var i = 0, events = [], length = listeners.length; i < length; i++) {\n      if (\n        listeners[i].fn !== fn ||\n        (once && !listeners[i].once) ||\n        (context && listeners[i].context !== context)\n      ) {\n        events.push(listeners[i]);\n      }\n    }\n\n    //\n    // Reset the array, or remove it completely if we have no more listeners.\n    //\n    if (events.length) this._events[evt] = events.length === 1 ? events[0] : events;\n    else clearEvent(this, evt);\n  }\n\n  return this;\n};\n\n/**\n * Remove all listeners, or those of the specified event.\n *\n * @param {(String|Symbol)} [event] The event name.\n * @returns {EventEmitter} `this`.\n * @public\n */\nEventEmitter.prototype.removeAllListeners = function removeAllListeners(event) {\n  var evt;\n\n  if (event) {\n    evt = prefix ? prefix + event : event;\n    if (this._events[evt]) clearEvent(this, evt);\n  } else {\n    this._events = new Events();\n    this._eventsCount = 0;\n  }\n\n  return this;\n};\n\n//\n// Alias methods names because people roll like that.\n//\nEventEmitter.prototype.off = EventEmitter.prototype.removeListener;\nEventEmitter.prototype.addListener = EventEmitter.prototype.on;\n\n//\n// Expose the prefix.\n//\nEventEmitter.prefixed = prefix;\n\n//\n// Allow `EventEmitter` to be imported as module namespace.\n//\nEventEmitter.EventEmitter = EventEmitter;\n\n//\n// Expose the module.\n//\nif ('undefined' !== typeof module) {\n  module.exports = EventEmitter;\n}\n","export class TimeoutError extends Error {\n\tconstructor(message) {\n\t\tsuper(message);\n\t\tthis.name = 'TimeoutError';\n\t}\n}\n\n/**\nAn error to be thrown when the request is aborted by AbortController.\nDOMException is thrown instead of this Error when DOMException is available.\n*/\nexport class AbortError extends Error {\n\tconstructor(message) {\n\t\tsuper();\n\t\tthis.name = 'AbortError';\n\t\tthis.message = message;\n\t}\n}\n\n/**\nTODO: Remove AbortError and just throw DOMException when targeting Node 18.\n*/\nconst getDOMException = errorMessage => globalThis.DOMException === undefined ?\n\tnew AbortError(errorMessage) :\n\tnew DOMException(errorMessage);\n\n/**\nTODO: Remove below function and just 'reject(signal.reason)' when targeting Node 18.\n*/\nconst getAbortedReason = signal => {\n\tconst reason = signal.reason === undefined ?\n\t\tgetDOMException('This operation was aborted.') :\n\t\tsignal.reason;\n\n\treturn reason instanceof Error ? reason : getDOMException(reason);\n};\n\nexport default function pTimeout(promise, milliseconds, fallback, options) {\n\tlet timer;\n\n\tconst cancelablePromise = new Promise((resolve, reject) => {\n\t\tif (typeof milliseconds !== 'number' || Math.sign(milliseconds) !== 1) {\n\t\t\tthrow new TypeError(`Expected \\`milliseconds\\` to be a positive number, got \\`${milliseconds}\\``);\n\t\t}\n\n\t\tif (milliseconds === Number.POSITIVE_INFINITY) {\n\t\t\tresolve(promise);\n\t\t\treturn;\n\t\t}\n\n\t\toptions = {\n\t\t\tcustomTimers: {setTimeout, clearTimeout},\n\t\t\t...options\n\t\t};\n\n\t\tif (options.signal) {\n\t\t\tconst {signal} = options;\n\t\t\tif (signal.aborted) {\n\t\t\t\treject(getAbortedReason(signal));\n\t\t\t}\n\n\t\t\tsignal.addEventListener('abort', () => {\n\t\t\t\treject(getAbortedReason(signal));\n\t\t\t});\n\t\t}\n\n\t\ttimer = options.customTimers.setTimeout.call(undefined, () => {\n\t\t\tif (typeof fallback === 'function') {\n\t\t\t\ttry {\n\t\t\t\t\tresolve(fallback());\n\t\t\t\t} catch (error) {\n\t\t\t\t\treject(error);\n\t\t\t\t}\n\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst message = typeof fallback === 'string' ? fallback : `Promise timed out after ${milliseconds} milliseconds`;\n\t\t\tconst timeoutError = fallback instanceof Error ? fallback : new TimeoutError(message);\n\n\t\t\tif (typeof promise.cancel === 'function') {\n\t\t\t\tpromise.cancel();\n\t\t\t}\n\n\t\t\treject(timeoutError);\n\t\t}, milliseconds);\n\n\t\t(async () => {\n\t\t\ttry {\n\t\t\t\tresolve(await promise);\n\t\t\t} catch (error) {\n\t\t\t\treject(error);\n\t\t\t} finally {\n\t\t\t\toptions.customTimers.clearTimeout.call(undefined, timer);\n\t\t\t}\n\t\t})();\n\t});\n\n\tcancelablePromise.clear = () => {\n\t\tclearTimeout(timer);\n\t\ttimer = undefined;\n\t};\n\n\treturn cancelablePromise;\n}\n","// Port of lower_bound from https://en.cppreference.com/w/cpp/algorithm/lower_bound\n// Used to compute insertion index to keep queue sorted after insertion\nexport default function lowerBound(array, value, comparator) {\n    let first = 0;\n    let count = array.length;\n    while (count > 0) {\n        const step = Math.trunc(count / 2);\n        let it = first + step;\n        if (comparator(array[it], value) <= 0) {\n            first = ++it;\n            count -= step + 1;\n        }\n        else {\n            count = step;\n        }\n    }\n    return first;\n}\n","var __classPrivateFieldGet = (this && this.__classPrivateFieldGet) || function (receiver, state, kind, f) {\n    if (kind === \"a\" && !f) throw new TypeError(\"Private accessor was defined without a getter\");\n    if (typeof state === \"function\" ? receiver !== state || !f : !state.has(receiver)) throw new TypeError(\"Cannot read private member from an object whose class did not declare it\");\n    return kind === \"m\" ? f : kind === \"a\" ? f.call(receiver) : f ? f.value : state.get(receiver);\n};\nvar _PriorityQueue_queue;\nimport lowerBound from './lower-bound.js';\nclass PriorityQueue {\n    constructor() {\n        _PriorityQueue_queue.set(this, []);\n    }\n    enqueue(run, options) {\n        options = {\n            priority: 0,\n            ...options,\n        };\n        const element = {\n            priority: options.priority,\n            run,\n        };\n        if (this.size && __classPrivateFieldGet(this, _PriorityQueue_queue, \"f\")[this.size - 1].priority >= options.priority) {\n            __classPrivateFieldGet(this, _PriorityQueue_queue, \"f\").push(element);\n            return;\n        }\n        const index = lowerBound(__classPrivateFieldGet(this, _PriorityQueue_queue, \"f\"), element, (a, b) => b.priority - a.priority);\n        __classPrivateFieldGet(this, _PriorityQueue_queue, \"f\").splice(index, 0, element);\n    }\n    dequeue() {\n        const item = __classPrivateFieldGet(this, _PriorityQueue_queue, \"f\").shift();\n        return item === null || item === void 0 ? void 0 : item.run;\n    }\n    filter(options) {\n        return __classPrivateFieldGet(this, _PriorityQueue_queue, \"f\").filter((element) => element.priority === options.priority).map((element) => element.run);\n    }\n    get size() {\n        return __classPrivateFieldGet(this, _PriorityQueue_queue, \"f\").length;\n    }\n}\n_PriorityQueue_queue = new WeakMap();\nexport default PriorityQueue;\n","var __classPrivateFieldSet = (this && this.__classPrivateFieldSet) || function (receiver, state, value, kind, f) {\n    if (kind === \"m\") throw new TypeError(\"Private method is not writable\");\n    if (kind === \"a\" && !f) throw new TypeError(\"Private accessor was defined without a setter\");\n    if (typeof state === \"function\" ? receiver !== state || !f : !state.has(receiver)) throw new TypeError(\"Cannot write private member to an object whose class did not declare it\");\n    return (kind === \"a\" ? f.call(receiver, value) : f ? f.value = value : state.set(receiver, value)), value;\n};\nvar __classPrivateFieldGet = (this && this.__classPrivateFieldGet) || function (receiver, state, kind, f) {\n    if (kind === \"a\" && !f) throw new TypeError(\"Private accessor was defined without a getter\");\n    if (typeof state === \"function\" ? receiver !== state || !f : !state.has(receiver)) throw new TypeError(\"Cannot read private member from an object whose class did not declare it\");\n    return kind === \"m\" ? f : kind === \"a\" ? f.call(receiver) : f ? f.value : state.get(receiver);\n};\nvar _PQueue_instances, _PQueue_carryoverConcurrencyCount, _PQueue_isIntervalIgnored, _PQueue_intervalCount, _PQueue_intervalCap, _PQueue_interval, _PQueue_intervalEnd, _PQueue_intervalId, _PQueue_timeoutId, _PQueue_queue, _PQueue_queueClass, _PQueue_pending, _PQueue_concurrency, _PQueue_isPaused, _PQueue_throwOnTimeout, _PQueue_doesIntervalAllowAnother_get, _PQueue_doesConcurrentAllowAnother_get, _PQueue_next, _PQueue_onResumeInterval, _PQueue_isIntervalPaused_get, _PQueue_tryToStartAnother, _PQueue_initializeIntervalIfNeeded, _PQueue_onInterval, _PQueue_processQueue, _PQueue_throwOnAbort, _PQueue_onEvent;\nimport { EventEmitter } from 'eventemitter3';\nimport pTimeout, { TimeoutError } from 'p-timeout';\nimport PriorityQueue from './priority-queue.js';\n/**\nThe error thrown by `queue.add()` when a job is aborted before it is run. See `signal`.\n*/\nexport class AbortError extends Error {\n}\n/**\nPromise queue with concurrency control.\n*/\nclass PQueue extends EventEmitter {\n    // TODO: The `throwOnTimeout` option should affect the return types of `add()` and `addAll()`\n    constructor(options) {\n        var _a, _b, _c, _d;\n        super();\n        _PQueue_instances.add(this);\n        _PQueue_carryoverConcurrencyCount.set(this, void 0);\n        _PQueue_isIntervalIgnored.set(this, void 0);\n        _PQueue_intervalCount.set(this, 0);\n        _PQueue_intervalCap.set(this, void 0);\n        _PQueue_interval.set(this, void 0);\n        _PQueue_intervalEnd.set(this, 0);\n        _PQueue_intervalId.set(this, void 0);\n        _PQueue_timeoutId.set(this, void 0);\n        _PQueue_queue.set(this, void 0);\n        _PQueue_queueClass.set(this, void 0);\n        _PQueue_pending.set(this, 0);\n        // The `!` is needed because of https://github.com/microsoft/TypeScript/issues/32194\n        _PQueue_concurrency.set(this, void 0);\n        _PQueue_isPaused.set(this, void 0);\n        _PQueue_throwOnTimeout.set(this, void 0);\n        /**\n        Per-operation timeout in milliseconds. Operations fulfill once `timeout` elapses if they haven't already.\n    \n        Applies to each future operation.\n        */\n        Object.defineProperty(this, \"timeout\", {\n            enumerable: true,\n            configurable: true,\n            writable: true,\n            value: void 0\n        });\n        // eslint-disable-next-line @typescript-eslint/consistent-type-assertions\n        options = {\n            carryoverConcurrencyCount: false,\n            intervalCap: Number.POSITIVE_INFINITY,\n            interval: 0,\n            concurrency: Number.POSITIVE_INFINITY,\n            autoStart: true,\n            queueClass: PriorityQueue,\n            ...options,\n        };\n        if (!(typeof options.intervalCap === 'number' && options.intervalCap >= 1)) {\n            throw new TypeError(`Expected \\`intervalCap\\` to be a number from 1 and up, got \\`${(_b = (_a = options.intervalCap) === null || _a === void 0 ? void 0 : _a.toString()) !== null && _b !== void 0 ? _b : ''}\\` (${typeof options.intervalCap})`);\n        }\n        if (options.interval === undefined || !(Number.isFinite(options.interval) && options.interval >= 0)) {\n            throw new TypeError(`Expected \\`interval\\` to be a finite number >= 0, got \\`${(_d = (_c = options.interval) === null || _c === void 0 ? void 0 : _c.toString()) !== null && _d !== void 0 ? _d : ''}\\` (${typeof options.interval})`);\n        }\n        __classPrivateFieldSet(this, _PQueue_carryoverConcurrencyCount, options.carryoverConcurrencyCount, \"f\");\n        __classPrivateFieldSet(this, _PQueue_isIntervalIgnored, options.intervalCap === Number.POSITIVE_INFINITY || options.interval === 0, \"f\");\n        __classPrivateFieldSet(this, _PQueue_intervalCap, options.intervalCap, \"f\");\n        __classPrivateFieldSet(this, _PQueue_interval, options.interval, \"f\");\n        __classPrivateFieldSet(this, _PQueue_queue, new options.queueClass(), \"f\");\n        __classPrivateFieldSet(this, _PQueue_queueClass, options.queueClass, \"f\");\n        this.concurrency = options.concurrency;\n        this.timeout = options.timeout;\n        __classPrivateFieldSet(this, _PQueue_throwOnTimeout, options.throwOnTimeout === true, \"f\");\n        __classPrivateFieldSet(this, _PQueue_isPaused, options.autoStart === false, \"f\");\n    }\n    get concurrency() {\n        return __classPrivateFieldGet(this, _PQueue_concurrency, \"f\");\n    }\n    set concurrency(newConcurrency) {\n        if (!(typeof newConcurrency === 'number' && newConcurrency >= 1)) {\n            throw new TypeError(`Expected \\`concurrency\\` to be a number from 1 and up, got \\`${newConcurrency}\\` (${typeof newConcurrency})`);\n        }\n        __classPrivateFieldSet(this, _PQueue_concurrency, newConcurrency, \"f\");\n        __classPrivateFieldGet(this, _PQueue_instances, \"m\", _PQueue_processQueue).call(this);\n    }\n    async add(function_, options = {}) {\n        options = {\n            timeout: this.timeout,\n            throwOnTimeout: __classPrivateFieldGet(this, _PQueue_throwOnTimeout, \"f\"),\n            ...options,\n        };\n        return new Promise((resolve, reject) => {\n            __classPrivateFieldGet(this, _PQueue_queue, \"f\").enqueue(async () => {\n                var _a;\n                var _b, _c;\n                __classPrivateFieldSet(this, _PQueue_pending, (_b = __classPrivateFieldGet(this, _PQueue_pending, \"f\"), _b++, _b), \"f\");\n                __classPrivateFieldSet(this, _PQueue_intervalCount, (_c = __classPrivateFieldGet(this, _PQueue_intervalCount, \"f\"), _c++, _c), \"f\");\n                try {\n                    // TODO: Use options.signal?.throwIfAborted() when targeting Node.js 18\n                    if ((_a = options.signal) === null || _a === void 0 ? void 0 : _a.aborted) {\n                        // TODO: Use ABORT_ERR code when targeting Node.js 16 (https://nodejs.org/docs/latest-v16.x/api/errors.html#abort_err)\n                        throw new AbortError('The task was aborted.');\n                    }\n                    let operation = function_({ signal: options.signal });\n                    if (options.timeout) {\n                        operation = pTimeout(Promise.resolve(operation), options.timeout);\n                    }\n                    if (options.signal) {\n                        operation = Promise.race([operation, __classPrivateFieldGet(this, _PQueue_instances, \"m\", _PQueue_throwOnAbort).call(this, options.signal)]);\n                    }\n                    const result = await operation;\n                    resolve(result);\n                    this.emit('completed', result);\n                }\n                catch (error) {\n                    if (error instanceof TimeoutError && !options.throwOnTimeout) {\n                        resolve();\n                        return;\n                    }\n                    reject(error);\n                    this.emit('error', error);\n                }\n                finally {\n                    __classPrivateFieldGet(this, _PQueue_instances, \"m\", _PQueue_next).call(this);\n                }\n            }, options);\n            this.emit('add');\n            __classPrivateFieldGet(this, _PQueue_instances, \"m\", _PQueue_tryToStartAnother).call(this);\n        });\n    }\n    async addAll(functions, options) {\n        return Promise.all(functions.map(async (function_) => this.add(function_, options)));\n    }\n    /**\n    Start (or resume) executing enqueued tasks within concurrency limit. No need to call this if queue is not paused (via `options.autoStart = false` or by `.pause()` method.)\n    */\n    start() {\n        if (!__classPrivateFieldGet(this, _PQueue_isPaused, \"f\")) {\n            return this;\n        }\n        __classPrivateFieldSet(this, _PQueue_isPaused, false, \"f\");\n        __classPrivateFieldGet(this, _PQueue_instances, \"m\", _PQueue_processQueue).call(this);\n        return this;\n    }\n    /**\n    Put queue execution on hold.\n    */\n    pause() {\n        __classPrivateFieldSet(this, _PQueue_isPaused, true, \"f\");\n    }\n    /**\n    Clear the queue.\n    */\n    clear() {\n        __classPrivateFieldSet(this, _PQueue_queue, new (__classPrivateFieldGet(this, _PQueue_queueClass, \"f\"))(), \"f\");\n    }\n    /**\n    Can be called multiple times. Useful if you for example add additional items at a later time.\n\n    @returns A promise that settles when the queue becomes empty.\n    */\n    async onEmpty() {\n        // Instantly resolve if the queue is empty\n        if (__classPrivateFieldGet(this, _PQueue_queue, \"f\").size === 0) {\n            return;\n        }\n        await __classPrivateFieldGet(this, _PQueue_instances, \"m\", _PQueue_onEvent).call(this, 'empty');\n    }\n    /**\n    @returns A promise that settles when the queue size is less than the given limit: `queue.size < limit`.\n\n    If you want to avoid having the queue grow beyond a certain size you can `await queue.onSizeLessThan()` before adding a new item.\n\n    Note that this only limits the number of items waiting to start. There could still be up to `concurrency` jobs already running that this call does not include in its calculation.\n    */\n    async onSizeLessThan(limit) {\n        // Instantly resolve if the queue is empty.\n        if (__classPrivateFieldGet(this, _PQueue_queue, \"f\").size < limit) {\n            return;\n        }\n        await __classPrivateFieldGet(this, _PQueue_instances, \"m\", _PQueue_onEvent).call(this, 'next', () => __classPrivateFieldGet(this, _PQueue_queue, \"f\").size < limit);\n    }\n    /**\n    The difference with `.onEmpty` is that `.onIdle` guarantees that all work from the queue has finished. `.onEmpty` merely signals that the queue is empty, but it could mean that some promises haven't completed yet.\n\n    @returns A promise that settles when the queue becomes empty, and all promises have completed; `queue.size === 0 && queue.pending === 0`.\n    */\n    async onIdle() {\n        // Instantly resolve if none pending and if nothing else is queued\n        if (__classPrivateFieldGet(this, _PQueue_pending, \"f\") === 0 && __classPrivateFieldGet(this, _PQueue_queue, \"f\").size === 0) {\n            return;\n        }\n        await __classPrivateFieldGet(this, _PQueue_instances, \"m\", _PQueue_onEvent).call(this, 'idle');\n    }\n    /**\n    Size of the queue, the number of queued items waiting to run.\n    */\n    get size() {\n        return __classPrivateFieldGet(this, _PQueue_queue, \"f\").size;\n    }\n    /**\n    Size of the queue, filtered by the given options.\n\n    For example, this can be used to find the number of items remaining in the queue with a specific priority level.\n    */\n    sizeBy(options) {\n        // eslint-disable-next-line unicorn/no-array-callback-reference\n        return __classPrivateFieldGet(this, _PQueue_queue, \"f\").filter(options).length;\n    }\n    /**\n    Number of running items (no longer in the queue).\n    */\n    get pending() {\n        return __classPrivateFieldGet(this, _PQueue_pending, \"f\");\n    }\n    /**\n    Whether the queue is currently paused.\n    */\n    get isPaused() {\n        return __classPrivateFieldGet(this, _PQueue_isPaused, \"f\");\n    }\n}\n_PQueue_carryoverConcurrencyCount = new WeakMap(), _PQueue_isIntervalIgnored = new WeakMap(), _PQueue_intervalCount = new WeakMap(), _PQueue_intervalCap = new WeakMap(), _PQueue_interval = new WeakMap(), _PQueue_intervalEnd = new WeakMap(), _PQueue_intervalId = new WeakMap(), _PQueue_timeoutId = new WeakMap(), _PQueue_queue = new WeakMap(), _PQueue_queueClass = new WeakMap(), _PQueue_pending = new WeakMap(), _PQueue_concurrency = new WeakMap(), _PQueue_isPaused = new WeakMap(), _PQueue_throwOnTimeout = new WeakMap(), _PQueue_instances = new WeakSet(), _PQueue_doesIntervalAllowAnother_get = function _PQueue_doesIntervalAllowAnother_get() {\n    return __classPrivateFieldGet(this, _PQueue_isIntervalIgnored, \"f\") || __classPrivateFieldGet(this, _PQueue_intervalCount, \"f\") < __classPrivateFieldGet(this, _PQueue_intervalCap, \"f\");\n}, _PQueue_doesConcurrentAllowAnother_get = function _PQueue_doesConcurrentAllowAnother_get() {\n    return __classPrivateFieldGet(this, _PQueue_pending, \"f\") < __classPrivateFieldGet(this, _PQueue_concurrency, \"f\");\n}, _PQueue_next = function _PQueue_next() {\n    var _a;\n    __classPrivateFieldSet(this, _PQueue_pending, (_a = __classPrivateFieldGet(this, _PQueue_pending, \"f\"), _a--, _a), \"f\");\n    __classPrivateFieldGet(this, _PQueue_instances, \"m\", _PQueue_tryToStartAnother).call(this);\n    this.emit('next');\n}, _PQueue_onResumeInterval = function _PQueue_onResumeInterval() {\n    __classPrivateFieldGet(this, _PQueue_instances, \"m\", _PQueue_onInterval).call(this);\n    __classPrivateFieldGet(this, _PQueue_instances, \"m\", _PQueue_initializeIntervalIfNeeded).call(this);\n    __classPrivateFieldSet(this, _PQueue_timeoutId, undefined, \"f\");\n}, _PQueue_isIntervalPaused_get = function _PQueue_isIntervalPaused_get() {\n    const now = Date.now();\n    if (__classPrivateFieldGet(this, _PQueue_intervalId, \"f\") === undefined) {\n        const delay = __classPrivateFieldGet(this, _PQueue_intervalEnd, \"f\") - now;\n        if (delay < 0) {\n            // Act as the interval was done\n            // We don't need to resume it here because it will be resumed on line 160\n            __classPrivateFieldSet(this, _PQueue_intervalCount, (__classPrivateFieldGet(this, _PQueue_carryoverConcurrencyCount, \"f\")) ? __classPrivateFieldGet(this, _PQueue_pending, \"f\") : 0, \"f\");\n        }\n        else {\n            // Act as the interval is pending\n            if (__classPrivateFieldGet(this, _PQueue_timeoutId, \"f\") === undefined) {\n                __classPrivateFieldSet(this, _PQueue_timeoutId, setTimeout(() => {\n                    __classPrivateFieldGet(this, _PQueue_instances, \"m\", _PQueue_onResumeInterval).call(this);\n                }, delay), \"f\");\n            }\n            return true;\n        }\n    }\n    return false;\n}, _PQueue_tryToStartAnother = function _PQueue_tryToStartAnother() {\n    if (__classPrivateFieldGet(this, _PQueue_queue, \"f\").size === 0) {\n        // We can clear the interval (\"pause\")\n        // Because we can redo it later (\"resume\")\n        if (__classPrivateFieldGet(this, _PQueue_intervalId, \"f\")) {\n            clearInterval(__classPrivateFieldGet(this, _PQueue_intervalId, \"f\"));\n        }\n        __classPrivateFieldSet(this, _PQueue_intervalId, undefined, \"f\");\n        this.emit('empty');\n        if (__classPrivateFieldGet(this, _PQueue_pending, \"f\") === 0) {\n            this.emit('idle');\n        }\n        return false;\n    }\n    if (!__classPrivateFieldGet(this, _PQueue_isPaused, \"f\")) {\n        const canInitializeInterval = !__classPrivateFieldGet(this, _PQueue_instances, \"a\", _PQueue_isIntervalPaused_get);\n        if (__classPrivateFieldGet(this, _PQueue_instances, \"a\", _PQueue_doesIntervalAllowAnother_get) && __classPrivateFieldGet(this, _PQueue_instances, \"a\", _PQueue_doesConcurrentAllowAnother_get)) {\n            const job = __classPrivateFieldGet(this, _PQueue_queue, \"f\").dequeue();\n            if (!job) {\n                return false;\n            }\n            this.emit('active');\n            job();\n            if (canInitializeInterval) {\n                __classPrivateFieldGet(this, _PQueue_instances, \"m\", _PQueue_initializeIntervalIfNeeded).call(this);\n            }\n            return true;\n        }\n    }\n    return false;\n}, _PQueue_initializeIntervalIfNeeded = function _PQueue_initializeIntervalIfNeeded() {\n    if (__classPrivateFieldGet(this, _PQueue_isIntervalIgnored, \"f\") || __classPrivateFieldGet(this, _PQueue_intervalId, \"f\") !== undefined) {\n        return;\n    }\n    __classPrivateFieldSet(this, _PQueue_intervalId, setInterval(() => {\n        __classPrivateFieldGet(this, _PQueue_instances, \"m\", _PQueue_onInterval).call(this);\n    }, __classPrivateFieldGet(this, _PQueue_interval, \"f\")), \"f\");\n    __classPrivateFieldSet(this, _PQueue_intervalEnd, Date.now() + __classPrivateFieldGet(this, _PQueue_interval, \"f\"), \"f\");\n}, _PQueue_onInterval = function _PQueue_onInterval() {\n    if (__classPrivateFieldGet(this, _PQueue_intervalCount, \"f\") === 0 && __classPrivateFieldGet(this, _PQueue_pending, \"f\") === 0 && __classPrivateFieldGet(this, _PQueue_intervalId, \"f\")) {\n        clearInterval(__classPrivateFieldGet(this, _PQueue_intervalId, \"f\"));\n        __classPrivateFieldSet(this, _PQueue_intervalId, undefined, \"f\");\n    }\n    __classPrivateFieldSet(this, _PQueue_intervalCount, __classPrivateFieldGet(this, _PQueue_carryoverConcurrencyCount, \"f\") ? __classPrivateFieldGet(this, _PQueue_pending, \"f\") : 0, \"f\");\n    __classPrivateFieldGet(this, _PQueue_instances, \"m\", _PQueue_processQueue).call(this);\n}, _PQueue_processQueue = function _PQueue_processQueue() {\n    // eslint-disable-next-line no-empty\n    while (__classPrivateFieldGet(this, _PQueue_instances, \"m\", _PQueue_tryToStartAnother).call(this)) { }\n}, _PQueue_throwOnAbort = async function _PQueue_throwOnAbort(signal) {\n    return new Promise((_resolve, reject) => {\n        signal.addEventListener('abort', () => {\n            // TODO: Reject with signal.throwIfAborted() when targeting Node.js 18\n            // TODO: Use ABORT_ERR code when targeting Node.js 16 (https://nodejs.org/docs/latest-v16.x/api/errors.html#abort_err)\n            reject(new AbortError('The task was aborted.'));\n        }, { once: true });\n    });\n}, _PQueue_onEvent = async function _PQueue_onEvent(event, filter) {\n    return new Promise(resolve => {\n        const listener = () => {\n            if (filter && !filter()) {\n                return;\n            }\n            this.off(event, listener);\n            resolve();\n        };\n        this.on(event, listener);\n    });\n};\nexport default PQueue;\n","module.exports = function dedent(templateStrings) {\r\n    var values = [];\r\n    for (var _i = 1; _i < arguments.length; _i++) {\r\n        values[_i - 1] = arguments[_i];\r\n    }\r\n    var matches = [];\r\n    var strings = typeof templateStrings === 'string' ? [templateStrings] : templateStrings.slice();\r\n    // 1. Remove trailing whitespace.\r\n    strings[strings.length - 1] = strings[strings.length - 1].replace(/\\r?\\n([\\t ]*)$/, '');\r\n    // 2. Find all line breaks to determine the highest common indentation level.\r\n    for (var i = 0; i < strings.length; i++) {\r\n        var match = void 0;\r\n        if (match = strings[i].match(/\\n[\\t ]+/g)) {\r\n            matches.push.apply(matches, match);\r\n        }\r\n    }\r\n    // 3. Remove the common indentation from all strings.\r\n    if (matches.length) {\r\n        var size = Math.min.apply(Math, matches.map(function (value) { return value.length - 1; }));\r\n        var pattern = new RegExp(\"\\n[\\t ]{\" + size + \"}\", 'g');\r\n        for (var i = 0; i < strings.length; i++) {\r\n            strings[i] = strings[i].replace(pattern, '\\n');\r\n        }\r\n    }\r\n    // 4. Remove leading whitespace.\r\n    strings[0] = strings[0].replace(/^\\r?\\n/, '');\r\n    // 5. Perform interpolation.\r\n    var string = strings[0];\r\n    for (var i = 0; i < values.length; i++) {\r\n        string += values[i] + strings[i + 1];\r\n    }\r\n    return string;\r\n};\r\n//# sourceMappingURL=index.js.map","// DEFLATE is a complex format; to read this code, you should probably check the RFC first:\n// https://tools.ietf.org/html/rfc1951\n// You may also wish to take a look at the guide I made about this program:\n// https://gist.github.com/101arrowz/253f31eb5abc3d9275ab943003ffecad\n// Some of the following code is similar to that of UZIP.js:\n// https://github.com/photopea/UZIP.js\n// However, the vast majority of the codebase has diverged from UZIP.js to increase performance and reduce bundle size.\n// Sometimes 0 will appear where -1 would be more appropriate. This is because using a uint\n// is better for memory in most engines (I *think*).\nvar ch2 = {};\nvar wk = (function (c, id, msg, transfer, cb) {\n    var w = new Worker(ch2[id] || (ch2[id] = URL.createObjectURL(new Blob([\n        c + ';addEventListener(\"error\",function(e){e=e.error;postMessage({$e$:[e.message,e.code,e.stack]})})'\n    ], { type: 'text/javascript' }))));\n    w.onmessage = function (e) {\n        var d = e.data, ed = d.$e$;\n        if (ed) {\n            var err = new Error(ed[0]);\n            err['code'] = ed[1];\n            err.stack = ed[2];\n            cb(err, null);\n        }\n        else\n            cb(null, d);\n    };\n    w.postMessage(msg, transfer);\n    return w;\n});\n\n// aliases for shorter compressed code (most minifers don't do this)\nvar u8 = Uint8Array, u16 = Uint16Array, i32 = Int32Array;\n// fixed length extra bits\nvar fleb = new u8([0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 2, 2, 2, 2, 3, 3, 3, 3, 4, 4, 4, 4, 5, 5, 5, 5, 0, /* unused */ 0, 0, /* impossible */ 0]);\n// fixed distance extra bits\nvar fdeb = new u8([0, 0, 0, 0, 1, 1, 2, 2, 3, 3, 4, 4, 5, 5, 6, 6, 7, 7, 8, 8, 9, 9, 10, 10, 11, 11, 12, 12, 13, 13, /* unused */ 0, 0]);\n// code length index map\nvar clim = new u8([16, 17, 18, 0, 8, 7, 9, 6, 10, 5, 11, 4, 12, 3, 13, 2, 14, 1, 15]);\n// get base, reverse index map from extra bits\nvar freb = function (eb, start) {\n    var b = new u16(31);\n    for (var i = 0; i < 31; ++i) {\n        b[i] = start += 1 << eb[i - 1];\n    }\n    // numbers here are at max 18 bits\n    var r = new i32(b[30]);\n    for (var i = 1; i < 30; ++i) {\n        for (var j = b[i]; j < b[i + 1]; ++j) {\n            r[j] = ((j - b[i]) << 5) | i;\n        }\n    }\n    return { b: b, r: r };\n};\nvar _a = freb(fleb, 2), fl = _a.b, revfl = _a.r;\n// we can ignore the fact that the other numbers are wrong; they never happen anyway\nfl[28] = 258, revfl[258] = 28;\nvar _b = freb(fdeb, 0), fd = _b.b, revfd = _b.r;\n// map of value to reverse (assuming 16 bits)\nvar rev = new u16(32768);\nfor (var i = 0; i < 32768; ++i) {\n    // reverse table algorithm from SO\n    var x = ((i & 0xAAAA) >> 1) | ((i & 0x5555) << 1);\n    x = ((x & 0xCCCC) >> 2) | ((x & 0x3333) << 2);\n    x = ((x & 0xF0F0) >> 4) | ((x & 0x0F0F) << 4);\n    rev[i] = (((x & 0xFF00) >> 8) | ((x & 0x00FF) << 8)) >> 1;\n}\n// create huffman tree from u8 \"map\": index -> code length for code index\n// mb (max bits) must be at most 15\n// TODO: optimize/split up?\nvar hMap = (function (cd, mb, r) {\n    var s = cd.length;\n    // index\n    var i = 0;\n    // u16 \"map\": index -> # of codes with bit length = index\n    var l = new u16(mb);\n    // length of cd must be 288 (total # of codes)\n    for (; i < s; ++i) {\n        if (cd[i])\n            ++l[cd[i] - 1];\n    }\n    // u16 \"map\": index -> minimum code for bit length = index\n    var le = new u16(mb);\n    for (i = 1; i < mb; ++i) {\n        le[i] = (le[i - 1] + l[i - 1]) << 1;\n    }\n    var co;\n    if (r) {\n        // u16 \"map\": index -> number of actual bits, symbol for code\n        co = new u16(1 << mb);\n        // bits to remove for reverser\n        var rvb = 15 - mb;\n        for (i = 0; i < s; ++i) {\n            // ignore 0 lengths\n            if (cd[i]) {\n                // num encoding both symbol and bits read\n                var sv = (i << 4) | cd[i];\n                // free bits\n                var r_1 = mb - cd[i];\n                // start value\n                var v = le[cd[i] - 1]++ << r_1;\n                // m is end value\n                for (var m = v | ((1 << r_1) - 1); v <= m; ++v) {\n                    // every 16 bit value starting with the code yields the same result\n                    co[rev[v] >> rvb] = sv;\n                }\n            }\n        }\n    }\n    else {\n        co = new u16(s);\n        for (i = 0; i < s; ++i) {\n            if (cd[i]) {\n                co[i] = rev[le[cd[i] - 1]++] >> (15 - cd[i]);\n            }\n        }\n    }\n    return co;\n});\n// fixed length tree\nvar flt = new u8(288);\nfor (var i = 0; i < 144; ++i)\n    flt[i] = 8;\nfor (var i = 144; i < 256; ++i)\n    flt[i] = 9;\nfor (var i = 256; i < 280; ++i)\n    flt[i] = 7;\nfor (var i = 280; i < 288; ++i)\n    flt[i] = 8;\n// fixed distance tree\nvar fdt = new u8(32);\nfor (var i = 0; i < 32; ++i)\n    fdt[i] = 5;\n// fixed length map\nvar flm = /*#__PURE__*/ hMap(flt, 9, 0), flrm = /*#__PURE__*/ hMap(flt, 9, 1);\n// fixed distance map\nvar fdm = /*#__PURE__*/ hMap(fdt, 5, 0), fdrm = /*#__PURE__*/ hMap(fdt, 5, 1);\n// find max of array\nvar max = function (a) {\n    var m = a[0];\n    for (var i = 1; i < a.length; ++i) {\n        if (a[i] > m)\n            m = a[i];\n    }\n    return m;\n};\n// read d, starting at bit p and mask with m\nvar bits = function (d, p, m) {\n    var o = (p / 8) | 0;\n    return ((d[o] | (d[o + 1] << 8)) >> (p & 7)) & m;\n};\n// read d, starting at bit p continuing for at least 16 bits\nvar bits16 = function (d, p) {\n    var o = (p / 8) | 0;\n    return ((d[o] | (d[o + 1] << 8) | (d[o + 2] << 16)) >> (p & 7));\n};\n// get end of byte\nvar shft = function (p) { return ((p + 7) / 8) | 0; };\n// typed array slice - allows garbage collector to free original reference,\n// while being more compatible than .slice\nvar slc = function (v, s, e) {\n    if (s == null || s < 0)\n        s = 0;\n    if (e == null || e > v.length)\n        e = v.length;\n    // can't use .constructor in case user-supplied\n    return new u8(v.subarray(s, e));\n};\n/**\n * Codes for errors generated within this library\n */\nexport var FlateErrorCode = {\n    UnexpectedEOF: 0,\n    InvalidBlockType: 1,\n    InvalidLengthLiteral: 2,\n    InvalidDistance: 3,\n    StreamFinished: 4,\n    NoStreamHandler: 5,\n    InvalidHeader: 6,\n    NoCallback: 7,\n    InvalidUTF8: 8,\n    ExtraFieldTooLong: 9,\n    InvalidDate: 10,\n    FilenameTooLong: 11,\n    StreamFinishing: 12,\n    InvalidZipData: 13,\n    UnknownCompressionMethod: 14\n};\n// error codes\nvar ec = [\n    'unexpected EOF',\n    'invalid block type',\n    'invalid length/literal',\n    'invalid distance',\n    'stream finished',\n    'no stream handler',\n    ,\n    'no callback',\n    'invalid UTF-8 data',\n    'extra field too long',\n    'date not in range 1980-2099',\n    'filename too long',\n    'stream finishing',\n    'invalid zip data'\n    // determined by unknown compression method\n];\n;\nvar err = function (ind, msg, nt) {\n    var e = new Error(msg || ec[ind]);\n    e.code = ind;\n    if (Error.captureStackTrace)\n        Error.captureStackTrace(e, err);\n    if (!nt)\n        throw e;\n    return e;\n};\n// expands raw DEFLATE data\nvar inflt = function (dat, st, buf, dict) {\n    // source length       dict length\n    var sl = dat.length, dl = dict ? dict.length : 0;\n    if (!sl || st.f && !st.l)\n        return buf || new u8(0);\n    var noBuf = !buf;\n    // have to estimate size\n    var resize = noBuf || st.i != 2;\n    // no state\n    var noSt = st.i;\n    // Assumes roughly 33% compression ratio average\n    if (noBuf)\n        buf = new u8(sl * 3);\n    // ensure buffer can fit at least l elements\n    var cbuf = function (l) {\n        var bl = buf.length;\n        // need to increase size to fit\n        if (l > bl) {\n            // Double or set to necessary, whichever is greater\n            var nbuf = new u8(Math.max(bl * 2, l));\n            nbuf.set(buf);\n            buf = nbuf;\n        }\n    };\n    //  last chunk         bitpos           bytes\n    var final = st.f || 0, pos = st.p || 0, bt = st.b || 0, lm = st.l, dm = st.d, lbt = st.m, dbt = st.n;\n    // total bits\n    var tbts = sl * 8;\n    do {\n        if (!lm) {\n            // BFINAL - this is only 1 when last chunk is next\n            final = bits(dat, pos, 1);\n            // type: 0 = no compression, 1 = fixed huffman, 2 = dynamic huffman\n            var type = bits(dat, pos + 1, 3);\n            pos += 3;\n            if (!type) {\n                // go to end of byte boundary\n                var s = shft(pos) + 4, l = dat[s - 4] | (dat[s - 3] << 8), t = s + l;\n                if (t > sl) {\n                    if (noSt)\n                        err(0);\n                    break;\n                }\n                // ensure size\n                if (resize)\n                    cbuf(bt + l);\n                // Copy over uncompressed data\n                buf.set(dat.subarray(s, t), bt);\n                // Get new bitpos, update byte count\n                st.b = bt += l, st.p = pos = t * 8, st.f = final;\n                continue;\n            }\n            else if (type == 1)\n                lm = flrm, dm = fdrm, lbt = 9, dbt = 5;\n            else if (type == 2) {\n                //  literal                            lengths\n                var hLit = bits(dat, pos, 31) + 257, hcLen = bits(dat, pos + 10, 15) + 4;\n                var tl = hLit + bits(dat, pos + 5, 31) + 1;\n                pos += 14;\n                // length+distance tree\n                var ldt = new u8(tl);\n                // code length tree\n                var clt = new u8(19);\n                for (var i = 0; i < hcLen; ++i) {\n                    // use index map to get real code\n                    clt[clim[i]] = bits(dat, pos + i * 3, 7);\n                }\n                pos += hcLen * 3;\n                // code lengths bits\n                var clb = max(clt), clbmsk = (1 << clb) - 1;\n                // code lengths map\n                var clm = hMap(clt, clb, 1);\n                for (var i = 0; i < tl;) {\n                    var r = clm[bits(dat, pos, clbmsk)];\n                    // bits read\n                    pos += r & 15;\n                    // symbol\n                    var s = r >> 4;\n                    // code length to copy\n                    if (s < 16) {\n                        ldt[i++] = s;\n                    }\n                    else {\n                        //  copy   count\n                        var c = 0, n = 0;\n                        if (s == 16)\n                            n = 3 + bits(dat, pos, 3), pos += 2, c = ldt[i - 1];\n                        else if (s == 17)\n                            n = 3 + bits(dat, pos, 7), pos += 3;\n                        else if (s == 18)\n                            n = 11 + bits(dat, pos, 127), pos += 7;\n                        while (n--)\n                            ldt[i++] = c;\n                    }\n                }\n                //    length tree                 distance tree\n                var lt = ldt.subarray(0, hLit), dt = ldt.subarray(hLit);\n                // max length bits\n                lbt = max(lt);\n                // max dist bits\n                dbt = max(dt);\n                lm = hMap(lt, lbt, 1);\n                dm = hMap(dt, dbt, 1);\n            }\n            else\n                err(1);\n            if (pos > tbts) {\n                if (noSt)\n                    err(0);\n                break;\n            }\n        }\n        // Make sure the buffer can hold this + the largest possible addition\n        // Maximum chunk size (practically, theoretically infinite) is 2^17\n        if (resize)\n            cbuf(bt + 131072);\n        var lms = (1 << lbt) - 1, dms = (1 << dbt) - 1;\n        var lpos = pos;\n        for (;; lpos = pos) {\n            // bits read, code\n            var c = lm[bits16(dat, pos) & lms], sym = c >> 4;\n            pos += c & 15;\n            if (pos > tbts) {\n                if (noSt)\n                    err(0);\n                break;\n            }\n            if (!c)\n                err(2);\n            if (sym < 256)\n                buf[bt++] = sym;\n            else if (sym == 256) {\n                lpos = pos, lm = null;\n                break;\n            }\n            else {\n                var add = sym - 254;\n                // no extra bits needed if less\n                if (sym > 264) {\n                    // index\n                    var i = sym - 257, b = fleb[i];\n                    add = bits(dat, pos, (1 << b) - 1) + fl[i];\n                    pos += b;\n                }\n                // dist\n                var d = dm[bits16(dat, pos) & dms], dsym = d >> 4;\n                if (!d)\n                    err(3);\n                pos += d & 15;\n                var dt = fd[dsym];\n                if (dsym > 3) {\n                    var b = fdeb[dsym];\n                    dt += bits16(dat, pos) & (1 << b) - 1, pos += b;\n                }\n                if (pos > tbts) {\n                    if (noSt)\n                        err(0);\n                    break;\n                }\n                if (resize)\n                    cbuf(bt + 131072);\n                var end = bt + add;\n                if (bt < dt) {\n                    var shift = dl - dt, dend = Math.min(dt, end);\n                    if (shift + bt < 0)\n                        err(3);\n                    for (; bt < dend; ++bt)\n                        buf[bt] = dict[shift + bt];\n                }\n                for (; bt < end; ++bt)\n                    buf[bt] = buf[bt - dt];\n            }\n        }\n        st.l = lm, st.p = lpos, st.b = bt, st.f = final;\n        if (lm)\n            final = 1, st.m = lbt, st.d = dm, st.n = dbt;\n    } while (!final);\n    // don't reallocate for streams or user buffers\n    return bt != buf.length && noBuf ? slc(buf, 0, bt) : buf.subarray(0, bt);\n};\n// starting at p, write the minimum number of bits that can hold v to d\nvar wbits = function (d, p, v) {\n    v <<= p & 7;\n    var o = (p / 8) | 0;\n    d[o] |= v;\n    d[o + 1] |= v >> 8;\n};\n// starting at p, write the minimum number of bits (>8) that can hold v to d\nvar wbits16 = function (d, p, v) {\n    v <<= p & 7;\n    var o = (p / 8) | 0;\n    d[o] |= v;\n    d[o + 1] |= v >> 8;\n    d[o + 2] |= v >> 16;\n};\n// creates code lengths from a frequency table\nvar hTree = function (d, mb) {\n    // Need extra info to make a tree\n    var t = [];\n    for (var i = 0; i < d.length; ++i) {\n        if (d[i])\n            t.push({ s: i, f: d[i] });\n    }\n    var s = t.length;\n    var t2 = t.slice();\n    if (!s)\n        return { t: et, l: 0 };\n    if (s == 1) {\n        var v = new u8(t[0].s + 1);\n        v[t[0].s] = 1;\n        return { t: v, l: 1 };\n    }\n    t.sort(function (a, b) { return a.f - b.f; });\n    // after i2 reaches last ind, will be stopped\n    // freq must be greater than largest possible number of symbols\n    t.push({ s: -1, f: 25001 });\n    var l = t[0], r = t[1], i0 = 0, i1 = 1, i2 = 2;\n    t[0] = { s: -1, f: l.f + r.f, l: l, r: r };\n    // efficient algorithm from UZIP.js\n    // i0 is lookbehind, i2 is lookahead - after processing two low-freq\n    // symbols that combined have high freq, will start processing i2 (high-freq,\n    // non-composite) symbols instead\n    // see https://reddit.com/r/photopea/comments/ikekht/uzipjs_questions/\n    while (i1 != s - 1) {\n        l = t[t[i0].f < t[i2].f ? i0++ : i2++];\n        r = t[i0 != i1 && t[i0].f < t[i2].f ? i0++ : i2++];\n        t[i1++] = { s: -1, f: l.f + r.f, l: l, r: r };\n    }\n    var maxSym = t2[0].s;\n    for (var i = 1; i < s; ++i) {\n        if (t2[i].s > maxSym)\n            maxSym = t2[i].s;\n    }\n    // code lengths\n    var tr = new u16(maxSym + 1);\n    // max bits in tree\n    var mbt = ln(t[i1 - 1], tr, 0);\n    if (mbt > mb) {\n        // more algorithms from UZIP.js\n        // TODO: find out how this code works (debt)\n        //  ind    debt\n        var i = 0, dt = 0;\n        //    left            cost\n        var lft = mbt - mb, cst = 1 << lft;\n        t2.sort(function (a, b) { return tr[b.s] - tr[a.s] || a.f - b.f; });\n        for (; i < s; ++i) {\n            var i2_1 = t2[i].s;\n            if (tr[i2_1] > mb) {\n                dt += cst - (1 << (mbt - tr[i2_1]));\n                tr[i2_1] = mb;\n            }\n            else\n                break;\n        }\n        dt >>= lft;\n        while (dt > 0) {\n            var i2_2 = t2[i].s;\n            if (tr[i2_2] < mb)\n                dt -= 1 << (mb - tr[i2_2]++ - 1);\n            else\n                ++i;\n        }\n        for (; i >= 0 && dt; --i) {\n            var i2_3 = t2[i].s;\n            if (tr[i2_3] == mb) {\n                --tr[i2_3];\n                ++dt;\n            }\n        }\n        mbt = mb;\n    }\n    return { t: new u8(tr), l: mbt };\n};\n// get the max length and assign length codes\nvar ln = function (n, l, d) {\n    return n.s == -1\n        ? Math.max(ln(n.l, l, d + 1), ln(n.r, l, d + 1))\n        : (l[n.s] = d);\n};\n// length codes generation\nvar lc = function (c) {\n    var s = c.length;\n    // Note that the semicolon was intentional\n    while (s && !c[--s])\n        ;\n    var cl = new u16(++s);\n    //  ind      num         streak\n    var cli = 0, cln = c[0], cls = 1;\n    var w = function (v) { cl[cli++] = v; };\n    for (var i = 1; i <= s; ++i) {\n        if (c[i] == cln && i != s)\n            ++cls;\n        else {\n            if (!cln && cls > 2) {\n                for (; cls > 138; cls -= 138)\n                    w(32754);\n                if (cls > 2) {\n                    w(cls > 10 ? ((cls - 11) << 5) | 28690 : ((cls - 3) << 5) | 12305);\n                    cls = 0;\n                }\n            }\n            else if (cls > 3) {\n                w(cln), --cls;\n                for (; cls > 6; cls -= 6)\n                    w(8304);\n                if (cls > 2)\n                    w(((cls - 3) << 5) | 8208), cls = 0;\n            }\n            while (cls--)\n                w(cln);\n            cls = 1;\n            cln = c[i];\n        }\n    }\n    return { c: cl.subarray(0, cli), n: s };\n};\n// calculate the length of output from tree, code lengths\nvar clen = function (cf, cl) {\n    var l = 0;\n    for (var i = 0; i < cl.length; ++i)\n        l += cf[i] * cl[i];\n    return l;\n};\n// writes a fixed block\n// returns the new bit pos\nvar wfblk = function (out, pos, dat) {\n    // no need to write 00 as type: TypedArray defaults to 0\n    var s = dat.length;\n    var o = shft(pos + 2);\n    out[o] = s & 255;\n    out[o + 1] = s >> 8;\n    out[o + 2] = out[o] ^ 255;\n    out[o + 3] = out[o + 1] ^ 255;\n    for (var i = 0; i < s; ++i)\n        out[o + i + 4] = dat[i];\n    return (o + 4 + s) * 8;\n};\n// writes a block\nvar wblk = function (dat, out, final, syms, lf, df, eb, li, bs, bl, p) {\n    wbits(out, p++, final);\n    ++lf[256];\n    var _a = hTree(lf, 15), dlt = _a.t, mlb = _a.l;\n    var _b = hTree(df, 15), ddt = _b.t, mdb = _b.l;\n    var _c = lc(dlt), lclt = _c.c, nlc = _c.n;\n    var _d = lc(ddt), lcdt = _d.c, ndc = _d.n;\n    var lcfreq = new u16(19);\n    for (var i = 0; i < lclt.length; ++i)\n        ++lcfreq[lclt[i] & 31];\n    for (var i = 0; i < lcdt.length; ++i)\n        ++lcfreq[lcdt[i] & 31];\n    var _e = hTree(lcfreq, 7), lct = _e.t, mlcb = _e.l;\n    var nlcc = 19;\n    for (; nlcc > 4 && !lct[clim[nlcc - 1]]; --nlcc)\n        ;\n    var flen = (bl + 5) << 3;\n    var ftlen = clen(lf, flt) + clen(df, fdt) + eb;\n    var dtlen = clen(lf, dlt) + clen(df, ddt) + eb + 14 + 3 * nlcc + clen(lcfreq, lct) + 2 * lcfreq[16] + 3 * lcfreq[17] + 7 * lcfreq[18];\n    if (bs >= 0 && flen <= ftlen && flen <= dtlen)\n        return wfblk(out, p, dat.subarray(bs, bs + bl));\n    var lm, ll, dm, dl;\n    wbits(out, p, 1 + (dtlen < ftlen)), p += 2;\n    if (dtlen < ftlen) {\n        lm = hMap(dlt, mlb, 0), ll = dlt, dm = hMap(ddt, mdb, 0), dl = ddt;\n        var llm = hMap(lct, mlcb, 0);\n        wbits(out, p, nlc - 257);\n        wbits(out, p + 5, ndc - 1);\n        wbits(out, p + 10, nlcc - 4);\n        p += 14;\n        for (var i = 0; i < nlcc; ++i)\n            wbits(out, p + 3 * i, lct[clim[i]]);\n        p += 3 * nlcc;\n        var lcts = [lclt, lcdt];\n        for (var it = 0; it < 2; ++it) {\n            var clct = lcts[it];\n            for (var i = 0; i < clct.length; ++i) {\n                var len = clct[i] & 31;\n                wbits(out, p, llm[len]), p += lct[len];\n                if (len > 15)\n                    wbits(out, p, (clct[i] >> 5) & 127), p += clct[i] >> 12;\n            }\n        }\n    }\n    else {\n        lm = flm, ll = flt, dm = fdm, dl = fdt;\n    }\n    for (var i = 0; i < li; ++i) {\n        var sym = syms[i];\n        if (sym > 255) {\n            var len = (sym >> 18) & 31;\n            wbits16(out, p, lm[len + 257]), p += ll[len + 257];\n            if (len > 7)\n                wbits(out, p, (sym >> 23) & 31), p += fleb[len];\n            var dst = sym & 31;\n            wbits16(out, p, dm[dst]), p += dl[dst];\n            if (dst > 3)\n                wbits16(out, p, (sym >> 5) & 8191), p += fdeb[dst];\n        }\n        else {\n            wbits16(out, p, lm[sym]), p += ll[sym];\n        }\n    }\n    wbits16(out, p, lm[256]);\n    return p + ll[256];\n};\n// deflate options (nice << 13) | chain\nvar deo = /*#__PURE__*/ new i32([65540, 131080, 131088, 131104, 262176, 1048704, 1048832, 2114560, 2117632]);\n// empty\nvar et = /*#__PURE__*/ new u8(0);\n// compresses data into a raw DEFLATE buffer\nvar dflt = function (dat, lvl, plvl, pre, post, st) {\n    var s = st.z || dat.length;\n    var o = new u8(pre + s + 5 * (1 + Math.ceil(s / 7000)) + post);\n    // writing to this writes to the output buffer\n    var w = o.subarray(pre, o.length - post);\n    var lst = st.l;\n    var pos = (st.r || 0) & 7;\n    if (lvl) {\n        if (pos)\n            w[0] = st.r >> 3;\n        var opt = deo[lvl - 1];\n        var n = opt >> 13, c = opt & 8191;\n        var msk_1 = (1 << plvl) - 1;\n        //    prev 2-byte val map    curr 2-byte val map\n        var prev = st.p || new u16(32768), head = st.h || new u16(msk_1 + 1);\n        var bs1_1 = Math.ceil(plvl / 3), bs2_1 = 2 * bs1_1;\n        var hsh = function (i) { return (dat[i] ^ (dat[i + 1] << bs1_1) ^ (dat[i + 2] << bs2_1)) & msk_1; };\n        // 24576 is an arbitrary number of maximum symbols per block\n        // 424 buffer for last block\n        var syms = new i32(25000);\n        // length/literal freq   distance freq\n        var lf = new u16(288), df = new u16(32);\n        //  l/lcnt  exbits  index          l/lind  waitdx          blkpos\n        var lc_1 = 0, eb = 0, i = st.i || 0, li = 0, wi = st.w || 0, bs = 0;\n        for (; i + 2 < s; ++i) {\n            // hash value\n            var hv = hsh(i);\n            // index mod 32768    previous index mod\n            var imod = i & 32767, pimod = head[hv];\n            prev[imod] = pimod;\n            head[hv] = imod;\n            // We always should modify head and prev, but only add symbols if\n            // this data is not yet processed (\"wait\" for wait index)\n            if (wi <= i) {\n                // bytes remaining\n                var rem = s - i;\n                if ((lc_1 > 7000 || li > 24576) && (rem > 423 || !lst)) {\n                    pos = wblk(dat, w, 0, syms, lf, df, eb, li, bs, i - bs, pos);\n                    li = lc_1 = eb = 0, bs = i;\n                    for (var j = 0; j < 286; ++j)\n                        lf[j] = 0;\n                    for (var j = 0; j < 30; ++j)\n                        df[j] = 0;\n                }\n                //  len    dist   chain\n                var l = 2, d = 0, ch_1 = c, dif = imod - pimod & 32767;\n                if (rem > 2 && hv == hsh(i - dif)) {\n                    var maxn = Math.min(n, rem) - 1;\n                    var maxd = Math.min(32767, i);\n                    // max possible length\n                    // not capped at dif because decompressors implement \"rolling\" index population\n                    var ml = Math.min(258, rem);\n                    while (dif <= maxd && --ch_1 && imod != pimod) {\n                        if (dat[i + l] == dat[i + l - dif]) {\n                            var nl = 0;\n                            for (; nl < ml && dat[i + nl] == dat[i + nl - dif]; ++nl)\n                                ;\n                            if (nl > l) {\n                                l = nl, d = dif;\n                                // break out early when we reach \"nice\" (we are satisfied enough)\n                                if (nl > maxn)\n                                    break;\n                                // now, find the rarest 2-byte sequence within this\n                                // length of literals and search for that instead.\n                                // Much faster than just using the start\n                                var mmd = Math.min(dif, nl - 2);\n                                var md = 0;\n                                for (var j = 0; j < mmd; ++j) {\n                                    var ti = i - dif + j & 32767;\n                                    var pti = prev[ti];\n                                    var cd = ti - pti & 32767;\n                                    if (cd > md)\n                                        md = cd, pimod = ti;\n                                }\n                            }\n                        }\n                        // check the previous match\n                        imod = pimod, pimod = prev[imod];\n                        dif += imod - pimod & 32767;\n                    }\n                }\n                // d will be nonzero only when a match was found\n                if (d) {\n                    // store both dist and len data in one int32\n                    // Make sure this is recognized as a len/dist with 28th bit (2^28)\n                    syms[li++] = 268435456 | (revfl[l] << 18) | revfd[d];\n                    var lin = revfl[l] & 31, din = revfd[d] & 31;\n                    eb += fleb[lin] + fdeb[din];\n                    ++lf[257 + lin];\n                    ++df[din];\n                    wi = i + l;\n                    ++lc_1;\n                }\n                else {\n                    syms[li++] = dat[i];\n                    ++lf[dat[i]];\n                }\n            }\n        }\n        for (i = Math.max(i, wi); i < s; ++i) {\n            syms[li++] = dat[i];\n            ++lf[dat[i]];\n        }\n        pos = wblk(dat, w, lst, syms, lf, df, eb, li, bs, i - bs, pos);\n        if (!lst) {\n            st.r = (pos & 7) | w[(pos / 8) | 0] << 3;\n            // shft(pos) now 1 less if pos & 7 != 0\n            pos -= 7;\n            st.h = head, st.p = prev, st.i = i, st.w = wi;\n        }\n    }\n    else {\n        for (var i = st.w || 0; i < s + lst; i += 65535) {\n            // end\n            var e = i + 65535;\n            if (e >= s) {\n                // write final block\n                w[(pos / 8) | 0] = lst;\n                e = s;\n            }\n            pos = wfblk(w, pos + 1, dat.subarray(i, e));\n        }\n        st.i = s;\n    }\n    return slc(o, 0, pre + shft(pos) + post);\n};\n// CRC32 table\nvar crct = /*#__PURE__*/ (function () {\n    var t = new Int32Array(256);\n    for (var i = 0; i < 256; ++i) {\n        var c = i, k = 9;\n        while (--k)\n            c = ((c & 1) && -306674912) ^ (c >>> 1);\n        t[i] = c;\n    }\n    return t;\n})();\n// CRC32\nvar crc = function () {\n    var c = -1;\n    return {\n        p: function (d) {\n            // closures have awful performance\n            var cr = c;\n            for (var i = 0; i < d.length; ++i)\n                cr = crct[(cr & 255) ^ d[i]] ^ (cr >>> 8);\n            c = cr;\n        },\n        d: function () { return ~c; }\n    };\n};\n// Adler32\nvar adler = function () {\n    var a = 1, b = 0;\n    return {\n        p: function (d) {\n            // closures have awful performance\n            var n = a, m = b;\n            var l = d.length | 0;\n            for (var i = 0; i != l;) {\n                var e = Math.min(i + 2655, l);\n                for (; i < e; ++i)\n                    m += n += d[i];\n                n = (n & 65535) + 15 * (n >> 16), m = (m & 65535) + 15 * (m >> 16);\n            }\n            a = n, b = m;\n        },\n        d: function () {\n            a %= 65521, b %= 65521;\n            return (a & 255) << 24 | (a & 0xFF00) << 8 | (b & 255) << 8 | (b >> 8);\n        }\n    };\n};\n;\n// deflate with opts\nvar dopt = function (dat, opt, pre, post, st) {\n    if (!st) {\n        st = { l: 1 };\n        if (opt.dictionary) {\n            var dict = opt.dictionary.subarray(-32768);\n            var newDat = new u8(dict.length + dat.length);\n            newDat.set(dict);\n            newDat.set(dat, dict.length);\n            dat = newDat;\n            st.w = dict.length;\n        }\n    }\n    return dflt(dat, opt.level == null ? 6 : opt.level, opt.mem == null ? (st.l ? Math.ceil(Math.max(8, Math.min(13, Math.log(dat.length))) * 1.5) : 20) : (12 + opt.mem), pre, post, st);\n};\n// Walmart object spread\nvar mrg = function (a, b) {\n    var o = {};\n    for (var k in a)\n        o[k] = a[k];\n    for (var k in b)\n        o[k] = b[k];\n    return o;\n};\n// worker clone\n// This is possibly the craziest part of the entire codebase, despite how simple it may seem.\n// The only parameter to this function is a closure that returns an array of variables outside of the function scope.\n// We're going to try to figure out the variable names used in the closure as strings because that is crucial for workerization.\n// We will return an object mapping of true variable name to value (basically, the current scope as a JS object).\n// The reason we can't just use the original variable names is minifiers mangling the toplevel scope.\n// This took me three weeks to figure out how to do.\nvar wcln = function (fn, fnStr, td) {\n    var dt = fn();\n    var st = fn.toString();\n    var ks = st.slice(st.indexOf('[') + 1, st.lastIndexOf(']')).replace(/\\s+/g, '').split(',');\n    for (var i = 0; i < dt.length; ++i) {\n        var v = dt[i], k = ks[i];\n        if (typeof v == 'function') {\n            fnStr += ';' + k + '=';\n            var st_1 = v.toString();\n            if (v.prototype) {\n                // for global objects\n                if (st_1.indexOf('[native code]') != -1) {\n                    var spInd = st_1.indexOf(' ', 8) + 1;\n                    fnStr += st_1.slice(spInd, st_1.indexOf('(', spInd));\n                }\n                else {\n                    fnStr += st_1;\n                    for (var t in v.prototype)\n                        fnStr += ';' + k + '.prototype.' + t + '=' + v.prototype[t].toString();\n                }\n            }\n            else\n                fnStr += st_1;\n        }\n        else\n            td[k] = v;\n    }\n    return fnStr;\n};\nvar ch = [];\n// clone bufs\nvar cbfs = function (v) {\n    var tl = [];\n    for (var k in v) {\n        if (v[k].buffer) {\n            tl.push((v[k] = new v[k].constructor(v[k])).buffer);\n        }\n    }\n    return tl;\n};\n// use a worker to execute code\nvar wrkr = function (fns, init, id, cb) {\n    if (!ch[id]) {\n        var fnStr = '', td_1 = {}, m = fns.length - 1;\n        for (var i = 0; i < m; ++i)\n            fnStr = wcln(fns[i], fnStr, td_1);\n        ch[id] = { c: wcln(fns[m], fnStr, td_1), e: td_1 };\n    }\n    var td = mrg({}, ch[id].e);\n    return wk(ch[id].c + ';onmessage=function(e){for(var k in e.data)self[k]=e.data[k];onmessage=' + init.toString() + '}', id, td, cbfs(td), cb);\n};\n// base async inflate fn\nvar bInflt = function () { return [u8, u16, i32, fleb, fdeb, clim, fl, fd, flrm, fdrm, rev, ec, hMap, max, bits, bits16, shft, slc, err, inflt, inflateSync, pbf, gopt]; };\nvar bDflt = function () { return [u8, u16, i32, fleb, fdeb, clim, revfl, revfd, flm, flt, fdm, fdt, rev, deo, et, hMap, wbits, wbits16, hTree, ln, lc, clen, wfblk, wblk, shft, slc, dflt, dopt, deflateSync, pbf]; };\n// gzip extra\nvar gze = function () { return [gzh, gzhl, wbytes, crc, crct]; };\n// gunzip extra\nvar guze = function () { return [gzs, gzl]; };\n// zlib extra\nvar zle = function () { return [zlh, wbytes, adler]; };\n// unzlib extra\nvar zule = function () { return [zls]; };\n// post buf\nvar pbf = function (msg) { return postMessage(msg, [msg.buffer]); };\n// get opts\nvar gopt = function (o) { return o && {\n    out: o.size && new u8(o.size),\n    dictionary: o.dictionary\n}; };\n// async helper\nvar cbify = function (dat, opts, fns, init, id, cb) {\n    var w = wrkr(fns, init, id, function (err, dat) {\n        w.terminate();\n        cb(err, dat);\n    });\n    w.postMessage([dat, opts], opts.consume ? [dat.buffer] : []);\n    return function () { w.terminate(); };\n};\n// auto stream\nvar astrm = function (strm) {\n    strm.ondata = function (dat, final) { return postMessage([dat, final], [dat.buffer]); };\n    return function (ev) {\n        if (ev.data.length) {\n            strm.push(ev.data[0], ev.data[1]);\n            postMessage([ev.data[0].length]);\n        }\n        else\n            strm.flush();\n    };\n};\n// async stream attach\nvar astrmify = function (fns, strm, opts, init, id, flush, ext) {\n    var t;\n    var w = wrkr(fns, init, id, function (err, dat) {\n        if (err)\n            w.terminate(), strm.ondata.call(strm, err);\n        else if (!Array.isArray(dat))\n            ext(dat);\n        else if (dat.length == 1) {\n            strm.queuedSize -= dat[0];\n            if (strm.ondrain)\n                strm.ondrain(dat[0]);\n        }\n        else {\n            if (dat[1])\n                w.terminate();\n            strm.ondata.call(strm, err, dat[0], dat[1]);\n        }\n    });\n    w.postMessage(opts);\n    strm.queuedSize = 0;\n    strm.push = function (d, f) {\n        if (!strm.ondata)\n            err(5);\n        if (t)\n            strm.ondata(err(4, 0, 1), null, !!f);\n        strm.queuedSize += d.length;\n        w.postMessage([d, t = f], [d.buffer]);\n    };\n    strm.terminate = function () { w.terminate(); };\n    if (flush) {\n        strm.flush = function () { w.postMessage([]); };\n    }\n};\n// read 2 bytes\nvar b2 = function (d, b) { return d[b] | (d[b + 1] << 8); };\n// read 4 bytes\nvar b4 = function (d, b) { return (d[b] | (d[b + 1] << 8) | (d[b + 2] << 16) | (d[b + 3] << 24)) >>> 0; };\nvar b8 = function (d, b) { return b4(d, b) + (b4(d, b + 4) * 4294967296); };\n// write bytes\nvar wbytes = function (d, b, v) {\n    for (; v; ++b)\n        d[b] = v, v >>>= 8;\n};\n// gzip header\nvar gzh = function (c, o) {\n    var fn = o.filename;\n    c[0] = 31, c[1] = 139, c[2] = 8, c[8] = o.level < 2 ? 4 : o.level == 9 ? 2 : 0, c[9] = 3; // assume Unix\n    if (o.mtime != 0)\n        wbytes(c, 4, Math.floor(new Date(o.mtime || Date.now()) / 1000));\n    if (fn) {\n        c[3] = 8;\n        for (var i = 0; i <= fn.length; ++i)\n            c[i + 10] = fn.charCodeAt(i);\n    }\n};\n// gzip footer: -8 to -4 = CRC, -4 to -0 is length\n// gzip start\nvar gzs = function (d) {\n    if (d[0] != 31 || d[1] != 139 || d[2] != 8)\n        err(6, 'invalid gzip data');\n    var flg = d[3];\n    var st = 10;\n    if (flg & 4)\n        st += (d[10] | d[11] << 8) + 2;\n    for (var zs = (flg >> 3 & 1) + (flg >> 4 & 1); zs > 0; zs -= !d[st++])\n        ;\n    return st + (flg & 2);\n};\n// gzip length\nvar gzl = function (d) {\n    var l = d.length;\n    return (d[l - 4] | d[l - 3] << 8 | d[l - 2] << 16 | d[l - 1] << 24) >>> 0;\n};\n// gzip header length\nvar gzhl = function (o) { return 10 + (o.filename ? o.filename.length + 1 : 0); };\n// zlib header\nvar zlh = function (c, o) {\n    var lv = o.level, fl = lv == 0 ? 0 : lv < 6 ? 1 : lv == 9 ? 3 : 2;\n    c[0] = 120, c[1] = (fl << 6) | (o.dictionary && 32);\n    c[1] |= 31 - ((c[0] << 8) | c[1]) % 31;\n    if (o.dictionary) {\n        var h = adler();\n        h.p(o.dictionary);\n        wbytes(c, 2, h.d());\n    }\n};\n// zlib start\nvar zls = function (d, dict) {\n    if ((d[0] & 15) != 8 || (d[0] >> 4) > 7 || ((d[0] << 8 | d[1]) % 31))\n        err(6, 'invalid zlib data');\n    if ((d[1] >> 5 & 1) == +!dict)\n        err(6, 'invalid zlib data: ' + (d[1] & 32 ? 'need' : 'unexpected') + ' dictionary');\n    return (d[1] >> 3 & 4) + 2;\n};\nfunction StrmOpt(opts, cb) {\n    if (typeof opts == 'function')\n        cb = opts, opts = {};\n    this.ondata = cb;\n    return opts;\n}\n/**\n * Streaming DEFLATE compression\n */\nvar Deflate = /*#__PURE__*/ (function () {\n    function Deflate(opts, cb) {\n        if (typeof opts == 'function')\n            cb = opts, opts = {};\n        this.ondata = cb;\n        this.o = opts || {};\n        this.s = { l: 0, i: 32768, w: 32768, z: 32768 };\n        // Buffer length must always be 0 mod 32768 for index calculations to be correct when modifying head and prev\n        // 98304 = 32768 (lookback) + 65536 (common chunk size)\n        this.b = new u8(98304);\n        if (this.o.dictionary) {\n            var dict = this.o.dictionary.subarray(-32768);\n            this.b.set(dict, 32768 - dict.length);\n            this.s.i = 32768 - dict.length;\n        }\n    }\n    Deflate.prototype.p = function (c, f) {\n        this.ondata(dopt(c, this.o, 0, 0, this.s), f);\n    };\n    /**\n     * Pushes a chunk to be deflated\n     * @param chunk The chunk to push\n     * @param final Whether this is the last chunk\n     */\n    Deflate.prototype.push = function (chunk, final) {\n        if (!this.ondata)\n            err(5);\n        if (this.s.l)\n            err(4);\n        var endLen = chunk.length + this.s.z;\n        if (endLen > this.b.length) {\n            if (endLen > 2 * this.b.length - 32768) {\n                var newBuf = new u8(endLen & -32768);\n                newBuf.set(this.b.subarray(0, this.s.z));\n                this.b = newBuf;\n            }\n            var split = this.b.length - this.s.z;\n            this.b.set(chunk.subarray(0, split), this.s.z);\n            this.s.z = this.b.length;\n            this.p(this.b, false);\n            this.b.set(this.b.subarray(-32768));\n            this.b.set(chunk.subarray(split), 32768);\n            this.s.z = chunk.length - split + 32768;\n            this.s.i = 32766, this.s.w = 32768;\n        }\n        else {\n            this.b.set(chunk, this.s.z);\n            this.s.z += chunk.length;\n        }\n        this.s.l = final & 1;\n        if (this.s.z > this.s.w + 8191 || final) {\n            this.p(this.b, final || false);\n            this.s.w = this.s.i, this.s.i -= 2;\n        }\n    };\n    /**\n     * Flushes buffered uncompressed data. Useful to immediately retrieve the\n     * deflated output for small inputs.\n     */\n    Deflate.prototype.flush = function () {\n        if (!this.ondata)\n            err(5);\n        if (this.s.l)\n            err(4);\n        this.p(this.b, false);\n        this.s.w = this.s.i, this.s.i -= 2;\n    };\n    return Deflate;\n}());\nexport { Deflate };\n/**\n * Asynchronous streaming DEFLATE compression\n */\nvar AsyncDeflate = /*#__PURE__*/ (function () {\n    function AsyncDeflate(opts, cb) {\n        astrmify([\n            bDflt,\n            function () { return [astrm, Deflate]; }\n        ], this, StrmOpt.call(this, opts, cb), function (ev) {\n            var strm = new Deflate(ev.data);\n            onmessage = astrm(strm);\n        }, 6, 1);\n    }\n    return AsyncDeflate;\n}());\nexport { AsyncDeflate };\nexport function deflate(data, opts, cb) {\n    if (!cb)\n        cb = opts, opts = {};\n    if (typeof cb != 'function')\n        err(7);\n    return cbify(data, opts, [\n        bDflt,\n    ], function (ev) { return pbf(deflateSync(ev.data[0], ev.data[1])); }, 0, cb);\n}\n/**\n * Compresses data with DEFLATE without any wrapper\n * @param data The data to compress\n * @param opts The compression options\n * @returns The deflated version of the data\n */\nexport function deflateSync(data, opts) {\n    return dopt(data, opts || {}, 0, 0);\n}\n/**\n * Streaming DEFLATE decompression\n */\nvar Inflate = /*#__PURE__*/ (function () {\n    function Inflate(opts, cb) {\n        // no StrmOpt here to avoid adding to workerizer\n        if (typeof opts == 'function')\n            cb = opts, opts = {};\n        this.ondata = cb;\n        var dict = opts && opts.dictionary && opts.dictionary.subarray(-32768);\n        this.s = { i: 0, b: dict ? dict.length : 0 };\n        this.o = new u8(32768);\n        this.p = new u8(0);\n        if (dict)\n            this.o.set(dict);\n    }\n    Inflate.prototype.e = function (c) {\n        if (!this.ondata)\n            err(5);\n        if (this.d)\n            err(4);\n        if (!this.p.length)\n            this.p = c;\n        else if (c.length) {\n            var n = new u8(this.p.length + c.length);\n            n.set(this.p), n.set(c, this.p.length), this.p = n;\n        }\n    };\n    Inflate.prototype.c = function (final) {\n        this.s.i = +(this.d = final || false);\n        var bts = this.s.b;\n        var dt = inflt(this.p, this.s, this.o);\n        this.ondata(slc(dt, bts, this.s.b), this.d);\n        this.o = slc(dt, this.s.b - 32768), this.s.b = this.o.length;\n        this.p = slc(this.p, (this.s.p / 8) | 0), this.s.p &= 7;\n    };\n    /**\n     * Pushes a chunk to be inflated\n     * @param chunk The chunk to push\n     * @param final Whether this is the final chunk\n     */\n    Inflate.prototype.push = function (chunk, final) {\n        this.e(chunk), this.c(final);\n    };\n    return Inflate;\n}());\nexport { Inflate };\n/**\n * Asynchronous streaming DEFLATE decompression\n */\nvar AsyncInflate = /*#__PURE__*/ (function () {\n    function AsyncInflate(opts, cb) {\n        astrmify([\n            bInflt,\n            function () { return [astrm, Inflate]; }\n        ], this, StrmOpt.call(this, opts, cb), function (ev) {\n            var strm = new Inflate(ev.data);\n            onmessage = astrm(strm);\n        }, 7, 0);\n    }\n    return AsyncInflate;\n}());\nexport { AsyncInflate };\nexport function inflate(data, opts, cb) {\n    if (!cb)\n        cb = opts, opts = {};\n    if (typeof cb != 'function')\n        err(7);\n    return cbify(data, opts, [\n        bInflt\n    ], function (ev) { return pbf(inflateSync(ev.data[0], gopt(ev.data[1]))); }, 1, cb);\n}\n/**\n * Expands DEFLATE data with no wrapper\n * @param data The data to decompress\n * @param opts The decompression options\n * @returns The decompressed version of the data\n */\nexport function inflateSync(data, opts) {\n    return inflt(data, { i: 2 }, opts && opts.out, opts && opts.dictionary);\n}\n// before you yell at me for not just using extends, my reason is that TS inheritance is hard to workerize.\n/**\n * Streaming GZIP compression\n */\nvar Gzip = /*#__PURE__*/ (function () {\n    function Gzip(opts, cb) {\n        this.c = crc();\n        this.l = 0;\n        this.v = 1;\n        Deflate.call(this, opts, cb);\n    }\n    /**\n     * Pushes a chunk to be GZIPped\n     * @param chunk The chunk to push\n     * @param final Whether this is the last chunk\n     */\n    Gzip.prototype.push = function (chunk, final) {\n        this.c.p(chunk);\n        this.l += chunk.length;\n        Deflate.prototype.push.call(this, chunk, final);\n    };\n    Gzip.prototype.p = function (c, f) {\n        var raw = dopt(c, this.o, this.v && gzhl(this.o), f && 8, this.s);\n        if (this.v)\n            gzh(raw, this.o), this.v = 0;\n        if (f)\n            wbytes(raw, raw.length - 8, this.c.d()), wbytes(raw, raw.length - 4, this.l);\n        this.ondata(raw, f);\n    };\n    /**\n     * Flushes buffered uncompressed data. Useful to immediately retrieve the\n     * GZIPped output for small inputs.\n     */\n    Gzip.prototype.flush = function () {\n        Deflate.prototype.flush.call(this);\n    };\n    return Gzip;\n}());\nexport { Gzip };\n/**\n * Asynchronous streaming GZIP compression\n */\nvar AsyncGzip = /*#__PURE__*/ (function () {\n    function AsyncGzip(opts, cb) {\n        astrmify([\n            bDflt,\n            gze,\n            function () { return [astrm, Deflate, Gzip]; }\n        ], this, StrmOpt.call(this, opts, cb), function (ev) {\n            var strm = new Gzip(ev.data);\n            onmessage = astrm(strm);\n        }, 8, 1);\n    }\n    return AsyncGzip;\n}());\nexport { AsyncGzip };\nexport function gzip(data, opts, cb) {\n    if (!cb)\n        cb = opts, opts = {};\n    if (typeof cb != 'function')\n        err(7);\n    return cbify(data, opts, [\n        bDflt,\n        gze,\n        function () { return [gzipSync]; }\n    ], function (ev) { return pbf(gzipSync(ev.data[0], ev.data[1])); }, 2, cb);\n}\n/**\n * Compresses data with GZIP\n * @param data The data to compress\n * @param opts The compression options\n * @returns The gzipped version of the data\n */\nexport function gzipSync(data, opts) {\n    if (!opts)\n        opts = {};\n    var c = crc(), l = data.length;\n    c.p(data);\n    var d = dopt(data, opts, gzhl(opts), 8), s = d.length;\n    return gzh(d, opts), wbytes(d, s - 8, c.d()), wbytes(d, s - 4, l), d;\n}\n/**\n * Streaming single or multi-member GZIP decompression\n */\nvar Gunzip = /*#__PURE__*/ (function () {\n    function Gunzip(opts, cb) {\n        this.v = 1;\n        this.r = 0;\n        Inflate.call(this, opts, cb);\n    }\n    /**\n     * Pushes a chunk to be GUNZIPped\n     * @param chunk The chunk to push\n     * @param final Whether this is the last chunk\n     */\n    Gunzip.prototype.push = function (chunk, final) {\n        Inflate.prototype.e.call(this, chunk);\n        this.r += chunk.length;\n        if (this.v) {\n            var p = this.p.subarray(this.v - 1);\n            var s = p.length > 3 ? gzs(p) : 4;\n            if (s > p.length) {\n                if (!final)\n                    return;\n            }\n            else if (this.v > 1 && this.onmember) {\n                this.onmember(this.r - p.length);\n            }\n            this.p = p.subarray(s), this.v = 0;\n        }\n        // necessary to prevent TS from using the closure value\n        // This allows for workerization to function correctly\n        Inflate.prototype.c.call(this, final);\n        // process concatenated GZIP\n        if (this.s.f && !this.s.l && !final) {\n            this.v = shft(this.s.p) + 9;\n            this.s = { i: 0 };\n            this.o = new u8(0);\n            this.push(new u8(0), final);\n        }\n    };\n    return Gunzip;\n}());\nexport { Gunzip };\n/**\n * Asynchronous streaming single or multi-member GZIP decompression\n */\nvar AsyncGunzip = /*#__PURE__*/ (function () {\n    function AsyncGunzip(opts, cb) {\n        var _this = this;\n        astrmify([\n            bInflt,\n            guze,\n            function () { return [astrm, Inflate, Gunzip]; }\n        ], this, StrmOpt.call(this, opts, cb), function (ev) {\n            var strm = new Gunzip(ev.data);\n            strm.onmember = function (offset) { return postMessage(offset); };\n            onmessage = astrm(strm);\n        }, 9, 0, function (offset) { return _this.onmember && _this.onmember(offset); });\n    }\n    return AsyncGunzip;\n}());\nexport { AsyncGunzip };\nexport function gunzip(data, opts, cb) {\n    if (!cb)\n        cb = opts, opts = {};\n    if (typeof cb != 'function')\n        err(7);\n    return cbify(data, opts, [\n        bInflt,\n        guze,\n        function () { return [gunzipSync]; }\n    ], function (ev) { return pbf(gunzipSync(ev.data[0], ev.data[1])); }, 3, cb);\n}\n/**\n * Expands GZIP data\n * @param data The data to decompress\n * @param opts The decompression options\n * @returns The decompressed version of the data\n */\nexport function gunzipSync(data, opts) {\n    var st = gzs(data);\n    if (st + 8 > data.length)\n        err(6, 'invalid gzip data');\n    return inflt(data.subarray(st, -8), { i: 2 }, opts && opts.out || new u8(gzl(data)), opts && opts.dictionary);\n}\n/**\n * Streaming Zlib compression\n */\nvar Zlib = /*#__PURE__*/ (function () {\n    function Zlib(opts, cb) {\n        this.c = adler();\n        this.v = 1;\n        Deflate.call(this, opts, cb);\n    }\n    /**\n     * Pushes a chunk to be zlibbed\n     * @param chunk The chunk to push\n     * @param final Whether this is the last chunk\n     */\n    Zlib.prototype.push = function (chunk, final) {\n        this.c.p(chunk);\n        Deflate.prototype.push.call(this, chunk, final);\n    };\n    Zlib.prototype.p = function (c, f) {\n        var raw = dopt(c, this.o, this.v && (this.o.dictionary ? 6 : 2), f && 4, this.s);\n        if (this.v)\n            zlh(raw, this.o), this.v = 0;\n        if (f)\n            wbytes(raw, raw.length - 4, this.c.d());\n        this.ondata(raw, f);\n    };\n    /**\n     * Flushes buffered uncompressed data. Useful to immediately retrieve the\n     * zlibbed output for small inputs.\n     */\n    Zlib.prototype.flush = function () {\n        Deflate.prototype.flush.call(this);\n    };\n    return Zlib;\n}());\nexport { Zlib };\n/**\n * Asynchronous streaming Zlib compression\n */\nvar AsyncZlib = /*#__PURE__*/ (function () {\n    function AsyncZlib(opts, cb) {\n        astrmify([\n            bDflt,\n            zle,\n            function () { return [astrm, Deflate, Zlib]; }\n        ], this, StrmOpt.call(this, opts, cb), function (ev) {\n            var strm = new Zlib(ev.data);\n            onmessage = astrm(strm);\n        }, 10, 1);\n    }\n    return AsyncZlib;\n}());\nexport { AsyncZlib };\nexport function zlib(data, opts, cb) {\n    if (!cb)\n        cb = opts, opts = {};\n    if (typeof cb != 'function')\n        err(7);\n    return cbify(data, opts, [\n        bDflt,\n        zle,\n        function () { return [zlibSync]; }\n    ], function (ev) { return pbf(zlibSync(ev.data[0], ev.data[1])); }, 4, cb);\n}\n/**\n * Compress data with Zlib\n * @param data The data to compress\n * @param opts The compression options\n * @returns The zlib-compressed version of the data\n */\nexport function zlibSync(data, opts) {\n    if (!opts)\n        opts = {};\n    var a = adler();\n    a.p(data);\n    var d = dopt(data, opts, opts.dictionary ? 6 : 2, 4);\n    return zlh(d, opts), wbytes(d, d.length - 4, a.d()), d;\n}\n/**\n * Streaming Zlib decompression\n */\nvar Unzlib = /*#__PURE__*/ (function () {\n    function Unzlib(opts, cb) {\n        Inflate.call(this, opts, cb);\n        this.v = opts && opts.dictionary ? 2 : 1;\n    }\n    /**\n     * Pushes a chunk to be unzlibbed\n     * @param chunk The chunk to push\n     * @param final Whether this is the last chunk\n     */\n    Unzlib.prototype.push = function (chunk, final) {\n        Inflate.prototype.e.call(this, chunk);\n        if (this.v) {\n            if (this.p.length < 6 && !final)\n                return;\n            this.p = this.p.subarray(zls(this.p, this.v - 1)), this.v = 0;\n        }\n        if (final) {\n            if (this.p.length < 4)\n                err(6, 'invalid zlib data');\n            this.p = this.p.subarray(0, -4);\n        }\n        // necessary to prevent TS from using the closure value\n        // This allows for workerization to function correctly\n        Inflate.prototype.c.call(this, final);\n    };\n    return Unzlib;\n}());\nexport { Unzlib };\n/**\n * Asynchronous streaming Zlib decompression\n */\nvar AsyncUnzlib = /*#__PURE__*/ (function () {\n    function AsyncUnzlib(opts, cb) {\n        astrmify([\n            bInflt,\n            zule,\n            function () { return [astrm, Inflate, Unzlib]; }\n        ], this, StrmOpt.call(this, opts, cb), function (ev) {\n            var strm = new Unzlib(ev.data);\n            onmessage = astrm(strm);\n        }, 11, 0);\n    }\n    return AsyncUnzlib;\n}());\nexport { AsyncUnzlib };\nexport function unzlib(data, opts, cb) {\n    if (!cb)\n        cb = opts, opts = {};\n    if (typeof cb != 'function')\n        err(7);\n    return cbify(data, opts, [\n        bInflt,\n        zule,\n        function () { return [unzlibSync]; }\n    ], function (ev) { return pbf(unzlibSync(ev.data[0], gopt(ev.data[1]))); }, 5, cb);\n}\n/**\n * Expands Zlib data\n * @param data The data to decompress\n * @param opts The decompression options\n * @returns The decompressed version of the data\n */\nexport function unzlibSync(data, opts) {\n    return inflt(data.subarray(zls(data, opts && opts.dictionary), -4), { i: 2 }, opts && opts.out, opts && opts.dictionary);\n}\n// Default algorithm for compression (used because having a known output size allows faster decompression)\nexport { gzip as compress, AsyncGzip as AsyncCompress };\nexport { gzipSync as compressSync, Gzip as Compress };\n/**\n * Streaming GZIP, Zlib, or raw DEFLATE decompression\n */\nvar Decompress = /*#__PURE__*/ (function () {\n    function Decompress(opts, cb) {\n        this.o = StrmOpt.call(this, opts, cb) || {};\n        this.G = Gunzip;\n        this.I = Inflate;\n        this.Z = Unzlib;\n    }\n    // init substream\n    // overriden by AsyncDecompress\n    Decompress.prototype.i = function () {\n        var _this = this;\n        this.s.ondata = function (dat, final) {\n            _this.ondata(dat, final);\n        };\n    };\n    /**\n     * Pushes a chunk to be decompressed\n     * @param chunk The chunk to push\n     * @param final Whether this is the last chunk\n     */\n    Decompress.prototype.push = function (chunk, final) {\n        if (!this.ondata)\n            err(5);\n        if (!this.s) {\n            if (this.p && this.p.length) {\n                var n = new u8(this.p.length + chunk.length);\n                n.set(this.p), n.set(chunk, this.p.length);\n            }\n            else\n                this.p = chunk;\n            if (this.p.length > 2) {\n                this.s = (this.p[0] == 31 && this.p[1] == 139 && this.p[2] == 8)\n                    ? new this.G(this.o)\n                    : ((this.p[0] & 15) != 8 || (this.p[0] >> 4) > 7 || ((this.p[0] << 8 | this.p[1]) % 31))\n                        ? new this.I(this.o)\n                        : new this.Z(this.o);\n                this.i();\n                this.s.push(this.p, final);\n                this.p = null;\n            }\n        }\n        else\n            this.s.push(chunk, final);\n    };\n    return Decompress;\n}());\nexport { Decompress };\n/**\n * Asynchronous streaming GZIP, Zlib, or raw DEFLATE decompression\n */\nvar AsyncDecompress = /*#__PURE__*/ (function () {\n    function AsyncDecompress(opts, cb) {\n        Decompress.call(this, opts, cb);\n        this.queuedSize = 0;\n        this.G = AsyncGunzip;\n        this.I = AsyncInflate;\n        this.Z = AsyncUnzlib;\n    }\n    AsyncDecompress.prototype.i = function () {\n        var _this = this;\n        this.s.ondata = function (err, dat, final) {\n            _this.ondata(err, dat, final);\n        };\n        this.s.ondrain = function (size) {\n            _this.queuedSize -= size;\n            if (_this.ondrain)\n                _this.ondrain(size);\n        };\n    };\n    /**\n     * Pushes a chunk to be decompressed\n     * @param chunk The chunk to push\n     * @param final Whether this is the last chunk\n     */\n    AsyncDecompress.prototype.push = function (chunk, final) {\n        this.queuedSize += chunk.length;\n        Decompress.prototype.push.call(this, chunk, final);\n    };\n    return AsyncDecompress;\n}());\nexport { AsyncDecompress };\nexport function decompress(data, opts, cb) {\n    if (!cb)\n        cb = opts, opts = {};\n    if (typeof cb != 'function')\n        err(7);\n    return (data[0] == 31 && data[1] == 139 && data[2] == 8)\n        ? gunzip(data, opts, cb)\n        : ((data[0] & 15) != 8 || (data[0] >> 4) > 7 || ((data[0] << 8 | data[1]) % 31))\n            ? inflate(data, opts, cb)\n            : unzlib(data, opts, cb);\n}\n/**\n * Expands compressed GZIP, Zlib, or raw DEFLATE data, automatically detecting the format\n * @param data The data to decompress\n * @param opts The decompression options\n * @returns The decompressed version of the data\n */\nexport function decompressSync(data, opts) {\n    return (data[0] == 31 && data[1] == 139 && data[2] == 8)\n        ? gunzipSync(data, opts)\n        : ((data[0] & 15) != 8 || (data[0] >> 4) > 7 || ((data[0] << 8 | data[1]) % 31))\n            ? inflateSync(data, opts)\n            : unzlibSync(data, opts);\n}\n// flatten a directory structure\nvar fltn = function (d, p, t, o) {\n    for (var k in d) {\n        var val = d[k], n = p + k, op = o;\n        if (Array.isArray(val))\n            op = mrg(o, val[1]), val = val[0];\n        if (val instanceof u8)\n            t[n] = [val, op];\n        else {\n            t[n += '/'] = [new u8(0), op];\n            fltn(val, n, t, o);\n        }\n    }\n};\n// text encoder\nvar te = typeof TextEncoder != 'undefined' && /*#__PURE__*/ new TextEncoder();\n// text decoder\nvar td = typeof TextDecoder != 'undefined' && /*#__PURE__*/ new TextDecoder();\n// text decoder stream\nvar tds = 0;\ntry {\n    td.decode(et, { stream: true });\n    tds = 1;\n}\ncatch (e) { }\n// decode UTF8\nvar dutf8 = function (d) {\n    for (var r = '', i = 0;;) {\n        var c = d[i++];\n        var eb = (c > 127) + (c > 223) + (c > 239);\n        if (i + eb > d.length)\n            return { s: r, r: slc(d, i - 1) };\n        if (!eb)\n            r += String.fromCharCode(c);\n        else if (eb == 3) {\n            c = ((c & 15) << 18 | (d[i++] & 63) << 12 | (d[i++] & 63) << 6 | (d[i++] & 63)) - 65536,\n                r += String.fromCharCode(55296 | (c >> 10), 56320 | (c & 1023));\n        }\n        else if (eb & 1)\n            r += String.fromCharCode((c & 31) << 6 | (d[i++] & 63));\n        else\n            r += String.fromCharCode((c & 15) << 12 | (d[i++] & 63) << 6 | (d[i++] & 63));\n    }\n};\n/**\n * Streaming UTF-8 decoding\n */\nvar DecodeUTF8 = /*#__PURE__*/ (function () {\n    /**\n     * Creates a UTF-8 decoding stream\n     * @param cb The callback to call whenever data is decoded\n     */\n    function DecodeUTF8(cb) {\n        this.ondata = cb;\n        if (tds)\n            this.t = new TextDecoder();\n        else\n            this.p = et;\n    }\n    /**\n     * Pushes a chunk to be decoded from UTF-8 binary\n     * @param chunk The chunk to push\n     * @param final Whether this is the last chunk\n     */\n    DecodeUTF8.prototype.push = function (chunk, final) {\n        if (!this.ondata)\n            err(5);\n        final = !!final;\n        if (this.t) {\n            this.ondata(this.t.decode(chunk, { stream: true }), final);\n            if (final) {\n                if (this.t.decode().length)\n                    err(8);\n                this.t = null;\n            }\n            return;\n        }\n        if (!this.p)\n            err(4);\n        var dat = new u8(this.p.length + chunk.length);\n        dat.set(this.p);\n        dat.set(chunk, this.p.length);\n        var _a = dutf8(dat), s = _a.s, r = _a.r;\n        if (final) {\n            if (r.length)\n                err(8);\n            this.p = null;\n        }\n        else\n            this.p = r;\n        this.ondata(s, final);\n    };\n    return DecodeUTF8;\n}());\nexport { DecodeUTF8 };\n/**\n * Streaming UTF-8 encoding\n */\nvar EncodeUTF8 = /*#__PURE__*/ (function () {\n    /**\n     * Creates a UTF-8 decoding stream\n     * @param cb The callback to call whenever data is encoded\n     */\n    function EncodeUTF8(cb) {\n        this.ondata = cb;\n    }\n    /**\n     * Pushes a chunk to be encoded to UTF-8\n     * @param chunk The string data to push\n     * @param final Whether this is the last chunk\n     */\n    EncodeUTF8.prototype.push = function (chunk, final) {\n        if (!this.ondata)\n            err(5);\n        if (this.d)\n            err(4);\n        this.ondata(strToU8(chunk), this.d = final || false);\n    };\n    return EncodeUTF8;\n}());\nexport { EncodeUTF8 };\n/**\n * Converts a string into a Uint8Array for use with compression/decompression methods\n * @param str The string to encode\n * @param latin1 Whether or not to interpret the data as Latin-1. This should\n *               not need to be true unless decoding a binary string.\n * @returns The string encoded in UTF-8/Latin-1 binary\n */\nexport function strToU8(str, latin1) {\n    if (latin1) {\n        var ar_1 = new u8(str.length);\n        for (var i = 0; i < str.length; ++i)\n            ar_1[i] = str.charCodeAt(i);\n        return ar_1;\n    }\n    if (te)\n        return te.encode(str);\n    var l = str.length;\n    var ar = new u8(str.length + (str.length >> 1));\n    var ai = 0;\n    var w = function (v) { ar[ai++] = v; };\n    for (var i = 0; i < l; ++i) {\n        if (ai + 5 > ar.length) {\n            var n = new u8(ai + 8 + ((l - i) << 1));\n            n.set(ar);\n            ar = n;\n        }\n        var c = str.charCodeAt(i);\n        if (c < 128 || latin1)\n            w(c);\n        else if (c < 2048)\n            w(192 | (c >> 6)), w(128 | (c & 63));\n        else if (c > 55295 && c < 57344)\n            c = 65536 + (c & 1023 << 10) | (str.charCodeAt(++i) & 1023),\n                w(240 | (c >> 18)), w(128 | ((c >> 12) & 63)), w(128 | ((c >> 6) & 63)), w(128 | (c & 63));\n        else\n            w(224 | (c >> 12)), w(128 | ((c >> 6) & 63)), w(128 | (c & 63));\n    }\n    return slc(ar, 0, ai);\n}\n/**\n * Converts a Uint8Array to a string\n * @param dat The data to decode to string\n * @param latin1 Whether or not to interpret the data as Latin-1. This should\n *               not need to be true unless encoding to binary string.\n * @returns The original UTF-8/Latin-1 string\n */\nexport function strFromU8(dat, latin1) {\n    if (latin1) {\n        var r = '';\n        for (var i = 0; i < dat.length; i += 16384)\n            r += String.fromCharCode.apply(null, dat.subarray(i, i + 16384));\n        return r;\n    }\n    else if (td) {\n        return td.decode(dat);\n    }\n    else {\n        var _a = dutf8(dat), s = _a.s, r = _a.r;\n        if (r.length)\n            err(8);\n        return s;\n    }\n}\n;\n// deflate bit flag\nvar dbf = function (l) { return l == 1 ? 3 : l < 6 ? 2 : l == 9 ? 1 : 0; };\n// skip local zip header\nvar slzh = function (d, b) { return b + 30 + b2(d, b + 26) + b2(d, b + 28); };\n// read zip header\nvar zh = function (d, b, z) {\n    var fnl = b2(d, b + 28), fn = strFromU8(d.subarray(b + 46, b + 46 + fnl), !(b2(d, b + 8) & 2048)), es = b + 46 + fnl, bs = b4(d, b + 20);\n    var _a = z && bs == 4294967295 ? z64e(d, es) : [bs, b4(d, b + 24), b4(d, b + 42)], sc = _a[0], su = _a[1], off = _a[2];\n    return [b2(d, b + 10), sc, su, fn, es + b2(d, b + 30) + b2(d, b + 32), off];\n};\n// read zip64 extra field\nvar z64e = function (d, b) {\n    for (; b2(d, b) != 1; b += 4 + b2(d, b + 2))\n        ;\n    return [b8(d, b + 12), b8(d, b + 4), b8(d, b + 20)];\n};\n// extra field length\nvar exfl = function (ex) {\n    var le = 0;\n    if (ex) {\n        for (var k in ex) {\n            var l = ex[k].length;\n            if (l > 65535)\n                err(9);\n            le += l + 4;\n        }\n    }\n    return le;\n};\n// write zip header\nvar wzh = function (d, b, f, fn, u, c, ce, co) {\n    var fl = fn.length, ex = f.extra, col = co && co.length;\n    var exl = exfl(ex);\n    wbytes(d, b, ce != null ? 0x2014B50 : 0x4034B50), b += 4;\n    if (ce != null)\n        d[b++] = 20, d[b++] = f.os;\n    d[b] = 20, b += 2; // spec compliance? what's that?\n    d[b++] = (f.flag << 1) | (c < 0 && 8), d[b++] = u && 8;\n    d[b++] = f.compression & 255, d[b++] = f.compression >> 8;\n    var dt = new Date(f.mtime == null ? Date.now() : f.mtime), y = dt.getFullYear() - 1980;\n    if (y < 0 || y > 119)\n        err(10);\n    wbytes(d, b, (y << 25) | ((dt.getMonth() + 1) << 21) | (dt.getDate() << 16) | (dt.getHours() << 11) | (dt.getMinutes() << 5) | (dt.getSeconds() >> 1)), b += 4;\n    if (c != -1) {\n        wbytes(d, b, f.crc);\n        wbytes(d, b + 4, c < 0 ? -c - 2 : c);\n        wbytes(d, b + 8, f.size);\n    }\n    wbytes(d, b + 12, fl);\n    wbytes(d, b + 14, exl), b += 16;\n    if (ce != null) {\n        wbytes(d, b, col);\n        wbytes(d, b + 6, f.attrs);\n        wbytes(d, b + 10, ce), b += 14;\n    }\n    d.set(fn, b);\n    b += fl;\n    if (exl) {\n        for (var k in ex) {\n            var exf = ex[k], l = exf.length;\n            wbytes(d, b, +k);\n            wbytes(d, b + 2, l);\n            d.set(exf, b + 4), b += 4 + l;\n        }\n    }\n    if (col)\n        d.set(co, b), b += col;\n    return b;\n};\n// write zip footer (end of central directory)\nvar wzf = function (o, b, c, d, e) {\n    wbytes(o, b, 0x6054B50); // skip disk\n    wbytes(o, b + 8, c);\n    wbytes(o, b + 10, c);\n    wbytes(o, b + 12, d);\n    wbytes(o, b + 16, e);\n};\n/**\n * A pass-through stream to keep data uncompressed in a ZIP archive.\n */\nvar ZipPassThrough = /*#__PURE__*/ (function () {\n    /**\n     * Creates a pass-through stream that can be added to ZIP archives\n     * @param filename The filename to associate with this data stream\n     */\n    function ZipPassThrough(filename) {\n        this.filename = filename;\n        this.c = crc();\n        this.size = 0;\n        this.compression = 0;\n    }\n    /**\n     * Processes a chunk and pushes to the output stream. You can override this\n     * method in a subclass for custom behavior, but by default this passes\n     * the data through. You must call this.ondata(err, chunk, final) at some\n     * point in this method.\n     * @param chunk The chunk to process\n     * @param final Whether this is the last chunk\n     */\n    ZipPassThrough.prototype.process = function (chunk, final) {\n        this.ondata(null, chunk, final);\n    };\n    /**\n     * Pushes a chunk to be added. If you are subclassing this with a custom\n     * compression algorithm, note that you must push data from the source\n     * file only, pre-compression.\n     * @param chunk The chunk to push\n     * @param final Whether this is the last chunk\n     */\n    ZipPassThrough.prototype.push = function (chunk, final) {\n        if (!this.ondata)\n            err(5);\n        this.c.p(chunk);\n        this.size += chunk.length;\n        if (final)\n            this.crc = this.c.d();\n        this.process(chunk, final || false);\n    };\n    return ZipPassThrough;\n}());\nexport { ZipPassThrough };\n// I don't extend because TypeScript extension adds 1kB of runtime bloat\n/**\n * Streaming DEFLATE compression for ZIP archives. Prefer using AsyncZipDeflate\n * for better performance\n */\nvar ZipDeflate = /*#__PURE__*/ (function () {\n    /**\n     * Creates a DEFLATE stream that can be added to ZIP archives\n     * @param filename The filename to associate with this data stream\n     * @param opts The compression options\n     */\n    function ZipDeflate(filename, opts) {\n        var _this = this;\n        if (!opts)\n            opts = {};\n        ZipPassThrough.call(this, filename);\n        this.d = new Deflate(opts, function (dat, final) {\n            _this.ondata(null, dat, final);\n        });\n        this.compression = 8;\n        this.flag = dbf(opts.level);\n    }\n    ZipDeflate.prototype.process = function (chunk, final) {\n        try {\n            this.d.push(chunk, final);\n        }\n        catch (e) {\n            this.ondata(e, null, final);\n        }\n    };\n    /**\n     * Pushes a chunk to be deflated\n     * @param chunk The chunk to push\n     * @param final Whether this is the last chunk\n     */\n    ZipDeflate.prototype.push = function (chunk, final) {\n        ZipPassThrough.prototype.push.call(this, chunk, final);\n    };\n    return ZipDeflate;\n}());\nexport { ZipDeflate };\n/**\n * Asynchronous streaming DEFLATE compression for ZIP archives\n */\nvar AsyncZipDeflate = /*#__PURE__*/ (function () {\n    /**\n     * Creates an asynchronous DEFLATE stream that can be added to ZIP archives\n     * @param filename The filename to associate with this data stream\n     * @param opts The compression options\n     */\n    function AsyncZipDeflate(filename, opts) {\n        var _this = this;\n        if (!opts)\n            opts = {};\n        ZipPassThrough.call(this, filename);\n        this.d = new AsyncDeflate(opts, function (err, dat, final) {\n            _this.ondata(err, dat, final);\n        });\n        this.compression = 8;\n        this.flag = dbf(opts.level);\n        this.terminate = this.d.terminate;\n    }\n    AsyncZipDeflate.prototype.process = function (chunk, final) {\n        this.d.push(chunk, final);\n    };\n    /**\n     * Pushes a chunk to be deflated\n     * @param chunk The chunk to push\n     * @param final Whether this is the last chunk\n     */\n    AsyncZipDeflate.prototype.push = function (chunk, final) {\n        ZipPassThrough.prototype.push.call(this, chunk, final);\n    };\n    return AsyncZipDeflate;\n}());\nexport { AsyncZipDeflate };\n// TODO: Better tree shaking\n/**\n * A zippable archive to which files can incrementally be added\n */\nvar Zip = /*#__PURE__*/ (function () {\n    /**\n     * Creates an empty ZIP archive to which files can be added\n     * @param cb The callback to call whenever data for the generated ZIP archive\n     *           is available\n     */\n    function Zip(cb) {\n        this.ondata = cb;\n        this.u = [];\n        this.d = 1;\n    }\n    /**\n     * Adds a file to the ZIP archive\n     * @param file The file stream to add\n     */\n    Zip.prototype.add = function (file) {\n        var _this = this;\n        if (!this.ondata)\n            err(5);\n        // finishing or finished\n        if (this.d & 2)\n            this.ondata(err(4 + (this.d & 1) * 8, 0, 1), null, false);\n        else {\n            var f = strToU8(file.filename), fl_1 = f.length;\n            var com = file.comment, o = com && strToU8(com);\n            var u = fl_1 != file.filename.length || (o && (com.length != o.length));\n            var hl_1 = fl_1 + exfl(file.extra) + 30;\n            if (fl_1 > 65535)\n                this.ondata(err(11, 0, 1), null, false);\n            var header = new u8(hl_1);\n            wzh(header, 0, file, f, u, -1);\n            var chks_1 = [header];\n            var pAll_1 = function () {\n                for (var _i = 0, chks_2 = chks_1; _i < chks_2.length; _i++) {\n                    var chk = chks_2[_i];\n                    _this.ondata(null, chk, false);\n                }\n                chks_1 = [];\n            };\n            var tr_1 = this.d;\n            this.d = 0;\n            var ind_1 = this.u.length;\n            var uf_1 = mrg(file, {\n                f: f,\n                u: u,\n                o: o,\n                t: function () {\n                    if (file.terminate)\n                        file.terminate();\n                },\n                r: function () {\n                    pAll_1();\n                    if (tr_1) {\n                        var nxt = _this.u[ind_1 + 1];\n                        if (nxt)\n                            nxt.r();\n                        else\n                            _this.d = 1;\n                    }\n                    tr_1 = 1;\n                }\n            });\n            var cl_1 = 0;\n            file.ondata = function (err, dat, final) {\n                if (err) {\n                    _this.ondata(err, dat, final);\n                    _this.terminate();\n                }\n                else {\n                    cl_1 += dat.length;\n                    chks_1.push(dat);\n                    if (final) {\n                        var dd = new u8(16);\n                        wbytes(dd, 0, 0x8074B50);\n                        wbytes(dd, 4, file.crc);\n                        wbytes(dd, 8, cl_1);\n                        wbytes(dd, 12, file.size);\n                        chks_1.push(dd);\n                        uf_1.c = cl_1, uf_1.b = hl_1 + cl_1 + 16, uf_1.crc = file.crc, uf_1.size = file.size;\n                        if (tr_1)\n                            uf_1.r();\n                        tr_1 = 1;\n                    }\n                    else if (tr_1)\n                        pAll_1();\n                }\n            };\n            this.u.push(uf_1);\n        }\n    };\n    /**\n     * Ends the process of adding files and prepares to emit the final chunks.\n     * This *must* be called after adding all desired files for the resulting\n     * ZIP file to work properly.\n     */\n    Zip.prototype.end = function () {\n        var _this = this;\n        if (this.d & 2) {\n            this.ondata(err(4 + (this.d & 1) * 8, 0, 1), null, true);\n            return;\n        }\n        if (this.d)\n            this.e();\n        else\n            this.u.push({\n                r: function () {\n                    if (!(_this.d & 1))\n                        return;\n                    _this.u.splice(-1, 1);\n                    _this.e();\n                },\n                t: function () { }\n            });\n        this.d = 3;\n    };\n    Zip.prototype.e = function () {\n        var bt = 0, l = 0, tl = 0;\n        for (var _i = 0, _a = this.u; _i < _a.length; _i++) {\n            var f = _a[_i];\n            tl += 46 + f.f.length + exfl(f.extra) + (f.o ? f.o.length : 0);\n        }\n        var out = new u8(tl + 22);\n        for (var _b = 0, _c = this.u; _b < _c.length; _b++) {\n            var f = _c[_b];\n            wzh(out, bt, f, f.f, f.u, -f.c - 2, l, f.o);\n            bt += 46 + f.f.length + exfl(f.extra) + (f.o ? f.o.length : 0), l += f.b;\n        }\n        wzf(out, bt, this.u.length, tl, l);\n        this.ondata(null, out, true);\n        this.d = 2;\n    };\n    /**\n     * A method to terminate any internal workers used by the stream. Subsequent\n     * calls to add() will fail.\n     */\n    Zip.prototype.terminate = function () {\n        for (var _i = 0, _a = this.u; _i < _a.length; _i++) {\n            var f = _a[_i];\n            f.t();\n        }\n        this.d = 2;\n    };\n    return Zip;\n}());\nexport { Zip };\nexport function zip(data, opts, cb) {\n    if (!cb)\n        cb = opts, opts = {};\n    if (typeof cb != 'function')\n        err(7);\n    var r = {};\n    fltn(data, '', r, opts);\n    var k = Object.keys(r);\n    var lft = k.length, o = 0, tot = 0;\n    var slft = lft, files = new Array(lft);\n    var term = [];\n    var tAll = function () {\n        for (var i = 0; i < term.length; ++i)\n            term[i]();\n    };\n    var cbd = function (a, b) {\n        mt(function () { cb(a, b); });\n    };\n    mt(function () { cbd = cb; });\n    var cbf = function () {\n        var out = new u8(tot + 22), oe = o, cdl = tot - o;\n        tot = 0;\n        for (var i = 0; i < slft; ++i) {\n            var f = files[i];\n            try {\n                var l = f.c.length;\n                wzh(out, tot, f, f.f, f.u, l);\n                var badd = 30 + f.f.length + exfl(f.extra);\n                var loc = tot + badd;\n                out.set(f.c, loc);\n                wzh(out, o, f, f.f, f.u, l, tot, f.m), o += 16 + badd + (f.m ? f.m.length : 0), tot = loc + l;\n            }\n            catch (e) {\n                return cbd(e, null);\n            }\n        }\n        wzf(out, o, files.length, cdl, oe);\n        cbd(null, out);\n    };\n    if (!lft)\n        cbf();\n    var _loop_1 = function (i) {\n        var fn = k[i];\n        var _a = r[fn], file = _a[0], p = _a[1];\n        var c = crc(), size = file.length;\n        c.p(file);\n        var f = strToU8(fn), s = f.length;\n        var com = p.comment, m = com && strToU8(com), ms = m && m.length;\n        var exl = exfl(p.extra);\n        var compression = p.level == 0 ? 0 : 8;\n        var cbl = function (e, d) {\n            if (e) {\n                tAll();\n                cbd(e, null);\n            }\n            else {\n                var l = d.length;\n                files[i] = mrg(p, {\n                    size: size,\n                    crc: c.d(),\n                    c: d,\n                    f: f,\n                    m: m,\n                    u: s != fn.length || (m && (com.length != ms)),\n                    compression: compression\n                });\n                o += 30 + s + exl + l;\n                tot += 76 + 2 * (s + exl) + (ms || 0) + l;\n                if (!--lft)\n                    cbf();\n            }\n        };\n        if (s > 65535)\n            cbl(err(11, 0, 1), null);\n        if (!compression)\n            cbl(null, file);\n        else if (size < 160000) {\n            try {\n                cbl(null, deflateSync(file, p));\n            }\n            catch (e) {\n                cbl(e, null);\n            }\n        }\n        else\n            term.push(deflate(file, p, cbl));\n    };\n    // Cannot use lft because it can decrease\n    for (var i = 0; i < slft; ++i) {\n        _loop_1(i);\n    }\n    return tAll;\n}\n/**\n * Synchronously creates a ZIP file. Prefer using `zip` for better performance\n * with more than one file.\n * @param data The directory structure for the ZIP archive\n * @param opts The main options, merged with per-file options\n * @returns The generated ZIP archive\n */\nexport function zipSync(data, opts) {\n    if (!opts)\n        opts = {};\n    var r = {};\n    var files = [];\n    fltn(data, '', r, opts);\n    var o = 0;\n    var tot = 0;\n    for (var fn in r) {\n        var _a = r[fn], file = _a[0], p = _a[1];\n        var compression = p.level == 0 ? 0 : 8;\n        var f = strToU8(fn), s = f.length;\n        var com = p.comment, m = com && strToU8(com), ms = m && m.length;\n        var exl = exfl(p.extra);\n        if (s > 65535)\n            err(11);\n        var d = compression ? deflateSync(file, p) : file, l = d.length;\n        var c = crc();\n        c.p(file);\n        files.push(mrg(p, {\n            size: file.length,\n            crc: c.d(),\n            c: d,\n            f: f,\n            m: m,\n            u: s != fn.length || (m && (com.length != ms)),\n            o: o,\n            compression: compression\n        }));\n        o += 30 + s + exl + l;\n        tot += 76 + 2 * (s + exl) + (ms || 0) + l;\n    }\n    var out = new u8(tot + 22), oe = o, cdl = tot - o;\n    for (var i = 0; i < files.length; ++i) {\n        var f = files[i];\n        wzh(out, f.o, f, f.f, f.u, f.c.length);\n        var badd = 30 + f.f.length + exfl(f.extra);\n        out.set(f.c, f.o + badd);\n        wzh(out, o, f, f.f, f.u, f.c.length, f.o, f.m), o += 16 + badd + (f.m ? f.m.length : 0);\n    }\n    wzf(out, o, files.length, cdl, oe);\n    return out;\n}\n/**\n * Streaming pass-through decompression for ZIP archives\n */\nvar UnzipPassThrough = /*#__PURE__*/ (function () {\n    function UnzipPassThrough() {\n    }\n    UnzipPassThrough.prototype.push = function (data, final) {\n        this.ondata(null, data, final);\n    };\n    UnzipPassThrough.compression = 0;\n    return UnzipPassThrough;\n}());\nexport { UnzipPassThrough };\n/**\n * Streaming DEFLATE decompression for ZIP archives. Prefer AsyncZipInflate for\n * better performance.\n */\nvar UnzipInflate = /*#__PURE__*/ (function () {\n    /**\n     * Creates a DEFLATE decompression that can be used in ZIP archives\n     */\n    function UnzipInflate() {\n        var _this = this;\n        this.i = new Inflate(function (dat, final) {\n            _this.ondata(null, dat, final);\n        });\n    }\n    UnzipInflate.prototype.push = function (data, final) {\n        try {\n            this.i.push(data, final);\n        }\n        catch (e) {\n            this.ondata(e, null, final);\n        }\n    };\n    UnzipInflate.compression = 8;\n    return UnzipInflate;\n}());\nexport { UnzipInflate };\n/**\n * Asynchronous streaming DEFLATE decompression for ZIP archives\n */\nvar AsyncUnzipInflate = /*#__PURE__*/ (function () {\n    /**\n     * Creates a DEFLATE decompression that can be used in ZIP archives\n     */\n    function AsyncUnzipInflate(_, sz) {\n        var _this = this;\n        if (sz < 320000) {\n            this.i = new Inflate(function (dat, final) {\n                _this.ondata(null, dat, final);\n            });\n        }\n        else {\n            this.i = new AsyncInflate(function (err, dat, final) {\n                _this.ondata(err, dat, final);\n            });\n            this.terminate = this.i.terminate;\n        }\n    }\n    AsyncUnzipInflate.prototype.push = function (data, final) {\n        if (this.i.terminate)\n            data = slc(data, 0);\n        this.i.push(data, final);\n    };\n    AsyncUnzipInflate.compression = 8;\n    return AsyncUnzipInflate;\n}());\nexport { AsyncUnzipInflate };\n/**\n * A ZIP archive decompression stream that emits files as they are discovered\n */\nvar Unzip = /*#__PURE__*/ (function () {\n    /**\n     * Creates a ZIP decompression stream\n     * @param cb The callback to call whenever a file in the ZIP archive is found\n     */\n    function Unzip(cb) {\n        this.onfile = cb;\n        this.k = [];\n        this.o = {\n            0: UnzipPassThrough\n        };\n        this.p = et;\n    }\n    /**\n     * Pushes a chunk to be unzipped\n     * @param chunk The chunk to push\n     * @param final Whether this is the last chunk\n     */\n    Unzip.prototype.push = function (chunk, final) {\n        var _this = this;\n        if (!this.onfile)\n            err(5);\n        if (!this.p)\n            err(4);\n        if (this.c > 0) {\n            var len = Math.min(this.c, chunk.length);\n            var toAdd = chunk.subarray(0, len);\n            this.c -= len;\n            if (this.d)\n                this.d.push(toAdd, !this.c);\n            else\n                this.k[0].push(toAdd);\n            chunk = chunk.subarray(len);\n            if (chunk.length)\n                return this.push(chunk, final);\n        }\n        else {\n            var f = 0, i = 0, is = void 0, buf = void 0;\n            if (!this.p.length)\n                buf = chunk;\n            else if (!chunk.length)\n                buf = this.p;\n            else {\n                buf = new u8(this.p.length + chunk.length);\n                buf.set(this.p), buf.set(chunk, this.p.length);\n            }\n            var l = buf.length, oc = this.c, add = oc && this.d;\n            var _loop_2 = function () {\n                var _a;\n                var sig = b4(buf, i);\n                if (sig == 0x4034B50) {\n                    f = 1, is = i;\n                    this_1.d = null;\n                    this_1.c = 0;\n                    var bf = b2(buf, i + 6), cmp_1 = b2(buf, i + 8), u = bf & 2048, dd = bf & 8, fnl = b2(buf, i + 26), es = b2(buf, i + 28);\n                    if (l > i + 30 + fnl + es) {\n                        var chks_3 = [];\n                        this_1.k.unshift(chks_3);\n                        f = 2;\n                        var sc_1 = b4(buf, i + 18), su_1 = b4(buf, i + 22);\n                        var fn_1 = strFromU8(buf.subarray(i + 30, i += 30 + fnl), !u);\n                        if (sc_1 == 4294967295) {\n                            _a = dd ? [-2] : z64e(buf, i), sc_1 = _a[0], su_1 = _a[1];\n                        }\n                        else if (dd)\n                            sc_1 = -1;\n                        i += es;\n                        this_1.c = sc_1;\n                        var d_1;\n                        var file_1 = {\n                            name: fn_1,\n                            compression: cmp_1,\n                            start: function () {\n                                if (!file_1.ondata)\n                                    err(5);\n                                if (!sc_1)\n                                    file_1.ondata(null, et, true);\n                                else {\n                                    var ctr = _this.o[cmp_1];\n                                    if (!ctr)\n                                        file_1.ondata(err(14, 'unknown compression type ' + cmp_1, 1), null, false);\n                                    d_1 = sc_1 < 0 ? new ctr(fn_1) : new ctr(fn_1, sc_1, su_1);\n                                    d_1.ondata = function (err, dat, final) { file_1.ondata(err, dat, final); };\n                                    for (var _i = 0, chks_4 = chks_3; _i < chks_4.length; _i++) {\n                                        var dat = chks_4[_i];\n                                        d_1.push(dat, false);\n                                    }\n                                    if (_this.k[0] == chks_3 && _this.c)\n                                        _this.d = d_1;\n                                    else\n                                        d_1.push(et, true);\n                                }\n                            },\n                            terminate: function () {\n                                if (d_1 && d_1.terminate)\n                                    d_1.terminate();\n                            }\n                        };\n                        if (sc_1 >= 0)\n                            file_1.size = sc_1, file_1.originalSize = su_1;\n                        this_1.onfile(file_1);\n                    }\n                    return \"break\";\n                }\n                else if (oc) {\n                    if (sig == 0x8074B50) {\n                        is = i += 12 + (oc == -2 && 8), f = 3, this_1.c = 0;\n                        return \"break\";\n                    }\n                    else if (sig == 0x2014B50) {\n                        is = i -= 4, f = 3, this_1.c = 0;\n                        return \"break\";\n                    }\n                }\n            };\n            var this_1 = this;\n            for (; i < l - 4; ++i) {\n                var state_1 = _loop_2();\n                if (state_1 === \"break\")\n                    break;\n            }\n            this.p = et;\n            if (oc < 0) {\n                var dat = f ? buf.subarray(0, is - 12 - (oc == -2 && 8) - (b4(buf, is - 16) == 0x8074B50 && 4)) : buf.subarray(0, i);\n                if (add)\n                    add.push(dat, !!f);\n                else\n                    this.k[+(f == 2)].push(dat);\n            }\n            if (f & 2)\n                return this.push(buf.subarray(i), final);\n            this.p = buf.subarray(i);\n        }\n        if (final) {\n            if (this.c)\n                err(13);\n            this.p = null;\n        }\n    };\n    /**\n     * Registers a decoder with the stream, allowing for files compressed with\n     * the compression type provided to be expanded correctly\n     * @param decoder The decoder constructor\n     */\n    Unzip.prototype.register = function (decoder) {\n        this.o[decoder.compression] = decoder;\n    };\n    return Unzip;\n}());\nexport { Unzip };\nvar mt = typeof queueMicrotask == 'function' ? queueMicrotask : typeof setTimeout == 'function' ? setTimeout : function (fn) { fn(); };\nexport function unzip(data, opts, cb) {\n    if (!cb)\n        cb = opts, opts = {};\n    if (typeof cb != 'function')\n        err(7);\n    var term = [];\n    var tAll = function () {\n        for (var i = 0; i < term.length; ++i)\n            term[i]();\n    };\n    var files = {};\n    var cbd = function (a, b) {\n        mt(function () { cb(a, b); });\n    };\n    mt(function () { cbd = cb; });\n    var e = data.length - 22;\n    for (; b4(data, e) != 0x6054B50; --e) {\n        if (!e || data.length - e > 65558) {\n            cbd(err(13, 0, 1), null);\n            return tAll;\n        }\n    }\n    ;\n    var lft = b2(data, e + 8);\n    if (lft) {\n        var c = lft;\n        var o = b4(data, e + 16);\n        var z = o == 4294967295 || c == 65535;\n        if (z) {\n            var ze = b4(data, e - 12);\n            z = b4(data, ze) == 0x6064B50;\n            if (z) {\n                c = lft = b4(data, ze + 32);\n                o = b4(data, ze + 48);\n            }\n        }\n        var fltr = opts && opts.filter;\n        var _loop_3 = function (i) {\n            var _a = zh(data, o, z), c_1 = _a[0], sc = _a[1], su = _a[2], fn = _a[3], no = _a[4], off = _a[5], b = slzh(data, off);\n            o = no;\n            var cbl = function (e, d) {\n                if (e) {\n                    tAll();\n                    cbd(e, null);\n                }\n                else {\n                    if (d)\n                        files[fn] = d;\n                    if (!--lft)\n                        cbd(null, files);\n                }\n            };\n            if (!fltr || fltr({\n                name: fn,\n                size: sc,\n                originalSize: su,\n                compression: c_1\n            })) {\n                if (!c_1)\n                    cbl(null, slc(data, b, b + sc));\n                else if (c_1 == 8) {\n                    var infl = data.subarray(b, b + sc);\n                    // Synchronously decompress under 512KB, or barely-compressed data\n                    if (su < 524288 || sc > 0.8 * su) {\n                        try {\n                            cbl(null, inflateSync(infl, { out: new u8(su) }));\n                        }\n                        catch (e) {\n                            cbl(e, null);\n                        }\n                    }\n                    else\n                        term.push(inflate(infl, { size: su }, cbl));\n                }\n                else\n                    cbl(err(14, 'unknown compression type ' + c_1, 1), null);\n            }\n            else\n                cbl(null, null);\n        };\n        for (var i = 0; i < c; ++i) {\n            _loop_3(i);\n        }\n    }\n    else\n        cbd(null, {});\n    return tAll;\n}\n/**\n * Synchronously decompresses a ZIP archive. Prefer using `unzip` for better\n * performance with more than one file.\n * @param data The raw compressed ZIP file\n * @param opts The ZIP extraction options\n * @returns The decompressed files\n */\nexport function unzipSync(data, opts) {\n    var files = {};\n    var e = data.length - 22;\n    for (; b4(data, e) != 0x6054B50; --e) {\n        if (!e || data.length - e > 65558)\n            err(13);\n    }\n    ;\n    var c = b2(data, e + 8);\n    if (!c)\n        return {};\n    var o = b4(data, e + 16);\n    var z = o == 4294967295 || c == 65535;\n    if (z) {\n        var ze = b4(data, e - 12);\n        z = b4(data, ze) == 0x6064B50;\n        if (z) {\n            c = b4(data, ze + 32);\n            o = b4(data, ze + 48);\n        }\n    }\n    var fltr = opts && opts.filter;\n    for (var i = 0; i < c; ++i) {\n        var _a = zh(data, o, z), c_2 = _a[0], sc = _a[1], su = _a[2], fn = _a[3], no = _a[4], off = _a[5], b = slzh(data, off);\n        o = no;\n        if (!fltr || fltr({\n            name: fn,\n            size: sc,\n            originalSize: su,\n            compression: c_2\n        })) {\n            if (!c_2)\n                files[fn] = slc(data, b, b + sc);\n            else if (c_2 == 8)\n                files[fn] = inflateSync(data.subarray(b, b + sc), { out: new u8(su) });\n            else\n                err(14, 'unknown compression type ' + c_2);\n        }\n    }\n    return files;\n}\n","import util from 'util';\nimport zlib from 'zlib';\nimport { zlibSync } from 'fflate';\nimport nodeCrypto from 'crypto';\n\nimport { StartCanvasInfo } from '../download.js';\nimport { PdfDictionary } from './common.js';\nimport log from '../log.js';\nimport { runningInNode } from '../util.js';\n\n// Browsers have native encoders/decoders in the global namespace, use these\nexport let textEncoder: TextEncoder | util.TextEncoder;\nexport let textDecoder: TextDecoder | util.TextDecoder;\nif (typeof TextEncoder !== 'undefined' && typeof TextDecoder !== 'undefined') {\n  textEncoder = new TextEncoder();\n  textDecoder = new TextDecoder();\n} else {\n  textEncoder = new util.TextEncoder();\n  textDecoder = new util.TextDecoder();\n}\n\n// If running in node, use the web compatible crypto implementation\nlet cryptoImpl: Crypto;\nif (runningInNode()) {\n  cryptoImpl = nodeCrypto.webcrypto as Crypto;\n} else {\n  cryptoImpl = crypto;\n}\n\nexport const IS_BIG_ENDIAN = (() => {\n  const array = new Uint8Array(4);\n  const view = new Uint32Array(array.buffer);\n  return !((view[0] = 1) & array[0]);\n})();\n\nexport interface TocItem {\n  label: string;\n  children?: Array<TocItem>;\n  startCanvas: StartCanvasInfo;\n}\n\nexport function getNumChildren(itm: TocItem): number {\n  const children = itm.children ?? [];\n  return (\n    children.length + children.map(getNumChildren).reduce((a, b) => a + b, 0)\n  );\n}\n\nexport function randomData(length: number): Uint8Array {\n  if (length > 2 ** 16) {\n    length = 2 ** 16;\n  }\n  const buf = new Uint8Array(length);\n  if (cryptoImpl !== undefined) {\n    cryptoImpl.getRandomValues(buf);\n  } else {\n    const u32View = new Uint32Array(buf.buffer);\n    for (let i = 0; i < u32View.length; i++) {\n      u32View[i] = Math.floor(Math.random() * 2 ** 32);\n    }\n  }\n  return buf;\n}\n\nexport async function tryDeflateStream(\n  pdfStream: Uint8Array | string\n): Promise<{ stream: Uint8Array | string; dict: PdfDictionary }> {\n  const data =\n    pdfStream instanceof Uint8Array ? pdfStream : textEncoder.encode(pdfStream);\n  let compressed: Uint8Array;\n  if (!runningInNode()) {\n    if (typeof CompressionStream === 'undefined') {\n      // Browser doesn't support CompressionStream API, try to use the JS implementation\n      try {\n        let bytes: Uint8Array;\n        if (pdfStream instanceof Uint8Array) {\n          bytes = pdfStream;\n        } else {\n          bytes = textEncoder.encode(pdfStream);\n        }\n        compressed = zlibSync(bytes);\n        return Promise.resolve({\n          stream: compressed,\n          dict: { Length: compressed.length, Filter: '/FlateDecode' },\n        });\n      } catch (err) {\n        log.warn(\n          `Failed to use JS deflate implementation, data will be written uncompressed: ${err}`\n        );\n        return Promise.resolve({\n          stream: pdfStream,\n          dict: { Length: pdfStream.length },\n        });\n      }\n    }\n    const compStream = new CompressionStream('deflate');\n    const c = new Blob([data]).stream().pipeThrough(compStream);\n    compressed = new Uint8Array(await new Response(c).arrayBuffer());\n  } else {\n    compressed = await new Promise((resolve, reject) =>\n      zlib.deflate(data, (err, buf) => (err ? reject(err) : resolve(buf)))\n    );\n  }\n  return {\n    dict: {\n      Length: compressed.length,\n      Filter: '/FlateDecode',\n    },\n    stream: compressed,\n  };\n}\n","import { IS_BIG_ENDIAN } from './util.js';\n\nconst PDF_INDENTATION = 2;\n\nexport interface Metadata {\n  Producer?: string;\n  Creator?: string;\n  CreationDate?: Date;\n  Title?: string;\n  Author?: string;\n  Keywords?: string;\n  ModDate?: Date;\n}\n\nexport interface PdfObject {\n  num: number;\n  data?: PdfValue;\n  stream?: Uint8Array | string;\n}\n\nexport class PdfRef {\n  refObj: number;\n\n  constructor(num: number) {\n    this.refObj = num;\n  }\n}\nexport type PdfPrimitive =\n  | string\n  | number\n  | boolean\n  | Uint8Array\n  | null\n  | Date\n  | PdfRef;\nexport interface PdfDictionary {\n  [member: string]: PdfPrimitive | PdfArray | PdfDictionary;\n}\nexport type PdfArray = Array<PdfPrimitive | PdfArray | PdfDictionary>;\nexport type PdfValue = PdfPrimitive | PdfDictionary | PdfArray | null;\n\nexport interface PdfAnnotation {\n  Type: 'Annot';\n  Subtype: string;\n  Rect: [number, number, number, number];\n  Contents: string | undefined;\n  P?: PdfRef;\n  NM?: string;\n  M?: Date;\n  F?: number;\n  AP?: PdfDictionary;\n  AS?: string;\n  Border?: [number, number, number] | [number, number, number, number];\n  C?:\n    | []\n    | [number]\n    | [number, number, number]\n    | [number, number, number, number];\n}\n\nexport interface StructTreeEntry {\n  type: 'Sect' | 'P' | 'Span';\n  children: Array<StructTreeEntry>; // Only for `Sect` and `P` entries\n  pageObjNum: number;\n  mcs: Array<number>; // Only for `Span` entries\n}\n\nexport function makeRef(target: number | PdfObject): PdfRef {\n  const num = typeof target === 'number' ? target : target.num;\n  return new PdfRef(num);\n}\n\nfunction isUnicode(str: string): boolean {\n  for (let i = 0, end = str.length; i < end; i++) {\n    if (str.charCodeAt(i) > 0x7f) {\n      return true;\n    }\n  }\n  return false;\n}\n\n/** Convert a JS UTF8 string to a UTF16 Big Endian string */\nexport function toUTF16BE(str: string, includeBom = true): Uint8Array {\n  const buf = new Uint16Array(str.length + (includeBom ? 1 : 0));\n  for (let i = includeBom ? 1 : 0; i < buf.length; i++) {\n    buf[i] = str.charCodeAt(i - (includeBom ? 1 : 0));\n  }\n  const outBuf = new Uint8Array(buf.buffer, buf.byteOffset, buf.byteLength);\n  if (!IS_BIG_ENDIAN) {\n    // PDF needs UTF16-BE, so in little endian systems we need to swap each\n    // codepoint's byte pair\n    for (let i = includeBom ? 2 : 0, end = outBuf.length - 1; i < end; i += 2) {\n      const a = outBuf[i];\n      outBuf[i] = outBuf[i + 1];\n      outBuf[i + 1] = a;\n    }\n  }\n  // UTF16BE BOM\n  if (includeBom) {\n    outBuf[0] = 254;\n    outBuf[1] = 255;\n  }\n  return outBuf;\n}\n\nfunction safeNumber(num: number): number {\n  if (num > -1e21 && num < 1e21) {\n    return Math.round(num * 1e6) / 1e6;\n  }\n  throw new Error(`unsupported number: ${num}`);\n}\n\nexport function serialize(value: PdfValue, dictIndent = 0): string {\n  if (typeof value === 'string') {\n    if (\n      value[0] === '(' &&\n      value[value.length - 1] === ')' &&\n      isUnicode(value)\n    ) {\n      return serialize(toUTF16BE(value.substring(1, value.length - 1)));\n    }\n    return value;\n  } else if (value instanceof Uint8Array) {\n    return `<${Array.from(value)\n      .map((x) => x.toString(16).padStart(2, '0').toUpperCase())\n      .join('')}>`;\n  } else if (value instanceof Date) {\n    const dateString =\n      `D:${value.getUTCFullYear().toString(10).padStart(4, '0')}` +\n      (value.getUTCMonth() + 1).toString(10).padStart(2, '0') +\n      value.getUTCDate().toString(10).padStart(2, '0') +\n      value.getUTCHours().toString(10).padStart(2, '0') +\n      value.getUTCMinutes().toString(10).padStart(2, '0') +\n      value.getUTCSeconds().toString(10).padStart(2, '0') +\n      'Z';\n    return `(${dateString})`;\n  } else if (Array.isArray(value)) {\n    return `[${value.map((v) => serialize(v, dictIndent + 1)).join(' ')}]`;\n  } else if (value instanceof PdfRef) {\n    if (value.refObj === -1) {\n      throw new Error('Cannot serialize a deferred object reference');\n    }\n    return `${value.refObj} 0 R`;\n  } else if ({}.toString.call(value) === '[object Object]') {\n    const outsideIndent = ' '.repeat(PDF_INDENTATION * dictIndent);\n    const insideIndent = outsideIndent + ' '.repeat(PDF_INDENTATION);\n    return `<<\\n${Object.entries(value as any)\n      .map(\n        ([k, v]) =>\n          `${insideIndent}/${k} ${serialize(v as any, dictIndent + 1)}`\n      )\n      .join('\\n')}\\n${outsideIndent}>>`;\n  } else if (typeof value === 'number') {\n    return safeNumber(value).toString(10);\n  } else {\n    return `${value}`;\n  }\n}\n","/** Types for writing to an output stream, with support for Node and Browsers. */\nimport type { Writable as NodeWritable } from 'stream';\nimport type nodeFs from 'fs';\n\nimport log from './log.js';\n\n/** Base interface to be implemented by all readers.  */\nexport interface Reader {\n  read(\n    dst: Uint8Array,\n    offset: number,\n    position: number,\n    length: number\n  ): Promise<number>;\n  size(): Promise<number>;\n}\n\n/** Base interface to be implemented by all writers. */\nexport interface Writer {\n  /** Write a chunk to the writer */\n  write(buffer: Uint8Array | string): Promise<void>;\n\n  /** Close the writer */\n  close(): Promise<void>;\n\n  /** Wait for the next drainage/flush event */\n  waitForDrain(): Promise<void>;\n}\n\n/** Reader implementation using the Web `File` API.  */\nexport class WebReader implements Reader {\n  private file: File;\n\n  constructor(file: File) {\n    this.file = file;\n  }\n\n  async read(\n    dst: Uint8Array,\n    offset: number,\n    position: number,\n    length: number\n  ): Promise<number> {\n    const blob = this.file.slice(position, position + length);\n    const buf = await blob.arrayBuffer();\n    dst.set(new Uint8Array(buf), offset);\n    return buf.byteLength;\n  }\n\n  size(): Promise<number> {\n    return new Promise((resolve) => resolve(this.file.size));\n  }\n}\n\n/** Wraps a writer and counts the bytes written to it. */\nexport class CountingWriter implements Writer {\n  private _writer: Writer;\n  bytesWritten = 0;\n\n  constructor(writer: Writer) {\n    this._writer = writer;\n  }\n\n  write(buffer: string | Uint8Array): Promise<void> {\n    this.bytesWritten += buffer.length;\n    return this._writer.write(buffer);\n  }\n\n  close(): Promise<void> {\n    return this._writer.close();\n  }\n\n  waitForDrain(): Promise<void> {\n    return this._writer.waitForDrain();\n  }\n}\n\n/** A Writer implemented using the `File System Access API` available in\n *  recent Chrome, Edge and Opera browsers. */\nexport class WebWriter implements Writer {\n  private _writer: WritableStreamDefaultWriter<any>;\n\n  constructor(stream: WritableStream) {\n    this._writer = stream.getWriter();\n  }\n\n  write(buffer: string | Uint8Array): Promise<void> {\n    return this._writer.write(buffer);\n  }\n\n  waitForDrain(): Promise<void> {\n    return this._writer.ready;\n  }\n\n  close(): Promise<void> {\n    return this._writer.close();\n  }\n}\n\n\n/** Writer implementation using the `Blob` API available in all browsers. */\nexport class BlobWriter implements Writer {\n  // TODO: A good reference seems to be the mega.nz implementation, which has always worked great for me on desktops at least:\n  // https://github.com/meganz/webclient/blob/f19289127b68ceaf19a5e884f2f48f15078304da/js/transfers/meths/memory.js\n  private _parts: Array<Uint8Array | string>;\n  private _blob?: Blob;\n\n  constructor() {\n    this._parts = [];\n  }\n\n  write(buffer: string | Uint8Array): Promise<void> {\n    if (this._blob) {\n      return Promise.reject('Cannot write to closed BlobWriter.');\n    }\n    this._parts.push(buffer);\n    return Promise.resolve();\n  }\n\n  waitForDrain(): Promise<void> {\n    if (this._blob) {\n      return Promise.reject('Cannot wait on a closed BlobWriter.');\n    }\n    return Promise.resolve();\n  }\n\n  close(): Promise<void> {\n    if (this._blob) {\n      return Promise.reject('BlobWriter is already closed');\n    }\n    this._blob = new Blob(this._parts);\n    this._parts = [];\n    return Promise.resolve();\n  }\n\n  get blob(): Blob {\n    if (!this._blob) {\n      throw 'BlobWriter must be closed first!';\n    }\n    return this._blob;\n  }\n}\n\n/** Reader implentation using the node.js filesystem API. */\nexport class NodeReader implements Reader {\n  private fileHandle: nodeFs.promises.FileHandle;\n\n  constructor(handle: nodeFs.promises.FileHandle) {\n    this.fileHandle = handle;\n  }\n\n  async read(\n    dst: Uint8Array,\n    offset: number,\n    position: number,\n    length: number\n  ): Promise<number> {\n    const { bytesRead } = await this.fileHandle.read(\n      dst,\n      offset,\n      length,\n      position\n    );\n    return bytesRead;\n  }\n\n  async size(): Promise<number> {\n    const stat = await this.fileHandle.stat();\n    return stat.size;\n  }\n}\n/** Writer implementation using the node.js filesystem API. */\nexport class NodeWriter implements Writer {\n  _writable: NodeWritable;\n  _drainWaiters: Array<() => void> = [];\n\n  constructor(writable: NodeWritable) {\n    this._writable = writable;\n    this._writable.on('drain', () => {\n      log.debug('Drained writer.');\n      for (const waiter of this._drainWaiters) {\n        waiter();\n      }\n      this._drainWaiters = [];\n    });\n    this._writable.on('close', () => {\n      for (const waiter of this._drainWaiters) {\n        waiter();\n      }\n      this._drainWaiters = [];\n    });\n  }\n\n  async write(buffer: string | Uint8Array): Promise<void> {\n    let waitForDrain = false;\n    const out = new Promise<void>((resolve, reject) => {\n      if (!this._writable.writable) {\n        reject('Cannot write to closed NodeWriter.');\n      }\n      waitForDrain = !this._writable.write(buffer, (err) =>\n        err ? reject(err) : resolve()\n      );\n    });\n    if (waitForDrain) {\n      log.debug('Waiting for writer to drain');\n      return await this.waitForDrain();\n    } else {\n      return await out;\n    }\n  }\n\n  waitForDrain(): Promise<void> {\n    return new Promise((resolve) => this._drainWaiters.push(resolve));\n  }\n\n  close(): Promise<void> {\n    return new Promise((resolve) => this._writable.end(() => resolve()));\n  }\n}\n\n/** Very basic Reader implementation using an Array. */\nexport class ArrayReader implements Reader {\n  _buf: Uint8Array;\n\n  constructor(buf: Uint8Array) {\n    this._buf = buf;\n  }\n\n  read(\n    dst: Uint8Array,\n    offset: number,\n    position: number,\n    length: number\n  ): Promise<number> {\n    const sub = this._buf.subarray(position, position + length);\n    dst.set(sub, offset);\n    return Promise.resolve(sub.length);\n  }\n\n  size(): Promise<number> {\n    return Promise.resolve(this._buf.length);\n  }\n}\n","/*\nTaken from Hopding/png-ts, which is a TypeScript port by Andrew Dillon of the\nPNG decoder from pdfkit written by Devon Govett.\nThe original code can be found at:\nhttps://github.com/Hopding/png-ts/blob/master/src/png.ts\n\nModified by me (@jbaiter):\n- use `fflate` instead of `pako` for decompression.\n- add support for decoding interlaced images\n\nMIT License\n\nCopyright (c) 2018 Andrew Dillon\nCopyright (c) 2017 Devon Govett\n\nPermission is hereby granted, free of charge, to any person obtaining a copy\nof this software and associated documentation files (the \"Software\"), to deal\nin the Software without restriction, including without limitation the rights\nto use, copy, modify, merge, publish, distribute, sublicense, and/or sell\ncopies of the Software, and to permit persons to whom the Software is\nfurnished to do so, subject to the following conditions:\n\nThe above copyright notice and this permission notice shall be included in all\ncopies or substantial portions of the Software.\n\nTHE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\nIMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\nFITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\nAUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\nLIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\nOUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\nSOFTWARE.\n*/\nimport { unzipSync, unzlibSync } from \"fflate\";\n\nexport type ColorSpace = 'DeviceGray' | 'DeviceRGB';\n\nexport default class PNG {\n  static load = (data: Uint8Array) => new PNG(data);\n\n  palette: number[];\n  imgData: Uint8Array;\n  transparency: {\n    indexed?: number[];\n    grayscale?: number;\n    rgb?: number[];\n  };\n  text: { [key: string]: string };\n  width!: number;\n  height!: number;\n  bits!: number;\n  colorType!: number;\n  compressionMethod!: number;\n  filterMethod!: number;\n  interlaceMethod!: number;\n  colors: 1 | 3;\n  hasAlphaChannel: boolean;\n  pixelBitlength: number;\n  colorSpace: ColorSpace;\n\n  private data: Uint8Array;\n  private pos: number;\n\n  constructor(data: Uint8Array) {\n    this.data = data;\n    this.pos = 8; // Skip the default header;\n\n    this.palette = [];\n    const imgDataBuff = [];\n    this.transparency = {};\n    this.text = {};\n\n    while (true) {\n      const chunkSize = this.readUInt32();\n\n      let section = '';\n      for (let i = 0; i < 4; i++) {\n        section += String.fromCharCode(this.data[this.pos++]);\n      }\n\n      switch (section) {\n        case 'IHDR': {\n          // We can grab interesting values from here (like width, height, etc...)\n          this.width = this.readUInt32();\n          this.height = this.readUInt32();\n          this.bits = this.data[this.pos++];\n          this.colorType = this.data[this.pos++];\n          this.compressionMethod = this.data[this.pos++];\n          this.filterMethod = this.data[this.pos++];\n          this.interlaceMethod = this.data[this.pos++];\n          break;\n        }\n\n        case 'PLTE': {\n          this.palette = this.read(chunkSize);\n          break;\n        }\n\n        case 'IDAT': {\n          for (let i = 0; i < chunkSize; i++) {\n            imgDataBuff.push(this.data[this.pos++]);\n          }\n          break;\n        }\n\n        case 'tRNS': {\n          // This chunk can only occur once and it must occur after the\n          // PLTE chunk and before the IDAT chunk.\n          this.transparency = {};\n          switch (this.colorType) {\n            case 3: {\n              // Indexed color, RGB. Each byte in this chunk is an alpha for the\n              // palette index in the PLTE (\"palette\") chunk up until the last\n              // non-opaque entry. Set up an array, stretching over all palette\n              // entries which will be 0 (opaque) or 1 (transparent).\n              this.transparency.indexed = this.read(chunkSize);\n              const short = 255 - this.transparency.indexed.length;\n              if (short > 0) {\n                for (let i = 0; i < 255; i++) {\n                  this.transparency.indexed.push(255);\n                }\n              }\n              break;\n            }\n            case 0: {\n              // Greyscale. Corresponding to entries in the PLTE chunk.\n              // Grey is two bytes, range 0 .. (2 ^ bit-depth) - 1\n              this.transparency.grayscale = this.read(chunkSize)[0];\n              break;\n            }\n            case 2: {\n              // True color with proper alpha channel.\n              this.transparency.rgb = this.read(chunkSize);\n              break;\n            }\n          }\n          break;\n        }\n\n        case 'tEXt': {\n          const text = this.read(chunkSize);\n          const index = text.indexOf(0);\n          const key = String.fromCharCode(...text.slice(0, index));\n          this.text[key] = String.fromCharCode(...text.slice(index + 1));\n          break;\n        }\n\n        case 'IEND': {\n          // We've got everything we need!\n          const colorTypeMap: { [colorType: number]: 1 | 3 } = {\n            0: 1,\n            3: 1,\n            4: 1,\n            2: 3,\n            6: 3,\n          };\n          this.colors = colorTypeMap[this.colorType];\n\n          this.hasAlphaChannel = [4, 6].includes(this.colorType);\n          const colors = this.colors + (this.hasAlphaChannel ? 1 : 0);\n          this.pixelBitlength = this.bits * colors;\n          this.colorSpace = {\n            1: 'DeviceGray',\n            3: 'DeviceRGB',\n          }[this.colors] as ColorSpace;\n          this.imgData = new Uint8Array(imgDataBuff);\n\n          return;\n        }\n\n        default: {\n          // Unknown (or unimportant) section, skip it\n          this.pos += chunkSize;\n        }\n      }\n\n      this.pos += 4; // Skip the CRC\n      if (this.pos > this.data.length) {\n        throw new Error('Incomplete or corrupt PNG file');\n      }\n    }\n  }\n\n  decode = () => {\n    const retVal = new Uint8Array(this.width * this.height * 4);\n    const pixels = this.decodePixels();\n    this.copyImageDataToBuffer(retVal, pixels);\n    return retVal;\n  };\n\n  copyImageDataToBuffer = (imageData: Uint8Array, pixels: Uint8Array): void => {\n    let colors: 1 | 3 | 4 = this.colors;\n    let palette;\n    let alpha = this.hasAlphaChannel;\n\n    if (this.palette.length) {\n      palette = this.decodePalette();\n      colors = 4;\n      alpha = true;\n    }\n\n    const data = imageData;\n    const length = data.length;\n    const input = palette || pixels;\n\n    let i = 0;\n    let j = 0;\n\n    if (colors === 1) {\n      while (i < length) {\n        let k = palette ? pixels[i / 4] * 4 : j;\n        const v = input[k++];\n        data[i++] = v;\n        data[i++] = v;\n        data[i++] = v;\n        data[i++] = alpha ? input[k++] : 255;\n        j = k;\n      }\n    } else {\n      while (i < length) {\n        let k = palette ? pixels[i / 4] * 4 : j;\n        data[i++] = input[k++];\n        data[i++] = input[k++];\n        data[i++] = input[k++];\n        data[i++] = alpha ? input[k++] : 255;\n        j = k;\n      }\n    }\n  };\n\n  decodePixels = (): Uint8Array => {\n    const data = unzlibSync(this.imgData);\n\n    const width = this.width;\n    const height = this.height;\n    const pixelBytes = this.pixelBitlength / 8;\n    const scanlineLength = pixelBytes * this.width;\n\n    const pixels = new Uint8Array(scanlineLength * this.height);\n    const length = data.length;\n    let row = 0;\n    let pos = 0;\n    let c = 0;\n\n    function pass(x0: number, y0: number, dx: number, dy: number, singlePass = false): void {\n      const w = Math.ceil((width - x0) / dx);\n      const h = Math.ceil((height - y0) / dy);\n      const scanlineLength = pixelBytes * w;\n      const buffer = singlePass ? pixels : new Uint8Array(scanlineLength * h);\n      let row = 0;\n      let c = 0;\n      while (row < h && pos < length) {\n        switch (data[pos++]) {\n          case 0: // None\n            for (let i = 0; i < scanlineLength; i++) {\n              buffer[c++] = data[pos++];\n            }\n            break;\n          case 1: // Sub\n            for (let i = 0; i < scanlineLength; i++) {\n              const byte = data[pos++];\n              const left = i < pixelBytes ? 0 : buffer[c - pixelBytes];\n              buffer[c++] = (byte + left) % 256;\n            }\n            break;\n          case 2: // Up\n            for (let i = 0; i < scanlineLength; i++) {\n              const byte = data[pos++];\n              const col = (i - (i % pixelBytes)) / pixelBytes;\n              const pixelsIdx = (row - 1) * scanlineLength + col * pixelBytes + (i % pixelBytes);\n              const upper = row && buffer[pixelsIdx];\n              buffer[c++] = (upper + byte) % 256;\n            }\n            break;\n          case 3: // Average\n            for (let i = 0; i < scanlineLength; i++) {\n              const byte = data[pos++];\n              const col = (i - (i % pixelBytes)) / pixelBytes;\n              const left = i < pixelBytes ? 0 : buffer[c - pixelBytes];\n              const pixelsIdx = (row - 1) * scanlineLength + col * pixelBytes + (i % pixelBytes);\n              const upper = row && buffer[pixelsIdx];\n              buffer[c++] = (byte + Math.floor((left + upper) / 2)) % 256;\n            }\n            break;\n          case 4: // Paeth\n            for (let i = 0; i < scanlineLength; i++) {\n              const byte = data[pos++];\n              const col = (i - (i % pixelBytes)) / pixelBytes;\n              const left = i < pixelBytes ? 0 : buffer[c - pixelBytes];\n              let upper;\n              let upperLeft;\n              if (row === 0) {\n                upper = upperLeft = 0;\n              } else {\n                const upperIdx = (row - 1) * scanlineLength + col * pixelBytes + (i % pixelBytes);\n                const upperLeftIdx = (row - 1) * scanlineLength + (col - 1) * pixelBytes + (i % pixelBytes);\n                upper = buffer[upperIdx];\n                upperLeft = col && buffer[upperLeftIdx];\n              }\n              const p = left + upper - upperLeft;\n              const pa = Math.abs(p - left);\n              const pb = Math.abs(p - upper);\n              const pc = Math.abs(p - upperLeft);\n              let paeth;\n              if (pa <= pb && pa <= pc) {\n                paeth = left;\n              } else if (pb <= pc) {\n                paeth = upper;\n              } else {\n                paeth = upperLeft;\n              }\n              buffer[c++] = (byte + paeth) % 256;\n            }\n            break;\n          default:\n            throw new Error(`Invalid filter algorithm: ${data[pos - 1]}`);\n          }\n\n          if (!singlePass) {\n            let pixelsPos = ((y0 + row * dy) * width + x0) * pixelBytes;\n            let bufferPos = row * scanlineLength;\n            for (let i = 0; i < w; i++) {\n              for (let j = 0; j < pixelBytes; j++) {\n                pixels[pixelsPos++] = buffer[bufferPos++];\n              }\n              pixelsPos += (dx - 1) * pixelBytes;\n            }\n          }\n\n          row++;\n      }\n    }\n\n    if (this.interlaceMethod === 0) {\n      // Single pass from top to bottom with no skips\n      pass(0, 0, 1, 1, true);\n    } else {\n      /*\n        Adam7 interlacing consists of 7 passes over the data, each one\n        starting at a different x,y offset and covering a different fraction of the pixels.\n\n        1 6 4 6 2 6 4 6\n        7 7 7 7 7 7 7 7\n        5 6 5 6 5 6 5 6\n        7 7 7 7 7 7 7 7\n        3 6 4 6 3 6 4 6\n        7 7 7 7 7 7 7 7\n        5 6 5 6 5 6 5 6\n        7 7 7 7 7 7 7 7\n      */\n      pass(0, 0, 8, 8); // 1\n      pass(4, 0, 8, 8); // 2\n      pass(0, 4, 4, 8); // 3\n      pass(2, 0, 4, 4); // 4\n      pass(0, 2, 2, 4); // 5\n      pass(1, 0, 2, 2); // 6\n      pass(0, 1, 1, 2); // 7\n    }\n\n\n    return pixels;\n  };\n\n  private read = (numBytes: number): number[] => {\n    const results = [];\n    for (let i = 0; i < numBytes; i++) {\n      results[i] = this.data[this.pos++];\n    }\n    return results;\n  };\n\n  private readUInt32 = (): number => {\n    const b1 = this.data[this.pos++] << 24;\n    const b2 = this.data[this.pos++] << 16;\n    const b3 = this.data[this.pos++] << 8;\n    const b4 = this.data[this.pos++];\n    return b1 | b2 | b3 | b4;\n  };\n\n  private decodePalette = (): Uint8Array => {\n    const palette = this.palette;\n    const transparency = this.transparency.indexed || [];\n    const retVal = new Uint8Array(transparency.length + palette.length);\n    let pos = 0;\n    let c = 0;\n\n    for (let i = 0; i < palette.length; i++) {\n      retVal[pos++] = palette[i];\n      retVal[pos++] = palette[i + 1];\n      retVal[pos++] = palette[i + 2];\n      const temp = transparency[c++];\n      retVal[pos++] = temp !== undefined ? temp : 255;\n    }\n\n    return retVal;\n  };\n}","/* Based on the `images` modules in `pdfkit` by Devon Govett, licensed under MIT.\n *\n * Ported to TypeScript and modified to better fit a web use case, by using Uint8Array\n * instead of Buffer.\n *\n * https://github.com/foliojs/pdfkit/blob/master/lib/image/jpeg.js\n * https://github.com/foliojs/pdfkit/blob/master/lib/image/png.js\n *\n * MIT LICENSE\n * Copyright (c) 2011 Devon Govett\n *\n * Permission is hereby granted, free of charge, to any person obtaining a copy of this\n * software and associated documentation files (the \"Software\"), to deal in the Software\n * without restriction, including without limitation the rights to use, copy, modify, merge,\n * publish, distribute, sublicense, and/or sell copies of the Software, and to permit persons\n * to whom the Software is furnished to do so, subject to the following conditions:\n *\n * The above copyright notice and this permission notice shall be included in all copies or\n * substantial portions of the Software.\n *\n * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING\n * BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND\n * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM,\n * DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.\n */\nimport { zlibSync } from 'fflate';\nimport { PdfDictionary, serialize, PdfObject, makeRef } from './common.js';\nimport PNG from './png.js';\nimport { IS_BIG_ENDIAN } from './util.js';\n\nfunction readUint16BE(buf: Uint8Array, pos = 0): number {\n  const val = new Uint16Array(buf.slice(pos, pos + 2).buffer)[0];\n  if (IS_BIG_ENDIAN) {\n    return val;\n  } else {\n    // system is little endian, swap bytes in value from buffer\n    return ((val & 0xff) << 8) | ((val >> 8) & 0xff);\n  }\n}\n\nabstract class PdfImage {\n  static open(data: Uint8Array): PdfImage {\n    if (data.length > 2 && data[0] === 0xff && data[1] === 0xd8) {\n      return new JPEGImage(data);\n    } else if (\n      data.length > 8 &&\n      data[0] === 0x89 &&\n      data[1] === 0x50 &&\n      data[2] === 0x4e &&\n      data[3] === 0x47 &&\n      data[4] === 0x0d &&\n      data[5] === 0x0a &&\n      data[6] === 0x1a &&\n      data[7] === 0x0a\n    ) {\n      return new PNGImage(data);\n    } else {\n      throw new Error('Unknown image format.');\n    }\n  }\n\n  abstract toObjects(\n    startNum: number,\n    isOptional?: boolean,\n    optionalTitle?: string,\n    optionalDefaultState?: boolean\n  ): Array<PdfObject>;\n}\n\nexport class JPEGImage extends PdfImage {\n  static MARKERS = [\n    0xffc0, 0xffc1, 0xffc2, 0xffc3, 0xffc5, 0xffc6, 0xffc7, 0xffc8, 0xffc9,\n    0xffca, 0xffcb, 0xffcc, 0xffcd, 0xffce, 0xffcf,\n  ];\n  static COLOR_SPACE_MAP = {\n    1: 'DeviceGray',\n    3: 'DeviceRGB',\n    4: 'DeviceCMYK',\n  };\n  data: Uint8Array;\n\n  bits: number;\n  width: number;\n  height: number;\n  colorSpace: string;\n\n  constructor(data: Uint8Array) {\n    super();\n    let marker;\n    this.data = data;\n    if (readUint16BE(this.data, 0) !== 0xffd8) {\n      throw 'SOI not found in JPEG';\n    }\n\n    let pos = 2;\n    while (pos < this.data.length) {\n      marker = readUint16BE(this.data, pos);\n      pos += 2;\n      if (JPEGImage.MARKERS.includes(marker)) {\n        break;\n      }\n      pos += readUint16BE(this.data, pos);\n    }\n\n    if (!marker || !JPEGImage.MARKERS.includes(marker)) {\n      throw 'Invalid JPEG.';\n    }\n    pos += 2;\n\n    this.bits = this.data[pos++];\n    this.height = readUint16BE(this.data, pos);\n    pos += 2;\n\n    this.width = readUint16BE(this.data, pos);\n    pos += 2;\n\n    const channels = this.data[pos++];\n    if ([1, 3, 4].indexOf(channels) < 0) {\n      throw 'Bad number of channels, only 1, 3 or 4 are supported';\n    }\n    this.colorSpace = JPEGImage.COLOR_SPACE_MAP[channels as 1 | 3 | 4];\n  }\n\n  toObjects(startNum: number): Array<PdfObject> {\n    const obj: PdfDictionary = {\n      Type: '/XObject',\n      Subtype: '/Image',\n      BitsPerComponent: this.bits,\n      Width: this.width,\n      Height: this.height,\n      ColorSpace: `/${this.colorSpace}`,\n      Filter: '/DCTDecode',\n      Length: this.data.length,\n    };\n\n    // add extra decode params for CMYK images. By swapping the\n    // min and max values from the default, we invert the colors. See\n    // section 4.8.4 of the spec.\n    if (this.colorSpace === 'DeviceCMYK') {\n      obj.Decode = [1.0, 0.0, 1.0, 0.0, 1.0, 0.0, 1.0, 0.0];\n    }\n    return [{ num: startNum, data: serialize(obj), stream: this.data }];\n  }\n}\n\nexport class PNGImage extends PdfImage {\n  label: string | undefined;\n  image: PNG;\n  width: number;\n  height: number;\n  imgData: Uint8Array;\n\n  constructor(data: Uint8Array, label?: string) {\n    super();\n    this.label = label;\n    this.image = new PNG(data);\n    this.width = this.image.width;\n    this.height = this.image.height;\n    this.imgData = this.image.imgData;\n  }\n\n  toObjects(startNum: number): Array<PdfObject> {\n    let dataDecoded = false;\n\n    const hasAlphaChannel = this.image.hasAlphaChannel;\n    const isInterlaced = this.image.interlaceMethod === 1;\n\n    const out: Array<PdfObject> = [];\n    let nextNum = startNum;\n    const imgObj: PdfObject = {\n      num: nextNum++,\n    };\n    out.push(imgObj);\n\n    const imgDict: PdfDictionary = {\n      Type: '/XObject',\n      Subtype: '/Image',\n      BitsPerComponent: hasAlphaChannel ? 8 : this.image.bits,\n      Width: this.width,\n      Height: this.height,\n      Filter: '/FlateDecode',\n    };\n\n    if (!hasAlphaChannel) {\n      imgDict.DecodeParms = {\n        Predictor: isInterlaced ? 1 : 15,\n        Colors: this.image.colors,\n        BitsPerComponent: this.image.bits,\n        Columns: this.width,\n      };\n    }\n\n    if (this.image.palette.length === 0) {\n      imgDict.ColorSpace = `/${this.image.colorSpace}`;\n    } else {\n      // embed the color palette in the PDF as an object stream\n      const paletteObj: PdfObject = {\n        num: nextNum++,\n        data: serialize({ Length: this.image.palette.length }),\n        stream: new Uint8Array(this.image.palette),\n      };\n      out.push(paletteObj);\n      // build the color space array for the image\n      imgDict.ColorSpace = [\n        '/Indexed',\n        '/DeviceRGB',\n        this.image.palette.length / 3 - 1,\n        makeRef(paletteObj),\n      ];\n    }\n\n    // For PNG color types 0, 2 and 3, the transparency data is stored in\n    // a dedicated PNG chunk.\n    if (this.image.transparency.grayscale != null) {\n      // Use Color Key Masking (spec section 4.8.5)\n      // An array with N elements, where N is two times the number of color components.\n      const val = this.image.transparency.grayscale;\n      imgDict.Mask = [val, val];\n    } else if (this.image.transparency.rgb) {\n      // Use Color Key Masking (spec section 4.8.5)\n      // An array with N elements, where N is two times the number of color components.\n      const { rgb } = this.image.transparency;\n      const mask = [];\n      for (let x of rgb) {\n        mask.push(x, x);\n      }\n\n      imgDict.Mask = mask;\n    } else if (this.image.transparency.indexed) {\n      // Create a transparency SMask for the image based on the data\n      // in the PLTE and tRNS sections. See below for details on SMasks.\n      const alphaChannelObj = this.loadIndexedAlphaChannel(nextNum++);\n      imgDict.SMask = makeRef(alphaChannelObj);\n      out.push(alphaChannelObj);\n      dataDecoded = true;\n    } else if (hasAlphaChannel) {\n      // For PNG color types 4 and 6, the transparency data is stored as a alpha\n      // channel mixed in with the main image data. Separate this data out into an\n      // SMask object and store it separately in the PDF.\n      const [imageData, alphaChannelObj] = this.splitAlphaChannel(nextNum++);\n      imgObj.stream = zlibSync(imageData);\n      imgDict.Length = imgObj.stream.length;\n      imgDict.SMask = makeRef(alphaChannelObj);\n      out.push(alphaChannelObj);\n    }\n\n    if (isInterlaced && !dataDecoded && !imgObj.stream) {\n      imgObj.stream = zlibSync(this.image.decodePixels());\n      imgDict.Length = imgObj.stream.length;\n    } else if (!imgObj.stream) {\n      imgObj.stream = this.imgData;\n      imgDict.Length = imgObj.stream.length;\n    }\n\n    imgObj.data = serialize(imgDict);\n\n    if (out.length < 3) {\n      // Add empty dummy objects until we have 3 objects for the image, to stay true\n      // to our pre-determined object numbering\n      for (let i = out.length; i < 3; i++) {\n        out.push({ num: nextNum++ });\n      }\n    }\n    return out;\n  }\n\n  splitAlphaChannel(objNum: number): [Uint8Array, PdfObject] {\n    const pixels = this.image.decodePixels();\n    const colorCount = this.image.colors;\n    const pixelCount = this.width * this.height;\n    const imgData = new Uint8Array(pixelCount * colorCount);\n    const alphaChannel = new Uint8Array(pixelCount);\n\n    let i = 0;\n    let a = 0;\n    let p = 0;\n    const len = pixels.length;\n    // For 16bit images copy only most significant byte (MSB) - PNG data is always stored in network byte order (MSB first)\n    const skipByteCount = this.image.bits === 16 ? 1 : 0;\n    while (i < len) {\n      for (let colorIndex = 0; colorIndex < colorCount; colorIndex++) {\n        imgData[p++] = pixels[i++];\n        i += skipByteCount;\n      }\n      alphaChannel[a++] = pixels[i++];\n      i += skipByteCount;\n    }\n\n    const alphaChannelDeflated = zlibSync(alphaChannel);\n    return [\n      imgData,\n      {\n        num: objNum,\n        data: serialize({\n          Type: '/XObject',\n          Subtype: '/Image',\n          Width: this.width,\n          Height: this.height,\n          BitsPerComponent: 8,\n          Decode: [0, 1],\n          ColorSpace: '/DeviceGray',\n          Filter: '/FlateDecode',\n          Length: alphaChannelDeflated.length,\n        }),\n        stream: alphaChannelDeflated,\n      },\n    ];\n  }\n\n  loadIndexedAlphaChannel(objNum: number): PdfObject {\n    const pixels = this.image.decodePixels();\n    const transparency = this.image.transparency.indexed!;\n    const alphaChannel = new Uint8Array(this.width * this.height);\n\n    let i = 0;\n    for (let j = 0, end = pixels.length; j < end; j++) {\n      alphaChannel[i++] = transparency[pixels[j]];\n    }\n\n    const alphaChannelDeflated = zlibSync(alphaChannel);\n    return {\n      num: objNum,\n      data: serialize({\n        Type: '/XObject',\n        Subtype: '/Image',\n        Width: this.width,\n        Height: this.height,\n        BitsPerComponent: 8,\n        Decode: [0, 1],\n        ColorSpace: '/DeviceGray',\n        Filter: '/FlateDecode',\n        Length: alphaChannelDeflated.length,\n      }),\n      stream: alphaChannelDeflated,\n    };\n  }\n}\n\nexport default PdfImage;\n","import { Reader } from '../io.js';\nimport { PdfObject, PdfValue, PdfDictionary, PdfRef } from './common.js';\nimport { textDecoder, textEncoder } from './util.js';\n\n// Polyfill Uint8Array.findLastIndex for older browsers\nif (!Uint8Array.prototype.findLastIndex) {\n  Uint8Array.prototype.findLastIndex = function (\n    predicate: (value: number, index: number, obj: Uint8Array) => boolean\n  ): number {\n    let l = this.length;\n    while (l--) {\n      if (predicate(this[l], l, this)) return l;\n    }\n    return -1;\n  };\n}\n\nconst ESCAPE_CHARS: Record<string, string> = {\n  n: '\\n',\n  r: '\\r',\n  t: '\\t',\n  b: '\\b',\n  f: '\\f',\n  '(': '(',\n  ')': ')',\n  '\\\\': '\\\\',\n};\n\n//          offset/nextFree|generation|inUse?\n//                                     \ntype CrossRefEntry = [number, number, boolean];\ninterface CrossRefSubSection {\n  startNum: number;\n  numObjs: number;\n  entries: Array<CrossRefEntry>;\n}\n\n/** Parse a section of the x-ref table, yielding `CrossRefSubSection` objects as\n *  we encounter them.\n *\n * @param reader The reader to read from.\n * @param offset The offset of the x-ref section in the file.\n * @param length The length of the x-ref section.\n */\nasync function* parseCrossRefSection(\n  reader: Reader,\n  offset: number,\n  length: number\n): AsyncGenerator<CrossRefSubSection> {\n  const buf = new Uint8Array(length);\n  offset += await reader.read(buf, 0, offset, buf.length);\n  if (!testForString(buf, 0, 'xref')) {\n    throw 'Invalid crossreference section, did not start with `xref` line.';\n  }\n  const trailerIdx = buf.findIndex((_x, idx) =>\n    testForString(buf, idx, 'trailer')\n  );\n  // Split into lines and skip first line (`xref`)\n  const parts = textDecoder\n    .decode(buf.subarray(0, trailerIdx))\n    .split(/[\\r ]?\\n/)\n    .slice(1);\n  let currentSection: CrossRefSubSection | undefined;\n  for (const part of parts) {\n    // Entries have length 18 (we stripped the newline already)\n    if (part.length === 18) {\n      if (!currentSection) {\n        throw 'Invalid crossreference section, entry outside of subsection.';\n      }\n      const entryParts = part.trim().split(' ');\n      currentSection.entries.push([\n        Number.parseInt(entryParts[0], 10),\n        Number.parseInt(entryParts[1], 10),\n        entryParts[2] === 'n',\n      ]);\n    } else {\n      if (currentSection) {\n        if (currentSection.numObjs !== currentSection.entries.length) {\n          throw `Invalid subsection, expected ${currentSection.numObjs} objects, found ${currentSection.entries.length}!`;\n        }\n        yield currentSection;\n        currentSection = undefined;\n      }\n      if (part.length === 0 || part.indexOf('trailer') >= 0) {\n        break;\n      }\n      const [startNum, numObjs] = part\n        .trimEnd()\n        .split(' ')\n        .map((p) => Number.parseInt(p, 10));\n      currentSection = {\n        startNum,\n        numObjs,\n        entries: [],\n      };\n    }\n  }\n  if (currentSection) {\n    yield currentSection;\n  }\n  const trailerBuf = buf.subarray(trailerIdx);\n  const trailerStartIdx = trailerBuf.findIndex((_x, idx) =>\n    testForString(trailerBuf, idx, '<<')\n  );\n  const trailerEndIdx = trailerBuf.findIndex((_x, idx) =>\n    testForString(trailerBuf, idx, '>>')\n  );\n\n  const trailerDict = new PdfValueParser(\n    trailerBuf.subarray(trailerStartIdx, trailerEndIdx + 2)\n  ).read() as PdfDictionary;\n  if (trailerDict.Prev) {\n    const previousXrefOffset = trailerDict.Prev as number;\n    yield* parseCrossRefSection(\n      reader,\n      previousXrefOffset,\n      offset - previousXrefOffset\n    );\n  }\n}\n\n/** Look for a string from a given location in a buffer. */\nfunction testForString(\n  buf: Uint8Array,\n  offset: number,\n  value: string,\n  backwards = false\n): boolean {\n  if (backwards) {\n    for (let idx = value.length - 1; idx >= 0; idx--) {\n      if (buf[offset + idx] !== value.charCodeAt(idx)) {\n        return false;\n      }\n    }\n  } else {\n    for (let idx = 0; idx < value.length; idx++) {\n      if (buf[offset + idx] !== value.charCodeAt(idx)) {\n        return false;\n      }\n    }\n  }\n  return true;\n}\n\n/** Check if a string is the representation of an integer digit */\nfunction isDigit(c: string): boolean {\n  return !isNaN(parseInt(c, 10));\n}\n\n/** Check if a character is a hexadecimal digit ([0-9a-fA-F])  */\nfunction isHex(c: number): boolean {\n  return (\n    (c >= 0x30 && c <= 0x39) ||\n    (c >= 0x41 && c <= 0x46) ||\n    (c >= 0x61 && c <= 0x66)\n  );\n}\n\n/** Parse a PDF \"value\", which can be one of:\n * - number (integer or float)\n * - string\n * - name (represented as a JS string starting with `/`)\n * - boolean\n * - null\n * - date\n * - XRef\n * - Array\n * - Dictionary\n *\n * API walkthrough:\n * - `read()` is the main entry point, it will read the next value from the\n *   buffer and advance the cursor\n *  - `match*` methods check if the buffer at the current offset matches a\n *    certain type of value, either returning a boolean or the section of the\n *    buffer containing the value as a string.\n *  - `read*` methods read a value of a specific type from the buffer and\n *    advance the cursor\n */\nexport class PdfValueParser {\n  start = 0;\n  current = 0;\n  private readonly buf: Uint8Array;\n\n  /** Construct a parser for a buffer containing one or more PDF values. */\n  constructor(buf: Uint8Array) {\n    this.buf = buf;\n  }\n\n  /** Get the buffer content at the current offset as a character. */\n  private getChar(): string {\n    return String.fromCharCode(this.buf[this.current]);\n  }\n\n  /** Compares the buffer contents at the current offset against a string value. */\n  private matchValue(value: string): boolean {\n    const valueRead = textDecoder.decode(\n      this.buf.subarray(\n        this.current,\n        this.current + textEncoder.encode(value).length\n      )\n    );\n    return valueRead === value;\n  }\n\n  /** Checks if the buffer at the current offset contains a number.\n   *\n   * See ISO32000-2:2020 section 7.3.3.\n   */\n  private matchInteger(resetAfter = true): string | undefined {\n    this.start = this.current;\n    let chr: string;\n    let isInt = true;\n    const chars: string[] = [];\n    while (\n      !this.matchWhiteSpace((chr = this.getChar())) &&\n      !this.matchDelimiter(chr)\n    ) {\n      if (chr === '+' || chr === '-') {\n        if (this.current - this.start > 0) {\n          isInt = false;\n          break;\n        }\n      } else if (!isDigit(chr)) {\n        isInt = false;\n        break;\n      }\n      this.current++;\n      chars.push(chr);\n    }\n    if (resetAfter) {\n      this.current = this.start;\n    }\n    return isInt ? chars.join('') : undefined;\n  }\n\n  /** Read a PDF value from the current offset, advancing the cursor. */\n  read(): PdfValue {\n    let c = this.getChar();\n    if (this.matchWhiteSpace(c)) {\n      this.skipWhiteSpace();\n      c = this.getChar();\n    }\n    switch (this.getChar()) {\n      case '[':\n        return this.readArray();\n      case '<':\n        return this.matchValue('<<') ? this.readDict() : this.readHexString();\n      case '(':\n        return this.readLiteralString();\n      case '/':\n        return this.readName();\n      case 't':\n        if (this.matchValue('true')) {\n          this.current += 'true'.length;\n          return true;\n        }\n        throw new Error('Unexpected character while parsing');\n      case 'f':\n        if (this.matchValue('false')) {\n          this.current += 'false'.length;\n          return false;\n        }\n        throw new Error('Unexpected character while parsing');\n      case 'n':\n        if (this.matchValue('null')) {\n          this.current += 'null'.length;\n          return null;\n        }\n        throw new Error('Unexpected character while parsing');\n      case '.':\n        return this.readRealNumber();\n      default:\n        if (this.matchIndirectObject()) {\n          return this.readIndirectObject();\n        }\n        if (this.matchRealNumber()) {\n          return this.readRealNumber();\n        }\n        if (this.matchInteger()) {\n          return this.readInteger();\n        }\n        throw new Error(\n          `Encountered unexpected character during parsing: '${c}'`\n        );\n    }\n  }\n\n  /** Check if the input string contains PDF whitespace.\n   *\n   * See ISO32000-2:2020 section 7.2.3, Table 1.\n   */\n  matchWhiteSpace(c: string): boolean {\n    return (\n      c === ' ' ||\n      c === '\\x00' ||\n      c === '\\n' ||\n      c === '\\r' ||\n      c === '\\r\\n' ||\n      c == '\\x0C'\n    );\n  }\n\n  /** Read an integer from the current offset. */\n  readInteger(): number {\n    const intStr = this.matchInteger(false);\n    if (intStr === undefined) {\n      throw new Error('Failed to read integer.');\n    }\n    return Number.parseInt(intStr, 10);\n  }\n\n  /** Read an indirect object from the current offset. */\n  readIndirectObject(): PdfRef {\n    const match = this.matchIndirectObject(false);\n    if (match === undefined) {\n      throw new Error('Failed to read indirect object');\n    }\n    return new PdfRef(Number.parseInt(match.split(' ')[0]));\n  }\n\n  /** Check if the buffer contains an indirect object at the current offset.\n   *\n   * See ISO32000-2:2020 section 7.3.10.\n   */\n  matchIndirectObject(resetAfter = true): string | undefined {\n    this.start = this.current;\n    let c = this.getChar();\n    const chars: string[] = [];\n    const matchNumber = (): boolean => {\n      if (!isDigit(c)) {\n        return false;\n      }\n      chars.push(c);\n      this.current++;\n      while (isDigit((c = this.getChar()))) {\n        chars.push(c);\n        this.current++;\n      }\n      return true;\n    };\n    const matchWhitespace = (): boolean => this.skipWhiteSpace();\n    // Using a closure makes resetting afterwards less verbose\n    const match = (): boolean => {\n      // Object number\n      if (!matchNumber()) {\n        return false;\n      }\n      if (!matchWhitespace()) {\n        return false;\n      }\n      chars.push(' ');\n      c = this.getChar();\n      // Generation number\n      if (!matchNumber()) {\n        return false;\n      }\n      if (!matchWhitespace()) {\n        return false;\n      }\n      chars.push(' ');\n      if (this.getChar() !== 'R') {\n        return false;\n      }\n      chars.push('R');\n      this.current++;\n      return true;\n    };\n    const doesMatch = match();\n    if (resetAfter) {\n      this.current = this.start;\n    }\n    if (doesMatch) {\n      return chars.join('');\n    }\n  }\n\n  /** Check if the buffer contains a real number at the current offset.\n   *\n   * See ISO32000-2:2020 section 7.3.3.\n   */\n  matchRealNumber(resetAfter = true): string | undefined {\n    this.start = this.current;\n    let isRealNumber = true;\n    let digitSeen = false;\n    let separatorSeen = false;\n    const chars: string[] = [];\n    let c: string;\n    // eslint-disable-next-line no-constant-condition\n    while (true) {\n      c = this.getChar();\n      if (c === '.') {\n        if (separatorSeen) {\n          isRealNumber = false;\n          break;\n        }\n        separatorSeen = true;\n      } else if (isDigit(c)) {\n        digitSeen = true;\n      } else if (c === '-' || c === '+') {\n        if (this.current - this.start > 0) {\n          break;\n        }\n      } else {\n        break;\n      }\n      chars.push(c);\n      this.current++;\n    }\n    if (resetAfter) {\n      this.current = this.start;\n    }\n    if (!isRealNumber) {\n      return undefined;\n    }\n    if (digitSeen && separatorSeen) {\n      return chars.join('');\n    }\n    return undefined;\n  }\n\n  /** Read a real number from the current offset. */\n  readRealNumber(): number {\n    const str = this.matchRealNumber(false);\n    if (!str) {\n      throw new Error('Could not read real number.');\n    }\n    return Number.parseFloat(str);\n  }\n\n  /** Skip a contiguous sequence of whitespae, advancing the cursor. */\n  skipWhiteSpace(): boolean {\n    let skipped = false;\n    while (!this.atEnd() && this.matchWhiteSpace(this.getChar())) {\n      this.current++;\n      skipped = true;\n    }\n    return skipped;\n  }\n\n  /** Check if we're at the end of the buffer. */\n  atEnd(): boolean {\n    return this.current >= this.buf.length;\n  }\n\n  /** Read a name from the current offset.\n   *\n   * See ISO32000-2:2020 section 7.3.5.\n   */\n  readName(): PdfValue {\n    const chars: string[] = ['/'];\n    this.current++;\n    let c: string;\n    while (\n      !this.matchWhiteSpace((c = this.getChar())) &&\n      !this.matchDelimiter(c)\n    ) {\n      if (c === '#') {\n        const a = this.buf[this.current++];\n        const b = this.buf[this.current++];\n        if (!isHex(a) || !isHex(b)) {\n          throw new Error('Illegal character escape in name.');\n        }\n        chars.push(\n          String.fromCharCode(\n            Number.parseInt(String.fromCharCode(a) + String.fromCharCode(b), 16)\n          )\n        );\n      } else {\n        chars.push(c);\n        this.current++;\n      }\n    }\n    return chars.join('');\n  }\n\n  /** Check if the current offset contains a delimiter.\n   *\n   * See ISO32000-2:2020 section 7.2.3, Table 2\n   */\n  matchDelimiter(c: string): boolean {\n    return '[]{}()<>/%'.indexOf(c) >= 0;\n  }\n\n  /** Read a hex string from the current offset.\n   *\n   * See ISO32000-2:2020 section 7.3.4.3\n   */\n  readHexString(): PdfValue {\n    this.current++;\n    const vals: Array<number> = [];\n    while (this.getChar() !== '>') {\n      const a = this.buf[this.current++];\n      const b = this.buf[this.current++];\n      if (!isHex(a) || !isHex(b)) {\n        throw new Error(`Invalid value in hex string: '${a}${b}`);\n      }\n      vals.push(\n        Number.parseInt(String.fromCharCode(a) + String.fromCharCode(b), 16)\n      );\n    }\n    this.current++;\n    return new Uint8Array(vals);\n  }\n\n  /** Read a literal string from the current offset.\n   *\n   * See ISO32000-2:2020 section 7.3.4.2\n   */\n  readLiteralString(): PdfValue {\n    this.current++;\n    const chars: string[] = [];\n    let openParens = 0;\n    let c: string;\n    // eslint-disable-next-line no-constant-condition\n    while (true) {\n      c = this.getChar();\n      if (c === '\\\\') {\n        this.current++;\n        c = this.getChar();\n        if (isDigit(c)) {\n          let cs = [c];\n          this.current++;\n          while (isDigit(this.getChar())) {\n            cs.push(this.getChar());\n            this.current++;\n          }\n          if (cs.length > 3) {\n            this.current -= cs.length - 3;\n            cs = cs.slice(0, 3);\n          }\n          this.current--;\n          c = String.fromCharCode(Number.parseInt(cs.join(''), 8));\n        } else {\n          c = ESCAPE_CHARS[c];\n          if (c === undefined) {\n            throw new Error(\n              `Illegal escape sequence in string literal: '\\\\${c}`\n            );\n          }\n        }\n      } else if (c === '(') {\n        openParens++;\n      } else if (c === ')') {\n        openParens--;\n        if (openParens < 0) {\n          this.current++;\n          return chars.join('');\n        }\n      }\n      chars.push(c);\n      this.current++;\n    }\n  }\n\n  /** Read a dictionary from the current offset.\n   *\n   * See ISO32000-2:2020 section 7.3.7\n   */\n  readDict(): PdfValue {\n    this.current += 2;\n    const obj: Record<string, PdfValue> = {};\n    this.skipWhiteSpace();\n    while (this.getChar() !== '>') {\n      const name = this.read();\n      if (typeof name !== 'string' || !name.startsWith('/')) {\n        throw new Error(`Dictionary keys must be name objects, got '${name}`);\n      }\n      this.skipWhiteSpace();\n      const val = this.read();\n      if (val !== null) {\n        obj[name.substring(1)] = val;\n      }\n      this.skipWhiteSpace();\n    }\n    this.current += 2;\n    return obj;\n  }\n\n  /** Read an array from the current offset.\n   *\n   * See ISO32000-2:2020 section 7.3.6\n   */\n  readArray(): Array<PdfValue> {\n    this.current++;\n    const arr: Array<PdfValue> = [];\n    while (this.getChar() !== ']') {\n      arr.push(this.read());\n      this.skipWhiteSpace();\n    }\n    this.current++;\n    return arr;\n  }\n}\n\n/** Minimalist low-level PDF parser operating on a Reader object.\n *\n * Currently only supports discovering page objects and annotation objects, as well\n * as obtaining arbitrary objects given the object number and generation.\n */\nexport class PdfParser {\n  private reader: Reader;\n  private objectOffsets: Array<number>;\n  private sortedOffsets: Array<number>;\n  pdfSize: any;\n  objGenerations: number[];\n  infoNum: number;\n  catalogNum: number;\n\n  /** Construct a new parser from a Reader.\n   *\n   * Used instead of the constructor to allow for async initialization.\n   */\n  static async parse(reader: Reader): Promise<PdfParser> {\n    const trailerBuf = new Uint8Array(1024);\n    const pdfSize = await reader.size();\n    const bufStart = pdfSize - trailerBuf.length;\n    await reader.read(trailerBuf, 0, bufStart, trailerBuf.length);\n    const eofIdx =\n      trailerBuf.length - (trailerBuf[trailerBuf.length - 1] === 0x46 ? 5 : 6);\n    if (!testForString(trailerBuf, eofIdx, '%%EOF')) {\n      throw 'Invalid PDF, missing EOF comment at end of file';\n    }\n    const startXrefPos = trailerBuf.findLastIndex((_x, idx) =>\n      testForString(trailerBuf, idx, 'startxref')\n    );\n    if (startXrefPos < 0) {\n      throw 'Invalid PDF, missing startxref marker in file trailer.';\n    }\n    const objGenerations: Array<number> = [];\n    const objsDeleted: Array<boolean> = [];\n    const objOffsets: Array<number> = [];\n    const xrefStartOffset = Number.parseInt(\n      textDecoder.decode(trailerBuf.subarray(startXrefPos + 9, eofIdx)).trim(),\n      10\n    );\n    const dictEnd =\n      trailerBuf.findLastIndex((_x, idx) =>\n        testForString(trailerBuf, idx, '>>')\n      ) + 2;\n    const dictStart = trailerBuf.findLastIndex((_x, idx) =>\n      testForString(trailerBuf, idx, '<<')\n    );\n    const trailerDict = new PdfValueParser(\n      trailerBuf.subarray(dictStart, dictEnd)\n    ).read() as PdfDictionary;\n    for await (const { startNum, entries } of parseCrossRefSection(\n      reader,\n      xrefStartOffset,\n      bufStart + dictEnd - xrefStartOffset\n    )) {\n      for (const [idx, [offset, gen, inUse]] of entries.entries()) {\n        const objNum = idx + startNum;\n        if ((objGenerations[objNum] ?? -1) > gen) {\n          // Outdated entry, don't consider\n          continue;\n        }\n        objGenerations[objNum] = gen;\n        if (inUse) {\n          objOffsets[objNum] = offset;\n          objsDeleted[objNum] = false;\n        } else {\n          objOffsets[objNum] = -1;\n          objsDeleted[objNum] = true;\n        }\n      }\n    }\n    if (objOffsets.length !== trailerDict.Size) {\n      throw `Trailer dictionary has different number of objects than crossreference tables, ${objOffsets.length} vs. ${trailerDict.Size}`;\n    }\n    return new PdfParser(reader, objOffsets, objGenerations, trailerDict);\n  }\n\n  /** Private constructor, use factory method above. */\n  private constructor(\n    reader: Reader,\n    objOffsets: Array<number>,\n    objGenerations: Array<number>,\n    trailerDict: PdfDictionary\n  ) {\n    this.reader = reader;\n    this.objectOffsets = objOffsets;\n    this.sortedOffsets = [...objOffsets].sort((a, b) => a - b);\n    this.objGenerations = objGenerations;\n    this.catalogNum = (trailerDict.Root as PdfRef).refObj;\n    this.infoNum = (trailerDict.Info as PdfRef).refObj;\n  }\n\n  /** Retrieve the catalog dictionary. */\n  async catalog(): Promise<PdfDictionary> {\n    const obj = await this.getObject(this.catalogNum);\n    if (!obj) {\n      throw `Document has no catalog object (num as per trailer: ${this.catalogNum}!`;\n    }\n    return obj.data as PdfDictionary;\n  }\n\n  /** Retrieve the info dictionary. */\n  async info(): Promise<PdfDictionary> {\n    const obj = await this.getObject(this.infoNum);\n    if (!obj) {\n      throw `Document has no info object (num as per trailer: ${this.infoNum}!`;\n    }\n    return obj.data as PdfDictionary;\n  }\n\n  /** Yield all pages referenced in the given page dictionary. */\n  async *_pagesFromPagesObj(\n    pagesObj: PdfDictionary\n  ): AsyncGenerator<PdfObject> {\n    for (const pageRef of pagesObj.Kids as Array<PdfRef>) {\n      const page = await this.getObject(pageRef.refObj, true);\n      if (!page) {\n        throw `Could not find Page object with number ${pageRef.refObj}`;\n      }\n      const pageDict = page.data as PdfDictionary;\n      if (pageDict.Type === '/Pages') {\n        yield* this._pagesFromPagesObj(pageDict);\n      } else {\n        yield page;\n      }\n    }\n  }\n\n  /** Yield all pages in the PDF. */\n  async *pages(): AsyncGenerator<PdfObject> {\n    const catalog = await this.catalog();\n    const pagesRef = catalog.Pages as PdfRef;\n    const pagesRoot = await this.getObject(pagesRef.refObj);\n    if (!pagesRoot) {\n      throw `Could not find Pages object with number ${pagesRef.refObj}`;\n    }\n    const pagesDict = pagesRoot.data as PdfDictionary;\n    yield* this._pagesFromPagesObj(pagesDict);\n  }\n\n  /** Yield all annotations for the given page dictionary. */\n  async *annotations(pageDict: PdfDictionary): AsyncGenerator<PdfDictionary> {\n    const annots = pageDict.Annots;\n    if (!annots) {\n      return;\n    }\n    for (const annoRef of annots as Array<PdfRef>) {\n      const anno = await this.getObject(annoRef.refObj);\n      if (!anno) {\n        throw `Could not find Annotation object with number ${annoRef.refObj}`;\n      }\n      yield anno.data as PdfDictionary;\n    }\n  }\n\n  /** Resolve a PDF reference to the corresponding object. */\n  resolveRef(ref: PdfRef): Promise<PdfObject | undefined> {\n    return this.getObject(ref.refObj, true);\n  }\n\n  /** Get an object from the PDF from its number. */\n  async getObject(\n    num: number,\n    withStream = false\n  ): Promise<PdfObject | undefined> {\n    const offset = this.objectOffsets[num];\n    if (!offset) {\n      return;\n    }\n    if (!this.pdfSize) {\n      this.pdfSize = await this.reader.size();\n    }\n    const nextOffset =\n      this.sortedOffsets[this.sortedOffsets.indexOf(offset) + 1] ??\n      this.pdfSize;\n    const buf = new Uint8Array(nextOffset - offset);\n    await this.reader.read(buf, 0, offset, buf.length);\n    const objEndIdx = buf.findIndex((_x, idx) =>\n      testForString(buf, idx, 'endobj')\n    );\n    let streamIdx = buf.findIndex((_x, idx) =>\n      testForString(buf, idx, 'stream')\n    );\n    if (streamIdx >= 0) {\n      streamIdx += 'stream'.length;\n      if (buf[streamIdx] === '\\r'.charCodeAt(0)) {\n        streamIdx += 2;\n      } else {\n        streamIdx += 1;\n      }\n    }\n    const objSig = `${num} ${this.objGenerations[num]} obj`;\n    const objParser = new PdfValueParser(\n      buf.subarray(objSig.length, streamIdx < 0 ? objEndIdx : streamIdx)\n    );\n    const data = objParser.read();\n    if (typeof data !== 'object' || data === null) {\n      throw new Error('Illegal PDF object, does not start with a dictionary.');\n    }\n    let stream: Uint8Array | undefined;\n    if (withStream && streamIdx > 0) {\n      const streamLength = (data as PdfDictionary).Length as number | undefined;\n      if (streamLength === undefined) {\n        throw new Error(\n          'Illegal stream object, missing Length entry in object dictionary.'\n        );\n      }\n      stream = buf.subarray(streamIdx, streamIdx + streamLength);\n    }\n    return {\n      num,\n      data,\n      stream,\n    };\n  }\n}\n","export default '0.2.6';\n","import { crc32 } from '../util.js';\nimport { textEncoder } from './util.js';\n\nexport type LocalHeaderParams = {\n  creationDate?: Date;\n  filename: string;\n  data: Uint8Array;\n  compressedData?: Uint8Array;\n  extraDataLength: number;\n};\n\nexport type CentralDirectoryFileSpec = {\n  localHeaderOffset: number;\n  deflated: boolean;\n  creationDate: Date;\n  crc32: number;\n  dataLength: number;\n  compressedDataLength: number;\n  filename: string;\n};\n\nexport type CentralFileDirectorySpec = {\n  files: CentralDirectoryFileSpec[];\n  trailingLength: number;\n  offset: number;\n};\n\nexport function buildLocalZipHeader({\n  creationDate = new Date(),\n  filename,\n  data,\n  compressedData,\n  extraDataLength,\n}: LocalHeaderParams): Uint8Array {\n  const creationTimeZip =\n    (creationDate.getHours() << 11) |\n    (creationDate.getDay() << 5) |\n    Math.round(creationDate.getSeconds() / 2);\n  const creationDateZip =\n    ((creationDate.getFullYear() - 1980) << 9) |\n    ((creationDate.getMonth() + 1) << 5) |\n    creationDate.getDate();\n  const dataCrc = crc32(data);\n  const filenameEncoded = textEncoder.encode(filename);\n  // 2 bytes for zlib header\n  const compressedLength = compressedData ? (compressedData.length - 2) : data.length;\n  return new Uint8Array([\n    // PKZIP magic number\n    0x50,\n    0x4b,\n    // Local File Header magic\n    0x03,\n    0x04,\n    // Required PKZip version\n    0x14,\n    0x00,\n    // General purpose bit flag, 2 bytes\n    0b00000000,\n    0b00000000,\n    // Compression method, 2 bytes little endian\n    compressedData ? 0x08 : 0x00,\n    0x00,\n    // Creation time, 2 bytes little endian\n    creationTimeZip & 0xff,\n    creationTimeZip >> 8,\n    // Creation date, 2 bytes little endian\n    creationDateZip & 0xff,\n    creationDateZip >> 8,\n    // CRC32 of data, 4 bytes little endian\n    dataCrc & 0xff,\n    (dataCrc >> 8) & 0xff,\n    (dataCrc >> 16) & 0xff,\n    (dataCrc >> 24) & 0xff,\n    // Compressed size, 4 bytes little endian\n    compressedLength & 0xff,\n    (compressedLength >> 8) & 0xff,\n    (compressedLength >> 16) & 0xff,\n    (compressedLength >> 24) & 0xff,\n    // Uncompressed size, 4 bytes little endian\n    data.length & 0xff,\n    (data.length >> 8) & 0xff,\n    (data.length >> 16) & 0xff,\n    (data.length >> 24) & 0xff,\n    // Filename length, 2 bytes little endian\n    filenameEncoded.length & 0xff,\n    filenameEncoded.length >> 8, // Filename length in little endian\n    // Extra field length, 2 bytes little endian\n    (extraDataLength + 4) & 0xff,\n    (extraDataLength + 4) >> 8,\n    // Encoded file name\n    ...filenameEncoded,\n    // Beginning of extra field: identifier, 2 bytes\n    0xff,\n    0xff,\n    // Beginning of extra field: length, 2 bytes little endian\n    extraDataLength & 0xff,\n    extraDataLength >> 8,\n  ]);\n}\n\nexport function buildCentralFileDirectory({\n  files,\n  trailingLength,\n  offset\n}: CentralFileDirectorySpec): Uint8Array {\n  const chunks = files.map(buildCentralDirectoryFileHeader);\n  const cdSize =  chunks.reduce((acc, chunk) => acc + chunk.length, 0);\n  chunks.push(new Uint8Array([\n    // PKZIP magic number\n    0x50,\n    0x4b,\n    // End of central directory magic\n    0x05,\n    0x06,\n    // Disk number\n    0x00,\n    0x00,\n    // Disk with central directory\n    0x00,\n    0x00,\n    // Disk entries\n    files.length & 0xff,\n    files.length >> 8,\n    // Total entries\n    files.length & 0xff,\n    files.length >> 8,\n    // Central directory size,\n    cdSize & 0xff,\n    (cdSize >> 8) & 0xff,\n    (cdSize >> 16) & 0xff,\n    (cdSize >> 24) & 0xff,\n    // Offset of central directory in file\n    offset & 0xff,\n    (offset >> 8) & 0xff,\n    (offset >> 16) & 0xff,\n    (offset >> 24) & 0xff,\n    // Length of trailing comment\n    trailingLength & 0xff,\n    trailingLength >> 8,\n  ]));\n  return new Uint8Array(\n    chunks.reduce((acc: number[], curr) => {\n      acc.push(...curr);\n      return acc;\n    }, [])\n  );\n}\n\nfunction buildCentralDirectoryFileHeader(\n  spec: CentralDirectoryFileSpec\n): Uint8Array {\n  const creationTimeZip =\n    (spec.creationDate.getHours() << 11) |\n    (spec.creationDate.getMinutes() << 5) |\n    Math.round(spec.creationDate.getSeconds() / 2);\n  const creationDateZip =\n    ((spec.creationDate.getFullYear() - 1980) << 9) |\n    ((spec.creationDate.getMonth() +1) << 5) |\n    spec.creationDate.getDate();\n  const filenameEncoded = textEncoder.encode(spec.filename);\n  return new Uint8Array([\n    // PKZIP magic number\n    0x50,\n    0x4b,\n    // Central directory file header magic\n    0x01,\n    0x02,\n    // Version\n    0x17,\n    0x03,\n    //  Version needed\n    0x14,\n    0x00,\n    // Flags, none set\n    0x00,\n    0x00,\n    // Compression method, 2 bytes little endian\n    spec.deflated ? 0x08 : 0x00,\n    0x00,\n    // Creation time, 2 bytes little endian\n    creationTimeZip & 0xff,\n    creationTimeZip >> 8,\n    // Creation date, 2 bytes little endian\n    creationDateZip & 0xff,\n    creationDateZip >> 8,\n    // CRC32 of data, 4 bytes little endian\n    spec.crc32 & 0xff,\n    (spec.crc32 >> 8) & 0xff,\n    (spec.crc32 >> 16) & 0xff,\n    (spec.crc32 >> 24) & 0xff,\n    // Compressed size, 4 bytes little endian\n    spec.compressedDataLength & 0xff,\n    (spec.compressedDataLength >> 8) & 0xff,\n    (spec.compressedDataLength >> 16) & 0xff,\n    (spec.compressedDataLength >> 24) & 0xff,\n    // Uncompressed size, 4 bytes little endian\n    spec.dataLength & 0xff,\n    (spec.dataLength >> 8) & 0xff,\n    (spec.dataLength >> 16) & 0xff,\n    (spec.dataLength >> 24) & 0xff,\n    // Filename length, 2 bytes little endian\n    filenameEncoded.length & 0xff,\n    filenameEncoded.length >> 8, // Filename length in little endian\n    // Extra field length, 2 bytes little endian\n    0x00,\n    0x00,\n    // File comment length, 2 bytes little endian\n    0x00,\n    0x00,\n    // Disk # start, 2 bytes little endian\n    0x00,\n    0x00,\n    // Internal Attribute, 2 bytes little endian\n    0x00,\n    0x00,\n    // External Attribute, 4 bytes little endian\n    0x00,\n    0x00,\n    0xa4,\n    0x81,\n    // Offset of local header, 4 bytes little endian\n    spec.localHeaderOffset & 0xff,\n    (spec.localHeaderOffset >> 8) &0xff,\n    (spec.localHeaderOffset >> 16) &0xff,\n    (spec.localHeaderOffset >> 24) &0xff,\n    ...filenameEncoded,\n  ]);\n}\n","'use strict'\r\n\r\nmodule.exports = {\r\n\t\"aliceblue\": [240, 248, 255],\r\n\t\"antiquewhite\": [250, 235, 215],\r\n\t\"aqua\": [0, 255, 255],\r\n\t\"aquamarine\": [127, 255, 212],\r\n\t\"azure\": [240, 255, 255],\r\n\t\"beige\": [245, 245, 220],\r\n\t\"bisque\": [255, 228, 196],\r\n\t\"black\": [0, 0, 0],\r\n\t\"blanchedalmond\": [255, 235, 205],\r\n\t\"blue\": [0, 0, 255],\r\n\t\"blueviolet\": [138, 43, 226],\r\n\t\"brown\": [165, 42, 42],\r\n\t\"burlywood\": [222, 184, 135],\r\n\t\"cadetblue\": [95, 158, 160],\r\n\t\"chartreuse\": [127, 255, 0],\r\n\t\"chocolate\": [210, 105, 30],\r\n\t\"coral\": [255, 127, 80],\r\n\t\"cornflowerblue\": [100, 149, 237],\r\n\t\"cornsilk\": [255, 248, 220],\r\n\t\"crimson\": [220, 20, 60],\r\n\t\"cyan\": [0, 255, 255],\r\n\t\"darkblue\": [0, 0, 139],\r\n\t\"darkcyan\": [0, 139, 139],\r\n\t\"darkgoldenrod\": [184, 134, 11],\r\n\t\"darkgray\": [169, 169, 169],\r\n\t\"darkgreen\": [0, 100, 0],\r\n\t\"darkgrey\": [169, 169, 169],\r\n\t\"darkkhaki\": [189, 183, 107],\r\n\t\"darkmagenta\": [139, 0, 139],\r\n\t\"darkolivegreen\": [85, 107, 47],\r\n\t\"darkorange\": [255, 140, 0],\r\n\t\"darkorchid\": [153, 50, 204],\r\n\t\"darkred\": [139, 0, 0],\r\n\t\"darksalmon\": [233, 150, 122],\r\n\t\"darkseagreen\": [143, 188, 143],\r\n\t\"darkslateblue\": [72, 61, 139],\r\n\t\"darkslategray\": [47, 79, 79],\r\n\t\"darkslategrey\": [47, 79, 79],\r\n\t\"darkturquoise\": [0, 206, 209],\r\n\t\"darkviolet\": [148, 0, 211],\r\n\t\"deeppink\": [255, 20, 147],\r\n\t\"deepskyblue\": [0, 191, 255],\r\n\t\"dimgray\": [105, 105, 105],\r\n\t\"dimgrey\": [105, 105, 105],\r\n\t\"dodgerblue\": [30, 144, 255],\r\n\t\"firebrick\": [178, 34, 34],\r\n\t\"floralwhite\": [255, 250, 240],\r\n\t\"forestgreen\": [34, 139, 34],\r\n\t\"fuchsia\": [255, 0, 255],\r\n\t\"gainsboro\": [220, 220, 220],\r\n\t\"ghostwhite\": [248, 248, 255],\r\n\t\"gold\": [255, 215, 0],\r\n\t\"goldenrod\": [218, 165, 32],\r\n\t\"gray\": [128, 128, 128],\r\n\t\"green\": [0, 128, 0],\r\n\t\"greenyellow\": [173, 255, 47],\r\n\t\"grey\": [128, 128, 128],\r\n\t\"honeydew\": [240, 255, 240],\r\n\t\"hotpink\": [255, 105, 180],\r\n\t\"indianred\": [205, 92, 92],\r\n\t\"indigo\": [75, 0, 130],\r\n\t\"ivory\": [255, 255, 240],\r\n\t\"khaki\": [240, 230, 140],\r\n\t\"lavender\": [230, 230, 250],\r\n\t\"lavenderblush\": [255, 240, 245],\r\n\t\"lawngreen\": [124, 252, 0],\r\n\t\"lemonchiffon\": [255, 250, 205],\r\n\t\"lightblue\": [173, 216, 230],\r\n\t\"lightcoral\": [240, 128, 128],\r\n\t\"lightcyan\": [224, 255, 255],\r\n\t\"lightgoldenrodyellow\": [250, 250, 210],\r\n\t\"lightgray\": [211, 211, 211],\r\n\t\"lightgreen\": [144, 238, 144],\r\n\t\"lightgrey\": [211, 211, 211],\r\n\t\"lightpink\": [255, 182, 193],\r\n\t\"lightsalmon\": [255, 160, 122],\r\n\t\"lightseagreen\": [32, 178, 170],\r\n\t\"lightskyblue\": [135, 206, 250],\r\n\t\"lightslategray\": [119, 136, 153],\r\n\t\"lightslategrey\": [119, 136, 153],\r\n\t\"lightsteelblue\": [176, 196, 222],\r\n\t\"lightyellow\": [255, 255, 224],\r\n\t\"lime\": [0, 255, 0],\r\n\t\"limegreen\": [50, 205, 50],\r\n\t\"linen\": [250, 240, 230],\r\n\t\"magenta\": [255, 0, 255],\r\n\t\"maroon\": [128, 0, 0],\r\n\t\"mediumaquamarine\": [102, 205, 170],\r\n\t\"mediumblue\": [0, 0, 205],\r\n\t\"mediumorchid\": [186, 85, 211],\r\n\t\"mediumpurple\": [147, 112, 219],\r\n\t\"mediumseagreen\": [60, 179, 113],\r\n\t\"mediumslateblue\": [123, 104, 238],\r\n\t\"mediumspringgreen\": [0, 250, 154],\r\n\t\"mediumturquoise\": [72, 209, 204],\r\n\t\"mediumvioletred\": [199, 21, 133],\r\n\t\"midnightblue\": [25, 25, 112],\r\n\t\"mintcream\": [245, 255, 250],\r\n\t\"mistyrose\": [255, 228, 225],\r\n\t\"moccasin\": [255, 228, 181],\r\n\t\"navajowhite\": [255, 222, 173],\r\n\t\"navy\": [0, 0, 128],\r\n\t\"oldlace\": [253, 245, 230],\r\n\t\"olive\": [128, 128, 0],\r\n\t\"olivedrab\": [107, 142, 35],\r\n\t\"orange\": [255, 165, 0],\r\n\t\"orangered\": [255, 69, 0],\r\n\t\"orchid\": [218, 112, 214],\r\n\t\"palegoldenrod\": [238, 232, 170],\r\n\t\"palegreen\": [152, 251, 152],\r\n\t\"paleturquoise\": [175, 238, 238],\r\n\t\"palevioletred\": [219, 112, 147],\r\n\t\"papayawhip\": [255, 239, 213],\r\n\t\"peachpuff\": [255, 218, 185],\r\n\t\"peru\": [205, 133, 63],\r\n\t\"pink\": [255, 192, 203],\r\n\t\"plum\": [221, 160, 221],\r\n\t\"powderblue\": [176, 224, 230],\r\n\t\"purple\": [128, 0, 128],\r\n\t\"rebeccapurple\": [102, 51, 153],\r\n\t\"red\": [255, 0, 0],\r\n\t\"rosybrown\": [188, 143, 143],\r\n\t\"royalblue\": [65, 105, 225],\r\n\t\"saddlebrown\": [139, 69, 19],\r\n\t\"salmon\": [250, 128, 114],\r\n\t\"sandybrown\": [244, 164, 96],\r\n\t\"seagreen\": [46, 139, 87],\r\n\t\"seashell\": [255, 245, 238],\r\n\t\"sienna\": [160, 82, 45],\r\n\t\"silver\": [192, 192, 192],\r\n\t\"skyblue\": [135, 206, 235],\r\n\t\"slateblue\": [106, 90, 205],\r\n\t\"slategray\": [112, 128, 144],\r\n\t\"slategrey\": [112, 128, 144],\r\n\t\"snow\": [255, 250, 250],\r\n\t\"springgreen\": [0, 255, 127],\r\n\t\"steelblue\": [70, 130, 180],\r\n\t\"tan\": [210, 180, 140],\r\n\t\"teal\": [0, 128, 128],\r\n\t\"thistle\": [216, 191, 216],\r\n\t\"tomato\": [255, 99, 71],\r\n\t\"turquoise\": [64, 224, 208],\r\n\t\"violet\": [238, 130, 238],\r\n\t\"wheat\": [245, 222, 179],\r\n\t\"white\": [255, 255, 255],\r\n\t\"whitesmoke\": [245, 245, 245],\r\n\t\"yellow\": [255, 255, 0],\r\n\t\"yellowgreen\": [154, 205, 50]\r\n};\r\n","module.exports = function isArrayish(obj) {\n\tif (!obj || typeof obj === 'string') {\n\t\treturn false;\n\t}\n\n\treturn obj instanceof Array || Array.isArray(obj) ||\n\t\t(obj.length >= 0 && (obj.splice instanceof Function ||\n\t\t\t(Object.getOwnPropertyDescriptor(obj, (obj.length - 1)) && obj.constructor.name !== 'String')));\n};\n","'use strict';\n\nvar isArrayish = require('is-arrayish');\n\nvar concat = Array.prototype.concat;\nvar slice = Array.prototype.slice;\n\nvar swizzle = module.exports = function swizzle(args) {\n\tvar results = [];\n\n\tfor (var i = 0, len = args.length; i < len; i++) {\n\t\tvar arg = args[i];\n\n\t\tif (isArrayish(arg)) {\n\t\t\t// http://jsperf.com/javascript-array-concat-vs-push/98\n\t\t\tresults = concat.call(results, slice.call(arg));\n\t\t} else {\n\t\t\tresults.push(arg);\n\t\t}\n\t}\n\n\treturn results;\n};\n\nswizzle.wrap = function (fn) {\n\treturn function () {\n\t\treturn fn(swizzle(arguments));\n\t};\n};\n","/* MIT license */\nvar colorNames = require('color-name');\nvar swizzle = require('simple-swizzle');\nvar hasOwnProperty = Object.hasOwnProperty;\n\nvar reverseNames = Object.create(null);\n\n// create a list of reverse color names\nfor (var name in colorNames) {\n\tif (hasOwnProperty.call(colorNames, name)) {\n\t\treverseNames[colorNames[name]] = name;\n\t}\n}\n\nvar cs = module.exports = {\n\tto: {},\n\tget: {}\n};\n\ncs.get = function (string) {\n\tvar prefix = string.substring(0, 3).toLowerCase();\n\tvar val;\n\tvar model;\n\tswitch (prefix) {\n\t\tcase 'hsl':\n\t\t\tval = cs.get.hsl(string);\n\t\t\tmodel = 'hsl';\n\t\t\tbreak;\n\t\tcase 'hwb':\n\t\t\tval = cs.get.hwb(string);\n\t\t\tmodel = 'hwb';\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tval = cs.get.rgb(string);\n\t\t\tmodel = 'rgb';\n\t\t\tbreak;\n\t}\n\n\tif (!val) {\n\t\treturn null;\n\t}\n\n\treturn {model: model, value: val};\n};\n\ncs.get.rgb = function (string) {\n\tif (!string) {\n\t\treturn null;\n\t}\n\n\tvar abbr = /^#([a-f0-9]{3,4})$/i;\n\tvar hex = /^#([a-f0-9]{6})([a-f0-9]{2})?$/i;\n\tvar rgba = /^rgba?\\(\\s*([+-]?\\d+)(?=[\\s,])\\s*(?:,\\s*)?([+-]?\\d+)(?=[\\s,])\\s*(?:,\\s*)?([+-]?\\d+)\\s*(?:[,|\\/]\\s*([+-]?[\\d\\.]+)(%?)\\s*)?\\)$/;\n\tvar per = /^rgba?\\(\\s*([+-]?[\\d\\.]+)\\%\\s*,?\\s*([+-]?[\\d\\.]+)\\%\\s*,?\\s*([+-]?[\\d\\.]+)\\%\\s*(?:[,|\\/]\\s*([+-]?[\\d\\.]+)(%?)\\s*)?\\)$/;\n\tvar keyword = /^(\\w+)$/;\n\n\tvar rgb = [0, 0, 0, 1];\n\tvar match;\n\tvar i;\n\tvar hexAlpha;\n\n\tif (match = string.match(hex)) {\n\t\thexAlpha = match[2];\n\t\tmatch = match[1];\n\n\t\tfor (i = 0; i < 3; i++) {\n\t\t\t// https://jsperf.com/slice-vs-substr-vs-substring-methods-long-string/19\n\t\t\tvar i2 = i * 2;\n\t\t\trgb[i] = parseInt(match.slice(i2, i2 + 2), 16);\n\t\t}\n\n\t\tif (hexAlpha) {\n\t\t\trgb[3] = parseInt(hexAlpha, 16) / 255;\n\t\t}\n\t} else if (match = string.match(abbr)) {\n\t\tmatch = match[1];\n\t\thexAlpha = match[3];\n\n\t\tfor (i = 0; i < 3; i++) {\n\t\t\trgb[i] = parseInt(match[i] + match[i], 16);\n\t\t}\n\n\t\tif (hexAlpha) {\n\t\t\trgb[3] = parseInt(hexAlpha + hexAlpha, 16) / 255;\n\t\t}\n\t} else if (match = string.match(rgba)) {\n\t\tfor (i = 0; i < 3; i++) {\n\t\t\trgb[i] = parseInt(match[i + 1], 0);\n\t\t}\n\n\t\tif (match[4]) {\n\t\t\tif (match[5]) {\n\t\t\t\trgb[3] = parseFloat(match[4]) * 0.01;\n\t\t\t} else {\n\t\t\t\trgb[3] = parseFloat(match[4]);\n\t\t\t}\n\t\t}\n\t} else if (match = string.match(per)) {\n\t\tfor (i = 0; i < 3; i++) {\n\t\t\trgb[i] = Math.round(parseFloat(match[i + 1]) * 2.55);\n\t\t}\n\n\t\tif (match[4]) {\n\t\t\tif (match[5]) {\n\t\t\t\trgb[3] = parseFloat(match[4]) * 0.01;\n\t\t\t} else {\n\t\t\t\trgb[3] = parseFloat(match[4]);\n\t\t\t}\n\t\t}\n\t} else if (match = string.match(keyword)) {\n\t\tif (match[1] === 'transparent') {\n\t\t\treturn [0, 0, 0, 0];\n\t\t}\n\n\t\tif (!hasOwnProperty.call(colorNames, match[1])) {\n\t\t\treturn null;\n\t\t}\n\n\t\trgb = colorNames[match[1]];\n\t\trgb[3] = 1;\n\n\t\treturn rgb;\n\t} else {\n\t\treturn null;\n\t}\n\n\tfor (i = 0; i < 3; i++) {\n\t\trgb[i] = clamp(rgb[i], 0, 255);\n\t}\n\trgb[3] = clamp(rgb[3], 0, 1);\n\n\treturn rgb;\n};\n\ncs.get.hsl = function (string) {\n\tif (!string) {\n\t\treturn null;\n\t}\n\n\tvar hsl = /^hsla?\\(\\s*([+-]?(?:\\d{0,3}\\.)?\\d+)(?:deg)?\\s*,?\\s*([+-]?[\\d\\.]+)%\\s*,?\\s*([+-]?[\\d\\.]+)%\\s*(?:[,|\\/]\\s*([+-]?(?=\\.\\d|\\d)(?:0|[1-9]\\d*)?(?:\\.\\d*)?(?:[eE][+-]?\\d+)?)\\s*)?\\)$/;\n\tvar match = string.match(hsl);\n\n\tif (match) {\n\t\tvar alpha = parseFloat(match[4]);\n\t\tvar h = ((parseFloat(match[1]) % 360) + 360) % 360;\n\t\tvar s = clamp(parseFloat(match[2]), 0, 100);\n\t\tvar l = clamp(parseFloat(match[3]), 0, 100);\n\t\tvar a = clamp(isNaN(alpha) ? 1 : alpha, 0, 1);\n\n\t\treturn [h, s, l, a];\n\t}\n\n\treturn null;\n};\n\ncs.get.hwb = function (string) {\n\tif (!string) {\n\t\treturn null;\n\t}\n\n\tvar hwb = /^hwb\\(\\s*([+-]?\\d{0,3}(?:\\.\\d+)?)(?:deg)?\\s*,\\s*([+-]?[\\d\\.]+)%\\s*,\\s*([+-]?[\\d\\.]+)%\\s*(?:,\\s*([+-]?(?=\\.\\d|\\d)(?:0|[1-9]\\d*)?(?:\\.\\d*)?(?:[eE][+-]?\\d+)?)\\s*)?\\)$/;\n\tvar match = string.match(hwb);\n\n\tif (match) {\n\t\tvar alpha = parseFloat(match[4]);\n\t\tvar h = ((parseFloat(match[1]) % 360) + 360) % 360;\n\t\tvar w = clamp(parseFloat(match[2]), 0, 100);\n\t\tvar b = clamp(parseFloat(match[3]), 0, 100);\n\t\tvar a = clamp(isNaN(alpha) ? 1 : alpha, 0, 1);\n\t\treturn [h, w, b, a];\n\t}\n\n\treturn null;\n};\n\ncs.to.hex = function () {\n\tvar rgba = swizzle(arguments);\n\n\treturn (\n\t\t'#' +\n\t\thexDouble(rgba[0]) +\n\t\thexDouble(rgba[1]) +\n\t\thexDouble(rgba[2]) +\n\t\t(rgba[3] < 1\n\t\t\t? (hexDouble(Math.round(rgba[3] * 255)))\n\t\t\t: '')\n\t);\n};\n\ncs.to.rgb = function () {\n\tvar rgba = swizzle(arguments);\n\n\treturn rgba.length < 4 || rgba[3] === 1\n\t\t? 'rgb(' + Math.round(rgba[0]) + ', ' + Math.round(rgba[1]) + ', ' + Math.round(rgba[2]) + ')'\n\t\t: 'rgba(' + Math.round(rgba[0]) + ', ' + Math.round(rgba[1]) + ', ' + Math.round(rgba[2]) + ', ' + rgba[3] + ')';\n};\n\ncs.to.rgb.percent = function () {\n\tvar rgba = swizzle(arguments);\n\n\tvar r = Math.round(rgba[0] / 255 * 100);\n\tvar g = Math.round(rgba[1] / 255 * 100);\n\tvar b = Math.round(rgba[2] / 255 * 100);\n\n\treturn rgba.length < 4 || rgba[3] === 1\n\t\t? 'rgb(' + r + '%, ' + g + '%, ' + b + '%)'\n\t\t: 'rgba(' + r + '%, ' + g + '%, ' + b + '%, ' + rgba[3] + ')';\n};\n\ncs.to.hsl = function () {\n\tvar hsla = swizzle(arguments);\n\treturn hsla.length < 4 || hsla[3] === 1\n\t\t? 'hsl(' + hsla[0] + ', ' + hsla[1] + '%, ' + hsla[2] + '%)'\n\t\t: 'hsla(' + hsla[0] + ', ' + hsla[1] + '%, ' + hsla[2] + '%, ' + hsla[3] + ')';\n};\n\n// hwb is a bit different than rgb(a) & hsl(a) since there is no alpha specific syntax\n// (hwb have alpha optional & 1 is default value)\ncs.to.hwb = function () {\n\tvar hwba = swizzle(arguments);\n\n\tvar a = '';\n\tif (hwba.length >= 4 && hwba[3] !== 1) {\n\t\ta = ', ' + hwba[3];\n\t}\n\n\treturn 'hwb(' + hwba[0] + ', ' + hwba[1] + '%, ' + hwba[2] + '%' + a + ')';\n};\n\ncs.to.keyword = function (rgb) {\n\treturn reverseNames[rgb.slice(0, 3)];\n};\n\n// helpers\nfunction clamp(num, min, max) {\n\treturn Math.min(Math.max(min, num), max);\n}\n\nfunction hexDouble(num) {\n\tvar str = Math.round(num).toString(16).toUpperCase();\n\treturn (str.length < 2) ? '0' + str : str;\n}\n","/* MIT license */\n/* eslint-disable no-mixed-operators */\nconst cssKeywords = require('color-name');\n\n// NOTE: conversions should only return primitive values (i.e. arrays, or\n//       values that give correct `typeof` results).\n//       do not use box values types (i.e. Number(), String(), etc.)\n\nconst reverseKeywords = {};\nfor (const key of Object.keys(cssKeywords)) {\n\treverseKeywords[cssKeywords[key]] = key;\n}\n\nconst convert = {\n\trgb: {channels: 3, labels: 'rgb'},\n\thsl: {channels: 3, labels: 'hsl'},\n\thsv: {channels: 3, labels: 'hsv'},\n\thwb: {channels: 3, labels: 'hwb'},\n\tcmyk: {channels: 4, labels: 'cmyk'},\n\txyz: {channels: 3, labels: 'xyz'},\n\tlab: {channels: 3, labels: 'lab'},\n\tlch: {channels: 3, labels: 'lch'},\n\thex: {channels: 1, labels: ['hex']},\n\tkeyword: {channels: 1, labels: ['keyword']},\n\tansi16: {channels: 1, labels: ['ansi16']},\n\tansi256: {channels: 1, labels: ['ansi256']},\n\thcg: {channels: 3, labels: ['h', 'c', 'g']},\n\tapple: {channels: 3, labels: ['r16', 'g16', 'b16']},\n\tgray: {channels: 1, labels: ['gray']}\n};\n\nmodule.exports = convert;\n\n// Hide .channels and .labels properties\nfor (const model of Object.keys(convert)) {\n\tif (!('channels' in convert[model])) {\n\t\tthrow new Error('missing channels property: ' + model);\n\t}\n\n\tif (!('labels' in convert[model])) {\n\t\tthrow new Error('missing channel labels property: ' + model);\n\t}\n\n\tif (convert[model].labels.length !== convert[model].channels) {\n\t\tthrow new Error('channel and label counts mismatch: ' + model);\n\t}\n\n\tconst {channels, labels} = convert[model];\n\tdelete convert[model].channels;\n\tdelete convert[model].labels;\n\tObject.defineProperty(convert[model], 'channels', {value: channels});\n\tObject.defineProperty(convert[model], 'labels', {value: labels});\n}\n\nconvert.rgb.hsl = function (rgb) {\n\tconst r = rgb[0] / 255;\n\tconst g = rgb[1] / 255;\n\tconst b = rgb[2] / 255;\n\tconst min = Math.min(r, g, b);\n\tconst max = Math.max(r, g, b);\n\tconst delta = max - min;\n\tlet h;\n\tlet s;\n\n\tif (max === min) {\n\t\th = 0;\n\t} else if (r === max) {\n\t\th = (g - b) / delta;\n\t} else if (g === max) {\n\t\th = 2 + (b - r) / delta;\n\t} else if (b === max) {\n\t\th = 4 + (r - g) / delta;\n\t}\n\n\th = Math.min(h * 60, 360);\n\n\tif (h < 0) {\n\t\th += 360;\n\t}\n\n\tconst l = (min + max) / 2;\n\n\tif (max === min) {\n\t\ts = 0;\n\t} else if (l <= 0.5) {\n\t\ts = delta / (max + min);\n\t} else {\n\t\ts = delta / (2 - max - min);\n\t}\n\n\treturn [h, s * 100, l * 100];\n};\n\nconvert.rgb.hsv = function (rgb) {\n\tlet rdif;\n\tlet gdif;\n\tlet bdif;\n\tlet h;\n\tlet s;\n\n\tconst r = rgb[0] / 255;\n\tconst g = rgb[1] / 255;\n\tconst b = rgb[2] / 255;\n\tconst v = Math.max(r, g, b);\n\tconst diff = v - Math.min(r, g, b);\n\tconst diffc = function (c) {\n\t\treturn (v - c) / 6 / diff + 1 / 2;\n\t};\n\n\tif (diff === 0) {\n\t\th = 0;\n\t\ts = 0;\n\t} else {\n\t\ts = diff / v;\n\t\trdif = diffc(r);\n\t\tgdif = diffc(g);\n\t\tbdif = diffc(b);\n\n\t\tif (r === v) {\n\t\t\th = bdif - gdif;\n\t\t} else if (g === v) {\n\t\t\th = (1 / 3) + rdif - bdif;\n\t\t} else if (b === v) {\n\t\t\th = (2 / 3) + gdif - rdif;\n\t\t}\n\n\t\tif (h < 0) {\n\t\t\th += 1;\n\t\t} else if (h > 1) {\n\t\t\th -= 1;\n\t\t}\n\t}\n\n\treturn [\n\t\th * 360,\n\t\ts * 100,\n\t\tv * 100\n\t];\n};\n\nconvert.rgb.hwb = function (rgb) {\n\tconst r = rgb[0];\n\tconst g = rgb[1];\n\tlet b = rgb[2];\n\tconst h = convert.rgb.hsl(rgb)[0];\n\tconst w = 1 / 255 * Math.min(r, Math.min(g, b));\n\n\tb = 1 - 1 / 255 * Math.max(r, Math.max(g, b));\n\n\treturn [h, w * 100, b * 100];\n};\n\nconvert.rgb.cmyk = function (rgb) {\n\tconst r = rgb[0] / 255;\n\tconst g = rgb[1] / 255;\n\tconst b = rgb[2] / 255;\n\n\tconst k = Math.min(1 - r, 1 - g, 1 - b);\n\tconst c = (1 - r - k) / (1 - k) || 0;\n\tconst m = (1 - g - k) / (1 - k) || 0;\n\tconst y = (1 - b - k) / (1 - k) || 0;\n\n\treturn [c * 100, m * 100, y * 100, k * 100];\n};\n\nfunction comparativeDistance(x, y) {\n\t/*\n\t\tSee https://en.m.wikipedia.org/wiki/Euclidean_distance#Squared_Euclidean_distance\n\t*/\n\treturn (\n\t\t((x[0] - y[0]) ** 2) +\n\t\t((x[1] - y[1]) ** 2) +\n\t\t((x[2] - y[2]) ** 2)\n\t);\n}\n\nconvert.rgb.keyword = function (rgb) {\n\tconst reversed = reverseKeywords[rgb];\n\tif (reversed) {\n\t\treturn reversed;\n\t}\n\n\tlet currentClosestDistance = Infinity;\n\tlet currentClosestKeyword;\n\n\tfor (const keyword of Object.keys(cssKeywords)) {\n\t\tconst value = cssKeywords[keyword];\n\n\t\t// Compute comparative distance\n\t\tconst distance = comparativeDistance(rgb, value);\n\n\t\t// Check if its less, if so set as closest\n\t\tif (distance < currentClosestDistance) {\n\t\t\tcurrentClosestDistance = distance;\n\t\t\tcurrentClosestKeyword = keyword;\n\t\t}\n\t}\n\n\treturn currentClosestKeyword;\n};\n\nconvert.keyword.rgb = function (keyword) {\n\treturn cssKeywords[keyword];\n};\n\nconvert.rgb.xyz = function (rgb) {\n\tlet r = rgb[0] / 255;\n\tlet g = rgb[1] / 255;\n\tlet b = rgb[2] / 255;\n\n\t// Assume sRGB\n\tr = r > 0.04045 ? (((r + 0.055) / 1.055) ** 2.4) : (r / 12.92);\n\tg = g > 0.04045 ? (((g + 0.055) / 1.055) ** 2.4) : (g / 12.92);\n\tb = b > 0.04045 ? (((b + 0.055) / 1.055) ** 2.4) : (b / 12.92);\n\n\tconst x = (r * 0.4124) + (g * 0.3576) + (b * 0.1805);\n\tconst y = (r * 0.2126) + (g * 0.7152) + (b * 0.0722);\n\tconst z = (r * 0.0193) + (g * 0.1192) + (b * 0.9505);\n\n\treturn [x * 100, y * 100, z * 100];\n};\n\nconvert.rgb.lab = function (rgb) {\n\tconst xyz = convert.rgb.xyz(rgb);\n\tlet x = xyz[0];\n\tlet y = xyz[1];\n\tlet z = xyz[2];\n\n\tx /= 95.047;\n\ty /= 100;\n\tz /= 108.883;\n\n\tx = x > 0.008856 ? (x ** (1 / 3)) : (7.787 * x) + (16 / 116);\n\ty = y > 0.008856 ? (y ** (1 / 3)) : (7.787 * y) + (16 / 116);\n\tz = z > 0.008856 ? (z ** (1 / 3)) : (7.787 * z) + (16 / 116);\n\n\tconst l = (116 * y) - 16;\n\tconst a = 500 * (x - y);\n\tconst b = 200 * (y - z);\n\n\treturn [l, a, b];\n};\n\nconvert.hsl.rgb = function (hsl) {\n\tconst h = hsl[0] / 360;\n\tconst s = hsl[1] / 100;\n\tconst l = hsl[2] / 100;\n\tlet t2;\n\tlet t3;\n\tlet val;\n\n\tif (s === 0) {\n\t\tval = l * 255;\n\t\treturn [val, val, val];\n\t}\n\n\tif (l < 0.5) {\n\t\tt2 = l * (1 + s);\n\t} else {\n\t\tt2 = l + s - l * s;\n\t}\n\n\tconst t1 = 2 * l - t2;\n\n\tconst rgb = [0, 0, 0];\n\tfor (let i = 0; i < 3; i++) {\n\t\tt3 = h + 1 / 3 * -(i - 1);\n\t\tif (t3 < 0) {\n\t\t\tt3++;\n\t\t}\n\n\t\tif (t3 > 1) {\n\t\t\tt3--;\n\t\t}\n\n\t\tif (6 * t3 < 1) {\n\t\t\tval = t1 + (t2 - t1) * 6 * t3;\n\t\t} else if (2 * t3 < 1) {\n\t\t\tval = t2;\n\t\t} else if (3 * t3 < 2) {\n\t\t\tval = t1 + (t2 - t1) * (2 / 3 - t3) * 6;\n\t\t} else {\n\t\t\tval = t1;\n\t\t}\n\n\t\trgb[i] = val * 255;\n\t}\n\n\treturn rgb;\n};\n\nconvert.hsl.hsv = function (hsl) {\n\tconst h = hsl[0];\n\tlet s = hsl[1] / 100;\n\tlet l = hsl[2] / 100;\n\tlet smin = s;\n\tconst lmin = Math.max(l, 0.01);\n\n\tl *= 2;\n\ts *= (l <= 1) ? l : 2 - l;\n\tsmin *= lmin <= 1 ? lmin : 2 - lmin;\n\tconst v = (l + s) / 2;\n\tconst sv = l === 0 ? (2 * smin) / (lmin + smin) : (2 * s) / (l + s);\n\n\treturn [h, sv * 100, v * 100];\n};\n\nconvert.hsv.rgb = function (hsv) {\n\tconst h = hsv[0] / 60;\n\tconst s = hsv[1] / 100;\n\tlet v = hsv[2] / 100;\n\tconst hi = Math.floor(h) % 6;\n\n\tconst f = h - Math.floor(h);\n\tconst p = 255 * v * (1 - s);\n\tconst q = 255 * v * (1 - (s * f));\n\tconst t = 255 * v * (1 - (s * (1 - f)));\n\tv *= 255;\n\n\tswitch (hi) {\n\t\tcase 0:\n\t\t\treturn [v, t, p];\n\t\tcase 1:\n\t\t\treturn [q, v, p];\n\t\tcase 2:\n\t\t\treturn [p, v, t];\n\t\tcase 3:\n\t\t\treturn [p, q, v];\n\t\tcase 4:\n\t\t\treturn [t, p, v];\n\t\tcase 5:\n\t\t\treturn [v, p, q];\n\t}\n};\n\nconvert.hsv.hsl = function (hsv) {\n\tconst h = hsv[0];\n\tconst s = hsv[1] / 100;\n\tconst v = hsv[2] / 100;\n\tconst vmin = Math.max(v, 0.01);\n\tlet sl;\n\tlet l;\n\n\tl = (2 - s) * v;\n\tconst lmin = (2 - s) * vmin;\n\tsl = s * vmin;\n\tsl /= (lmin <= 1) ? lmin : 2 - lmin;\n\tsl = sl || 0;\n\tl /= 2;\n\n\treturn [h, sl * 100, l * 100];\n};\n\n// http://dev.w3.org/csswg/css-color/#hwb-to-rgb\nconvert.hwb.rgb = function (hwb) {\n\tconst h = hwb[0] / 360;\n\tlet wh = hwb[1] / 100;\n\tlet bl = hwb[2] / 100;\n\tconst ratio = wh + bl;\n\tlet f;\n\n\t// Wh + bl cant be > 1\n\tif (ratio > 1) {\n\t\twh /= ratio;\n\t\tbl /= ratio;\n\t}\n\n\tconst i = Math.floor(6 * h);\n\tconst v = 1 - bl;\n\tf = 6 * h - i;\n\n\tif ((i & 0x01) !== 0) {\n\t\tf = 1 - f;\n\t}\n\n\tconst n = wh + f * (v - wh); // Linear interpolation\n\n\tlet r;\n\tlet g;\n\tlet b;\n\t/* eslint-disable max-statements-per-line,no-multi-spaces */\n\tswitch (i) {\n\t\tdefault:\n\t\tcase 6:\n\t\tcase 0: r = v;  g = n;  b = wh; break;\n\t\tcase 1: r = n;  g = v;  b = wh; break;\n\t\tcase 2: r = wh; g = v;  b = n; break;\n\t\tcase 3: r = wh; g = n;  b = v; break;\n\t\tcase 4: r = n;  g = wh; b = v; break;\n\t\tcase 5: r = v;  g = wh; b = n; break;\n\t}\n\t/* eslint-enable max-statements-per-line,no-multi-spaces */\n\n\treturn [r * 255, g * 255, b * 255];\n};\n\nconvert.cmyk.rgb = function (cmyk) {\n\tconst c = cmyk[0] / 100;\n\tconst m = cmyk[1] / 100;\n\tconst y = cmyk[2] / 100;\n\tconst k = cmyk[3] / 100;\n\n\tconst r = 1 - Math.min(1, c * (1 - k) + k);\n\tconst g = 1 - Math.min(1, m * (1 - k) + k);\n\tconst b = 1 - Math.min(1, y * (1 - k) + k);\n\n\treturn [r * 255, g * 255, b * 255];\n};\n\nconvert.xyz.rgb = function (xyz) {\n\tconst x = xyz[0] / 100;\n\tconst y = xyz[1] / 100;\n\tconst z = xyz[2] / 100;\n\tlet r;\n\tlet g;\n\tlet b;\n\n\tr = (x * 3.2406) + (y * -1.5372) + (z * -0.4986);\n\tg = (x * -0.9689) + (y * 1.8758) + (z * 0.0415);\n\tb = (x * 0.0557) + (y * -0.2040) + (z * 1.0570);\n\n\t// Assume sRGB\n\tr = r > 0.0031308\n\t\t? ((1.055 * (r ** (1.0 / 2.4))) - 0.055)\n\t\t: r * 12.92;\n\n\tg = g > 0.0031308\n\t\t? ((1.055 * (g ** (1.0 / 2.4))) - 0.055)\n\t\t: g * 12.92;\n\n\tb = b > 0.0031308\n\t\t? ((1.055 * (b ** (1.0 / 2.4))) - 0.055)\n\t\t: b * 12.92;\n\n\tr = Math.min(Math.max(0, r), 1);\n\tg = Math.min(Math.max(0, g), 1);\n\tb = Math.min(Math.max(0, b), 1);\n\n\treturn [r * 255, g * 255, b * 255];\n};\n\nconvert.xyz.lab = function (xyz) {\n\tlet x = xyz[0];\n\tlet y = xyz[1];\n\tlet z = xyz[2];\n\n\tx /= 95.047;\n\ty /= 100;\n\tz /= 108.883;\n\n\tx = x > 0.008856 ? (x ** (1 / 3)) : (7.787 * x) + (16 / 116);\n\ty = y > 0.008856 ? (y ** (1 / 3)) : (7.787 * y) + (16 / 116);\n\tz = z > 0.008856 ? (z ** (1 / 3)) : (7.787 * z) + (16 / 116);\n\n\tconst l = (116 * y) - 16;\n\tconst a = 500 * (x - y);\n\tconst b = 200 * (y - z);\n\n\treturn [l, a, b];\n};\n\nconvert.lab.xyz = function (lab) {\n\tconst l = lab[0];\n\tconst a = lab[1];\n\tconst b = lab[2];\n\tlet x;\n\tlet y;\n\tlet z;\n\n\ty = (l + 16) / 116;\n\tx = a / 500 + y;\n\tz = y - b / 200;\n\n\tconst y2 = y ** 3;\n\tconst x2 = x ** 3;\n\tconst z2 = z ** 3;\n\ty = y2 > 0.008856 ? y2 : (y - 16 / 116) / 7.787;\n\tx = x2 > 0.008856 ? x2 : (x - 16 / 116) / 7.787;\n\tz = z2 > 0.008856 ? z2 : (z - 16 / 116) / 7.787;\n\n\tx *= 95.047;\n\ty *= 100;\n\tz *= 108.883;\n\n\treturn [x, y, z];\n};\n\nconvert.lab.lch = function (lab) {\n\tconst l = lab[0];\n\tconst a = lab[1];\n\tconst b = lab[2];\n\tlet h;\n\n\tconst hr = Math.atan2(b, a);\n\th = hr * 360 / 2 / Math.PI;\n\n\tif (h < 0) {\n\t\th += 360;\n\t}\n\n\tconst c = Math.sqrt(a * a + b * b);\n\n\treturn [l, c, h];\n};\n\nconvert.lch.lab = function (lch) {\n\tconst l = lch[0];\n\tconst c = lch[1];\n\tconst h = lch[2];\n\n\tconst hr = h / 360 * 2 * Math.PI;\n\tconst a = c * Math.cos(hr);\n\tconst b = c * Math.sin(hr);\n\n\treturn [l, a, b];\n};\n\nconvert.rgb.ansi16 = function (args, saturation = null) {\n\tconst [r, g, b] = args;\n\tlet value = saturation === null ? convert.rgb.hsv(args)[2] : saturation; // Hsv -> ansi16 optimization\n\n\tvalue = Math.round(value / 50);\n\n\tif (value === 0) {\n\t\treturn 30;\n\t}\n\n\tlet ansi = 30\n\t\t+ ((Math.round(b / 255) << 2)\n\t\t| (Math.round(g / 255) << 1)\n\t\t| Math.round(r / 255));\n\n\tif (value === 2) {\n\t\tansi += 60;\n\t}\n\n\treturn ansi;\n};\n\nconvert.hsv.ansi16 = function (args) {\n\t// Optimization here; we already know the value and don't need to get\n\t// it converted for us.\n\treturn convert.rgb.ansi16(convert.hsv.rgb(args), args[2]);\n};\n\nconvert.rgb.ansi256 = function (args) {\n\tconst r = args[0];\n\tconst g = args[1];\n\tconst b = args[2];\n\n\t// We use the extended greyscale palette here, with the exception of\n\t// black and white. normal palette only has 4 greyscale shades.\n\tif (r === g && g === b) {\n\t\tif (r < 8) {\n\t\t\treturn 16;\n\t\t}\n\n\t\tif (r > 248) {\n\t\t\treturn 231;\n\t\t}\n\n\t\treturn Math.round(((r - 8) / 247) * 24) + 232;\n\t}\n\n\tconst ansi = 16\n\t\t+ (36 * Math.round(r / 255 * 5))\n\t\t+ (6 * Math.round(g / 255 * 5))\n\t\t+ Math.round(b / 255 * 5);\n\n\treturn ansi;\n};\n\nconvert.ansi16.rgb = function (args) {\n\tlet color = args % 10;\n\n\t// Handle greyscale\n\tif (color === 0 || color === 7) {\n\t\tif (args > 50) {\n\t\t\tcolor += 3.5;\n\t\t}\n\n\t\tcolor = color / 10.5 * 255;\n\n\t\treturn [color, color, color];\n\t}\n\n\tconst mult = (~~(args > 50) + 1) * 0.5;\n\tconst r = ((color & 1) * mult) * 255;\n\tconst g = (((color >> 1) & 1) * mult) * 255;\n\tconst b = (((color >> 2) & 1) * mult) * 255;\n\n\treturn [r, g, b];\n};\n\nconvert.ansi256.rgb = function (args) {\n\t// Handle greyscale\n\tif (args >= 232) {\n\t\tconst c = (args - 232) * 10 + 8;\n\t\treturn [c, c, c];\n\t}\n\n\targs -= 16;\n\n\tlet rem;\n\tconst r = Math.floor(args / 36) / 5 * 255;\n\tconst g = Math.floor((rem = args % 36) / 6) / 5 * 255;\n\tconst b = (rem % 6) / 5 * 255;\n\n\treturn [r, g, b];\n};\n\nconvert.rgb.hex = function (args) {\n\tconst integer = ((Math.round(args[0]) & 0xFF) << 16)\n\t\t+ ((Math.round(args[1]) & 0xFF) << 8)\n\t\t+ (Math.round(args[2]) & 0xFF);\n\n\tconst string = integer.toString(16).toUpperCase();\n\treturn '000000'.substring(string.length) + string;\n};\n\nconvert.hex.rgb = function (args) {\n\tconst match = args.toString(16).match(/[a-f0-9]{6}|[a-f0-9]{3}/i);\n\tif (!match) {\n\t\treturn [0, 0, 0];\n\t}\n\n\tlet colorString = match[0];\n\n\tif (match[0].length === 3) {\n\t\tcolorString = colorString.split('').map(char => {\n\t\t\treturn char + char;\n\t\t}).join('');\n\t}\n\n\tconst integer = parseInt(colorString, 16);\n\tconst r = (integer >> 16) & 0xFF;\n\tconst g = (integer >> 8) & 0xFF;\n\tconst b = integer & 0xFF;\n\n\treturn [r, g, b];\n};\n\nconvert.rgb.hcg = function (rgb) {\n\tconst r = rgb[0] / 255;\n\tconst g = rgb[1] / 255;\n\tconst b = rgb[2] / 255;\n\tconst max = Math.max(Math.max(r, g), b);\n\tconst min = Math.min(Math.min(r, g), b);\n\tconst chroma = (max - min);\n\tlet grayscale;\n\tlet hue;\n\n\tif (chroma < 1) {\n\t\tgrayscale = min / (1 - chroma);\n\t} else {\n\t\tgrayscale = 0;\n\t}\n\n\tif (chroma <= 0) {\n\t\thue = 0;\n\t} else\n\tif (max === r) {\n\t\thue = ((g - b) / chroma) % 6;\n\t} else\n\tif (max === g) {\n\t\thue = 2 + (b - r) / chroma;\n\t} else {\n\t\thue = 4 + (r - g) / chroma;\n\t}\n\n\thue /= 6;\n\thue %= 1;\n\n\treturn [hue * 360, chroma * 100, grayscale * 100];\n};\n\nconvert.hsl.hcg = function (hsl) {\n\tconst s = hsl[1] / 100;\n\tconst l = hsl[2] / 100;\n\n\tconst c = l < 0.5 ? (2.0 * s * l) : (2.0 * s * (1.0 - l));\n\n\tlet f = 0;\n\tif (c < 1.0) {\n\t\tf = (l - 0.5 * c) / (1.0 - c);\n\t}\n\n\treturn [hsl[0], c * 100, f * 100];\n};\n\nconvert.hsv.hcg = function (hsv) {\n\tconst s = hsv[1] / 100;\n\tconst v = hsv[2] / 100;\n\n\tconst c = s * v;\n\tlet f = 0;\n\n\tif (c < 1.0) {\n\t\tf = (v - c) / (1 - c);\n\t}\n\n\treturn [hsv[0], c * 100, f * 100];\n};\n\nconvert.hcg.rgb = function (hcg) {\n\tconst h = hcg[0] / 360;\n\tconst c = hcg[1] / 100;\n\tconst g = hcg[2] / 100;\n\n\tif (c === 0.0) {\n\t\treturn [g * 255, g * 255, g * 255];\n\t}\n\n\tconst pure = [0, 0, 0];\n\tconst hi = (h % 1) * 6;\n\tconst v = hi % 1;\n\tconst w = 1 - v;\n\tlet mg = 0;\n\n\t/* eslint-disable max-statements-per-line */\n\tswitch (Math.floor(hi)) {\n\t\tcase 0:\n\t\t\tpure[0] = 1; pure[1] = v; pure[2] = 0; break;\n\t\tcase 1:\n\t\t\tpure[0] = w; pure[1] = 1; pure[2] = 0; break;\n\t\tcase 2:\n\t\t\tpure[0] = 0; pure[1] = 1; pure[2] = v; break;\n\t\tcase 3:\n\t\t\tpure[0] = 0; pure[1] = w; pure[2] = 1; break;\n\t\tcase 4:\n\t\t\tpure[0] = v; pure[1] = 0; pure[2] = 1; break;\n\t\tdefault:\n\t\t\tpure[0] = 1; pure[1] = 0; pure[2] = w;\n\t}\n\t/* eslint-enable max-statements-per-line */\n\n\tmg = (1.0 - c) * g;\n\n\treturn [\n\t\t(c * pure[0] + mg) * 255,\n\t\t(c * pure[1] + mg) * 255,\n\t\t(c * pure[2] + mg) * 255\n\t];\n};\n\nconvert.hcg.hsv = function (hcg) {\n\tconst c = hcg[1] / 100;\n\tconst g = hcg[2] / 100;\n\n\tconst v = c + g * (1.0 - c);\n\tlet f = 0;\n\n\tif (v > 0.0) {\n\t\tf = c / v;\n\t}\n\n\treturn [hcg[0], f * 100, v * 100];\n};\n\nconvert.hcg.hsl = function (hcg) {\n\tconst c = hcg[1] / 100;\n\tconst g = hcg[2] / 100;\n\n\tconst l = g * (1.0 - c) + 0.5 * c;\n\tlet s = 0;\n\n\tif (l > 0.0 && l < 0.5) {\n\t\ts = c / (2 * l);\n\t} else\n\tif (l >= 0.5 && l < 1.0) {\n\t\ts = c / (2 * (1 - l));\n\t}\n\n\treturn [hcg[0], s * 100, l * 100];\n};\n\nconvert.hcg.hwb = function (hcg) {\n\tconst c = hcg[1] / 100;\n\tconst g = hcg[2] / 100;\n\tconst v = c + g * (1.0 - c);\n\treturn [hcg[0], (v - c) * 100, (1 - v) * 100];\n};\n\nconvert.hwb.hcg = function (hwb) {\n\tconst w = hwb[1] / 100;\n\tconst b = hwb[2] / 100;\n\tconst v = 1 - b;\n\tconst c = v - w;\n\tlet g = 0;\n\n\tif (c < 1) {\n\t\tg = (v - c) / (1 - c);\n\t}\n\n\treturn [hwb[0], c * 100, g * 100];\n};\n\nconvert.apple.rgb = function (apple) {\n\treturn [(apple[0] / 65535) * 255, (apple[1] / 65535) * 255, (apple[2] / 65535) * 255];\n};\n\nconvert.rgb.apple = function (rgb) {\n\treturn [(rgb[0] / 255) * 65535, (rgb[1] / 255) * 65535, (rgb[2] / 255) * 65535];\n};\n\nconvert.gray.rgb = function (args) {\n\treturn [args[0] / 100 * 255, args[0] / 100 * 255, args[0] / 100 * 255];\n};\n\nconvert.gray.hsl = function (args) {\n\treturn [0, 0, args[0]];\n};\n\nconvert.gray.hsv = convert.gray.hsl;\n\nconvert.gray.hwb = function (gray) {\n\treturn [0, 100, gray[0]];\n};\n\nconvert.gray.cmyk = function (gray) {\n\treturn [0, 0, 0, gray[0]];\n};\n\nconvert.gray.lab = function (gray) {\n\treturn [gray[0], 0, 0];\n};\n\nconvert.gray.hex = function (gray) {\n\tconst val = Math.round(gray[0] / 100 * 255) & 0xFF;\n\tconst integer = (val << 16) + (val << 8) + val;\n\n\tconst string = integer.toString(16).toUpperCase();\n\treturn '000000'.substring(string.length) + string;\n};\n\nconvert.rgb.gray = function (rgb) {\n\tconst val = (rgb[0] + rgb[1] + rgb[2]) / 3;\n\treturn [val / 255 * 100];\n};\n","const conversions = require('./conversions');\n\n/*\n\tThis function routes a model to all other models.\n\n\tall functions that are routed have a property `.conversion` attached\n\tto the returned synthetic function. This property is an array\n\tof strings, each with the steps in between the 'from' and 'to'\n\tcolor models (inclusive).\n\n\tconversions that are not possible simply are not included.\n*/\n\nfunction buildGraph() {\n\tconst graph = {};\n\t// https://jsperf.com/object-keys-vs-for-in-with-closure/3\n\tconst models = Object.keys(conversions);\n\n\tfor (let len = models.length, i = 0; i < len; i++) {\n\t\tgraph[models[i]] = {\n\t\t\t// http://jsperf.com/1-vs-infinity\n\t\t\t// micro-opt, but this is simple.\n\t\t\tdistance: -1,\n\t\t\tparent: null\n\t\t};\n\t}\n\n\treturn graph;\n}\n\n// https://en.wikipedia.org/wiki/Breadth-first_search\nfunction deriveBFS(fromModel) {\n\tconst graph = buildGraph();\n\tconst queue = [fromModel]; // Unshift -> queue -> pop\n\n\tgraph[fromModel].distance = 0;\n\n\twhile (queue.length) {\n\t\tconst current = queue.pop();\n\t\tconst adjacents = Object.keys(conversions[current]);\n\n\t\tfor (let len = adjacents.length, i = 0; i < len; i++) {\n\t\t\tconst adjacent = adjacents[i];\n\t\t\tconst node = graph[adjacent];\n\n\t\t\tif (node.distance === -1) {\n\t\t\t\tnode.distance = graph[current].distance + 1;\n\t\t\t\tnode.parent = current;\n\t\t\t\tqueue.unshift(adjacent);\n\t\t\t}\n\t\t}\n\t}\n\n\treturn graph;\n}\n\nfunction link(from, to) {\n\treturn function (args) {\n\t\treturn to(from(args));\n\t};\n}\n\nfunction wrapConversion(toModel, graph) {\n\tconst path = [graph[toModel].parent, toModel];\n\tlet fn = conversions[graph[toModel].parent][toModel];\n\n\tlet cur = graph[toModel].parent;\n\twhile (graph[cur].parent) {\n\t\tpath.unshift(graph[cur].parent);\n\t\tfn = link(conversions[graph[cur].parent][cur], fn);\n\t\tcur = graph[cur].parent;\n\t}\n\n\tfn.conversion = path;\n\treturn fn;\n}\n\nmodule.exports = function (fromModel) {\n\tconst graph = deriveBFS(fromModel);\n\tconst conversion = {};\n\n\tconst models = Object.keys(graph);\n\tfor (let len = models.length, i = 0; i < len; i++) {\n\t\tconst toModel = models[i];\n\t\tconst node = graph[toModel];\n\n\t\tif (node.parent === null) {\n\t\t\t// No possible conversion, or this node is the source model.\n\t\t\tcontinue;\n\t\t}\n\n\t\tconversion[toModel] = wrapConversion(toModel, graph);\n\t}\n\n\treturn conversion;\n};\n\n","const conversions = require('./conversions');\nconst route = require('./route');\n\nconst convert = {};\n\nconst models = Object.keys(conversions);\n\nfunction wrapRaw(fn) {\n\tconst wrappedFn = function (...args) {\n\t\tconst arg0 = args[0];\n\t\tif (arg0 === undefined || arg0 === null) {\n\t\t\treturn arg0;\n\t\t}\n\n\t\tif (arg0.length > 1) {\n\t\t\targs = arg0;\n\t\t}\n\n\t\treturn fn(args);\n\t};\n\n\t// Preserve .conversion property if there is one\n\tif ('conversion' in fn) {\n\t\twrappedFn.conversion = fn.conversion;\n\t}\n\n\treturn wrappedFn;\n}\n\nfunction wrapRounded(fn) {\n\tconst wrappedFn = function (...args) {\n\t\tconst arg0 = args[0];\n\n\t\tif (arg0 === undefined || arg0 === null) {\n\t\t\treturn arg0;\n\t\t}\n\n\t\tif (arg0.length > 1) {\n\t\t\targs = arg0;\n\t\t}\n\n\t\tconst result = fn(args);\n\n\t\t// We're assuming the result is an array here.\n\t\t// see notice in conversions.js; don't use box types\n\t\t// in conversion functions.\n\t\tif (typeof result === 'object') {\n\t\t\tfor (let len = result.length, i = 0; i < len; i++) {\n\t\t\t\tresult[i] = Math.round(result[i]);\n\t\t\t}\n\t\t}\n\n\t\treturn result;\n\t};\n\n\t// Preserve .conversion property if there is one\n\tif ('conversion' in fn) {\n\t\twrappedFn.conversion = fn.conversion;\n\t}\n\n\treturn wrappedFn;\n}\n\nmodels.forEach(fromModel => {\n\tconvert[fromModel] = {};\n\n\tObject.defineProperty(convert[fromModel], 'channels', {value: conversions[fromModel].channels});\n\tObject.defineProperty(convert[fromModel], 'labels', {value: conversions[fromModel].labels});\n\n\tconst routes = route(fromModel);\n\tconst routeModels = Object.keys(routes);\n\n\trouteModels.forEach(toModel => {\n\t\tconst fn = routes[toModel];\n\n\t\tconvert[fromModel][toModel] = wrapRounded(fn);\n\t\tconvert[fromModel][toModel].raw = wrapRaw(fn);\n\t});\n});\n\nmodule.exports = convert;\n","const colorString = require('color-string');\nconst convert = require('color-convert');\n\nconst skippedModels = [\n\t// To be honest, I don't really feel like keyword belongs in color convert, but eh.\n\t'keyword',\n\n\t// Gray conflicts with some method names, and has its own method defined.\n\t'gray',\n\n\t// Shouldn't really be in color-convert either...\n\t'hex',\n];\n\nconst hashedModelKeys = {};\nfor (const model of Object.keys(convert)) {\n\thashedModelKeys[[...convert[model].labels].sort().join('')] = model;\n}\n\nconst limiters = {};\n\nfunction Color(object, model) {\n\tif (!(this instanceof Color)) {\n\t\treturn new Color(object, model);\n\t}\n\n\tif (model && model in skippedModels) {\n\t\tmodel = null;\n\t}\n\n\tif (model && !(model in convert)) {\n\t\tthrow new Error('Unknown model: ' + model);\n\t}\n\n\tlet i;\n\tlet channels;\n\n\tif (object == null) { // eslint-disable-line no-eq-null,eqeqeq\n\t\tthis.model = 'rgb';\n\t\tthis.color = [0, 0, 0];\n\t\tthis.valpha = 1;\n\t} else if (object instanceof Color) {\n\t\tthis.model = object.model;\n\t\tthis.color = [...object.color];\n\t\tthis.valpha = object.valpha;\n\t} else if (typeof object === 'string') {\n\t\tconst result = colorString.get(object);\n\t\tif (result === null) {\n\t\t\tthrow new Error('Unable to parse color from string: ' + object);\n\t\t}\n\n\t\tthis.model = result.model;\n\t\tchannels = convert[this.model].channels;\n\t\tthis.color = result.value.slice(0, channels);\n\t\tthis.valpha = typeof result.value[channels] === 'number' ? result.value[channels] : 1;\n\t} else if (object.length > 0) {\n\t\tthis.model = model || 'rgb';\n\t\tchannels = convert[this.model].channels;\n\t\tconst newArray = Array.prototype.slice.call(object, 0, channels);\n\t\tthis.color = zeroArray(newArray, channels);\n\t\tthis.valpha = typeof object[channels] === 'number' ? object[channels] : 1;\n\t} else if (typeof object === 'number') {\n\t\t// This is always RGB - can be converted later on.\n\t\tthis.model = 'rgb';\n\t\tthis.color = [\n\t\t\t(object >> 16) & 0xFF,\n\t\t\t(object >> 8) & 0xFF,\n\t\t\tobject & 0xFF,\n\t\t];\n\t\tthis.valpha = 1;\n\t} else {\n\t\tthis.valpha = 1;\n\n\t\tconst keys = Object.keys(object);\n\t\tif ('alpha' in object) {\n\t\t\tkeys.splice(keys.indexOf('alpha'), 1);\n\t\t\tthis.valpha = typeof object.alpha === 'number' ? object.alpha : 0;\n\t\t}\n\n\t\tconst hashedKeys = keys.sort().join('');\n\t\tif (!(hashedKeys in hashedModelKeys)) {\n\t\t\tthrow new Error('Unable to parse color from object: ' + JSON.stringify(object));\n\t\t}\n\n\t\tthis.model = hashedModelKeys[hashedKeys];\n\n\t\tconst {labels} = convert[this.model];\n\t\tconst color = [];\n\t\tfor (i = 0; i < labels.length; i++) {\n\t\t\tcolor.push(object[labels[i]]);\n\t\t}\n\n\t\tthis.color = zeroArray(color);\n\t}\n\n\t// Perform limitations (clamping, etc.)\n\tif (limiters[this.model]) {\n\t\tchannels = convert[this.model].channels;\n\t\tfor (i = 0; i < channels; i++) {\n\t\t\tconst limit = limiters[this.model][i];\n\t\t\tif (limit) {\n\t\t\t\tthis.color[i] = limit(this.color[i]);\n\t\t\t}\n\t\t}\n\t}\n\n\tthis.valpha = Math.max(0, Math.min(1, this.valpha));\n\n\tif (Object.freeze) {\n\t\tObject.freeze(this);\n\t}\n}\n\nColor.prototype = {\n\ttoString() {\n\t\treturn this.string();\n\t},\n\n\ttoJSON() {\n\t\treturn this[this.model]();\n\t},\n\n\tstring(places) {\n\t\tlet self = this.model in colorString.to ? this : this.rgb();\n\t\tself = self.round(typeof places === 'number' ? places : 1);\n\t\tconst args = self.valpha === 1 ? self.color : [...self.color, this.valpha];\n\t\treturn colorString.to[self.model](args);\n\t},\n\n\tpercentString(places) {\n\t\tconst self = this.rgb().round(typeof places === 'number' ? places : 1);\n\t\tconst args = self.valpha === 1 ? self.color : [...self.color, this.valpha];\n\t\treturn colorString.to.rgb.percent(args);\n\t},\n\n\tarray() {\n\t\treturn this.valpha === 1 ? [...this.color] : [...this.color, this.valpha];\n\t},\n\n\tobject() {\n\t\tconst result = {};\n\t\tconst {channels} = convert[this.model];\n\t\tconst {labels} = convert[this.model];\n\n\t\tfor (let i = 0; i < channels; i++) {\n\t\t\tresult[labels[i]] = this.color[i];\n\t\t}\n\n\t\tif (this.valpha !== 1) {\n\t\t\tresult.alpha = this.valpha;\n\t\t}\n\n\t\treturn result;\n\t},\n\n\tunitArray() {\n\t\tconst rgb = this.rgb().color;\n\t\trgb[0] /= 255;\n\t\trgb[1] /= 255;\n\t\trgb[2] /= 255;\n\n\t\tif (this.valpha !== 1) {\n\t\t\trgb.push(this.valpha);\n\t\t}\n\n\t\treturn rgb;\n\t},\n\n\tunitObject() {\n\t\tconst rgb = this.rgb().object();\n\t\trgb.r /= 255;\n\t\trgb.g /= 255;\n\t\trgb.b /= 255;\n\n\t\tif (this.valpha !== 1) {\n\t\t\trgb.alpha = this.valpha;\n\t\t}\n\n\t\treturn rgb;\n\t},\n\n\tround(places) {\n\t\tplaces = Math.max(places || 0, 0);\n\t\treturn new Color([...this.color.map(roundToPlace(places)), this.valpha], this.model);\n\t},\n\n\talpha(value) {\n\t\tif (value !== undefined) {\n\t\t\treturn new Color([...this.color, Math.max(0, Math.min(1, value))], this.model);\n\t\t}\n\n\t\treturn this.valpha;\n\t},\n\n\t// Rgb\n\tred: getset('rgb', 0, maxfn(255)),\n\tgreen: getset('rgb', 1, maxfn(255)),\n\tblue: getset('rgb', 2, maxfn(255)),\n\n\thue: getset(['hsl', 'hsv', 'hsl', 'hwb', 'hcg'], 0, value => ((value % 360) + 360) % 360),\n\n\tsaturationl: getset('hsl', 1, maxfn(100)),\n\tlightness: getset('hsl', 2, maxfn(100)),\n\n\tsaturationv: getset('hsv', 1, maxfn(100)),\n\tvalue: getset('hsv', 2, maxfn(100)),\n\n\tchroma: getset('hcg', 1, maxfn(100)),\n\tgray: getset('hcg', 2, maxfn(100)),\n\n\twhite: getset('hwb', 1, maxfn(100)),\n\twblack: getset('hwb', 2, maxfn(100)),\n\n\tcyan: getset('cmyk', 0, maxfn(100)),\n\tmagenta: getset('cmyk', 1, maxfn(100)),\n\tyellow: getset('cmyk', 2, maxfn(100)),\n\tblack: getset('cmyk', 3, maxfn(100)),\n\n\tx: getset('xyz', 0, maxfn(95.047)),\n\ty: getset('xyz', 1, maxfn(100)),\n\tz: getset('xyz', 2, maxfn(108.833)),\n\n\tl: getset('lab', 0, maxfn(100)),\n\ta: getset('lab', 1),\n\tb: getset('lab', 2),\n\n\tkeyword(value) {\n\t\tif (value !== undefined) {\n\t\t\treturn new Color(value);\n\t\t}\n\n\t\treturn convert[this.model].keyword(this.color);\n\t},\n\n\thex(value) {\n\t\tif (value !== undefined) {\n\t\t\treturn new Color(value);\n\t\t}\n\n\t\treturn colorString.to.hex(this.rgb().round().color);\n\t},\n\n\thexa(value) {\n\t\tif (value !== undefined) {\n\t\t\treturn new Color(value);\n\t\t}\n\n\t\tconst rgbArray = this.rgb().round().color;\n\n\t\tlet alphaHex = Math.round(this.valpha * 255).toString(16).toUpperCase();\n\t\tif (alphaHex.length === 1) {\n\t\t\talphaHex = '0' + alphaHex;\n\t\t}\n\n\t\treturn colorString.to.hex(rgbArray) + alphaHex;\n\t},\n\n\trgbNumber() {\n\t\tconst rgb = this.rgb().color;\n\t\treturn ((rgb[0] & 0xFF) << 16) | ((rgb[1] & 0xFF) << 8) | (rgb[2] & 0xFF);\n\t},\n\n\tluminosity() {\n\t\t// http://www.w3.org/TR/WCAG20/#relativeluminancedef\n\t\tconst rgb = this.rgb().color;\n\n\t\tconst lum = [];\n\t\tfor (const [i, element] of rgb.entries()) {\n\t\t\tconst chan = element / 255;\n\t\t\tlum[i] = (chan <= 0.04045) ? chan / 12.92 : ((chan + 0.055) / 1.055) ** 2.4;\n\t\t}\n\n\t\treturn 0.2126 * lum[0] + 0.7152 * lum[1] + 0.0722 * lum[2];\n\t},\n\n\tcontrast(color2) {\n\t\t// http://www.w3.org/TR/WCAG20/#contrast-ratiodef\n\t\tconst lum1 = this.luminosity();\n\t\tconst lum2 = color2.luminosity();\n\n\t\tif (lum1 > lum2) {\n\t\t\treturn (lum1 + 0.05) / (lum2 + 0.05);\n\t\t}\n\n\t\treturn (lum2 + 0.05) / (lum1 + 0.05);\n\t},\n\n\tlevel(color2) {\n\t\t// https://www.w3.org/TR/WCAG/#contrast-enhanced\n\t\tconst contrastRatio = this.contrast(color2);\n\t\tif (contrastRatio >= 7) {\n\t\t\treturn 'AAA';\n\t\t}\n\n\t\treturn (contrastRatio >= 4.5) ? 'AA' : '';\n\t},\n\n\tisDark() {\n\t\t// YIQ equation from http://24ways.org/2010/calculating-color-contrast\n\t\tconst rgb = this.rgb().color;\n\t\tconst yiq = (rgb[0] * 2126 + rgb[1] * 7152 + rgb[2] * 722) / 10000;\n\t\treturn yiq < 128;\n\t},\n\n\tisLight() {\n\t\treturn !this.isDark();\n\t},\n\n\tnegate() {\n\t\tconst rgb = this.rgb();\n\t\tfor (let i = 0; i < 3; i++) {\n\t\t\trgb.color[i] = 255 - rgb.color[i];\n\t\t}\n\n\t\treturn rgb;\n\t},\n\n\tlighten(ratio) {\n\t\tconst hsl = this.hsl();\n\t\thsl.color[2] += hsl.color[2] * ratio;\n\t\treturn hsl;\n\t},\n\n\tdarken(ratio) {\n\t\tconst hsl = this.hsl();\n\t\thsl.color[2] -= hsl.color[2] * ratio;\n\t\treturn hsl;\n\t},\n\n\tsaturate(ratio) {\n\t\tconst hsl = this.hsl();\n\t\thsl.color[1] += hsl.color[1] * ratio;\n\t\treturn hsl;\n\t},\n\n\tdesaturate(ratio) {\n\t\tconst hsl = this.hsl();\n\t\thsl.color[1] -= hsl.color[1] * ratio;\n\t\treturn hsl;\n\t},\n\n\twhiten(ratio) {\n\t\tconst hwb = this.hwb();\n\t\thwb.color[1] += hwb.color[1] * ratio;\n\t\treturn hwb;\n\t},\n\n\tblacken(ratio) {\n\t\tconst hwb = this.hwb();\n\t\thwb.color[2] += hwb.color[2] * ratio;\n\t\treturn hwb;\n\t},\n\n\tgrayscale() {\n\t\t// http://en.wikipedia.org/wiki/Grayscale#Converting_color_to_grayscale\n\t\tconst rgb = this.rgb().color;\n\t\tconst value = rgb[0] * 0.3 + rgb[1] * 0.59 + rgb[2] * 0.11;\n\t\treturn Color.rgb(value, value, value);\n\t},\n\n\tfade(ratio) {\n\t\treturn this.alpha(this.valpha - (this.valpha * ratio));\n\t},\n\n\topaquer(ratio) {\n\t\treturn this.alpha(this.valpha + (this.valpha * ratio));\n\t},\n\n\trotate(degrees) {\n\t\tconst hsl = this.hsl();\n\t\tlet hue = hsl.color[0];\n\t\thue = (hue + degrees) % 360;\n\t\thue = hue < 0 ? 360 + hue : hue;\n\t\thsl.color[0] = hue;\n\t\treturn hsl;\n\t},\n\n\tmix(mixinColor, weight) {\n\t\t// Ported from sass implementation in C\n\t\t// https://github.com/sass/libsass/blob/0e6b4a2850092356aa3ece07c6b249f0221caced/functions.cpp#L209\n\t\tif (!mixinColor || !mixinColor.rgb) {\n\t\t\tthrow new Error('Argument to \"mix\" was not a Color instance, but rather an instance of ' + typeof mixinColor);\n\t\t}\n\n\t\tconst color1 = mixinColor.rgb();\n\t\tconst color2 = this.rgb();\n\t\tconst p = weight === undefined ? 0.5 : weight;\n\n\t\tconst w = 2 * p - 1;\n\t\tconst a = color1.alpha() - color2.alpha();\n\n\t\tconst w1 = (((w * a === -1) ? w : (w + a) / (1 + w * a)) + 1) / 2;\n\t\tconst w2 = 1 - w1;\n\n\t\treturn Color.rgb(\n\t\t\tw1 * color1.red() + w2 * color2.red(),\n\t\t\tw1 * color1.green() + w2 * color2.green(),\n\t\t\tw1 * color1.blue() + w2 * color2.blue(),\n\t\t\tcolor1.alpha() * p + color2.alpha() * (1 - p));\n\t},\n};\n\n// Model conversion methods and static constructors\nfor (const model of Object.keys(convert)) {\n\tif (skippedModels.includes(model)) {\n\t\tcontinue;\n\t}\n\n\tconst {channels} = convert[model];\n\n\t// Conversion methods\n\tColor.prototype[model] = function (...args) {\n\t\tif (this.model === model) {\n\t\t\treturn new Color(this);\n\t\t}\n\n\t\tif (args.length > 0) {\n\t\t\treturn new Color(args, model);\n\t\t}\n\n\t\treturn new Color([...assertArray(convert[this.model][model].raw(this.color)), this.valpha], model);\n\t};\n\n\t// 'static' construction methods\n\tColor[model] = function (...args) {\n\t\tlet color = args[0];\n\t\tif (typeof color === 'number') {\n\t\t\tcolor = zeroArray(args, channels);\n\t\t}\n\n\t\treturn new Color(color, model);\n\t};\n}\n\nfunction roundTo(number, places) {\n\treturn Number(number.toFixed(places));\n}\n\nfunction roundToPlace(places) {\n\treturn function (number) {\n\t\treturn roundTo(number, places);\n\t};\n}\n\nfunction getset(model, channel, modifier) {\n\tmodel = Array.isArray(model) ? model : [model];\n\n\tfor (const m of model) {\n\t\t(limiters[m] || (limiters[m] = []))[channel] = modifier;\n\t}\n\n\tmodel = model[0];\n\n\treturn function (value) {\n\t\tlet result;\n\n\t\tif (value !== undefined) {\n\t\t\tif (modifier) {\n\t\t\t\tvalue = modifier(value);\n\t\t\t}\n\n\t\t\tresult = this[model]();\n\t\t\tresult.color[channel] = value;\n\t\t\treturn result;\n\t\t}\n\n\t\tresult = this[model]().color[channel];\n\t\tif (modifier) {\n\t\t\tresult = modifier(result);\n\t\t}\n\n\t\treturn result;\n\t};\n}\n\nfunction maxfn(max) {\n\treturn function (v) {\n\t\treturn Math.max(0, Math.min(max, v));\n\t};\n}\n\nfunction assertArray(value) {\n\treturn Array.isArray(value) ? value : [value];\n}\n\nfunction zeroArray(array, length) {\n\tfor (let i = 0; i < length; i++) {\n\t\tif (typeof array[i] !== 'number') {\n\t\t\tarray[i] = 0;\n\t\t}\n\t}\n\n\treturn array;\n}\n\nmodule.exports = Color;\n","export class SaxEventType {\n    // 1\n    static Text = 0b1;\n    // 2\n    static ProcessingInstruction = 0b10;\n    // 4\n    static SGMLDeclaration = 0b100;\n    // 8\n    static Doctype = 0b1000;\n    // 16\n    static Comment = 0b10000;\n    // 32\n    static OpenTagStart = 0b100000;\n    // 64\n    static Attribute = 0b1000000;\n    // 128\n    static OpenTag = 0b10000000;\n    // 256\n    static CloseTag = 0b100000000;\n    // 512\n    static Cdata = 0b1000000000;\n}\nexport class Reader {\n    data;\n    cache = {};\n    ptr;\n    constructor(data, ptr = 0) {\n        this.data = data;\n        this.ptr = ptr;\n    }\n}\nexport class Position {\n    line;\n    character;\n    constructor(line, character) {\n        this.line = line;\n        this.character = character;\n    }\n}\nexport var AttributeType;\n(function (AttributeType) {\n    AttributeType[AttributeType[\"Normal\"] = 0] = \"Normal\";\n    AttributeType[AttributeType[\"JSX\"] = 1] = \"JSX\";\n})(AttributeType || (AttributeType = {}));\nexport class Attribute extends Reader {\n    type;\n    name;\n    value;\n    constructor(buffer, ptr = 0) {\n        super(buffer, ptr);\n        this.type = buffer[ptr];\n        ptr += 1;\n        const len = readU32(buffer, ptr);\n        ptr += 4;\n        this.name = new Text(buffer, ptr);\n        ptr += len;\n        this.value = new Text(buffer, ptr);\n    }\n    toJSON() {\n        const { name, value, type } = this;\n        return { name, value, type };\n    }\n    toString() {\n        const { name, value } = this;\n        return `${name}=\"${value}\"`;\n    }\n}\nexport class ProcInst extends Reader {\n    target;\n    content;\n    constructor(buffer, ptr = 0) {\n        super(buffer, ptr);\n        ptr += 16;\n        const len = readU32(buffer, ptr);\n        ptr += 4;\n        this.target = new Text(buffer, ptr);\n        ptr += len;\n        this.content = new Text(buffer, ptr);\n    }\n    get start() {\n        return this.cache.start || (this.cache.start = readPosition(this.data, this.ptr));\n    }\n    get end() {\n        return this.cache.end || (this.cache.end = readPosition(this.data, this.ptr + 8));\n    }\n    toJSON() {\n        const { start, end, target, content } = this;\n        return { start, end, target, content };\n    }\n    toString() {\n        const { target, content } = this;\n        return `<? ${target} ${content} ?>`;\n    }\n}\nexport class Text extends Reader {\n    get start() {\n        return this.cache.start || (this.cache.start = readPosition(this.data, this.ptr));\n    }\n    get end() {\n        return this.cache.end || (this.cache.end = readPosition(this.data, this.ptr + 8));\n    }\n    get value() {\n        if (this.cache.value) {\n            return this.cache.value;\n        }\n        const valueLen = readU32(this.data, this.ptr + 16);\n        return (this.cache.value = readString(this.data, this.ptr + 20, valueLen));\n    }\n    toJSON() {\n        const { start, end, value } = this;\n        return { start, end, value };\n    }\n    toString() {\n        return this.value;\n    }\n}\nexport class Tag extends Reader {\n    get openStart() {\n        return this.cache.openStart || (this.cache.openStart = readPosition(this.data, this.ptr + 8));\n    }\n    get openEnd() {\n        return this.cache.openEnd || (this.cache.openEnd = readPosition(this.data, this.ptr + 16));\n    }\n    get closeStart() {\n        return this.cache.closeStart || (this.cache.closeStart = readPosition(this.data, this.ptr + 24));\n    }\n    get closeEnd() {\n        return this.cache.closeEnd || (this.cache.closeEnd = readPosition(this.data, this.ptr + 32));\n    }\n    get selfClosing() {\n        return !!this.data[this.ptr + 40];\n    }\n    get name() {\n        if (this.cache.name) {\n            return this.cache.name;\n        }\n        const nameLen = readU32(this.data, this.ptr + 41);\n        return (this.cache.name = readString(this.data, this.ptr + 45, nameLen));\n    }\n    get attributes() {\n        if (this.cache.attributes) {\n            return this.cache.attributes;\n        }\n        // starting location of the attribute block\n        let ptr = readU32(this.data, this.ptr);\n        const numAttrs = readU32(this.data, ptr);\n        ptr += 4;\n        const attributes = [];\n        for (let i = 0; i < numAttrs; i++) {\n            const attrLen = readU32(this.data, ptr);\n            ptr += 4;\n            attributes[i] = new Attribute(this.data, ptr);\n            ptr += attrLen;\n        }\n        return (this.cache.attributes = attributes);\n    }\n    get textNodes() {\n        if (this.cache.textNodes) {\n            return this.cache.textNodes;\n        }\n        // starting location of the text nodes block\n        let ptr = readU32(this.data, this.ptr + 4);\n        const numTextNodes = readU32(this.data, ptr);\n        const textNodes = [];\n        ptr += 4;\n        for (let i = 0; i < numTextNodes; i++) {\n            const textLen = readU32(this.data, ptr);\n            ptr += 4;\n            textNodes[i] = new Text(this.data, ptr);\n            ptr += textLen;\n        }\n        return (this.cache.textNodes = textNodes);\n    }\n    toJSON() {\n        const { openStart, openEnd, closeStart, closeEnd, name, attributes, textNodes, selfClosing } = this;\n        return { openStart, openEnd, closeStart, closeEnd, name, attributes, textNodes, selfClosing };\n    }\n    get value() {\n        return this.name;\n    }\n}\nexport class SAXParser {\n    static textDecoder; // Web only\n    events;\n    wasmSaxParser;\n    eventHandler;\n    writeBuffer;\n    constructor(events = 0) {\n        const self = this;\n        Object.defineProperties(this, {\n            events: {\n                get: () => ~~events,\n                set: (value) => {\n                    events = ~~value;\n                    if (self.wasmSaxParser) {\n                        self.wasmSaxParser.parser(events);\n                    }\n                }, configurable: false, enumerable: true\n            }\n        });\n    }\n    async *parse(reader) {\n        let eventAggregator = [];\n        this.eventHandler = function (event, detail) { eventAggregator.push([event, detail]); };\n        while (true) {\n            const chunk = await reader.read();\n            if (chunk.done)\n                return this.end();\n            this.write(chunk.value);\n            if (eventAggregator.length) {\n                for (const event of eventAggregator) {\n                    yield event;\n                }\n                eventAggregator.length = 0;\n            }\n        }\n    }\n    write(chunk) {\n        if (!this.wasmSaxParser) {\n            return;\n        }\n        const { write, memory } = this.wasmSaxParser;\n        // Allocations within the WASM process\n        // invalidate reference to the memory buffer.\n        // We check for this and create a new Uint8Array\n        // with the new memory buffer reference if needed.\n        // **NOTE** These allocations can slow down parsing\n        // if they become excessive. Consider adjusting the\n        // highWaterMark in the options up or down to find the optimal\n        // memory allocation to prevent too many new Uint8Array instances.\n        if (!this.writeBuffer || this.writeBuffer.buffer !== memory.buffer) {\n            this.writeBuffer = new Uint8Array(memory.buffer);\n        }\n        this.writeBuffer.set(chunk, 0);\n        write(0, chunk.byteLength);\n    }\n    end() {\n        this.writeBuffer = undefined;\n        this.wasmSaxParser?.end();\n    }\n    async prepareWasm(saxWasm) {\n        let result;\n        const env = {\n            memory: new WebAssembly.Memory({ initial: 10, shared: true, maximum: 150 }),\n            table: new WebAssembly.Table({ initial: 1, element: 'anyfunc' }),\n            event_listener: this.eventTrap\n        };\n        if (saxWasm instanceof Uint8Array) {\n            result = await WebAssembly.instantiate(saxWasm, { env });\n        }\n        else {\n            result = await WebAssembly.instantiateStreaming(saxWasm, { env });\n        }\n        if (result && typeof this.events === 'number') {\n            const { parser } = this.wasmSaxParser = result.instance.exports;\n            parser(this.events);\n            return true;\n        }\n        throw new Error(`Failed to instantiate the parser.`);\n    }\n    eventTrap = (event, ptr, len) => {\n        if (!this.wasmSaxParser) {\n            return;\n        }\n        const array = new Uint8Array(this.wasmSaxParser.memory.buffer, ptr, len);\n        const uint8array = new Uint8Array(array);\n        let detail;\n        switch (event) {\n            case SaxEventType.Attribute:\n                detail = new Attribute(uint8array);\n                break;\n            case SaxEventType.ProcessingInstruction:\n                detail = new ProcInst(uint8array);\n                break;\n            case SaxEventType.OpenTag:\n            case SaxEventType.CloseTag:\n            case SaxEventType.OpenTagStart:\n                detail = new Tag(uint8array);\n                break;\n            case SaxEventType.Text:\n            case SaxEventType.Cdata:\n            case SaxEventType.Comment:\n            case SaxEventType.Doctype:\n            case SaxEventType.SGMLDeclaration:\n                detail = new Text(uint8array);\n                break;\n            default:\n                throw new Error('No reader for this event type');\n        }\n        if (this.eventHandler) {\n            this.eventHandler(event, detail);\n        }\n    };\n}\nconst readString = (data, offset, length) => {\n    // Node\n    if (globalThis.hasOwnProperty('Buffer')) {\n        return Buffer.from(data.buffer, data.byteOffset + offset, length).toString();\n    }\n    // Web\n    return (SAXParser.textDecoder || (SAXParser.textDecoder = new TextDecoder()))\n        .decode(data.subarray(offset, offset + length));\n};\nconst readU32 = (uint8Array, ptr) => (uint8Array[ptr + 3] << 24) | (uint8Array[ptr + 2] << 16) | (uint8Array[ptr + 1] << 8) | uint8Array[ptr];\nconst readPosition = (uint8Array, ptr = 0) => {\n    const line = readU32(uint8Array, ptr);\n    const character = readU32(uint8Array, ptr + 4);\n    return new Position(line, character);\n};\n","import { PdfDictionary } from './common.js';\nimport { Annotation } from '../iiif.js';\nimport {\n  BoxSelector,\n  SelectorStyle,\n  SupportedSelector,\n  SvgSelector,\n} from '@iiif/helpers';\nimport { PointSelector } from '@iiif/presentation-3';\nimport Color from 'color';\nimport { SAXParser, SaxEventType, Text } from 'sax-wasm';\nimport { textEncoder } from './util.js';\n\nconst ALLOWED_CSS_RULES = [\n  'text-align',\n  'vertical-align',\n  'font-size',\n  'font-weight',\n  'font-style',\n  'font-family',\n  'font',\n  'color',\n  'text-decoration',\n  'font-stretch',\n];\nconst CSS_PAT = /\\s*(?<attrib>[^:]+)\\s*:\\s*(?<val>[^;]+)(?:;|$)/gm;\nconst RGB_PAT = /rgb\\((?<r>\\d+)\\s*,\\s*(?<g>\\d+)\\s*,\\s*(?<b>\\d+)\\)/;\nconst CSS_LENGTH_PAT = /(?<val>\\d+(?:\\.\\d+)?)\\s*(?<unit>[[a-z%]+)?/;\n\nfunction sanitizeCssForPdf(styleAttrib: string): string {\n  let parts: RegExpExecArray | null;\n  const out: Array<string> = [];\n  while ((parts = CSS_PAT.exec(styleAttrib)) !== null) {\n    const [, attrib, value] = parts;\n    if (!ALLOWED_CSS_RULES.includes(attrib)) {\n      continue;\n    }\n    out.push(`${attrib}: ${value}`);\n  }\n  return out.join('; ');\n}\n\nfunction htmlToPlainText(html: string): string {\n  const parser = new SAXParser(SaxEventType.Text);\n  const txt: string[] = [];\n  parser.eventHandler = (ev, data) => {\n    txt.push((data as Text).value);\n  }\n  parser.write(textEncoder.encode(html));\n  return txt.join('').trim();\n}\n\nfunction toPdfRect(\n  selector: BoxSelector | SvgSelector,\n  pageHeight: number,\n  unitScale: number\n): PdfDictionary | null {\n  if (!selector.spatial) {\n    return null;\n  }\n  const lly = pageHeight - selector.spatial.y;\n  const ury = lly - selector.spatial.height;\n  return {\n    Subtype: '/Square',\n    Rect: [\n      selector.spatial.x * unitScale,\n      lly * unitScale,\n      (selector.spatial.x + selector.spatial.width) * unitScale,\n      ury * unitScale,\n    ],\n  };\n}\n\nfunction cssColorToRgb(cssColor: string): [number, number, number] | null {\n  return Color(cssColor).rgb().array() as [number, number, number];\n}\n\nfunction cssLengthToPdfUserspace(\n  cssLength: string,\n  unitScale: number,\n  referenceDimensionPx?: number\n): number | null {\n  const match = CSS_LENGTH_PAT.exec(cssLength);\n  if (!match || !match.groups) {\n    return null;\n  }\n  const val = parseFloat(match.groups.val);\n  const unit = match.groups.unit;\n  if (!unit) {\n    return val * unitScale;\n  }\n  switch (unit) {\n    case '%':\n      if (!referenceDimensionPx) {\n        return null;\n      }\n      return (val / 100) * referenceDimensionPx * unitScale;\n    case 'px':\n      return unitScale * val;\n    default:\n      console.warn(`Unsupported CSS length unit: ${unit}`);\n      return null;\n  }\n}\n\nfunction selectorStyleToPdf(\n  style: SelectorStyle,\n  unitScale: number\n): PdfDictionary {\n  const pdfStyle: PdfDictionary = {};\n  if (style.stroke || style.strokeDasharray || style.strokeWidth) {\n    pdfStyle.BS = {\n      Type: '/Border',\n      W: style.strokeWidth ?? 1,\n      S: style.strokeDasharray ? '/D' : '/S',\n    };\n    if (style.strokeDasharray) {\n      pdfStyle.BS.D = style.strokeDasharray;\n    }\n  }\n  if (style.fill) {\n    const rgb = cssColorToRgb(style.fill);\n    if (rgb) {\n      pdfStyle.IC = rgb.map((c) => c / 255);\n    }\n  }\n  // TODO: Check if fill-opacity is desired and use an Apperance Stream instead of IC\n  if (style.strokeWidth) {\n    const width = cssLengthToPdfUserspace(style.strokeWidth, unitScale);\n    pdfStyle.BS = {\n      Type: '/Border',\n      W: width,\n    };\n  }\n  return pdfStyle;\n}\n\nfunction selectorToPdf(\n  selector: SupportedSelector,\n  unitScale: number,\n  pageHeight: number\n): PdfDictionary {\n  const styleDict = selector.style\n    ? selectorStyleToPdf(selector.style, unitScale)\n    : {};\n  switch (selector.type) {\n    case 'BoxSelector':\n      return {\n        Subtype: '/Square',\n        ...toPdfRect(selector as BoxSelector, pageHeight, unitScale),\n        ...styleDict,\n      };\n    case 'PointSelector': {\n      // TODO: Use a /Stamp with a custom icon (flag?)\n      //       This is a bit complicated since we need to povide\n      //       an /AP dictionary with a custom /Form that\n      //       renders our icon. Luckily, this can be reused, so\n      //       we store it once and just reference it in all point-type\n      //       annotations.\n      const point = selector as PointSelector;\n      if (!point.x || !point.y) {\n        throw `Only PointSelectors with both x and y coordinates are supported!`;\n      }\n      return {\n        Subtype: '/Circle',\n        BS: {\n          Type: '/Border',\n          W: 2,\n          S: '/S',\n        },\n        IC: [1.0, 1.0, 1.0],\n        Rect: [\n          point.x * unitScale - 0.5,\n          point.y * unitScale - 0.5,\n          point.x * unitScale + 1.0,\n          point.y * unitScale + 1.0,\n        ],\n      };\n    }\n    case 'SvgSelector': {\n      const svgSel = selector as SvgSelector;\n      switch (svgSel.svgShape) {\n        case 'rect':\n          return {\n            Subtype: '/Square',\n            ...toPdfRect(svgSel, pageHeight, unitScale),\n            ...styleDict,\n          };\n        case 'circle':\n        case 'ellipse':\n          return {\n            Subtype: '/Circle',\n            Rect: toPdfRect(svgSel, pageHeight, unitScale),\n            ...styleDict,\n          };\n        case 'polyline':\n        case 'polygon':\n          return {\n            Subtype: svgSel.svgShape === 'polyline' ? '/PolyLine' : '/Polygon',\n            Vertices:\n              svgSel.points?.flatMap(([x, y]) => [\n                x * unitScale,\n                (pageHeight - y) * unitScale,\n              ]) ?? [],\n            ...styleDict,\n          };\n        case 'path':\n          return {\n            Subtype: '/Ink',\n            InkList:\n              svgSel.points?.flatMap(([x, y]) => [\n                x * unitScale,\n                (pageHeight - y) * unitScale,\n              ]) ?? [],\n            ...styleDict,\n          };\n        default:\n          throw new Error('not implemented yet');\n      }\n    }\n    default:\n      throw `${selector.type} selector is currently not supported`;\n  }\n}\n\nexport function exportPdfAnnotation(\n  anno: Annotation,\n  unitScale: number,\n  pageHeight: number\n): Array<PdfDictionary> {\n  const annoDict: PdfDictionary = {\n    Type: '/Annot',\n    NM: `(${anno.id})`,\n    Contents: `(${htmlToPlainText(anno.markup)})`,\n    F: 4,\n    C: [1, 0, 0], // Red title bar\n    CA: 1, // Constant opacity of 1\n    Border: [0, 0, 5],\n    //RC: `(${htmlToPdfRichText(anno.markup)})`,\n  };\n  if (anno.author) {\n    annoDict.T = `(${anno.author})`;\n  }\n  if (anno.lastModified) {\n    annoDict.M = anno.lastModified;\n  }\n  if (anno.target.selector) {\n    return [\n      {\n        ...annoDict,\n        ...selectorToPdf(anno.target.selector, unitScale, pageHeight),\n      },\n    ] as PdfDictionary[];\n  } else if (anno.target.selectors && anno.target.selectors.length > 0) {\n    return anno.target.selectors.map((s) => ({\n      ...annoDict,\n      ...selectorToPdf(s, unitScale, pageHeight),\n    })) as PdfDictionary[];\n  }\n  return [];\n}\n","/* eslint-disable no-new-wrappers */\n/* eslint-disable @typescript-eslint/no-non-null-assertion */\n\n/// PDF generation code\n// FIXME: This is currently one hell of a mess, learning about PDF and coming up\n// with good abstractions at the same time was too much of a challenge for me \nimport dedent from 'dedent-js';\nimport { Manifest } from '@iiif/presentation-3';\nimport { Manifest as ManifestV2 } from '@iiif/presentation-2';\nimport { OcrPage, OcrBlock, OcrParagraph, OcrLine, OcrWord } from 'ocr-parser';\n\nimport {\n  Metadata,\n  PdfObject,\n  PdfDictionary,\n  makeRef,\n  PdfArray,\n  PdfRef,\n  serialize,\n  PdfValue,\n  toUTF16BE,\n  StructTreeEntry,\n} from './common.js';\nimport { TocItem, textEncoder, randomData, tryDeflateStream } from './util.js';\nimport { ArrayReader, Writer } from '../io.js';\nimport { OcrPageWithMarkup } from '../ocr.js';\nimport PdfImage, { JPEGImage, PNGImage } from './image.js';\nimport { PdfParser } from './parser.js';\nimport pdiiifVersion from '../version.js';\nimport log from '../log.js';\nimport {\n  CanvasImage,\n  ImageFetchFailure,\n  StartCanvasInfo,\n  isImageFetchFailure,\n} from '../download.js';\nimport { Annotation, CanvasInfo, getI18nValue } from '../iiif.js';\nimport {\n  buildCentralFileDirectory,\n  buildLocalZipHeader,\n  CentralDirectoryFileSpec,\n} from './pkzip.js';\nimport { crc32 } from '../util.js';\nimport { exportPdfAnnotation } from './annos.js';\nimport { OptimizationParams } from '../optimization.js';\n\nconst PRODUCER = `pdiiif v${pdiiifVersion}`;\n\n/// If the font is 10 pts, nominal character width is 5 pts\nconst CHAR_WIDTH = 2;\n\n/// Taken from tesseract@2d6f38eebf9a14d9fbe65d785f0d7bd898ff46cb, tessdata/pdf.ttf\n/// Created by Ken Sharp\n/// (C) Copyright 2011, Google Inc.\n/// Licensed under the Apache License, Version 2.0 (the \"License\");\n/// you may not use this file except in compliance with the License.\n/// You may obtain a copy of the License at http://www.apache.org/licenses/LICENSE-2.0\n/// Unless required by applicable law or agreed to in writing, software\n/// distributed under the License is distributed on an \"AS IS\" BASIS,\n/// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n/// See the License for the specific language governing permissions and\n/// limitations under the License.\nconst FONTDATA = new Uint8Array([\n  0, 1, 0, 0, 0, 10, 0, 128, 0, 3, 0, 32, 79, 83, 47, 50, 86, 222, 200, 148, 0,\n  0, 1, 40, 0, 0, 0, 96, 99, 109, 97, 112, 0, 10, 0, 52, 0, 0, 1, 144, 0, 0, 0,\n  30, 103, 108, 121, 102, 21, 34, 65, 36, 0, 0, 1, 184, 0, 0, 0, 24, 104, 101,\n  97, 100, 11, 120, 241, 101, 0, 0, 0, 172, 0, 0, 0, 54, 104, 104, 101, 97, 12,\n  2, 4, 2, 0, 0, 0, 228, 0, 0, 0, 36, 104, 109, 116, 120, 4, 0, 0, 0, 0, 0, 1,\n  136, 0, 0, 0, 8, 108, 111, 99, 97, 0, 12, 0, 0, 0, 0, 1, 176, 0, 0, 0, 6, 109,\n  97, 120, 112, 0, 4, 0, 5, 0, 0, 1, 8, 0, 0, 0, 32, 110, 97, 109, 101, 242,\n  235, 22, 218, 0, 0, 1, 208, 0, 0, 0, 75, 112, 111, 115, 116, 0, 1, 0, 1, 0, 0,\n  2, 28, 0, 0, 0, 32, 0, 1, 0, 0, 0, 1, 0, 0, 176, 148, 113, 16, 95, 15, 60,\n  245, 4, 7, 8, 0, 0, 0, 0, 0, 207, 154, 252, 110, 0, 0, 0, 0, 212, 195, 167,\n  242, 0, 0, 0, 0, 4, 0, 8, 0, 0, 0, 0, 16, 0, 2, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0,\n  8, 0, 255, 255, 0, 0, 4, 0, 0, 0, 0, 0, 4, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0,\n  0, 0, 0, 0, 0, 0, 2, 0, 1, 0, 0, 0, 2, 0, 4, 0, 1, 0, 0, 0, 0, 0, 1, 0, 0, 0,\n  0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 0, 0, 1, 144, 0, 5, 0, 0, 0, 0,\n  0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 0, 1, 0, 1, 0,\n  0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 71, 79, 79, 71, 0,\n  64, 0, 0, 0, 0, 0, 1, 255, 255, 0, 0, 0, 1, 0, 1, 128, 0, 0, 0, 0, 0, 0, 0, 0,\n  0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 4, 0, 0, 0, 0, 0, 0, 2, 0, 1, 0, 0, 0,\n  0, 0, 20, 0, 3, 0, 0, 0, 0, 0, 20, 0, 6, 0, 10, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,\n  0, 0, 0, 12, 0, 0, 0, 1, 0, 0, 0, 0, 4, 0, 8, 0, 0, 3, 0, 0, 49, 33, 17, 33,\n  4, 0, 252, 0, 8, 0, 0, 0, 0, 3, 0, 42, 0, 0, 0, 3, 0, 0, 0, 5, 0, 22, 0, 0, 0,\n  1, 0, 0, 0, 0, 0, 5, 0, 11, 0, 22, 0, 3, 0, 1, 4, 9, 0, 5, 0, 22, 0, 0, 0, 86,\n  0, 101, 0, 114, 0, 115, 0, 105, 0, 111, 0, 110, 0, 32, 0, 49, 0, 46, 0, 48,\n  86, 101, 114, 115, 105, 111, 110, 32, 49, 46, 48, 0, 0, 1, 0, 0, 0, 0, 0, 0,\n  0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,\n]);\n\ntype ZipDummyObjectSpec = {\n  filename: string;\n  data: Uint8Array;\n  deflatedData?: Uint8Array;\n  bytesUntilActualData: number;\n};\n\nexport type GeneratorParams = {\n  // Writer to output the PDF to\n  writer: Writer;\n  // Metadata to include in the PDF\n  metadata: Metadata;\n  // Information about canvases included in the PDF\n  canvasInfos: CanvasInfo[];\n  // List of languages to use for rendering labels, in descending order of preference\n  langPref: readonly string[];\n  // Labels for pages, every position corresponds to the canvas in the same position\n  pageLabels?: string[];\n  // Outline tree for the PDF\n  outline: TocItem[];\n  // Whether the PDF should include a hidden text layer\n  hasText?: boolean;\n  // Reading direction of the PDF\n  readingDirection?: 'right-to-left' | 'left-to-right';\n  // Information about the canvas (or canvas region) that should be displayed initially\n  initialCanvas?: StartCanvasInfo;\n  // The manifest to build the PDF from\n  manifestJson?: Manifest | ManifestV2;\n  // If this is enabled, the PDF will also be a valid ZIP archive of all the resources\n  // included in the PDF\n  zipPolyglot?: boolean;\n  // Base directory name for the polyglot ZIP archive, if not set the resources will be\n  // top-level in the archive\n  zipBaseDir?: string;\n  // Optimize images to reduce size\n  optimization?: OptimizationParams;\n};\n\n/** Streaming PDF generator based on a IIIF manifest.\n *\n * This class is responsible for generating a PDF document based on a IIIF manifest.\n * It is designed to be used in a streaming fashion, i.e. it can start writing the PDF\n * before all the resources have been loaded and thus does not require a huge amount\n * of memory. On the flipside, this makes the code a lot more complex, since we need\n * to keep track of the PDF's internal state and write objects in the correct order.\n * Another complication is that we want to write out the catalog and page tree first\n * to allow viewers to quickly display the first page, which requires a bunch of\n * complicated pre-allocation of objects.\n *\n * FIXME: Can't we just write the pages first and then the catalog and page tree at\n *        the end of the file? Would make things *A LOT* easier and less complex and\n *        error-prone.\n */\nexport default class PDFGenerator {\n  // Keep track of how many bytes have been written so far\n  _offset = 0;\n  // PDF objects that are scheduled for writing, will be written on _flush()\n  _objects: Array<PdfObject> = [];\n  // Number of the next PDF object\n  _nextObjNo = 1;\n  // References to various central objects\n  _objRefs: Record<string, PdfRef> = {};\n  // Tracks offset of every XObject\n  _offsets: number[] = [];\n  // Writer used for outputting the PDF\n  _writer: Writer | undefined;\n  // Have we already started writing the IIIF pages?\n  _pagesStarted = false;\n  // Information about each canvas, needed for pre-allocating objects\n  _canvasInfos: Array<CanvasInfo> = [];\n  // Object number of the first page\n  _firstPageObjectNum: number | undefined;\n  // Labels for every page in the PDF\n  _pageLabels?: string[];\n  // Number of cover pages inserted at the beginning of the PDF\n  _numCoverPages = 0;\n  // PDF outline\n  _outline: TocItem[] = [];\n  // Is the PDF supposed to have a hidden text layer?\n  _hasText = false;\n  // List of top-level entries in the PDF's logical structure tree\n  _strucTree: StructTreeEntry[] = [];\n  // Maps a page's object number to the marked content sequence IDs its content\n  // stream has\n  _pageMCIds: Map<number, Array<number>> = new Map();\n  // Identifier of the next structure parent entry\n  _nextStructParentId = 0;\n  // For every page, its corresponding parent ID for the parent tree\n  _pageParentIds: Map<number, number> = new Map();\n  // Language preference\n  _langPref: readonly string[];\n  _initialCanvas?: StartCanvasInfo;\n  private _polyglot: boolean;\n  private _manifestJson?: Manifest | ManifestV2;\n  private _zipCatalog?: Array<CentralDirectoryFileSpec>;\n  private _zipBaseDir?: string;\n  private _readingDirection: 'right-to-left' | 'left-to-right';\n  // FIXME: Overlap with _objRefs, should be unified\n  private _deferredReferences = new Map<string, PdfRef>();\n\n  /** Just basic setup of state, real setup is done in setup()\n      method since we need to call a bunch of async stuff */\n  constructor({\n    writer,\n    metadata,\n    canvasInfos,\n    langPref,\n    pageLabels,\n    outline = [],\n    readingDirection = 'left-to-right',\n    hasText = false,\n    initialCanvas,\n    manifestJson,\n    zipPolyglot = false,\n    zipBaseDir,\n  }: GeneratorParams) {\n    this._writer = writer;\n    this._canvasInfos = canvasInfos;\n    this._pageLabels = pageLabels;\n    this._outline = outline;\n    this._hasText = hasText;\n    this._readingDirection = readingDirection;\n    this._langPref = langPref;\n    this._initialCanvas = initialCanvas;\n    this._polyglot = zipPolyglot;\n    this._zipBaseDir = zipBaseDir;\n    this._manifestJson = manifestJson;\n\n    const pdfMetadata: PdfDictionary = {\n      ...Object.entries(metadata)\n        .filter((k, v) => v !== undefined)\n        .reduce((prev, [k, v]) => {\n          prev[k] = `(${v})`;\n          return prev;\n        }, {} as PdfDictionary),\n      Producer: `(${PRODUCER})`,\n    };\n    this._addObject(pdfMetadata, 'Info');\n  }\n\n  /** Set up the basic PDF document, creating neccessary objects.  */\n  async setup(): Promise<void> {\n    // Add the catalog object, will be updated later\n    const catalog: PdfDictionary = {\n      Type: '/Catalog',\n    };\n    this._addObject(catalog, 'Catalog');\n\n    // Pages Dictionary, will be updated later\n    const pagesObj = this._addObject(\n      {\n        Type: '/Pages',\n        Count: this._canvasInfos.length,\n      },\n      'Pages'\n    );\n    catalog.Pages = makeRef(pagesObj);\n\n    // Indicate that our PDF contains structure information, attached to the text layer\n    if (this._hasText) {\n      catalog.MarkInfo = {\n        Type: '/MarkInfo',\n        Marked: true,\n      };\n    }\n\n    if (this._outline.length > 0) {\n      // If we have an outline, display the ToC by default in PDF viewers and set up\n      // the required objects\n      catalog.PageMode = '/UseOutlines';\n      const outlines: PdfDictionary = {\n        Type: '/Outlines',\n        Count: 0,\n      };\n      const outlinesObj = this._addObject(outlines);\n      catalog.Outlines = makeRef(outlinesObj);\n      let prev: PdfObject | undefined;\n      for (const [idx, itm] of this._outline.entries()) {\n        const [childObj, numKids] = this._addOutline(itm, outlinesObj, prev);\n        (outlines.Count as number) += 1 + numKids;\n        if (idx === 0) {\n          outlines.First = makeRef(childObj);\n        } else if (idx === this._outline.length - 1) {\n          outlines.Last = makeRef(childObj);\n        }\n        prev = childObj;\n      }\n    } else {\n      // Otherwise, display the thumbnails in PDF viewers\n      catalog.PageMode = '/UseThumbs';\n    }\n\n    // Adjust reading direction to RTL if neccessary\n    catalog.ViewerPreferences = {\n      Direction: this._readingDirection === 'right-to-left' ? '/R2L' : '/L2R',\n    };\n\n    if (this._hasText) {\n      await this._setupHiddenTextFont();\n    }\n  }\n\n  /** Set up neccessary fonts for the hidden text layer. */\n  async _setupHiddenTextFont(): Promise<void> {\n    const typeZeroFont = this._addObject(\n      {\n        Type: '/Font',\n        Subtype: '/Type0',\n        BaseFont: '/GlyphLessFont',\n        Encoding: '/Identity-H',\n      },\n      'Type0Font'\n    );\n\n    const typeTwoFont = this._addObject({\n      type: '/Font',\n      Subtype: '/CIDFontType2',\n      BaseFont: '/GlyphLessFont',\n      DW: 1000 / CHAR_WIDTH,\n      CIDSystemInfo: {\n        Ordering: '(Identity)',\n        Registry: '(Adobe)',\n        Supplement: 0,\n      },\n    });\n    (typeZeroFont.data as PdfDictionary).DescendantFonts = [\n      makeRef(typeTwoFont),\n    ];\n\n    // Set up character id to glyph id mapping\n    const cidtoGidMapData = new Uint8Array(128 * 1024);\n    for (let i = 0; i < cidtoGidMapData.length; i++) {\n      cidtoGidMapData[i] = i % 2 ? 1 : 0;\n    }\n    const comp = await tryDeflateStream(cidtoGidMapData);\n    const cidToGidMap = this._addObject(comp.dict, undefined, comp.stream);\n    (typeTwoFont.data as PdfDictionary).CIDToGIDMap = makeRef(cidToGidMap);\n\n    // Set up character code to unicode codepoint mapping\n    // Effectively an identity mapping, since in our font every character code\n    // exactly corresponds to the unicode codepoint\n    const cmapStream = dedent`\n      /CIDInit /ProcSet findresource begin\n        12 dict begin\n        begincmap\n            /CIDSystemInfo\n            <<\n              /Registry (Adobe)\n              /Ordering (UCS)\n              /Supplement 0\n            >> def\n            /CMapName /Identity-H def\n            /CMapType 2 def\n            1 begincodespacerange\n            <0000> <FFFF>\n            endcodespacerange\n            1 beginbfrange\n            <0000> <FFFF> <0000>\n            endbfrange\n        endcmap\n        CMapName currentdict /CMap defineresource pop\n        end\n    end`;\n    const cmap = this._addObject(\n      {\n        Length: cmapStream.length,\n      },\n      undefined,\n      cmapStream\n    );\n    (typeZeroFont.data as PdfDictionary).ToUnicode = makeRef(cmap);\n\n    // Set up the font descriptor for our hidden text font\n    const fontDesc = this._addObject({\n      Type: '/FontDescriptor',\n      FontName: '/GlyphLessFont',\n      FontBBox: [0, 0, 1000 / CHAR_WIDTH, 1000],\n      Ascent: 1000,\n      CapHeight: 1000,\n      Descent: -1,\n      Flags: 5,\n      ItalicAngle: 0,\n      StemV: 80,\n    });\n    (typeTwoFont.data as PdfDictionary).FontDescriptor = makeRef(fontDesc);\n\n    const maybeCompressedFont = await tryDeflateStream(FONTDATA);\n    const fontDataObj = this._addObject(\n      {\n        Length1: FONTDATA.length,\n        ...maybeCompressedFont.dict,\n      },\n      undefined,\n      maybeCompressedFont.stream\n    );\n    (fontDesc.data as PdfDictionary).FontFile2 = makeRef(fontDataObj);\n  }\n\n  /** Register embedded OCR files in the PDF's catalog object. */\n  _registerEmbeddedFilesInCatalog() {\n    const catalog = this._objects[this._objRefs.Catalog.refObj]\n      .data as PdfDictionary;\n    const embeddedFiles: PdfArray = [\n      `(manifest.json)`,\n      makeRef(this._firstPageObjectNum! - (this._polyglot ? 3 : 2)),\n    ];\n    for (const [idx, canvas] of this._canvasInfos.entries()) {\n      if (!canvas.ocr) {\n        continue;\n      }\n      const pageObjNum = this.getCanvasObjectNumber(idx);\n      // The file spec for embedded OCR file is the previous to last XObject for a given canvas\n      let fileObjNum = pageObjNum + this.getObjectsPerCanvas(idx) - 2;\n      if (this._polyglot) {\n        // Except if the PDF is polyglot, then it's the second to last XObject\n        fileObjNum -= 1;\n      }\n      embeddedFiles.push(`(${canvas.ocr.id})`);\n      embeddedFiles.push(makeRef(fileObjNum));\n    }\n    if (!catalog.Names) {\n      catalog.Names = {\n        EmbeddedFiles: { Names: embeddedFiles },\n      };\n    } else {\n      const names = catalog.Names as PdfDictionary;\n      const nameTree = names.EmbeddedFiles as PdfDictionary;\n      nameTree.Names = (nameTree.Names as PdfArray).concat(embeddedFiles);\n    }\n  }\n\n  /** Create a PdfRef whose value is deferred, i.e. will be set at a later stage.\n   *\n   * Useful for bidirectional references.\n   *\n   * Prevents serialization of objects containing this reference as long as the\n   * value is not set.\n   *\n   * @param key A unique key to identify the reference\n   */\n  _makeDeferredReference(key: string): PdfRef {\n    if (!this._deferredReferences.has(key)) {\n      // Placeholder reference\n      const ref = makeRef(-1);\n      this._deferredReferences.set(key, ref);\n    }\n    return this._deferredReferences.get(key)!;\n  }\n\n  /** Add items to the PDF's outline, based on the passed TocItem tree.\n   *\n   * @param itm The item we want to add to the outline\n   * @param parent The parent outline item\n   * @param prev The preceding sibling outline item, if present\n   * @returns A tuple containing the object reference of the added outline item and the number\n   *         of children outline items that were created\n   */\n  _addOutline(\n    itm: TocItem,\n    parent: PdfObject,\n    prev?: PdfObject\n  ): [PdfObject, number] {\n    let dest: PdfArray;\n    if (typeof itm.startCanvas === 'string') {\n      // Simple case, just linke to a whole canvas/page\n      const destCanvasIdx = this._canvasInfos.findIndex(\n        (ci) => ci.canvas.id === itm.startCanvas\n      );\n      if (destCanvasIdx < 0) {\n        throw Error(\n          `Could not find canvas with id ${itm.startCanvas} in manifest!`\n        );\n      }\n      dest = [destCanvasIdx, '/Fit'];\n    } else {\n      // More complex: link to a specific region on a canvas\n      const canvasId = itm.startCanvas.id;\n      const unitScale = 72 / itm.startCanvas.ppi;\n      const rect = itm.startCanvas.position;\n      const { width, height } = itm.startCanvas.dimensions;\n      const destCanvasIdx = this._canvasInfos.findIndex(\n        (ci) => ci.canvas.id === canvasId\n      );\n      if (destCanvasIdx < 0) {\n        throw Error(`Could not find canvas with id ${canvasId} in manifest!`);\n      }\n      dest = [\n        destCanvasIdx,\n        '/FitR',\n        // TODO: Thoroughly test that this is actually working!\n        unitScale * rect.x, // left\n        unitScale * rect.y, // bottom\n        unitScale * (width - (rect.x + rect.width)), // right,\n        unitScale * (height - (rect.y + rect.height)), // top,\n      ];\n    }\n\n    const rec: PdfDictionary = {\n      Title: `( ${itm.label} )`,\n      Parent: makeRef(parent),\n      // NOTE: The first entry is a number only during setup and will later be\n      //       replaced with a reference to the actual page object, once we know\n      //       how many objects are preceding the page objects.\n      Dest: dest,\n    };\n    const obj = this._addObject(rec);\n    if (prev) {\n      rec.Prev = makeRef(prev);\n      (prev.data as PdfDictionary).Next = makeRef(obj);\n    }\n\n    if (itm.children?.length) {\n      // Recursively add children\n      let prev: PdfObject | undefined;\n      rec.Count = 0;\n      for (const [idx, child] of itm.children.entries()) {\n        const [childObj, numChildren] = this._addOutline(child, obj, prev);\n        if (idx === 0) {\n          rec.First = makeRef(childObj);\n        } else if (idx === itm.children.length - 1) {\n          rec.Last = makeRef(childObj);\n        }\n        rec.Count = rec.Count + 1 + numChildren;\n        prev = childObj;\n      }\n    }\n    return [obj, (rec.Count as number) ?? 0];\n  }\n\n  /** Add a new object to the PDF document.\n   *\n   * @param val A PDF value, can be any of the supported types.\n   * @param refName An optional name to reference the object by.\n   * @param stream An optional stream to attach to the object, value must be adictionary in this case\n   * @returns The created object\n   */\n  _addObject(\n    val: PdfValue,\n    refName?: string,\n    stream?: Uint8Array | string\n  ): PdfObject {\n    const isObject = (x: unknown): x is object =>\n      typeof x === 'object' && x !== null;\n    if (stream) {\n      if (!isObject(val)) {\n        throw new Error(\n          'PDF Objects with a stream must have a dictionary as its value'\n        );\n      }\n      if (!(val as PdfDictionary).Length) {\n        (val as PdfDictionary).Length = stream.length;\n      }\n    }\n    const obj = {\n      num: this._nextObjNo,\n      data: val,\n      stream,\n    };\n    this._nextObjNo++;\n    this._objects[obj.num] = obj;\n    if (refName) {\n      this._objRefs[refName] = makeRef(obj);\n    }\n    return obj;\n  }\n\n  /** Clone an object from a foreign PDF into the current PDF, adjusting\n   *  the encountered indirect object references.\n   *\n   * @param parser PdfParser instance for the PDF the object is from\n   * @param obj The object to transplant into our document\n   * @param seenObjects A map of object numbers to known references, used to avoid\n   *                    infinite recursion\n   * @returns A reference to the transplanted object\n   */\n  private async _transplantObject(\n    parser: PdfParser,\n    obj: PdfObject,\n    seenObjects: Record<number, PdfRef> = {}\n  ): Promise<PdfRef> {\n    const handleValue = async (value: PdfValue): Promise<PdfValue> => {\n      if (value instanceof PdfRef) {\n        const o = await parser.resolveRef(value);\n        if (o === undefined) {\n          throw `Could not resolve reference to object '${value.refObj}'`;\n        }\n        // Check if we've already transplanted the object\n        if (seenObjects[o.num]) {\n          return seenObjects[o.num];\n        }\n        const objDict = o.data as PdfDictionary;\n        const newObj = this._addObject(objDict, undefined, o.stream);\n        const ref = new PdfRef(newObj.num);\n        seenObjects[o.num] = ref;\n        newObj.data = await handleValue(objDict);\n        if (objDict.Type === '/Page') {\n          // Redirect to our own Pages object\n          (newObj.data as PdfDictionary).Parent = this._objRefs.Pages;\n        }\n        return ref;\n      } else if (typeof value === 'string' && value[0] != '/') {\n        return `(${value})`;\n      } else if (Array.isArray(value)) {\n        const out = [];\n        for (const val of value) {\n          out.push(await handleValue(val));\n        }\n        return out;\n      } else if (typeof value === 'object' && value !== null) {\n        const out: PdfDictionary = {};\n        for (const [key, val] of Object.entries(value)) {\n          // Ignore structure keys for now\n          if (key === 'StructParent' || key === 'StructParents') {\n            continue;\n          }\n          out[key] = await handleValue(val as PdfDictionary);\n        }\n        return out;\n      }\n      return value;\n    };\n    const ref = new PdfRef(obj.num);\n    // TODO: Special case: if the object is a page, we need to check for\n    //       a /StructParents key, check for the /StructTreeRoot key in\n    //       the catalog, and then transplant that to our _strucTree\n    //       and _pageMCIDs structures. Quite the handful!!\n    return (await handleValue(ref)) as PdfRef;\n  }\n\n  /** Insert cover pages from another PDF into our document. */\n  async insertCoverPages(pdfData: ArrayBuffer): Promise<void> {\n    if (this._pagesStarted) {\n      throw 'Cover pages must be inserted before writing the first regular page';\n    }\n    const reader = new ArrayReader(new Uint8Array(pdfData));\n    const parser = await PdfParser.parse(reader);\n    const pagesDict = this._objects[this._objRefs.Pages.refObj]\n      .data as PdfDictionary;\n    pagesDict.Kids = [];\n    // TODO: Parse and transplant the section and parent trees from\n    //       the catalog into our own structures.\n    for await (const page of parser.pages()) {\n      const dict = page.data as PdfDictionary;\n      // Ignore associated structured content for now\n      delete dict.StructParents;\n      delete dict.Parent;\n      const newPageRef = await this._transplantObject(parser, page);\n      (pagesDict.Kids as PdfArray).push(newPageRef);\n      (pagesDict.Count as number) += 1;\n      this._numCoverPages += 1;\n    }\n    return;\n  }\n\n  /** Embed a file resource in the PDF.\n   *\n   * @param filename The filename for the embedded resource\n   * @param description A description of the file\n   * @param mimeType The MIME type of the file\n   * @param data The data to embed\n   */\n  private async _embedResource(\n    filename: string,\n    description: string,\n    mimeType: string,\n    data: string\n  ): Promise<void> {\n    // TODO: Add check that the file is actually pre-registered in\n    //       the catalog!\n    const fileSpec: PdfDictionary = {\n      Type: '/Filespec',\n      F: `(${filename})`,\n      UF: toUTF16BE(filename),\n      Desc: `(${description})`,\n      EF: {\n        F: makeRef(this._nextObjNo + (this._polyglot ? 2 : 1)),\n      },\n    };\n\n    const maybeCompressed = await tryDeflateStream(data);\n    const embeddedFile = {\n      Type: '/EmbeddedFile',\n      Subtype: `(${mimeType})`,\n      ...maybeCompressed.dict,\n    };\n\n    this._addObject(fileSpec);\n    if (this._polyglot) {\n      let zipData: Uint8Array;\n      if (typeof data === 'string') {\n        zipData = textEncoder.encode(data);\n      } else {\n        zipData = data;\n      }\n      const extraDataLength = this._getSerializedSize(\n        {\n          num: this._nextObjNo + 2,\n          data: { ...embeddedFile, ...maybeCompressed.dict },\n          stream: maybeCompressed.stream,\n        },\n        true\n      );\n      this._insertZipHeaderDummyObject({\n        filename,\n        data: zipData,\n        deflatedData: maybeCompressed.dict.Filter\n          ? (maybeCompressed.stream as Uint8Array)\n          : undefined,\n        // 2 bytes zlib header of deflated data\n        bytesUntilActualData: extraDataLength + 2,\n      });\n    }\n    this._addObject(embeddedFile, undefined, maybeCompressed.stream);\n  }\n\n  /** Embed the IIIF Manifest JSON in the PDF.\n   *\n   * @param manifestJson The IIIF (v2 or v3) Manifest to embed\n   */\n  private async _embedManifest(\n    manifestJson: ManifestV2 | Manifest\n  ): Promise<void> {\n    let manifestMime = 'application/ld+json';\n    if (Array.isArray(manifestJson['@context'])) {\n      const manifestProfile = manifestJson['@context'].find((p) =>\n        p.startsWith('http://iiif.io/api/presentation')\n      );\n      if (manifestProfile) {\n        manifestMime += `;profile=\"${manifestProfile}\"`;\n      }\n    } else if (manifestJson['@context']) {\n      manifestMime += `;profile=\"${manifestJson['@context']}\"`;\n    }\n    await this._embedResource(\n      'manifest.json',\n      'IIIF Manifest this PDF is based on',\n      manifestMime,\n      JSON.stringify(manifestJson)\n    );\n  }\n\n  /** Once all setup is complete and we begin rendering pages into the document,\n   *  we need to finalize the PDF header with the remaining information.\n   */\n  async finalizePdfHeader(): Promise<void> {\n    const catalog = this._objects[this._objRefs.Catalog.refObj]\n      .data as PdfDictionary;\n\n    // Create page tree with page labels\n    if (this._pageLabels) {\n      catalog.PageLabels = makeRef(\n        this._addObject({\n          Nums: this._pageLabels\n            .map((label, idx) =>\n              label\n                ? [idx + this._numCoverPages, { P: `( ${label} )` }]\n                : undefined\n            )\n            .filter((x) => x !== undefined)\n            .flat() as PdfArray,\n        })\n      );\n    }\n\n    const pagesObj = this._objects[this._objRefs.Pages.refObj];\n\n    // Now that we know from which object number the pages start, we can set the\n    // /Kids entry in the Pages object and update the outline destinations.\n    const pageDict = pagesObj.data as PdfDictionary;\n    if (!pageDict.Kids) {\n      pageDict.Kids = [];\n    }\n    this._firstPageObjectNum = this._nextObjNo;\n    if (this._manifestJson) {\n      this._firstPageObjectNum += 2;\n      if (this._polyglot) {\n        this._firstPageObjectNum++;\n      }\n    }\n    for (const [idx] of this._canvasInfos.entries()) {\n      (pageDict.Kids as PdfArray).push(\n        makeRef(this.getCanvasObjectNumber(idx))\n      );\n    }\n    this._objects\n      // Get ToC entry object, the first destination will be the canvas index\n      .filter((obj) => (obj.data as PdfDictionary)?.Dest !== undefined)\n      .forEach((obj: PdfObject) => {\n        const dest = (obj.data as PdfDictionary).Dest as PdfArray;\n        if (typeof dest[0] !== 'number') {\n          return;\n        }\n        dest[0] = makeRef(this.getCanvasObjectNumber(dest[0]));\n      });\n\n    // Register the structural content tree root\n    if (this._hasText) {\n      catalog.StructTreeRoot = makeRef(\n        this._nextObjNo + this.totalCanvasObjects\n      );\n    }\n\n    // Register the optional content groups, if present\n    if (this._canvasInfos.some((ci) => ci.images.some((i) => i.choiceInfo))) {\n      // We're *very* explicit with the visibility of the various OCGs to\n      // ensure as broad a viewer support as possible (especially pdf.js\n      // needed it...)\n      const initiallyEnabledOCGs: PdfRef[] = [];\n      const initiallyDisabledOCGs: PdfRef[] = [];\n      const allOCGs: PdfRef[] = [];\n      const rbGroups: PdfRef[][] = [];\n      for (const [canvasIdx, { images }] of this._canvasInfos.entries()) {\n        const pageObjNum = this.getCanvasObjectNumber(canvasIdx);\n        let ocgStart = pageObjNum + 2 + images.length;\n        if (this._polyglot) {\n          // Take 'dummy' objects for ZIP polyglot into account\n          ocgStart += images.length;\n        }\n        let ocgIdx = 0;\n        const rbGroup = [];\n        for (const img of images) {\n          if (!img.choiceInfo) {\n            continue;\n          }\n          const ref = makeRef(ocgStart + ocgIdx);\n          if (img.choiceInfo.enabled) {\n            initiallyEnabledOCGs.push(ref);\n          } else {\n            initiallyDisabledOCGs.push(ref);\n          }\n          allOCGs.push(ref);\n          rbGroup.push(ref);\n          ocgIdx++;\n        }\n        rbGroups.push(rbGroup);\n      }\n      catalog.OCProperties = {\n        OCGs: allOCGs,\n        D: {\n          BaseState: '/OFF',\n          ON: initiallyEnabledOCGs,\n          OFF: initiallyDisabledOCGs,\n          RBGroups: rbGroups,\n        },\n      };\n    }\n\n    // Set the initial view of the PDF\n    if (typeof this._initialCanvas === 'string') {\n      // ...to a whole page\n      catalog.OpenAction = [\n        makeRef(\n          this.getCanvasObjectNumber(\n            this._canvasInfos.findIndex(\n              (ci) => ci.canvas.id === this._initialCanvas\n            )\n          )\n        ),\n      ];\n    } else if (this._initialCanvas) {\n      // ...to a specific region on a page\n      const unitScale = 72 / this._initialCanvas.ppi;\n      const rect = this._initialCanvas.position;\n      const { width, height } = this._initialCanvas.dimensions;\n      catalog.OpenAction = [\n        makeRef(\n          this.getCanvasObjectNumber(\n            this._canvasInfos.findIndex(\n              (ci) => ci.canvas.id === this._initialCanvas\n            )\n          )\n        ),\n        '/FitR',\n        // TODO: Thoroughly test that this is actually working!\n        unitScale * rect.x, // left\n        unitScale * rect.y, // bottom\n        unitScale * (width - (rect.x + rect.width)), // right,\n        unitScale * (height - (rect.y + rect.height)), // top,\n      ];\n    }\n\n    this._registerEmbeddedFilesInCatalog();\n\n    await this._flush();\n\n    if (this._manifestJson) {\n      await this._embedManifest(this._manifestJson);\n      await this._flush();\n    }\n  }\n\n  /** Render a new page, based on a IIIF canvas, its associated annotations and OCR text.\n   *\n   * @param canvasId The ID of the canvas to render\n   * @param width The width of the canvas in pixels\n   * @param height The height of the canvas in pixels\n   * @param images The images to render on the canvas\n   * @param annotations The annotations to render on the canvas\n   * @param ocrText The OCR text to render on the canvas\n   * @param ppi The resolution of the canvas in pixels per inch, used to determine the physical\n   *            size of the PDF page. Assumes 300ppi by default.\n   */\n  async renderPage(\n    canvasId: string,\n    {\n      width: canvasWidth,\n      height: canvasHeight,\n    }: { width: number; height: number },\n    images: (CanvasImage | ImageFetchFailure)[],\n    annotations: Annotation[],\n    ocrText?: OcrPageWithMarkup,\n    ppi = 300\n  ): Promise<void> {\n    if (!this._pagesStarted) {\n      log.debug('Initial page, finalizing PDF header structures.');\n      await this.finalizePdfHeader();\n      this._pagesStarted = true;\n    }\n\n    // Factor to multiply pixels by to get equivalent PDF units (72 pdf units === 1 inch)\n    const unitScale = 72 / ppi;\n    const pageDict: PdfDictionary = {\n      Type: '/Page',\n      Parent: this._objRefs.Pages,\n      MediaBox: [0, 0, unitScale * canvasWidth, unitScale * canvasHeight],\n      Resources: {\n        ProcSet: ['/PDF', '/Text', '/ImageB', '/ImageI', '/ImageC'],\n      },\n    };\n\n    if (this._hasText) {\n      pageDict.StructParents = this._nextStructParentId;\n      this._pageParentIds.set(this._nextObjNo, this._nextStructParentId);\n      this._nextStructParentId++;\n    }\n\n    if (ocrText && this._objRefs.Type0Font) {\n      (pageDict.Resources as PdfDictionary).Font = {\n        'f-0-0': this._objRefs.Type0Font,\n      };\n    }\n    const page = this._addObject(pageDict);\n\n    // Draw images onto the page\n    const contentOps: string[] = [];\n    const optionalGroupIds: { [imgId: string]: string } = {};\n    for (const [idx, image] of images.entries()) {\n      if (isImageFetchFailure(image)) {\n        continue;\n      }\n      const { x, y, width, height, choiceInfo } = image;\n      const drawWidth = unitScale * width;\n      const drawHeight = unitScale * height;\n      const drawX = unitScale * x;\n      const drawY = unitScale * (canvasHeight - height - y);\n      const imageId = `/Im${idx + 1}`;\n\n      if (choiceInfo?.optional) {\n        const ocId = `/oc${Object.keys(optionalGroupIds).length + 1}`;\n        optionalGroupIds[imageId] = ocId;\n        contentOps.push(`/OC ${ocId} BDC`);\n      }\n      contentOps.push(`q ${drawWidth} 0 0 ${drawHeight} ${drawX} ${drawY} cm`);\n      contentOps.push(`${imageId} Do`);\n      contentOps.push('Q');\n      if (choiceInfo?.optional) {\n        contentOps.push('EMC');\n      }\n    }\n\n    if (ocrText) {\n      contentOps.push(this._renderOcrText(ocrText, unitScale));\n    }\n\n    log.debug('Trying to compress content stream.');\n    const contentStreamComp = await tryDeflateStream(contentOps.join('\\n'));\n    const contentsObj = this._addObject(\n      contentStreamComp.dict,\n      undefined,\n      contentStreamComp.stream\n    );\n    (page.data as PdfDictionary).Contents = makeRef(contentsObj);\n\n    // Register all resources for the page\n    const pageResources = (page.data as PdfDictionary)\n      .Resources as PdfDictionary;\n    const xObjects: PdfDictionary = {};\n    const properties: PdfDictionary = {};\n    for (const [idx, img] of images.entries()) {\n      if (isImageFetchFailure(img)) {\n        continue;\n      }\n      const imageId = `/Im${idx + 1}`;\n      xObjects[imageId.substring(1)] = this._makeDeferredReference(imageId);\n      if (img.choiceInfo?.optional) {\n        const ocgId = optionalGroupIds[imageId];\n        properties[ocgId.substring(1)] = this._makeDeferredReference(ocgId);\n      }\n    }\n    pageResources.XObject = xObjects;\n    if (Object.keys(properties).length > 0) {\n      pageResources.Properties = properties;\n    }\n\n    log.debug('Creating image objects.');\n    const canvasIdx = this._canvasInfos.findIndex(\n      (ci) => ci.canvas.id === canvasId\n    );\n    for (const [imgIdx, img] of images.entries()) {\n      if (isImageFetchFailure(img)) {\n        // Dummy image data object\n        this._addObject({});\n        if (this._polyglot) {\n          // Dummy dummy zip header object\n          this._addObject({});\n        }\n        continue;\n      }\n      const imageData = new Uint8Array(img.data!);\n      const image = PdfImage.open(imageData);\n\n      const imageObjs = image.toObjects(\n        // Account for local zip header object if polyglot Zip-PDF is enabled\n        this._polyglot ? this._nextObjNo + 1 : this._nextObjNo\n      );\n\n      if (img.format !== 'jpeg' && image instanceof JPEGImage) {\n        // We calculated with 3 objects for this image, since it was either identified\n        // as PNG or we did not have a format in the manifest. So we need to add empty\n        // dummy objects to keep the object numbers in sync.\n        let objNum = imageObjs.slice(-1)[0].num;\n        for (let i = 0; imageObjs.length < 3; i++) {\n          imageObjs.push({ num: objNum++ });\n        }\n      }\n\n      // Resolve deferred references to this image\n      const mainImageObj = imageObjs[0];\n      const imageId = `/Im${imgIdx + 1}`;\n      this._deferredReferences.get(imageId)!.refObj = mainImageObj.num;\n\n      if (this._polyglot) {\n        if (image instanceof JPEGImage) {\n          const imgPreambleSize = this._getSerializedSize(mainImageObj, true);\n          const filename = `img/canvas-${canvasIdx}-${imgIdx}.jpg`;\n          this._insertZipHeaderDummyObject({\n            filename,\n            data: imageData,\n            bytesUntilActualData: imgPreambleSize,\n          });\n        } else {\n          // Polyglot PDF is not possible for PNG images, since PNGs are not stored\n          // as-is in the PDF, but can be split and stored across multiple objects\n          // To keep our pre-calculated object numbers valid, we need to insert an\n          // empty dummy object in place of the local zip header\n          this._addObject({});\n        }\n      }\n      imageObjs.forEach((obj) => this._objects.push(obj));\n      this._nextObjNo = imageObjs.slice(-1)[0].num + 1;\n    }\n\n    if (images.some((i) => i?.choiceInfo?.optional)) {\n      log.debug('Creating optional content groups for page');\n      for (const [idx, img] of images.entries()) {\n        const imageId = `/Im${idx + 1}`;\n        if (!img?.choiceInfo) {\n          continue;\n        }\n        if (isImageFetchFailure(img)) {\n          // Dummy object to maintain precalculated object numbers\n          this._addObject({});\n          continue;\n        }\n        this._deferredReferences.get(optionalGroupIds[imageId])!.refObj =\n          this._nextObjNo;\n        this._addObject({\n          Type: '/OCG',\n          Name: img.choiceInfo.label\n            ? `(${getI18nValue(img.choiceInfo.label, this._langPref, '/')})`\n            : undefined,\n          Intent: '/View',\n          Usage: img.choiceInfo.visibleByDefault ? '/ON' : '/OFF',\n        } as PdfDictionary);\n      }\n    }\n\n    const canvasInfo = this._canvasInfos[canvasIdx];\n\n    // Embed OCR text, if present\n    if (ocrText?.markup) {\n      const canvasIdx = this._canvasInfos.findIndex(\n        (ci) => ci.canvas.id === canvasId\n      );\n      let filename = `ocr/canvas-${canvasIdx}`;\n      if (ocrText.mimeType.indexOf('html') >= 0) {\n        filename += '.html';\n      } else {\n        filename += '.xml';\n      }\n\n      await this._embedResource(\n        filename,\n        `OCR for canvas #${canvasIdx}`,\n        ocrText.mimeType,\n        ocrText.markup\n      );\n    } else if (canvasInfo.ocr) {\n      // Canvas Info says we have OCR, but none was passed, possible\n      // when the OCR doesn't have CORS or fetching failed for another reason\n      // Add two empty objects so object references are still valid\n      this._addObject({});\n      this._addObject({});\n      // Add one more if we have a polyglot PDF/ZIP\n      if (this._polyglot) {\n        this._addObject({});\n      }\n    }\n\n    // Add annotations, if present\n    if (annotations && annotations.length > 0) {\n      log.debug('Creating annotations for page');\n      pageDict.Annots = annotations\n        .flatMap((anno) => exportPdfAnnotation(anno, unitScale, canvasHeight))\n        .map((pdfAnno) => makeRef(this._addObject(pdfAnno)));\n    }\n\n    // Write out all of the objects\n    log.debug('Flushing data for page');\n    await this._flush();\n    log.debug('Finished rendering page');\n  }\n\n  /** Get PDF instructions to render a hidden text layer with the page's OCR.\n   *\n   * This owes *a lot* to Tesseract's PDF renderer[1] and the IA's `pdf-tools`[2]\n   * that ported it to Python. Accordingly, the license of this method is Apache 2.0.\n   *\n   * [1] https://github.com/tesseract-ocr/tesseract/blob/5.0.0-beta-20210916/src/api/pdfrenderer.cpp\n   * [2] https://github.com/internetarchive/archive-pdf-tools/blob/master/internetarchivepdf/pdfrenderer.py\n   *\n   *                            Apache License\n   *                     Version 2.0, January 2004\n   *                  http://www.apache.org/licenses/\n   */\n  _renderOcrText(ocr: OcrPageWithMarkup, unitScale: number): string {\n    // TODO: Handle changes in writing direction!\n    // TODO: Handle baselines, at least the simple ``cx+d` skewed-line-type, proper polyline support\n    //       requires a per-character transformation matrix, which is a bit much for the current\n    //       MVP-ish state\n    const pageHeight = ocr.height;\n    const ops: Array<string> = [];\n    ops.push('BT'); // Begin text rendering\n    ops.push('3 Tr'); // Use \"invisible ink\" (no fill, no stroke)\n    const pageObjNum = this._nextObjNo - 1;\n    let lineIdx = 0;\n    const entries: StructTreeEntry[] = [];\n    const handleChild = (\n      child: OcrPage | OcrBlock | OcrParagraph | OcrLine,\n      parent?: StructTreeEntry\n    ) => {\n      if (child.type === 'block') {\n        entries.push({\n          type: 'Sect',\n          children: [],\n          pageObjNum,\n          mcs: [],\n        });\n      } else if (child.type === 'paragraph') {\n        entries.push({\n          type: 'P',\n          children: [],\n          pageObjNum,\n          mcs: [],\n        });\n        if (parent) {\n          parent.children.push(entries.slice(-1)[0]);\n        }\n      } else if (child.type === 'line') {\n        ops.push(\n          ...this.renderOcrLine(\n            child,\n            lineIdx,\n            unitScale,\n            pageHeight,\n            pageObjNum\n          )\n        );\n        if (parent) {\n          parent.children.push({\n            type: 'Span',\n            children: [],\n            pageObjNum,\n            mcs: [lineIdx],\n          });\n        }\n        lineIdx++;\n        return;\n      }\n      for (const grandchild of child.children) {\n        handleChild(grandchild, entries.slice(-1)[0]);\n      }\n    };\n    handleChild(ocr);\n    this._strucTree.push(...entries);\n    ops.push('ET');\n    return ops.join('\\n');\n  }\n\n  /** Get PDF instructions to render a single line of OCR text. */\n  renderOcrLine(\n    line: OcrLine,\n    lineIdx: number,\n    unitScale: number,\n    pageHeight: number,\n    pageObjNum: number\n  ): string[] {\n    const fontRef = '/f-0-0';\n    const scaleX = 1;\n    const scaleY = 1;\n    const shearX = 0;\n    const shearY = 0;\n    const ops: Array<string> = [];\n    // Begin of marked content sequence that wraps the line in a Span\n    ops.push(`/Span << /MCID ${lineIdx} >> BDC`);\n    // Approximated font size for western scripts, PDF font size is specified in multiples of\n    // 'user units', which default to 1/72inch. The `userScale` gives us the units per pixel.\n    const fontSize = line.height * unitScale * 0.75;\n    //const fontSize = 8; // TODO: This is what Tesseract uses, why does this work?\n    ops.push(`${fontRef} ${fontSize} Tf`);\n    // We use a text matrix for every line. Tesseract uses a per-paragraph matrix, but we don't\n    // neccesarily have block/paragraph information available, so we'll use the next-closest\n    // thing. This means that every word on the line is positioned relative to the line, not\n    // relative to the page as in the markup.\n    const xPos = line.x * unitScale;\n    const lineY = pageHeight - line.y - line.height * 0.75;\n    const yPos = lineY * unitScale;\n    ops.push(`${scaleX} ${shearX} ${shearY} ${scaleY} ${xPos} ${yPos} Tm`);\n    let xOld = 0;\n    let yOld = 0;\n    // TODO: What to do if non-word line content?\n    for (const word of line.words) {\n      if (!word.text) {\n        continue;\n      }\n      if (!word.width) {\n        continue;\n      }\n      // Position drawing with relative moveto\n      const wordX = (word.x - line.x) * unitScale;\n      // Convert beween different y-origins in OCR and PDF\n      const wordYAbsolute = pageHeight - word.y - word.height * 0.75;\n      const wordY = (wordYAbsolute - lineY) * unitScale;\n      const wordWidth = word.width * unitScale;\n      const wordHeight = word.height * unitScale;\n      const dx = wordX - xOld;\n      const dy = wordY - yOld;\n      ops.push(`${dx * scaleX + dy * shearX} ${dx * shearY + dy * scaleY} Td`);\n      xOld = wordX;\n      yOld = wordY;\n      // Calculate horizontal stretch\n      // TODO: This is ripped straight from Tesseract, I have no clue what it does\n      // FIXME: The end of the line seems to be too far to the left sometimes,\n      // while the start seems to match\n      const wordLength = Math.pow(\n        Math.pow(wordWidth, 2) + Math.pow(wordHeight, 2),\n        0.5\n      );\n      const pdfWordLen = word.text.length;\n      ops.push(\n        `${CHAR_WIDTH * ((100 * wordLength) / (fontSize * pdfWordLen))} Tz`\n      );\n      // TODO: Account for trailing space in width calculation to prevent readers\n      //       from inserting a line break\n      const textBytes = serialize(toUTF16BE(word.text + ' ', false));\n      ops.push(`[ ${textBytes} ] TJ`);\n    }\n    ops.push('EMC');\n    // Add a newline to visually group together all statements belonging to a line\n    ops.push('');\n    if (!this._pageMCIds.has(pageObjNum)) {\n      this._pageMCIds.set(pageObjNum, []);\n    }\n    this._pageMCIds.get(pageObjNum)!.push(lineIdx);\n    return ops;\n  }\n\n  /** How many bytes have we written to the output so far? */\n  get bytesWritten(): number {\n    return this._offset;\n  }\n\n  /** Number of objects needed to render all canvases */\n  get totalCanvasObjects(): number {\n    // Every canvas needs 1 object per image, 1 for the content stream and 1 for the page definition.\n    return this._canvasInfos.reduce(\n      (sum, _, idx) => sum + this.getCanvasObjectNumber(idx),\n      0\n    );\n  }\n\n  /** How many objects are needed to render the canvas at the given index? */\n  getObjectsPerCanvas(canvasIdx: number): number {\n    const { images, ocr, numAnnotations } = this._canvasInfos[canvasIdx];\n    let numObjects =\n      // 1 XObject for JPEGs, 3 for PNGs or unknown formats\n      // The minority of PNGs actually need three XObjects, but we can't know\n      // that in advance and so we simply add empty dummy objects if we need less.\n      images\n        .map((img) => (img.format === 'jpeg' ? 1 : 3))\n        .reduce((a, b) => a + b, 0) +\n      // Page dictionary and content\n      2 +\n      // 1 Optional Content Group per optional image\n      images.filter((i) => i.choiceInfo !== undefined).length +\n      // 1 XObject per annotation\n      numAnnotations;\n    if (this._polyglot) {\n      // For a polyglot PDF, we need to precede every XObject that we'd like\n      // to expose as a file in the ZIP with a separate XObject that contains\n      // the local ZIP header for that file. Currently this concerns the\n      // images and the OCR data\n      // PNG images can't be embedded in the polyglot ZIP, so we simply add an\n      // empty object for each PNG image in place of the zip header object.\n      numObjects = numObjects + images.length + (ocr ? 1 : 0);\n    }\n    if (ocr) {\n      numObjects += 2;\n    }\n    return numObjects;\n  }\n\n  /** Get the object number for the canvas at the given index. */\n  getCanvasObjectNumber(canvasIdx: number): number {\n    let num = this._firstPageObjectNum!;\n    for (const [idx] of this._canvasInfos.entries()) {\n      if (idx === canvasIdx) {\n        return num;\n      }\n      num += this.getObjectsPerCanvas(idx);\n    }\n    throw new Error(`Canvas #${canvasIdx} not found.`);\n  }\n\n  /** Flush remaining data to output. */\n  async _flush(): Promise<void> {\n    if (this._offsets.length === 0) {\n      log.debug('Writing PDF header');\n      await this._write(`%PDF-1.5\\n%\\xde\\xad\\xbe\\xef\\n`);\n    }\n    for (const obj of this._objects) {\n      if (!obj) {\n        continue;\n      }\n      log.debug(`Serializing object #${obj.num}`);\n      await this._serializeObject(obj);\n    }\n    this._objects = [];\n  }\n\n  /** Get the serialized size in bytes of a PDF object. */\n  _getSerializedSize(\n    { num, data, stream }: PdfObject,\n    untilStreamStart = false\n  ): number {\n    let size = 0;\n    size += `${num} 0 obj\\n`.length;\n\n    if (data) {\n      size += serialize(data).length;\n    }\n    if (stream) {\n      size += '\\nstream\\n'.length;\n      if (untilStreamStart) {\n        return size;\n      }\n      if (typeof stream === 'string') {\n        size += textEncoder.encode(stream).byteLength;\n      } else {\n        size += stream.byteLength;\n      }\n      size += '\\nendstream'.length;\n    }\n    size += '\\nendobj\\n'.length;\n    return size;\n  }\n\n  /** Serialize a PDF object to the output. */\n  async _serializeObject(obj: PdfObject): Promise<void> {\n    this._offsets.push(this._offset);\n    const { num, data, stream } = obj;\n    await this._write(`${num} 0 obj\\n`);\n    if (data) {\n      await this._write(serialize(data));\n    }\n    if (stream) {\n      await this._write('\\nstream\\n');\n      await this._write(stream);\n      await this._write('\\nendstream');\n    }\n    await this._write('\\nendobj\\n');\n  }\n\n  /** Write data to the output. */\n  async _write(data: Uint8Array | string): Promise<void> {\n    if (this._writer === undefined) {\n      throw new Error(\n        'Cannot perform mutating operations on an already closed PDFGenerator.'\n      );\n    }\n    if (typeof data === 'string') {\n      data = textEncoder.encode(data);\n    }\n    this._offset += data.byteLength;\n    await this._writer.write(data);\n  }\n\n  /** Write the PDF objects required for the structure tree */\n  async _writeStructureTree(): Promise<void> {\n    const parentRoot: PdfDictionary = {\n      Nums: [],\n    };\n    const parentRootRef = makeRef(this._addObject(parentRoot));\n    const root: PdfDictionary = {\n      Type: '/StructTreeRoot',\n      K: [],\n      ParentTree: parentRootRef,\n      ParentTreeNextKey: this._nextStructParentId,\n    };\n    const pageParents: Map<number, Array<PdfRef>> = new Map();\n    const rootRef = makeRef(this._addObject(root));\n    const visitEntry = async (\n      entry: StructTreeEntry,\n      parent: PdfDictionary,\n      parentRef: PdfRef\n    ): Promise<void> => {\n      const obj: PdfDictionary = {\n        Type: '/StructElem',\n        S: `/${entry.type}`,\n        P: parentRef,\n        Pg: makeRef(entry.pageObjNum),\n        K: [],\n      };\n      if (!pageParents.has(entry.pageObjNum)) {\n        pageParents.set(entry.pageObjNum, []);\n      }\n      const objRef = makeRef(this._addObject(obj));\n      (parent.K as PdfRef[]).push(objRef);\n      if (entry.children.length > 0) {\n        for (const i of entry.children) {\n          await visitEntry(i, obj, objRef);\n        }\n      } else if (entry.mcs.length == 1) {\n        obj.K = entry.mcs[0];\n      } else if (entry.mcs.length > 0) {\n        obj.K = entry.mcs;\n      }\n      if (entry.mcs.length > 0) {\n        const parents = pageParents.get(entry.pageObjNum)!;\n        for (const mcId of entry.mcs) {\n          parents[mcId] = objRef;\n        }\n      }\n      if (this._objects.length > 1000) {\n        await this._flush();\n      }\n    };\n    for (const i of this._strucTree) {\n      await visitEntry(i, root, rootRef);\n    }\n    for (const [pageObjNum, parents] of pageParents) {\n      const pidx = this._pageParentIds.get(pageObjNum)!;\n      (parentRoot.Nums as PdfArray).push(\n        pidx,\n        makeRef(this._addObject(parents))\n      );\n    }\n    await this._flush();\n  }\n\n  /** Finish writing the PDF and close the writer.\n   *\n   * Writes XRef table, trailer and EOF marker to the output.\n   * Also adds ZIP central directory if polyglot PDF is enabled.\n   */\n  async end(): Promise<void> {\n    if (!this._writer) {\n      return;\n    }\n    /* FIXME: Disabled due to poor performance on large volumes and a strange\n     *        interaction with streamsaver, where the PDF would be prematurely\n     *        closed in the middle of writing out the structure tree.\n    log.debug(\"Writing structure tree\");\n    if (this._strucTree.length > 0) {\n      await this._writeStructureTree();\n    }\n    */\n    log.debug('Writing xref table');\n    type XrefEntry = [number, number, 'f' | 'n'];\n    const xrefEntries: Array<XrefEntry> = [\n      [0, 65535, 'f'],\n      ...this._offsets.map((offset): XrefEntry => [offset, 0, 'n']),\n    ];\n    const xRefTable = xrefEntries\n      .map(([off, gen, free]) =>\n        [\n          off.toString(10).padStart(10, '0'),\n          gen.toString(10).padStart(5, '0'),\n          free,\n          '',\n        ].join(' ')\n      )\n      .join('\\n');\n    const xrefOffset = this._offset;\n    await this._write(`xref\\n0 ${xrefEntries.length}\\n${xRefTable}\\n`);\n    const trailerDict: PdfDictionary = {\n      Size: xrefEntries.length,\n      Root: this._objRefs.Catalog,\n      Info: this._objRefs.Info,\n      ID: [randomData(32), randomData(32)],\n    };\n    await this._write(`\\ntrailer\\n${serialize(trailerDict)}`);\n    const trailer = `startxref\\n${xrefOffset}\\n%%EOF`;\n    if (this._polyglot && this._zipCatalog) {\n      log.debug('Writing zip end of central directory');\n      await this._write('9990 0 obj\\n<<>>\\nstream\\n');\n      const endObj = '\\nendstream\\nendobj\\n';\n      await this._write(\n        buildCentralFileDirectory({\n          files: this._zipCatalog,\n          trailingLength: trailer.length + endObj.length,\n          offset: this._offset,\n        })\n      );\n      await this._write(endObj);\n    }\n    await this._flush();\n    log.debug('Writing trailer');\n    await this._write(trailer);\n    log.debug('Flushing');\n    await this._flush();\n    // FIXME: Never resolves on Node.js, is it really\n    // needed in browsers?\n    //log.debug('Waiting for drainage');\n    //await this._writer.waitForDrain();\n    log.debug('PDF finished, closing writer');\n    await this._writer.close();\n    log.debug('Writer closed');\n    this._writer = undefined;\n  }\n\n  /** Insert a 'dummy' PDF object that isn't referenced anywhere, but which\n   *  contains the data neccessary to expose the following object's data as a\n   *  file in the ZIP archive.\n   */\n  private _insertZipHeaderDummyObject({\n    filename,\n    data,\n    deflatedData,\n    bytesUntilActualData,\n  }: ZipDummyObjectSpec): void {\n    if (this._zipBaseDir) {\n      filename = `${this._zipBaseDir}/${filename}`;\n    }\n    const zipObjOffset =\n      this._offset +\n      this._objects.reduce((acc, obj) => acc + this._getSerializedSize(obj), 0);\n    const creationDate = new Date();\n    bytesUntilActualData += '\\nendstream\\nendobj\\n'.length;\n    const zipObj = this._addObject(\n      {},\n      undefined,\n      buildLocalZipHeader({\n        filename,\n        data,\n        compressedData: deflatedData,\n        extraDataLength: bytesUntilActualData,\n        creationDate,\n      })\n    );\n    const localHeaderOffset =\n      zipObjOffset + this._getSerializedSize(zipObj, true);\n    if (!this._zipCatalog) {\n      this._zipCatalog = [];\n    }\n    this._zipCatalog.push({\n      localHeaderOffset,\n      deflated: deflatedData?.length !== data.length,\n      creationDate: new Date(),\n      crc32: crc32(data),\n      dataLength: data.length,\n      // skip 2 bytes for zlib header\n      compressedDataLength: deflatedData\n        ? deflatedData.length - 2\n        : data.length,\n      filename,\n    });\n  }\n}\n","export interface LicenseDescription {\n  text: string;\n  logo: string;\n}\nexport type LicenseList = Record<string, LicenseDescription>;\n\n// TODO: Re-generate this list based on the official CC RDF files:\n//  https://github.com/creativecommons/cc-licenses-data/blob/main/legacy/rdf-licenses\nexport const licenses: LicenseList = {\n  'http://creativecommons.org/licenses/by-nc-sa/2.0/fr/': {\n    text: 'Creative Commons Attribution-NonCommercial-ShareAlike 2.0 France (CC-BY-NC-SA-2.0-FR)',\n    logo: 'https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nc-sa.svg',\n  },\n  'http://creativecommons.org/licenses/by-sa/4.0/': {\n    text: 'Creative Commons Attribution Share Alike 4.0 International (CC-BY-SA-4.0)',\n    logo: 'https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-sa.svg',\n  },\n  'http://creativecommons.org/licenses/by/3.0/de/': {\n    text: 'Creative Commons Attribution 3.0 Germany (CC-BY-3.0-DE)',\n    logo: 'https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by.svg',\n  },\n  'http://creativecommons.org/licenses/by-nc-nd/3.0/': {\n    text: 'Creative Commons Attribution Non Commercial No Derivatives 3.0 Unported (CC-BY-NC-ND-3.0)',\n    logo: 'https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nc-nd.svg',\n  },\n  'http://creativecommons.org/licenses/by/1.0/': {\n    text: 'Creative Commons Attribution 1.0 Generic (CC-BY-1.0)',\n    logo: 'https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by.svg',\n  },\n  'http://creativecommons.org/licenses/by-nd/1.0/': {\n    text: 'Creative Commons Attribution No Derivatives 1.0 Generic (CC-BY-ND-1.0)',\n    logo: 'https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nd.svg',\n  },\n  'http://creativecommons.org/licenses/by-nc-sa/3.0/de/': {\n    text: 'Creative Commons Attribution Non Commercial Share Alike 3.0 Germany (CC-BY-NC-SA-3.0-DE)',\n    logo: 'https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nc-sa.svg',\n  },\n  'http://creativecommons.org/licenses/by-nc-sa/1.0/': {\n    text: 'Creative Commons Attribution Non Commercial Share Alike 1.0 Generic (CC-BY-NC-SA-1.0)',\n    logo: 'https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nc-sa.svg',\n  },\n  'http://creativecommons.org/licenses/by-nd/4.0/': {\n    text: 'Creative Commons Attribution No Derivatives 4.0 International (CC-BY-ND-4.0)',\n    logo: 'https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nd.svg',\n  },\n  'http://creativecommons.org/licenses/by-sa/3.0/at/': {\n    text: 'Creative Commons Attribution Share Alike 3.0 Austria (CC-BY-SA-3.0-AT)',\n    logo: 'https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-sa.svg',\n  },\n  'http://creativecommons.org/licenses/by/3.0/at/': {\n    text: 'Creative Commons Attribution 3.0 Austria (CC-BY-3.0-AT)',\n    logo: 'https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by.svg',\n  },\n  'http://creativecommons.org/licenses/by/3.0/': {\n    text: 'Creative Commons Attribution 3.0 Unported (CC-BY-3.0)',\n    logo: 'https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by.svg',\n  },\n  'http://creativecommons.org/licenses/by-nc/2.0/': {\n    text: 'Creative Commons Attribution Non Commercial 2.0 Generic (CC-BY-NC-2.0)',\n    logo: 'https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nc.svg',\n  },\n  'http://creativecommons.org/licenses/by-nc-sa/2.5/': {\n    text: 'Creative Commons Attribution Non Commercial Share Alike 2.5 Generic (CC-BY-NC-SA-2.5)',\n    logo: 'https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nc-sa.svg',\n  },\n  'http://creativecommons.org/licenses/by-nc/2.5/': {\n    text: 'Creative Commons Attribution Non Commercial 2.5 Generic (CC-BY-NC-2.5)',\n    logo: 'https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nc.svg',\n  },\n  'http://creativecommons.org/licenses/by-nd-nc/1.0/': {\n    text: 'Creative Commons Attribution Non Commercial No Derivatives 1.0 Generic (CC-BY-NC-ND-1.0)',\n    logo: 'https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nc-nd.svg',\n  },\n  'http://creativecommons.org/licenses/by-nd/3.0/': {\n    text: 'Creative Commons Attribution No Derivatives 3.0 Unported (CC-BY-ND-3.0)',\n    logo: 'https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nd.svg',\n  },\n  'http://creativecommons.org/licenses/by-sa/2.5/': {\n    text: 'Creative Commons Attribution Share Alike 2.5 Generic (CC-BY-SA-2.5)',\n    logo: 'https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-sa.svg',\n  },\n  'http://creativecommons.org/licenses/by-nc-sa/2.0/uk/': {\n    text: 'Creative Commons Attribution Non Commercial Share Alike 2.0 England and Wales (CC-BY-NC-SA-2.0-UK)',\n    logo: 'https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nc-sa.svg',\n  },\n  'http://creativecommons.org/licenses/by/2.0/': {\n    text: 'Creative Commons Attribution 2.0 Generic (CC-BY-2.0)',\n    logo: 'https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by.svg',\n  },\n  'http://creativecommons.org/licenses/by-nd/2.5/': {\n    text: 'Creative Commons Attribution No Derivatives 2.5 Generic (CC-BY-ND-2.5)',\n    logo: 'https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nd.svg',\n  },\n  'http://creativecommons.org/licenses/by-nc-nd/2.0/': {\n    text: 'Creative Commons Attribution Non Commercial No Derivatives 2.0 Generic (CC-BY-NC-ND-2.0)',\n    logo: 'https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nc-nd.svg',\n  },\n  'http://creativecommons.org/licenses/by-nc-sa/3.0/igo/': {\n    text: 'Creative Commons Attribution Non Commercial Share Alike 3.0 IGO (CC-BY-NC-SA-3.0-IGO)',\n    logo: 'https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nc-sa.svg',\n  },\n  'http://creativecommons.org/licenses/publicdomain//': {\n    text: 'Creative Commons Public Domain Dedication and Certification (CC-PDDC)',\n    logo: 'https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/publicdomain.svg',\n  },\n  'http://creativecommons.org/licenses/by-nc-sa/2.0/': {\n    text: 'Creative Commons Attribution Non Commercial Share Alike 2.0 Generic (CC-BY-NC-SA-2.0)',\n    logo: 'https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nc-sa.svg',\n  },\n  'http://creativecommons.org/licenses/by-nc-nd/3.0/de/': {\n    text: 'Creative Commons Attribution Non Commercial No Derivatives 3.0 Germany (CC-BY-NC-ND-3.0-DE)',\n    logo: 'https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nc-nd.svg',\n  },\n  'http://creativecommons.org/licenses/by-nc/3.0/': {\n    text: 'Creative Commons Attribution Non Commercial 3.0 Unported (CC-BY-NC-3.0)',\n    logo: 'https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nc.svg',\n  },\n  'http://creativecommons.org/licenses/by-nc/3.0/de/': {\n    text: 'Creative Commons Attribution Non Commercial 3.0 Germany (CC-BY-NC-3.0-DE)',\n    logo: 'https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nc.svg',\n  },\n  'http://creativecommons.org/licenses/by-sa/1.0/': {\n    text: 'Creative Commons Attribution Share Alike 1.0 Generic (CC-BY-SA-1.0)',\n    logo: 'https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-sa.svg',\n  },\n  'http://creativecommons.org/licenses/by-nd/3.0/de/': {\n    text: 'Creative Commons Attribution No Derivatives 3.0 Germany (CC-BY-ND-3.0-DE)',\n    logo: 'https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nd.svg',\n  },\n  'http://creativecommons.org/licenses/by-nc-nd/2.5/': {\n    text: 'Creative Commons Attribution Non Commercial No Derivatives 2.5 Generic (CC-BY-NC-ND-2.5)',\n    logo: 'https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nc-nd.svg',\n  },\n  'http://creativecommons.org/licenses/by-sa/3.0/': {\n    text: 'Creative Commons Attribution Share Alike 3.0 Unported (CC-BY-SA-3.0)',\n    logo: 'https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-sa.svg',\n  },\n  'http://creativecommons.org/licenses/by-nc-sa/4.0/': {\n    text: 'Creative Commons Attribution Non Commercial Share Alike 4.0 International (CC-BY-NC-SA-4.0)',\n    logo: 'https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nc-sa.svg',\n  },\n  'http://creativecommons.org/licenses/by-sa/2.0/': {\n    text: 'Creative Commons Attribution Share Alike 2.0 Generic (CC-BY-SA-2.0)',\n    logo: 'https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-sa.svg',\n  },\n  'http://creativecommons.org/licenses/by-sa/2.1/jp/': {\n    text: 'Creative Commons Attribution Share Alike 2.1 Japan (CC-BY-SA-2.1-JP)',\n    logo: 'https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-sa.svg',\n  },\n  'http://creativecommons.org/licenses/by/2.5/': {\n    text: 'Creative Commons Attribution 2.5 Generic (CC-BY-2.5)',\n    logo: 'https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by.svg',\n  },\n  'http://creativecommons.org/licenses/by-sa/2.0/uk/': {\n    text: 'Creative Commons Attribution Share Alike 2.0 England and Wales (CC-BY-SA-2.0-UK)',\n    logo: 'https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-sa.svg',\n  },\n  'http://creativecommons.org/licenses/by/3.0/nl/': {\n    text: 'Creative Commons Attribution 3.0 Netherlands (CC-BY-3.0-NL)',\n    logo: 'https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by.svg',\n  },\n  'http://creativecommons.org/licenses/by-nc-sa/3.0/': {\n    text: 'Creative Commons Attribution Non Commercial Share Alike 3.0 Unported (CC-BY-NC-SA-3.0)',\n    logo: 'https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nc-sa.svg',\n  },\n  'http://creativecommons.org/licenses/by/4.0/': {\n    text: 'Creative Commons Attribution 4.0 International (CC-BY-4.0)',\n    logo: 'https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by.svg',\n  },\n  'http://creativecommons.org/licenses/by/3.0/us/': {\n    text: 'Creative Commons Attribution 3.0 United States (CC-BY-3.0-US)',\n    logo: 'https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by.svg',\n  },\n  'http://creativecommons.org/licenses/by-nc-nd/4.0/': {\n    text: 'Creative Commons Attribution Non Commercial No Derivatives 4.0 International (CC-BY-NC-ND-4.0)',\n    logo: 'https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nc-nd.svg',\n  },\n  'http://creativecommons.org/licenses/by-sa/3.0/de/': {\n    text: 'Creative Commons Attribution Share Alike 3.0 Germany (CC-BY-SA-3.0-DE)',\n    logo: 'https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-sa.svg',\n  },\n  'http://creativecommons.org/licenses/by-nc-nd/3.0/igo/': {\n    text: 'Creative Commons Attribution Non Commercial No Derivatives 3.0 IGO (CC-BY-NC-ND-3.0-IGO)',\n    logo: 'https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nc-nd.svg',\n  },\n  'http://creativecommons.org/publicdomain/zero/1.0/': {\n    text: 'Creative Commons Zero v1.0 Universal (CC0-1.0)',\n    logo: 'https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/cc-zero.svg',\n  },\n  'http://creativecommons.org/publicdomain/mark/1.0/': {\n    text: 'Public Domain Mark 1.0: No Copyright',\n    logo: 'https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/publicdomain.svg',\n  },\n  'http://creativecommons.org/licenses/by/2.5/au/': {\n    text: 'Creative Commons Attribution 2.5 Australia (CC-BY-2.5-AU)',\n    logo: 'https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by.svg',\n  },\n  'http://creativecommons.org/licenses/by-nd/2.0/': {\n    text: 'Creative Commons Attribution No Derivatives 2.0 Generic (CC-BY-ND-2.0)',\n    logo: 'https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nd.svg',\n  },\n  'http://creativecommons.org/licenses/by-nc/1.0/': {\n    text: 'Creative Commons Attribution Non Commercial 1.0 Generic (CC-BY-NC-1.0)',\n    logo: 'https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nc.svg',\n  },\n  'http://creativecommons.org/licenses/by-nc/4.0/': {\n    text: 'Creative Commons Attribution Non Commercial 4.0 International (CC-BY-NC-4.0)',\n    logo: 'https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nc.svg',\n  },\n  'http://rightsstatements.org/vocab/InC/1.0/': {\n    text: 'In Copyright',\n    logo: 'https://rightsstatements.org/files/buttons/InC.dark.svg',\n  },\n  'http://rightsstatements.org/vocab/InC-OW-EU/1.0/': {\n    text: 'In Copyright - EU Orphan Work',\n    logo: 'https://rightsstatements.org/files/buttons/InC-OW-EU.dark.svg',\n  },\n  'http://rightsstatements.org/vocab/InC-EDU/1.0/': {\n    text: 'In Copyright - Educational Use Permitted',\n    logo: 'https://rightsstatements.org/files/buttons/InC-EDU.dark.svg',\n  },\n  'http://rightsstatements.org/vocab/InC-NC/1.0/': {\n    text: 'In Copyright - Non-Commercial Use Permitted',\n    logo: 'https://rightsstatements.org/files/buttons/InC-NC.dark.svg',\n  },\n  'http://rightsstatements.org/vocab/InC-RUU/1.0/': {\n    text: 'In Copyright - Rights-holder(s) Unlocatable or Unidentifiable',\n    logo: 'https://rightsstatements.org/files/buttons/InC-RUU.dark.svg',\n  },\n  'http://rightsstatements.org/vocab/NoC-CR/1.0/': {\n    text: 'No Copyright - Contractual Restrictions',\n    logo: 'https://rightsstatements.org/files/buttons/NoC-CR.dark.svg',\n  },\n  'http://rightsstatements.org/vocab/NoC-NC/1.0/': {\n    text: 'No Copyright - Non-Commercial Use Only',\n    logo: 'https://rightsstatements.org/files/buttons/NoC-NC.dark.svg',\n  },\n  'http://rightsstatements.org/vocab/NoC-OKLR/1.0/': {\n    text: 'No Copyright - Other Known Legal Restrictions',\n    logo: 'https://rightsstatements.org/files/buttons/NoC-OKLR.dark.svg',\n  },\n  'http://rightsstatements.org/vocab/NoC-US/1.0/': {\n    text: 'No Copyright - United States',\n    logo: 'https://rightsstatements.org/files/buttons/NoC-US.dark.svg',\n  },\n  'http://rightsstatements.org/vocab/CNE/1.0/': {\n    text: 'Copyright Not Evaluated',\n    logo: 'https://rightsstatements.org/files/buttons/CNE.dark.svg',\n  },\n  'http://rightsstatements.org/vocab/UND/1.0/': {\n    text: 'Copyright Undetermined',\n    logo: 'https://rightsstatements.org/files/buttons/UND.dark.svg',\n  },\n  'http://rightsstatements.org/vocab/NKC/1.0/': {\n    text: 'No Known Copyright',\n    logo: 'https://rightsstatements.org/files/buttons/NKC.dark.svg',\n  },\n};\n\nexport function getLicenseInfo(uri: string): LicenseDescription | null {\n  uri = uri.replace(/^https:/, 'http:').replace(/\\/deed\\.[a-z]{2}$/, '');\n  if (!uri.endsWith('/')) {\n    uri += '/';\n  }\n  return licenses[uri];\n}\n","import type { EncodeOptions } from '@jsquash/jpeg/meta';\nimport { randomUUIDv4 } from './util';\nimport OptimizationWorker from './optimization.worker.ts?worker';\nimport log from './log';\n\nexport type InitializationRequest = {\n  mozjpegWasm: Uint8Array;\n};\n\nexport type TaskDescription<I> = {\n  id: string;\n  data: I;\n};\n\nexport type WorkerMessage<I, O> = { input: { id: string; data: I }; result: O };\nexport type WorkerTask<I, O> = {\n  resolve: (value: O) => void;\n  reject: (reason: any) => void;\n  task: TaskDescription<I>;\n};\n\nexport type MozJPEGParams = {\n  method: 'mozjpeg';\n  quality: number;\n} & Partial<EncodeOptions>;\n\nexport type BrowserEncoderParams = {\n  method: 'browser';\n  quality: number;\n};\n\nexport type OptimizationParams = MozJPEGParams | BrowserEncoderParams;\n\nexport type OptimizationRequest = {\n  imageData: Uint8Array;\n  imageFormat: 'image/jpeg' | 'image/png';\n} & OptimizationParams;\n\nexport type OptimizedImage = {\n  jpegData: Uint8Array;\n  sizeFactor: number;\n};\n\nexport class OptimizationError extends Error {\n  constructor(message: string, public taskId: string, public cause?: unknown) {\n    super(message);\n  }\n}\n\nexport const MOZJPEG_DEFAULT_PARAMS: EncodeOptions = {\n  quality: 75,\n  progressive: true,\n  optimize_coding: true,\n  smoothing: 0,\n  color_space: 3, // YCbCr\n  quant_table: 3,\n  trellis_multipass: false,\n  trellis_opt_table: true,\n  trellis_opt_zero: true,\n  trellis_loops: 0,\n  auto_subsample: false,\n  chroma_subsample: 2,\n  separate_chroma_quality: false,\n  chroma_quality: 75,\n  arithmetic: false,\n  baseline: false,\n};\n\nclass WorkerPool<I, O> {\n  private workers: Worker[] = [];\n  private queue: WorkerTask<I, O>[] = [];\n  private pendingTasks: Map<string, WorkerTask<I, O>> = new Map();\n  private busyWorkers: Set<Worker> = new Set();\n\n  constructor(public size: number) {}\n\n  start(): void {\n    for (let i = 0; i < this.size; i++) {\n      const worker = new OptimizationWorker();\n      worker.onmessage = this.handleMessage.bind(this, worker);\n      worker.onerror = this.handleError.bind(this, worker);\n      this.workers.push(worker);\n    }\n  }\n\n  stop(): void {\n    this.workers.forEach((worker) => worker.terminate());\n    this.workers = [];\n    this.queue = [];\n    this.busyWorkers.clear();\n  }\n\n  dispatch(data: I): Promise<O> {\n    return new Promise((resolve, reject) => {\n      this.queue.push({\n        resolve,\n        reject,\n        task: {\n          id: randomUUIDv4(),\n          data,\n        },\n      });\n      this.processQueue();\n    });\n  }\n\n  private processQueue(): void {\n    if (this.queue.length === 0) return;\n    const availableWorker = this.workers.find((w) => !this.busyWorkers.has(w));\n    if (!availableWorker) return;\n\n    const job = this.queue.shift()!;\n    this.pendingTasks.set(job.task.id, job);\n    this.busyWorkers.add(availableWorker);\n    availableWorker.postMessage(job.task);\n  }\n\n  private handleMessage(\n    worker: Worker,\n    event: MessageEvent<WorkerMessage<I, O>>\n  ): void {\n    log.debug(`worker: received message`, event.data);\n    const job = this.pendingTasks.get(event.data.input.id);\n    if (job) {\n      job.resolve(event.data.result);\n      log.debug(`worker: resolved job`, job.task.id);\n      this.pendingTasks.delete(job.task.id);\n      this.busyWorkers.delete(worker);\n      this.processQueue();\n    } else {\n      log.warn(\n        `worker: unknown job, known jobs: ${[...this.pendingTasks.keys()].join(\n          ', '\n        )}`,\n        event.data.input.id\n      );\n    }\n  }\n\n  private handleError(worker: Worker, evt: ErrorEvent): void {\n    const optimError = evt.error as OptimizationError;\n    const job = this.queue.find((j) => j.task.id === optimError.taskId);\n    if (job) {\n      job.reject(optimError.cause);\n      this.busyWorkers.delete(worker);\n      this.processQueue();\n    }\n  }\n}\n\nlet pool: WorkerPool<\n  OptimizationParams | InitializationRequest,\n  OptimizedImage | undefined\n> | null = null;\nlet isInitialized = false;\n\nexport function startWorkerPool(size = navigator.hardwareConcurrency): void {\n  if (pool !== null) {\n    return;\n  }\n  pool = new WorkerPool(size);\n  pool.start();\n}\n\nexport function stopWorkerPool(): void {\n  if (pool === null) {\n    return;\n  }\n  pool.stop();\n  pool = null;\n}\n\nexport async function initialize(wasmLoader: () => Promise<Uint8Array>): Promise<void> {\n  if (pool === null) {\n    startWorkerPool();\n  }\n\n  if (isInitialized) {\n    return;\n  }\n\n  const mozjpegWasm = await wasmLoader();\n  let promises: Promise<undefined>[] = [];\n  for (let i = 0; i < pool!.size; i++) {\n    promises.push(pool!.dispatch({ mozjpegWasm }) as Promise<undefined>);\n  }\n  log.debug('main: mozjpegWasm sent to workers');\n  await Promise.all(promises);\n  log.debug('main: workers initialized with MozJPEG encoder');\n  isInitialized = true;\n}\n\nexport async function optimizeImage(\n  params: OptimizationRequest\n): Promise<OptimizedImage> {\n  if (pool === null) {\n    startWorkerPool();\n  }\n\n  return pool!.dispatch(params) as Promise<OptimizedImage>;\n}\n","/// <reference types=\"wicg-file-system-access\"/>\nimport type { Writable } from 'stream';\nimport {\n  Manifest,\n  RangeItems,\n  Reference,\n  IIIFExternalWebResource,\n  ContentResource,\n  Service,\n  ImageService,\n  Annotation as IIIF3Annotation,\n} from '@iiif/presentation-3';\nimport {\n  ManifestNormalized,\n  CanvasNormalized,\n  RangeNormalized,\n  AnnotationNormalized,\n  ResourceProviderNormalized,\n  NormalizedRangeItemSchemas,\n} from '@iiif/presentation-3-normalized';\nimport Presentation2 from '@iiif/presentation-2';\nimport { upgrade as convertPresentation2 } from '@iiif/parser/upgrader';\nimport PQueue from 'p-queue';\nimport events from 'events';\nimport * as ocrParser from 'ocr-parser';\n\nimport PDFGenerator from './pdf/generator.js';\nimport {\n  CountingWriter,\n  WebWriter,\n  NodeWriter,\n  Writer,\n  BlobWriter,\n} from './io.js';\nimport { TocItem } from './pdf/util.js';\nimport { getLicenseInfo } from './res/licenses.js';\nimport { getOcrReferences } from './ocr.js';\nimport pdiiifVersion from './version.js';\nimport {\n  fetchCanvasData,\n  fetchRespectfully,\n  CanvasData,\n  fetchStartCanvasInfo,\n  StartCanvasInfo,\n  fetchManifestJson,\n} from './download.js';\nimport metrics from './metrics.js';\nimport { initializeSaxParser, isDefined, now, saxParserWasm } from './util.js';\nimport log from './log.js';\nimport {\n  getI18nValue,\n  getThumbnail,\n  getCanvasInfo,\n  vault,\n  parseAnnotation,\n  Annotation,\n} from './iiif.js';\nimport {\n  initialize,\n  OptimizationParams,\n  optimizeImage,\n} from './optimization.js';\n\n/** Progress information for rendering a progress bar or similar UI elements. */\nexport interface ProgressStatus {\n  /** Message code that should be mapped to a human readable description in a UI. */\n  messageCode?: ProgressMessageCode;\n  /** Expected total number of pages in the PDF */\n  totalPages: number;\n  /** Number of pages that were submitted for writing */\n  pagesWritten: number;\n  /** Number of bytes that were submitted for writing to the output stream */\n  bytesPushed: number;\n  /** Number of bytes that were written to the output stream so far */\n  bytesWritten: number;\n  /** Predicted size of the final file in bytes */\n  estimatedFileSize?: number;\n  /** Write speed in bytes per second */\n  writeSpeed: number;\n  /** Estimated time in seconds until PDF has finished generating */\n  remainingDuration: number;\n}\n\n/** Parameters for rendering a cover page, parsed from IIIF manifest. */\nexport interface CoverPageParams {\n  title: string;\n  manifestUrl: string;\n  thumbnail?: {\n    url: string;\n    iiifImageService?: string;\n  };\n  provider?: {\n    label: string;\n    homepage?: string;\n    logo?: string;\n  };\n  requiredStatement?: {\n    label: string;\n    value: string;\n  };\n  rights?: {\n    text: string;\n    url?: string;\n    logo?: string;\n  };\n  metadata?: Array<[string, string | Array<string>]>;\n  pdiiifVersion: string;\n}\n\n/** Options for converting a IIIF Manifest to a PDF. */\nexport interface ConvertOptions {\n  /** Callback to provide annotations for a given canvas identifier.\n   * Should return either a `sc:AnnotationList` (IIIF2) or an `AnnotationPage` (IIIF3).\n   */\n  fetchCanvasAnnotations?: (\n    canvasId: string\n  ) => Promise<Array<IIIF3Annotation> | Array<Presentation2.Annotation>>;\n  /** Pixels per inch to assume for the full resolution version of each canvas.\n      If not set, the conversion will use an available IIIF Physical Dimensions\n      service to calculate the page dimensions instead. */\n  ppi?: number;\n  /** Set of canvas ids to include in PDF, or a predicate to filter canvas identifiers\n      by. By default, all canvases are included in the PDF. */\n  filterCanvases?: readonly string[] | ((canvasId: string) => boolean);\n  /** List of languages to use for metadata, page labels and table of contents, in\n      descending order of preference. Will use the environment's locale settings by\n      default. */\n  languagePreference?: readonly string[];\n  /** Restrict the image size to include in the PDF by downscaling by a fixed factor.\n   * The value must be a number between 0.1 and 1.\n   * Only works with Level 2 Image API services that allow arbitrary downscaling, the\n   * conversion will not perform downscaling itself.\n   * For Level 1 endpoints, the closest available lower width will be selected. */\n  scaleFactor?: number;\n  /** Number of maximum concurrent IIIF Image API requests to be performed, defaults to 1 */\n  concurrency?: number;\n  /** Callback that gets called whenever a page has finished, useful to render a\n      progress bar. */\n  onProgress?: (status: ProgressStatus) => void;\n  /** Callback that gets called with a notification when an error occurs during PDF generation\n   *  that does not cause the conversion to fail. */\n  onNotification?: (notification: ProgressNotification) => void;\n  /** Controller that allows aborting the PDF generation. All pending\n      downloads will be terminated. The caller is responsible for\n      removing underlying partial files and/or other user signaling. */\n  abortController?: AbortController;\n  /** Set PDF metadata, by default `Title` will be the manifest's label. */\n  metadata?: {\n    CreationDate?: Date;\n    Title?: string;\n    Author?: string;\n    Keywords?: string;\n  };\n  /** Endpoint to contact for retrieving PDF data with one or more cover pages\n      to insert before the canvas pages */\n  coverPageEndpoint?: string;\n  /** Callback to call for retrieving PDF data with one or more cover pages\n      to insert before the canvas pages */\n  coverPageCallback?: (params: CoverPageParams) => Promise<Uint8Array>;\n  /** Generate the PDF in a way that the resulting file is also a valid\n   *  ZIP file that contains the manifest, all of the images and, if present,\n   *  the OCR files referenced in the manifest. */\n  polyglotZipPdf?: boolean;\n  /** Base directory in the polyglot ZIP archive. If not set, all resource\n   * directories will be to-level in the archive. */\n  polyglotZipBaseDir?: string;\n  /** Custom loader callback that fetches the WASM binary for the `sax-wasm`\n   *  dependency (v2.2.4). By default, the dependency will be loaded from\n   *  `https://unpkg.com/sax-wasm/dist/sax-wasm.wasm`. Override if you want\n   *  to provide your own payload. Loader will not be called if {@link initialize}\n   *  from `ocr-parser` has been called before.\n   */\n  saxWasmLoader?: () => Promise<Uint8Array>;\n  /** Custom loader callback that fetches the WASM binary for the `@jsquash/jpeg`\n   * dependency (v1.5.0). By default the dependency will be loaded from\n   * `https://unpkg.com/@jsquash/jpeg@1.5.0/codec/enc/mozjpeg_enc.wasm`. Override\n   * if you want to provide your own payload. Loader will not be called if\n   * {@link optimization} is not set to use the `mozjpeg` method.\n   */\n  mozjpegWasmLoader?: () => Promise<Uint8Array>;\n  /** Parameters for optimizing the images for size by re-encoding them to JPEGs. */\n  optimization?: OptimizationParams;\n}\n\n/** Parameters for size estimation */\nexport interface EstimationParams {\n  /** The manifest to determine the PDF size for */\n  manifest: string | Manifest | Presentation2.Manifest;\n  /** Restrict the image size to include in the PDF by downscaling by a fixed factor.\n   * The value must be a number between 0.1 and 1.\n   * Only works with Level 2 Image API services that allow arbitrary downscaling, the\n   * conversion will not perform downscaling itself.\n   * For Level 1 endpoints, the closest available lower width will be selected. */\n  scaleFactor?: number;\n  /** Set of canvas ids to include in PDF, or a predicate to filter canvas identifiers\n      by. By default, all canvases are included in the PDF. */\n  filterCanvases?: readonly string[] | ((canvasId: string) => boolean);\n  /** Number of canvses to sample for estimation, defaults to 8 */\n  numSamples?: number;\n  /** Number of maximum concurrent IIIF Image API requests to be performed, defaults to 1 */\n  concurrency?: number;\n  /** Parameters for optimizing the images for size by re-encoding them to JPEGs. */\n  optimization?: OptimizationParams;\n  /** Custom loader callback that fetches the WASM binary for the `sax-wasm`\n   *  dependency (v2.2.4). By default, the dependency will be loaded from\n   *  `https://unpkg.com/sax-wasm/dist/sax-wasm.wasm`. Override if you want\n   *  to provide your own payload. Loader will not be called if {@link initialize}\n   *  from `ocr-parser` has been called before.\n   */\n  saxWasmLoader?: () => Promise<Uint8Array>;\n  /** Custom loader callback that fetches the WASM binary for the `@jsquash/jpeg`\n   * dependency (v1.5.0). By default the dependency will be loaded from\n   * `https://unpkg.com/@jsquash/jpeg@1.5.0/codec/enc/mozjpeg_enc.wasm`. Override\n   * if you want to provide your own payload. Loader will not be called if\n   * {@link optimization} is not set to use the `mozjpeg` method.\n   */\n  mozjpegWasmLoader?: () => Promise<Uint8Array>;\n  /** Pre-sampled list of canvases to use for estimating the size */\n  sampleCanvases?: CanvasNormalized[];\n}\n\nexport type Estimation = {\n  /** Estimated size of the PDF in bytes */\n  size: number;\n  /** If CORS is enabled for all of the images referenced in the sample canvases */\n  corsSupported: boolean;\n  /** Image data for a sample image, present when optimization is enabled. */\n  sampleImageData?: Uint8Array;\n  /** Image MIME type for a sample image, present when optimization is enabled. */\n  sampleImageMimeType?: string;\n  /** How large is the PDF after the image optimization, compared to the unoptimized images?  */\n  optimizationResult?: number;\n  /** Canvases that were used for estimating */\n  sampleCanvases: CanvasNormalized[];\n};\n\nfunction getCanvasesForSampling(\n  canvases: CanvasNormalized[],\n  numSamples: number\n): CanvasNormalized[] {\n  if (canvases.length <= numSamples) {\n    return canvases;\n  }\n  const meanPixels =\n    canvases.reduce((x, { width, height }) => x + width * height, 0) /\n    canvases.length;\n  const candidateCanvases = canvases.filter(\n    (c) => Math.abs(meanPixels - c.width * c.height) <= 0.25 * meanPixels\n  );\n  if (candidateCanvases.length <= numSamples) {\n    return candidateCanvases;\n  }\n  const sampleCanvases: CanvasNormalized[] = [];\n  while (sampleCanvases.length < numSamples) {\n    const candidate =\n      candidateCanvases[Math.floor(Math.random() * candidateCanvases.length)];\n    if (sampleCanvases.indexOf(candidate) < 0) {\n      sampleCanvases.push(candidate);\n    }\n  }\n  return sampleCanvases.sort(\n    (a, b) => canvases.indexOf(a) - canvases.indexOf(b)\n  );\n}\n\n/** Estimate the final size of the PDF for a given manifest.\n *\n * This will randomly sample a few representative canvases from the manifest,\n * check their size in bytes and extrapolate from that to all canvases.\n *\n * @throws {Error} if the manifest cannot be loaded\n */\nexport async function estimatePdfSize({\n  manifest: inputManifest,\n  concurrency = 1,\n  scaleFactor,\n  filterCanvases = () => true,\n  numSamples = 8,\n  optimization,\n  saxWasmLoader = async () =>\n    fetch(\n      `https://unpkg.com/sax-wasm@${ocrParser.SAX_WASM_VERSION}/lib/sax-wasm.wasm`\n    )\n      .then((res) => res.arrayBuffer())\n      .then((buf) => new Uint8Array(buf)),\n  mozjpegWasmLoader = async () =>\n    fetch('https://unpkg.com/@jsquash/jpeg@1.5.0/codec/enc/mozjpeg_enc.wasm')\n      .then((res) => res.arrayBuffer())\n      .then((buf) => new Uint8Array(buf)),\n  sampleCanvases\n}: EstimationParams): Promise<Estimation> {\n  let manifestId;\n  if (typeof inputManifest === 'string') {\n    manifestId = inputManifest;\n  } else {\n    manifestId =\n      (inputManifest as Manifest).id ??\n      (inputManifest as Presentation2.Manifest)['@id'];\n  }\n  const manifestJson = await fetchManifestJson(manifestId);\n  const manifest = await vault.loadManifest(manifestId, manifestJson);\n  if (!manifest) {\n    throw new Error(`Failed to load manifest from ${manifestId}`);\n  }\n  let canvasPredicate: (canvasId: string) => boolean;\n  if (Array.isArray(filterCanvases)) {\n    canvasPredicate = (canvasId) => filterCanvases.indexOf(canvasId) >= 0;\n  } else {\n    canvasPredicate = filterCanvases as (id: string) => boolean;\n  }\n\n  const canvases = vault.get<CanvasNormalized>(\n    manifest.items.filter(c => canvasPredicate(c.id)).map(c => c.id));\n\n  // Select some representative canvases that are close to the mean in terms\n  // of their pixel area to avoid small images distorting the estimate too much\n  const totalCanvasPixels = canvases.reduce(\n    (sum, canvas) => sum + canvas.width * canvas.height,\n    0\n  );\n  if (!sampleCanvases?.length) {\n    sampleCanvases = getCanvasesForSampling(canvases, numSamples);\n  }\n  const samplePixels = sampleCanvases.reduce(\n    (sum, canvas) => sum + canvas.width * canvas.height,\n    0\n  );\n\n  // Initialize XML parsers\n  if (!saxParserWasm || !ocrParser.isInitialized()) {\n    if (!saxParserWasm) {\n      const wasm = await saxWasmLoader();\n      initializeSaxParser(wasm);\n    }\n    if (!ocrParser.isInitialized()) {\n      await ocrParser.initialize(() => Promise.resolve(saxParserWasm!));\n      ocrParser.setupLogging({\n        debug: log.debug.bind(log),\n        info: log.info.bind(log),\n        warn: log.warn.bind(log),\n        error: log.error.bind(log),\n      });\n    }\n  }\n\n  const queue = new PQueue({ concurrency });\n  const canvasData = await Promise.all(\n    sampleCanvases.map((c) =>\n      queue.add(async () => {\n        const info = getCanvasInfo(c);\n        return fetchCanvasData(c, info.images, {\n          scaleFactor,\n          sizeOnly: optimization === undefined,\n        });\n      })\n    )\n  );\n\n  let optimizationResult: number | undefined;\n  if (optimization) {\n    if (optimization.method === 'mozjpeg') {\n      await initialize(mozjpegWasmLoader);\n    }\n    const images = canvasData\n      .filter((c): c is CanvasData => c !== undefined)\n      .flatMap((c) => c.images);\n    const originalSize = images.reduce(\n      (sum, img) => sum + img.data!.byteLength,\n      0\n    );\n    await Promise.all(\n      images.map(async (img) => {\n        const optimized = await optimizeImage({\n          imageData: new Uint8Array(img.data!),\n          imageFormat:\n            (img.format as 'jpeg' | 'png') === 'jpeg'\n              ? 'image/jpeg'\n              : 'image/png',\n          ...optimization,\n        });\n        img.data = optimized.jpegData.buffer;\n        img.format = 'jpeg';\n      })\n    );\n    const optimizedSize = images.reduce(\n      (sum, img) => sum + img.data!.byteLength,\n      0\n    );\n    optimizationResult = optimizedSize / originalSize;\n  }\n\n  const corsSupported = canvasData\n    .filter(isDefined<CanvasData>)\n    .flatMap((c) => c.images)\n    .every((i) => i.corsAvailable);\n  const sampleBytes = canvasData\n    .filter(isDefined<CanvasData>)\n    .flatMap((c) => c.images)\n    .reduce(\n      (size: number, img) => size + (img?.data?.byteLength ?? img.numBytes),\n      0\n    );\n  const sampleImages = canvasData\n    .filter(isDefined<CanvasData>)\n    .flatMap((c) => c.images);\n  const sampleImage = sampleImages[0];\n  const bpp = sampleBytes / samplePixels;\n  return {\n    size: bpp * totalCanvasPixels,\n    corsSupported,\n    sampleImageData: sampleImage.data\n      ? new Uint8Array(sampleImage.data)\n      : undefined,\n    sampleImageMimeType: sampleImage.format,\n    sampleCanvases,\n    optimizationResult\n  };\n}\n\nasync function buildOutlineFromRanges(\n  manifest: ManifestNormalized,\n  canvases: CanvasNormalized[],\n  languagePreference: string[]\n): Promise<Array<TocItem>> {\n  // ToC generation: IIIF's `Range` construct is so open, doing anything useful with it is a pain :-/\n  // In our case, the pain comes from multiple directions:\n  // - PDFs can only connect an outline node to a *single* page (IIIF connects ranges of pages)\n  // - IIIF doesn't prescribe an order for the ranges or the canvases contained in them\n  // Our approach is to pre-generate the range associated with each canvas and a hierarchy\n  // of parent-child relationships for ranges.\n\n  // All canvas identifiers in the order they appear as in the sequence\n  // Note that this is a *filtered* list of canvases, i.e. if the user only selected a subset of the\n  // canvases for PDF generation, not every Range in the manifest will have all of its canvases in here\n  const canvasIds = canvases.map((canvas) => canvas.id);\n\n  // We have to recurse, this small closure handles each node in the tree\n  const isCanvas = (ri: RangeItems | NormalizedRangeItemSchemas): ri is Reference<'Canvas'> =>\n    typeof ri !== 'string' && ri.type === 'Canvas';\n  const isRange = (ri: RangeItems | NormalizedRangeItemSchemas): ri is Reference<'Range'> =>\n    typeof ri !== 'string' && ri.type == 'Range';\n\n  const seenRanges: Set<string> = new Set();\n  const handleTocRange = async (\n    range: RangeNormalized\n  ): Promise<TocItem | undefined> => {\n    if (seenRanges.has(range.id)) {\n      return;\n    }\n    // Double filtering with `isCanvas` is necessary because of TS limitations\n    const firstCanvas = range.items\n      .filter(isCanvas)\n      .filter((c) => canvasIds.indexOf(c.id!) >= 0)\n      .filter(isCanvas)\n      .sort((a, b) =>\n        canvasIds.indexOf(a.id!) > canvasIds.indexOf(b.id!) ? -1 : 1\n      )[0];\n    const rangeLabel = getI18nValue(\n      range.label ?? '<untitled>',\n      languagePreference,\n      '; '\n    );\n    const childRanges = vault.get<RangeNormalized>(range.items.filter(isRange));\n    const children = (\n      await Promise.all(childRanges.map(handleTocRange))\n    ).filter(isDefined<TocItem>);\n\n    let startCanvas: StartCanvasInfo | undefined;\n    if (range.start) {\n      startCanvas = await fetchStartCanvasInfo(range);\n    }\n    seenRanges.add(range.id);\n    if (children.length === 0 && !firstCanvas) {\n      // Range with no canvases and no child ranges, ignore\n      // This usually happens when the user filtered the canvases to be included in the\n      // PDF and the range and its children only contains canvases that were filtered out\n      return;\n    } else if (!startCanvas && firstCanvas) {\n      startCanvas = firstCanvas.id;\n    } else if (!startCanvas) {\n      startCanvas = children[0].startCanvas;\n    }\n    return {\n      label: rangeLabel,\n      startCanvas: startCanvas!,\n      children,\n    };\n  };\n\n  let tocRanges = vault.get<RangeNormalized>(manifest.structures);\n  const topRange = tocRanges.find(\n    (r) => (r.behavior as string[]).indexOf('top') >= 0\n  );\n  // If there's a 'top' range, only use that as the single top-level ToC node\n  if (topRange) {\n    tocRanges = [topRange];\n  }\n\n  return (\n    (await Promise.all(tocRanges.map(handleTocRange))).filter(\n      isDefined<TocItem>\n    ) ?? []\n  );\n}\n\nexport type ProgressMessageCode =\n  | 'generate-cover-page'\n  | 'generate-pages'\n  | 'finishing';\n\nexport type ProgressNotification =\n  | ImageDownloadFailureNotification\n  | OcrDownloadFailureNotification;\n\nexport type ImageDownloadFailureNotification = {\n  code: 'image-download-failure';\n  canvasIndex: number;\n  numFailed: number;\n  numTotal: number;\n  details: {\n    [imageUrl: string]: string;\n  };\n};\nexport type OcrDownloadFailureNotification = {\n  code: 'ocr-download-failure';\n  canvasIndex: number;\n  ocrUrl: string;\n};\n\n/** Tracks PDF generation progress and various statistics related to that. */\nclass ProgressTracker {\n  canvasPixels = 0;\n  pixelsWritten = 0;\n  pixelBytesFactor = 0;\n  pixelScaleFactor = 0;\n  timeStart: number | undefined;\n\n  pdfGen: PDFGenerator;\n  totalPages: number;\n  totalCanvasPixels = 0;\n  countingStream: CountingWriter;\n  onProgress?: (status: ProgressStatus) => void;\n  onNotification?: (notification: ProgressNotification) => void;\n\n  constructor(\n    canvases: CanvasNormalized[],\n    countingStream: CountingWriter,\n    pdfGen: PDFGenerator,\n    onProgress?: (status: ProgressStatus) => void,\n    onNotification?: (notification: ProgressNotification) => void\n  ) {\n    this.totalCanvasPixels = canvases.reduce(\n      (sum, canvas) => sum + canvas.width * canvas.height,\n      0\n    );\n    this.totalPages = canvases.length;\n    this.pdfGen = pdfGen;\n    this.countingStream = countingStream;\n    this.onProgress = onProgress;\n    this.onNotification = onNotification;\n  }\n\n  /** Check if there is still data that needs to be written out. */\n  get writeOutstanding(): boolean {\n    return this.pdfGen.bytesWritten > this.countingStream.bytesWritten;\n  }\n\n  /** Emit a progress update, with an optional message. */\n  emitProgress(pagesWritten: number, messageCode?: ProgressMessageCode): void {\n    if (!this.timeStart) {\n      this.timeStart = now();\n    }\n    const bytesPushed = this.pdfGen.bytesWritten;\n    let estimatedFileSize;\n    if (pagesWritten === this.totalPages) {\n      estimatedFileSize = bytesPushed;\n    } else if (pagesWritten > 0) {\n      estimatedFileSize = Math.floor(\n        this.pixelBytesFactor * this.pixelScaleFactor * this.totalCanvasPixels\n      );\n    }\n    const bytesWritten = this.countingStream.bytesWritten;\n    const writeSpeed = bytesPushed / ((now() - this.timeStart) / 1000);\n    let remainingDuration = Number.POSITIVE_INFINITY;\n    if (estimatedFileSize) {\n      remainingDuration = (estimatedFileSize - bytesWritten) / writeSpeed;\n    }\n    this.onProgress?.({\n      messageCode,\n      pagesWritten,\n      totalPages: this.totalPages,\n      bytesWritten,\n      bytesPushed,\n      estimatedFileSize,\n      writeSpeed,\n      remainingDuration,\n    });\n  }\n\n  /** Emit a notification message to inform the user about unexpected stuff that\n   * happens during PDF generation */\n  emitNotification(notification: ProgressNotification) {\n    this.onNotification?.(notification);\n  }\n\n  /** Update how many actual pixels and 'canvas pixels' have been written. */\n  updatePixels(pixelsWritten: number, canvasPixels: number) {\n    this.pixelsWritten += pixelsWritten;\n    this.canvasPixels += canvasPixels;\n    this.pixelScaleFactor = this.pixelsWritten / this.canvasPixels;\n    this.pixelBytesFactor = this.pdfGen.bytesWritten / this.pixelsWritten;\n  }\n}\n\n/** Generate a cover page PDF, either via user-provided callback, or by fetching\n * it from a remote endpoint. */\nasync function getCoverPagePdf(\n  manifest: ManifestNormalized,\n  languagePreference: Array<string>,\n  endpoint?: string,\n  callback?: (params: CoverPageParams) => Promise<Uint8Array>\n): Promise<Uint8Array> {\n  const params: CoverPageParams = {\n    // NOTE: Manifest label is mandatory, i.e. safe to assert non-null\n    // eslint-disable-next-line @typescript-eslint/no-non-null-assertion\n    title: getI18nValue(\n      manifest.label ?? '<untitled>',\n      languagePreference,\n      '; '\n    ),\n    manifestUrl: manifest.id,\n    pdiiifVersion,\n  };\n  const thumbUrl = await getThumbnail(manifest, 512);\n  if (thumbUrl) {\n    params.thumbnail = { url: thumbUrl };\n    const manifestThumb = vault.get<ContentResource>(manifest.thumbnail.map(t => t.id))[0];\n    if (manifestThumb && 'type' in manifestThumb) {\n      params.thumbnail.iiifImageService = (\n        manifestThumb as IIIFExternalWebResource\n      ).service?.find(\n        (s: Service): s is ImageService =>\n          (s as ImageService | undefined)?.type?.startsWith('ImageService') ??\n          false\n      )?.id;\n    }\n  }\n\n  const provider = vault.get<ResourceProviderNormalized>(manifest.provider)[0];\n  const required = manifest.requiredStatement;\n  if (provider) {\n    params.provider = {\n      label: getI18nValue(provider.label, languagePreference, '; '),\n      homepage: provider.homepage?.[0]?.id,\n      logo: provider.logo?.[0]?.id,\n    };\n    // FIXME: Currently this is assigned by @iiif/parser when converting from v2 to v3\n    if (params.provider.label === 'Unknown') {\n      params.provider.label = '';\n    }\n  }\n  if (required != null && required.label) {\n    params.requiredStatement = {\n      label: getI18nValue(required.label, languagePreference, '; '),\n      value: getI18nValue(required.value, languagePreference, '; '),\n    };\n  }\n  const license = manifest.rights;\n  if (license) {\n    const licenseDef = getLicenseInfo(license);\n    params.rights = {\n      text: licenseDef?.text ?? license,\n      url: license,\n      logo: licenseDef?.logo,\n    };\n  }\n  params.metadata =\n    manifest.metadata\n      ?.map((itm) => {\n        const label = getI18nValue(itm.label, languagePreference, '; ');\n        const values = getI18nValue(itm.value, languagePreference, '|||').split(\n          '|||'\n        );\n        if (!label || values.length === 0) {\n          return;\n        }\n        if (values.length === 1) {\n          return [label, values[0]];\n        } else {\n          return [label, values];\n        }\n      })\n      .filter((x): x is [string, string | string[]] => x !== undefined) ?? [];\n  if (callback) {\n    return await callback(params);\n  } else if (endpoint) {\n    const resp = await fetchRespectfully(endpoint, {\n      method: 'POST',\n      headers: { 'Content-Type': 'application/json; charset=utf-8' },\n      body: JSON.stringify(params),\n    });\n    const buf = await resp.arrayBuffer();\n    return new Uint8Array(buf);\n  } else {\n    throw 'Either `endpoint` or `callback` must be specified!';\n  }\n}\n\nexport type ConversionReport = {\n  fileSizeBytes: number;\n  numPages: number;\n  fileName?: string;\n  failedImages?: Array<{\n    canvasIndex: number;\n    numFailed: number;\n    numTotal: number;\n    details: {\n      [imageUrl: string]: string;\n    };\n  }>;\n  failedOcr?: Array<{\n    canvasIndex: number;\n    ocrUrl: string;\n  }>;\n};\n\nexport type ConversionReportWithData = ConversionReport & { data: Blob };\n\nexport async function convertManifest(\n  inputManifest: string | Manifest | Presentation2.Manifest,\n  outputStream: Writable | WritableStream,\n  options: ConvertOptions\n): Promise<ConversionReport>;\nexport async function convertManifest(\n  inputManifest: string | Manifest | Presentation2.Manifest,\n  outputStream: undefined,\n  options: ConvertOptions\n): Promise<ConversionReportWithData>;\n/** Convert a IIIF manifest to a PDF,  */\nexport async function convertManifest(\n  /* eslint-disable  @typescript-eslint/explicit-module-boundary-types */\n  inputManifest: string | Manifest | Presentation2.Manifest,\n  outputStream: Writable | WritableStream | undefined,\n  {\n    fetchCanvasAnnotations = () => Promise.resolve([]),\n    filterCanvases = () => true,\n    languagePreference = [Intl.DateTimeFormat().resolvedOptions().locale],\n    scaleFactor,\n    metadata = {},\n    onProgress,\n    onNotification,\n    ppi,\n    concurrency = 1,\n    abortController = new AbortController(),\n    coverPageCallback,\n    coverPageEndpoint,\n    polyglotZipPdf,\n    polyglotZipBaseDir,\n    optimization,\n    saxWasmLoader = async () =>\n      fetch(\n        `https://unpkg.com/sax-wasm@${ocrParser.SAX_WASM_VERSION}/lib/sax-wasm.wasm`\n      )\n        .then((res) => res.arrayBuffer())\n        .then((buf) => new Uint8Array(buf)),\n    mozjpegWasmLoader = async () =>\n      fetch('https://unpkg.com/@jsquash/jpeg@1.5.0/codec/enc/mozjpeg_enc.wasm')\n        .then((res) => res.arrayBuffer())\n        .then((buf) => new Uint8Array(buf)),\n  }: ConvertOptions\n): Promise<ConversionReport | ConversionReportWithData> {\n  // Prevent warning when running in Node.js\n  if (typeof process !== 'undefined') {\n    events.setMaxListeners(100, abortController.signal);\n  }\n  let writer: Writer;\n  if (!outputStream) {\n    log.debug('Writing to Blob');\n    writer = new BlobWriter();\n    // Can't use `instanceof` since we don't have the Node class in the\n    // browser and vice versa, so examine the shape of the object\n  } else if (typeof (outputStream as Writable).destroy === 'function') {\n    log.debug('Writing to Node writable stream');\n    writer = new NodeWriter(outputStream as Writable);\n    // Cancel further processing once the underlying stream has been closed\n    // This will only have an effect if the PDF has not finished generating\n    // yet (i.e. when the client terminates the connection prematurely),\n    // otherwise all processing will long have stopped\n    (outputStream as Writable).on('close', () => abortController.abort());\n  } else {\n    log.debug('Writing to file system');\n    writer = new WebWriter(outputStream as WritableStream);\n  }\n  const countingWriter = new CountingWriter(writer);\n  const report = {\n    fileSizeBytes: 0,\n    numPages: 0,\n  } as ConversionReport;\n\n  // Build a canvas predicate function from a list of identifiers, if needed\n  let canvasPredicate: (canvasId: string) => boolean;\n  if (Array.isArray(filterCanvases)) {\n    canvasPredicate = (canvasId) => filterCanvases.indexOf(canvasId) >= 0;\n  } else {\n    canvasPredicate = filterCanvases as (id: string) => boolean;\n  }\n\n  let manifestId: string;\n  let manifestJson: Manifest | Presentation2.Manifest;\n  if (typeof inputManifest === 'string') {\n    manifestId = inputManifest;\n    manifestJson = (await fetchManifestJson(manifestId)) as\n      | Manifest\n      | Presentation2.Manifest;\n  } else {\n    manifestId =\n      (inputManifest as Presentation2.Manifest)['@id'] ??\n      (inputManifest as Manifest).id;\n    manifestJson = inputManifest;\n  }\n  const manifest = await vault.loadManifest(manifestId, manifestJson);\n  if (!manifest) {\n    throw new Error(`Failed to load manifest from ${manifestId}`);\n  }\n\n  const pdfMetadata = { ...metadata };\n  if (!pdfMetadata.Title && manifest.label) {\n    pdfMetadata.Title = getI18nValue(\n      manifest.label,\n      languagePreference as string[],\n      '; '\n    );\n  }\n\n  const canvases = vault.get<CanvasNormalized>(\n    manifest.items.filter((c) => canvasPredicate(c.id))\n  );\n  const hasText = !!canvases.find((c) => !!getOcrReferences(c));\n  const labels = canvases.map((canvas) =>\n    canvas.label ? getI18nValue(canvas.label, languagePreference, '; ') : ''\n  );\n\n  // Initialize XML parsers\n  if (!saxParserWasm || !ocrParser.isInitialized()) {\n    if (!saxParserWasm) {\n      const wasm = await saxWasmLoader();\n      initializeSaxParser(wasm);\n    }\n    if (!ocrParser.isInitialized()) {\n      await ocrParser.initialize(() => Promise.resolve(saxParserWasm!));\n      ocrParser.setupLogging({\n        debug: log.debug.bind(log),\n        info: log.info.bind(log),\n        warn: log.warn.bind(log),\n        error: log.error.bind(log),\n      });\n    }\n  }\n\n  // Fetch images concurrently, within limits specified by user\n  log.debug(`Setting up queue with ${concurrency} concurrent canvas fetches.`);\n  const queue = new PQueue({ concurrency });\n  abortController.signal.addEventListener('abort', () => queue.clear(), {\n    once: true,\n  });\n  const canvasInfos = canvases.map(getCanvasInfo);\n  const canvasFuts = canvases.map((c, idx) => {\n    return queue.add(async () => {\n      const info = canvasInfos[idx];\n      const canvasData = await fetchCanvasData(c, info.images, {\n        scaleFactor,\n        ppiOverride: ppi,\n        abortSignal: abortController.signal,\n      });\n      // TODO: If downscaling was not possible due to lack of IIIF Image API support,\n      //       we should force an optimization pass with a lower resolution.\n      if (optimization) {\n        await Promise.all(\n          canvasData?.images.map(async (i) => {\n            const optimized = await optimizeImage({\n              imageData: new Uint8Array(i.data!),\n              imageFormat: i.format === 'jpeg' ? 'image/jpeg' : 'image/png',\n              ...optimization,\n            });\n            log.debug('main: Got optimized image', i.resource.id);\n            i.data = optimized.jpegData;\n            i.format = 'jpeg';\n          }) ?? []\n        );\n      }\n      return canvasData;\n    });\n  });\n\n  const outline = await buildOutlineFromRanges(\n    manifest,\n    canvases,\n    languagePreference as string[]\n  );\n  const pdfGen = new PDFGenerator({\n    writer: countingWriter,\n    metadata: pdfMetadata,\n    canvasInfos: canvases.map((c, idx) => ({\n      canvasIdx: idx,\n      ...canvasInfos[idx],\n    })),\n    langPref: languagePreference,\n    pageLabels: labels,\n    outline,\n    hasText,\n    initialCanvas: await fetchStartCanvasInfo(manifest),\n    readingDirection:\n      manifest.viewingDirection === 'right-to-left'\n        ? 'right-to-left'\n        : 'left-to-right',\n    manifestJson,\n    zipPolyglot: polyglotZipPdf,\n    zipBaseDir: polyglotZipBaseDir,\n  });\n  log.debug(`Initialising PDF generator.`);\n  await pdfGen.setup();\n  const progress = new ProgressTracker(\n    canvases,\n    countingWriter,\n    pdfGen,\n    onProgress,\n    onNotification\n  );\n  progress.emitProgress(0);\n\n  if (coverPageCallback || coverPageEndpoint) {\n    log.debug(`Generating cover page`);\n    progress.emitProgress(0, 'generate-cover-page');\n    try {\n      const coverPageData = await getCoverPagePdf(\n        manifest,\n        languagePreference as string[],\n        coverPageEndpoint,\n        coverPageCallback\n      );\n      log.debug('Inserting cover page into PDF');\n      await pdfGen.insertCoverPages(coverPageData);\n    } catch (err) {\n      log.error('Error while generating cover page', err);\n      abortController.abort();\n      throw err;\n    }\n  }\n\n  progress.emitProgress(0, 'generate-pages');\n  for (let canvasIdx = 0; canvasIdx < canvases.length; canvasIdx++) {\n    if (abortController.signal.aborted) {\n      log.debug('Abort signalled, aborting while waiting for image data.');\n      break;\n    }\n    try {\n      log.debug(`Waiting for data for canvas #${canvasIdx}`);\n      const canvasData = await canvasFuts[canvasIdx];\n      // This means the task was aborted, do nothing\n      // FIXME: Doesn't this also happen in case of an error?\n      if (!canvasData) {\n        throw 'Aborted';\n      }\n      const canvas = vault.get<CanvasNormalized>(canvasData.canvas);\n      const canvasInfo = canvasInfos[canvasIdx];\n      const { images, ppi, text, annotations, imageFailures } = canvasData;\n      if (imageFailures.length > 0) {\n        if (!report.failedImages) {\n          report.failedImages = [];\n        }\n        const reportData = {\n          canvasIndex: canvasIdx,\n          numFailed: imageFailures.length,\n          numTotal: images.length + imageFailures.length,\n          details: Object.fromEntries(\n            imageFailures.map((f) => [\n              f.resource.id ?? '<unknown>',\n              f.cause instanceof Error ? f.cause.toString() : f.cause,\n            ])\n          ),\n        };\n        report.failedImages.push(reportData);\n        progress.emitNotification({\n          code: 'image-download-failure',\n          ...reportData,\n        });\n      }\n      if (canvasInfo.ocr && !text?.markup) {\n        if (!report.failedOcr) {\n          report.failedOcr = [];\n        }\n        const reportData = {\n          canvasIndex: canvasIdx,\n          ocrUrl: canvasInfo.ocr.id,\n        };\n        report.failedOcr.push(reportData);\n        progress.emitNotification({\n          code: 'ocr-download-failure',\n          ...reportData,\n        });\n      }\n      const externalAnnotations = await fetchCanvasAnnotations(canvas.id);\n      if (externalAnnotations != null) {\n        const normalized = await Promise.all(\n          externalAnnotations.map((a) => {\n            if (!('id' in a)) {\n              a = convertPresentation2(a) as unknown as IIIF3Annotation;\n            }\n            return vault.load<AnnotationNormalized>(a.id, a);\n          })\n        );\n        if (normalized) {\n          normalized\n            .filter((a): a is AnnotationNormalized => a !== undefined)\n            .map((a) => parseAnnotation(a, languagePreference))\n            .filter((a): a is Annotation => a !== undefined)\n            .forEach((a) => annotations.push(a));\n        }\n      }\n      // eslint-disable-next-line @typescript-eslint/no-non-null-assertion\n      const stopMeasuring = metrics?.pageGenerationDuration.startTimer();\n      log.debug(`Rendering canvas #${canvasIdx} into PDF`);\n      await pdfGen.renderPage(\n        canvasData.canvas.id,\n        { width: canvas.width, height: canvas.height },\n        [...images, ...imageFailures],\n        annotations,\n        text,\n        ppi\n      );\n      stopMeasuring?.();\n      progress.updatePixels(\n        images.reduce((acc, img) => acc + img.width * img.height, 0),\n        canvas.width * canvas.height\n      );\n      report.numPages++;\n    } catch (err) {\n      // Clear queue, cancel all ongoing image fetching\n      if (err !== 'Aborted') {\n        log.error('Failed to render page', err);\n      }\n      queue.clear();\n      if (!abortController.signal.aborted) {\n        abortController.abort();\n      }\n      throw err;\n    } finally {\n      delete canvasFuts[canvasIdx];\n    }\n    progress.emitProgress(canvasIdx + 1);\n  }\n\n  // Finish writing PDF, resulting Promise is resolved once the writer is closed\n  log.debug('Finalizing PDF');\n  const endPromise = pdfGen.end();\n\n  // At this point the PDF data might still be incomplete, so we wait for\n  // drain events on the writer and continue updating our progress tracker\n  // until the writer is actually closed\n  if (!abortController.signal.aborted) {\n    let closed = false;\n    endPromise.then(() => (closed = true));\n    const progressOnDrain = async () => {\n      if (closed) {\n        return;\n      }\n      progress.emitProgress(canvases.length, 'finishing');\n      while (!closed && progress.writeOutstanding) {\n        await writer.waitForDrain();\n      }\n    };\n\n    // Wait for initial drainage event in case the writer isn't already closed\n    if (!closed) {\n      await writer.waitForDrain();\n      await progressOnDrain();\n    }\n  }\n\n  // Wait for the writer to be closed\n  log.debug('Waiting for writer to close.');\n  await endPromise;\n\n  report.fileSizeBytes = countingWriter.bytesWritten;\n  if (writer instanceof BlobWriter) {\n    return { ...report, data: writer.blob };\n  } else {\n    return report;\n  }\n}\n"],"names":["ConsoleLogger","level","__publicField","message","args","logger","setLogger","newLogger","E_CANCELED","__awaiter$2","thisArg","_arguments","P","generator","adopt","value","resolve","reject","fulfilled","step","e","rejected","result","Semaphore","_value","_cancelError","weight","callback","release","queue","entry","_a","queueEntry","previousValue","previousWeight","called","waiter","__awaiter$1","Mutex","cancelError","releaser","SaxEventType$1","Reader$1","data","ptr","Position$1","line","character","AttributeType","Reader","buffer","len","readU32","Text","name","type","readPosition","start","end","target","content","valueLen","readString","nameLen","numAttrs","attributes","i","attrLen","Attribute","numTextNodes","textNodes","textLen","openStart","openEnd","closeStart","closeEnd","selfClosing","SAXParser$1","events","options","event","uint8array","detail","SaxEventType","ProcInst","Tag","self","chunk","write","memory","saxWasm","parser","offset","length","SAXParser","uint8Array","Position","makeLine","spec","c","makeParagraph","l","out","idx","child","makeBlock","acc","makePage","SAX_WASM_VERSION","xmlParserWasm","initialize","loadSaxWasm","res","buf","isInitialized","getParser","readable","StaxParser","NUMERIC_ENTITY_REGEX","HEX_ENTITY_REGEX","ENTITY_MAP","ENTITY_REGEX","resolveXmlEntities","str","match","entity","entityCode","decimalCode","toReadableStream","encoder","controller","getAttributeValue","tag","attrName","attr","a","getAllAttributes","eventMask","wasm","reader","logWithPosition","msg","parseHocrAttribs","titleAttrib","x","val","key","parsePolygon","polyAttr","scaleFactor","last","y","handleChildren","eventIter","allowedTypes","ctx","openTags","evt","SaxEventType2","parentElem","txt","whitespaceOnly","hocrType","getHocrType","handleBlock","handleParagraph","handleLine","handleWord","handlePage","referenceSize","hocrAttribs","pageSize","determineScaleFactor","page","elem","w","ulx","uly","lrx","lry","dim","block","width","height","coords","paragraph","parsedAttribs","parts","slope","intercept","ulx2","uly2","word","wordText","wordChoices","tag2","t","nlp","choice","scaleFactorX","scaleFactorY","scaledWidth","scaledHeight","parseHocrPages","hocr","referenceSizes","sizeArr","_a2","pageIdx","NUMERIC_ATTRIBS","getAttributes","names","getCoordinates","attrs","handlePage2","dims","pageAttribs","SaxEventType3","handleBlock2","handleLine2","polygon","handleShape","handleWord2","points","p","lastElem","parent","text","wordConfidence","altText","handleSourceImageInformation","_tag","ident","location","parseAltoPages","alto","unit","saxParserWasm","now","isDefined","CRC_TABLE","k","crc32","runningInNode","initializeSaxParser","parserWasm","randomUUIDv4","metrics","prometheus","createStoreImpl","createState","state","listeners","setState","partial","replace","nextState","previousState","listener","getState","api","initialState","__vite_import_meta_env__","createStore","o","r","_","I","s","n","E","F","m","f","A","L","h","d","g","M","O","v","u","N","G","R","C","B","S","z","b","j","D","q","V","U","$","W","H","J","K","Q","X","Y","Z","ee","te","ne","ie","re","ae","se","oe","pe","fe","ce","le","he","ue","ve","de","T","ye","ge","me","Ce","Ae","Me","metaState","compatVault","nonRef","id","meta","oldValue","oldValueItem","newValue","resource","metaKey","resourceMeta","idToLoad","response","parseSpecificResource","createPaintingAnnotationsHelper","vault","getAllPaintingAnnotations","canvasOrId","canvas","annotationPages","flatAnnotations","getPaintables","paintingAnnotationsOrCanvas","enabledChoices","paintingAnnotations","types","choices","items","annotation","references","reference","ref","selector","body","nestedBodies","selected","cid","extractChoices","Fe","$e","Se","Re","Ke","Be","createAction","base","payload","IMPORT_ENTITIES","MODIFY_ENTITY_FIELD","REORDER_ENTITY_FIELD","ADD_REFERENCE","UPDATE_REFERENCE","REMOVE_REFERENCE","ADD_METADATA","REMOVE_METADATA","UPDATE_METADATA","REORDER_METADATA","importEntities","modifyEntityField","reorderEntityField","addReference","removeReference","updateReference","addMetadata","updateMetadata","removeMetadata","reorderMetadata","entityActions","ADD_MAPPING","ADD_MAPPINGS","addMapping","addMappings","RESOURCE_ERROR","RESOURCE_LOADING","RESOURCE_READY","REQUEST_RESOURCE","REQUEST_ERROR","REQUEST_MISMATCH","REQUEST_COMPLETE","REQUEST_OFFLINE_RESOURCE","requestResource","requestError","requestMismatch","requestComplete","BATCH_ACTIONS","BATCH_IMPORT","batchActions","actionListFromResource","entities","mapping","normalize","actions","safeIsNaN","isEqual","first","second","areInputsEqual","newInputs","lastInputs","resolveIfExists","url","request","resourceType","fullEntity","HAS_PART","framing","PART_OF","frameResource","isPromise","createFetchHelper","fetcher","waitTimeout","store","resolvedEntity","cleanupSubscription","didContinue","latestState","maybeResolvedEntity","importResource","toDispatch","resourceOrPromise","err","SET_META_VALUE","SET_META_VALUE_DYNAMIC","UNSET_META_VALUE","setMetaValue","setMetaValueDynamic","unsetMetaValue","metaActions","getDefaultEntities","reduxImpl","reducer","initial","set","_get","action","redux","trackedConnections","getTrackedConnectionState","api2","extractConnectionInformation","extensionConnector","existingConnection","newConnection","devtoolsImpl","fn","devtoolsOptions","get","enabled","anonymousActionType","connection","connectionInformation","isRecording","nameOrAction","setStateFromDevtools","originalIsRecording","store2","didWarnAboutReservedActionType","originalDispatch","parseJsonThen","stateFromDevtools","nextLiftedState","lastComputedState","devtools","stringified","parsed","subscribeWithSelectorImpl","origSubscribe","optListener","equalityFn","currentSlice","nextSlice","previousSlice","subscribeWithSelector","mappingReducer","isReferenceList","quickMerge","newResource","added","bValue","numberOr","entitiesReducer","updateField","values","removed","keys","toReturn","newEntities","changed","ids","indexToRemove","metadata","actionPayload","requestReducer","metaReducer","updateValue","combineReducers","reducers2","reducerKeys","hasChanged","createBatchReducer","rootReducer","reducers","getDefaultState","createStore2","enableDevtools","iiifStoreName","defaultState","customReducers","dv","mitt_default","n2","__create","__defProp","__getOwnPropDesc","__getOwnPropNames","__getProtoOf","__hasOwnProp","__defNormalProp","obj","__commonJS","cb","mod","__copyProps","to","from","except","desc","__toESM","isNodeMode","defineProperty","prototype","enumerable","DEFINED","cache","REFS","object","wrapObject","REACTIVE","unwrapObject","PARENT","createPrototype","reactive","refOrObject","fresh","parent2","that","subscription","skipInitial","isWrapped","newObject","wrapped","resolveType","Vault","json","realAction","state2","handler","config","serialize","serializeConfigPresentation2","serializeConfigPresentation3","skipSelfReturn","isSpecificResource","_type2","_type","_id","found","input","prev","next","fn2","newInput","otherOptions","objectType","newValueOrUpdate","getGlobal","globalVault","gv","newVault","getClosestLanguage","i18nLanguage","languages","i18nLanguages","strictFallback","skipLanguages","root","lang","inverseIdx","root2","inverseIdx2","buildLocaleString","inputText","defaultText","separator","fallbackLanguages","closest","language","candidateText","skip","Qe","hi","Si","zi","Pi","Oi","Wi","getImageServerFromId","sampledTilesToTiles","sampledTiles","maxDim","newTiles","tile","lastSize","curWidth","scaleFactors","getImageFromTileSource","image","targetWidth","targetHeight","req","createImageServiceRequest","canonicalServiceUrl","getId","imageServiceRequestToString","isBestMatch","current","candidate","pickBestFromCandidates","inputRequest","candidates","log","explain","indent","lastResorts","fallback","currentChoice","swapChoice","candidateGroups","group","candidatesLength","isImage3","service","getFixedSizesFromService","isImageService","size","getId2","getImageServiceLevel","getCustomSizeFromService","supportsCustomSizes","imagesSizes","profiles","pLen","profile","getId3","getImageServiceLevel2","getImageCandidatesFromService","totalServices","single","fixedSizes","customSizes","inferImageSizeFromUrl","regex","region","format","getFixedSizeFromImage","contentResource","getType","getId4","getImageCandidates","unknownResource","dereference","loader","fixedSizeFromImage","refCandidates","imageServices2","getImageServices","getId5","externalService","imageSizesMatch","sizesA","sizesB","matchOrder","matching","ImageServiceLoader","imageServiceRequest","preLoaded","server","getId6","serviceUrl","canonicalServiceUrl2","existing","isLevel0","extractFixedSizeScales","forceVerify","verify","force","source","serverId","imageServer","fixedSizesFromScales","otherCandidates","getImageServices2","prediction","imageService","isValid","serviceId","canonical","forceFresh","service2","init","running","serviceJson","createImageServiceStore","backgroundRequest","getId7","loaded","error","imageServiceLoader","createThumbnailHelper","dependencies","getBestThumbnailAtSize","dimensions","thumbnailNotFound","fixed","fullInput","thumbnail","potentialThumbnails","contentResources","firstContentResources","firstManifest","firstCanvas","require_parse_svg_path","exports","module","parse","segment","path","command","parseValues","number","numbers","require_abs_svg_path","absolutize","startX","startY","seg","_slicedToArray","sliceIterator","arr","_arr","_n","_d","_e","_i","_s","TAU","mapToEllipse","_ref","rx","ry","cosphi","sinphi","centerx","centery","xp","yp","approxUnitArc","ang1","ang2","x1","y1","x2","y2","vectorAngle","ux","uy","vx","vy","sign","dot","getArcCenter","px","py","cx","cy","largeArcFlag","sweepFlag","pxp","pyp","rxsq","rysq","pxpsq","pypsq","radicant","centerxp","centeryp","vx1","vy1","vx2","vy2","arcToBezier","_ref2","_ref2$xAxisRotation","xAxisRotation","_ref2$largeArcFlag","_ref2$sweepFlag","curves","lambda","_getArcCenter","_getArcCenter2","ratio","segments","curve","_mapToEllipse","_mapToEllipse2","_mapToEllipse3","modules_default","import_parse_svg_path","import_abs_svg_path","parseAndNormalizeSvgPath","absolute","prevCmd","bezierX","bezierY","quadX","quadY","cmd","flattenQuadraticBezier","control","tolerance","QuadraticBezier","flattenCubicBezier","startControl","endControl","CubicBezier","hypot2","approx_myint","approx_inv_myint","mt","x0","y0","ddx","ddy","u0","u2","cross","paramX0","paramX2","scale","params","a0","a2","count","tValues","_CubicBezier","c0","c1","c2","c3","p1","t0","t1","p0","p3","d1","d2","tol","tol1","tol2","sqrt_tol2","err2","n_quads","quads","sum","i2","quad","val2","xmin","cusp_val","BOX_SELECTOR","TEMPORAL_SELECTOR","RGBA_COLOR","parseSelector","domParser","svgPreprocessor","iiifRenderingHints","resolveHints","nextSource","selectors","newIiifRenderingHints","fragment","isImageApiSelector","parsedRegion","matchBoxSelector","matchBoxTimeSelector","matchTimeSelector","rect","style","svg","svgShape","svgElement","selectorElem","getSelectorElement","extractStyles","sel","getShapeTypeFromPath","svgPath","cmdFrequencies","cmdTypes","lastSeg","svgElem","element","normalized","pathToPoints","angle","rad","ps","shapeType","normalizedPath","startPoint","selectorElement","rgbaMatch","rootElem","supported","parsedRotation","parseRotation","num","expandTarget","Le","Oe","Pe","We","je","Te","Ne","ke","Ge","xe","Ie","we","ze","be","Ee","PURPOSE_ORDER","PURPOSE_LABELS","getI18nValue","languagePreference","splitAfter","localized","ImageServiceLoader_","fetchRespectfully","thumbHelper","getThumbnail","manifest","maxDimension","isExternalWebResourceWithProfile","isPhysicalDimensionService","supportsScaling","getCanvasAnnotations","parseAnnotation","getCanvasInfo","imageInfos","getImageInfos","getOcrReferences","agentToString","agent","creatorToString","creator","anno","langPrefs","annoBody","bodyRef","creatorNames","modifiedDates","targets","markup","buildAnnotationMarkup","bodies","purpose","purposeLabel","part","parseTarget","targetStr","canvasId","getImageFormat","_b","_c","paintingAnnos","ap","annoTarget","choiceItem","parseOcr","ocrText","pageIter","isAlto","isHocr","fetchOcrMarkup","resp","refs","fetchAndParseText","annotations","ocrRefs","stopMeasuring","rateLimitRegistry","FALLBACK_PPI","MANIFEST_ACCEPT_HEADER","RateLimitingRegistry","host","mutex","ticket","includedCredentialsHosts","maxRetries","rateLimitMutex","numRetries","waitMs","fetchOptions","retryAfter","getHeaderValue","ietfHeader","header","limit","remaining","reset","secsPerQuotaUnit","getImageSize","imgService","sizeStr","isIIIFv3","maxWidth","requestedWidth","aspectRatio","supportsScaleByWh","fullArea","getPointsPerInch","services","physDimService","physicalScale","physicalUnits","ppi","isImageFetchFailure","fetchCanvasImage","abortSignal","sizeOnly","imageUrl","downscaled","fetchFullImageService","sizeInfo","numBytes","corsAvailable","imgResp","isImageUnavailableDueToCors","imgElem","fetchStartCanvasInfo","startRef","selectorStr","fragSel","selX","selY","selWidth","selHeight","fetchCanvasData","ppiOverride","imagePromises","results","canvasImages","imgInfo","failures","fetchManifestJson","manifestUrl","serviceRef","has","prefix","Events","EE","context","once","addListener","emitter","clearEvent","EventEmitter","handlers","a1","a3","a4","a5","TimeoutError","getDOMException","errorMessage","AbortError","getAbortedReason","signal","reason","pTimeout","promise","milliseconds","timer","cancelablePromise","timeoutError","lowerBound","array","comparator","it","__classPrivateFieldGet","receiver","kind","_PriorityQueue_queue","PriorityQueue","run","index","item","__classPrivateFieldSet","_PQueue_instances","_PQueue_carryoverConcurrencyCount","_PQueue_isIntervalIgnored","_PQueue_intervalCount","_PQueue_intervalCap","_PQueue_interval","_PQueue_intervalEnd","_PQueue_intervalId","_PQueue_timeoutId","_PQueue_queue","_PQueue_queueClass","_PQueue_pending","_PQueue_concurrency","_PQueue_isPaused","_PQueue_throwOnTimeout","_PQueue_doesIntervalAllowAnother_get","_PQueue_doesConcurrentAllowAnother_get","_PQueue_next","_PQueue_onResumeInterval","_PQueue_isIntervalPaused_get","_PQueue_tryToStartAnother","_PQueue_initializeIntervalIfNeeded","_PQueue_onInterval","_PQueue_processQueue","_PQueue_throwOnAbort","_PQueue_onEvent","PQueue","newConcurrency","function_","operation","functions","delay","canInitializeInterval","job","_resolve","filter","lib","templateStrings","matches","strings","pattern","string","u8","u16","i32","fleb","fdeb","clim","freb","eb","fl","revfl","fd","revfd","rev","hMap","cd","mb","co","rvb","sv","r_1","flt","fdt","flm","flrm","fdm","fdrm","max","bits","bits16","shft","slc","ec","ind","nt","inflt","dat","st","dict","sl","dl","noBuf","resize","noSt","cbuf","bl","nbuf","final","pos","bt","lm","dm","lbt","dbt","tbts","hLit","hcLen","tl","ldt","clt","clb","clbmsk","clm","lt","dt","lms","dms","lpos","sym","add","dsym","shift","dend","wbits","wbits16","hTree","t2","et","i0","i1","maxSym","tr","mbt","ln","lft","cst","i2_1","i2_2","i2_3","lc","cl","cli","cln","cls","clen","cf","wfblk","wblk","syms","lf","df","li","bs","dlt","mlb","ddt","mdb","lclt","nlc","lcdt","ndc","lcfreq","lct","mlcb","nlcc","flen","ftlen","dtlen","ll","llm","lcts","clct","dst","deo","dflt","lvl","plvl","pre","post","lst","opt","msk_1","head","bs1_1","bs2_1","hsh","lc_1","wi","hv","imod","pimod","rem","ch_1","dif","maxn","maxd","ml","nl","mmd","md","ti","pti","lin","din","adler","dopt","newDat","wbytes","zlh","lv","zls","zlibSync","opts","unzlibSync","td","tds","textEncoder","textDecoder","util","cryptoImpl","nodeCrypto","IS_BIG_ENDIAN","view","randomData","u32View","tryDeflateStream","pdfStream","compressed","zlib","bytes","compStream","PDF_INDENTATION","PdfRef","makeRef","isUnicode","toUTF16BE","includeBom","outBuf","safeNumber","dictIndent","outsideIndent","insideIndent","CountingWriter","writer","WebWriter","stream","BlobWriter","NodeWriter","writable","waitForDrain","ArrayReader","position","sub","_PNG","retVal","pixels","imageData","colors","palette","alpha","pixelBytes","scanlineLength","pass","dx","dy","singlePass","row","byte","left","col","pixelsIdx","upper","upperLeft","upperIdx","upperLeftIdx","pa","pb","pc","paeth","pixelsPos","bufferPos","b1","b2","b3","b4","transparency","temp","imgDataBuff","chunkSize","section","colorTypeMap","PNG","readUint16BE","PdfImage","JPEGImage","PNGImage","_JPEGImage","marker","channels","startNum","label","dataDecoded","hasAlphaChannel","isInterlaced","nextNum","imgObj","imgDict","paletteObj","rgb","mask","alphaChannelObj","objNum","colorCount","pixelCount","imgData","alphaChannel","skipByteCount","colorIndex","alphaChannelDeflated","predicate","ESCAPE_CHARS","parseCrossRefSection","testForString","trailerIdx","_x","currentSection","entryParts","numObjs","trailerBuf","trailerStartIdx","trailerEndIdx","trailerDict","PdfValueParser","previousXrefOffset","backwards","isDigit","isHex","resetAfter","chr","isInt","chars","intStr","matchNumber","matchWhitespace","doesMatch","isRealNumber","digitSeen","separatorSeen","skipped","vals","openParens","cs","PdfParser","objOffsets","objGenerations","bufStart","eofIdx","startXrefPos","xrefStartOffset","dictEnd","dictStart","entries","gen","inUse","pagesObj","pageRef","pageDict","pagesRef","pagesRoot","pagesDict","annots","annoRef","withStream","nextOffset","objEndIdx","streamIdx","objSig","streamLength","pdiiifVersion","buildLocalZipHeader","creationDate","filename","compressedData","extraDataLength","creationTimeZip","creationDateZip","dataCrc","filenameEncoded","compressedLength","buildCentralFileDirectory","files","trailingLength","chunks","buildCentralDirectoryFileHeader","cdSize","curr","colorName","isArrayish","require$$0","concat","slice","swizzle","simpleSwizzleModule","arg","colorNames","require$$1","hasOwnProperty","reverseNames","colorStringModule","model","abbr","hex","rgba","per","keyword","hexAlpha","clamp","hsl","hwb","hexDouble","hsla","hwba","min","cssKeywords","reverseKeywords","convert","conversions","labels","delta","rdif","gdif","bdif","diff","diffc","comparativeDistance","reversed","currentClosestDistance","currentClosestKeyword","distance","xyz","t3","smin","lmin","hsv","vmin","wh","cmyk","lab","z2","lch","hr","saturation","ansi","color","mult","colorString","char","integer","chroma","grayscale","hue","hcg","pure","mg","apple","gray","buildGraph","graph","models","deriveBFS","fromModel","adjacents","adjacent","node","link","wrapConversion","toModel","cur","route","conversion","wrapRaw","wrappedFn","arg0","wrapRounded","routes","colorConvert","skippedModels","hashedModelKeys","limiters","Color","newArray","zeroArray","hashedKeys","places","roundToPlace","getset","maxfn","rgbArray","alphaHex","lum","chan","color2","lum1","lum2","contrastRatio","degrees","mixinColor","color1","w1","w2","assertArray","roundTo","channel","modifier","eventAggregator","env","CSS_LENGTH_PAT","htmlToPlainText","html","ev","toPdfRect","pageHeight","unitScale","lly","ury","cssColorToRgb","cssColor","cssLengthToPdfUserspace","cssLength","referenceDimensionPx","selectorStyleToPdf","pdfStyle","selectorToPdf","styleDict","point","svgSel","exportPdfAnnotation","annoDict","PRODUCER","CHAR_WIDTH","FONTDATA","PDFGenerator","canvasInfos","langPref","pageLabels","outline","readingDirection","hasText","initialCanvas","manifestJson","zipPolyglot","zipBaseDir","pdfMetadata","catalog","outlines","outlinesObj","itm","childObj","numKids","typeZeroFont","typeTwoFont","cidtoGidMapData","comp","cidToGidMap","cmapStream","dedent","cmap","fontDesc","maybeCompressedFont","fontDataObj","embeddedFiles","fileObjNum","nameTree","dest","destCanvasIdx","ci","rec","numChildren","refName","isObject","seenObjects","handleValue","objDict","newObj","pdfData","newPageRef","description","mimeType","fileSpec","maybeCompressed","embeddedFile","zipData","manifestMime","manifestProfile","initiallyEnabledOCGs","initiallyDisabledOCGs","allOCGs","rbGroups","canvasIdx","images","ocgStart","ocgIdx","rbGroup","img","canvasWidth","canvasHeight","contentOps","optionalGroupIds","choiceInfo","drawWidth","drawHeight","drawX","drawY","imageId","ocId","contentStreamComp","contentsObj","pageResources","xObjects","properties","ocgId","imgIdx","imageObjs","mainImageObj","imgPreambleSize","canvasInfo","pdfAnno","ocr","ops","pageObjNum","lineIdx","handleChild","grandchild","fontRef","fontSize","xPos","lineY","yPos","xOld","yOld","wordX","wordY","wordWidth","wordHeight","wordLength","pdfWordLen","textBytes","numAnnotations","numObjects","untilStreamStart","parentRoot","parentRootRef","pageParents","rootRef","visitEntry","parentRef","objRef","parents","mcId","pidx","xrefEntries","xRefTable","off","free","xrefOffset","trailer","endObj","deflatedData","bytesUntilActualData","zipObjOffset","zipObj","localHeaderOffset","licenses","getLicenseInfo","uri","WorkerPool","worker","OptimizationWorker","availableWorker","optimError","pool","startWorkerPool","wasmLoader","mozjpegWasm","promises","optimizeImage","getCanvasesForSampling","canvases","numSamples","meanPixels","candidateCanvases","sampleCanvases","estimatePdfSize","inputManifest","concurrency","filterCanvases","optimization","saxWasmLoader","ocrParser.SAX_WASM_VERSION","mozjpegWasmLoader","manifestId","canvasPredicate","totalCanvasPixels","samplePixels","ocrParser.isInitialized","ocrParser.initialize","ocrParser.setupLogging","canvasData","info","optimizationResult","originalSize","optimized","corsSupported","sampleBytes","sampleImage","buildOutlineFromRanges","canvasIds","isCanvas","ri","isRange","seenRanges","handleTocRange","range","rangeLabel","childRanges","children","startCanvas","tocRanges","topRange","ProgressTracker","countingStream","pdfGen","onProgress","onNotification","pagesWritten","messageCode","bytesPushed","estimatedFileSize","bytesWritten","writeSpeed","remainingDuration","notification","pixelsWritten","canvasPixels","getCoverPagePdf","endpoint","thumbUrl","manifestThumb","provider","required","_f","license","licenseDef","_g","convertManifest","outputStream","fetchCanvasAnnotations","abortController","coverPageCallback","coverPageEndpoint","polyglotZipPdf","polyglotZipBaseDir","countingWriter","report","canvasFuts","progress","coverPageData","imageFailures","reportData","externalAnnotations","convertPresentation2","endPromise","closed","progressOnDrain"],"mappings":"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,EAAG,EAAG,EAAG,EAAG,EAAG,EAAG,EAAG,EAAG,IAAK,EAAG,EAAG,EAAG,EAAG,EAAG,EAC1E,EAAG,EAAG,EAAG,EAAG,EAAG,EAAG,EAAG,EAAG,EAAG,EAAG,EAAG,EAAG,EAAG,EAAG,EAAG,EAAG,EAAG,EAAG,EAAG,EAAG,EAAG,EAAG,EAAG,EAAG,EAAG,EAC3E,EAAG,EAAG,EAAG,EAAG,EAAG,EAAG,EAAG,EAAG,EAAG,EAAG,EAAG,EAAG,EAAG,EAAG,EAAG,EAAG,EAAG,EAAG,EAAG,EAAG,GAAI,GAAI,GAAI,GAAI,EAC5E,GAAI,EAAG,EAAG,EAAG,EAAG,EAAG,EAAG,IAAK,IAAK,EAAG,EAAG,EAAG,EAAG,EAAG,EAAG,IAAK,EAAG,EAAG,EAAG,EAAG,EAAG,EAAG,EAAG,EAC5E,EAAG,EAAG,EAAG,EAAG,EAAG,EAAG,EAAG,EAAG,EAAG,EAAG,EAAG,EAAG,EAAG,EAAG,EAAG,EAAG,EAAG,EAAG,EAAG,EAAG,EAAG,EAAG,EAAG,EAAG,EAAG,EAC3E,EAAG,EAAG,GAAI,EAAG,EAAG,EAAG,EAAG,EAAG,EAAG,EAAG,GAAI,EAAG,EAAG,EAAG,GAAI,EAAG,EAAG,EAAG,EAAG,EAAG,EAAG,EAAG,EAAG,EAAG,EAC3E,EAAG,EAAG,EAAG,GAAI,EAAG,EAAG,EAAG,EAAG,EAAG,EAAG,EAAG,EAAG,EAAG,EAAG,EAAG,EAAG,EAAG,EAAG,EAAG,EAAG,GAAI,GAAI,GAAI,GACzE,EAAG,EAAG,IAAK,EAAG,EAAG,EAAG,EAAG,EAAG,EAAG,EAAG,EAAG,GAAI,EAAG,EAAG,EAAG,EAAG,EAAG,EAAG,EAAG,EAAG,EAAG,GAAI,EAAG,EAAG,EAC5E,EAAG,EAAG,EAAG,EAAG,EAAG,EAAG,EAAG,EAAG,GAAI,EAAG,GAAI,EAAG,EAAG,EAAG,EAAG,EAAG,EAAG,EAAG,EAAG,EAAG,GAAI,EAAG,EAAG,EAAG,GAC3E,EAAG,IAAK,EAAG,IAAK,EAAG,IAAK,EAAG,IAAK,EAAG,IAAK,EAAG,IAAK,EAAG,GAAI,EAAG,GAAI,EAAG,GAAI,EAAG,GACxE,GAAI,IAAK,IAAK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R,EACA,8CAA+C,CAC7C,KAAM,wDACN,KAAM,uEACR,EACA,iDAAkD,CAChD,KAAM,yEACN,KAAM,0EACR,EACA,oDAAqD,CACnD,KAAM,wFACN,KAAM,6EACR,EACA,iDAAkD,CAChD,KAAM,yEACN,KAAM,0EACR,EACA,oDAAqD,CACnD,KAAM,2FACN,KAAM,6EACR,EACA,iDAAkD,CAChD,KAAM,0EACN,KAAM,0EACR,EACA,iDAAkD,CAChD,KAAM,sEACN,KAAM,0EACR,EACA,uDAAwD,CACtD,KAAM,qGACN,KAAM,6EACR,EACA,8CAA+C,CAC7C,KAAM,uDACN,KAAM,uEACR,EACA,iDAAkD,CAChD,KAAM,yEACN,KAAM,0EACR,EACA,oDAAqD,CACnD,KAAM,2FACN,KAAM,6EACR,EACA,wDAAyD,CACvD,KAAM,wFACN,KAAM,6EACR,EACA,qDAAsD,CACpD,KAAM,wEACN,KAAM,iFACR,EACA,oDAAqD,CACnD,KAAM,wFACN,KAAM,6EACR,EACA,uDAAwD,CACtD,KAAM,8FACN,KAAM,6EACR,EACA,iDAAkD,CAChD,KAAM,0EACN,KAAM,0EACR,EACA,oDAAqD,CACnD,KAAM,4EACN,KAAM,0EACR,EACA,iDAAkD,CAChD,KAAM,sEACN,KAAM,0EACR,EACA,oDAAqD,CACnD,KAAM,4EACN,KAAM,0EACR,EACA,oDAAqD,CACnD,KAAM,2FACN,KAAM,6EACR,EACA,iDAAkD,CAChD,KAAM,uEACN,KAAM,0EACR,EACA,oDAAqD,CACnD,KAAM,8FACN,KAAM,6EACR,EACA,iDAAkD,CAChD,KAAM,sEACN,KAAM,0EACR,EACA,oDAAqD,CACnD,KAAM,uEACN,KAAM,0EACR,EACA,8CAA+C,CAC7C,KAAM,uDACN,KAAM,uEACR,EACA,oDAAqD,CACnD,KAAM,mFACN,KAAM,0EACR,EACA,iDAAkD,CAChD,KAAM,8DACN,KAAM,uEACR,EACA,oDAAqD,CACnD,KAAM,yFACN,KAAM,6EACR,EACA,8CAA+C,CAC7C,KAAM,6DACN,KAAM,uEACR,EACA,iDAAkD,CAChD,KAAM,gEACN,KAAM,uEAC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","x_google_ignoreList":[1,2,3,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,34,35,36,37,38,39,40,49,50,51,52,53,54,55,56,57]}
\ No newline at end of file
diff --git a/node_modules/pdiiif/dist/index.d.ts b/node_modules/pdiiif/dist/index.d.ts
index b8c3211..dfbfce7 100644
--- a/node_modules/pdiiif/dist/index.d.ts
+++ b/node_modules/pdiiif/dist/index.d.ts
@@ -1,209 +1,7 @@
-import { Writable } from 'stream';
-import { Annotation, Manifest } from '@iiif/presentation-3';
-import Presentation2 from '@iiif/presentation-2';
-
-type LogLevel = 'debug' | 'info' | 'warn' | 'error';
-interface Logger {
-    setLevel(level: LogLevel): void;
-    debug(message: string, ...args: any[]): void;
-    info(message: string, ...args: any[]): void;
-    warn(message: string, ...args: any[]): void;
-    error(message: string, ...args: any[]): void;
-}
-/** Simple logger that simply outputs to the console */
-declare class ConsoleLogger implements Logger {
-    private level;
-    constructor(level?: LogLevel);
-    setLevel(level: LogLevel): void;
-    debug(message: string, ...args: any[]): void;
-    info(message: string, ...args: any[]): void;
-    warn(message: string, ...args: any[]): void;
-    error(message: string, ...args: any[]): void;
-}
-declare function setLogger(newLogger: Logger): void;
-
-/** Download the JSON data for a manifest, handling stuff like broken CORS implementations
- *  and Content-Negotiation for IIIFv3 */
-declare function fetchManifestJson(manifestUrl: string): Promise<any>;
-
-/** Progress information for rendering a progress bar or similar UI elements. */
-interface ProgressStatus {
-    /** Message code that should be mapped to a human readable description in a UI. */
-    messageCode?: ProgressMessageCode;
-    /** Expected total number of pages in the PDF */
-    totalPages: number;
-    /** Number of pages that were submitted for writing */
-    pagesWritten: number;
-    /** Number of bytes that were submitted for writing to the output stream */
-    bytesPushed: number;
-    /** Number of bytes that were written to the output stream so far */
-    bytesWritten: number;
-    /** Predicted size of the final file in bytes */
-    estimatedFileSize?: number;
-    /** Write speed in bytes per second */
-    writeSpeed: number;
-    /** Estimated time in seconds until PDF has finished generating */
-    remainingDuration: number;
-}
-/** Parameters for rendering a cover page, parsed from IIIF manifest. */
-interface CoverPageParams {
-    title: string;
-    manifestUrl: string;
-    thumbnail?: {
-        url: string;
-        iiifImageService?: string;
-    };
-    provider?: {
-        label: string;
-        homepage?: string;
-        logo?: string;
-    };
-    requiredStatement?: {
-        label: string;
-        value: string;
-    };
-    rights?: {
-        text: string;
-        url?: string;
-        logo?: string;
-    };
-    metadata?: Array<[string, string | Array<string>]>;
-    pdiiifVersion: string;
-}
-/** Options for converting a IIIF Manifest to a PDF. */
-interface ConvertOptions {
-    /** Callback to provide annotations for a given canvas identifier.
-     * Should return either a `sc:AnnotationList` (IIIF2) or an `AnnotationPage` (IIIF3).
-     */
-    fetchCanvasAnnotations?: (canvasId: string) => Promise<Array<Annotation> | Array<Presentation2.Annotation>>;
-    /** Pixels per inch to assume for the full resolution version of each canvas.
-        If not set, the conversion will use an available IIIF Physical Dimensions
-        service to calculate the page dimensions instead. */
-    ppi?: number;
-    /** Set of canvas ids to include in PDF, or a predicate to filter canvas identifiers
-        by. By default, all canvases are included in the PDF. */
-    filterCanvases?: readonly string[] | ((canvasId: string) => boolean);
-    /** List of languages to use for metadata, page labels and table of contents, in
-        descending order of preference. Will use the environment's locale settings by
-        default. */
-    languagePreference?: readonly string[];
-    /** Restrict the image size to include in the PDF by downscaling by a fixed factor.
-     * The value must be a number between 0.1 and 1.
-     * Only works with Level 2 Image API services that allow arbitrary downscaling, the
-     * conversion will not perform downscaling itself.
-     * For Level 1 endpoints, the closest available lower width will be selected. */
-    scaleFactor?: number;
-    /** Number of maximum concurrent IIIF Image API requests to be performed, defaults to 1 */
-    concurrency?: number;
-    /** Callback that gets called whenever a page has finished, useful to render a
-        progress bar. */
-    onProgress?: (status: ProgressStatus) => void;
-    /** Callback that gets called with a notification when an error occurs during PDF generation
-     *  that does not cause the conversion to fail. */
-    onNotification?: (notification: ProgressNotification) => void;
-    /** Controller that allows aborting the PDF generation. All pending
-        downloads will be terminated. The caller is responsible for
-        removing underlying partial files and/or other user signaling. */
-    abortController?: AbortController;
-    /** Set PDF metadata, by default `Title` will be the manifest's label. */
-    metadata?: {
-        CreationDate?: Date;
-        Title?: string;
-        Author?: string;
-        Keywords?: string;
-    };
-    /** Endpoint to contact for retrieving PDF data with one or more cover pages
-        to insert before the canvas pages */
-    coverPageEndpoint?: string;
-    /** Callback to call for retrieving PDF data with one or more cover pages
-        to insert before the canvas pages */
-    coverPageCallback?: (params: CoverPageParams) => Promise<Uint8Array>;
-    /** Generate the PDF in a way that the resulting file is also a valid
-     *  ZIP file that contains the manifest, all of the images and, if present,
-     *  the OCR files referenced in the manifest. */
-    polyglotZipPdf?: boolean;
-    /** Base directory in the polyglot ZIP archive. If not set, all resource
-     * directories will be to-level in the archive. */
-    polyglotZipBaseDir?: string;
-    /** Custom loader callback that fetches the WASM binary for the `sax-wasm`
-     *  dependency (v2.2.4). By default, the dependency will be loaded from
-     *  `https://unpkg.com/sax-wasm/dist/sax-wasm.wasm`. Override if you want
-     *  to provide your own payload. Loader will not be called if {@link initialize}
-     *  from `ocr-parser` has been called before.
-     */
-    saxWasmLoader?: () => Promise<Uint8Array>;
-}
-/** Parameters for size estimation */
-interface EstimationParams {
-    /** The manifest to determine the PDF size for */
-    manifest: string | Manifest | Presentation2.Manifest;
-    /** Restrict the image size to include in the PDF by downscaling by a fixed factor.
-     * The value must be a number between 0.1 and 1.
-     * Only works with Level 2 Image API services that allow arbitrary downscaling, the
-     * conversion will not perform downscaling itself.
-     * For Level 1 endpoints, the closest available lower width will be selected. */
-    scaleFactor?: number;
-    /** Set of canvas ids to include in PDF, or a predicate to filter canvas identifiers
-        by. By default, all canvases are included in the PDF. */
-    filterCanvases?: readonly string[] | ((canvasId: string) => boolean);
-    /** Number of canvses to sample for estimation, defaults to 8 */
-    numSamples?: number;
-    /** Number of maximum concurrent IIIF Image API requests to be performed, defaults to 1 */
-    concurrency?: number;
-}
-type Estimation = {
-    /** Estimated size of the PDF in bytes */
-    size: number;
-    /** If CORS is enabled for all of the images referenced in the sample canvases */
-    corsSupported: boolean;
-};
-/** Estimate the final size of the PDF for a given manifest.
- *
- * This will randomly sample a few representative canvases from the manifest,
- * check their size in bytes and extrapolate from that to all canvases.
- *
- * @throws {Error} if the manifest cannot be loaded
- */
-declare function estimatePdfSize({ manifest: inputManifest, concurrency, scaleFactor, filterCanvases, numSamples, }: EstimationParams): Promise<Estimation>;
-type ProgressMessageCode = 'generate-cover-page' | 'generate-pages' | 'finishing';
-type ProgressNotification = ImageDownloadFailureNotification | OcrDownloadFailureNotification;
-type ImageDownloadFailureNotification = {
-    code: 'image-download-failure';
-    canvasIndex: number;
-    numFailed: number;
-    numTotal: number;
-    details: {
-        [imageUrl: string]: string;
-    };
-};
-type OcrDownloadFailureNotification = {
-    code: 'ocr-download-failure';
-    canvasIndex: number;
-    ocrUrl: string;
-};
-type ConversionReport = {
-    fileSizeBytes: number;
-    numPages: number;
-    fileName?: string;
-    failedImages?: Array<{
-        canvasIndex: number;
-        numFailed: number;
-        numTotal: number;
-        details: {
-            [imageUrl: string]: string;
-        };
-    }>;
-    failedOcr?: Array<{
-        canvasIndex: number;
-        ocrUrl: string;
-    }>;
-};
-type ConversionReportWithData = ConversionReport & {
-    data: Blob;
-};
-declare function convertManifest(inputManifest: string | Manifest | Presentation2.Manifest, outputStream: Writable | WritableStream, options: ConvertOptions): Promise<ConversionReport>;
-declare function convertManifest(inputManifest: string | Manifest | Presentation2.Manifest, outputStream: undefined, options: ConvertOptions): Promise<ConversionReportWithData>;
-
-declare const _default: "0.2.3";
-
-export { ConsoleLogger, ConversionReport, ConversionReportWithData, ConvertOptions, CoverPageParams, Estimation, EstimationParams, ImageDownloadFailureNotification, Logger, OcrDownloadFailureNotification, ProgressMessageCode, ProgressNotification, ProgressStatus, convertManifest, estimatePdfSize, fetchManifestJson, setLogger, _default as version };
+export type { Logger } from './log.js';
+export { setLogger, ConsoleLogger } from './log.js';
+export { fetchManifestJson } from './download.js';
+export * from './convert.js';
+export { vault } from './iiif.js';
+export type { OptimizationParams } from './optimization.js';
+export { default as version } from './version.js';
diff --git a/node_modules/pdiiif/dist/index.mjs b/node_modules/pdiiif/dist/index.mjs
new file mode 100644
index 0000000..de15f5a
--- /dev/null
+++ b/node_modules/pdiiif/dist/index.mjs
@@ -0,0 +1,11409 @@
+var Wo = Object.defineProperty;
+var Uo = (e, t, r) => t in e ? Wo(e, t, { enumerable: !0, configurable: !0, writable: !0, value: r }) : e[t] = r;
+var v = (e, t, r) => Uo(e, typeof t != "symbol" ? t + "" : t, r);
+import sr from "prom-client";
+import zo from "events";
+import Zi from "util";
+import Bo from "zlib";
+import qo from "crypto";
+class Ho {
+  constructor(t = "warn") {
+    v(this, "level");
+    this.level = t;
+  }
+  setLevel(t) {
+    this.level = t;
+  }
+  debug(t, ...r) {
+    this.level === "debug" && console.debug(t, ...r);
+  }
+  info(t, ...r) {
+    this.level !== "error" && this.level !== "warn" && console.info(t, ...r);
+  }
+  warn(t, ...r) {
+    this.level !== "error" && console.warn(t, ...r);
+  }
+  error(t, ...r) {
+    console.error(t, ...r);
+  }
+}
+let O = new Ho();
+function Tp(e) {
+  O = e;
+}
+const Qo = new Error("request for lock canceled");
+var Go = function(e, t, r, i) {
+  function n(s) {
+    return s instanceof r ? s : new r(function(a) {
+      a(s);
+    });
+  }
+  return new (r || (r = Promise))(function(s, a) {
+    function o(l) {
+      try {
+        h(i.next(l));
+      } catch (u) {
+        a(u);
+      }
+    }
+    function c(l) {
+      try {
+        h(i.throw(l));
+      } catch (u) {
+        a(u);
+      }
+    }
+    function h(l) {
+      l.done ? s(l.value) : n(l.value).then(o, c);
+    }
+    h((i = i.apply(e, t || [])).next());
+  });
+};
+class Yo {
+  constructor(t, r = Qo) {
+    this._value = t, this._cancelError = r, this._weightedQueues = [], this._weightedWaiters = [];
+  }
+  acquire(t = 1) {
+    if (t <= 0)
+      throw new Error(`invalid weight ${t}: must be positive`);
+    return new Promise((r, i) => {
+      this._weightedQueues[t - 1] || (this._weightedQueues[t - 1] = []), this._weightedQueues[t - 1].push({ resolve: r, reject: i }), this._dispatch();
+    });
+  }
+  runExclusive(t, r = 1) {
+    return Go(this, void 0, void 0, function* () {
+      const [i, n] = yield this.acquire(r);
+      try {
+        return yield t(i);
+      } finally {
+        n();
+      }
+    });
+  }
+  waitForUnlock(t = 1) {
+    if (t <= 0)
+      throw new Error(`invalid weight ${t}: must be positive`);
+    return new Promise((r) => {
+      this._weightedWaiters[t - 1] || (this._weightedWaiters[t - 1] = []), this._weightedWaiters[t - 1].push(r), this._dispatch();
+    });
+  }
+  isLocked() {
+    return this._value <= 0;
+  }
+  getValue() {
+    return this._value;
+  }
+  setValue(t) {
+    this._value = t, this._dispatch();
+  }
+  release(t = 1) {
+    if (t <= 0)
+      throw new Error(`invalid weight ${t}: must be positive`);
+    this._value += t, this._dispatch();
+  }
+  cancel() {
+    this._weightedQueues.forEach((t) => t.forEach((r) => r.reject(this._cancelError))), this._weightedQueues = [];
+  }
+  _dispatch() {
+    var t;
+    for (let r = this._value; r > 0; r--) {
+      const i = (t = this._weightedQueues[r - 1]) === null || t === void 0 ? void 0 : t.shift();
+      if (!i)
+        continue;
+      const n = this._value, s = r;
+      this._value -= r, r = this._value + 1, i.resolve([n, this._newReleaser(s)]);
+    }
+    this._drainUnlockWaiters();
+  }
+  _newReleaser(t) {
+    let r = !1;
+    return () => {
+      r || (r = !0, this.release(t));
+    };
+  }
+  _drainUnlockWaiters() {
+    for (let t = this._value; t > 0; t--)
+      this._weightedWaiters[t - 1] && (this._weightedWaiters[t - 1].forEach((r) => r()), this._weightedWaiters[t - 1] = []);
+  }
+}
+var Vo = function(e, t, r, i) {
+  function n(s) {
+    return s instanceof r ? s : new r(function(a) {
+      a(s);
+    });
+  }
+  return new (r || (r = Promise))(function(s, a) {
+    function o(l) {
+      try {
+        h(i.next(l));
+      } catch (u) {
+        a(u);
+      }
+    }
+    function c(l) {
+      try {
+        h(i.throw(l));
+      } catch (u) {
+        a(u);
+      }
+    }
+    function h(l) {
+      l.done ? s(l.value) : n(l.value).then(o, c);
+    }
+    h((i = i.apply(e, t || [])).next());
+  });
+};
+class Jo {
+  constructor(t) {
+    this._semaphore = new Yo(1, t);
+  }
+  acquire() {
+    return Vo(this, void 0, void 0, function* () {
+      const [, t] = yield this._semaphore.acquire();
+      return t;
+    });
+  }
+  runExclusive(t) {
+    return this._semaphore.runExclusive(() => t());
+  }
+  isLocked() {
+    return this._semaphore.isLocked();
+  }
+  waitForUnlock() {
+    return this._semaphore.waitForUnlock();
+  }
+  release() {
+    this._semaphore.isLocked() && this._semaphore.release();
+  }
+  cancel() {
+    return this._semaphore.cancel();
+  }
+}
+var we;
+let N = (we = class {
+}, // 1
+v(we, "Text", 1), // 2
+v(we, "ProcessingInstruction", 2), // 4
+v(we, "SGMLDeclaration", 4), // 8
+v(we, "Doctype", 8), // 16
+v(we, "Comment", 16), // 32
+v(we, "OpenTagStart", 32), // 64
+v(we, "Attribute", 64), // 128
+v(we, "OpenTag", 128), // 256
+v(we, "CloseTag", 256), // 512
+v(we, "Cdata", 512), we), Tr = class {
+  constructor(t, r = 0) {
+    v(this, "data");
+    v(this, "cache", {});
+    v(this, "ptr");
+    this.data = t, this.ptr = r;
+  }
+}, Xo = class {
+  constructor(t, r) {
+    v(this, "line");
+    v(this, "character");
+    this.line = t, this.character = r;
+  }
+};
+var en;
+(function(e) {
+  e[e.Normal = 0] = "Normal", e[e.JSX = 1] = "JSX";
+})(en || (en = {}));
+let Gn = class extends Tr {
+  constructor(r, i = 0) {
+    super(r, i);
+    v(this, "type");
+    v(this, "name");
+    v(this, "value");
+    this.type = r[i], i += 1;
+    const n = xe(r, i);
+    i += 4, this.name = new Pt(r, i), i += n, this.value = new Pt(r, i);
+  }
+  toJSON() {
+    const { name: r, value: i, type: n } = this;
+    return { name: r, value: i, type: n };
+  }
+  toString() {
+    const { name: r, value: i } = this;
+    return `${r}="${i}"`;
+  }
+}, Ko = class extends Tr {
+  constructor(r, i = 0) {
+    super(r, i);
+    v(this, "target");
+    v(this, "content");
+    i += 16;
+    const n = xe(r, i);
+    i += 4, this.target = new Pt(r, i), i += n, this.content = new Pt(r, i);
+  }
+  get start() {
+    return this.cache.start || (this.cache.start = Xe(this.data, this.ptr));
+  }
+  get end() {
+    return this.cache.end || (this.cache.end = Xe(this.data, this.ptr + 8));
+  }
+  toJSON() {
+    const { start: r, end: i, target: n, content: s } = this;
+    return { start: r, end: i, target: n, content: s };
+  }
+  toString() {
+    const { target: r, content: i } = this;
+    return `<? ${r} ${i} ?>`;
+  }
+}, Pt = class extends Tr {
+  get start() {
+    return this.cache.start || (this.cache.start = Xe(this.data, this.ptr));
+  }
+  get end() {
+    return this.cache.end || (this.cache.end = Xe(this.data, this.ptr + 8));
+  }
+  get value() {
+    if (this.cache.value)
+      return this.cache.value;
+    const t = xe(this.data, this.ptr + 16);
+    return this.cache.value = Yn(this.data, this.ptr + 20, t);
+  }
+  toJSON() {
+    const { start: t, end: r, value: i } = this;
+    return { start: t, end: r, value: i };
+  }
+  toString() {
+    return this.value;
+  }
+}, Zo = class extends Tr {
+  get openStart() {
+    return this.cache.openStart || (this.cache.openStart = Xe(this.data, this.ptr + 8));
+  }
+  get openEnd() {
+    return this.cache.openEnd || (this.cache.openEnd = Xe(this.data, this.ptr + 16));
+  }
+  get closeStart() {
+    return this.cache.closeStart || (this.cache.closeStart = Xe(this.data, this.ptr + 24));
+  }
+  get closeEnd() {
+    return this.cache.closeEnd || (this.cache.closeEnd = Xe(this.data, this.ptr + 32));
+  }
+  get selfClosing() {
+    return !!this.data[this.ptr + 40];
+  }
+  get name() {
+    if (this.cache.name)
+      return this.cache.name;
+    const t = xe(this.data, this.ptr + 41);
+    return this.cache.name = Yn(this.data, this.ptr + 45, t);
+  }
+  get attributes() {
+    if (this.cache.attributes)
+      return this.cache.attributes;
+    let t = xe(this.data, this.ptr);
+    const r = xe(this.data, t);
+    t += 4;
+    const i = [];
+    for (let n = 0; n < r; n++) {
+      const s = xe(this.data, t);
+      t += 4, i[n] = new Gn(this.data, t), t += s;
+    }
+    return this.cache.attributes = i;
+  }
+  get textNodes() {
+    if (this.cache.textNodes)
+      return this.cache.textNodes;
+    let t = xe(this.data, this.ptr + 4);
+    const r = xe(this.data, t), i = [];
+    t += 4;
+    for (let n = 0; n < r; n++) {
+      const s = xe(this.data, t);
+      t += 4, i[n] = new Pt(this.data, t), t += s;
+    }
+    return this.cache.textNodes = i;
+  }
+  toJSON() {
+    const { openStart: t, openEnd: r, closeStart: i, closeEnd: n, name: s, attributes: a, textNodes: o, selfClosing: c } = this;
+    return { openStart: t, openEnd: r, closeStart: i, closeEnd: n, name: s, attributes: a, textNodes: o, selfClosing: c };
+  }
+  get value() {
+    return this.name;
+  }
+};
+var oi;
+let ci = (oi = class {
+  constructor(t = 0, r = { highWaterMark: 32 * 1024 }) {
+    // Web only
+    v(this, "events");
+    v(this, "wasmSaxParser");
+    v(this, "eventHandler");
+    v(this, "options");
+    v(this, "writeBuffer");
+    v(this, "eventTrap", (t, r, i) => {
+      if (!this.wasmSaxParser)
+        return;
+      const n = new Uint8Array(this.wasmSaxParser.memory.buffer, r, i).slice();
+      let s;
+      switch (t) {
+        case N.Attribute:
+          s = new Gn(n);
+          break;
+        case N.ProcessingInstruction:
+          s = new Ko(n);
+          break;
+        case N.OpenTag:
+        case N.CloseTag:
+        case N.OpenTagStart:
+          s = new Zo(n);
+          break;
+        case N.Text:
+        case N.Cdata:
+        case N.Comment:
+        case N.Doctype:
+        case N.SGMLDeclaration:
+          s = new Pt(n);
+          break;
+        default:
+          throw new Error("No reader for this event type");
+      }
+      this.eventHandler && this.eventHandler(t, s);
+    });
+    this.options = r;
+    const i = this;
+    Object.defineProperties(this, {
+      events: {
+        get: () => ~~t,
+        set: (n) => {
+          t = ~~n, i.wasmSaxParser && i.wasmSaxParser.parser(t);
+        },
+        configurable: !1,
+        enumerable: !0
+      }
+    });
+  }
+  write(t) {
+    if (!this.wasmSaxParser)
+      return;
+    const { write: r, memory: i } = this.wasmSaxParser;
+    (!this.writeBuffer || this.writeBuffer.buffer !== i.buffer) && (this.writeBuffer = new Uint8Array(i.buffer)), this.writeBuffer.set(t, 0), r(0, t.byteLength);
+  }
+  end() {
+    var t;
+    this.writeBuffer = void 0, (t = this.wasmSaxParser) == null || t.end();
+  }
+  async prepareWasm(t) {
+    let r;
+    if (t instanceof Uint8Array ? r = await WebAssembly.instantiate(t, {
+      env: {
+        memoryBase: 0,
+        tableBase: 0,
+        memory: new WebAssembly.Memory({ initial: 10 }),
+        table: new WebAssembly.Table({ initial: 1, element: "anyfunc" }),
+        event_listener: this.eventTrap
+      }
+    }) : r = await WebAssembly.instantiateStreaming(t), r && typeof this.events == "number") {
+      const { parser: i } = this.wasmSaxParser = r.instance.exports;
+      return i(this.events), !0;
+    }
+    throw new Error("Failed to instantiate the parser.");
+  }
+}, v(oi, "textDecoder"), oi);
+const Yn = (e, t, r) => globalThis.hasOwnProperty("Buffer") ? Buffer.from(e.buffer, e.byteOffset + t, r).toString() : (ci.textDecoder || (ci.textDecoder = new TextDecoder())).decode(e.subarray(t, t + r)), xe = (e, t) => e[t + 3] << 24 | e[t + 2] << 16 | e[t + 1] << 8 | e[t], Xe = (e, t = 0) => {
+  const r = xe(e, t), i = xe(e, t + 4);
+  return new Xo(r, i);
+};
+function Vn(e) {
+  return {
+    ...e,
+    type: "line",
+    children: [],
+    get words() {
+      return this.children.filter((t) => typeof t != "string");
+    },
+    get text() {
+      return this.children.map((t) => typeof t == "string" ? t : t.text).join("");
+    }
+  };
+}
+function ec(e) {
+  return {
+    ...e,
+    type: "paragraph",
+    children: [],
+    get lines() {
+      return this.children;
+    },
+    get words() {
+      return this.children.flatMap((t) => t.words);
+    },
+    get text() {
+      var t;
+      const r = [];
+      for (const [i, n] of this.children.entries())
+        r.push(n.text), i < this.children.length - 1 && !((t = n.words.slice(-1)[0]) != null && t.hyphenStart) && r.push(" ");
+      return r.join("");
+    }
+  };
+}
+function Jn(e) {
+  return {
+    ...e,
+    type: "block",
+    children: [],
+    get paragraphs() {
+      return this.children.filter((t) => "lines" in t);
+    },
+    get lines() {
+      return this.children.reduce((t, r) => ("lines" in r ? t.push(...r.lines) : "words" in r && t.push(r), t), []);
+    },
+    get words() {
+      return this.lines.flatMap((t) => t.words);
+    },
+    get text() {
+      var t;
+      const r = [];
+      for (const [i, n] of this.children.entries())
+        r.push(n.text), i < this.children.length - 1 && !((t = n.words.slice(-1)[0]) != null && t.hyphenStart) && (n.type === "line" ? r.push(" ") : r.push(`
+`));
+      return r.join("");
+    }
+  };
+}
+function Xn(e) {
+  return {
+    ...e,
+    type: "page",
+    children: [],
+    get blocks() {
+      return this.children.filter((t) => "paragraphs" in t);
+    },
+    get paragraphs() {
+      return this.children.reduce((t, r) => ("paragraphs" in r ? t.push(...r.paragraphs) : "lines" in r && t.push(r), t), []);
+    },
+    get lines() {
+      return this.children.reduce((t, r) => ("lines" in r ? t.push(...r.lines) : "words" in r && t.push(r), t), []);
+    },
+    get words() {
+      return this.children.flatMap((t) => t.words);
+    },
+    get text() {
+      var t;
+      const r = [];
+      for (const [i, n] of this.children.entries())
+        r.push(n.text), i < this.children.length - 1 && !((t = n.words.slice(-1)[0]) != null && t.hyphenStart) && (n.type === "line" ? r.push(" ") : r.push(`
+`));
+      return r.join("");
+    }
+  };
+}
+var Ri = "2.2.4", Pr = null;
+async function Kn(e = () => fetch(`https://unpkg.com/sax-wasm@${Ri}/lib/sax-wasm.wasm`).then((t) => t.arrayBuffer()).then((t) => new Uint8Array(t))) {
+  Pr = await e();
+}
+function Xt() {
+  return Pr !== null;
+}
+async function Zn(e, t) {
+  const r = new nc(
+    e,
+    /* @__PURE__ */ new Set([
+      N.OpenTag,
+      N.Text,
+      N.CloseTag
+    ]),
+    {
+      highWaterMark: 65536
+    }
+  );
+  if (!Xt())
+    throw new Error(
+      "XML parser WASM not initialized, call initialize() first!"
+    );
+  if (!await r.prepareWasm(Pr))
+    throw new Error("Failed to initialize parser with WASM");
+  return r;
+}
+var tc = /&#(\d+);/g, rc = /&#x([A-Fa-f0-9]+);/g, es = {
+  amp: "&",
+  apos: "'",
+  quot: '"',
+  lt: "<",
+  gt: ">"
+}, ic = new RegExp(
+  `&(${Object.keys(es).join("|")});`,
+  "g"
+);
+function xr(e) {
+  return e = e.replace(ic, function(t, r) {
+    return es[r];
+  }), e = e.replace(tc, function(t, r) {
+    const i = parseInt(r, 10);
+    return String.fromCharCode(i);
+  }), e = e.replace(rc, function(t, r) {
+    const i = parseInt(r, 16);
+    return String.fromCharCode(i);
+  }), e;
+}
+function ts(e) {
+  const t = new TextEncoder();
+  return new ReadableStream({
+    start(r) {
+      r.enqueue(
+        e instanceof Uint8Array ? e : t.encode(e)
+      ), r.close();
+    }
+  });
+}
+function Ue(e, t) {
+  var r;
+  const i = e.attributes.find((n) => n.name.value === t);
+  return (r = i == null ? void 0 : i.value) == null ? void 0 : r.value;
+}
+function Mi(e) {
+  return Object.fromEntries(
+    e.attributes.map((t) => [t.name.value, t.value.value])
+  );
+}
+var nc = class {
+  constructor(e, t, r) {
+    this.accumulator = [], this.readable = e;
+    let i;
+    if (t) {
+      i = 0;
+      for (const n of t)
+        i |= n;
+    }
+    this.saxParser = new ci(i, r), this.saxParser.eventHandler = (n, s) => this.accumulator.push([n, s]);
+  }
+  prepareWasm(e) {
+    return this.saxParser.prepareWasm(Pr);
+  }
+  [Symbol.asyncIterator]() {
+    return this.iterate();
+  }
+  async *iterate() {
+    const e = this.readable.getReader();
+    try {
+      for (; ; ) {
+        const t = await e.read();
+        if (t.done)
+          break;
+        for (this.saxParser.write(t.value); this.accumulator.length > 0; )
+          yield this.accumulator.shift();
+      }
+    } finally {
+      e.releaseLock();
+    }
+    for (; this.accumulator.length > 0; )
+      yield this.accumulator.shift();
+  }
+};
+function jr(e, t = "log", r) {
+  console[t](
+    `At line ${r.openStart.line}, column ${r.openStart.character}: ${e}`
+  );
+}
+function ir(e) {
+  const t = Ue(e, "title");
+  return t ? t.split(";").map((i) => i.trim()).reduce((i, n) => {
+    const s = n.split(" ")[0];
+    return s === "bbox" ? i[s] = n.split(" ").slice(1, 5).map((a) => Number.parseInt(a, 10)) : (i[s] = n.split(" ").slice(1, 5).join(" "), i[s].startsWith('"') && i[s].endsWith('"') && (i[s] = i[s].slice(1, -1))), i;
+  }, {}) : {};
+}
+function $r(e, t) {
+  return e.split(" ").map((r) => Number.parseFloat(r)).reduce((r, i) => {
+    const n = r.slice(-1)[0];
+    return !n || n.length === 2 ? r.push([i]) : n.push(i), r;
+  }, []).map(([r, i]) => ({ x: t * r, y: t * i }));
+}
+async function Fr(e, t, r) {
+  let i = 0, n;
+  for (; i >= 0 && !(n = await e.next()).done; ) {
+    const [s, a] = n.value;
+    if (s === N.Text && t.has("text")) {
+      const h = r.elementStack.slice(-1)[0];
+      if (typeof h != "string" && h.type === "line") {
+        const l = a.value.replace(/\s+/g, " "), u = l === " ";
+        (h.children.length > 0 || !u) && !(h.children.slice(-1)[0] === " " && u) && h.children.push(l);
+      }
+    }
+    if (s === N.CloseTag && i--, s !== N.OpenTag)
+      continue;
+    i++;
+    const o = a, c = Ni(o);
+    if (c !== null) {
+      if (!t.has(c)) {
+        jr(
+          `Unexpected hOCR element type: ${c}, expected one of [${Array.from(
+            t
+          ).join(", ")}]`,
+          "warn",
+          o
+        );
+        continue;
+      }
+      switch (c) {
+        case "block":
+          await ac(e, o, r), i--;
+          break;
+        case "paragraph":
+          await oc(e, o, r), i--;
+          break;
+        case "line":
+          await cc(e, o, r), i--;
+          break;
+        case "word":
+          await lc(e, o, r), i--;
+          break;
+      }
+    }
+  }
+  r.elementStack.pop();
+}
+async function sc(e, t, r, i) {
+  var n;
+  const s = ir(t), a = s.bbox;
+  r.scaleFactor = i ? hc(a, i) : 1;
+  const o = Xn({
+    features: [],
+    width: a[2] * r.scaleFactor,
+    height: a[3] * r.scaleFactor
+  });
+  "ppageno" in s && (o.physicalPageNumber = Number.parseInt(s.ppageno, 10)), "lpageno" in s && (o.logicalPageNumber = s.lpageno), "image" in s && (o.imageSource = {
+    fileName: s.image
+  }), "x_source" in s && (o.imageSource || (o.imageSource = {}), o.imageSource.documentIdentifier = s.x_source), "imagemd5" in s && (o.imageSource || (o.imageSource = {}), o.imageSource.checksum = s.imagemd5, o.imageSource.checksumType = "MD5"), "scan_res" in s && (o.imageSource || (o.imageSource = {}), o.imageSource.ppi = Number.parseInt(s.scan_res.split(" ")[0], 10)), r.elementStack.push(o), await Fr(
+    e,
+    /* @__PURE__ */ new Set(["block", "paragraph", "line"]),
+    r
+  );
+  for (const c of ["blocks", "paragraphs", "lines"])
+    ((n = o[c]) != null ? n : []).some((h) => h.polygon !== void 0) && o.features.push("POLYGONS");
+  return o.words.some((c) => c.choices !== void 0) && o.features.push("CHOICES"), o.words.some((c) => c.hyphenStart) && o.features.push("HYPHEN"), o.words.some((c) => c.confidence !== void 0) && o.features.push("CONFIDENCE"), o;
+}
+async function ac(e, t, r) {
+  const i = ir(t), [n, s, a, o] = i.bbox.map(
+    (h) => h * r.scaleFactor
+  ), c = Jn({
+    x: n,
+    y: s,
+    width: a - n,
+    height: o - s
+  });
+  "poly" in i && (c.polygon = $r(i.poly, r.scaleFactor)), r.elementStack.slice(-1)[0].children.push(c), r.elementStack.push(c), await Fr(e, /* @__PURE__ */ new Set(["paragraph", "line"]), r);
+}
+async function oc(e, t, r) {
+  const i = ir(t);
+  let n, s, a, o;
+  if (i.bbox) {
+    const l = i.bbox.map(
+      (u) => u * r.scaleFactor
+    );
+    n = l[0], s = l[1], a = l[2] - n, o = l[3] - s;
+  }
+  const c = ec({
+    x: n,
+    y: s,
+    width: a,
+    height: o
+  });
+  "poly" in i && (c.polygon = $r(i.poly, r.scaleFactor)), r.elementStack.slice(-1)[0].children.push(c), r.elementStack.push(c), await Fr(e, /* @__PURE__ */ new Set(["line"]), r);
+}
+async function cc(e, t, r) {
+  const i = ir(t);
+  if (!("bbox" in i)) {
+    jr("Missing bbox attribute on line element", "warn", t);
+    return;
+  }
+  const [n, s, a, o] = i.bbox.map(
+    (u) => u * r.scaleFactor
+  ), c = Vn({
+    x: n,
+    y: s,
+    width: a - n,
+    height: o - s
+  });
+  if ("poly" in i && (c.polygon = $r(i.poly, r.scaleFactor)), "baseline" in i) {
+    const u = i.baseline.split(" "), f = Number.parseFloat(u[0]), p = Number.parseInt(u[1], 10), d = c.x, m = c.y;
+    c.baseline = [
+      { x: d, y: m + p },
+      { x: d + c.width, y: m + p + c.width * f }
+    ];
+  }
+  if (r.elementStack.slice(-1)[0].children.push(c), r.elementStack.push(c), await Fr(e, /* @__PURE__ */ new Set(["word", "text"]), r), c.children.slice(-1)[0] === " " && (c.children = c.children.slice(0, -1)), c.words.some(
+    (u) => u.confidence !== void 0 && u.confidence > 1
+  ))
+    for (const u of c.words)
+      u.confidence !== void 0 && (u.confidence /= 100);
+}
+async function lc(e, t, r) {
+  const i = ir(t), [n, s, a, o] = i.bbox.map(
+    (f) => f * r.scaleFactor
+  );
+  let c = "", h, l = 0;
+  for (; l >= 0; ) {
+    const f = await e.next();
+    if (f.done)
+      throw new Error("Unexpected end of stream while parsing word");
+    const [p, d] = f.value;
+    if (p === N.OpenTag) {
+      l++;
+      const m = d;
+      m.name === "span" && Ni(m) === "alternatives" && (h = []);
+    } else if (p === N.CloseTag) {
+      l--;
+      const m = d;
+      if (h && m.name === "ins")
+        c = m.textNodes.map((g) => g.value.trim()).join("");
+      else if (h && m.name === "del") {
+        const g = Ue(m, "nlp"), y = {
+          text: m.textNodes.map((b) => b.value.trim()).join("")
+        };
+        y.text.includes("&") && (y.text = xr(y.text)), g && (y.probability = Math.exp(-Number.parseFloat(g))), h.push(y);
+      }
+    } else if (p === N.Text && !h) {
+      const m = d.value;
+      c += m.trim();
+    }
+  }
+  if (!c.length) {
+    jr("Word element has no text, skipping.", "debug", t);
+    return;
+  }
+  const u = {
+    type: "word",
+    x: n,
+    y: s,
+    width: a - n,
+    height: o - s,
+    text: c
+  };
+  h != null && h.length && (u.choices = h), u.hyphenStart = u.text.endsWith(""), u.hyphenStart && (u.text = u.text.slice(0, -1)), u.text.includes("&") && (u.text = xr(u.text)), "poly" in i && (u.polygon = $r(i.poly, r.scaleFactor)), "x_wconf" in i && (u.confidence = Number.parseFloat(i.x_wconf)), r.elementStack.slice(-1)[0].children.push(u);
+}
+function hc(e, t) {
+  if (e[2] === t.width && e[3] === t.height)
+    return 1;
+  const r = t.width / e[2], i = t.height / e[3], n = Math.round(i * e[2]), s = Math.round(r * e[3]);
+  return (n !== t.width || s !== t.height) && console.warn(
+    `Differing scale factors for x and y axis while parsing hOCR, will use X factor: x=${r}, y=${i}`
+  ), r;
+}
+function Ni(e) {
+  switch (Ue(e, "class")) {
+    case "ocr_page":
+      return "page";
+    case "ocr_carea":
+    case "ocrx_block":
+      return "block";
+    case "ocr_par":
+      return "paragraph";
+    case "ocr_line":
+    case "ocrx_line":
+      return "line";
+    case "ocrx_word":
+      return "word";
+    case "ocrx_cinfo":
+      return "char";
+    case "alternatives":
+      return "alternatives";
+    case "alt":
+      return "alt";
+    default:
+      return null;
+  }
+}
+async function* uc(e, t) {
+  var r;
+  if (Array.isArray(t)) {
+    const h = t;
+    t = (l) => {
+      var u;
+      return (u = h[l]) != null ? u : null;
+    };
+  }
+  const i = typeof e == "string" || e instanceof Uint8Array ? ts(e) : e, n = await Zn(i), s = {
+    scaleFactor: 1,
+    elementStack: []
+  };
+  let a = 0;
+  const o = n.iterate();
+  let c;
+  for (; !(c = await o.next()).done; ) {
+    const [h, l] = c.value;
+    if (h !== N.OpenTag || l.name !== "div" || Ni(l) !== "page")
+      continue;
+    const u = await sc(
+      o,
+      l,
+      s,
+      (r = t == null ? void 0 : t(a, Mi(l))) != null ? r : void 0
+    );
+    u && (yield u);
+  }
+}
+var fc = ["HEIGHT", "WIDTH", "HPOS", "VPOS", "WC"];
+function dc(e, t) {
+  return Object.fromEntries(
+    e.attributes.filter((r) => !t || t.includes(r.name.value)).map((r) => [
+      r.name.value,
+      fc.includes(r.name.value) ? Number.parseFloat(r.value.value) : r.value.value
+    ])
+  );
+}
+function Er(e) {
+  const t = dc(e, ["HEIGHT", "WIDTH", "HPOS", "VPOS"]);
+  return {
+    height: t.HEIGHT,
+    width: t.WIDTH,
+    x: t.HPOS,
+    y: t.VPOS
+  };
+}
+async function pc(e, t, r, i) {
+  var n;
+  const s = Er(r);
+  if (!s.width || !s.height)
+    throw new Error("Could not get Page dimensions");
+  const a = i ? i.width / s.width : 1, o = i ? i.height / s.height : 1;
+  a !== o && console.warn(
+    `Scale factors differ: x=${a} vs y=${o}, using X scale factor.`
+  ), t.scaleFactor = a;
+  const c = Xn({
+    features: [],
+    width: s.width * a,
+    height: s.height * a
+  });
+  t.elementStack.push(c);
+  const h = Mi(r);
+  "PHYSICAL_IMG_NR" in h && (c.physicalPageNumber = Number.parseInt(h.PHYSICAL_IMG_NR)), "PRINTED_IMG_NR" in h && (c.logicalPageNumber = h.PRINTED_IMG_NR);
+  let l = 0, u;
+  for (; l >= 0 && !(u = await e.next()).done; ) {
+    const [f, p] = u.value;
+    if (f === N.CloseTag)
+      l--;
+    else if (f !== N.OpenTag)
+      continue;
+    l++, p.name === "TextBlock" && await gc(e, t, p);
+  }
+  t.elementStack.pop();
+  for (const f of ["blocks", "paragraphs", "lines"])
+    ((n = c[f]) != null ? n : []).some((p) => p.polygon !== void 0) && c.features.push("POLYGONS");
+  return c.words.some((f) => f.choices !== void 0) && c.features.push("CHOICES"), c.words.some((f) => f.hyphenStart) && c.features.push("HYPHEN"), c.words.some((f) => f.confidence !== void 0) && c.features.push("CONFIDENCE"), t.sourceImageInformation && (c.imageSource = t.sourceImageInformation, t.sourceImageInformation = void 0), c;
+}
+async function gc(e, t, r) {
+  const i = Er(r), n = Jn({
+    x: i.x ? i.x * t.scaleFactor : -1,
+    y: i.y ? i.y * t.scaleFactor : -1,
+    width: i.width ? i.width * t.scaleFactor : -1,
+    height: i.height ? i.height * t.scaleFactor : -1
+  });
+  t.elementStack.slice(-1)[0].children.push(n), t.elementStack.push(n);
+  let s = 0, a;
+  for (; s >= 0 && !(a = await e.next()).done; ) {
+    const [o, c] = a.value;
+    if (o === N.CloseTag)
+      s--;
+    else if (o !== N.OpenTag)
+      continue;
+    s++;
+    const h = c;
+    if (h.name === "TextLine")
+      await mc(e, t, c);
+    else if (h.name === "Shape") {
+      const l = await Di(e, t);
+      l != null && (n.polygon = l);
+    }
+  }
+  t.elementStack.pop();
+}
+async function mc(e, t, r) {
+  const i = Er(r), n = Vn({
+    x: i.x ? i.x * t.scaleFactor : -1,
+    y: i.y ? i.y * t.scaleFactor : -1,
+    width: i.width ? i.width * t.scaleFactor : -1,
+    height: i.height ? i.height * t.scaleFactor : -1
+  });
+  t.elementStack.slice(-1)[0].children.push(n), t.elementStack.push(n);
+  let s = 0, a;
+  for (; s >= 0 && !(a = await e.next()).done; ) {
+    const [o, c] = a.value;
+    if (o === N.CloseTag && s--, o !== N.OpenTag)
+      continue;
+    s++;
+    const h = c;
+    if (h.name === "String")
+      await vc(e, t, c), s--;
+    else if (h.name === "SP")
+      n.children.push(" ");
+    else if (h.name === "Shape") {
+      const l = await Di(e, t);
+      l != null && (n.polygon = l);
+    }
+  }
+  t.elementStack.pop(), n.children.find((o) => o === " ") || (n.children = n.children.flatMap(
+    (o, c) => c === n.children.length - 1 ? [o] : [o, " "]
+  ));
+}
+async function Di(e, t, r) {
+  let i = null, n = 0, s;
+  for (; n >= 0 && !(s = await e.next()).done; ) {
+    const [o, c] = s.value;
+    if (o === N.CloseTag && n--, o !== N.OpenTag)
+      continue;
+    n++;
+    const h = c;
+    if (h.name === "Polygon") {
+      const l = Ue(h, "POINTS");
+      if (!l) {
+        jr(
+          "<Polygon> without POINTS attribute, ignoring",
+          "warn",
+          h
+        );
+        continue;
+      }
+      i = l.split(" ").map((u) => u.split(/(,| )/).map((f) => Number.parseFloat(f))).reduce((u, [f]) => {
+        const p = u.slice(-1)[0];
+        return !p || p.length === 2 ? u.push([f]) : p.push(f), u;
+      }, []).map(([u, f]) => ({ x: u * t.scaleFactor, y: f * t.scaleFactor }));
+    }
+  }
+  const a = t.elementStack.slice(-1)[0];
+  if (a.x < 0 || a.y < 0 || a.width < 0 || a.height < 0)
+    if (i)
+      a.x = Math.min(...i.map((o) => o.x)), a.y = Math.min(...i.map((o) => o.y)), a.width = Math.max(...i.map((o) => o.x)) - a.x, a.height = Math.max(...i.map((o) => o.y)) - a.y;
+    else
+      throw new Error(
+        `Could not get dimensions for ${a.type}, no HPOS/VPOS/WIDTH/HEIGHT attribs and no associated Shape`
+      );
+  return i;
+}
+async function vc(e, t, r) {
+  const i = Er(r);
+  let n = Ue(r, "CONTENT");
+  if (!n)
+    throw new Error("Could not get String text");
+  n.includes("&") && (n = xr(n));
+  const s = {
+    type: "word",
+    x: i.x ? i.x * t.scaleFactor : -1,
+    y: i.y ? i.y * t.scaleFactor : -1,
+    width: i.width ? i.width * t.scaleFactor : -1,
+    height: i.height ? i.height * t.scaleFactor : -1,
+    text: n
+  };
+  t.elementStack.push(s), Ue(r, "SUBS_TYPE") === "HypPart1" && (s.hyphenStart = !0);
+  const o = Ue(r, "WC");
+  o !== void 0 && (s.confidence = Number.parseFloat(o));
+  let c = 0, h;
+  for (; c >= 0 && !(h = await e.next()).done; ) {
+    const [u, f] = h.value;
+    if (u === N.CloseTag) {
+      if (c--, f.name === "ALTERNATIVE") {
+        "choices" in s || (s.choices = []);
+        let p = f.textNodes.filter((d) => d.value.trim() !== "").map((d) => d.value.trim()).join("");
+        p.includes("&") && (p = xr(p)), s.choices.push({
+          text: p
+        });
+      }
+    } else if (u === N.OpenTag && (c++, f.name === "Shape")) {
+      const p = await Di(e, t);
+      c--, p != null && (s.polygon = p);
+    }
+  }
+  t.elementStack.slice(-2)[0].children.push(s), t.elementStack.pop();
+}
+async function yc(e, t, r) {
+  let i = 0, n;
+  for (t.sourceImageInformation = {}; i >= 0 && !(n = await e.next()).done; ) {
+    const [s, a] = n.value, o = a;
+    if (s === N.CloseTag) {
+      if (i--, o.name === "fileName")
+        t.sourceImageInformation.fileName = o.textNodes.map((c) => c.value).join("");
+      else if (o.name === "fileIdentifier") {
+        let c = o.textNodes.map((l) => l.value).join("");
+        const h = Ue(o, "fileIdentifierLocation");
+        h && (c = `${h}:${c}`), t.sourceImageInformation.fileIdentifier = c;
+      } else if (o.name === "documentIdentifier") {
+        let c = o.textNodes.map((l) => l.value).join("");
+        const h = Ue(o, "documentIdentifierLocation");
+        h && (c = `${h}:${c}`), t.sourceImageInformation.documentIdentifier = c;
+      }
+    } else s === N.OpenTag && i++;
+  }
+}
+async function* bc(e, t) {
+  var r;
+  if (Array.isArray(t)) {
+    const h = t;
+    t = (l) => {
+      var u;
+      return (u = h[l]) != null ? u : null;
+    };
+  }
+  const i = typeof e == "string" || e instanceof Uint8Array ? ts(e) : e, n = await Zn(i), s = {
+    scaleFactor: 1,
+    elementStack: []
+  }, a = n.iterate();
+  let o, c = 0;
+  for (; !(o = await a.next()).done; ) {
+    const [h, l] = o.value;
+    if (h === N.CloseTag && l.name === "MeasurementUnit") {
+      const f = l.textNodes[0].value.trim();
+      if (f !== "pixel" && !t)
+        throw new Error(`Measurement unit ${f} requires a reference size.`);
+    }
+    if (h !== N.OpenTag)
+      continue;
+    const u = l;
+    if (u.name === "Page") {
+      const f = await pc(
+        a,
+        s,
+        l,
+        (r = t == null ? void 0 : t(c, Mi(l))) != null ? r : void 0
+      );
+      f && (yield f, c++);
+    } else u.name === "sourceImageInformation" && await yc(a, s);
+  }
+}
+let yt = null;
+function tn() {
+  return typeof window < "u" && window.performance ? window.performance.now() : Date.now();
+}
+function bt(e) {
+  return e != null && e !== null && e !== void 0;
+}
+const wc = (() => {
+  const e = new Int32Array(256);
+  for (let t = 0; t < 256; ++t) {
+    let r = t, i = 9;
+    for (; --i; ) r = (r & 1 && -306674912) ^ r >>> 1;
+    e[t] = r;
+  }
+  return e;
+})();
+function rs(e) {
+  let t = -1;
+  for (let r = 0; r < e.length; ++r)
+    t = wc[t & 255 ^ e[r]] ^ t >>> 8;
+  return ~t;
+}
+function Li() {
+  var e;
+  return typeof process < "u" && typeof ((e = process.versions) == null ? void 0 : e.node) < "u";
+}
+function is(e) {
+  yt = e;
+}
+function xc() {
+  return typeof crypto < "u" && crypto.randomUUID ? crypto.randomUUID() : "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g, function(e) {
+    return e !== "x" ? e : ((Math.random() * 16 | 0) & 3 | 8).toString(16);
+  });
+}
+let Ee;
+Li() && (Ee = {
+  pageGenerationDuration: new sr.Histogram({
+    name: "pdiiif_page_generation_duration_seconds",
+    help: "Latency for generating the PDF for a single page",
+    buckets: [1e-3, 5e-3, 0.015, 0.05, 0.1, 0.5, 1, 2],
+    labelNames: ["status"]
+  }),
+  imageFetchDuration: new sr.Histogram({
+    name: "pdiiif_image_fetch_duration_seconds",
+    help: "Latency for fetching data from IIIF Image API endpoints",
+    buckets: [0.01, 0.05, 0.15, 0.5, 1, 5, 10],
+    labelNames: ["status", "iiif_host", "limited"]
+  }),
+  imageInfoDuration: new sr.Histogram({
+    name: "pdiiif_image_info_duration_seconds",
+    help: "Latency for fetching info from IIIF Image API endpoints",
+    buckets: [0.01, 0.05, 0.15, 0.5, 1, 5, 10],
+    labelNames: ["status", "iiif_host", "limited"]
+  }),
+  ocrFetchDuration: new sr.Histogram({
+    name: "pdiiif_ocr_fetch_duration_seconds",
+    help: "Latency for fetching OCR data",
+    buckets: [0.01, 0.05, 0.15, 0.5, 1, 5, 10],
+    labelNames: ["status", "ocr_host", "limited"]
+  })
+});
+const Cc = {};
+var rn = (e) => {
+  let t;
+  const r = /* @__PURE__ */ new Set(), i = (l, u) => {
+    const f = typeof l == "function" ? l(t) : l;
+    if (!Object.is(f, t)) {
+      const p = t;
+      t = u ?? (typeof f != "object" || f === null) ? f : Object.assign({}, t, f), r.forEach((d) => d(t, p));
+    }
+  }, n = () => t, c = { setState: i, getState: n, getInitialState: () => h, subscribe: (l) => (r.add(l), () => r.delete(l)), destroy: () => {
+    (Cc ? "production" : void 0) !== "production" && console.warn(
+      "[DEPRECATED] The `destroy` method will be unsupported in a future version. Instead use unsubscribe function returned by subscribe. Everything will be garbage-collected if store is garbage-collected."
+    ), r.clear();
+  } }, h = t = e(i, n, c);
+  return c;
+}, ns = (e) => e ? rn(e) : rn, ss = "http://library.stanford.edu/iiif/image-api/compliance.html#level0", as = "http://library.stanford.edu/iiif/image-api/compliance.html#level1", os = "http://library.stanford.edu/iiif/image-api/compliance.html#level2", cs = "http://library.stanford.edu/iiif/image-api/conformance.html#level0", ls = "http://library.stanford.edu/iiif/image-api/conformance.html#level1", hs = "http://library.stanford.edu/iiif/image-api/conformance.html#level2", us = "http://library.stanford.edu/iiif/image-api/1.1/compliance.html#level0", fs = "http://library.stanford.edu/iiif/image-api/1.1/compliance.html#level1", ds = "http://library.stanford.edu/iiif/image-api/1.1/compliance.html#level2", ps = "http://library.stanford.edu/iiif/image-api/1.1/conformance.html#level0", gs = "http://library.stanford.edu/iiif/image-api/1.1/conformance.html#level1", ms = "http://library.stanford.edu/iiif/image-api/1.1/conformance.html#level2", vs = "http://iiif.io/api/image/1/level0.json", ys = "http://iiif.io/api/image/1/profiles/level0.json", bs = "http://iiif.io/api/image/1/level1.json", ws = "http://iiif.io/api/image/1/profiles/level1.json", xs = "http://iiif.io/api/image/1/level2.json", Cs = "http://iiif.io/api/image/1/profiles/level2.json", Ss = "http://iiif.io/api/image/2/level0.json", As = "http://iiif.io/api/image/2/profiles/level0.json", _s = "http://iiif.io/api/image/2/level1.json", Os = "http://iiif.io/api/image/2/profiles/level1.json", ks = "http://iiif.io/api/image/2/level2.json", Is = "http://iiif.io/api/image/2/profiles/level2.json", Ts = "level0", Ps = "level1", js = "level2", $s = "http://iiif.io/api/image/2/level0", Fs = "http://iiif.io/api/image/2/level1", Es = "http://iiif.io/api/image/2/level2", Rr = [Es, os, hs, ds, ms, xs, Cs, ks, Is, js], Wi = [...Rr, Fs, as, ls, fs, gs, bs, ws, _s, Os, Ps], Rs = [$s, Fs, Es, ss, as, os, cs, ls, hs, us, fs, ds, ps, gs, ms, vs, ys, bs, ws, xs, Cs, Ss, As, _s, Os, ks, Is, Ts, Ps, js], Sc = Rs, Ms = [$s, ss, cs, us, ps, vs, ys, Ss, As, Ts], Ac = { extraFormats: ["jpg"], extraQualities: ["default"], extraFeatures: ["sizeByWhListed"] }, _c = { extraFormats: ["jpg"], extraQualities: ["default"], extraFeatures: ["baseUriRedirect", "cors", "jsonldMediaType", "regionByPx", "regionSquare", "sizeByWhListed", "sizeByH", "sizeByW", "sizeByWh"] }, Oc = { extraFormats: ["jpg", "png"], extraQualities: ["default"], extraFeatures: ["baseUriRedirect", "cors", "jsonldMediaType", "regionByPct", "regionByPx", "regionSquare", "rotationBy90s", "sizeByWhListed", "sizeByConfinedWh", "sizeByH", "sizeByPct", "sizeByW", "sizeByWh"] };
+function Me(e) {
+  for (let t in e) (typeof e[t] > "u" || e[t] === null) && delete e[t];
+  return e;
+}
+function ht(e) {
+  return Array.isArray(e) ? e : e ? [e] : [];
+}
+var kc = Object.defineProperty, Ic = (e, t, r) => t in e ? kc(e, t, { enumerable: !0, configurable: !0, writable: !0, value: r }) : e[t] = r, Ye = (e, t, r) => (Ic(e, typeof t != "symbol" ? t + "" : t, r), r), nn = ["sc:Collection", "sc:Manifest", "sc:Canvas", "sc:AnnotationList", "oa:Annotation", "sc:Range", "sc:Layer", "sc:Sequence", "oa:Choice", "Service", "ContentResource"];
+function Tc(e) {
+  if (typeof e > "u" || e === null) throw new Error("Null or undefined is not a valid entity.");
+  if (Array.isArray(e)) throw new Error("Array is not a valid entity");
+  if (typeof e != "object") throw new Error(`${typeof e} is not a valid entity`);
+  if (typeof e["@type"] == "string") {
+    let t = nn.indexOf(e["@type"]);
+    if (t !== -1) return nn[t];
+  }
+  if (e.profile) return "Service";
+  if (e.format || e["@type"]) return "ContentResource";
+  throw new Error("Resource type is not known");
+}
+var Pc = class Ns {
+  constructor(t, r = {}) {
+    Ye(this, "traversals"), Ye(this, "options"), this.traversals = { collection: [], manifest: [], canvas: [], annotationList: [], sequence: [], annotation: [], contentResource: [], choice: [], range: [], service: [], layer: [], ...t }, this.options = { convertPropsToArray: !0, mergeMemberProperties: !0, allowUndefinedReturn: !1, ...r };
+  }
+  static all(t) {
+    return new Ns({ collection: [t], manifest: [t], canvas: [t], annotationList: [t], sequence: [t], annotation: [t], contentResource: [t], choice: [t], range: [t], service: [t], layer: [t] });
+  }
+  traverseCollection(t) {
+    return this.traverseType(this.traverseDescriptive(this.traverseLinking(this.traverseCollectionItems(t))), this.traversals.collection);
+  }
+  traverseCollectionItems(t) {
+    if (this.options.mergeMemberProperties) {
+      let r = [...(t.manifests || []).map((i) => typeof i == "string" ? { "@id": i, "@type": "sc:Manifest" } : i), ...(t.collections || []).map((i) => typeof i == "string" ? { "@id": i, "@type": "sc:Collection" } : i), ...t.members || []];
+      delete t.collections, delete t.manifests, t.members = r;
+    }
+    return t.manifests && (t.manifests = t.manifests.map((r) => this.traverseManifest(typeof r == "string" ? { "@id": r, "@type": "sc:Manifest" } : r))), t.collections && (t.collections = t.collections.map((r) => this.traverseCollection(typeof r == "string" ? { "@id": r, "@type": "sc:Collection" } : r))), t.members && (t.members = t.members.map((r) => typeof r == "string" ? r : this.traverseUnknown(r))), t;
+  }
+  traverseManifest(t) {
+    return this.traverseType(this.traverseDescriptive(this.traverseLinking(this.traverseManifestItems(t))), this.traversals.manifest);
+  }
+  traverseManifestItems(t) {
+    return t.sequences && (t.sequences = t.sequences.map((r) => this.traverseSequence(r))), t.structures && (t.structures = t.structures.map((r) => this.traverseRange(r))), t;
+  }
+  traverseSequence(t) {
+    return this.traverseType(this.traverseDescriptive(this.traverseLinking(this.traverseSequenceItems(t))), this.traversals.sequence);
+  }
+  traverseSequenceItems(t) {
+    return t.canvases && (t.canvases = t.canvases.map((r) => this.traverseCanvas(r))), t;
+  }
+  traverseCanvas(t) {
+    return this.traverseType(this.traverseDescriptive(this.traverseLinking(this.traverseCanvasItems(t))), this.traversals.canvas);
+  }
+  traverseCanvasItems(t) {
+    return t.images && (t.images = t.images.map((r) => this.traverseAnnotation(r))), t.otherContent && (t.otherContent = t.otherContent.map((r) => this.traverseAnnotationList(r))), t;
+  }
+  traverseRange(t) {
+    return this.traverseType(this.traverseDescriptive(this.traverseLinking(this.traverseRangeItems(t))), this.traversals.range);
+  }
+  traverseRangeItems(t) {
+    if (this.options.mergeMemberProperties) {
+      let r = [...(t.ranges || []).map((i) => typeof i == "string" ? { "@id": i, "@type": "sc:Range" } : i), ...(t.canvases || []).map((i) => typeof i == "string" ? { "@id": i, "@type": "sc:Canvas" } : i), ...t.members || []];
+      delete t.ranges, delete t.canvases, t.members = r.length ? r.map((i) => this.traverseUnknown(i)) : void 0;
+    }
+    return t;
+  }
+  traverseAnnotationList(t) {
+    let r = typeof t == "string" ? { "@id": t, "@type": "sc:AnnotationList" } : t;
+    return this.traverseType(this.traverseDescriptive(this.traverseAnnotationListItems(r)), this.traversals.annotationList);
+  }
+  traverseAnnotationListItems(t) {
+    return t.resources && (t.resources = t.resources.map((r) => this.traverseAnnotation(r))), t;
+  }
+  traverseAnnotation(t) {
+    return this.traverseType(this.traverseDescriptive(this.traverseLinking(this.traverseAnnotationItems(t))), this.traversals.annotation);
+  }
+  traverseAnnotationItems(t) {
+    return t.resource && (Array.isArray(t.resource) ? t.resource = t.resource.map((r) => this.traverseContentResource(r)) : t.resource = this.traverseContentResource(t.resource)), t.on, t;
+  }
+  traverseLayer(t) {
+    return this.traverseType(this.traverseLinking(this.traverseLayerItems(t)), this.traversals.layer);
+  }
+  traverseLayerItems(t) {
+    return t.otherContent && (t.otherContent = t.otherContent.map((r) => this.traverseAnnotationList(r))), t;
+  }
+  traverseChoice(t) {
+    return this.traverseType(this.traverseChoiceItems(t), this.traversals.choice);
+  }
+  traverseChoiceItems(t) {
+    return t.default && t.default !== "rdf:nil" && (t.default = this.traverseContentResource(t.default)), t.item && t.item !== "rdf:nil" && (t.item = t.item.map((r) => this.traverseContentResource(r))), t;
+  }
+  traverseService(t) {
+    return this.traverseType(this.traverseLinking(t), this.traversals.service);
+  }
+  traverseContentResource(t) {
+    return t["@type"] === "oa:Choice" ? this.traverseChoice(t) : this.traverseType(this.traverseDescriptive(this.traverseLinking(t)), this.traversals.contentResource);
+  }
+  traverseUnknown(t) {
+    if (!t["@type"] || typeof t == "string") return t;
+    switch (Tc(t)) {
+      case "sc:Collection":
+        return this.traverseCollection(t);
+      case "sc:Manifest":
+        return this.traverseManifest(t);
+      case "sc:Canvas":
+        return this.traverseCanvas(t);
+      case "sc:Sequence":
+        return this.traverseSequence(t);
+      case "sc:Range":
+        return this.traverseRange(t);
+      case "oa:Annotation":
+        return this.traverseAnnotation(t);
+      case "sc:AnnotationList":
+        return this.traverseAnnotationList(t);
+      case "sc:Layer":
+        return this.traverseLayer(t);
+      case "Service":
+        return this.traverseService(t);
+      case "oa:Choice":
+        return this.traverseChoice(t);
+      case "ContentResource":
+        return this.traverseContentResource(t);
+    }
+    return t.profile ? this.traverseService(t) : t;
+  }
+  traverseImageResource(t) {
+    let r = Array.isArray(t), i = Array.isArray(t) ? t : [t], n = [];
+    for (let s of i) typeof s == "string" ? n.push(this.traverseContentResource({ "@id": s, "@type": "dctypes:Image" })) : n.push(this.traverseContentResource(s));
+    return !r && !this.options.convertPropsToArray ? n[0] : n;
+  }
+  traverseDescriptive(t) {
+    return t.thumbnail && (t.thumbnail = this.traverseImageResource(t.thumbnail)), t.logo && (t.logo = this.traverseImageResource(t.logo)), t;
+  }
+  traverseOneOrMoreServices(t) {
+    let r = Array.isArray(t), i = Array.isArray(t) ? t : [t], n = [];
+    for (let s of i) n.push(this.traverseService(s));
+    return !r && !this.options.convertPropsToArray ? n[0] : n;
+  }
+  traverseLinking(t) {
+    return t.related && (t.related = this.traverseOneOrManyType(t.related, this.traversals.contentResource)), t.rendering && (t.rendering = this.traverseOneOrManyType(t.rendering, this.traversals.contentResource)), t.service && (t.service = this.traverseOneOrMoreServices(t.service)), t.seeAlso && (t.seeAlso = this.traverseOneOrManyType(t.seeAlso, this.traversals.contentResource)), t.within && (typeof t.within == "string" || (t.within = this.traverseOneOrManyType(t.within, this.traversals.contentResource))), t.startCanvas && (typeof t.startCanvas == "string" ? t.startCanvas = this.traverseType({ "@id": t.startCanvas, "@type": "sc:Canvas" }, this.traversals.canvas) : t.startCanvas && this.traverseType(t.startCanvas, this.traversals.canvas)), t.contentLayer && (typeof t.contentLayer == "string" ? t.contentLayer = this.traverseLayer({ "@id": t.contentLayer, "@type": "sc:Layer" }) : t.contentLayer = this.traverseLayer(t.contentLayer)), t;
+  }
+  traverseOneOrManyType(t, r) {
+    if (!Array.isArray(t)) if (this.options.convertPropsToArray) t = [t];
+    else return this.traverseType(t, r);
+    return t.map((i) => this.traverseType(i, r));
+  }
+  traverseType(t, r) {
+    return r.reduce((i, n) => {
+      let s = n(i);
+      return typeof s > "u" && !this.options.allowUndefinedReturn ? i : s;
+    }, t);
+  }
+}, jc = "http://library.stanford.edu/iiif/image-api/compliance.html#level1", $c = "http://library.stanford.edu/iiif/image-api/compliance.html#level2", Fc = "http://library.stanford.edu/iiif/image-api/conformance.html#level1", Ec = "http://library.stanford.edu/iiif/image-api/conformance.html#level2", Rc = "http://library.stanford.edu/iiif/image-api/1.1/compliance.html#level1", Mc = "http://library.stanford.edu/iiif/image-api/1.1/compliance.html#level2", Nc = "http://library.stanford.edu/iiif/image-api/1.1/conformance.html#level1", Dc = "http://library.stanford.edu/iiif/image-api/1.1/conformance.html#level2", Lc = "http://iiif.io/api/image/1/level1.json", Wc = "http://iiif.io/api/image/1/profiles/level1.json", Uc = "http://iiif.io/api/image/1/level2.json", zc = "http://iiif.io/api/image/1/profiles/level2.json", Bc = "http://iiif.io/api/image/2/level1.json", qc = "http://iiif.io/api/image/2/profiles/level1.json", Hc = "http://iiif.io/api/image/2/level2.json", Qc = "http://iiif.io/api/image/2/profiles/level2.json", Gc = "level1", Yc = "level2", Vc = "http://iiif.io/api/image/2/level1", Jc = "http://iiif.io/api/image/2/level2", Xc = [Vc, Jc, jc, $c, Fc, Ec, Rc, Mc, Nc, Dc, Lc, Wc, Uc, zc, Bc, qc, Hc, Qc, Gc, Yc], li = { attributionLabel: "Attribution", providerId: "http://example.org/provider", providerName: "Unknown" };
+function Kc(e) {
+  if (typeof e == "string") return [e];
+  if (!e) return [];
+  let t = Array.isArray(e) ? e : [e], r = [];
+  for (let i of t) {
+    if (typeof i == "string") {
+      r.push(i);
+      continue;
+    }
+    r.push({ "@language": i["@language"] || i.language, "@value": i["@value"] || i.value });
+  }
+  return r;
+}
+function vt(e, t = "none") {
+  if (!e) return { none: [""] };
+  let r = Kc(e), i = {};
+  for (let n of r) {
+    if (typeof n == "string") {
+      i[t] = i[t] ? i[t] : [], i[t].push(n || "");
+      continue;
+    }
+    if (!n["@language"]) {
+      i[t] = i[t] ? i[t] : [], i[t].push(n["@value"] || "");
+      continue;
+    }
+    let s = n["@language"];
+    i[s] = i[s] ? i[s] : [], i[s].push(n["@value"] || "");
+  }
+  return Object.keys(i).length === 0 ? { none: [""] } : i;
+}
+function Ds(e) {
+  if (Array.isArray(e)) return Ds(e.find((t) => typeof t == "string"));
+  if (Rr.indexOf(e) !== -1) return "level2";
+  if (Xc.indexOf(e) !== -1) return "level1";
+  if (Sc.indexOf(e) !== -1) return "level0";
+  if (typeof e == "string") return e;
+}
+function Zc(e) {
+  let t = Array.isArray(e) ? e : [e];
+  for (let r of t) switch (r) {
+    case "http://iiif.io/api/image/2/context.json":
+    case "http://library.stanford.edu/iiif/image-api/1.1/compliance.html#level2":
+      return "ImageService2";
+    case "http://iiif.io/api/image/1/context.json":
+    case "http://library.stanford.edu/iiif/image-api/1.1/context.json":
+      return "ImageService1";
+    case "http://iiif.io/api/annex/openannotation/context.json":
+      return "ImageApiSelector";
+  }
+}
+function el(e) {
+  switch (e) {
+    case "http://iiif.io/api/image/2/level0.json":
+    case "http://iiif.io/api/image/2/level1.json":
+    case "http://iiif.io/api/image/2/level2.json":
+      return "ImageService2";
+    case "http://iiif.io/api/auth/1/kiosk":
+    case "http://iiif.io/api/auth/1/login":
+    case "http://iiif.io/api/auth/1/clickthrough":
+    case "http://iiif.io/api/auth/1/external":
+    case "http://iiif.io/api/auth/0/kiosk":
+    case "http://iiif.io/api/auth/0/login":
+    case "http://iiif.io/api/auth/0/clickthrough":
+    case "http://iiif.io/api/auth/0/external":
+      return "AuthCookieService1";
+    case "http://iiif.io/api/auth/1/token":
+    case "http://iiif.io/api/auth/0/token":
+      return "AuthTokenService1";
+    case "http://iiif.io/api/auth/1/logout":
+    case "http://iiif.io/api/auth/0/logout":
+      return "AuthLogoutService1";
+    case "http://iiif.io/api/search/1/search":
+    case "http://iiif.io/api/search/0/search":
+      return "SearchService1";
+    case "http://iiif.io/api/search/1/autocomplete":
+    case "http://iiif.io/api/search/0/autocomplete":
+      return "AutoCompleteService1";
+  }
+}
+function sn(e) {
+  for (let t of ["sc", "oa", "dcterms", "dctypes", "iiif"]) if (e.startsWith(`${t}:`)) return e.slice(t.length + 1);
+  return e;
+}
+var tl = ["Collection", "Manifest", "Annotation", "AnnotationPage", "Range", "Service"];
+function Ui(e) {
+  let t = e["@id"] || e.id, r = e["@type"] || e.type, i = e.profile || void 0, n = e["@context"] || void 0;
+  if (i) {
+    let s = el(i);
+    if (s) return s;
+  }
+  if (n) {
+    let s = Zc(n);
+    if (s) return s;
+  }
+  if (r) {
+    if (Array.isArray(r)) {
+      if (r.indexOf("oa:CssStylesheet") !== -1) return "CssStylesheet";
+      if (r.indexOf("cnt:ContentAsText") !== -1) return "TextualBody";
+      r = r[0];
+    }
+    for (let s of ["sc", "oa", "dcterms", "dctypes", "iiif"]) if (r.startsWith(`${s}:`)) {
+      r = r.slice(s.length + 1);
+      break;
+    }
+    switch (r) {
+      case "Layer":
+        return "AnnotationCollection";
+      case "AnnotationList":
+        return "AnnotationPage";
+      case "cnt:ContentAsText":
+        return "TextualBody";
+    }
+  }
+  if (r && tl.indexOf(r) !== -1) return r;
+  if (e.format) {
+    if (e.format.startsWith("image/")) return "Image";
+    if (e.format.startsWith("text/") || e.format === "application/pdf") return "Text";
+    if (e.format.startsWith("application/")) return "Dataset";
+  }
+  return t && (t.endsWith(".jpg") || t.endsWith(".png") || t.endsWith(".jpeg")) ? "Image" : r || "unknown";
+}
+var rl = /http(s)?:\/\/(creativecommons.org|rightsstatements.org)[^"'\\<\n]+/gm;
+function il(e) {
+  let t = e.match(rl);
+  return t ? t[0] : e;
+}
+function nl(e, t = "Rights/License", r = "none") {
+  let i = null, n = [], s = Array.isArray(e) ? e : [e];
+  for (let a of s) {
+    let o = a ? il(a) : void 0;
+    if (o && (o.indexOf("creativecommons.org") !== -1 || o.indexOf("rightsstatements.org") !== -1)) {
+      o.startsWith("https://") ? i = `http://${o.slice(8)}` : i = o;
+      continue;
+    }
+    o && n.push({ label: { [r]: [t] }, value: { [r]: [o] } });
+  }
+  return [i, n];
+}
+var sl = ["http://iiif.io/api/presentation/2/context.json", "http://iiif.io/api/image/2/context.json", "http://iiif.io/api/image/1/context.json", "http://library.stanford.edu/iiif/image-api/1.1/context.json", "http://iiif.io/api/search/1/context.json", "http://iiif.io/api/search/0/context.json", "http://iiif.io/api/auth/1/context.json", "http://iiif.io/api/auth/0/context.json", "http://iiif.io/api/annex/openannotation/context.json"];
+function al(e) {
+  if (e) {
+    let t = Array.isArray(e) ? e : [e], r = [];
+    for (let i of t) i === "http://iiif.io/api/presentation/2/context.json" && r.push("http://iiif.io/api/presentation/3/context.json"), sl.indexOf(i) === -1 && r.push(i);
+    if (t.length) return r.length === 1 ? r[0] : r;
+  }
+}
+function ol(e) {
+  return e ? e.map((t) => ({ label: vt(t.label), value: vt(t.value) })) : [];
+}
+var an = 0;
+function Ls(e, t) {
+  let r = encodeURI(e.id || e["@id"] || "").trim();
+  return r && t ? `${r}/${t}` : r || (an++, `http://example.org/${e["@type"]}${t ? `/${t}` : ""}/${an}`);
+}
+function Be(e) {
+  let t = [...e.behavior || []];
+  e.viewingHint && t.push(e.viewingHint);
+  let r;
+  return Array.isArray(e.motivation) ? r = e.motivation.map(sn) : e.motivation && (r = sn(e.motivation)), { "@context": e["@context"] ? al(e["@context"]) : void 0, id: (e["@id"] || Ls(e)).trim(), type: Ui(e), behavior: t.length ? t : void 0, height: e.height ? e.height : void 0, width: e.width ? e.width : void 0, motivation: r, viewingDirection: e.viewingDirection, profile: e.profile, format: e.format ? e.format : void 0, duration: void 0, timeMode: void 0 };
+}
+function qe(e) {
+  let [t, r] = nl(e.license), i = [...e.metadata ? ol(e.metadata) : [], ...r];
+  return { rights: t, metadata: i.length ? i : void 0, label: e.label ? vt(e.label) : void 0, requiredStatement: e.attribution ? { label: vt(li.attributionLabel), value: vt(e.attribution) } : void 0, navDate: e.navDate, summary: e.description ? vt(e.description) : void 0, thumbnail: cl(e.thumbnail) };
+}
+function cl(e) {
+  return e && (Array.isArray(e) ? e : [e]).map((t) => typeof t == "string" ? { id: t, type: "Image" } : (t.type === "unknown" && (t.type = "Image"), t));
+}
+function ll(e) {
+  if (!e.within) return;
+  let t = Array.isArray(e.within) ? e.within : [e.within], r = [];
+  for (let i of t) if (typeof i == "string") {
+    if (i) switch (e["@type"]) {
+      case "sc:Manifest":
+        r.push({ id: i, type: "Collection" });
+        break;
+    }
+  } else i["@id"] && r.push({ id: i["@id"], type: Ui(i) });
+  return r.length ? r : void 0;
+}
+function nt(e) {
+  let t = e.related ? Array.isArray(e.related) ? e.related : [e.related] : [], r = e.contentLayer;
+  return { provider: e.logo || t.length ? [{ id: li.providerId, type: "Agent", homepage: t.length ? [t[0]] : void 0, logo: e.logo ? Array.isArray(e.logo) ? e.logo : [e.logo] : void 0, label: vt(li.providerName) }] : void 0, partOf: ll(e), rendering: e.rendering, seeAlso: e.seeAlso, start: e.startCanvas, service: e.service ? ht(e.service) : void 0, supplementary: r ? [r] : void 0 };
+}
+function hl(e) {
+  return { chars: e.chars, format: e.format ? e.format : void 0, language: e.language };
+}
+function ul(e) {
+  return Me({ ...Be(e), ...qe(e), ...nt(e), items: e.members });
+}
+function fl(e) {
+  let t = [], r = [], i, n;
+  for (let a of e.sequences || []) console.log(a), a.canvases.length && t.push(...a.canvases), a.behavior && r.push(...a.behavior), a.viewingDirection && (n = a.viewingDirection), a.startCanvas && (i = a.startCanvas);
+  let s = Be(e);
+  return r.length && (s.behavior ? s.behavior.push(...r) : s.behavior = r), Me({ ...s, ...qe(e), ...nt(e), viewingDirection: n, start: i, items: t, structures: dl(e.structures) });
+}
+function dl(e) {
+  if (!e) return e;
+  let t = /* @__PURE__ */ new Map();
+  for (let i of e) t.set(i.id, i);
+  let r = [];
+  for (let i of e) if (i.items) {
+    let n = i.items.map((s) => typeof s == "string" ? (r.push(s), t.get(s) || s) : s && s.id ? (r.push(s.id), t.get(s.id) || s) : s);
+    i.items = n;
+  }
+  return e.filter((i) => r.indexOf(i.id) === -1);
+}
+function pl(e) {
+  return Me({ ...Be(e), ...qe(e), ...nt(e), annotations: e.otherContent && e.otherContent.length ? e.otherContent : void 0, items: e.images && e.images.length ? [{ id: Ls(e, "annotation-page"), type: "AnnotationPage", items: e.images }] : void 0 });
+}
+function gl(e) {
+  return Me({ ...Be(e), ...qe(e), ...nt(e), items: e.resources && e.resources.length ? e.resources : void 0 });
+}
+function ml(e) {
+  return !e.canvases || e.canvases.length === 0 ? { canvases: [], behavior: [] } : { canvases: e.canvases, behavior: e.viewingHint ? [e.viewingHint] : [], viewingDirection: e.viewingDirection, startCanvas: e.startCanvas };
+}
+function vl(e) {
+  function t(r) {
+    if (Array.isArray(r)) {
+      if (r.length > 1) return { type: "List", items: r.map(t) };
+      r = r[0];
+    }
+    if (typeof r == "string") return encodeURI(r).trim();
+    if ("@type" in r) {
+      let i;
+      if (typeof r.full == "string") i = r.full;
+      else if (r.full["@type"] === "dctypes:Image") i = { id: r.full["@id"], type: "Image" };
+      else if (r.full["@type"] === "sc:Canvas") i = { id: r.full["@id"], type: "Canvas" };
+      else throw new Error(`Unsupported source type on annotation: ${r.full["@type"]}`);
+      return { type: "SpecificResource", source: i, selector: hi(r.selector) };
+    } else return encodeURI(r["@id"]).trim();
+  }
+  return Me({ ...Be(e), ...qe(e), ...nt(e), target: t(e.on), body: Array.isArray(e.resource) ? e.resource.map(on) : on(e.resource) });
+}
+function on(e) {
+  return e.type === "Choice" ? e : Ws(e);
+}
+function Ws(e) {
+  let t = e;
+  return Me({ ...Be(t), ...qe(t), ...nt(t), ...hl(t) });
+}
+function yl(e) {
+  let t = [];
+  return e.default && e.default !== "rdf:nil" && t.push(e.default), e.item && e.item !== "rdf:nil" && t.push(...e.item), Me({ ...Be(e), ...qe(e), items: t });
+}
+function bl(e) {
+  return Me({ ...Be(e), ...qe(e), ...nt(e), items: e.members });
+}
+function wl(e) {
+  let { "@id": t, "@type": r, "@context": i, profile: n, ...s } = e, a = {};
+  return t && (a["@id"] = t), a["@type"] = Ui(e), a["@type"] === "unknown" && (i && i.length && (a["@context"] = i), a["@type"] = "Service"), n && (a.profile = Ds(n)), Me({ ...a, ...s });
+}
+function xl(e) {
+  return Me({ ...Be(e), ...qe(e), ...nt(e) });
+}
+var Cl = new Pc({ collection: [ul], manifest: [fl], canvas: [pl], annotationList: [gl], sequence: [ml], annotation: [vl], contentResource: [Ws], choice: [yl], range: [bl], service: [wl], layer: [xl] });
+function Us(e) {
+  return e && e["@context"] && (e["@context"] === "http://iiif.io/api/presentation/2/context.json" || e["@context"].indexOf("http://iiif.io/api/presentation/2/context.json") !== -1 || e["@context"] === "http://www.shared-canvas.org/ns/context.json") || e["@context"] === "http://iiif.io/api/image/2/context.json" ? Cl.traverseUnknown(e) : e;
+}
+function hi(e) {
+  if ((Array.isArray(e["@type"]) && e["@type"].includes("oa:SvgSelector") || e["@type"] == "oa:SvgSelector") && ("chars" in e || "value" in e)) return { type: "SvgSelector", value: "chars" in e ? e.chars : e.value };
+  if (e["@type"] === "oa:FragmentSelector") return { type: "FragmentSelector", value: e.value };
+  if (e["@type"] === "oa:Choice") return [hi(e.default), ...(Array.isArray(e.item) ? e.item : [e.item]).map(hi)];
+  if (e["@type"] == "iiif:ImageApiSelector") return { type: "ImageApiSelector", region: "region" in e ? e.region : void 0, rotation: "rotation" in e ? e.rotation : void 0 };
+  throw new Error(`Unsupported selector type: ${e["@type"]}`);
+}
+var Sl = Us, ar = {}, zi = {
+  get(e) {
+    return e;
+  },
+  setMetaValue([e, t, r], i) {
+    const n = zi.getResourceMeta(e, t), s = n ? n[r] : void 0, a = typeof i == "function" ? i(s) : i;
+    ar[e] = {
+      ...ar[e] || {},
+      [t]: {
+        ...(ar[e] || {})[t] || {},
+        [r]: a
+      }
+    };
+  },
+  getResourceMeta: (e, t) => {
+    const r = ar[e];
+    if (r)
+      return t ? r[t] : r;
+  },
+  async load(e) {
+    const t = typeof e == "string" ? e : e.id;
+    return fetch(t).then((r) => r.json());
+  },
+  requestStatus(e) {
+  }
+};
+function Al(e) {
+  return e.type === "SpecificResource" ? [e.source, { selector: e.selector }] : [e, { selector: null }];
+}
+function _l(e = zi) {
+  function t(n) {
+    const s = n ? typeof n == "string" ? e.get(n) : n : null;
+    if (!s)
+      return [];
+    const a = e.get(s.items, { parent: s }), o = [];
+    for (const c of a)
+      o.push(...e.get(c.items, { parent: c }));
+    return o;
+  }
+  function r(n, s = []) {
+    const a = Array.isArray(n) ? n : t(n), o = [];
+    let c = {
+      items: [],
+      type: "complex-choice"
+    };
+    const h = [];
+    for (const l of a) {
+      if (l.type !== "Annotation")
+        throw new Error("getPaintables() accept either a canvas or list of annotations");
+      const u = Array.from(Array.isArray(l.body) ? l.body : [l.body]);
+      for (const f of u) {
+        const [p, { selector: d }] = Al(f), m = e.get(p), g = (m.type || "unknown").toLowerCase();
+        if (g === "choice") {
+          const y = e.get(m.items, { parent: m.id }), b = s.length ? s.map((w) => y.find((F) => F.id === w)).filter(Boolean) : [y[0]];
+          b.length === 0 && b.push(y[0]), c.items.push({
+            type: "single-choice",
+            items: y.map((w) => ({
+              id: w.id,
+              label: w.label,
+              selected: b.indexOf(w) !== -1
+            })),
+            label: p.label
+          }), u.push(...b);
+          continue;
+        }
+        o.indexOf(g) === -1 && o.push(g), h.push({
+          type: g,
+          annotationId: l.id,
+          annotation: l,
+          resource: m,
+          target: l.target,
+          selector: d
+        });
+      }
+    }
+    return {
+      types: o,
+      items: h,
+      choice: c.items.length < 2 ? c.items[0] || null : c,
+      allChoices: c.items.length ? c : null
+    };
+  }
+  function i(n) {
+    const { choice: s } = r(n);
+    return s;
+  }
+  return {
+    getAllPaintingAnnotations: t,
+    getPaintables: r,
+    extractChoices: i
+  };
+}
+function Ze(e) {
+  return typeof e == "string" ? !1 : e && !e.type && "source" in e ? (e.type = "SpecificResource", !0) : !!e && e.type === "SpecificResource";
+}
+function or(...e) {
+  return (t) => e.reduce((r, i) => i(r), t);
+}
+var cn = ["Collection", "Manifest", "Canvas", "AnnotationPage", "AnnotationCollection", "Annotation", "ContentResource", "Range", "Service", "Selector", "Agent"];
+function Ol(e, t) {
+  if (typeof e > "u" || e === null) throw new Error("Null or undefined is not a valid entity.");
+  if (Array.isArray(e)) throw new Error("Array is not a valid entity");
+  if (typeof e != "object") {
+    if (t) return t;
+    throw new Error(`${typeof e} is not a valid entity`);
+  }
+  if (typeof e.type == "string") {
+    let r = cn.indexOf(e.type);
+    if (r !== -1) return cn[r];
+  }
+  if (e.profile) return "Service";
+  throw new Error("Resource type is not known");
+}
+var kl = class zs {
+  constructor(t, r = {}) {
+    Ye(this, "traversals"), Ye(this, "options"), Ye(this, "_traverseManifest", or(this.traverseManifestItems.bind(this), this.traverseLinking.bind(this), this.traverseDescriptive.bind(this), this.traverseLinkedCanvases.bind(this), this.traverseManifestStructures.bind(this), this.traverseInlineAnnotationPages.bind(this))), Ye(this, "_traverseCanvas", or(this.traverseCanvasItems.bind(this), this.traverseLinking.bind(this), this.traverseDescriptive.bind(this), this.traverseLinkedCanvases.bind(this), this.traverseInlineAnnotationPages.bind(this))), Ye(this, "_traverseAnnotationPage", or(this.traverseAnnotationPageItems.bind(this), this.traverseLinking.bind(this), this.traverseDescriptive.bind(this))), Ye(this, "_traverseRange", or(this.traverseRangeRanges.bind(this), this.traverseLinking.bind(this), this.traverseDescriptive.bind(this), this.traverseLinkedCanvases.bind(this))), this.traversals = { collection: [], manifest: [], canvas: [], annotationCollection: [], annotationPage: [], annotation: [], contentResource: [], choice: [], range: [], service: [], agent: [], specificResource: [], geoJson: [], ...t }, this.options = { allowUndefinedReturn: !1, ...r };
+  }
+  static all(t) {
+    return new zs({ collection: [t], manifest: [t], canvas: [t], annotationCollection: [t], annotationPage: [t], annotation: [t], contentResource: [t], choice: [t], range: [t], service: [t], geoJson: [t], specificResource: [t], agent: [t] });
+  }
+  traverseDescriptive(t) {
+    return t.thumbnail && (t.thumbnail = ht(t.thumbnail).map((r) => this.traverseType(r, { parent: t }, this.traversals.contentResource))), t.provider && (t.provider = t.provider.map((r) => this.traverseAgent(r, t))), t;
+  }
+  traverseLinking(t) {
+    return t.seeAlso && (t.seeAlso = t.seeAlso.map((r) => this.traverseType(r, { parent: t }, this.traversals.contentResource))), t.service && (t.service = ht(t.service).map((r) => this.traverseService(r))), t.services && (t.services = ht(t.services).map((r) => this.traverseService(r, t))), t.logo && (t.logo = t.logo.map((r) => this.traverseType(r, { parent: t }, this.traversals.contentResource))), t.homepage && (t.homepage = ht(t.homepage).map((r) => this.traverseType(r, { parent: t }, this.traversals.contentResource))), t.partOf && (t.partOf = t.partOf.map((r) => typeof r == "string" || !r.type ? this.traverseType(r, { parent: t }, this.traversals.contentResource) : r.type === "Canvas" ? this.traverseType(r, { parent: t }, this.traversals.canvas) : r.type === "AnnotationCollection" ? this.traverseType(r, { parent: t }, this.traversals.annotationCollection) : r.type === "Collection" ? this.traverseType(r, { parent: t }, this.traversals.collection) : this.traverseType(r, { parent: t }, this.traversals.contentResource))), t.start && (Ze(t.start) ? t.start = this.traverseSpecificResource(t.start, "Canvas", t) : t.start = this.traverseType(t.start, { parent: t }, this.traversals.canvas)), t.rendering && (t.rendering = t.rendering.map((r) => this.traverseType(r, { parent: t }, this.traversals.contentResource))), t.supplementary && (t.supplementary = t.supplementary.map((r) => this.traverseType(r, { parent: t }, this.traversals.contentResource))), t;
+  }
+  traverseCollectionItems(t) {
+    return t.items && t.items.map((r) => r.type === "Collection" ? this.traverseCollection(r) : this.traverseManifest(r)), t;
+  }
+  traverseCollection(t, r) {
+    return this.traverseType(this.traverseDescriptive(this.traverseInlineAnnotationPages(this.traverseLinking(this.traverseLinkedCanvases(this.traverseCollectionItems(t))))), { parent: r }, this.traversals.collection);
+  }
+  traverseGeoJson(t, r) {
+    return this.traverseType(t, { parent: r }, this.traversals.geoJson);
+  }
+  traverseNavPlace(t) {
+    return t.navPlace && (t.navPlace = this.traverseGeoJson(t.navPlace, t)), t;
+  }
+  traverseManifestItems(t) {
+    return t.items && (t.items = t.items.map((r) => this.traverseCanvas(r))), t;
+  }
+  traverseManifestStructures(t) {
+    return t.structures && (t.structures = t.structures.map((r) => this.traverseRange(r))), t;
+  }
+  traverseManifest(t, r) {
+    return this.traverseType(this._traverseManifest(t), { parent: r }, this.traversals.manifest);
+  }
+  traverseCanvasItems(t) {
+    return t.items = (t.items || []).map((r) => this.traverseAnnotationPage(r, t)), t;
+  }
+  traverseInlineAnnotationPages(t) {
+    return typeof t == "string" || !t || t.annotations && (t.annotations = t.annotations.map((r) => this.traverseAnnotationPage(r, t))), t;
+  }
+  traverseCanvas(t, r) {
+    return this.traverseType(this._traverseCanvas(t), { parent: r }, this.traversals.canvas);
+  }
+  traverseAnnotationPageItems(t) {
+    return t.items && (t.items = t.items.map((r) => this.traverseAnnotation(r, t))), t;
+  }
+  traverseAnnotationPage(t, r) {
+    return this.traverseType(this._traverseAnnotationPage(t), { parent: r }, this.traversals.annotationPage);
+  }
+  traverseAnnotationBody(t) {
+    return Array.isArray(t.body) ? t.body = t.body.map((r) => this.traverseContentResource(r, t)) : t.body && (t.body = this.traverseContentResource(t.body, t)), t;
+  }
+  traverseLinkedCanvases(t) {
+    return t.placeholderCanvas && (t.placeholderCanvas = this.traverseCanvas(t.placeholderCanvas)), t.accompanyingCanvas && (t.accompanyingCanvas = this.traverseCanvas(t.accompanyingCanvas)), t;
+  }
+  traverseAnnotation(t, r) {
+    return this.traverseType(this.traverseLinking(this.traverseAnnotationBody(this.traverseDescriptive(t))), { parent: r }, this.traversals.annotation);
+  }
+  traverseContentResourceLinking(t) {
+    return typeof t == "string" || !t || t && t.service && (t.service = ht(t.service || []).map((r) => this.traverseService(r, t))), t;
+  }
+  traverseContentResource(t, r) {
+    return t.type === "Choice" && (t.items = t.items.map((i) => this.traverseContentResource(i, t))), Ze(t) ? this.traverseSpecificResource(t, "ContentResource") : this.traverseType(this.traverseInlineAnnotationPages(this.traverseContentResourceLinking(t)), { parent: r }, this.traversals.contentResource);
+  }
+  traverseSpecificResource(t, r, i) {
+    let n = t.source;
+    return typeof t.source == "string" && (n = { id: t.source, type: r || "unknown" }), this.traverseType({ ...t, source: r === "Canvas" || n.type === "Canvas" ? this.traverseType(n, { parent: i }, this.traversals.canvas) : r === "ContentResource" ? this.traverseContentResource(n, { parent: i }) : this.traverseUnknown(n, { parent: i, typeHint: r }) }, { parent: i }, this.traversals.specificResource);
+  }
+  traverseRangeRanges(t) {
+    return t.items && (t.items = t.items.map((r) => typeof r == "string" ? this.traverseCanvas({ id: r, type: "Canvas" }, t) : Ze(r) ? this.traverseSpecificResource(r, "Canvas", t) : r.type === "Manifest" ? this.traverseManifest(r, t) : this.traverseRange(r, t))), t;
+  }
+  traverseRange(t, r) {
+    return this.traverseType(this._traverseRange(t), { parent: r }, this.traversals.range);
+  }
+  traverseAgent(t, r) {
+    return this.traverseType(this.traverseDescriptive(this.traverseLinking(t)), { parent: r }, this.traversals.agent);
+  }
+  traverseType(t, r, i) {
+    return i.reduce((n, s) => {
+      let a = s(n, r);
+      return typeof a > "u" && !this.options.allowUndefinedReturn ? n : a;
+    }, t);
+  }
+  traverseService(t, r) {
+    let i = Object.assign({}, t);
+    return i && i.service && (i.service = ht(i.service).map((n) => this.traverseService(n))), this.traverseType(i, { parent: r }, this.traversals.service);
+  }
+  traverseUnknown(t, { parent: r, typeHint: i } = {}) {
+    let n = Ol(t, i);
+    switch (n) {
+      case "Collection":
+        return this.traverseCollection(t, r);
+      case "Manifest":
+        return this.traverseManifest(t, r);
+      case "Canvas":
+        return this.traverseCanvas(t, r);
+      case "AnnotationPage":
+        return this.traverseAnnotationPage(t, r);
+      case "Annotation":
+        return this.traverseAnnotation(t, r);
+      case "ContentResource":
+        return this.traverseContentResource(t, r);
+      case "Range":
+        return this.traverseRange(t, r);
+      case "Service":
+        return this.traverseService(t, r);
+      case "Agent":
+        return this.traverseAgent(t, r);
+      default:
+        throw new Error(`Unknown or unsupported resource type of ${n}`);
+    }
+  }
+};
+function Bs(e, t) {
+  let r = "unknown";
+  if (!e) return;
+  if (typeof e == "string") return { id: e, type: r };
+  if (Ze(e)) return Bs(e.source);
+  let i = e.type || e["@type"], n = e.id || e["@id"];
+  if (i && i.indexOf(":") !== -1 && (i = i.split(":").pop()), n && i) return { id: n, type: i };
+}
+var Ut = {}, oe = "iiif-parser:hasPart", ze = "iiif-parser:partOf", zt = "iiif-parser:isExternal", Te = "__$UNSET$__", qs = "__$UNWRAP$__", T = [];
+Object.freeze(T);
+Object.freeze(Ut);
+function Il(e) {
+  if (e === Ut || Object.keys(e).length === 0) return !0;
+  for (let t in e) return !1;
+  return !0;
+}
+function Bi(e, t) {
+  if (t && t["@explicit"]) {
+    let r = {}, i = Object.keys(t);
+    for (let n of i) n === ze || n === "@explicit" || (Il(t[n]) ? r[n] = e[n] : r[n] = t[n]);
+    return r;
+  }
+  return e;
+}
+function Hs(e, t, r) {
+  let i = Bs(t);
+  if (!i) return [void 0, void 0];
+  let n = e.requests[i.id], s = i.type || e.mapping[i.id];
+  if (!s || n && n.resourceUri && (!e.entities[s] || !e.entities[s][n.resourceUri])) return [void 0, void 0];
+  let a = e.entities[s][n ? n.resourceUri : i.id];
+  if (i.type && !a) return Hs(e, { id: i.id }, r);
+  if (a && a[oe]) {
+    let o = a[oe].find((c) => r ? c[ze] === r.id : c[ze] === a.id);
+    return [Bi(a, o), a];
+  }
+  return [a, a];
+}
+var Tl = { id: "https://iiif-parser/annotation-page", type: "AnnotationPage", behavior: T, label: null, thumbnail: T, summary: null, requiredStatement: null, metadata: T, rights: null, provider: T, items: T, seeAlso: T, homepage: T, rendering: T, service: T }, Pl = { id: "https://iiif-parser/empty-canvas", type: "Canvas", label: null, behavior: T, thumbnail: T, accompanyingCanvas: null, placeholderCanvas: null, summary: null, requiredStatement: null, metadata: T, rights: null, navDate: null, provider: T, items: T, annotations: T, seeAlso: T, homepage: T, partOf: T, rendering: T, service: T, duration: 0, height: 0, width: 0 }, jl = { id: "https://iiif-parser/empty-collection", type: "Collection", label: null, viewingDirection: "left-to-right", behavior: T, thumbnail: T, accompanyingCanvas: null, placeholderCanvas: null, summary: null, requiredStatement: null, metadata: T, rights: null, navDate: null, provider: T, items: T, annotations: T, seeAlso: T, homepage: T, partOf: T, rendering: T, service: T, services: T }, $l = { id: "https://iiif-parser/empty-manifest", type: "Manifest", annotations: T, behavior: T, homepage: T, items: T, label: null, metadata: T, navDate: null, provider: T, partOf: T, accompanyingCanvas: null, placeholderCanvas: null, rendering: T, requiredStatement: null, rights: null, seeAlso: T, service: T, services: T, start: null, structures: T, summary: null, thumbnail: T, viewingDirection: "left-to-right" }, Fl = { id: "https://iiif-parser/empty-canvas", type: "Range", label: null, behavior: T, thumbnail: T, accompanyingCanvas: null, placeholderCanvas: null, summary: null, requiredStatement: null, metadata: T, rights: null, navDate: null, provider: T, items: T, annotations: T, seeAlso: T, homepage: T, partOf: T, rendering: T, service: T, start: null, supplementary: null, viewingDirection: "left-to-right" }, El = { id: "https://iiif-parser/empty-agent", type: "Agent", label: {}, logo: T, seeAlso: T, homepage: T }, Rl = { id: "https://iiif-parser/empty-service", type: "UnknownService" };
+function ui(e, t = {}) {
+  if (Array.isArray(e)) return ui(e[0]);
+  if (typeof e == "string") {
+    let [r, i] = e.split("#");
+    return i ? { type: "SpecificResource", source: { id: r, type: t.typeHint || "Unknown" }, selector: { type: "FragmentSelector", value: i } } : { type: "SpecificResource", source: { id: r, type: t.typeMap && t.typeMap[r] || t.typeHint || "Unknown" } };
+  }
+  if (e.type === "Choice" || e.type === "List" || e.type === "Composite" || e.type === "Independents") return ui(e.items[0]);
+  if (!e.type && "source" in e && (e.type = "SpecificResource"), e.type === "SpecificResource") return e.source.type === "Canvas" && e.source.partOf && typeof e.source.partOf == "string" && (e.source.partOf = [{ id: e.source.partOf, type: "Manifest" }]), e.selector ? { type: "SpecificResource", source: e.source, selector: e.selector } : { type: "SpecificResource", source: e.source };
+  if (e.id) {
+    e.type === "Canvas" && e.partOf && typeof e.partOf == "string" && (e.partOf = [{ id: e.partOf, type: "Manifest" }]);
+    let [r, i] = e.id.split("#");
+    return i ? { type: "SpecificResource", source: { ...e, id: r }, selector: { type: "FragmentSelector", value: i } } : { type: "SpecificResource", source: { ...e, id: r } };
+  }
+  return { type: "SpecificResource", source: e };
+}
+function Ml() {
+  return { Collection: {}, Manifest: {}, Canvas: {}, AnnotationPage: {}, AnnotationCollection: {}, Annotation: {}, ContentResource: {}, Range: {}, Service: {}, Selector: {}, Agent: {} };
+}
+function Qs(e, t) {
+  if (typeof e == "string") return { id: e, type: t };
+  if (!e.id) throw new Error(`Invalid resource does not have an ID (${JSON.stringify(e)}, ${t})`);
+  return e;
+}
+function Nl(e, t) {
+  return (r, i) => {
+    let n = e[r] ? e[r] : {};
+    return (s, a) => {
+      let o = Qs(s, i || r);
+      return o && o.id && r ? (n[o.id] = n[o.id] ? di(n[o.id], o, { parent: a.parent, isTopLevel: t.id === o.id }) : di({ id: o.id, type: o.type }, o, { parent: a.parent, isTopLevel: t.id === o.id }), { id: o.id, type: r === "ContentResource" ? r : o.type }) : o;
+    };
+  };
+}
+function fi(e, t, r) {
+  if (!t) return e;
+  if (Array.isArray(e)) {
+    if (!Array.isArray(t)) throw new Error("Cannot merge array with non-array");
+    let i = [...e];
+    for (let n of t) if (n["@id"] && !n.id && (n.id = n["@id"]), n["@type"] && !n.type && (n.type = n["@type"]), n != null) if (Array.isArray(n)) i.push(n);
+    else if (typeof n == "object" && n.id && n.type) {
+      let s = i.findIndex((a) => a.id === n.id && a.type === n.type);
+      s >= 0 && (i[s] = fi(i[s], n));
+    } else e.indexOf(n) === -1 && i.push(n);
+    return i;
+  } else if (typeof e == "object") {
+    if (Array.isArray(t) || typeof t != "object") throw new Error("Cannot merge object with non-object");
+    let i = { ...e }, n = [], s = [], a = Object.keys(e).filter((h) => h !== oe && h !== "id" && h !== "type"), o = {}, c = {};
+    for (let [h, l] of Object.entries(t)) {
+      if (h === oe || h === "id" || h === "type") continue;
+      let u = i[h];
+      u === l ? s.push(h) : u === T || !u ? (n.push(h), i[h] = l) : (u && l && (o[h] = u, c[h] = l), i[h] = fi(u, l), i[h] === o[h] && (s.push(h), delete o[h]));
+    }
+    if (r && (r.parent && r.parent.id || r.isTopLevel)) {
+      let h = [], l = {};
+      if (r.parent ? l[ze] = r.parent.id : r.isTopLevel && (l[ze] = e.id), i[oe] && i[oe].length) {
+        let u = !(i[oe] || []).find((p) => p["@explicit"]), f = n.length > 0 || s.length !== a.length;
+        if (u && f) for (let p of i[oe]) {
+          let d = { ...p }, m = Object.keys(o);
+          if (d) {
+            d["@explicit"] = !0;
+            for (let g of a) g !== oe && (d[g] = Ut);
+            for (let g of m) d[g] = o[g];
+          }
+          h.push(d);
+        }
+        else h.push(...i[oe]);
+        if (f) {
+          let p = Object.keys(c);
+          l["@explicit"] = !0;
+          for (let d of n) l[d] = Ut;
+          for (let d of s) l[d] = Ut;
+          for (let d of p) l[d] = c[d];
+        }
+      }
+      l.id = i.id, l.type = i.type, h.push(l), i[oe] = h;
+    }
+    return i;
+  } else if (e) return e;
+  return t;
+}
+function di(e, t, r) {
+  if (typeof e == "string") return e;
+  if (t.id !== e.id || t.type !== e.type) {
+    if (t.type === "ImageService3") return t;
+    if (e.type === "ImageService3") return e;
+    throw new Error(`Can only merge entities with identical identifiers and type! ${t.type}(${t.id}) => ${e.type}(${e.id})`);
+  }
+  return fi({ ...e }, t, r);
+}
+function Dl(e) {
+  return (t, r) => (i) => {
+    let { id: n, type: s } = Qs(i, r || t);
+    if (typeof n > "u") throw new Error("Found invalid entity without an ID.");
+    return t === "ContentResource" || t === "Service" ? e[n] = t : e[n] = s, i;
+  };
+}
+function Ll(e) {
+  let t = Object.assign({}, e);
+  if (t["@id"] && (t.id = t["@id"]), t["@type"] && (t.type = t["@type"]), t.service) {
+    let r = [];
+    t.service = Array.isArray(t.service) ? t.service : [t.service];
+    for (let i of t.service) r.push({ id: i["@id"] || i.id, type: i["@type"] || i.type });
+    t.service = r;
+  }
+  return Object.assign({}, Rl, t);
+}
+function Wl(e) {
+  return (t) => {
+    e.Service = e.Service ? e.Service : {};
+    let r = t.id || t["@id"], i = Ll(t);
+    return i && i.id && (e.Service[i.id] ? e.Service[r] = di(e.Service[r], i) : e.Service[r] = i), t;
+  };
+}
+function Ul(e) {
+  let t = JSON.stringify(e), r = 5381, i = t.length;
+  for (; i; ) r = r * 33 ^ t.charCodeAt(--i);
+  let n = (r >>> 0).toString(16);
+  return n.length % 2 ? "0" + n : n;
+}
+function zr(e) {
+  return (t) => typeof t == "string" ? { id: t, type: e } : t.id ? t.type ? t : { type: e, ...t } : { id: `vault://${Ul(t)}`, type: e, ...t };
+}
+function wt(e) {
+  return (t) => ({ ...e, ...t });
+}
+function Ft(e) {
+  return Array.isArray(e) ? e : [e];
+}
+function zl(e) {
+  return e.body && (e.body = Ft(e.body)), e.seeAlso && (e.seeAlso = Ft(e.seeAlso)), e.audience && (e.audience = Ft(e.audience)), e.accessibility && (e.accessibility = Ft(e.accessibility)), e.motivation && (e.motivation = Ft(e.motivation)), e;
+}
+function Gs(e, { typeHint: t, partOfTypeHint: r } = {}) {
+  if (typeof e == "string" && (e = { id: e, type: t || "unknown" }), Ze(e)) return typeof e.source == "string" && (e.source = { id: e.source, type: t || "unknown" }), e.source.type === "Canvas" && e.source.partOf && typeof e.source.partOf == "string" && (e.source.partOf = [{ id: e.source.partOf, type: r || "Manifest" }]), e;
+  let i;
+  if ((e.id || "").indexOf("#") !== -1) {
+    let [n, s] = (e.id || "").split("#");
+    e.id = n, s && (i = { type: "FragmentSelector", value: s });
+  }
+  return { type: "SpecificResource", source: e, selector: i };
+}
+function Bl(e) {
+  let t = Object.assign({}, e);
+  return e && e.items && (t.items = e.items.map((r) => typeof r == "string" || r.type === "Canvas" ? Gs(r) : r)), t;
+}
+function ql(e) {
+  let t = Object.assign({}, e);
+  return t.start ? (t.start = Gs(t.start, { typeHint: "Canvas" }), t) : e;
+}
+function Hl(e) {
+  let t = Object.assign({}, e);
+  return t.target ? (t.target = ui(t.target, { typeHint: "Canvas" }), t) : e;
+}
+function Ql(e) {
+  return e;
+}
+function Br(e) {
+  return typeof e.items > "u" && (e[zt] = !0), e;
+}
+function Gl(e) {
+  let t = Us(e), r = Ml(), i = {}, n = Nl(r, t), s = Dl(i), a = new kl({ collection: [Br, wt(jl), s("Collection"), n("Collection")], manifest: [Br, wt($l), ql, s("Manifest"), n("Manifest")], canvas: [wt(Pl), s("Canvas"), n("Canvas")], annotationPage: [Br, zr("AnnotationPage"), wt(Tl), s("AnnotationPage"), n("AnnotationPage")], annotation: [zr("Annotation"), zl, Hl, s("Annotation"), n("Annotation")], contentResource: [zr("ContentResource"), s("ContentResource"), n("ContentResource")], range: [wt(Fl), Bl, s("Range", "Canvas"), n("Range", "Canvas")], agent: [wt(El), s("Agent"), n("Agent")], specificResource: [Ql], service: [Wl(r)] }).traverseUnknown(t);
+  return { entities: r, resource: a, mapping: i };
+}
+function Yl(e) {
+  let t = {};
+  for (let [r, i] of e) {
+    if (r === qs && i !== Te) return i;
+    i !== Te && typeof i < "u" && i !== null && (t[r] = i);
+  }
+  return t;
+}
+function Vl(e, t, r) {
+  if (!t.type || !t.id) throw new Error("Unknown entity");
+  if (!r[t.type]) throw new Error(`Serializer not found for ${t.type}`);
+  function i(n, s, a = 0) {
+    let o = r[n.type];
+    if (!o) return Te;
+    if (a > 20) throw new Error("Circular reference: " + n.id + " " + n.type);
+    let [c, h] = Hs(e, n.type ? n : n.id, s) || (n.id && n.type ? n : null);
+    if (!c) return Te;
+    let l = o(c, e, { parent: s, isTopLevel: t.id === n.id, fullResource: h }), u = l.next();
+    for (; !u.done; ) {
+      let f = u.value, p = Te;
+      if (f) if (Array.isArray(f)) {
+        let d = [];
+        for (let m of f) d.push(i(m, n, a + 1));
+        p = d;
+      } else p = i(f, n, a + 1);
+      u = l.next(p);
+    }
+    return u.value === Te ? Te : Yl(u.value);
+  }
+  return i(t);
+}
+function Bt(e, { allowSourceString: t = !0, allowString: r = !1, allowedStringType: i } = {}) {
+  let n = (s) => {
+    if (t && s && s.source && typeof s.source != "string") {
+      let a = Object.keys(s.source);
+      if (s.source.id && s.source.type && a.length === 2) return { ...s, source: s.source.id };
+    }
+    return s;
+  };
+  if (e) {
+    if (e.source && e.source.partOf) return n(e);
+    let s = Object.keys(e);
+    if (s.length === 2 && e.type && e.source || s.length === 3 && e.type && e.source && s.indexOf("selector") !== -1 && !e.selector) return r && (!i || i === e.source.type) ? e.source.id : e.source.type === "ContentResource" ? { type: "SpecificResource", source: e.source.id } : e.source;
+    if (e.selector && !Array.isArray(e.selector) && typeof e.selector != "string" && e.selector.type === "FragmentSelector") {
+      let a = `${e.source.id}#${e.selector.value}`;
+      return r ? a : { id: a, type: e.source.type };
+    }
+  }
+  return n(e);
+}
+function At(e) {
+  if (!e) return;
+  let t = Object.keys(e);
+  if (t.length !== 0) {
+    if (t.length === 1) {
+      let r = t[0];
+      if (!r) return "";
+      let i = (e[r] || []).join("");
+      return r === "@none" || r === "none" || r === "en" ? i : { "@language": r, "@value": i };
+    }
+    return t.map((r) => ({ "@language": r, "@value": (e[r] || []).join("") }));
+  }
+}
+function Ys(e) {
+  return Array.isArray(e) ? e.map((t) => Ys(t)) : typeof e == "string" ? e : e.type && e.type === "Canvas" ? e.id : e;
+}
+function et(e, t = !1) {
+  if (e) return e.length > 1 && !t ? e : e[0] || void 0;
+}
+function Jl(e) {
+  if (e) {
+    if (typeof e == "string") return { "@id": e };
+    if ("@id" in e) {
+      let t = { ...e };
+      return delete t["@type"], t;
+    }
+    return { "@context": "http://iiif.io/api/image/2/context.json", "@id": e.id, profile: `http://iiif.io/api/image/2/profiles/${e.profile}.json` };
+  }
+}
+function at(e, t) {
+  return [["@id", e.id], ["@type", t], ["format", e.format], ["height", e.height], ["width", e.width], ["viewingDirection", e.viewingDirection !== "left-to-right" ? e.viewingDirection : void 0], ["license", e.license ? e.license : void 0]];
+}
+function* ot(e) {
+  let t = e.provider ? yield e.provider[0] : void 0;
+  return [["label", At(e.label)], ["metadata", e.metadata && e.metadata.length ? e.metadata.map((r) => ({ label: At(r.label) || "", value: At(r.value) || "" })) : void 0], ["description", At(e.summary)], ["thumbnail", et(yield e.thumbnail)], ["navDate", e.navDate], ["logo", t ? et(t.logo) : void 0], ["homepage", t ? t.homepage : void 0], ["attribution", e.requiredStatement ? At(e.requiredStatement.value) : void 0]];
+}
+function* Et(e) {
+  let t = e.start && e.start.type && e.start.type === "SpecificResource" ? Bt(e.start) : e.start;
+  return [["seeAlso", et(yield e.seeAlso)], ["service", et((e.service || []).map(Jl))], ["rendering", et(yield e.rendering)], ["startCanvas", t ? t.id : void 0]];
+}
+function Xl(e) {
+  return e.type === "SpecificResource";
+}
+function Kl(e) {
+  return e && e.type === "FragmentSelector";
+}
+function Zl(e) {
+  if (e && Xl(e)) {
+    let t = e.id, r = e.selector ? Array.isArray(e.selector) ? e.selector[0] : e.selector : void 0;
+    return Kl(r) && (t += "#" + r.value), t;
+  }
+  return e == null ? void 0 : e.id;
+}
+var eh = { Manifest: function* (e, t, { isTopLevel: r }) {
+  return [...r ? [["@context", "http://iiif.io/api/presentation/2/context.json"]] : [], ...at(e, "sc:Manifest"), ...yield* ot(e), ...yield* Et(e), ["sequences", [{ "@id": `${e.id}/sequence0`, "@type": "sc:Sequence", canvases: yield e.items }]], ["structures", yield e.structures]];
+}, Canvas: function* (e) {
+  let t = (yield e.items)[0];
+  return [...at(e, "sc:Canvas"), ...yield* ot(e), ...yield* Et(e), ["images", t ? [t.resources] : void 0], ["annotations", e.annotations && e.annotations.length ? et(yield e.annotations) : void 0]];
+}, AnnotationPage: function* (e) {
+  return [...at(e, "sc:AnnotationList"), ...yield* ot(e), ["resources", e.items && e.items.length ? et(yield e.items) : void 0]];
+}, Annotation: function* (e) {
+  return [["@id", e.id], ["@type", "oa:Annotation"], ["motivation", "sc:painting"], ["on", Ys(e.target)], ["resource", et(yield e.body, !0)]];
+}, ContentResource: function* (e) {
+  switch (e.type) {
+    case "Image":
+      return [...at(e, "dctypes:Image"), ...yield* ot(e), ...yield* Et(e)];
+    case "Text":
+    case "Dataset":
+    default:
+      return [...at(e, void 0), ...yield* ot(e)];
+  }
+}, AnnotationCollection: function* (e) {
+  return [["@id", e.id], ["@type", "sc:Layer"], ["label", At(e.label)]];
+}, Collection: function* (e) {
+  return [...at(e, "sc:Collection"), ...yield* ot(e), ...yield* Et(e), ["members", yield* e.items]];
+}, Range: function* (e) {
+  let t = [], r = [];
+  if (e.items) for (let i of e.items) {
+    let n = i.type === "SpecificResource" ? i.source : i;
+    if (n) {
+      let s = yield n;
+      t.push({ "@id": Zl(i), "@type": n.type, label: s ? s.label : void 0, within: e.id }), n.type === "Canvas" && r.push(n.id);
+    }
+  }
+  return [...at(e, "sc:Range"), ...yield* ot(e), ...yield* Et(e), ["canvases", r.length === t.length ? r : void 0], ["members", r.length !== t.length ? t : void 0]];
+} };
+function ct(e) {
+  var t;
+  return [["id", (t = e.id) != null && t.startsWith("vault://") ? void 0 : e.id], ["type", e.type], ["format", e.format], ["profile", e.profile], ["height", e.height || void 0], ["width", e.width || void 0], ["duration", e.duration || void 0], ["viewingDirection", e.viewingDirection !== "left-to-right" ? e.viewingDirection : void 0], ["behavior", e.behavior && e.behavior.length ? e.behavior : void 0], ["timeMode", e.timeMode], ["motivation", Array.isArray(e.motivation) ? e.motivation[0] : e.motivation], [oe, Te]];
+}
+function ne(e) {
+  if (e === Te || !e || e.length === 0) return;
+  let t = e.filter((r) => r !== Te);
+  if (t.length !== 0) return t;
+}
+function Vs(e) {
+  if (e && e.type && e.type === "ImageService2") {
+    let { id: t, type: r, profile: i, ...n } = e, s = typeof i == "string" ? i : Array.isArray(i) ? i.find((a) => typeof a == "string") : "";
+    return { "@id": t, "@type": r, profile: s ? s.startsWith("http") ? s : `http://iiif.io/api/image/2/${s}.json` : "http://iiif.io/api/image/2/level0.json", ...n };
+  }
+  return e;
+}
+function ln(e) {
+  if (Array.isArray(e) || (e = e ? [e] : []), !(!e || e.length === 0)) return e.map(Vs);
+}
+function* He(e) {
+  return [["label", e.label], ["metadata", ne(e.metadata)], ["summary", e.summary], ["requiredStatement", e.requiredStatement], ["rights", Array.isArray(e.rights) ? e.rights[0] || void 0 : e.rights || void 0], ["navDate", e.navDate], ["language", e.language], ["thumbnail", ne(yield e.thumbnail)], ["placeholderCanvas", yield e.placeholderCanvas], ["accompanyingCanvas", yield e.accompanyingCanvas], ["provider", ne(yield e.provider)]];
+}
+function* Qe(e, t) {
+  let r = [];
+  for (let i of e.partOf || []) i.type === "Manifest" && t.type === "Manifest" || r.push(yield i);
+  return [["seeAlso", ne(yield e.seeAlso)], ["service", ne(ln(e.service))], ["services", ne(ln(e.services))], ["rendering", ne(yield e.rendering)], ["supplementary", ne(yield e.supplementary)], ["homepage", ne(yield e.homepage)], ["logo", ne(yield e.logo)], ["partOf", ne(r)], ["start", e.start ? Bt(e.start) : e.start]];
+}
+var th = { Manifest: function* (e, t, { isTopLevel: r }) {
+  return r ? [["@context", e["@context"] ? e["@context"] : "http://iiif.io/api/presentation/3/context.json"], ...ct(e), ...yield* He(e), ...yield* Qe(e), ["items", yield e.items], ["structures", ne(yield e.structures)], ["annotations", ne(yield e.annotations)], ["navPlace", e.navPlace]] : [...ct(e), ...yield* He(e)];
+}, Canvas: function* (e, t, { parent: r }) {
+  return r && r.type !== "Manifest" && r.type !== "Canvas" ? [["id", e.id]] : [...ct(e), ...yield* He(e), ...yield* Qe(e, r), ["items", yield e.items], ["annotations", ne(yield e.annotations)], ["navPlace", e.navPlace]];
+}, Agent: function* (e) {
+  return [["id", e.id], ["type", "Agent"], ["label", e.label], ...yield* Qe(e)];
+}, AnnotationPage: function* (e) {
+  var i;
+  let t = Object.entries(e).map(([n, s]) => [n, Array.isArray(s) ? ne(s) : s]).filter(([n, s]) => n !== "items" && n !== "id" && n !== oe && n !== ze && n !== zt), r = yield e.items;
+  return [["id", (i = e.id) != null && i.startsWith("vault://") ? void 0 : e.id], ...t, ...yield* Qe(e), ["items", r.length || e[zt] === !1 ? r : Te]];
+}, Service: function* (e) {
+  return [[qs, Vs(e)]];
+}, Annotation: function* (e) {
+  let t = Object.entries(e).map(([i, n]) => i === "motivation" ? [i, Array.isArray(n) ? n[0] : n] : i === "target" ? [i, Bt(n, { allowString: !0, allowSourceString: !0, allowedStringType: "Canvas" })] : [i, Array.isArray(n) ? ne(n) : n]).filter(([i]) => i !== "body" && i !== oe && i !== zt), r;
+  if (Array.isArray(e.body)) {
+    let i = [];
+    for (let n of e.body) if (n && Ze(n)) {
+      let s = { ...n };
+      n.source.type !== "Canvas" ? s.source = yield n.source : s.source = n.source, i.push(Bt(s, { allowSourceString: !0 }));
+    } else i.push(yield n);
+    r = i;
+  } else e.body && Ze(e.body) ? (r = { ...e.body }, r.source = yield e.body.source) : r = yield e.body;
+  return [...t, ...yield* He(e), ...yield* Qe(e), ["body", r.length === 1 ? r[0] : r]];
+}, ContentResource: function* (e) {
+  return rh([...ct(e), ...yield* He(e), ...yield* Qe(e), ["annotations", ne(yield e.annotations)], ["items", ne(yield e.items)]], e);
+}, AnnotationCollection: function* (e) {
+  return [["id", e.id], ["type", "AnnotationCollection"], ["label", e.label]];
+}, Collection: function* (e, t, { isTopLevel: r }) {
+  return r ? [["@context", "http://iiif.io/api/presentation/3/context.json"], ...ct(e), ...yield* He(e), ...yield* Qe(e), ["items", ne(yield e.items)], ["navPlace", e.navPlace]] : [...ct(e), ...yield* He(e)];
+}, Range: function* (e) {
+  let t = [];
+  for (let r of e.items) r.type === "Range" ? t.push(yield r) : r && r.type === "SpecificResource" ? t.push(Bt(r)) : t.push(r);
+  return [...ct(e), ...yield* He(e), ...yield* Qe(e), ["items", t], ["annotations", ne(yield e.annotations)], ["navPlace", e.navPlace]];
+} };
+function rh(e, t) {
+  let r = Object.keys(t), i = e.map(([n]) => n);
+  for (let n of r) n === oe || n === zt || i.indexOf(n) === -1 && typeof t[n] < "u" && e.push([n, t[n]]);
+  return e;
+}
+var se = function(t) {
+  return function() {
+    const r = { type: t, getType: () => t, toString: () => t };
+    return (i, n) => ({
+      ...r,
+      ...i !== void 0 && { payload: i },
+      ...n !== void 0 && { meta: n }
+    });
+  };
+}, Js = "@iiif/IMPORT_ENTITIES", Xs = "@iiif/MODIFY_ENTITY_FIELD", Ks = "@iiif/REORDER_ENTITY_FIELD", Zs = "@iiif/ADD_REFERENCE", pi = "@iiif/UPDATE_REFERENCE", ea = "@iiif/REMOVE_REFERENCE", ta = "@iiif/ADD_METADATA", ra = "@iiif/REMOVE_METADATA", gi = "@iiif/UPDATE_METADATA", ia = "@iiif/REORDER_METADATA", na = se(Js)(), ih = se(Xs)(), nh = se(Ks)(), sh = se(Zs)(), ah = se(ea)(), oh = se(pi)(), ch = se(ta)(), lh = se(gi)(), hh = se(ra)(), uh = se(ia)(), fh = {
+  importEntities: na,
+  modifyEntityField: ih,
+  reorderEntityField: nh,
+  addReference: sh,
+  removeReference: ah,
+  updateReference: oh,
+  addMetadata: ch,
+  removeMetadata: hh,
+  updateMetadata: lh,
+  reorderMetadata: uh
+}, sa = "@iiif/ADD_MAPPING", aa = "@iiif/ADD_MAPPINGS", dh = se(sa)(), ph = se(aa)(), mi = "RESOURCE_ERROR", oa = "RESOURCE_LOADING", vi = "RESOURCE_READY", ca = "@iiif/REQUEST_RESOURCE", la = "@iiif/REQUEST_ERROR", ha = "@iiif/REQUEST_MISMATCH", ua = "@iiif/REQUEST_COMPLETE", gh = "@iiif/REQUEST_OFFLINE_RESOURCE", mh = se(ca)(), yi = se(la)(), vh = se(ha)(), yh = se(ua)(), qi = "@iiif/BATCH", bh = "@iiif/BATCH_IMPORT", bi = se(qi)(), wh = (e, t) => {
+  const { entities: r, resource: i, mapping: n } = Gl(t);
+  if (i.id === void 0)
+    return [yi({ id: e, message: "ID is not defined in resource." })];
+  const s = [na({ entities: r }), ph({ mapping: n })];
+  return i.id !== e && (s.push(dh({ id: e, type: i.type })), s.push(vh({ requestId: e, actualId: i.id }))), s.push(yh({ id: e })), s;
+}, hn = Number.isNaN || function(t) {
+  return typeof t == "number" && t !== t;
+};
+function xh(e, t) {
+  return !!(e === t || hn(e) && hn(t));
+}
+function un(e, t) {
+  if (!Array.isArray(e) || !Array.isArray(t))
+    return e === t;
+  if (e.length !== t.length)
+    return !1;
+  for (let r = 0; r < e.length; r++)
+    if (!xh(e[r], t[r]))
+      return !1;
+  return !0;
+}
+function qr(e, t, r) {
+  const i = e.iiif.requests[t], n = e.iiif.mapping[t];
+  if (!n || !e.iiif.entities[n][i.resourceUri])
+    return;
+  const s = e.iiif.entities[n][i.resourceUri];
+  if (s && s[oe]) {
+    const a = s[oe].find((o) => o[ze] === s.id);
+    return Bi(s, a);
+  }
+  return s;
+}
+function Ch(e) {
+  return e && typeof e.then == "function";
+}
+function fn(e, t, { waitTimeout: r = 30 } = {}) {
+  return (i, n) => {
+    const s = e.getStore(), a = s.getState(), o = a.iiif.requests[i];
+    if (o) {
+      if (o.loadingState === vi) {
+        const h = qr(a, i);
+        if (h)
+          return h;
+      }
+      switch (o.loadingState) {
+        case mi:
+          break;
+        case oa:
+          return (async () => {
+            let h, l = !1;
+            try {
+              const u = await Promise.race([
+                new Promise((f, p) => {
+                  l || (h = s.subscribe(() => {
+                    const d = s.getState();
+                    if (d.iiif.requests[i].loadingState === mi) {
+                      p();
+                      return;
+                    }
+                    if (d.iiif.requests[i].loadingState === vi) {
+                      const m = qr(d, i);
+                      m ? f(m) : p();
+                    }
+                  }));
+                }),
+                new Promise(
+                  (f, p) => setTimeout(
+                    () => {
+                      l = !0, p();
+                    },
+                    r * 60 * 1e3
+                  )
+                )
+              ]);
+              if (h && h(), u)
+                return u;
+            } catch {
+              h && h();
+            }
+          })();
+      }
+    }
+    e.dispatch(mh({ id: i }));
+    const c = (h) => {
+      if (!h)
+        return;
+      !h.id && !h["@id"] && (h["@type"] && (h["@id"] = i), h.id = i);
+      const l = wh(i, h);
+      return e.dispatch(bi({ actions: l })), qr(s.getState(), i);
+    };
+    try {
+      const h = t(i, n);
+      return Ch(h) ? (async () => {
+        try {
+          return c(await h);
+        } catch (l) {
+          throw e.dispatch(yi({ id: i, message: l.toString() })), l;
+        }
+      })() : c(h);
+    } catch (h) {
+      throw e.dispatch(yi({ id: i, message: h.toString() })), h;
+    }
+  };
+}
+var fa = "@iiif/SET_META_VALUE", da = "@iiif/SET_META_VALUE_DYNAMIC", pa = "@iiif/UNSET_META_VALUE", Sh = se(fa)(), Ah = se(da)(), _h = se(pa)(), dn = {
+  setMetaValue: Sh,
+  setMetaValueDynamic: Ah,
+  unsetMetaValue: _h
+};
+function ga() {
+  return {
+    Collection: {},
+    Manifest: {},
+    Canvas: {},
+    AnnotationPage: {},
+    AnnotationCollection: {},
+    Annotation: {},
+    ContentResource: {},
+    Range: {},
+    Service: {},
+    Selector: {},
+    Agent: {}
+  };
+}
+const Hr = { BASE_URL: "./", DEV: !1, MODE: "production", PROD: !0, SSR: !1 };
+var Oh = (e, t) => (r, i, n) => (n.dispatch = (s) => (r((a) => e(a, s), !1, s), s), n.dispatchFromDevtools = !0, { dispatch: (...s) => n.dispatch(...s), ...t }), kh = Oh, wi = /* @__PURE__ */ new Map(), cr = (e) => {
+  const t = wi.get(e);
+  return t ? Object.fromEntries(
+    Object.entries(t.stores).map(([r, i]) => [r, i.getState()])
+  ) : {};
+}, Ih = (e, t, r) => {
+  if (e === void 0)
+    return {
+      type: "untracked",
+      connection: t.connect(r)
+    };
+  const i = wi.get(r.name);
+  if (i)
+    return { type: "tracked", store: e, ...i };
+  const n = {
+    connection: t.connect(r),
+    stores: {}
+  };
+  return wi.set(r.name, n), { type: "tracked", store: e, ...n };
+}, Th = (e, t = {}) => (r, i, n) => {
+  const { enabled: s, anonymousActionType: a, store: o, ...c } = t;
+  let h;
+  try {
+    h = (s ?? (Hr ? "production" : void 0) !== "production") && window.__REDUX_DEVTOOLS_EXTENSION__;
+  } catch {
+  }
+  if (!h)
+    return (Hr ? "production" : void 0) !== "production" && s && console.warn(
+      "[zustand devtools middleware] Please install/enable Redux devtools extension"
+    ), e(r, i, n);
+  const { connection: l, ...u } = Ih(o, h, c);
+  let f = !0;
+  n.setState = (m, g, y) => {
+    const b = r(m, g);
+    if (!f)
+      return b;
+    const w = y === void 0 ? { type: a || "anonymous" } : typeof y == "string" ? { type: y } : y;
+    return o === void 0 ? (l == null || l.send(w, i()), b) : (l == null || l.send(
+      {
+        ...w,
+        type: `${o}/${w.type}`
+      },
+      {
+        ...cr(c.name),
+        [o]: n.getState()
+      }
+    ), b);
+  };
+  const p = (...m) => {
+    const g = f;
+    f = !1, r(...m), f = g;
+  }, d = e(n.setState, i, n);
+  if (u.type === "untracked" ? l == null || l.init(d) : (u.stores[u.store] = n, l == null || l.init(
+    Object.fromEntries(
+      Object.entries(u.stores).map(([m, g]) => [
+        m,
+        m === u.store ? d : g.getState()
+      ])
+    )
+  )), n.dispatchFromDevtools && typeof n.dispatch == "function") {
+    let m = !1;
+    const g = n.dispatch;
+    n.dispatch = (...y) => {
+      (Hr ? "production" : void 0) !== "production" && y[0].type === "__setState" && !m && (console.warn(
+        '[zustand devtools middleware] "__setState" action type is reserved to set state from the devtools. Avoid using it.'
+      ), m = !0), g(...y);
+    };
+  }
+  return l.subscribe((m) => {
+    var g;
+    switch (m.type) {
+      case "ACTION":
+        if (typeof m.payload != "string") {
+          console.error(
+            "[zustand devtools middleware] Unsupported action format"
+          );
+          return;
+        }
+        return Qr(
+          m.payload,
+          (y) => {
+            if (y.type === "__setState") {
+              if (o === void 0) {
+                p(y.state);
+                return;
+              }
+              Object.keys(y.state).length !== 1 && console.error(
+                `
+                    [zustand devtools middleware] Unsupported __setState action format. 
+                    When using 'store' option in devtools(), the 'state' should have only one key, which is a value of 'store' that was passed in devtools(),
+                    and value of this only key should be a state object. Example: { "type": "__setState", "state": { "abc123Store": { "foo": "bar" } } }
+                    `
+              );
+              const b = y.state[o];
+              if (b == null)
+                return;
+              JSON.stringify(n.getState()) !== JSON.stringify(b) && p(b);
+              return;
+            }
+            n.dispatchFromDevtools && typeof n.dispatch == "function" && n.dispatch(y);
+          }
+        );
+      case "DISPATCH":
+        switch (m.payload.type) {
+          case "RESET":
+            return p(d), o === void 0 ? l == null ? void 0 : l.init(n.getState()) : l == null ? void 0 : l.init(cr(c.name));
+          case "COMMIT":
+            if (o === void 0) {
+              l == null || l.init(n.getState());
+              return;
+            }
+            return l == null ? void 0 : l.init(cr(c.name));
+          case "ROLLBACK":
+            return Qr(m.state, (y) => {
+              if (o === void 0) {
+                p(y), l == null || l.init(n.getState());
+                return;
+              }
+              p(y[o]), l == null || l.init(cr(c.name));
+            });
+          case "JUMP_TO_STATE":
+          case "JUMP_TO_ACTION":
+            return Qr(m.state, (y) => {
+              if (o === void 0) {
+                p(y);
+                return;
+              }
+              JSON.stringify(n.getState()) !== JSON.stringify(y[o]) && p(y[o]);
+            });
+          case "IMPORT_STATE": {
+            const { nextLiftedState: y } = m.payload, b = (g = y.computedStates.slice(-1)[0]) == null ? void 0 : g.state;
+            if (!b)
+              return;
+            p(o === void 0 ? b : b[o]), l == null || l.send(
+              null,
+              // FIXME no-any
+              y
+            );
+            return;
+          }
+          case "PAUSE_RECORDING":
+            return f = !f;
+        }
+        return;
+    }
+  }), d;
+}, Ph = Th, Qr = (e, t) => {
+  let r;
+  try {
+    r = JSON.parse(e);
+  } catch (i) {
+    console.error(
+      "[zustand devtools middleware] Could not parse the received json",
+      i
+    );
+  }
+  r !== void 0 && t(r);
+}, jh = (e) => (t, r, i) => {
+  const n = i.subscribe;
+  return i.subscribe = (a, o, c) => {
+    let h = a;
+    if (o) {
+      const l = (c == null ? void 0 : c.equalityFn) || Object.is;
+      let u = a(i.getState());
+      h = (f) => {
+        const p = a(f);
+        if (!l(u, p)) {
+          const d = u;
+          o(u = p, d);
+        }
+      }, c != null && c.fireImmediately && o(u, u);
+    }
+    return n(h);
+  }, e(t, r, i);
+}, $h = jh, Fh = (e = {}, t) => {
+  switch (t.type) {
+    case sa:
+      return {
+        ...e,
+        [t.payload.id]: t.payload.type
+      };
+    case aa:
+      return {
+        ...e,
+        ...t.payload.mapping
+      };
+    default:
+      return e;
+  }
+};
+function Gr(e, t, r, i) {
+  return !(!e[r] || !e[r][t] || !e[r][t][i] || !Array.isArray(e[r][t][i]));
+}
+function Eh(e, t) {
+  const r = {}, i = [];
+  for (const [n, s] of Object.entries(e || {})) {
+    i.push(n);
+    const a = (t || {})[n];
+    if (!a || a.length === 0) {
+      r[n] = s;
+      continue;
+    }
+    r[n] = a;
+  }
+  for (const [n, s] of Object.entries(t || {}))
+    i.indexOf(n) === -1 && (r[n] = s);
+  return r;
+}
+function j(e) {
+  return e.payload;
+}
+function Yr(e, t) {
+  return typeof e > "u" ? t : e;
+}
+var Rh = (e = ga(), t) => {
+  var i;
+  const r = (n, s) => ({
+    ...e,
+    [j(t).type]: {
+      ...e[j(t).type],
+      [j(t).id]: {
+        ...n,
+        ...s
+      }
+    }
+  });
+  switch (t.type) {
+    case Xs: {
+      if (!e[j(t).type] || !e[j(t).type][j(t).id])
+        return e;
+      const n = e[j(t).type][j(t).id];
+      return typeof n == "string" ? e : r(n, { [j(t).key]: j(t).value });
+    }
+    case Ks: {
+      if (!Gr(e, j(t).id, j(t).type, j(t).key))
+        return e;
+      const n = e[j(t).type][j(t).id];
+      if (typeof n == "string")
+        return e;
+      const s = Array.from(n[j(t).key]), [a] = s.splice(j(t).startIndex, 1);
+      return s.splice(j(t).endIndex, 0, a), r(n, { [j(t).key]: s });
+    }
+    case Js: {
+      const n = Object.keys(j(t).entities), s = { ...e };
+      for (const a of n) {
+        const o = j(t).entities[a], c = { ...e[a] || {} };
+        let h = !1;
+        const l = Object.keys(o || {}) || [];
+        if (o && l) {
+          for (const u of l)
+            h = !0, c[u] = e[a][u] ? Eh(e[a][u], o[u]) : o[u];
+          h && (s[a] = c);
+        }
+      }
+      return s;
+    }
+    case Zs: {
+      if (!Gr(e, j(t).id, j(t).type, j(t).key))
+        return e;
+      const n = e[j(t).type][j(t).id], s = Array.from(n[j(t).key]);
+      return s.splice(Yr(j(t).index, s.length + 1), 0, j(t).reference), r(n, { [j(t).key]: s });
+    }
+    case pi:
+    case ea: {
+      if (!Gr(e, j(t).id, j(t).type, j(t).key))
+        return e;
+      const n = e[j(t).type][j(t).id], s = Array.from(n[j(t).key]), a = Yr(
+        j(t).index,
+        s.findIndex((o) => o && o.id === j(t).reference.id)
+      );
+      return a === -1 || ((i = s[a]) == null ? void 0 : i.id) !== j(t).reference.id ? e : (t.type === pi ? s.splice(a, 1, j(t).reference) : s.splice(a, 1), r(n, { [j(t).key]: s }));
+    }
+    case ta: {
+      const n = e[j(t).type][j(t).id];
+      if (!n)
+        return e;
+      const s = Array.from(n.metadata || []), a = j(t);
+      return s.splice(Yr(t.payload.beforeIndex, s.length + 1), 0, {
+        label: a.label,
+        value: a.label
+      }), r(n, { metadata: s });
+    }
+    case ia: {
+      const n = e[j(t).type][j(t).id];
+      if (typeof n == "string" || !n)
+        return e;
+      const s = Array.from(n.metadata || []), [a] = s.splice(j(t).startIndex, 1);
+      return s.splice(j(t).endIndex, 0, a), r(n, { metadata: s });
+    }
+    case gi:
+    case ra: {
+      const n = e[j(t).type][j(t).id], s = Array.from(n.metadata || []), a = j(t).atIndex;
+      return typeof a > "u" || a === -1 || !s[a] ? e : (t.type === gi ? s.splice(a, 1, { label: j(t).label, value: j(t).value }) : s.splice(a, 1), r(n, { metadata: s }));
+    }
+    default:
+      return e;
+  }
+}, Mh = (e = {}, t) => {
+  switch (t.type) {
+    case ca:
+    case gh:
+      return {
+        ...e,
+        [t.payload.id]: {
+          requestUri: t.payload.id,
+          loadingState: oa,
+          uriMismatch: !1,
+          resourceUri: t.payload.id
+        }
+      };
+    case ha:
+      return {
+        ...e,
+        [t.payload.requestId]: {
+          ...e[t.payload.requestId] || {},
+          uriMismatch: !0,
+          resourceUri: t.payload.actualId
+        },
+        [t.payload.actualId]: {
+          requestUri: t.payload.requestId,
+          loadingState: e[t.payload.requestId].loadingState,
+          uriMismatch: !0,
+          resourceUri: t.payload.actualId
+        }
+      };
+    case la:
+      return {
+        ...e,
+        [t.payload.id]: {
+          ...e[t.payload.id] || {},
+          loadingState: mi,
+          error: t.payload.message
+        }
+      };
+    case ua:
+      return {
+        ...e,
+        [t.payload.id]: {
+          ...e[t.payload.id] || {},
+          loadingState: vi,
+          error: void 0
+        }
+      };
+  }
+  return e;
+}, Nh = (e = {}, t) => {
+  const { id: r, updateValue: i, value: n, meta: s, key: a } = t && t.payload || {};
+  switch (t.type) {
+    case fa:
+      return {
+        ...e,
+        [r]: {
+          ...e[r] || {},
+          [s]: {
+            ...e[r] ? e[r][s] || {} : {},
+            [a]: n
+          }
+        }
+      };
+    case da:
+      return {
+        ...e,
+        [r]: {
+          ...e[r] || {},
+          [s]: {
+            ...e[r] ? e[r][s] || {} : {},
+            [a]: e[r] && e[r][s] ? i(e[r][s][a]) : i(void 0)
+          }
+        }
+      };
+    case pa:
+      return e[r] && e[r][s] && e[r][s][a] ? {
+        ...e,
+        [r]: {
+          ...e[r] || {},
+          [s]: {
+            ...e[r] ? e[r][s] || {} : {},
+            [a]: void 0
+          }
+        }
+      } : e;
+    default:
+      return e;
+  }
+};
+function ma(e = {}) {
+  const t = Object.keys(e);
+  return function(i = {}, n) {
+    let s = !1;
+    const a = {};
+    for (let o = 0; o < t.length; o++) {
+      const c = t[o];
+      a[c] = e[c](i[c], n), s = s || a[c] !== i[c];
+    }
+    return s ? a : i;
+  };
+}
+function Dh(e) {
+  return (t, r) => r && r.type === qi ? r.payload.actions.reduce(e, t) : r && r.type === bh ? {
+    ...t,
+    iiif: {
+      ...t.iiif,
+      ...r.payload.state
+    }
+  } : e(t, r);
+}
+var Lh = ma({
+  mapping: Fh,
+  entities: Rh,
+  requests: Mh,
+  meta: Nh
+});
+function Wh() {
+  return {
+    iiif: {
+      entities: ga(),
+      meta: {},
+      mapping: {},
+      requests: {}
+    }
+  };
+}
+function Uh(e = {}) {
+  const {
+    enableDevtools: t = !1,
+    iiifStoreName: r = "iiif",
+    defaultState: i = Wh(),
+    customReducers: n = {}
+  } = e, s = Dh(ma({ [r]: Lh, ...n })), o = !!(typeof window < "u" && window.__REDUX_DEVTOOLS_EXTENSION__) ? Ph : (c, h) => c;
+  return ns(
+    //
+    $h(
+      //
+      o(
+        //
+        kh(s, i),
+        { enabled: t }
+      )
+    )
+  );
+}
+function va(e) {
+  return { all: e = e || /* @__PURE__ */ new Map(), on: function(t, r) {
+    var i = e.get(t);
+    i ? i.push(r) : e.set(t, [r]);
+  }, off: function(t, r) {
+    var i = e.get(t);
+    i && (r ? i.splice(i.indexOf(r) >>> 0, 1) : e.set(t, []));
+  }, emit: function(t, r) {
+    var i = e.get(t);
+    i && i.slice().map(function(n) {
+      n(r);
+    }), (i = e.get("*")) && i.slice().map(function(n) {
+      n(t, r);
+    });
+  } };
+}
+var zh = Object.create, Hi = Object.defineProperty, Bh = Object.getOwnPropertyDescriptor, ya = Object.getOwnPropertyNames, qh = Object.getPrototypeOf, Hh = Object.prototype.hasOwnProperty, Qh = (e, t, r) => t in e ? Hi(e, t, { enumerable: !0, configurable: !0, writable: !0, value: r }) : e[t] = r, ba = (e, t) => function() {
+  return t || (0, e[ya(e)[0]])((t = { exports: {} }).exports, t), t.exports;
+}, Gh = (e, t, r, i) => {
+  if (t && typeof t == "object" || typeof t == "function")
+    for (let n of ya(t))
+      !Hh.call(e, n) && n !== r && Hi(e, n, { get: () => t[n], enumerable: !(i = Bh(t, n)) || i.enumerable });
+  return e;
+}, wa = (e, t, r) => (r = e != null ? zh(qh(e)) : {}, Gh(
+  // If the importer is in node compatibility mode or this is not an ESM
+  // file that has been converted to a CommonJS file using a Babel-
+  // compatible transform (i.e. "__esModule" has not been set), then set
+  // "default" to the CommonJS "module.exports" for node compatibility.
+  Hi(r, "default", { value: e, enumerable: !0 }),
+  e
+)), he = (e, t, r) => (Qh(e, typeof t != "symbol" ? t + "" : t, r), r);
+function fe(e, t, r, i = !0) {
+  t[kt] = t[kt] || [], t[kt].push(e);
+  const n = /* @__PURE__ */ new Map();
+  Object.defineProperty(t, e, {
+    enumerable: i,
+    get() {
+      if (typeof t[ft][e] > "u")
+        return;
+      const s = t[ft][e];
+      if (!s)
+        return s;
+      const a = r.get(t[ft][e], {
+        parent: this.id ? { id: this.id, type: this.type } : void 0
+      });
+      return n.has(a) || (n.clear(), n.set(a, dt(a, r))), n.get(a);
+    },
+    set(s) {
+      t[ft][e] !== s && (this[ut] ? r.modifyEntityField({ id: this.id, type: this.type }, e, xa(s)) : this[ft][e] = s);
+    }
+  });
+}
+var ft = Symbol.for("_refs_"), ut = Symbol.for("_reactive_"), kt = Symbol.for("_defined_"), pn = Symbol.for("_parent_");
+function Yh(e, t = !1, r) {
+  const i = {
+    id: "",
+    type: "unknown",
+    [kt]: [],
+    [ft]: {},
+    [pn]: null,
+    [ut]: null,
+    is(n) {
+      return typeof n == "string" ? this.id === n : n.id ? n.id === this.id : !1;
+    },
+    reactive() {
+      if (!this[ut])
+        return this[ut] = this.subscribe(() => this.refresh(), !0), () => {
+          this.unreactive();
+        };
+    },
+    refresh() {
+      if (this.id) {
+        const n = this.unwrap();
+        for (const s of Object.keys(n || {}))
+          this[kt].includes(s) ? this[ft][s] = n[s] : this[s] = n[s];
+      }
+    },
+    unreactive() {
+      this[ut] && (this[ut](), this[ut] = null);
+    },
+    unwrap() {
+      if (!this.id)
+        throw new Error("Invalid object");
+      const n = this[pn];
+      return e.get(this.id, { parent: n ? { id: n, type: "unknown" } : void 0 });
+    },
+    toPresentation3() {
+      return e.toPresentation3(this.unwrap());
+    },
+    toPresentation2() {
+      return e.toPresentation2(this.unwrap());
+    },
+    valueOf() {
+      return this.unwrap();
+    },
+    toJSON() {
+      const n = this;
+      return {
+        ...n,
+        items: n.items,
+        annotations: n.annotations,
+        structures: n.structures,
+        seeAlso: n.seeAlso,
+        service: n.service,
+        services: n.services,
+        rendering: n.rendering,
+        partOf: n.partOf,
+        start: n.start,
+        supplementary: n.supplementary,
+        homepage: n.homepage,
+        thumbnail: n.thumbnail,
+        placeholderCanvas: n.placeholderCanvas,
+        accompanyingCanvas: n.accompanyingCanvas,
+        provider: n.provider
+      };
+    },
+    subscribe(n, s = !0) {
+      return e.subscribe(
+        () => this.id ? e.get(this.id) : null,
+        n,
+        s
+      );
+    }
+  };
+  return fe("items", i, e), fe("annotations", i, e), fe("structures", i, e), fe("seeAlso", i, e), fe("rendering", i, e), fe("partOf", i, e), fe("start", i, e, !1), fe("supplementary", i, e), fe("homepage", i, e), fe("thumbnail", i, e), fe("placeholderCanvas", i, e, !1), fe("accompanyingCanvas", i, e, !1), fe("provider", i, e), fe("body", i, e), fe("logo", i, e), i;
+}
+function Vh(e) {
+  return !!e[kt];
+}
+function xa(e) {
+  return Array.isArray(e) ? e.map((t) => xa(t)) : !e || !e.type ? e : { id: e.id, type: e.type };
+}
+function dt(e, t, r = !1, i) {
+  if (Array.isArray(e))
+    return e.map((o) => dt(o, t, r));
+  if (!e || !e.type || !e.id)
+    return e;
+  const n = Yh(t, r), s = Object.create(n), a = Object.assign(s, e);
+  return r && a.reactive(), a;
+}
+function gn(e) {
+  switch (e) {
+    case "Image":
+    case "Video":
+    case "Sound":
+    case "Dataset":
+    case "Text":
+    case "Composite":
+    case "List":
+    case "Independents":
+    case "Audience":
+      return "ContentResource";
+    case "ImageService1":
+    case "ImageService2":
+    case "ImageService3":
+      return "Service";
+  }
+  return e;
+}
+var Jh = class {
+  constructor(e, t) {
+    he(this, "options"), he(this, "store"), he(this, "emitter"), he(this, "isBatching", !1), he(this, "batchQueue", []), he(this, "remoteFetcher"), he(this, "staticFetcher"), he(this, "defaultFetcher", (r) => fetch(r).then((i) => {
+      if (i.status === 200)
+        return i.json();
+      {
+        const n = new Error(`${i.status} ${i.statusText}`);
+        throw n.name = "HTTPError", n;
+      }
+    })), this.options = Object.assign(
+      {
+        reducers: {},
+        customFetcher: this.defaultFetcher,
+        enableDevtools: !0
+      },
+      e || {}
+    ), this.store = t || Uh({
+      customReducers: this.options.reducers,
+      defaultState: this.options.defaultState,
+      enableDevtools: this.options.enableDevtools
+    }), this.emitter = va(), this.remoteFetcher = fn(this, this.options.customFetcher), this.staticFetcher = fn(this, (r, i) => i);
+  }
+  batch(e) {
+    this.isBatching = !0;
+    try {
+      e(this), this.isBatching = !1, this.dispatch(bi({ actions: this.batchQueue }));
+    } catch (t) {
+      throw this.batchQueue = [], this.isBatching = !1, t;
+    }
+    this.batchQueue = [];
+  }
+  async asyncBatch(e) {
+    this.isBatching = !0;
+    try {
+      await e(this), this.isBatching = !1, this.dispatch(bi({ actions: this.batchQueue }));
+    } catch (t) {
+      throw this.batchQueue = [], this.isBatching = !1, t;
+    }
+    this.batchQueue = [];
+  }
+  modifyEntityField(e, t, r) {
+    this.dispatch(
+      fh.modifyEntityField({
+        id: e.id,
+        type: e.type,
+        key: t,
+        value: r
+      })
+    );
+  }
+  dispatch(e) {
+    if (this.isBatching)
+      this.batchQueue.push(e);
+    else {
+      if (e.type === qi) {
+        for (const i of e.payload.actions)
+          this.emitter.emit(i.type, { action: i, state: this.store.getState() });
+        this.store.dispatch(e);
+        const r = this.getState();
+        for (const i of e.payload.actions)
+          this.emitter.emit(`after:${i.type}`, { action: i, state: r });
+        return;
+      }
+      this.emitter.emit(e.type, { action: e, state: this.store.getState() }), this.store.dispatch(e);
+      const t = this.store.getState();
+      this.emitter.emit(`after:${e.type}`, { action: e, state: t });
+      return;
+    }
+  }
+  on(e, t) {
+    return this.emitter.on(e, t), () => {
+      this.emitter.off(e, t);
+    };
+  }
+  serialize(e, t) {
+    return Vl(this.getState().iiif, e, t);
+  }
+  toPresentation2(e) {
+    return this.serialize(e, eh);
+  }
+  toPresentation3(e) {
+    return this.serialize(e, th);
+  }
+  hydrate(e, t, r = {}) {
+    return this.get(e, t, { ...r, skipSelfReturn: !1 });
+  }
+  get(e, t, r = {}) {
+    typeof t != "string" && (r = t || {}, t = void 0);
+    const { skipSelfReturn: i = !0 } = r || {};
+    let n = r.parent ? typeof r.parent == "string" ? r.parent : r.parent.id : void 0;
+    if (Array.isArray(e))
+      return e.map((l) => this.get(l, r));
+    const s = this.getState();
+    if (Ze(e) && !r.preserveSpecificResources && (e = e.source), typeof e == "string") {
+      const l = gn(t || s.iiif.mapping[e]);
+      if (!l)
+        return i ? null : { id: e, type: "unknown" };
+      e = { id: e, type: l };
+    }
+    if (e && e.partOf && !n && !r.skipPartOfCheck) {
+      const l = Array.isArray(e.partOf) ? e.partOf[0] : e.partOf;
+      l && (typeof l == "string" && (n = l), typeof l.id == "string" && (n = l.id));
+    }
+    const a = gn(t || (e == null ? void 0 : e.type)), o = e == null ? void 0 : e.id, c = s.iiif.entities[a];
+    if (!c) {
+      const l = s.iiif.requests[o];
+      return l && l.resourceUri !== o ? this.get(l.resourceUri, r) : i ? null : e;
+    }
+    const h = c[e.id];
+    if (h && h[oe]) {
+      const l = h[oe].find((u) => n ? u[ze] === n : u[ze] === h.id);
+      return Bi(h, l);
+    }
+    return c[e.id] || (i ? null : e);
+  }
+  select(e) {
+    return e(this.getState());
+  }
+  getStore() {
+    return this.store;
+  }
+  getState() {
+    return this.store.getState();
+  }
+  deep(e, t) {
+    if (typeof e > "u")
+      return this.get(t, { skipSelfReturn: !1 });
+    if (typeof e == "function")
+      try {
+        const i = e(this.get(t, { skipSelfReturn: !1 })), n = (s) => this.deep(s, i);
+        return n.size = Array.isArray(i) ? i.length : 1, n;
+      } catch {
+        const n = (s) => this.deep(s, void 0);
+        return n.size = 0, n;
+      }
+    const r = (i) => this.deep(i, e);
+    return r.size = Array.isArray(e) ? e.length : 1, r;
+  }
+  loadManifest(e, t) {
+    const r = typeof e == "string" ? e : e.id;
+    return this.load(r, t);
+  }
+  loadCollection(e, t) {
+    const r = typeof e == "string" ? e : e.id;
+    return this.load(r, t);
+  }
+  load(e, t) {
+    const r = typeof e == "string" ? e : e.id;
+    return t ? Promise.resolve(this.staticFetcher(r, t)) : Promise.resolve(this.remoteFetcher(r));
+  }
+  loadSync(e, t) {
+    const r = typeof e == "string" ? e : e.id;
+    return this.staticFetcher(r, t);
+  }
+  loadManifestSync(e, t) {
+    const r = typeof e == "string" ? e : e.id;
+    return this.loadSync(r, t);
+  }
+  loadCollectionSync(e, t) {
+    const r = typeof e == "string" ? e : e.id;
+    return this.loadSync(r, t);
+  }
+  areInputsEqual(e, t) {
+    return un(e, t);
+  }
+  subscribe(e, t, r) {
+    return typeof r > "u" && (typeof t > "u" || t === !1 || t === !0) && (r = t, t = e, e = (i) => i), this.store.subscribe(e, (i) => t(i, this), {
+      equalityFn: un,
+      fireImmediately: !r
+    });
+  }
+  async ensureLoaded(e) {
+    const t = typeof e == "string" ? e : e.id;
+    this.requestStatus(t) || await this.load(t);
+  }
+  requestStatus(e) {
+    return this.select((t) => t.iiif.requests[e]);
+  }
+  getResourceMeta(e, t) {
+    const r = this.getState().iiif.meta[e];
+    if (r)
+      return t ? r[t] : r;
+  }
+  getObject(e, t, r = {}) {
+    const { reactive: i, ...n } = r;
+    return dt(this.get(e, t, n), this, i);
+  }
+  async loadObject(e, t) {
+    return dt(await this.load(e, t), this);
+  }
+  async loadManifestObject(e, t) {
+    return dt(await this.loadManifest(e, t), this);
+  }
+  async loadCollectionObject(e, t) {
+    return dt(await this.loadCollection(e, t), this);
+  }
+  wrapObject(e) {
+    return dt(this.get(e, { skipSelfReturn: !1 }), this);
+  }
+  isWrapped(e) {
+    return Vh(e);
+  }
+  setMetaValue([e, t, r], i) {
+    this.dispatch(
+      typeof i == "function" ? dn.setMetaValueDynamic({
+        id: e,
+        meta: t,
+        key: r,
+        updateValue: i
+      }) : dn.setMetaValue({
+        id: e,
+        meta: t,
+        key: r,
+        value: i
+      })
+    );
+  }
+};
+function Xh() {
+  return typeof self < "u" ? self : typeof window < "u" ? window : typeof global < "u" ? global : {};
+}
+function Kh(e) {
+  const t = Xh();
+  try {
+    const i = t.IIIF_VAULT;
+    if (i)
+      return i;
+  } catch {
+  }
+  const r = new Jh(e);
+  try {
+    t.IIIF_VAULT = r;
+  } catch {
+  }
+  return r;
+}
+function Zh(e, t, r = [], i = !1, n = []) {
+  if (n.length && (t = t.filter((a) => n.indexOf(a) === -1)), !t || t.length === 0)
+    return;
+  if (t.length === 1)
+    return t[0];
+  if (!e)
+    return t.indexOf("none") !== -1 ? "none" : t[0];
+  if (t.indexOf(e) !== -1)
+    return e;
+  const s = e.indexOf("-") !== -1 ? e.slice(0, e.indexOf("-")) : null;
+  if (s && t.indexOf(s) !== -1)
+    return s;
+  for (const a of r)
+    if (t.indexOf(a) !== -1)
+      return a;
+  if (!i && e) {
+    const o = t.map((c) => c.indexOf("-") !== -1 ? c.slice(0, c.indexOf("-")) : null).indexOf(e);
+    if (o !== -1)
+      return t[o];
+    for (const c of r) {
+      const h = c.indexOf("-") !== -1 ? c.slice(0, c.indexOf("-")) : null, l = h ? t.indexOf(h) : -1;
+      if (l !== -1)
+        return t[l];
+    }
+  }
+  return t.indexOf("none") !== -1 ? "none" : t.indexOf("@none") !== -1 ? "@none" : t[0];
+}
+function Ca(e, t, r = {}) {
+  const {
+    strictFallback: i = !1,
+    defaultText: n = "",
+    separator: s = `
+`,
+    fallbackLanguages: a = [],
+    closest: o,
+    skipLanguages: c
+  } = r, h = Object.keys(e || {}), l = o ? t : Zh(t, h, a, i, c);
+  if (!e)
+    return n;
+  if (typeof e == "string")
+    return e;
+  const u = l ? e[l] : void 0;
+  if (u && l) {
+    if (typeof u == "string")
+      return u;
+    if (u.length === 1 && u[0] === "") {
+      const f = r.skipLanguages || [];
+      return Ca(e, t, {
+        ...r,
+        skipLanguages: [...f, l]
+      });
+    }
+    return u.join(s);
+  }
+  return "";
+}
+function eu(e) {
+  try {
+    if (e === "full") return { full: !0 };
+    if (e === "square") return { square: !0 };
+    let t = e.startsWith("pct:"), r = e.substr(t ? 4 : 0).split(",").map((i) => parseFloat(i));
+    return { x: r[0], y: r[1], w: r[2], h: r[3], percent: t };
+  } catch {
+    throw new Error("Expected 'full', 'square' or 'x,y,w,h'. Found " + e);
+  }
+}
+function tu(e) {
+  let t = { upscaled: !1, max: !1, confined: !1 };
+  if (e[0] === "^" && (t.upscaled = !0, e = e.slice(1)), e === "max" || e === "full") return t.max = !0, t.serialiseAsFull = e === "full", t;
+  if (e[0] === "!" && (t.confined = !0, e = e.slice(1)), e[0] === "p") return t.percentScale = parseFloat(e.slice(4)), t;
+  let r = e.split(",").map((i) => i.trim());
+  return r.length && (r[0] !== "" && (t.width = parseInt(r[0], 10)), r[1] !== "" && (t.height = parseInt(r[1], 10))), t;
+}
+function ru(e) {
+  let t = { angle: 0 };
+  if (e[0] === "!" && (t.mirror = !0, e = e.substr(1)), t.angle = parseFloat(e) % 360, Number.isNaN(t.angle)) throw new Error(`Invalid rotation ${e}`);
+  return t;
+}
+function iu(e, t = "") {
+  let r = e.match(/^(([a-zA-Z]+):\/\/([^/]+))?((.*)+)/);
+  if (!r) throw new Error(`Invalid or unknown input ${e}`);
+  let i = r[2], n = r[3], s = r[4];
+  if (s[0] === "/" && (s = s.substring(1)), t.length > 0) {
+    if (t[0] === "/" && (t = t.substring(1)), t !== s.substring(0, t.length)) throw new Error(`Path does not start with prefix (path: ${s}, prefix: ${t})`);
+    s = s.substring(t.length);
+  }
+  return { scheme: i, server: n, path: s, prefix: t };
+}
+function nu(e, t = "") {
+  let { path: r, scheme: i, server: n, prefix: s } = iu(e, t), a = r.split("/").reverse(), [o, c, h, l, ...u] = a, f = u.reverse().filter(Boolean).join("/");
+  if (a.length === 1 || o === "") return { type: "base", scheme: i, server: n, prefix: s, identifier: f };
+  if (o === "info.json") {
+    let [, ...m] = a;
+    return { type: "info", scheme: i, server: n, prefix: s, identifier: m.reverse().filter(Boolean).join("/") };
+  }
+  if (typeof i > "u" || typeof n > "u" || typeof r > "u" || typeof l > "u" || typeof h > "u" || typeof c > "u" || typeof o > "u") throw new Error("Invalid image service URL");
+  let [p = "", d = ""] = o.split(".");
+  return { type: "image", scheme: i, server: n, prefix: s, identifier: f, originalPath: r, region: eu(l), size: tu(h), rotation: ru(c), quality: p, format: d };
+}
+function su(e) {
+  return Rr.indexOf(e) !== -1 ? Oc : Wi.indexOf(e) !== -1 ? _c : Ac;
+}
+function au(e) {
+  let t = e ? Array.isArray(e.profile) ? e.profile : [e.profile] : [], r = { extraQualities: [], extraFormats: [], extraFeatures: [] };
+  for (let i of t) if (typeof i == "string" && (i = su(i)), !!i) {
+    if (i.formats) for (let n of i.formats) r.extraFormats.indexOf(n) === -1 && r.extraFormats.push(n);
+    if (i.qualities) for (let n of i.qualities) r.extraQualities.indexOf(n) === -1 && r.extraQualities.push(n);
+    if (i.supports) for (let n of i.supports) r.extraFeatures.indexOf(n) === -1 && r.extraFeatures.push(n);
+    if (i.maxHeight && (r.maxHeight = i.maxHeight), i.maxWidth && (r.maxWidth = i.maxWidth), i.maxArea && (r.maxArea = i.maxArea), i.extraFormats) for (let n of i.extraFormats) r.extraFormats.indexOf(n) === -1 && r.extraFormats.push(n);
+    if (i.extraQualities) for (let n of i.extraQualities) r.extraQualities.indexOf(n) === -1 && r.extraQualities.push(n);
+    if (i.extraFeatures) for (let n of i.extraFeatures) r.extraFeatures.indexOf(n) === -1 && r.extraFeatures.push(n);
+    i.maxHeight && (r.maxHeight = i.maxHeight), i.maxWidth && (r.maxWidth = i.maxWidth), i.maxArea && (r.maxArea = i.maxArea);
+  }
+  if (e.extraFormats) for (let i of e.extraFormats) r.extraFormats.indexOf(i) === -1 && r.extraFormats.push(i);
+  if (e.extraFeatures) for (let i of e.extraFeatures) r.extraFeatures.indexOf(i) === -1 && r.extraFeatures.push(i);
+  if (e.extraQualities) for (let i of e.extraQualities) r.extraQualities.indexOf(i) === -1 && r.extraQualities.push(i);
+  return r;
+}
+function mn(e) {
+  let t = Array.isArray(e.profile) ? e.profile : [e.profile];
+  for (let r of t) if (typeof r == "string" && Ms.indexOf(r) !== -1) return !0;
+  return !1;
+}
+function Y(e) {
+  if (e["@id"]) return e["@id"];
+  if (e.id) return e.id;
+}
+function Mr(e) {
+  if (!e || !e.profile || !Y(e)) return !1;
+  let t = Array.isArray(e.profile) ? e.profile : [e.profile];
+  for (let r of t) if (typeof r == "string" && Rs.indexOf(r) !== -1) return !0;
+  return !1;
+}
+function ou(e) {
+  if (!Mr(e)) return !1;
+  let t = Array.isArray(e.profile) ? e.profile : [e.profile];
+  for (let r of t) if (typeof r == "string") {
+    if (Wi.indexOf(r) !== -1) return !0;
+  } else {
+    let i = [...r.supports || [], ...r.extraFeatures || []];
+    if (i.indexOf("regionByPx") !== -1 && (i.indexOf("sizeByW") !== -1 || i.indexOf("sizeByWh") !== -1)) return !0;
+  }
+  return !1;
+}
+function cu({ x: e = 0, y: t = 0, w: r, h: i, full: n, square: s, percent: a }) {
+  return "full";
+}
+function lu({ max: e, percentScale: t, upscaled: r, confined: i, width: n, height: s, serialiseAsFull: a, version: o }) {
+  let c = [];
+  return r && c.push("^"), e ? (c.push(a ? "full" : "max"), c.join("")) : (i && c.push("!"), t && c.push(`pct:${t}`), n && c.push(`${n}`), c.push(","), s && o === 3 && c.push(`${s}`), c.join(""));
+}
+function hu(e) {
+  return `${e.mirror ? "!" : ""}${(e.angle || 0) % 360}`;
+}
+function uu(e, t) {
+  let r = e.prefix.startsWith("/") ? e.prefix.substring(1) : e.prefix, i = `${e.scheme}://${e.server}/${r ? `${r}/` : ""}${e.identifier}`, { size: n } = e, { region: s, rotation: a, format: o, quality: c } = e;
+  return [i, cu(s), lu(n), hu(a), `${c}.${o}`].filter(Boolean).join("/");
+}
+function pt(e) {
+  return e.endsWith("info.json") ? e : e.endsWith("/") ? `${e}info.json` : `${e}/info.json`;
+}
+function fu(e) {
+  let t = nu(pt(e.id));
+  if (t.type !== "info") throw new Error("Invalid service URL");
+  let r = au(e);
+  return { identifier: t.identifier, originalPath: "", server: t.server, prefix: t.prefix, scheme: t.scheme, type: "image", quality: r.extraQualities.indexOf("default") === -1 ? r.extraQualities[0] : "default", region: { full: !0 }, size: { max: !0, upscaled: !1, confined: !1 }, format: "jpg", rotation: { angle: 0 } };
+}
+function du(e, t, r) {
+  let i = r.length, n = [];
+  for (let s = 0; s < i; s++) {
+    let a = r[s];
+    if (!a) continue;
+    let o = a.width;
+    n.push(e / o);
+  }
+  return n;
+}
+function pu(e, t, r) {
+  let i = r.length, n = [];
+  for (let s = 0; s < i; s++) {
+    let a = r[s];
+    a && n.push({ width: Math.floor(e / a), height: Math.floor(t / a) });
+  }
+  return n;
+}
+function Vr(e, t) {
+  if (t && t.profile) {
+    let r = t.profile;
+    if (r) {
+      let i = Array.isArray(r) ? r : [r];
+      if (i.includes(`level${e}`) || i.includes(`http://iiif.io/api/image/2/level${e}.json`) || i.includes(`http://iiif.io/api/image/1/level${e}.json`) || i.includes(`http://iiif.io/api/image/1/profiles/level${e}.json`)) return !0;
+      if (e === 2) {
+        for (let n of i) if (Rr.includes(n)) return !0;
+      }
+      if (e === 1) {
+        for (let n of i) if (Wi.includes(n)) return !0;
+      }
+      if (e === 0) {
+        for (let n of i) if (Ms.includes(n)) return !0;
+      }
+    }
+  }
+  return !1;
+}
+function xi(e) {
+  return Mr(e) ? Vr(0, e) ? 0 : Vr(1, e) ? 1 : Vr(2, e) ? 2 : null : null;
+}
+function Sa(e) {
+  let t = e.service ? Array.isArray(e.service) ? e.service : [e.service] : [], r = t.length, i = [];
+  for (let n = 0; n < r; n++) Mr(t[n]) && i.push(t[n]);
+  return i;
+}
+function gu(e) {
+  if (e["@type"]) return e["@type"];
+  if (e.type) return e.type;
+}
+function xt(e) {
+  const t = e.replace(/(https?:\/\/)?(www.)?/i, "");
+  return t.indexOf("/") !== -1 ? t.split("/")[0] : t;
+}
+function mu(e, t, r) {
+  const i = e > t ? e : t, n = r.length, s = [];
+  for (let a = 0; a < n; a++) {
+    const o = r[a];
+    if (!o || o.scaleFactors.length === 0)
+      continue;
+    let c = o.scaleFactors[0];
+    if (!c)
+      continue;
+    let h = i / c;
+    const l = [c];
+    for (; h >= o.width; )
+      c = c * 2, l.push(c), h = h / 2;
+    s.push({
+      ...o,
+      scaleFactors: l
+    });
+  }
+  return s;
+}
+function Jr(e, t, r) {
+  const i = fu({
+    "@context": e.version === 3 ? "http://iiif.io/api/image/3/context.json" : "http://iiif.io/api/image/2/context.json",
+    id: pt(Y(e)),
+    profile: e.level === null || typeof e.level > "u" ? "level0" : `level${e.level}`,
+    type: e.version === 3 ? "ImageService3" : "ImageService2"
+  });
+  return i.size.max = !1, i.size.width = t, i.size.height = r, {
+    id: uu(i),
+    type: "fixed",
+    width: t,
+    height: r || e.height / (e.width || 1) * t,
+    unsafe: e.width > t
+  };
+}
+function vu(e, t, r) {
+  const i = e.width ? e.width : e.maxWidth;
+  return r.height <= e.maxHeight && r.width <= e.maxWidth && r.height >= e.minHeight && r.width >= e.minWidth && (!t || Math.abs(r.width - i) < Math.abs(t.width - i));
+}
+function yu(e, t) {
+  const r = [], i = Object.assign(
+    {
+      unsafeImageService: !1,
+      atAnyCost: !0,
+      fallback: !0,
+      minHeight: 64,
+      minWidth: 64,
+      maxHeight: 1 / 0,
+      maxWidth: 1 / 0,
+      returnAllOptions: !1,
+      preferFixedSize: !1,
+      allowUnsafe: !1,
+      explain: !1,
+      height: 0,
+      width: 0
+    },
+    e
+  ), n = (l, u = 0) => i.explain ? r.push(
+    new Array(u).fill(0).map((f) => "    ").join("") + l().trim()
+  ) : void 0, s = [], a = [];
+  let o = null;
+  n(() => `Using configuration: ${JSON.stringify(i, null, 2)}`);
+  const c = (l, u) => {
+    if (n(() => "Swapping choice", 3), vu(i, u, l)) {
+      if (i.preferFixedSize && l.unsafe) {
+        n(() => `We found an image that was marked as unsafe, but it was the best size. (${l.id})`, 4), a.push(l);
+        return;
+      }
+      i.returnAllOptions && u && a.push(u), n(() => `We found a new image that was the best size. (${l.id})`, 4), o = l;
+    } else i.returnAllOptions && a.push(l);
+  };
+  n(() => `The input shows we have ${t.length} list(s) of candidates to choose from.`);
+  const h = t.length;
+  for (let l = 0; l < h; l++) {
+    const u = t[l]();
+    n(() => `Candidate group ${l}: ${JSON.stringify(u, null, 2)}`, 1);
+    const f = u.length;
+    n(
+      () => `Checking candidate list number ${l} and found ${f} potential ways of creating image(s)`,
+      1
+    );
+    for (let p = 0; p < f; p++) {
+      const d = u[p];
+      if (n(() => `-> Checking candidate ${p}`, 1), d.type === "unknown" && i.atAnyCost && (n(() => `We've found an unknown image type, adding this to the "last resort" list`, 2), s.push(d)), d.type === "fixed" && (d.unsafe ? (n(() => `We've found an unsafe fixed image type, adding this to the "last resort" list`, 2), s.push(d)) : (n(() => "We've found a fixed size image, checking if it matches the request", 2), c(d, o))), d.type === "fixed-service")
+        if (i.unsafeImageService) {
+          n(
+            () => "Checking for an image from the tile source, without calculating the right height and width (unsafeImageService)",
+            2
+          );
+          const m = Jr(d, i.width, i.height);
+          c(m, o);
+        } else {
+          n(() => "Checking for an image from the tile source 3", 2);
+          const m = Jr(d, d.width, d.height);
+          c(m, o);
+        }
+      if (d.type === "variable" && d.maxWidth) {
+        const m = Jr(
+          {
+            id: d.id,
+            width: d.maxWidth,
+            height: d.maxWidth,
+            level: d.level,
+            version: d.version
+          },
+          d.maxWidth
+        );
+        c(m, o);
+      }
+    }
+    if (o && !i.returnAllOptions) {
+      if (o.unsafe || i.allowUnsafe)
+        continue;
+      n(() => `We found a match in choice list number ${l}, no searching any more`);
+      break;
+    }
+  }
+  return i.atAnyCost && a.length === 0 ? (n(
+    () => o ? `We found an image! ${o.id} of type ${o.type}` : 'We found no images, but "atAnyCost" is set, so returning that'
+  ), {
+    best: o || s[0] || null,
+    fallback: s.slice(1),
+    log: r
+  }) : i.returnAllOptions ? (n(() => "Returning all options that we have found"), {
+    best: (i.atAnyCost ? o || a[0] || s[0] : o || a[0]) || null,
+    fallback: [...a, ...s],
+    log: r
+  }) : (n(() => "Returning the best image that we found, and a fallback"), {
+    best: o || a[0] || null,
+    fallback: o ? a : a.slice(1),
+    log: r
+  });
+}
+function Aa(e) {
+  return (e["@context"] ? Array.isArray(e["@context"]) ? e["@context"] : [e["@context"]] : []).indexOf("http://iiif.io/api/image/3/context.json") !== -1;
+}
+function bu(e) {
+  return Mr(e) ? (e && e.sizes ? e.sizes : []).map((t) => ({
+    id: Y(e),
+    type: "fixed-service",
+    height: t.height,
+    width: t.width,
+    level: xi(e),
+    version: Aa(e) ? 3 : 2
+  })) : [];
+}
+function wu(e) {
+  if (!ou(e))
+    return [];
+  const t = [], r = Array.isArray(e.profile) ? e.profile : [e.profile], i = r.length;
+  for (let n = 0; n < i; n++) {
+    const s = r[n];
+    if (s && typeof s != "string" && (s.maxHeight || s.maxWidth))
+      return [
+        {
+          id: Y(e),
+          type: "variable",
+          minWidth: 0,
+          minHeight: 0,
+          maxHeight: s.maxHeight || s.maxWidth,
+          maxWidth: s.maxWidth || s.maxHeight,
+          level: xi(e),
+          version: e["@context"] === "http://iiif.io/api/image/3/context.json" ? 3 : 2
+        }
+      ];
+  }
+  if (e.tiles) {
+    const n = e.tiles.length;
+    for (let s = 0; s < n; s++) {
+      const a = e.tiles[s];
+      a && (a.height || a.width) && t.push({
+        id: Y(e),
+        type: "variable",
+        minHeight: 0,
+        minWidth: 0,
+        maxHeight: a.height || a.width,
+        maxWidth: a.width,
+        level: xi(e),
+        version: Aa(e) ? 3 : 2
+      });
+    }
+  }
+  return t;
+}
+function vn(e) {
+  const t = [], r = e.length;
+  for (let i = 0; i < r; i++) {
+    const n = e[i];
+    if (!n)
+      continue;
+    const s = bu(n);
+    s.length && t.push(...s);
+    const a = wu(n);
+    a.length && t.push(...a);
+  }
+  return t;
+}
+function yn(e) {
+  const t = /^.*\/(full)\/(((\d+),(\d+)?)|max)\/(\d+)\/default\.(jpg|png|jpeg)$/, r = e.match(t);
+  if (r && r[4] && r[5]) {
+    const i = r[1], n = parseInt(r[4], 10), s = parseInt(r[5], 10), a = r[7];
+    if ((i === "max" || i === "full") && n && s && a)
+      return {
+        type: "fixed",
+        id: e,
+        height: s,
+        width: n
+      };
+  }
+  return { type: "unknown", id: e };
+}
+function Ci(e) {
+  if (typeof e == "string")
+    return yn(e);
+  const t = gu(e);
+  if (t !== "Image" && t !== "sc:Image")
+    return null;
+  const r = e, i = Y(r);
+  return i ? i && r.width && r.height ? {
+    id: i,
+    type: "fixed",
+    width: r.width,
+    height: r.height,
+    unsafe: !0
+  } : yn(i) : null;
+}
+function xu(e, t = !0, r) {
+  const i = [], n = Ci(e);
+  if (n === null)
+    return i;
+  const s = e;
+  if (i.push(n), t && s && s.width && s.height) {
+    const a = [], o = Sa(s);
+    for (const c of o) {
+      const h = {
+        id: Y(c),
+        width: s.width,
+        height: s.height
+      };
+      if (r.canLoadSync(h)) {
+        const l = r.loadServiceSync(h);
+        l && (l.height || (l.height = s.height), l.width || (l.width = s.width), a.push(...vn([l])));
+      }
+    }
+    if (a.length)
+      return i.push(...a), i;
+  }
+  return s.service && i.push(...vn(s.service)), i;
+}
+function Cu(e, t) {
+  if (e.length !== t.length)
+    return !1;
+  if (e.length === 0 && t.length === 0)
+    return !0;
+  const r = e.length;
+  let i = !0;
+  for (let s = 0; s < r; s++) {
+    const a = e[s], o = t[s];
+    if (a.width !== o.width || a.height !== o.height) {
+      i = !1;
+      break;
+    }
+  }
+  if (i)
+    return !0;
+  let n = 0;
+  for (let s = 0; s < r; s++)
+    for (let a = 0; a < r; a++)
+      if (e[s].width === t[a].width && e[s].height === t[a].height) {
+        n++;
+        break;
+      }
+  return n === r;
+}
+var _a = class {
+  constructor(t = {}) {
+    he(this, "config", {
+      verificationsRequired: 1,
+      approximateServices: !1,
+      enableFetching: !0,
+      disableThrottling: !1
+    }), he(this, "fetchingCount", 0), he(this, "imageServices", {}), he(this, "knownImageServers", {}), this.config = Object.assign(this.config, t);
+  }
+  /**
+   * Preload image service
+   *
+   * This will preload an image service, fetching details and recording the image server that served
+   * the request. Based on this it will make a template for predicting other image sources from this
+   * server. You can optionally pass in other ids to verify that the prediction is accurate.
+   *
+   */
+  // async preload(id: string, verify?: string[]): Promise<void> {}
+  setConfig(t) {
+    Object.assign(this.config, t);
+  }
+  /**
+   * Sample pre-fetched service
+   *
+   * If you have already fetched an image service, or are creating a viewer that only talks to a single
+   * image server and want to avoid calls, you can sample a service up-front. This will allow you to make
+   * completely synchronous calls to `loadServiceSync` and avoid any network calls for image services.
+   *
+   * @param service
+   * @param preLoaded Mark this as being pre-loaded (default: true)
+   */
+  sample(t, r, i = !0) {
+    const n = xt(Y(t)), s = pt(Y(t)), a = this.knownImageServers[n];
+    return this.imageServices[s] = Object.assign(t, { real: !0 }), !a && t.tiles && !mn(t) ? (this.knownImageServers[n] = {
+      verifications: 0,
+      malformed: !1,
+      root: n,
+      preLoaded: i,
+      sampledId: Y(t),
+      verified: !1,
+      server: null,
+      result: {
+        context: t["@context"] || [],
+        sampledProfile: t.profile,
+        resourceServiceRatio: r && t.height ? r.height / t.height : 1,
+        sampledSizes: t.sizes || [],
+        sizeRatios: du(t.width, t.height, t.sizes || []),
+        sampledTiles: t.tiles || []
+      }
+    }, !0) : this.verify(t);
+  }
+  /**
+   * Preload an image server
+   *
+   * Similar to sample, but faster. This will bypass any checks and the logic contained in this implementation
+   * allowing you to correct mistakes this implementation might have made.
+   *
+   * @param server
+   * @param forceVerify
+   */
+  preLoad(t, r = !0) {
+    this.knownImageServers[t.root] = t, r && (this.knownImageServers[t.root].malformed = !1, this.knownImageServers[t.root].verifications = this.config.verificationsRequired);
+  }
+  /**
+   * Predict
+   *
+   * Predicts what the image service will be for a content resource.
+   *
+   * @param resource
+   * @param verify
+   * @param force
+   */
+  predict(t, r = !1, i = !1) {
+    const n = t == null ? void 0 : t.source, s = xt(Y(t)), a = this.knownImageServers[s], o = pt(Y(t));
+    return this.imageServices[o] ? this.imageServices[o] || null : !this.config.approximateServices || !a || !a.result || !(n != null && n.height || t.height) || !(n != null && n.width || t.width) || !i && (a.malformed || a.verifications < this.config.verificationsRequired) || t.source && mn(t.source) ? null : (this.imageServices[o] || (this.imageServices[o] = {
+      "@context": a.result.context,
+      "@id": Y(t),
+      id: Y(t),
+      protocol: "http://iiif.io/api/image",
+      tiles: (n == null ? void 0 : n.tiles) || mu(t.width, t.height, a.result.sampledTiles),
+      sizes: (n == null ? void 0 : n.sizes) || pu(
+        Math.round(t.width / a.result.resourceServiceRatio),
+        Math.round(t.height / a.result.resourceServiceRatio),
+        a.result.sizeRatios
+      ),
+      profile: (n == null ? void 0 : n.profile) || a.result.sampledProfile,
+      height: (n == null ? void 0 : n.height) || t.height,
+      width: (n == null ? void 0 : n.width) || t.width,
+      real: !1
+    }), this.imageServices[o] || null);
+  }
+  async getThumbnailFromResource(t, r, i = !0, n = []) {
+    const s = t ? await this.getImageCandidates(t, i) : [];
+    return yu(r, [() => n, () => s]);
+  }
+  async getImageCandidates(t, r = !0) {
+    const i = t;
+    if (r && i && i.height && i.width) {
+      const n = Sa(i);
+      for (const s of n) {
+        const a = {
+          id: Y(s),
+          width: s.width ? s.width : i.width,
+          height: s.height ? s.height : i.height,
+          source: s
+        };
+        await this.loadService(a);
+      }
+    }
+    return xu(t, r, this);
+  }
+  /**
+   * Verify approximation
+   *
+   * Given an image service, it will dereference that image service and compare the result with what
+   * would have been generated if we used internal guessing.
+   *
+   * @param resource
+   * @return Promise<boolean>
+   */
+  async verify(t) {
+    const r = this.predict(t, !1, !0), i = await this.fetchService(Y(t));
+    if (!r)
+      return !1;
+    const n = r.height === i.height && r.width === i.width && r["@context"] === i["@context"] && Cu(r.sizes || [], i.sizes || []);
+    if (n) {
+      const s = xt(Y(t)), a = this.knownImageServers[s];
+      a && (a.verifications += 1, a.verifications >= this.config.verificationsRequired && (a.verified = !0));
+    }
+    return n;
+  }
+  canLoadSync(t) {
+    const r = typeof t == "string" ? t : Y(t), i = pt(r);
+    if (this.imageServices[i])
+      return !0;
+    const n = this.knownImageServers[xt(r)];
+    return !!(n && !n.malformed && n.verifications >= this.config.verificationsRequired);
+  }
+  /**
+   * Mark image service as malformed
+   *
+   * If you run into issues requesting images, you can mark an image service as malformed, and it will
+   * return you a new one. Future image services will also be requested fresh, and the system will have
+   * failed. Report a bug if this happens.
+   *
+   * @param resource
+   */
+  async markAsMalformed(t) {
+    return this.knownImageServers[xt(Y(t))].malformed = !0, this.loadService(t, !0);
+  }
+  /**
+   * Fetch an image service (use loadService instead)
+   *
+   * @param serviceId
+   * @param forceFresh
+   */
+  async fetchService(t, r = !1) {
+    const i = pt(t), n = this.imageServices[i];
+    if (n && (!r || n.real))
+      return n;
+    if (!this.config.enableFetching)
+      throw new Error("Fetching is not enabled");
+    const s = await this.fetch(i).then((a) => a.json());
+    return !s.id && s["@id"] && (s.id = s["@id"]), s.id !== t && (s.id = t, s["@id"] && (s["@id"] = t)), this.imageServices[i] = Object.assign(s, { real: !0 }), this.imageServices[i];
+  }
+  async fetch(t, r) {
+    return fetch(t, r);
+  }
+  /**
+   * Load an image service
+   *
+   * @param resource
+   * @param forceFresh
+   *
+   * @todo make this batched, so only the maximum required can be done at once, to allow
+   *       for the prediction engine to kick in.
+   */
+  async loadService(t, r = !1) {
+    if (!this.config.disableThrottling) {
+      let s = !0;
+      for (; s; )
+        if (this.fetchingCount >= this.config.verificationsRequired)
+          await new Promise((a) => setTimeout(a, 500));
+        else {
+          s = !1;
+          break;
+        }
+    }
+    const i = this.knownImageServers[xt(Y(t))];
+    if (i && !i.malformed && !r) {
+      await i.result;
+      const s = this.loadServiceSync(t);
+      if (s)
+        return s;
+    }
+    this.fetchingCount++;
+    const n = await this.fetchService(Y(t), r);
+    return this.fetchingCount--, n.real && this.sample(n, t), n;
+  }
+  /**
+   * Load service synchronously
+   *
+   * If you know that the image service you are
+   * @param resource
+   */
+  loadServiceSync(t) {
+    const r = pt(Y(t));
+    return this.imageServices[r] ? this.imageServices[r] : this.config.approximateServices ? this.predict(t) : null;
+  }
+};
+function Su(e = {}) {
+  const t = e.events || va(), r = e.loader || new _a();
+  return {
+    store: ns((n, s) => ({
+      loaded: {},
+      loadServiceSync: (a, o, c) => {
+        const h = a.id || a["@id"], l = s().loaded[h];
+        if (l && l.status === "done")
+          return l.service;
+        if (l && l.status === "loading")
+          return null;
+        if (l && l.status === "error")
+          throw new Error("Failed to load image service");
+        const u = {
+          id: Y(a),
+          width: a.width || (o == null ? void 0 : o.width) || 0,
+          height: a.height || (o == null ? void 0 : o.height) || 0,
+          source: a
+        }, f = r.loadServiceSync(u);
+        return f ? (n((p) => ({
+          loaded: {
+            ...p.loaded,
+            [h]: {
+              status: "done",
+              service: f,
+              real: !0
+            }
+          }
+        })), t.emit("image-service.loaded", { id: h, service: f })) : c && s().loadService(a, o).then(() => {
+        }), f;
+      },
+      loadService: async (a, o) => {
+        const c = a.id || a["@id"], h = s().loaded[c];
+        if (h && h.status === "done")
+          return h.service;
+        if (h && h.status === "loading")
+          return new Promise((l, u) => {
+            const f = (p) => {
+              p.id === c && (t.off("image-service.loaded", f), l(p.service || a));
+            };
+            t.on("image-service.loaded", f);
+          });
+        if (h && h.status === "error" && !(o != null && o.force))
+          throw new Error("Failed to load image service");
+        t.emit("image-service.loading", { id: c });
+        try {
+          const l = {
+            id: Y(a),
+            width: a.width || 0,
+            height: a.height || 0,
+            source: a
+          }, u = await r.loadService(l, o == null ? void 0 : o.force);
+          return n((f) => ({
+            loaded: {
+              ...f.loaded,
+              [c]: {
+                status: "done",
+                service: u,
+                real: u.real
+              }
+            }
+          })), t.emit("image-service.loaded", { id: c, service: u }), u;
+        } catch (l) {
+          throw t.emit("image-service.error", { id: c, error: l }), l;
+        }
+      }
+    })),
+    events: t
+  };
+}
+Su();
+var Au = new _a();
+function _u(e = zi, t = {}) {
+  const r = t.imageServiceLoader || Au;
+  async function i(n, s, a = !1, o = [], c) {
+    const h = () => r.getThumbnailFromResource(void 0, s, a, o);
+    if (!n)
+      return await r.getThumbnailFromResource(void 0, s, a, o);
+    if (typeof n == "string") {
+      const f = Ci(n);
+      return f && o.push(f), await r.getThumbnailFromResource(void 0, s, a, o);
+    }
+    const l = e.get(n, { skipSelfReturn: !1 });
+    if (typeof l == "string")
+      return { best: Ci(l), fallback: [], log: [] };
+    if (!l)
+      return await h();
+    switch (await (async (f) => {
+      if (f && f.thumbnail && f.thumbnail.length) {
+        const p = e.get(f.thumbnail[0]), d = await r.getImageCandidates(p, a);
+        d && d.length && o.push(...d);
+      }
+    })(l), l.type) {
+      case "Annotation": {
+        const f = Array.isArray(l.body) ? l.body : [l.body], p = e.get(f[0]);
+        return c && !p.width && (p.width = c.width, p.height = c.height), await r.getThumbnailFromResource(p, s, a, o);
+      }
+      case "Canvas": {
+        const f = l;
+        return i(f.items[0], s, a, o, {
+          width: f.width,
+          height: f.height
+        });
+      }
+      case "AnnotationPage":
+        return i(l.items[0], s, a, o, c);
+      case "Choice": {
+        const f = l;
+        return !f.items || f.items[0] ? await h() : i(f.items[0], s, a, o, c);
+      }
+      case "Collection": {
+        const p = l.items[0];
+        return p ? i(p, s, a, o, c) : await h();
+      }
+      case "Manifest": {
+        const p = l.items[0];
+        return p ? i(p, s, a, o, c) : await h();
+      }
+      case "SpecificResource":
+      case "Image":
+      case "Dataset":
+      case "Sound":
+      case "Text":
+      case "TextualBody":
+      case "Video":
+        return c && !l.width && (l.width = c.width, l.height = c.height), r.getThumbnailFromResource(l, s, a, o);
+    }
+    return await h();
+  }
+  return {
+    getBestThumbnailAtSize: i
+  };
+}
+var Ou = ba({
+  "node_modules/.pnpm/parse-svg-path@0.1.2/node_modules/parse-svg-path/index.js"(e, t) {
+    t.exports = n;
+    var r = { a: 7, c: 6, h: 1, l: 2, m: 2, q: 4, s: 4, t: 2, v: 1, z: 0 }, i = /([astvzqmhlc])([^astvzqmhlc]*)/ig;
+    function n(o) {
+      var c = [];
+      return o.replace(i, function(h, l, u) {
+        var f = l.toLowerCase();
+        for (u = a(u), f == "m" && u.length > 2 && (c.push([l].concat(u.splice(0, 2))), f = "l", l = l == "m" ? "l" : "L"); ; ) {
+          if (u.length == r[f])
+            return u.unshift(l), c.push(u);
+          if (u.length < r[f])
+            throw new Error("malformed path data");
+          c.push([l].concat(u.splice(0, r[f])));
+        }
+      }), c;
+    }
+    var s = /-?[0-9]*\.?[0-9]+(?:e[-+]?\d+)?/ig;
+    function a(o) {
+      var c = o.match(s);
+      return c ? c.map(Number) : [];
+    }
+  }
+}), ku = ba({
+  "node_modules/.pnpm/abs-svg-path@0.1.1/node_modules/abs-svg-path/index.js"(e, t) {
+    t.exports = r;
+    function r(i) {
+      var n = 0, s = 0, a = 0, o = 0;
+      return i.map(function(c) {
+        c = c.slice();
+        var h = c[0], l = h.toUpperCase();
+        if (h != l)
+          switch (c[0] = l, h) {
+            case "a":
+              c[6] += a, c[7] += o;
+              break;
+            case "v":
+              c[1] += o;
+              break;
+            case "h":
+              c[1] += a;
+              break;
+            default:
+              for (var u = 1; u < c.length; )
+                c[u++] += a, c[u++] += o;
+          }
+        switch (l) {
+          case "Z":
+            a = n, o = s;
+            break;
+          case "H":
+            a = c[1];
+            break;
+          case "V":
+            o = c[1];
+            break;
+          case "M":
+            a = n = c[1], o = s = c[2];
+            break;
+          default:
+            a = c[c.length - 2], o = c[c.length - 1];
+        }
+        return c;
+      });
+    }
+  }
+}), Iu = /* @__PURE__ */ function() {
+  function e(t, r) {
+    var i = [], n = !0, s = !1, a = void 0;
+    try {
+      for (var o = t[Symbol.iterator](), c; !(n = (c = o.next()).done) && (i.push(c.value), !(r && i.length === r)); n = !0)
+        ;
+    } catch (h) {
+      s = !0, a = h;
+    } finally {
+      try {
+        !n && o.return && o.return();
+      } finally {
+        if (s)
+          throw a;
+      }
+    }
+    return i;
+  }
+  return function(t, r) {
+    if (Array.isArray(t))
+      return t;
+    if (Symbol.iterator in Object(t))
+      return e(t, r);
+    throw new TypeError("Invalid attempt to destructure non-iterable instance");
+  };
+}(), qt = Math.PI * 2, Xr = function(t, r, i, n, s, a, o) {
+  var c = t.x, h = t.y;
+  c *= r, h *= i;
+  var l = n * c - s * h, u = s * c + n * h;
+  return {
+    x: l + a,
+    y: u + o
+  };
+}, Tu = function(t, r) {
+  var i = r === 1.5707963267948966 ? 0.551915024494 : r === -1.5707963267948966 ? -0.551915024494 : 1.3333333333333333 * Math.tan(r / 4), n = Math.cos(t), s = Math.sin(t), a = Math.cos(t + r), o = Math.sin(t + r);
+  return [{
+    x: n - s * i,
+    y: s + n * i
+  }, {
+    x: a + o * i,
+    y: o - a * i
+  }, {
+    x: a,
+    y: o
+  }];
+}, bn = function(t, r, i, n) {
+  var s = t * n - r * i < 0 ? -1 : 1, a = t * i + r * n;
+  return a > 1 && (a = 1), a < -1 && (a = -1), s * Math.acos(a);
+}, Pu = function(t, r, i, n, s, a, o, c, h, l, u, f) {
+  var p = Math.pow(s, 2), d = Math.pow(a, 2), m = Math.pow(u, 2), g = Math.pow(f, 2), y = p * d - p * g - d * m;
+  y < 0 && (y = 0), y /= p * g + d * m, y = Math.sqrt(y) * (o === c ? -1 : 1);
+  var b = y * s / a * f, w = y * -a / s * u, F = l * b - h * w + (t + i) / 2, x = h * b + l * w + (r + n) / 2, A = (u - b) / s, I = (f - w) / a, C = (-u - b) / s, S = (-f - w) / a, E = bn(1, 0, A, I), _ = bn(A, I, C, S);
+  return c === 0 && _ > 0 && (_ -= qt), c === 1 && _ < 0 && (_ += qt), [F, x, E, _];
+}, ju = function(t) {
+  var r = t.px, i = t.py, n = t.cx, s = t.cy, a = t.rx, o = t.ry, c = t.xAxisRotation, h = c === void 0 ? 0 : c, l = t.largeArcFlag, u = l === void 0 ? 0 : l, f = t.sweepFlag, p = f === void 0 ? 0 : f, d = [];
+  if (a === 0 || o === 0)
+    return [];
+  var m = Math.sin(h * qt / 360), g = Math.cos(h * qt / 360), y = g * (r - n) / 2 + m * (i - s) / 2, b = -m * (r - n) / 2 + g * (i - s) / 2;
+  if (y === 0 && b === 0)
+    return [];
+  a = Math.abs(a), o = Math.abs(o);
+  var w = Math.pow(y, 2) / Math.pow(a, 2) + Math.pow(b, 2) / Math.pow(o, 2);
+  w > 1 && (a *= Math.sqrt(w), o *= Math.sqrt(w));
+  var F = Pu(r, i, n, s, a, o, u, p, m, g, y, b), x = Iu(F, 4), A = x[0], I = x[1], C = x[2], S = x[3], E = Math.abs(S) / (qt / 4);
+  Math.abs(1 - E) < 1e-7 && (E = 1);
+  var _ = Math.max(Math.ceil(E), 1);
+  S /= _;
+  for (var R = 0; R < _; R++)
+    d.push(Tu(C, S)), C += S;
+  return d.map(function(V) {
+    var H = Xr(V[0], a, o, g, m, A, I), z = H.x, B = H.y, D = Xr(V[1], a, o, g, m, A, I), X = D.x, W = D.y, Ae = Xr(V[2], a, o, g, m, A, I), $ = Ae.x, q = Ae.y;
+    return { x1: z, y1: B, x2: X, y2: W, x: $, y: q };
+  });
+}, $u = ju, Fu = wa(Ou()), Eu = wa(ku());
+function Ru(e) {
+  const t = (0, Fu.default)(e), r = (0, Eu.default)(t);
+  let i, n = 0, s = 0, a = 0, o = 0, c, h, l = 0, u = 0;
+  const f = [];
+  for (let p = 0; p < r.length; p++) {
+    let d = r[p];
+    const m = d[0];
+    switch (m) {
+      case "M":
+        n = d[1], s = d[2];
+        break;
+      case "H":
+        d = ["L", d[1], s];
+        break;
+      case "V":
+        d = ["L", n, d[1]];
+        break;
+      case "S":
+        {
+          let g = l, y = u;
+          (i === "C" || i == "S") && (g += g - a, y += y - o), d = ["C", g, y, d[1], d[2], d[3], d[4]];
+        }
+        break;
+      case "T":
+        i === "Q" || i == "T" ? (c = l * 2 - c, h = u * 2 - h) : (c = l, h = u), d = ["Q", c, h, d[1], d[2]];
+        break;
+      case "Q":
+        c = d[1], h = d[2];
+        break;
+      case "A":
+        {
+          const g = $u({
+            px: l,
+            py: u,
+            cx: d[6],
+            cy: d[7],
+            rx: d[1],
+            ry: d[2],
+            xAxisRotation: d[3],
+            largeArcFlag: d[4],
+            sweepFlag: d[5]
+          });
+          if (!g.length)
+            continue;
+          for (const [y, b] of g.entries())
+            d = ["C", b.x1, b.y1, b.x2, b.y2, b.x, b.y], y < g.length - 1 && f.push(d);
+          d = d;
+        }
+        break;
+      case "Z":
+        d = ["L", n, s];
+        break;
+    }
+    i = m, l = d[d.length - 2], u = d[d.length - 1], ["C", "Q", "A"].indexOf(m) > -1 ? (a = d[d.length - 4], o = d[d.length - 3]) : (a = l, o = u), f.push(d);
+  }
+  return f;
+}
+function Mu(e, t, r, i = 1) {
+  return new Oa(e, t, r).subdivide(i);
+}
+function Nu(e, t, r, i, n = 1) {
+  return new Lu(
+    new Float64Array([e.x, e.y, t.x, t.y, r.x, r.y, i.x, i.y])
+  ).subdivide(n);
+}
+function Du(e) {
+  return e.x * e.x + e.y * e.y;
+}
+function Ht(e) {
+  return e / (1 - 0.67 + Math.pow(Math.pow(0.67, 4) + 0.25 * e * e, 0.25));
+}
+function It(e) {
+  return e * (1 - 0.39 + Math.sqrt(0.39 * 0.39 + 0.25 * e * e));
+}
+var Oa = class {
+  constructor(e, t, r) {
+    he(this, "start"), he(this, "control"), he(this, "end"), this.start = e, this.control = t, this.end = r;
+  }
+  eval(e) {
+    const t = 1 - e;
+    return {
+      x: this.start.x * t * t + 2 * this.control.x * t * e + this.end.x * e * e,
+      y: this.start.y * t * t + 2 * this.control.y * t * e + this.end.y * e * e
+    };
+  }
+  mapToBasic() {
+    const { x: e, y: t } = this.start, { x: r, y: i } = this.control, { x: n, y: s } = this.end, a = 2 * r - e - n, o = 2 * i - t - s, c = (r - e) * a + (i - t) * o, h = (n - r) * a + (s - i) * o, l = (n - e) * o - (s - t) * a, u = c / l, f = h / l, p = Math.abs(l) / (Math.hypot(a, o) * Math.abs(f - u));
+    return { x0: e, x2: n, scale: p, cross: l };
+  }
+  subdivide(e) {
+    const t = this.mapToBasic(), r = Ht(t.x0), i = Ht(t.x2), n = 0.5 * Math.abs(i - r) * Math.sqrt(t.scale / e), s = Math.ceil(n), a = It(r), o = It(i), c = [0];
+    for (let h = 1; h < s; h++) {
+      const u = (It(r + (i - r) * h / s) - a) / (o - a);
+      c.push(u);
+    }
+    return c.push(1), c.map((h) => this.eval(h));
+  }
+}, Lu = class ka {
+  /// Argument is array of coordinate values [x0, y0, x1, y1, x2, y2, x3, y3].
+  constructor(t) {
+    he(this, "c"), this.c = t;
+  }
+  weightsum(t, r, i, n) {
+    const s = t * this.c[0] + r * this.c[2] + i * this.c[4] + n * this.c[6], a = t * this.c[1] + r * this.c[3] + i * this.c[5] + n * this.c[7];
+    return { x: s, y: a };
+  }
+  eval(t) {
+    const r = 1 - t, i = r * r * r, n = 3 * r * r * t, s = 3 * r * t * t, a = t * t * t;
+    return this.weightsum(i, n, s, a);
+  }
+  deriv(t) {
+    const r = 1 - t, i = -3 * r * r, n = 3 * t * t, s = -6 * t * r - i, a = 6 * t * r - n;
+    return this.weightsum(i, s, a, n);
+  }
+  // quadratic bezier with matching endpoints and minimum max vector error
+  midpoint_quadbez() {
+    const t = this.weightsum(-0.25, 0.75, 0.75, -0.25);
+    return new Oa({ x: this.c[0], y: this.c[1] }, t, { x: this.c[6], y: this.c[7] });
+  }
+  subsegment(t, r) {
+    const i = new Float64Array(8), n = this.eval(t), s = this.eval(r);
+    i[0] = n.x, i[1] = n.y;
+    const a = (r - t) / 3, o = this.deriv(t);
+    i[2] = n.x + a * o.x, i[3] = n.y + a * o.y;
+    const c = this.deriv(r);
+    return i[4] = s.x - a * c.x, i[5] = s.y - a * c.y, i[6] = s.x, i[7] = s.y, new ka(i);
+  }
+  // Very fancy subdivision scheme
+  subdivide(t) {
+    const r = 0.1 * t, i = t - r, n = Math.sqrt(i), s = Du(this.weightsum(1, -3, 3, -1)), a = Math.ceil(Math.pow(s / (432 * r * r), 1 / 6)), o = [];
+    let c = 0;
+    for (let d = 0; d < a; d++) {
+      const m = d / a, g = (d + 1) / a, y = this.subsegment(m, g).midpoint_quadbez(), b = y.mapToBasic(), w = Ht(b.x0), F = Ht(b.x2), x = Math.sqrt(b.scale);
+      let A = Math.abs(F - w) * x;
+      if (Math.sign(b.x0) != Math.sign(b.x2)) {
+        const I = n / x, C = n * Math.abs(F - w) / Ht(I);
+        A = Math.max(A, C);
+      }
+      o.push({
+        quad: y,
+        a0: w,
+        a2: F,
+        val: A
+      }), c += A;
+    }
+    const h = 0.5 * c / n, l = Math.ceil(h), u = [{ x: this.c[0], y: this.c[1] }];
+    let f = 0, p = 0;
+    for (let d = 1; d < l; d++) {
+      const m = c * d / l;
+      for (; f + o[p].val < m; )
+        f += o[p].val, p++;
+      const g = o[p].a0, y = o[p].a2, b = It(g), w = It(y), F = g + (y - g) * (m - f) / o[p].val, A = (It(F) - b) / (w - b);
+      u.push(o[p].quad.eval(A));
+    }
+    return u.push({ x: this.c[6], y: this.c[7] }), u;
+  }
+}, Wu = /&?(xywh=)?(pixel:|percent:|pct:)?([0-9]+(?:\.[0-9]+)?),([0-9]+(?:\.[0-9]+)?),([0-9]+(?:\.[0-9]+)?),([0-9]+(?:\.[0-9]+)?)/, wn = /&?(t=)(npt:)?([0-9]+(\.[0-9]+)?)?(,([0-9]+(\.[0-9]+)?))?/, xn = /^rgba\((\d+),(\d+),(\d+),([0-9.]+)\)$/;
+function pr(e, {
+  domParser: t,
+  svgPreprocessor: r,
+  iiifRenderingHints: i
+} = {}) {
+  if (Array.isArray(e))
+    return be(
+      e.reduce(
+        (n, s) => {
+          const {
+            selector: a,
+            selectors: o,
+            iiifRenderingHints: c
+          } = pr(s, { domParser: t, svgPreprocessor: r, iiifRenderingHints: i });
+          return a && (n.selector || (n.selector = a), n.selectors.push(...o)), c && (n.iiifRenderingHints = n.iiifRenderingHints || { type: "ImageApiSelector" }, Object.assign(n.iiifRenderingHints, c)), n;
+        },
+        {
+          selector: null,
+          selectors: [],
+          iiifRenderingHints: i
+        }
+      )
+    );
+  if (!e)
+    return be({
+      selector: null,
+      selectors: [],
+      iiifRenderingHints: i
+    });
+  if (typeof e == "string") {
+    const [n, s] = e.split("#");
+    return s ? pr(
+      { type: "FragmentSelector", value: s },
+      { svgPreprocessor: r, iiifRenderingHints: i, domParser: t }
+    ) : be({
+      selector: null,
+      selectors: [],
+      iiifRenderingHints: i
+    });
+  }
+  if (e.type) {
+    if (e.type === "PointSelector" && (e.t || e.t === 0)) {
+      const n = {
+        type: "TemporalSelector",
+        temporal: {
+          startTime: e.t
+        }
+      };
+      return be({
+        selector: n,
+        selectors: [n],
+        iiifRenderingHints: i
+      });
+    }
+    if (e.type === "PointSelector" && e.x && e.y) {
+      const n = {
+        type: "PointSelector",
+        spatial: {
+          x: e.x,
+          y: e.y
+        }
+      };
+      return be({
+        selector: n,
+        selectors: [n],
+        iiifRenderingHints: i
+      });
+    }
+  }
+  if (qu(e)) {
+    const n = [];
+    if (e.region) {
+      const s = pr(
+        { type: "FragmentSelector", value: "xywh=" + e.region },
+        { domParser: t, svgPreprocessor: r, iiifRenderingHints: i }
+      );
+      n.push(...s.selectors);
+    }
+    return be({
+      selector: n[0],
+      selectors: n,
+      iiifRenderingHints: i ? { ...i, ...e } : e
+    });
+  }
+  if (e.type === "FragmentSelector") {
+    const n = Wu.exec(e.value);
+    if (n) {
+      let a = {
+        type: "BoxSelector",
+        spatial: {
+          unit: n[2] === "percent:" || n[2] === "pct:" ? "percent" : "pixel",
+          x: parseFloat(n[3]),
+          y: parseFloat(n[4]),
+          width: parseFloat(n[5]),
+          height: parseFloat(n[6])
+        }
+      };
+      const o = e.value.match(wn);
+      return o && (a = {
+        type: "TemporalBoxSelector",
+        spatial: a.spatial,
+        temporal: {
+          startTime: o[3] ? parseFloat(o[3]) : 0,
+          endTime: o[6] ? parseFloat(o[6]) : void 0
+        }
+      }), be({
+        selector: a,
+        selectors: [a],
+        iiifRenderingHints: i
+      });
+    }
+    const s = e.value.match(wn);
+    if (s) {
+      const a = {
+        type: "TemporalSelector",
+        temporal: {
+          startTime: s[3] ? parseFloat(s[3]) : 0,
+          endTime: s[6] ? parseFloat(s[6]) : void 0
+        }
+      };
+      return be({
+        selector: a,
+        selectors: [a],
+        iiifRenderingHints: i
+      });
+    }
+    return be({
+      selector: null,
+      selectors: [],
+      iiifRenderingHints: i
+    });
+  }
+  if (e.type === "SvgSelector" && "value" in e) {
+    t || (typeof window < "u" ? t = new window.DOMParser() : console.warn(
+      "No DOMParser available, cannot parse SVG selector, `points`, `spatial` and `style` will be unavailable and the SVG will not be normalized."
+    ));
+    let n = [], s, a, o = (r == null ? void 0 : r(e.value)) ?? e.value, c;
+    if (t) {
+      const l = t.parseFromString(e.value, "image/svg+xml").querySelector("svg");
+      if (!l)
+        return console.warn(`Illegal SVG selector: ${e.value}`), be({
+          selector: null,
+          selectors: [],
+          iiifRenderingHints: i
+        });
+      const u = Ia(l);
+      u && (n = u.points, c = u.shapeType, s = [
+        Math.min(...n.map((f) => f[0])),
+        // llx
+        Math.min(...n.map((f) => f[1])),
+        // lly
+        Math.max(...n.map((f) => f[0])),
+        // urx
+        Math.max(...n.map((f) => f[1]))
+        // ury
+      ], { style: a, svg: o } = Bu(u.element) ?? { svg: o });
+    }
+    const h = {
+      type: "SvgSelector",
+      svg: o,
+      svgShape: c,
+      style: a,
+      points: n.length ? n : void 0,
+      spatial: s ? { unit: "pixel", x: s[0], y: s[1], width: s[2] - s[0], height: s[3] - s[1] } : void 0
+    };
+    return be({
+      selector: h,
+      selectors: [h],
+      iiifRenderingHints: i
+    });
+  }
+  return be({
+    selector: null,
+    selectors: [],
+    iiifRenderingHints: i
+  });
+}
+function Uu(e) {
+  const t = e.map((i) => i[0]).reduce(
+    (i, n) => (i[n] += 1, i),
+    { C: 0, Q: 0, L: 0, M: 0 }
+  ), r = new Set(e.map((i) => i[0]));
+  if (t.C > 0 || t.Q > 0)
+    return "path";
+  if (t.L > 0 && (r.size === 1 || r.size === 2 && r.has("M"))) {
+    if (t.L === 4)
+      return "rect";
+    const i = e.slice(-1)[0];
+    return e[0][0] === "M" && i[0] === "L" && i[1] == e[0][1] && i[2] === e[0][2] || i[1] === 0 && i[2] === 0 ? "polygon" : "polyline";
+  }
+  return "path";
+}
+function Ia(e) {
+  var t;
+  for (const r of Array.from(e.children))
+    switch (r == null ? void 0 : r.tagName.toLowerCase()) {
+      case "g":
+        {
+          const i = Ia(r);
+          if (i)
+            return i;
+        }
+        continue;
+      case "path": {
+        const i = r.getAttribute("d");
+        if (!i)
+          continue;
+        const n = Ru(i);
+        return { element: r, points: zu(n), shapeType: Uu(n) };
+      }
+      case "circle": {
+        const i = parseFloat(r.getAttribute("cx") ?? "0"), n = parseFloat(r.getAttribute("cy") ?? "0"), s = parseFloat(r.getAttribute("r") ?? "0");
+        if (!s)
+          continue;
+        const a = [];
+        for (let o = 0; o <= 360; o += 12) {
+          const c = o * Math.PI / 180;
+          a.push([i + s * Math.cos(c), n + s * Math.sin(c)]);
+        }
+        return { element: r, points: a, shapeType: "circle" };
+      }
+      case "ellipse": {
+        const i = parseFloat(r.getAttribute("cx") ?? "0"), n = parseFloat(r.getAttribute("cy") ?? "0"), s = parseFloat(r.getAttribute("rx") ?? "0"), a = parseFloat(r.getAttribute("ry") ?? "0");
+        if (!s && !a)
+          continue;
+        const o = [];
+        for (let c = 0; c <= 360; c += 12) {
+          const h = Math.tan(c / 360 * Math.PI), l = s * (1 - h ** 2) / (1 + h ** 2), u = a * 2 * h / (1 + h ** 2);
+          o.push([i + l, n + u]);
+        }
+        return { element: r, points: o, shapeType: "ellipse" };
+      }
+      case "line": {
+        const i = parseFloat(r.getAttribute("x0") ?? "0"), n = parseFloat(r.getAttribute("y0") ?? "0"), s = parseFloat(r.getAttribute("x1") ?? "0"), a = parseFloat(r.getAttribute("y1") ?? "0");
+        if (i === s && n === a)
+          continue;
+        return {
+          element: r,
+          points: [
+            [i, n],
+            [s, a]
+          ],
+          shapeType: "polyline"
+        };
+      }
+      case "polygon":
+      case "polyline": {
+        const i = ((t = r.getAttribute("points")) == null ? void 0 : t.split(" ").map((s) => s.split(",").map(parseFloat))) ?? [];
+        if (!i.length)
+          continue;
+        let n = "polyline";
+        return r.tagName.toLowerCase() === "polygon" && (i.push(i[0]), n = "polygon"), { element: r, points: i, shapeType: n };
+      }
+      case "rect": {
+        const i = parseFloat(r.getAttribute("x") ?? "0"), n = parseFloat(r.getAttribute("y") ?? "0"), s = parseFloat(r.getAttribute("width") ?? "0"), a = parseFloat(r.getAttribute("height") ?? "0");
+        if (!s || !a)
+          continue;
+        return {
+          element: r,
+          points: [
+            [i, n],
+            [i + s, n],
+            [i + s, n + a],
+            [i, n + a],
+            [i, n]
+          ],
+          shapeType: "rect"
+        };
+      }
+      default:
+        continue;
+    }
+  return null;
+}
+function zu(e) {
+  const t = [];
+  for (let r = 0; r < e.length; r++) {
+    const i = t[t.length - 1] ?? [0, 0], n = e[r];
+    switch (n[0]) {
+      case "M":
+      case "L":
+        t.push([n[1], n[2]]);
+        continue;
+      case "C":
+        t.push(
+          ...Nu(
+            { x: i[0], y: i[1] },
+            { x: n[1], y: n[2] },
+            { x: n[3], y: n[4] },
+            { x: n[5], y: n[6] }
+          ).map((s) => [s.x, s.y]).slice(1)
+          // skip first point, already part of output
+        );
+        continue;
+      case "Q":
+        t.push(
+          ...Mu(
+            { x: i[0], y: i[1] },
+            { x: n[1], y: n[2] },
+            { x: n[3], y: n[4] }
+          ).map((s) => [s.x, s.y]).slice(1)
+          // skip first point, already part of output
+        );
+        continue;
+    }
+  }
+  return t;
+}
+function Bu(e) {
+  const t = {};
+  if (e.hasAttribute("fill") ? (t.fill = e.getAttribute("fill"), e.removeAttribute("fill")) : e.style && e.style.fill && (t.fill = e.style.fill), t.fill) {
+    const i = xn.exec(t.fill);
+    i && (t.fillOpacity = parseFloat(i[4]), t.fill = `rgb(${i[1]}, ${i[2]}, ${i[3]})`);
+  }
+  if (e.hasAttribute("fill-opacity") ? (t.fillOpacity = parseFloat(e.getAttribute("fill-opacity")), e.removeAttribute("fill-opacity")) : e.style && e.style.fillOpacity && (t.fillOpacity = parseFloat(e.style.fillOpacity)), e.hasAttribute("stroke") ? (t.stroke = e.getAttribute("stroke"), e.removeAttribute("stroke")) : e.style && e.style.stroke && (t.stroke = e.style.stroke), t.stroke) {
+    const i = xn.exec(t.stroke);
+    i && (t.strokeOpacity = parseFloat(i[4]), t.stroke = `rgb(${i[1]}, ${i[2]}, ${i[3]})`);
+  }
+  e.hasAttribute("stroke-opacity") ? (t.strokeOpacity = parseFloat(e.getAttribute("stroke-opacity")), e.removeAttribute("stroke-opacity")) : e.style && e.style.strokeOpacity && (t.strokeOpacity = parseFloat(e.style.strokeOpacity)), e.hasAttribute("stroke-width") ? (t.strokeWidth = e.getAttribute("stroke-width"), e.removeAttribute("stroke-width")) : e.style && e.style.strokeWidth && (t.strokeWidth = e.style.strokeWidth), e.hasAttribute("stroke-dasharray") ? (t.strokeDasharray = e.getAttribute("stroke-dasharray"), e.removeAttribute("stroke-dasharray")) : e.style && e.style.strokeDasharray && (t.strokeDasharray = e.style.strokeDasharray);
+  let r = e;
+  for (; r.tagName.toLowerCase() !== "svg"; )
+    if (r = r.parentElement, r === null)
+      throw new Error("Could not find root SVG element");
+  return { svg: r.outerHTML, style: Object.keys(t).length > 0 ? t : void 0 };
+}
+function qu(e) {
+  return !!e && e.type === "iiif:ImageApiSelector" && e.type === "iiif:ImageApiSelector";
+}
+function be(e) {
+  if (e.iiifRenderingHints) {
+    const t = e.iiifRenderingHints;
+    if (t.rotation) {
+      const r = Hu(`${t.rotation}`);
+      if (r)
+        if (e.selectors.length)
+          for (const i of e.selectors)
+            i.rotation = r;
+        else
+          e.selectors.push({
+            type: "RotationSelector",
+            rotation: r
+          });
+    }
+  } else
+    delete e.iiifRenderingHints;
+  return e;
+}
+function Hu(e) {
+  let t = parseFloat(e);
+  return t && e.startsWith("!") && (t = 360 - t), t && (t = t % 360), t !== t ? 0 : t || 0;
+}
+function Dt(e, t = {}) {
+  if (Array.isArray(e))
+    return Dt(e[0]);
+  if (typeof e == "string") {
+    const [r, i] = e.split("#");
+    return i ? Dt({
+      type: "SpecificResource",
+      source: { id: r, type: "Unknown" },
+      selector: {
+        type: "FragmentSelector",
+        value: i
+      }
+    }) : {
+      type: "SpecificResource",
+      source: { id: r, type: t.typeMap && t.typeMap[r] || "Unknown" },
+      selector: null,
+      selectors: []
+    };
+  }
+  if (e.type === "Choice" || e.type === "List" || e.type === "Composite" || e.type === "Independents")
+    return Dt(e.items[0]);
+  if (!e.type && "source" in e && (e.type = "SpecificResource"), e.type === "SpecificResource") {
+    e.source.type === "Canvas" && e.source.partOf && typeof e.source.partOf == "string" && (e.source.partOf = [
+      {
+        id: e.source.partOf,
+        type: "Manifest"
+      }
+    ]);
+    const { selector: r, selectors: i } = e.selector ? pr(e.selector, t) : { selector: null, selectors: [] };
+    return {
+      type: "SpecificResource",
+      source: e.source,
+      selector: r,
+      selectors: i
+    };
+  }
+  if (e.id) {
+    e.type === "Canvas" && e.partOf && typeof e.partOf == "string" && (e.partOf = [
+      {
+        id: e.partOf,
+        type: "Manifest"
+      }
+    ]);
+    const [r, i] = e.id.split("#");
+    return i ? Dt({
+      type: "SpecificResource",
+      source: {
+        ...e,
+        id: r
+      },
+      selector: {
+        type: "FragmentSelector",
+        value: i
+      }
+    }) : {
+      type: "SpecificResource",
+      source: {
+        ...e,
+        id: r
+      },
+      selector: null,
+      selectors: []
+    };
+  }
+  return {
+    type: "SpecificResource",
+    source: e,
+    selector: null,
+    selectors: []
+  };
+}
+/** Code to "flatten" quadratic and cubic Bzier curves to polylines.
+ *
+ * All code in this module is based on JavaScript code by Raph Levien, published on his blog at
+ * https://raphlinus.github.io/.
+ * I merely changed the structure a bit, removed some unneeded parts and added some comments and type hints.
+ *
+ * Flattening of quadratic Bzier curves:
+ * - Article: https://raphlinus.github.io/graphics/curves/2019/12/23/flatten-quadbez.html
+ * - Code: https://github.com/raphlinus/raphlinus.github.io/blob/master/_posts/2019-12-23-flatten-quadbez.md?plain=1#L73-L212
+ *
+ * Flattening of cubic Bzier curves: https://levien.com/tmp/flatten.html
+ *
+ * Note that the code in this module has a different license than the rest of the package,
+ * due to the inclusion of Apache-licensed third party code.
+ *
+ * @license
+ * Copyright 2022 Johannes Baiter <johannes.baiter@gmail.com>
+ * Copyright 2019, 2022 Raph Levien <raph.levien@gmail.com>
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *     http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+var Qu = Object.defineProperty, Gu = (e, t, r) => t in e ? Qu(e, t, { enumerable: !0, configurable: !0, writable: !0, value: r }) : e[t] = r, lr = (e, t, r) => (Gu(e, typeof t != "symbol" ? t + "" : t, r), r);
+function gt(e) {
+  return e.endsWith("info.json") ? e : e.endsWith("/") ? `${e}info.json` : `${e}/info.json`;
+}
+var Yu = "http://library.stanford.edu/iiif/image-api/compliance.html#level0", Ta = "http://library.stanford.edu/iiif/image-api/compliance.html#level1", Pa = "http://library.stanford.edu/iiif/image-api/compliance.html#level2", Vu = "http://library.stanford.edu/iiif/image-api/conformance.html#level0", ja = "http://library.stanford.edu/iiif/image-api/conformance.html#level1", $a = "http://library.stanford.edu/iiif/image-api/conformance.html#level2", Ju = "http://library.stanford.edu/iiif/image-api/1.1/compliance.html#level0", Fa = "http://library.stanford.edu/iiif/image-api/1.1/compliance.html#level1", Ea = "http://library.stanford.edu/iiif/image-api/1.1/compliance.html#level2", Xu = "http://library.stanford.edu/iiif/image-api/1.1/conformance.html#level0", Ra = "http://library.stanford.edu/iiif/image-api/1.1/conformance.html#level1", Ma = "http://library.stanford.edu/iiif/image-api/1.1/conformance.html#level2", Ku = "http://iiif.io/api/image/1/level0.json", Zu = "http://iiif.io/api/image/1/profiles/level0.json", Na = "http://iiif.io/api/image/1/level1.json", Da = "http://iiif.io/api/image/1/profiles/level1.json", La = "http://iiif.io/api/image/1/level2.json", Wa = "http://iiif.io/api/image/1/profiles/level2.json", ef = "http://iiif.io/api/image/2/level0.json", tf = "http://iiif.io/api/image/2/profiles/level0.json", Ua = "http://iiif.io/api/image/2/level1.json", za = "http://iiif.io/api/image/2/profiles/level1.json", Ba = "http://iiif.io/api/image/2/level2.json", qa = "http://iiif.io/api/image/2/profiles/level2.json", rf = "level0", Ha = "level1", Qa = "level2", nf = "http://iiif.io/api/image/2/level0", Ga = "http://iiif.io/api/image/2/level1", Ya = "http://iiif.io/api/image/2/level2", sf = "https://iiif.io/api/image/1.1/compliance/#level0", Va = "https://iiif.io/api/image/1.1/compliance/#level1", Ja = "https://iiif.io/api/image/1.1/compliance/#level2", Xa = [Ya, Pa, $a, Ea, Ma, La, Wa, Ba, qa, Qa, Ja], Ka = [...Xa, Ga, Ta, ja, Fa, Ra, Na, Da, Ua, za, Ha, Va], af = [nf, Ga, Ya, Yu, Ta, Pa, Vu, ja, $a, Ju, Fa, Ea, Xu, Ra, Ma, Ku, Zu, Na, Da, La, Wa, ef, tf, Ua, za, Ba, qa, rf, Ha, Qa, sf, Va, Ja], of = { extraFormats: ["jpg"], extraQualities: ["default"], extraFeatures: ["sizeByWhListed"] }, cf = { extraFormats: ["jpg"], extraQualities: ["default"], extraFeatures: ["baseUriRedirect", "cors", "jsonldMediaType", "regionByPx", "regionSquare", "sizeByWhListed", "sizeByH", "sizeByW", "sizeByWh"] }, lf = { extraFormats: ["jpg", "png"], extraQualities: ["default"], extraFeatures: ["baseUriRedirect", "cors", "jsonldMediaType", "regionByPct", "regionByPx", "regionSquare", "rotationBy90s", "sizeByWhListed", "sizeByConfinedWh", "sizeByH", "sizeByPct", "sizeByW", "sizeByWh"] };
+function hf(e) {
+  return Xa.indexOf(e) !== -1 ? lf : Ka.indexOf(e) !== -1 ? cf : of;
+}
+function uf(e) {
+  let t = e ? Array.isArray(e.profile) ? e.profile : [e.profile] : [], r = { extraQualities: [], extraFormats: [], extraFeatures: [] };
+  for (let i of t) if (typeof i == "string" && (i = hf(i)), !!i) {
+    if (i.formats) for (let n of i.formats) r.extraFormats.indexOf(n) === -1 && r.extraFormats.push(n);
+    if (i.qualities) for (let n of i.qualities) r.extraQualities.indexOf(n) === -1 && r.extraQualities.push(n);
+    if (i.supports) for (let n of i.supports) r.extraFeatures.indexOf(n) === -1 && r.extraFeatures.push(n);
+    if (i.maxHeight && (r.maxHeight = i.maxHeight), i.maxWidth && (r.maxWidth = i.maxWidth), i.maxArea && (r.maxArea = i.maxArea), i.extraFormats) for (let n of i.extraFormats) r.extraFormats.indexOf(n) === -1 && r.extraFormats.push(n);
+    if (i.extraQualities) for (let n of i.extraQualities) r.extraQualities.indexOf(n) === -1 && r.extraQualities.push(n);
+    if (i.extraFeatures) for (let n of i.extraFeatures) r.extraFeatures.indexOf(n) === -1 && r.extraFeatures.push(n);
+    i.maxHeight && (r.maxHeight = i.maxHeight), i.maxWidth && (r.maxWidth = i.maxWidth), i.maxArea && (r.maxArea = i.maxArea);
+  }
+  if (e.extraFormats) for (let i of e.extraFormats) r.extraFormats.indexOf(i) === -1 && r.extraFormats.push(i);
+  if (e.extraFeatures) for (let i of e.extraFeatures) r.extraFeatures.indexOf(i) === -1 && r.extraFeatures.push(i);
+  if (e.extraQualities) for (let i of e.extraQualities) r.extraQualities.indexOf(i) === -1 && r.extraQualities.push(i);
+  return r;
+}
+function ff(e) {
+  try {
+    if (e === "full") return { full: !0 };
+    if (e === "square") return { square: !0 };
+    let t = e.startsWith("pct:"), r = e.substr(t ? 4 : 0).split(",").map((i) => parseFloat(i));
+    return { x: r[0], y: r[1], w: r[2], h: r[3], percent: t };
+  } catch {
+    throw new Error("Expected 'full', 'square' or 'x,y,w,h'. Found " + e);
+  }
+}
+function df(e) {
+  let t = { upscaled: !1, max: !1, confined: !1 };
+  if (e[0] === "^" && (t.upscaled = !0, e = e.slice(1)), e === "max" || e === "full") return t.max = !0, t.serialiseAsFull = e === "full", t;
+  if (e[0] === "!" && (t.confined = !0, e = e.slice(1)), e[0] === "p") return t.percentScale = parseFloat(e.slice(4)), t;
+  let r = e.split(",").map((i) => i.trim());
+  return r.length && typeof r[0] < "u" && (r[0] !== "" && (t.width = parseInt(r[0], 10)), typeof r[1] < "u" && r[1] !== "" ? (t.height = parseInt(r[1], 10), t.version = 2) : t.version = 3), t;
+}
+function pf(e) {
+  let t = { angle: 0 };
+  if (e[0] === "!" && (t.mirror = !0, e = e.substr(1)), t.angle = parseFloat(e) % 360, Number.isNaN(t.angle)) throw new Error(`Invalid rotation ${e}`);
+  return t;
+}
+function gf(e, t = "") {
+  let r = e.match(/^(([a-zA-Z]+):\/\/([^/]+))?((.*)+)/);
+  if (!r) throw new Error(`Invalid or unknown input ${e}`);
+  let i = r[2], n = r[3], s = r[4];
+  if (s[0] === "/" && (s = s.substring(1)), t.length > 0) {
+    if (t[0] === "/" && (t = t.substring(1)), t !== s.substring(0, t.length)) throw new Error(`Path does not start with prefix (path: ${s}, prefix: ${t})`);
+    s = s.substring(t.length);
+  }
+  return { scheme: i, server: n, path: s, prefix: t };
+}
+function mf(e, t = "") {
+  let { path: r, scheme: i, server: n, prefix: s } = gf(e, t), a = (r || "").split("/").reverse(), [o, c, h, l, ...u] = a, f = u.reverse().filter(Boolean).join("/");
+  if (a.length === 1 || o === "") return { type: "base", scheme: i, server: n, prefix: s, identifier: f };
+  if (o === "info.json") {
+    let [, ...d] = a;
+    return { type: "info", scheme: i, server: n, prefix: s, identifier: d.reverse().filter(Boolean).join("/") };
+  }
+  let p = (o || "").split(".");
+  if (typeof p[1] > "u" || typeof p[0] > "u" || typeof l > "u" || typeof h > "u" || typeof c > "u") throw new Error("Invalid image request");
+  return { type: "image", scheme: i, server: n, prefix: s, identifier: f, originalPath: r, region: ff(l), size: df(h), rotation: pf(c), quality: p[0], format: p[1] };
+}
+function vf(e) {
+  let t = mf(gt(e.id));
+  if (t.type !== "info") throw new Error("Invalid service URL");
+  let r = uf(e);
+  return { identifier: t.identifier, originalPath: "", server: t.server, prefix: t.prefix, scheme: t.scheme, type: "image", quality: r.extraQualities.indexOf("default") === -1 ? r.extraQualities[0] : "default", region: { full: !0 }, size: { max: !0, upscaled: !1, confined: !1 }, format: "jpg", rotation: { angle: 0 } };
+}
+function yf(e, t, r) {
+  let i = r.length, n = [];
+  for (let s = 0; s < i; s++) {
+    let a = r[s];
+    if (a) {
+      let o = a.width;
+      n.push(e / o);
+    }
+  }
+  return n;
+}
+function bf(e, t, r) {
+  let i = r.length, n = [];
+  for (let s = 0; s < i; s++) {
+    let a = r[s];
+    a && n.push({ width: Math.floor(e / a), height: Math.floor(t / a) });
+  }
+  return n;
+}
+function Z(e) {
+  if (e["@id"]) return e["@id"];
+  if (e.id) return e.id;
+}
+function Nr(e) {
+  if (!e || !e.profile || !Z(e)) return !1;
+  let t = Array.isArray(e.profile) ? e.profile : [e.profile];
+  for (let r of t) if (typeof r == "string" && af.indexOf(r) !== -1) return !0;
+  return !1;
+}
+function wf(e) {
+  if (!Nr(e)) return !1;
+  let t = Array.isArray(e.profile) ? e.profile : [e.profile];
+  for (let r of t) if (typeof r == "string") {
+    if (Ka.indexOf(r) !== -1) return !0;
+  } else {
+    let i = [...r.supports || [], ...r.extraFeatures || []];
+    if (i.indexOf("regionByPx") !== -1 && (i.indexOf("sizeByW") !== -1 || i.indexOf("sizeByWh") !== -1)) return !0;
+  }
+  return !1;
+}
+function gr(e, t) {
+  if (t && t.profile) {
+    let r = t.profile;
+    if (r) {
+      let i = Array.isArray(r) ? r : [r];
+      return i.includes(`level${e}`) || i.includes(`http://iiif.io/api/image/2/level${e}.json`) || i.includes(`http://iiif.io/api/image/1/level${e}.json`) || i.includes(`http://iiif.io/api/image/1/profiles/level${e}.json`);
+    }
+  }
+  return !1;
+}
+function Si(e) {
+  return Nr(e) ? gr(0, e) ? 0 : gr(1, e) ? 1 : gr(2, e) ? 2 : null : null;
+}
+function Za(e) {
+  return (e["@context"] ? Array.isArray(e["@context"]) ? e["@context"] : [e["@context"]] : []).indexOf("http://iiif.io/api/image/3/context.json") !== -1;
+}
+function xf(e) {
+  if (!wf(e)) return [];
+  let t = [], r = Array.isArray(e.profile) ? e.profile : [e.profile], i = r.length;
+  for (let n = 0; n < i; n++) {
+    let s = r[n];
+    if (s && typeof s != "string" && (s.maxHeight || s.maxWidth)) return [{ id: Z(e), type: "variable", minWidth: 0, minHeight: 0, maxHeight: s.maxHeight || s.maxWidth, maxWidth: s.maxWidth || s.maxHeight, level: Si(e), version: e["@context"] === "http://iiif.io/api/image/3/context.json" ? 3 : 2 }];
+  }
+  if (e.tiles) {
+    let n = e.tiles.length;
+    for (let s = 0; s < n; s++) {
+      let a = e.tiles[s];
+      a && (a.height || a.width) && t.push({ id: Z(e), type: "variable", minHeight: 0, minWidth: 0, maxHeight: a.height || a.width, maxWidth: a.width, level: Si(e), version: Za(e) ? 3 : 2 });
+    }
+  }
+  return t;
+}
+function Cn(e) {
+  let t = /^.*\/(full)\/(((\d+),(\d+)?)|max)\/(\d+)\/default\.(jpg|png|jpeg)$/, r = e.match(t);
+  if (r && r[4] && r[5]) {
+    let i = r[1], n = parseInt(r[4], 10), s = parseInt(r[5], 10), a = r[7];
+    if ((i === "max" || i === "full") && n && s && a) return { type: "fixed", id: e, height: s, width: n };
+  }
+  return { type: "unknown", id: e };
+}
+function Cf(e) {
+  if (e["@type"]) return e["@type"];
+  if (e.type) return e.type;
+}
+function Sf(e) {
+  if (typeof e == "string") return Cn(e);
+  let t = Cf(e);
+  if (t !== "Image" && t !== "sc:Image") return null;
+  let r = e, i = Z(r);
+  return i ? i && r.width && r.height ? { id: i, type: "fixed", width: r.width, height: r.height, unsafe: !0 } : Cn(i) : null;
+}
+function Af(e) {
+  return Nr(e) ? (e && e.sizes ? e.sizes : []).map((t) => ({ id: Z(e), type: "fixed-service", height: t.height, width: t.width, level: Si(e), version: Za(e) ? 3 : 2 })) : [];
+}
+function Sn(e) {
+  let t = [], r = e.length;
+  for (let i = 0; i < r; i++) {
+    let n = e[i];
+    if (!n) continue;
+    let s = Af(n);
+    s.length && t.push(...s);
+    let a = xf(n);
+    a.length && t.push(...a);
+  }
+  return t;
+}
+function eo(e) {
+  let t = e.service ? Array.isArray(e.service) ? e.service : [e.service] : [], r = t.length, i = [];
+  for (let n = 0; n < r; n++) Nr(t[n]) && i.push(t[n]);
+  return i;
+}
+function _f(e, t = !0, r) {
+  let i = [], n = Sf(e);
+  if (n === null) return i;
+  let s = e;
+  if (i.push(n), t && s && s.width && s.height) {
+    let a = [], o = eo(s);
+    for (let c of o) {
+      let h = { id: Z(c), width: s.width, height: s.height };
+      if (r.canLoadSync(h)) {
+        let l = r.loadServiceSync(h);
+        l && (l.height || (l.height = s.height), l.width || (l.width = s.width), a.push(...Sn([l])));
+      }
+    }
+    if (a.length) return i.push(...a), i;
+  }
+  return s.service && i.push(...Sn(s.service)), i;
+}
+function Of({ x: e = 0, y: t = 0, w: r, h: i, full: n, square: s, percent: a }) {
+  return "full";
+}
+function kf({ max: e, percentScale: t, upscaled: r, confined: i, width: n, height: s, serialiseAsFull: a, version: o }) {
+  let c = [];
+  return r && c.push("^"), e ? (c.push(a ? "full" : "max"), c.join("")) : (i && c.push("!"), t && c.push(`pct:${t}`), n && c.push(`${n}`), c.push(","), s && o === 3 && c.push(`${s}`), c.join(""));
+}
+function If(e) {
+  return `${e.mirror ? "!" : ""}${(e.angle || 0) % 360}`;
+}
+function Tf(e, t) {
+  let r = e.prefix.startsWith("/") ? e.prefix.substr(1) : e.prefix, i = `${e.scheme}://${e.server}/${r ? `${r}/` : ""}${e.identifier}`, { size: n } = e, { region: s, rotation: a, format: o, quality: c } = e;
+  return [i, Of(s), kf(n), If(a), `${c}.${o}`].filter(Boolean).join("/");
+}
+function Kr(e, t, r) {
+  let i = vf({ "@context": e.version === 3 ? "http://iiif.io/api/image/3/context.json" : "http://iiif.io/api/image/2/context.json", id: gt(Z(e)), profile: e.level === null || typeof e.level > "u" ? "level0" : `level${e.level}`, type: e.version === 3 ? "ImageService3" : "ImageService2" });
+  return i.size.max = !1, i.size.width = t, i.size.height = r, { id: Tf(i), type: "fixed", width: t, height: r || e.height / (e.width || 1) * t, unsafe: e.width > t };
+}
+function Ct(e) {
+  let t = e.replace(/(https?:\/\/)?(www.)?/i, "");
+  return t.indexOf("/") !== -1 ? t.split("/")[0] : t;
+}
+function Pf(e, t, r) {
+  let i = e.width ? e.width : e.maxWidth;
+  return r.height <= e.maxHeight && r.width <= e.maxWidth && r.height >= e.minHeight && r.width >= e.minWidth && (!t || Math.abs(r.width - i) < Math.abs(t.width - i));
+}
+function jf(e, t) {
+  let r = [], i = Object.assign({ unsafeImageService: !1, atAnyCost: !0, fallback: !0, minHeight: 64, minWidth: 64, maxHeight: 1 / 0, maxWidth: 1 / 0, returnAllOptions: !1, preferFixedSize: !1, allowUnsafe: !1, explain: !1, height: 0, width: 0 }, e), n = (l, u = 0) => i.explain ? r.push(new Array(u).fill(0).map((f) => "    ").join("") + l().trim()) : void 0, s = [], a = [], o = null;
+  n(() => `Using configuration: ${JSON.stringify(i, null, 2)}`);
+  let c = (l, u) => {
+    if (n(() => "Swapping choice", 3), Pf(i, u, l)) {
+      if (i.preferFixedSize && l.unsafe) {
+        n(() => `We found an image that was marked as unsafe, but it was the best size. (${l.id})`, 4), a.push(l);
+        return;
+      }
+      i.returnAllOptions && u && a.push(u), n(() => `We found a new image that was the best size. (${l.id})`, 4), o = l;
+    } else i.returnAllOptions && a.push(l);
+  };
+  n(() => `The input shows we have ${t.length} list(s) of candidates to choose from.`);
+  let h = t.length;
+  for (let l = 0; l < h; l++) {
+    let u = t[l]();
+    n(() => `Candidate group ${l}: ${JSON.stringify(u, null, 2)}`, 1);
+    let f = u.length;
+    n(() => `Checking candidate list number ${l} and found ${f} potential ways of creating image(s)`, 1);
+    for (let p = 0; p < f; p++) {
+      let d = u[p];
+      if (n(() => `-> Checking candidate ${p}`, 1), d.type === "unknown" && i.atAnyCost && (n(() => `We've found an unknown image type, adding this to the "last resort" list`, 2), s.push(d)), d.type === "fixed" && (d.unsafe ? (n(() => `We've found an unsafe fixed image type, adding this to the "last resort" list`, 2), s.push(d)) : (n(() => "We've found a fixed size image, checking if it matches the request", 2), c(d, o))), d.type === "fixed-service") if (i.unsafeImageService) {
+        n(() => "Checking for an image from the tile source, without calculating the right height and width (unsafeImageService)", 2);
+        let m = Kr(d, i.width, i.height);
+        c(m, o);
+      } else {
+        n(() => "Checking for an image from the tile source 3", 2);
+        let m = Kr(d, d.width, d.height);
+        c(m, o);
+      }
+      if (d.type === "variable" && d.maxWidth) {
+        let m = Kr({ id: d.id, width: d.maxWidth, height: d.maxWidth, level: d.level, version: d.version }, d.maxWidth);
+        c(m, o);
+      }
+    }
+    if (o && !i.returnAllOptions) {
+      if (o.unsafe || i.allowUnsafe) continue;
+      n(() => `We found a match in choice list number ${l}, no searching any more`);
+      break;
+    }
+  }
+  return i.atAnyCost && a.length === 0 ? (n(() => o ? `We found an image! ${o.id} of type ${o.type}` : 'We found no images, but "atAnyCost" is set, so returning that'), { best: o || s[0] || null, fallback: s.slice(1), log: r }) : i.returnAllOptions ? (n(() => "Returning all options that we have found"), { best: (i.atAnyCost ? o || a[0] || s[0] : o || a[0]) || null, fallback: [...a, ...s], log: r }) : (n(() => "Returning the best image that we found, and a fallback"), { best: o || a[0] || null, fallback: o ? a : a.slice(1), log: r });
+}
+function $f(e, t, r) {
+  let i = e > t ? e : t, n = r.length, s = [];
+  for (let a = 0; a < n; a++) {
+    let o = r[a];
+    if (!o || o.scaleFactors.length === 0) continue;
+    let c = o.scaleFactors[0];
+    if (!c) continue;
+    let h = i / c, l = [c];
+    for (; h >= o.width; ) c = c * 2, l.push(c), h = h / 2;
+    s.push({ ...o, scaleFactors: l });
+  }
+  return s;
+}
+function Ff(e, t) {
+  if (e.length !== t.length) return !1;
+  if (e.length === 0 && t.length === 0) return !0;
+  let r = e.length, i = !0;
+  for (let s = 0; s < r; s++) {
+    let a = e[s], o = t[s];
+    if (a.width !== o.width || a.height !== o.height) {
+      i = !1;
+      break;
+    }
+  }
+  if (i) return !0;
+  let n = 0;
+  for (let s = 0; s < r; s++) for (let a = 0; a < r; a++) if (e[s].width === t[a].width && e[s].height === t[a].height) {
+    n++;
+    break;
+  }
+  return n === r;
+}
+function An(e) {
+  return gr(0, e);
+}
+var to = class {
+  constructor(e = {}) {
+    lr(this, "config", { verificationsRequired: 1, approximateServices: !1, enableFetching: !0, disableThrottling: !1 }), lr(this, "fetchingCount", 0), lr(this, "imageServices", {}), lr(this, "knownImageServers", {}), this.config = Object.assign(this.config, e);
+  }
+  setConfig(e) {
+    Object.assign(this.config, e);
+  }
+  sample(e, t, r = !0) {
+    let i = Ct(Z(e)), n = gt(Z(e)), s = this.knownImageServers[i];
+    return this.imageServices[n] = Object.assign(e, { real: !0 }), !s && e.tiles && !An(e) ? (this.knownImageServers[i] = { verifications: 0, malformed: !1, root: i, preLoaded: r, sampledId: Z(e), verified: !1, server: null, result: { context: e["@context"] || [], sampledProfile: e.profile, resourceServiceRatio: t && e.height ? t.height / e.height : 1, sampledSizes: e.sizes || [], sizeRatios: yf(e.width, e.height, e.sizes || []), sampledTiles: e.tiles || [] } }, !0) : this.verify(e);
+  }
+  preLoad(e, t = !0) {
+    this.knownImageServers[e.root] = e, t && (this.knownImageServers[e.root].malformed = !1, this.knownImageServers[e.root].verifications = this.config.verificationsRequired);
+  }
+  predict(e, t = !1, r = !1) {
+    let i = e == null ? void 0 : e.source, n = Ct(Z(e)), s = this.knownImageServers[n], a = gt(Z(e));
+    return this.imageServices[a] ? this.imageServices[a] || null : !this.config.approximateServices || !s || !s.result || !(i != null && i.height || e.height) || !(i != null && i.width || e.width) || !r && (s.malformed || s.verifications < this.config.verificationsRequired) || An(e.source) ? null : (this.imageServices[a] || (this.imageServices[a] = { "@context": s.result.context, "@id": Z(e), id: Z(e), protocol: "http://iiif.io/api/image", tiles: (i == null ? void 0 : i.tiles) || $f(e.width, e.height, s.result.sampledTiles), sizes: (i == null ? void 0 : i.sizes) || bf(Math.round(e.width / s.result.resourceServiceRatio), Math.round(e.height / s.result.resourceServiceRatio), s.result.sizeRatios), profile: (i == null ? void 0 : i.profile) || s.result.sampledProfile, height: (i == null ? void 0 : i.height) || e.height, width: (i == null ? void 0 : i.width) || e.width, real: !1 }), this.imageServices[a] || null);
+  }
+  async getThumbnailFromResource(e, t, r = !0, i = []) {
+    let n = e ? await this.getImageCandidates(e, r) : [];
+    return jf(t, [() => i, () => n]);
+  }
+  async getImageCandidates(e, t = !0) {
+    let r = e;
+    if (t && r && r.height && r.width) {
+      let i = eo(r);
+      for (let n of i) {
+        let s = { id: Z(n), width: n.width ? n.width : r.width, height: n.height ? n.height : r.height, source: n };
+        await this.loadService(s);
+      }
+    }
+    return _f(e, t, this);
+  }
+  async verify(e) {
+    let t = this.predict(e, !1, !0), r = await this.fetchService(Z(e));
+    if (!t) return !1;
+    let i = t.height === r.height && t.width === r.width && t["@context"] === r["@context"] && Ff(t.sizes || [], r.sizes || []);
+    if (i) {
+      let n = Ct(Z(e)), s = this.knownImageServers[n];
+      s && (s.verifications += 1, s.verifications >= this.config.verificationsRequired && (s.verified = !0));
+    }
+    return i;
+  }
+  canLoadSync(e) {
+    let t = typeof e == "string" ? e : Z(e), r = gt(t);
+    if (this.imageServices[r]) return !0;
+    let i = this.knownImageServers[Ct(t)];
+    return !!(i && !i.malformed && i.verifications >= this.config.verificationsRequired);
+  }
+  async markAsMalformed(e) {
+    return this.knownImageServers[Ct(Z(e))].malformed = !0, this.loadService(e, !0);
+  }
+  async fetchService(e, t = !1) {
+    let r = gt(e), i = this.imageServices[r];
+    if (i && (!t || i.real)) return i;
+    if (!this.config.enableFetching) throw new Error("Fetching is not enabled");
+    let n = await this.fetch(r).then((s) => s.json());
+    return !n.id && n["@id"] && (n.id = n["@id"]), n.id !== e && (n.id = e, n["@id"] && (n["@id"] = e)), this.imageServices[r] = Object.assign(n, { real: !0 }), this.imageServices[r];
+  }
+  async fetch(e, t) {
+    return fetch(e, t);
+  }
+  async loadService(e, t = !1) {
+    if (!this.config.disableThrottling) {
+      let n = !0;
+      for (; n; ) if (this.fetchingCount >= this.config.verificationsRequired) await new Promise((s) => setTimeout(s, 500));
+      else {
+        n = !1;
+        break;
+      }
+    }
+    let r = this.knownImageServers[Ct(Z(e))];
+    if (r && !r.malformed && !t) {
+      await r.result;
+      let n = this.loadServiceSync(e);
+      if (n) return n;
+    }
+    this.fetchingCount++;
+    let i = await this.fetchService(Z(e), t);
+    return this.fetchingCount--, i.real && this.sample(i, e), i;
+  }
+  loadServiceSync(e) {
+    let t = gt(Z(e));
+    return this.imageServices[t] ? this.imageServices[t] : this.config.approximateServices ? this.predict(e) : null;
+  }
+};
+new to();
+const Ef = ["commenting", "describing", "tagging", "no-purpose"], Ai = {
+  commenting: "Comment",
+  describing: "Description",
+  tagging: "Tags"
+}, G = Kh();
+function $e(e, t, r) {
+  let i = !1;
+  r || (r = "<<<SNIP>>>", i = !0);
+  const n = Ca(e, t[0] ?? "none", {
+    defaultText: "",
+    fallbackLanguages: t.slice(1),
+    separator: r
+  });
+  return i ? n.split(r).filter((s) => s.length > 0) : n;
+}
+class Rf extends to {
+  async fetch(t, r) {
+    return Kt(t, r);
+  }
+}
+const Mf = _u(G, {
+  imageServiceLoader: new Rf()
+}), { extractChoices: Nf } = _l(G);
+async function Df(e, t) {
+  var i;
+  return (i = (await Mf.getBestThumbnailAtSize(e, {
+    maxWidth: t,
+    maxHeight: t
+  })).best) == null ? void 0 : i.id;
+}
+function Lf(e) {
+  return e.type !== void 0 && ["Dataset", "Image", "Video", "Sound", "Text", "unknown"].indexOf(
+    e.type
+  ) >= 0 && e.profile !== void 0;
+}
+function Wf(e) {
+  return typeof e.profile == "string" && e.profile === "http://iiif.io/api/annex/services/physdim";
+}
+function _n(e) {
+  var t;
+  return typeof e == "string" ? e.indexOf("level2") >= 0 : (((t = e.supports) == null ? void 0 : t.indexOf("sizeByWh")) ?? -1) >= 0;
+}
+function ro(e) {
+  return G.get(e.annotations).flatMap((t) => G.get(t.items)).filter(
+    (t) => Array.isArray(t.motivation) ? t.motivation.find((r) => Ai[r] !== void 0) !== void 0 : Ai[t.motivation ?? "invalid"] !== void 0
+  ).map((t) => no(t)).filter((t) => t !== void 0);
+}
+function io(e) {
+  const t = Bf(e), r = Qi(e);
+  return {
+    canvas: { id: e.id, type: "Canvas" },
+    images: t,
+    // eslint-disable-next-line @typescript-eslint/no-non-null-assertion
+    ocr: r ? { id: r.id } : void 0,
+    numAnnotations: ro(e).length
+  };
+}
+function On(e) {
+  let t = Array.isArray(e.name) ? e.name.join("; ") : e.name;
+  return t || (t = e.nickname ?? "unknown"), e.email ? `${t} <${e.email}>` : t;
+}
+function Uf(e) {
+  return Array.isArray(e) ? typeof e[0] == "string" ? e.join("; ") : e.map((t) => On(t)).join("; ") : typeof e == "string" ? e : On(e);
+}
+function no(e, t) {
+  if (!e.target)
+    return;
+  const r = e.body.map(
+    (c) => G.get(c.id)
+  ), i = r.map((c) => c.creator).filter((c) => c !== void 0).map(Uf), n = r.map((c) => c.modified).filter((c) => c !== void 0).map((c) => new Date(c).getTime());
+  if (typeof e.target == "string")
+    return;
+  const s = G.get(e.target.map((c) => c.id)), a = Dt(s), o = zf(r);
+  if (!o)
+    throw "No valid textual content in annotation.";
+  return {
+    id: e.id,
+    target: a,
+    markup: o,
+    lastModified: n.length > 0 ? new Date(Math.max(...n)) : void 0,
+    author: i.length > 0 ? i.join("; ") : void 0
+  };
+}
+function zf(e) {
+  const t = {};
+  for (const i of e) {
+    if (i.type !== "TextualBody" || i.format !== "text/plain" && i.format !== "text/html" || i.value === void 0)
+      continue;
+    let { purpose: n } = i;
+    Array.isArray(n) ? n = n[0] : n || (n = "no-purpose"), t[n] || (t[n] = []), t[n].push(i.value);
+  }
+  if (Object.keys(t).length === 0)
+    return;
+  const r = [];
+  for (const i of Ef) {
+    const n = Ai[i];
+    if (t[i])
+      if (t[i].length > 1) {
+        n && r.push(`<p><b>${n}:</b></p>`);
+        for (const s of t[i])
+          r.push(`<p>${s}</p>`);
+      } else
+        r.push("<p>"), n && r.push(`<b>${n}:</b> `), r.push(`${t[i][0]}</p>`);
+  }
+  if (r.length !== 0)
+    return r.join(`
+`);
+}
+function kn(e) {
+  const [t, r] = e.split("#xywh=");
+  if (r) {
+    const [i, n, s, a] = r.split(",").map((o) => parseInt(o, 10));
+    return { x: i, y: n, width: s, height: a };
+  } else {
+    const i = G.get(t);
+    return { x: 0, y: 0, width: i.width, height: i.height };
+  }
+}
+function In(e) {
+  var t, r, i;
+  if (e.format === "image/jpeg")
+    return "jpeg";
+  if (e.format === "image/png")
+    return "png";
+  if (e.format === void 0) {
+    if ((t = e.id) != null && t.endsWith(".jpg") || (r = e.id) != null && r.endsWith(".jpeg"))
+      return "jpeg";
+    if ((i = e.id) != null && i.endsWith(".png"))
+      return "png";
+  } else
+    return "unsupported";
+}
+function Bf(e) {
+  const t = [], r = G.get(e.items).flatMap((n) => G.get(n.items));
+  for (const n of r) {
+    const s = n.target;
+    let a;
+    if (typeof s == "string")
+      a = kn(s);
+    else if (s.type === "SpecificResource")
+      a = kn(s.source.id);
+    else {
+      console.error(`Unsupported target type for annotation on canvas ${e.id}: '${s.type}'`);
+      continue;
+    }
+    const o = G.get(n.body.map((c) => c.id));
+    for (const c of o)
+      c.type === "Image" && t.push({
+        resource: c,
+        ...a,
+        format: In(c),
+        nativeWidth: c.width,
+        nativeHeight: c.height
+      });
+  }
+  const i = Nf(r);
+  if ((i == null ? void 0 : i.type) !== "single-choice")
+    return t;
+  for (const n of i.items) {
+    const s = G.get(n.id);
+    s.type === "Image" && t.push({
+      resource: s,
+      // FIXME: Can't choice images have a location and rendering dimensions?
+      x: 0,
+      y: 0,
+      width: e.width,
+      height: e.height,
+      nativeWidth: s.width,
+      nativeHeight: s.height,
+      format: In(s),
+      choiceInfo: {
+        enabled: n.selected ?? !1,
+        optional: !0,
+        label: s.label,
+        visibleByDefault: n.selected ?? !1
+      }
+    });
+  }
+  return t;
+}
+async function qf(e, t, r) {
+  let i;
+  const n = t.indexOf("<alto") >= 0;
+  n ? i = bc(t, [r]) : i = uc(t, [r]);
+  const s = (await i.next()).value;
+  return s ? {
+    ...s,
+    id: e,
+    markup: t,
+    mimeType: n ? "application/xml+alto" : "text/vnd.hocr+html"
+  } : null;
+}
+const Hf = (e) => {
+  var t;
+  return e.format === "application/xml+alto" || ((t = e.profile) == null ? void 0 : t.startsWith("http://www.loc.gov/standards/alto/"));
+}, Qf = (e) => {
+  var t, r;
+  return e.format === "text/vnd.hocr+html" || e.profile === "https://github.com/kba/hocr-spec/blob/master/hocr-spec.md" || ((t = e.profile) == null ? void 0 : t.startsWith("http://kba.cloud/hocr-spec/")) || ((r = e.profile) == null ? void 0 : r.startsWith("http://kba.github.io/hocr-spec/"));
+};
+async function Gf(e) {
+  const t = await Kt(e);
+  if (t.status !== 404) {
+    if (t.status != 200)
+      throw new Error(
+        `Could not fetch OCR markup from ${e}, got status code ${t.status}`
+      );
+    return t.text();
+  }
+}
+function Qi(e) {
+  const t = G.get(e.seeAlso.map((r) => r.id));
+  return t.push(...G.get(e.rendering.map((r) => r.id))), t.filter(Lf).find((r) => Hf(r) || Qf(r));
+}
+async function Yf(e, t) {
+  const r = Qi(e);
+  if (r) {
+    const i = Ee == null ? void 0 : Ee.ocrFetchDuration.startTimer({
+      ocr_host: new URL(r.id).host
+    });
+    let n;
+    try {
+      if (n = await Gf(r.id), i == null || i({
+        status: "success",
+        limited: jt.isLimited(r.id).toString()
+      }), !n)
+        return;
+    } catch (s) {
+      throw i == null || i({
+        status: "error",
+        limited: jt.isLimited(r.id).toString()
+      }), s;
+    }
+    return await qf(r.id, n, {
+      width: e.width,
+      height: e.height
+    }) ?? void 0;
+  }
+}
+const so = 300, Vf = 'application/ld+json;q=0.9;profile="http://iiif.io/api/presentation/3/context.json", application/ld+json;q=0.7;profile="http://iiif.io/api/presentation/2/context.json", application/ld+json;q=0.5, application/json;q=0.2';
+class Jf {
+  constructor() {
+    v(this, "hostMutexes", /* @__PURE__ */ new Map());
+    v(this, "callbacks", []);
+  }
+  getMutex(t) {
+    return this.hostMutexes.get(t);
+  }
+  limitHost(t) {
+    const r = new Jo();
+    return this.hostMutexes.set(t, r), this.callbacks.forEach((i) => i(t, !0)), r;
+  }
+  unlimitHost(t) {
+    this.hostMutexes.delete(t), this.callbacks.forEach((r) => r(t, !1));
+  }
+  subscribe(t) {
+    return this.callbacks.push(t), this.callbacks.length - 1;
+  }
+  unsubscribe(t) {
+    this.callbacks.splice(t, 1);
+  }
+  isLimited(t) {
+    return this.hostMutexes.has(new URL(t).host);
+  }
+}
+const jt = new Jf(), Tn = /* @__PURE__ */ new Set();
+async function Kt(e, t = {}, r = 3) {
+  const { host: i } = new URL(e);
+  let n = jt.getMutex(i), s = -1, a, o = 5e3, c = { ...t };
+  Tn.has(i) && (c.credentials = "include");
+  const h = await (n == null ? void 0 : n.acquire());
+  try {
+    do {
+      if (a = await fetch(e, c), a.ok) {
+        c.credentials === "include" && Tn.add(i);
+        break;
+      }
+      if ((a.status == 401 || a.status == 403) && c.credentials !== "include") {
+        c.credentials = "include";
+        continue;
+      }
+      s++;
+      const l = a == null ? void 0 : a.headers.get("retry-after");
+      bt(l) ? Number.isInteger(l) ? o = Number.parseInt(l, 10) * 1e3 : o = Date.parse(l) - Date.now() : o = Math.pow(Math.random() * 2 * o, s);
+      const u = (m) => [
+        m,
+        `x-${m}`,
+        `x-${m.replace("ratelimit", "rate-limit")}`
+      ].map((y) => a == null ? void 0 : a.headers.get(y)).filter(bt).map((y) => Number.parseInt(y, 10)).find((y) => y != null), f = u("ratelimit-limit"), p = u("ratelimit-remaining"), d = u("ratelimit-reset");
+      if (f !== void 0 && p !== void 0 && d !== void 0) {
+        n = jt.limitHost(i);
+        const m = d / (f - p);
+        p > 0 ? o = 2 * p * m * 1e3 : o = m * 1e3;
+      }
+      await new Promise((m) => setTimeout(m, o + 100));
+    } while (s < r);
+  } finally {
+    n && await new Promise((l) => setTimeout(l, o + 100)), h == null || h();
+  }
+  return a;
+}
+function Xf(e, t = 1) {
+  let r;
+  const i = e.id !== void 0, n = e.maxWidth ?? e.width;
+  let s = Math.floor(t * n);
+  const a = e.width / e.height, o = Array.isArray(e.profile) ? e.profile.find(_n) !== void 0 : _n(e.profile);
+  if (t < 1 && !o)
+    e.sizes ? (s = Math.min(...e.sizes.map((c) => Math.abs(s - c.width))), r = `${s},`) : r = `${n},`;
+  else if (t == 1)
+    if (r = i || e.maxWidth || e.maxArea ? "max" : "full", e.maxWidth)
+      s = e.maxWidth;
+    else if (e.maxHeight)
+      s = Math.round(a * e.maxHeight);
+    else if (e.maxArea) {
+      const c = e.width * e.height, h = e.maxArea / c;
+      s = Math.round(h * e.width);
+    } else
+      s = e.width;
+  else
+    r = `${s},`;
+  return {
+    iiifSize: r,
+    width: s,
+    height: s / a
+  };
+}
+function Gi(e) {
+  const t = e.find(Wf);
+  if (!t)
+    return null;
+  const { physicalScale: r, physicalUnits: i } = t;
+  let n;
+  return i === "in" ? n = 1 / r : i === "mm" ? n = 25.4 / r : i === "cm" ? n = 2.54 / r : n = so, n;
+}
+function hr(e) {
+  return e.cause !== void 0;
+}
+async function Kf(e, { scaleFactor: t, abortSignal: r, sizeOnly: i = !1 }) {
+  var p, d, m;
+  if (r != null && r.aborted)
+    throw O.debug(
+      "Abort signalled, aborting before initiating image data fetching."
+    ), new Error("Aborted due to client request", { cause: { type: "abort" } });
+  if (e.type !== "Image")
+    throw new Error(`Can only fetch image resources, got ${e.type}`);
+  let n;
+  "service" in e && (n = (p = e.service) == null ? void 0 : p.find(
+    (g) => {
+      var y, b;
+      return (((y = g == null ? void 0 : g.type) == null ? void 0 : y.startsWith("ImageService")) ?? !1) || (((b = g == null ? void 0 : g["@type"]) == null ? void 0 : b.startsWith("ImageService")) ?? !1);
+    }
+  ));
+  let s, a, o = !1;
+  if (n) {
+    n.width || (n = await ed(n));
+    const g = Xf(n, t);
+    a = `${n.id ?? n["@id"]}/full/${g.iiifSize}/0/default.jpg`, s = Gi(n.service ?? []) ?? void 0, s && (s = s * (g.width / n.width)), g.width < n.width && (o = !0);
+  } else if (e.id && ["image/jpeg", "image/png"].indexOf(e.format ?? "unknown") >= 0)
+    a = e.id;
+  else
+    return O.error(
+      `No JPEG or PNG image identifier for resource ${e.id} could be found!`
+    ), null;
+  let c, h, l = !0, u = null;
+  const f = Ee == null ? void 0 : Ee.imageFetchDuration.startTimer({
+    iiif_host: new URL(a).host
+  });
+  try {
+    const g = await Kt(a, {
+      method: "GET",
+      signal: r
+    });
+    if (g.status >= 400)
+      throw new Error(
+        `Failed to fetch page image from ${a}, server returned status ${g.status}`,
+        { cause: { type: "http-status", status: g.status } }
+      );
+    if (r != null && r.aborted)
+      throw new Error("Aborted due to client request", { cause: { type: "abort" } });
+    if (h = Number.parseInt(g.headers.get("Content-Length") ?? "-1"), c = i && h >= 0 ? void 0 : await g.arrayBuffer(), (d = g.headers.get("Content-Type")) != null && d.startsWith("image/jpeg"))
+      u = "jpeg";
+    else if ((m = g.headers.get("Content-Type")) != null && m.startsWith("image/png"))
+      u = "png";
+    else
+      throw new Error("Unsupported image content type", { cause: { type: "content-type" } });
+    h < 0 && (h = (c == null ? void 0 : c.byteLength) ?? -1), f == null || f({
+      status: "success",
+      limited: jt.isLimited(a).toString()
+    });
+  } catch (g) {
+    if (typeof document < "u" && await Zf(a)) {
+      if (!i)
+        throw new Error("Data requested, but no CORS for the image endpoint", { cause: { type: "no-cors" } });
+    } else throw O.error(`Failed to fetch image data from ${a}: ${g}`), f == null || f({
+      status: "error",
+      limited: jt.isLimited(a).toString(),
+      cause: g instanceof Error ? g.cause.type : g
+    }), g;
+    l = !1, O.warn(
+      `Failed to fetch image data from ${a}: CORS headers missing!`
+    );
+    const b = await Kt(a, {
+      method: "GET",
+      signal: r,
+      mode: "no-cors"
+    });
+    h = Number.parseInt(b.headers.get("Content-Length") ?? "-1");
+  }
+  return {
+    data: c,
+    ppi: s,
+    numBytes: h,
+    corsAvailable: l,
+    format: u,
+    downscaled: o
+  };
+}
+async function Zf(e) {
+  const t = document.createElement("img");
+  return t.src = e, new Promise((r) => {
+    t.onload = () => r(!0), t.onerror = () => r(!1);
+  });
+}
+async function ao(e) {
+  const t = e.start;
+  if (!t)
+    return;
+  let r, i;
+  if (typeof t == "string") {
+    const [l, u] = t.split("#xywh=");
+    if (!u)
+      return l;
+    r = l, i = `xywh=${u}`;
+  } else {
+    if (t.type === "SpecificResource")
+      return t.id;
+    {
+      const l = G.get(t.id);
+      if (typeof l == "string" || l.type !== "FragmentSelector") {
+        O.warn(
+          `Unsupported selector type, cannot determine start canvas for ${e.id}`
+        );
+        return;
+      }
+      const u = l;
+      if (u.conformsTo !== "http://www.w3.org/TR/media-frags/") {
+        O.warn(
+          `Unsupported selector type, cannot determine start canvas for ${e.id} (fragment selector type was ${u.conformsTo})`
+        );
+        return;
+      }
+      r = u.value;
+    }
+  }
+  if (!i || !r) {
+    O.error(
+      `Couldn't parse either canvas identifier or selector for ${e.id} start canvas.`
+    );
+    return;
+  }
+  const [n, s, a, o] = i.substring(5).split(",").map((l) => Number.parseInt(l, 10)), c = G.get(r), h = Gi(c.service) ?? so;
+  return {
+    id: r,
+    ppi: h,
+    dimensions: { width: c.width, height: c.height },
+    position: {
+      x: n,
+      y: s,
+      width: a,
+      height: o
+    }
+  };
+}
+async function oo(e, t, { scaleFactor: r, ppiOverride: i, abortSignal: n, sizeOnly: s = !1 }) {
+  const a = t.map((f) => f.resource).map((f) => Kf(f, { scaleFactor: r, abortSignal: n, sizeOnly: s })), o = await Promise.allSettled(a), c = o.reduce((f, p, d) => {
+    if (p.status !== "fulfilled" || p.value === null)
+      return f;
+    const m = t[d];
+    return f.push({
+      ...m,
+      ...p.value
+      // FIXME: How can we get rid of the cast?
+    }), f;
+  }, []), h = o.filter((f) => f.status === "rejected").map((f, p) => ({
+    ...t[p],
+    cause: f.reason
+  })), l = i;
+  i || Gi(e.service);
+  let u;
+  if (!s)
+    try {
+      u = await Yf(e, void 0);
+    } catch (f) {
+      O.warn(`Failed to fetch text for canvas ${e.id}: ${f}`);
+    }
+  return {
+    canvas: e,
+    images: c,
+    imageFailures: h,
+    ppi: l,
+    text: u,
+    annotations: ro(e)
+  };
+}
+async function co(e) {
+  try {
+    return await (await fetch(e, {
+      headers: {
+        Accept: Vf
+      }
+    })).json();
+  } catch {
+    return await (await fetch(e)).json();
+  }
+}
+async function ed(e) {
+  const t = `${e["@id"] ?? e.id}/info.json`;
+  return await (await fetch(t)).json();
+}
+function Yi(e) {
+  return e && e.__esModule && Object.prototype.hasOwnProperty.call(e, "default") ? e.default : e;
+}
+var lo = { exports: {} };
+(function(e) {
+  var t = Object.prototype.hasOwnProperty, r = "~";
+  function i() {
+  }
+  Object.create && (i.prototype = /* @__PURE__ */ Object.create(null), new i().__proto__ || (r = !1));
+  function n(c, h, l) {
+    this.fn = c, this.context = h, this.once = l || !1;
+  }
+  function s(c, h, l, u, f) {
+    if (typeof l != "function")
+      throw new TypeError("The listener must be a function");
+    var p = new n(l, u || c, f), d = r ? r + h : h;
+    return c._events[d] ? c._events[d].fn ? c._events[d] = [c._events[d], p] : c._events[d].push(p) : (c._events[d] = p, c._eventsCount++), c;
+  }
+  function a(c, h) {
+    --c._eventsCount === 0 ? c._events = new i() : delete c._events[h];
+  }
+  function o() {
+    this._events = new i(), this._eventsCount = 0;
+  }
+  o.prototype.eventNames = function() {
+    var h = [], l, u;
+    if (this._eventsCount === 0) return h;
+    for (u in l = this._events)
+      t.call(l, u) && h.push(r ? u.slice(1) : u);
+    return Object.getOwnPropertySymbols ? h.concat(Object.getOwnPropertySymbols(l)) : h;
+  }, o.prototype.listeners = function(h) {
+    var l = r ? r + h : h, u = this._events[l];
+    if (!u) return [];
+    if (u.fn) return [u.fn];
+    for (var f = 0, p = u.length, d = new Array(p); f < p; f++)
+      d[f] = u[f].fn;
+    return d;
+  }, o.prototype.listenerCount = function(h) {
+    var l = r ? r + h : h, u = this._events[l];
+    return u ? u.fn ? 1 : u.length : 0;
+  }, o.prototype.emit = function(h, l, u, f, p, d) {
+    var m = r ? r + h : h;
+    if (!this._events[m]) return !1;
+    var g = this._events[m], y = arguments.length, b, w;
+    if (g.fn) {
+      switch (g.once && this.removeListener(h, g.fn, void 0, !0), y) {
+        case 1:
+          return g.fn.call(g.context), !0;
+        case 2:
+          return g.fn.call(g.context, l), !0;
+        case 3:
+          return g.fn.call(g.context, l, u), !0;
+        case 4:
+          return g.fn.call(g.context, l, u, f), !0;
+        case 5:
+          return g.fn.call(g.context, l, u, f, p), !0;
+        case 6:
+          return g.fn.call(g.context, l, u, f, p, d), !0;
+      }
+      for (w = 1, b = new Array(y - 1); w < y; w++)
+        b[w - 1] = arguments[w];
+      g.fn.apply(g.context, b);
+    } else {
+      var F = g.length, x;
+      for (w = 0; w < F; w++)
+        switch (g[w].once && this.removeListener(h, g[w].fn, void 0, !0), y) {
+          case 1:
+            g[w].fn.call(g[w].context);
+            break;
+          case 2:
+            g[w].fn.call(g[w].context, l);
+            break;
+          case 3:
+            g[w].fn.call(g[w].context, l, u);
+            break;
+          case 4:
+            g[w].fn.call(g[w].context, l, u, f);
+            break;
+          default:
+            if (!b) for (x = 1, b = new Array(y - 1); x < y; x++)
+              b[x - 1] = arguments[x];
+            g[w].fn.apply(g[w].context, b);
+        }
+    }
+    return !0;
+  }, o.prototype.on = function(h, l, u) {
+    return s(this, h, l, u, !1);
+  }, o.prototype.once = function(h, l, u) {
+    return s(this, h, l, u, !0);
+  }, o.prototype.removeListener = function(h, l, u, f) {
+    var p = r ? r + h : h;
+    if (!this._events[p]) return this;
+    if (!l)
+      return a(this, p), this;
+    var d = this._events[p];
+    if (d.fn)
+      d.fn === l && (!f || d.once) && (!u || d.context === u) && a(this, p);
+    else {
+      for (var m = 0, g = [], y = d.length; m < y; m++)
+        (d[m].fn !== l || f && !d[m].once || u && d[m].context !== u) && g.push(d[m]);
+      g.length ? this._events[p] = g.length === 1 ? g[0] : g : a(this, p);
+    }
+    return this;
+  }, o.prototype.removeAllListeners = function(h) {
+    var l;
+    return h ? (l = r ? r + h : h, this._events[l] && a(this, l)) : (this._events = new i(), this._eventsCount = 0), this;
+  }, o.prototype.off = o.prototype.removeListener, o.prototype.addListener = o.prototype.on, o.prefixed = r, o.EventEmitter = o, e.exports = o;
+})(lo);
+var td = lo.exports;
+const rd = /* @__PURE__ */ Yi(td);
+class ho extends Error {
+  constructor(t) {
+    super(t), this.name = "TimeoutError";
+  }
+}
+let id = class extends Error {
+  constructor(t) {
+    super(), this.name = "AbortError", this.message = t;
+  }
+};
+const Pn = (e) => globalThis.DOMException === void 0 ? new id(e) : new DOMException(e), jn = (e) => {
+  const t = e.reason === void 0 ? Pn("This operation was aborted.") : e.reason;
+  return t instanceof Error ? t : Pn(t);
+};
+function nd(e, t, r, i) {
+  let n;
+  const s = new Promise((a, o) => {
+    if (typeof t != "number" || Math.sign(t) !== 1)
+      throw new TypeError(`Expected \`milliseconds\` to be a positive number, got \`${t}\``);
+    if (t === Number.POSITIVE_INFINITY) {
+      a(e);
+      return;
+    }
+    if (i = {
+      customTimers: { setTimeout, clearTimeout },
+      ...i
+    }, i.signal) {
+      const { signal: c } = i;
+      c.aborted && o(jn(c)), c.addEventListener("abort", () => {
+        o(jn(c));
+      });
+    }
+    n = i.customTimers.setTimeout.call(void 0, () => {
+      const c = `Promise timed out after ${t} milliseconds`, h = r instanceof Error ? r : new ho(c);
+      typeof e.cancel == "function" && e.cancel(), o(h);
+    }, t), (async () => {
+      try {
+        a(await e);
+      } catch (c) {
+        o(c);
+      } finally {
+        i.customTimers.clearTimeout.call(void 0, n);
+      }
+    })();
+  });
+  return s.clear = () => {
+    clearTimeout(n), n = void 0;
+  }, s;
+}
+function sd(e, t, r) {
+  let i = 0, n = e.length;
+  for (; n > 0; ) {
+    const s = Math.trunc(n / 2);
+    let a = i + s;
+    r(e[a], t) <= 0 ? (i = ++a, n -= s + 1) : n = s;
+  }
+  return i;
+}
+var lt = function(e, t, r, i) {
+  if (r === "a" && !i) throw new TypeError("Private accessor was defined without a getter");
+  if (typeof t == "function" ? e !== t || !i : !t.has(e)) throw new TypeError("Cannot read private member from an object whose class did not declare it");
+  return r === "m" ? i : r === "a" ? i.call(e) : i ? i.value : t.get(e);
+}, We;
+class ad {
+  constructor() {
+    We.set(this, []);
+  }
+  enqueue(t, r) {
+    r = {
+      priority: 0,
+      ...r
+    };
+    const i = {
+      priority: r.priority,
+      run: t
+    };
+    if (this.size && lt(this, We, "f")[this.size - 1].priority >= r.priority) {
+      lt(this, We, "f").push(i);
+      return;
+    }
+    const n = sd(lt(this, We, "f"), i, (s, a) => a.priority - s.priority);
+    lt(this, We, "f").splice(n, 0, i);
+  }
+  dequeue() {
+    const t = lt(this, We, "f").shift();
+    return t == null ? void 0 : t.run;
+  }
+  filter(t) {
+    return lt(this, We, "f").filter((r) => r.priority === t.priority).map((r) => r.run);
+  }
+  get size() {
+    return lt(this, We, "f").length;
+  }
+}
+We = /* @__PURE__ */ new WeakMap();
+var J = function(e, t, r, i, n) {
+  if (i === "m") throw new TypeError("Private method is not writable");
+  if (i === "a" && !n) throw new TypeError("Private accessor was defined without a setter");
+  if (typeof t == "function" ? e !== t || !n : !t.has(e)) throw new TypeError("Cannot write private member to an object whose class did not declare it");
+  return i === "a" ? n.call(e, r) : n ? n.value = r : t.set(e, r), r;
+}, k = function(e, t, r, i) {
+  if (r === "a" && !i) throw new TypeError("Private accessor was defined without a getter");
+  if (typeof t == "function" ? e !== t || !i : !t.has(e)) throw new TypeError("Cannot read private member from an object whose class did not declare it");
+  return r === "m" ? i : r === "a" ? i.call(e) : i ? i.value : t.get(e);
+}, re, Qt, Gt, Je, Cr, Yt, mr, ke, Lt, pe, vr, ge, Vt, Ve, yr, $n, Fn, uo, En, Rn, br, Zr, ei, Sr, fo, wr;
+class po extends Error {
+}
+class go extends rd {
+  // TODO: The `throwOnTimeout` option should affect the return types of `add()` and `addAll()`
+  constructor(t) {
+    var r, i, n, s;
+    if (super(), re.add(this), Qt.set(this, void 0), Gt.set(this, void 0), Je.set(this, 0), Cr.set(this, void 0), Yt.set(this, void 0), mr.set(this, 0), ke.set(this, void 0), Lt.set(this, void 0), pe.set(this, void 0), vr.set(this, void 0), ge.set(this, 0), Vt.set(this, void 0), Ve.set(this, void 0), yr.set(this, void 0), Object.defineProperty(this, "timeout", {
+      enumerable: !0,
+      configurable: !0,
+      writable: !0,
+      value: void 0
+    }), t = {
+      carryoverConcurrencyCount: !1,
+      intervalCap: Number.POSITIVE_INFINITY,
+      interval: 0,
+      concurrency: Number.POSITIVE_INFINITY,
+      autoStart: !0,
+      queueClass: ad,
+      ...t
+    }, !(typeof t.intervalCap == "number" && t.intervalCap >= 1))
+      throw new TypeError(`Expected \`intervalCap\` to be a number from 1 and up, got \`${(i = (r = t.intervalCap) === null || r === void 0 ? void 0 : r.toString()) !== null && i !== void 0 ? i : ""}\` (${typeof t.intervalCap})`);
+    if (t.interval === void 0 || !(Number.isFinite(t.interval) && t.interval >= 0))
+      throw new TypeError(`Expected \`interval\` to be a finite number >= 0, got \`${(s = (n = t.interval) === null || n === void 0 ? void 0 : n.toString()) !== null && s !== void 0 ? s : ""}\` (${typeof t.interval})`);
+    J(this, Qt, t.carryoverConcurrencyCount, "f"), J(this, Gt, t.intervalCap === Number.POSITIVE_INFINITY || t.interval === 0, "f"), J(this, Cr, t.intervalCap, "f"), J(this, Yt, t.interval, "f"), J(this, pe, new t.queueClass(), "f"), J(this, vr, t.queueClass, "f"), this.concurrency = t.concurrency, this.timeout = t.timeout, J(this, yr, t.throwOnTimeout === !0, "f"), J(this, Ve, t.autoStart === !1, "f");
+  }
+  get concurrency() {
+    return k(this, Vt, "f");
+  }
+  set concurrency(t) {
+    if (!(typeof t == "number" && t >= 1))
+      throw new TypeError(`Expected \`concurrency\` to be a number from 1 and up, got \`${t}\` (${typeof t})`);
+    J(this, Vt, t, "f"), k(this, re, "m", Sr).call(this);
+  }
+  async add(t, r = {}) {
+    return r = {
+      timeout: this.timeout,
+      throwOnTimeout: k(this, yr, "f"),
+      ...r
+    }, new Promise((i, n) => {
+      k(this, pe, "f").enqueue(async () => {
+        var s, a, o;
+        J(this, ge, (a = k(this, ge, "f"), a++, a), "f"), J(this, Je, (o = k(this, Je, "f"), o++, o), "f");
+        try {
+          if (!((s = r.signal) === null || s === void 0) && s.aborted)
+            throw new po("The task was aborted.");
+          let c = t({ signal: r.signal });
+          r.timeout && (c = nd(Promise.resolve(c), r.timeout)), r.signal && (c = Promise.race([c, k(this, re, "m", fo).call(this, r.signal)]));
+          const h = await c;
+          i(h), this.emit("completed", h);
+        } catch (c) {
+          if (c instanceof ho && !r.throwOnTimeout) {
+            i();
+            return;
+          }
+          n(c), this.emit("error", c);
+        } finally {
+          k(this, re, "m", uo).call(this);
+        }
+      }, r), this.emit("add"), k(this, re, "m", br).call(this);
+    });
+  }
+  async addAll(t, r) {
+    return Promise.all(t.map(async (i) => this.add(i, r)));
+  }
+  /**
+  Start (or resume) executing enqueued tasks within concurrency limit. No need to call this if queue is not paused (via `options.autoStart = false` or by `.pause()` method.)
+  */
+  start() {
+    return k(this, Ve, "f") ? (J(this, Ve, !1, "f"), k(this, re, "m", Sr).call(this), this) : this;
+  }
+  /**
+  Put queue execution on hold.
+  */
+  pause() {
+    J(this, Ve, !0, "f");
+  }
+  /**
+  Clear the queue.
+  */
+  clear() {
+    J(this, pe, new (k(this, vr, "f"))(), "f");
+  }
+  /**
+      Can be called multiple times. Useful if you for example add additional items at a later time.
+  
+      @returns A promise that settles when the queue becomes empty.
+      */
+  async onEmpty() {
+    k(this, pe, "f").size !== 0 && await k(this, re, "m", wr).call(this, "empty");
+  }
+  /**
+      @returns A promise that settles when the queue size is less than the given limit: `queue.size < limit`.
+  
+      If you want to avoid having the queue grow beyond a certain size you can `await queue.onSizeLessThan()` before adding a new item.
+  
+      Note that this only limits the number of items waiting to start. There could still be up to `concurrency` jobs already running that this call does not include in its calculation.
+      */
+  async onSizeLessThan(t) {
+    k(this, pe, "f").size < t || await k(this, re, "m", wr).call(this, "next", () => k(this, pe, "f").size < t);
+  }
+  /**
+      The difference with `.onEmpty` is that `.onIdle` guarantees that all work from the queue has finished. `.onEmpty` merely signals that the queue is empty, but it could mean that some promises haven't completed yet.
+  
+      @returns A promise that settles when the queue becomes empty, and all promises have completed; `queue.size === 0 && queue.pending === 0`.
+      */
+  async onIdle() {
+    k(this, ge, "f") === 0 && k(this, pe, "f").size === 0 || await k(this, re, "m", wr).call(this, "idle");
+  }
+  /**
+  Size of the queue, the number of queued items waiting to run.
+  */
+  get size() {
+    return k(this, pe, "f").size;
+  }
+  /**
+      Size of the queue, filtered by the given options.
+  
+      For example, this can be used to find the number of items remaining in the queue with a specific priority level.
+      */
+  sizeBy(t) {
+    return k(this, pe, "f").filter(t).length;
+  }
+  /**
+  Number of running items (no longer in the queue).
+  */
+  get pending() {
+    return k(this, ge, "f");
+  }
+  /**
+  Whether the queue is currently paused.
+  */
+  get isPaused() {
+    return k(this, Ve, "f");
+  }
+}
+Qt = /* @__PURE__ */ new WeakMap(), Gt = /* @__PURE__ */ new WeakMap(), Je = /* @__PURE__ */ new WeakMap(), Cr = /* @__PURE__ */ new WeakMap(), Yt = /* @__PURE__ */ new WeakMap(), mr = /* @__PURE__ */ new WeakMap(), ke = /* @__PURE__ */ new WeakMap(), Lt = /* @__PURE__ */ new WeakMap(), pe = /* @__PURE__ */ new WeakMap(), vr = /* @__PURE__ */ new WeakMap(), ge = /* @__PURE__ */ new WeakMap(), Vt = /* @__PURE__ */ new WeakMap(), Ve = /* @__PURE__ */ new WeakMap(), yr = /* @__PURE__ */ new WeakMap(), re = /* @__PURE__ */ new WeakSet(), $n = function() {
+  return k(this, Gt, "f") || k(this, Je, "f") < k(this, Cr, "f");
+}, Fn = function() {
+  return k(this, ge, "f") < k(this, Vt, "f");
+}, uo = function() {
+  var t;
+  J(this, ge, (t = k(this, ge, "f"), t--, t), "f"), k(this, re, "m", br).call(this), this.emit("next");
+}, En = function() {
+  k(this, re, "m", ei).call(this), k(this, re, "m", Zr).call(this), J(this, Lt, void 0, "f");
+}, Rn = function() {
+  const t = Date.now();
+  if (k(this, ke, "f") === void 0) {
+    const r = k(this, mr, "f") - t;
+    if (r < 0)
+      J(this, Je, k(this, Qt, "f") ? k(this, ge, "f") : 0, "f");
+    else
+      return k(this, Lt, "f") === void 0 && J(this, Lt, setTimeout(() => {
+        k(this, re, "m", En).call(this);
+      }, r), "f"), !0;
+  }
+  return !1;
+}, br = function() {
+  if (k(this, pe, "f").size === 0)
+    return k(this, ke, "f") && clearInterval(k(this, ke, "f")), J(this, ke, void 0, "f"), this.emit("empty"), k(this, ge, "f") === 0 && this.emit("idle"), !1;
+  if (!k(this, Ve, "f")) {
+    const t = !k(this, re, "a", Rn);
+    if (k(this, re, "a", $n) && k(this, re, "a", Fn)) {
+      const r = k(this, pe, "f").dequeue();
+      return r ? (this.emit("active"), r(), t && k(this, re, "m", Zr).call(this), !0) : !1;
+    }
+  }
+  return !1;
+}, Zr = function() {
+  k(this, Gt, "f") || k(this, ke, "f") !== void 0 || (J(this, ke, setInterval(() => {
+    k(this, re, "m", ei).call(this);
+  }, k(this, Yt, "f")), "f"), J(this, mr, Date.now() + k(this, Yt, "f"), "f"));
+}, ei = function() {
+  k(this, Je, "f") === 0 && k(this, ge, "f") === 0 && k(this, ke, "f") && (clearInterval(k(this, ke, "f")), J(this, ke, void 0, "f")), J(this, Je, k(this, Qt, "f") ? k(this, ge, "f") : 0, "f"), k(this, re, "m", Sr).call(this);
+}, Sr = function() {
+  for (; k(this, re, "m", br).call(this); )
+    ;
+}, fo = async function(t) {
+  return new Promise((r, i) => {
+    t.addEventListener("abort", () => {
+      i(new po("The task was aborted."));
+    }, { once: !0 });
+  });
+}, wr = async function(t, r) {
+  return new Promise((i) => {
+    const n = () => {
+      r && !r() || (this.off(t, n), i());
+    };
+    this.on(t, n);
+  });
+};
+var od = function(t) {
+  for (var r = [], i = 1; i < arguments.length; i++)
+    r[i - 1] = arguments[i];
+  var n = [], s = typeof t == "string" ? [t] : t.slice();
+  s[s.length - 1] = s[s.length - 1].replace(/\r?\n([\t ]*)$/, "");
+  for (var a = 0; a < s.length; a++) {
+    var o = void 0;
+    (o = s[a].match(/\n[\t ]+/g)) && n.push.apply(n, o);
+  }
+  if (n.length)
+    for (var c = Math.min.apply(Math, n.map(function(u) {
+      return u.length - 1;
+    })), h = new RegExp(`
+[	 ]{` + c + "}", "g"), a = 0; a < s.length; a++)
+      s[a] = s[a].replace(h, `
+`);
+  s[0] = s[0].replace(/^\r?\n/, "");
+  for (var l = s[0], a = 0; a < r.length; a++)
+    l += r[a] + s[a + 1];
+  return l;
+};
+const cd = /* @__PURE__ */ Yi(od);
+var ue = Uint8Array, ve = Uint16Array, Vi = Int32Array, Dr = new ue([
+  0,
+  0,
+  0,
+  0,
+  0,
+  0,
+  0,
+  0,
+  1,
+  1,
+  1,
+  1,
+  2,
+  2,
+  2,
+  2,
+  3,
+  3,
+  3,
+  3,
+  4,
+  4,
+  4,
+  4,
+  5,
+  5,
+  5,
+  5,
+  0,
+  /* unused */
+  0,
+  0,
+  /* impossible */
+  0
+]), Lr = new ue([
+  0,
+  0,
+  0,
+  0,
+  1,
+  1,
+  2,
+  2,
+  3,
+  3,
+  4,
+  4,
+  5,
+  5,
+  6,
+  6,
+  7,
+  7,
+  8,
+  8,
+  9,
+  9,
+  10,
+  10,
+  11,
+  11,
+  12,
+  12,
+  13,
+  13,
+  /* unused */
+  0,
+  0
+]), _i = new ue([16, 17, 18, 0, 8, 7, 9, 6, 10, 5, 11, 4, 12, 3, 13, 2, 14, 1, 15]), mo = function(e, t) {
+  for (var r = new ve(31), i = 0; i < 31; ++i)
+    r[i] = t += 1 << e[i - 1];
+  for (var n = new Vi(r[30]), i = 1; i < 30; ++i)
+    for (var s = r[i]; s < r[i + 1]; ++s)
+      n[s] = s - r[i] << 5 | i;
+  return { b: r, r: n };
+}, vo = mo(Dr, 2), yo = vo.b, Oi = vo.r;
+yo[28] = 258, Oi[258] = 28;
+var bo = mo(Lr, 0), ld = bo.b, Mn = bo.r, ki = new ve(32768);
+for (var Q = 0; Q < 32768; ++Q) {
+  var Ge = (Q & 43690) >> 1 | (Q & 21845) << 1;
+  Ge = (Ge & 52428) >> 2 | (Ge & 13107) << 2, Ge = (Ge & 61680) >> 4 | (Ge & 3855) << 4, ki[Q] = ((Ge & 65280) >> 8 | (Ge & 255) << 8) >> 1;
+}
+var Re = function(e, t, r) {
+  for (var i = e.length, n = 0, s = new ve(t); n < i; ++n)
+    e[n] && ++s[e[n] - 1];
+  var a = new ve(t);
+  for (n = 1; n < t; ++n)
+    a[n] = a[n - 1] + s[n - 1] << 1;
+  var o;
+  if (r) {
+    o = new ve(1 << t);
+    var c = 15 - t;
+    for (n = 0; n < i; ++n)
+      if (e[n])
+        for (var h = n << 4 | e[n], l = t - e[n], u = a[e[n] - 1]++ << l, f = u | (1 << l) - 1; u <= f; ++u)
+          o[ki[u] >> c] = h;
+  } else
+    for (o = new ve(i), n = 0; n < i; ++n)
+      e[n] && (o[n] = ki[a[e[n] - 1]++] >> 15 - e[n]);
+  return o;
+}, it = new ue(288);
+for (var Q = 0; Q < 144; ++Q)
+  it[Q] = 8;
+for (var Q = 144; Q < 256; ++Q)
+  it[Q] = 9;
+for (var Q = 256; Q < 280; ++Q)
+  it[Q] = 7;
+for (var Q = 280; Q < 288; ++Q)
+  it[Q] = 8;
+var Zt = new ue(32);
+for (var Q = 0; Q < 32; ++Q)
+  Zt[Q] = 5;
+var hd = /* @__PURE__ */ Re(it, 9, 0), ud = /* @__PURE__ */ Re(it, 9, 1), fd = /* @__PURE__ */ Re(Zt, 5, 0), dd = /* @__PURE__ */ Re(Zt, 5, 1), ti = function(e) {
+  for (var t = e[0], r = 1; r < e.length; ++r)
+    e[r] > t && (t = e[r]);
+  return t;
+}, Oe = function(e, t, r) {
+  var i = t / 8 | 0;
+  return (e[i] | e[i + 1] << 8) >> (t & 7) & r;
+}, ri = function(e, t) {
+  var r = t / 8 | 0;
+  return (e[r] | e[r + 1] << 8 | e[r + 2] << 16) >> (t & 7);
+}, Ji = function(e) {
+  return (e + 7) / 8 | 0;
+}, wo = function(e, t, r) {
+  return (r == null || r > e.length) && (r = e.length), new ue(e.subarray(t, r));
+}, pd = [
+  "unexpected EOF",
+  "invalid block type",
+  "invalid length/literal",
+  "invalid distance",
+  "stream finished",
+  "no stream handler",
+  ,
+  "no callback",
+  "invalid UTF-8 data",
+  "extra field too long",
+  "date not in range 1980-2099",
+  "filename too long",
+  "stream finishing",
+  "invalid zip data"
+  // determined by unknown compression method
+], Ie = function(e, t, r) {
+  var i = new Error(t || pd[e]);
+  if (i.code = e, Error.captureStackTrace && Error.captureStackTrace(i, Ie), !r)
+    throw i;
+  return i;
+}, gd = function(e, t, r, i) {
+  var n = e.length, s = 0;
+  if (!n || t.f && !t.l)
+    return r || new ue(0);
+  var a = !r, o = a || t.i != 2, c = t.i;
+  a && (r = new ue(n * 3));
+  var h = function(De) {
+    var le = r.length;
+    if (De > le) {
+      var U = new ue(Math.max(le * 2, De));
+      U.set(r), r = U;
+    }
+  }, l = t.f || 0, u = t.p || 0, f = t.b || 0, p = t.l, d = t.d, m = t.m, g = t.n, y = n * 8;
+  do {
+    if (!p) {
+      l = Oe(e, u, 1);
+      var b = Oe(e, u + 1, 3);
+      if (u += 3, b)
+        if (b == 1)
+          p = ud, d = dd, m = 9, g = 5;
+        else if (b == 2) {
+          var A = Oe(e, u, 31) + 257, I = Oe(e, u + 10, 15) + 4, C = A + Oe(e, u + 5, 31) + 1;
+          u += 14;
+          for (var S = new ue(C), E = new ue(19), _ = 0; _ < I; ++_)
+            E[_i[_]] = Oe(e, u + _ * 3, 7);
+          u += I * 3;
+          for (var R = ti(E), V = (1 << R) - 1, H = Re(E, R, 1), _ = 0; _ < C; ) {
+            var z = H[Oe(e, u, V)];
+            u += z & 15;
+            var w = z >> 4;
+            if (w < 16)
+              S[_++] = w;
+            else {
+              var B = 0, D = 0;
+              for (w == 16 ? (D = 3 + Oe(e, u, 3), u += 2, B = S[_ - 1]) : w == 17 ? (D = 3 + Oe(e, u, 7), u += 3) : w == 18 && (D = 11 + Oe(e, u, 127), u += 7); D--; )
+                S[_++] = B;
+            }
+          }
+          var X = S.subarray(0, A), W = S.subarray(A);
+          m = ti(X), g = ti(W), p = Re(X, m, 1), d = Re(W, g, 1);
+        } else
+          Ie(1);
+      else {
+        var w = Ji(u) + 4, F = e[w - 4] | e[w - 3] << 8, x = w + F;
+        if (x > n) {
+          c && Ie(0);
+          break;
+        }
+        o && h(f + F), r.set(e.subarray(w, x), f), t.b = f += F, t.p = u = x * 8, t.f = l;
+        continue;
+      }
+      if (u > y) {
+        c && Ie(0);
+        break;
+      }
+    }
+    o && h(f + 131072);
+    for (var Ae = (1 << m) - 1, $ = (1 << g) - 1, q = u; ; q = u) {
+      var B = p[ri(e, u) & Ae], ee = B >> 4;
+      if (u += B & 15, u > y) {
+        c && Ie(0);
+        break;
+      }
+      if (B || Ie(2), ee < 256)
+        r[f++] = ee;
+      else if (ee == 256) {
+        q = u, p = null;
+        break;
+      } else {
+        var te = ee - 254;
+        if (ee > 264) {
+          var _ = ee - 257, L = Dr[_];
+          te = Oe(e, u, (1 << L) - 1) + yo[_], u += L;
+        }
+        var de = d[ri(e, u) & $], _e = de >> 4;
+        de || Ie(3), u += de & 15;
+        var W = ld[_e];
+        if (_e > 3) {
+          var L = Lr[_e];
+          W += ri(e, u) & (1 << L) - 1, u += L;
+        }
+        if (u > y) {
+          c && Ie(0);
+          break;
+        }
+        o && h(f + 131072);
+        var Ne = f + te;
+        if (f < W) {
+          var je = s - W, st = Math.min(W, Ne);
+          for (je + f < 0 && Ie(3); f < st; ++f)
+            r[f] = i[je + f];
+        }
+        for (; f < Ne; ++f)
+          r[f] = r[f - W];
+      }
+    }
+    t.l = p, t.p = q, t.b = f, t.f = l, p && (l = 1, t.m = m, t.d = d, t.n = g);
+  } while (!l);
+  return f != r.length && a ? wo(r, 0, f) : r.subarray(0, f);
+}, Le = function(e, t, r) {
+  r <<= t & 7;
+  var i = t / 8 | 0;
+  e[i] |= r, e[i + 1] |= r >> 8;
+}, Rt = function(e, t, r) {
+  r <<= t & 7;
+  var i = t / 8 | 0;
+  e[i] |= r, e[i + 1] |= r >> 8, e[i + 2] |= r >> 16;
+}, ii = function(e, t) {
+  for (var r = [], i = 0; i < e.length; ++i)
+    e[i] && r.push({ s: i, f: e[i] });
+  var n = r.length, s = r.slice();
+  if (!n)
+    return { t: Co, l: 0 };
+  if (n == 1) {
+    var a = new ue(r[0].s + 1);
+    return a[r[0].s] = 1, { t: a, l: 1 };
+  }
+  r.sort(function(x, A) {
+    return x.f - A.f;
+  }), r.push({ s: -1, f: 25001 });
+  var o = r[0], c = r[1], h = 0, l = 1, u = 2;
+  for (r[0] = { s: -1, f: o.f + c.f, l: o, r: c }; l != n - 1; )
+    o = r[r[h].f < r[u].f ? h++ : u++], c = r[h != l && r[h].f < r[u].f ? h++ : u++], r[l++] = { s: -1, f: o.f + c.f, l: o, r: c };
+  for (var f = s[0].s, i = 1; i < n; ++i)
+    s[i].s > f && (f = s[i].s);
+  var p = new ve(f + 1), d = Ii(r[l - 1], p, 0);
+  if (d > t) {
+    var i = 0, m = 0, g = d - t, y = 1 << g;
+    for (s.sort(function(A, I) {
+      return p[I.s] - p[A.s] || A.f - I.f;
+    }); i < n; ++i) {
+      var b = s[i].s;
+      if (p[b] > t)
+        m += y - (1 << d - p[b]), p[b] = t;
+      else
+        break;
+    }
+    for (m >>= g; m > 0; ) {
+      var w = s[i].s;
+      p[w] < t ? m -= 1 << t - p[w]++ - 1 : ++i;
+    }
+    for (; i >= 0 && m; --i) {
+      var F = s[i].s;
+      p[F] == t && (--p[F], ++m);
+    }
+    d = t;
+  }
+  return { t: new ue(p), l: d };
+}, Ii = function(e, t, r) {
+  return e.s == -1 ? Math.max(Ii(e.l, t, r + 1), Ii(e.r, t, r + 1)) : t[e.s] = r;
+}, Nn = function(e) {
+  for (var t = e.length; t && !e[--t]; )
+    ;
+  for (var r = new ve(++t), i = 0, n = e[0], s = 1, a = function(c) {
+    r[i++] = c;
+  }, o = 1; o <= t; ++o)
+    if (e[o] == n && o != t)
+      ++s;
+    else {
+      if (!n && s > 2) {
+        for (; s > 138; s -= 138)
+          a(32754);
+        s > 2 && (a(s > 10 ? s - 11 << 5 | 28690 : s - 3 << 5 | 12305), s = 0);
+      } else if (s > 3) {
+        for (a(n), --s; s > 6; s -= 6)
+          a(8304);
+        s > 2 && (a(s - 3 << 5 | 8208), s = 0);
+      }
+      for (; s--; )
+        a(n);
+      s = 1, n = e[o];
+    }
+  return { c: r.subarray(0, i), n: t };
+}, Mt = function(e, t) {
+  for (var r = 0, i = 0; i < t.length; ++i)
+    r += e[i] * t[i];
+  return r;
+}, xo = function(e, t, r) {
+  var i = r.length, n = Ji(t + 2);
+  e[n] = i & 255, e[n + 1] = i >> 8, e[n + 2] = e[n] ^ 255, e[n + 3] = e[n + 1] ^ 255;
+  for (var s = 0; s < i; ++s)
+    e[n + s + 4] = r[s];
+  return (n + 4 + i) * 8;
+}, Dn = function(e, t, r, i, n, s, a, o, c, h, l) {
+  Le(t, l++, r), ++n[256];
+  for (var u = ii(n, 15), f = u.t, p = u.l, d = ii(s, 15), m = d.t, g = d.l, y = Nn(f), b = y.c, w = y.n, F = Nn(m), x = F.c, A = F.n, I = new ve(19), C = 0; C < b.length; ++C)
+    ++I[b[C] & 31];
+  for (var C = 0; C < x.length; ++C)
+    ++I[x[C] & 31];
+  for (var S = ii(I, 7), E = S.t, _ = S.l, R = 19; R > 4 && !E[_i[R - 1]]; --R)
+    ;
+  var V = h + 5 << 3, H = Mt(n, it) + Mt(s, Zt) + a, z = Mt(n, f) + Mt(s, m) + a + 14 + 3 * R + Mt(I, E) + 2 * I[16] + 3 * I[17] + 7 * I[18];
+  if (c >= 0 && V <= H && V <= z)
+    return xo(t, l, e.subarray(c, c + h));
+  var B, D, X, W;
+  if (Le(t, l, 1 + (z < H)), l += 2, z < H) {
+    B = Re(f, p, 0), D = f, X = Re(m, g, 0), W = m;
+    var Ae = Re(E, _, 0);
+    Le(t, l, w - 257), Le(t, l + 5, A - 1), Le(t, l + 10, R - 4), l += 14;
+    for (var C = 0; C < R; ++C)
+      Le(t, l + 3 * C, E[_i[C]]);
+    l += 3 * R;
+    for (var $ = [b, x], q = 0; q < 2; ++q)
+      for (var ee = $[q], C = 0; C < ee.length; ++C) {
+        var te = ee[C] & 31;
+        Le(t, l, Ae[te]), l += E[te], te > 15 && (Le(t, l, ee[C] >> 5 & 127), l += ee[C] >> 12);
+      }
+  } else
+    B = hd, D = it, X = fd, W = Zt;
+  for (var C = 0; C < o; ++C) {
+    var L = i[C];
+    if (L > 255) {
+      var te = L >> 18 & 31;
+      Rt(t, l, B[te + 257]), l += D[te + 257], te > 7 && (Le(t, l, L >> 23 & 31), l += Dr[te]);
+      var de = L & 31;
+      Rt(t, l, X[de]), l += W[de], de > 3 && (Rt(t, l, L >> 5 & 8191), l += Lr[de]);
+    } else
+      Rt(t, l, B[L]), l += D[L];
+  }
+  return Rt(t, l, B[256]), l + D[256];
+}, md = /* @__PURE__ */ new Vi([65540, 131080, 131088, 131104, 262176, 1048704, 1048832, 2114560, 2117632]), Co = /* @__PURE__ */ new ue(0), vd = function(e, t, r, i, n, s) {
+  var a = s.z || e.length, o = new ue(i + a + 5 * (1 + Math.ceil(a / 7e3)) + n), c = o.subarray(i, o.length - n), h = s.l, l = (s.r || 0) & 7;
+  if (t) {
+    l && (c[0] = s.r >> 3);
+    for (var u = md[t - 1], f = u >> 13, p = u & 8191, d = (1 << r) - 1, m = s.p || new ve(32768), g = s.h || new ve(d + 1), y = Math.ceil(r / 3), b = 2 * y, w = function(Ur) {
+      return (e[Ur] ^ e[Ur + 1] << y ^ e[Ur + 2] << b) & d;
+    }, F = new Vi(25e3), x = new ve(288), A = new ve(32), I = 0, C = 0, S = s.i || 0, E = 0, _ = s.w || 0, R = 0; S + 2 < a; ++S) {
+      var V = w(S), H = S & 32767, z = g[V];
+      if (m[H] = z, g[V] = H, _ <= S) {
+        var B = a - S;
+        if ((I > 7e3 || E > 24576) && (B > 423 || !h)) {
+          l = Dn(e, c, 0, F, x, A, C, E, R, S - R, l), E = I = C = 0, R = S;
+          for (var D = 0; D < 286; ++D)
+            x[D] = 0;
+          for (var D = 0; D < 30; ++D)
+            A[D] = 0;
+        }
+        var X = 2, W = 0, Ae = p, $ = H - z & 32767;
+        if (B > 2 && V == w(S - $))
+          for (var q = Math.min(f, B) - 1, ee = Math.min(32767, S), te = Math.min(258, B); $ <= ee && --Ae && H != z; ) {
+            if (e[S + X] == e[S + X - $]) {
+              for (var L = 0; L < te && e[S + L] == e[S + L - $]; ++L)
+                ;
+              if (L > X) {
+                if (X = L, W = $, L > q)
+                  break;
+                for (var de = Math.min($, L - 2), _e = 0, D = 0; D < de; ++D) {
+                  var Ne = S - $ + D & 32767, je = m[Ne], st = Ne - je & 32767;
+                  st > _e && (_e = st, z = Ne);
+                }
+              }
+            }
+            H = z, z = m[H], $ += H - z & 32767;
+          }
+        if (W) {
+          F[E++] = 268435456 | Oi[X] << 18 | Mn[W];
+          var De = Oi[X] & 31, le = Mn[W] & 31;
+          C += Dr[De] + Lr[le], ++x[257 + De], ++A[le], _ = S + X, ++I;
+        } else
+          F[E++] = e[S], ++x[e[S]];
+      }
+    }
+    for (S = Math.max(S, _); S < a; ++S)
+      F[E++] = e[S], ++x[e[S]];
+    l = Dn(e, c, h, F, x, A, C, E, R, S - R, l), h || (s.r = l & 7 | c[l / 8 | 0] << 3, l -= 7, s.h = g, s.p = m, s.i = S, s.w = _);
+  } else {
+    for (var S = s.w || 0; S < a + h; S += 65535) {
+      var U = S + 65535;
+      U >= a && (c[l / 8 | 0] = h, U = a), l = xo(c, l + 1, e.subarray(S, U));
+    }
+    s.i = a;
+  }
+  return wo(o, 0, i + Ji(l) + n);
+}, So = function() {
+  var e = 1, t = 0;
+  return {
+    p: function(r) {
+      for (var i = e, n = t, s = r.length | 0, a = 0; a != s; ) {
+        for (var o = Math.min(a + 2655, s); a < o; ++a)
+          n += i += r[a];
+        i = (i & 65535) + 15 * (i >> 16), n = (n & 65535) + 15 * (n >> 16);
+      }
+      e = i, t = n;
+    },
+    d: function() {
+      return e %= 65521, t %= 65521, (e & 255) << 24 | (e & 65280) << 8 | (t & 255) << 8 | t >> 8;
+    }
+  };
+}, yd = function(e, t, r, i, n) {
+  if (!n && (n = { l: 1 }, t.dictionary)) {
+    var s = t.dictionary.subarray(-32768), a = new ue(s.length + e.length);
+    a.set(s), a.set(e, s.length), e = a, n.w = s.length;
+  }
+  return vd(e, t.level == null ? 6 : t.level, t.mem == null ? n.l ? Math.ceil(Math.max(8, Math.min(13, Math.log(e.length))) * 1.5) : 20 : 12 + t.mem, r, i, n);
+}, Ao = function(e, t, r) {
+  for (; r; ++t)
+    e[t] = r, r >>>= 8;
+}, bd = function(e, t) {
+  var r = t.level, i = r == 0 ? 0 : r < 6 ? 1 : r == 9 ? 3 : 2;
+  if (e[0] = 120, e[1] = i << 6 | (t.dictionary && 32), e[1] |= 31 - (e[0] << 8 | e[1]) % 31, t.dictionary) {
+    var n = So();
+    n.p(t.dictionary), Ao(e, 2, n.d());
+  }
+}, wd = function(e, t) {
+  return ((e[0] & 15) != 8 || e[0] >> 4 > 7 || (e[0] << 8 | e[1]) % 31) && Ie(6, "invalid zlib data"), (e[1] >> 5 & 1) == 1 && Ie(6, "invalid zlib data: " + (e[1] & 32 ? "need" : "unexpected") + " dictionary"), (e[1] >> 3 & 4) + 2;
+};
+function Wt(e, t) {
+  t || (t = {});
+  var r = So();
+  r.p(e);
+  var i = yd(e, t, t.dictionary ? 6 : 2, 4);
+  return bd(i, t), Ao(i, i.length - 4, r.d()), i;
+}
+function xd(e, t) {
+  return gd(e.subarray(wd(e), -4), { i: 2 }, t, t);
+}
+var Cd = typeof TextDecoder < "u" && /* @__PURE__ */ new TextDecoder(), Sd = 0;
+try {
+  Cd.decode(Co, { stream: !0 }), Sd = 1;
+} catch {
+}
+let Pe, er;
+typeof TextEncoder < "u" && typeof TextDecoder < "u" ? (Pe = new TextEncoder(), er = new TextDecoder()) : (Pe = new Zi.TextEncoder(), er = new Zi.TextDecoder());
+let Ar;
+Li() ? Ar = qo.webcrypto : Ar = crypto;
+const _o = (() => {
+  const e = new Uint8Array(4), t = new Uint32Array(e.buffer);
+  return !((t[0] = 1) & e[0]);
+})();
+function Ln(e) {
+  const t = new Uint8Array(e);
+  if (Ar !== void 0)
+    Ar.getRandomValues(t);
+  else {
+    const r = new Uint32Array(t.buffer);
+    for (let i = 0; i < r.length; i++)
+      r[i] = Math.floor(Math.random() * 2 ** 32);
+  }
+  return t;
+}
+async function ur(e) {
+  const t = e instanceof Uint8Array ? e : Pe.encode(e);
+  let r;
+  if (Li())
+    r = await new Promise(
+      (i, n) => Bo.deflate(t, (s, a) => s ? n(s) : i(a))
+    );
+  else {
+    if (typeof CompressionStream > "u")
+      try {
+        let s;
+        return e instanceof Uint8Array ? s = e : s = Pe.encode(e), r = Wt(s), Promise.resolve({
+          stream: r,
+          dict: { Length: r.length, Filter: "/FlateDecode" }
+        });
+      } catch (s) {
+        return O.warn(
+          `Failed to use JS deflate implementation, data will be written uncompressed: ${s}`
+        ), Promise.resolve({
+          stream: e,
+          dict: { Length: e.length }
+        });
+      }
+    const i = new CompressionStream("deflate"), n = new Blob([t]).stream().pipeThrough(i);
+    r = new Uint8Array(await new Response(n).arrayBuffer());
+  }
+  return {
+    dict: {
+      Length: r.length,
+      Filter: "/FlateDecode"
+    },
+    stream: r
+  };
+}
+const Wn = 2;
+class Tt {
+  constructor(t) {
+    v(this, "refObj");
+    this.refObj = t;
+  }
+}
+function M(e) {
+  const t = typeof e == "number" ? e : e.num;
+  return new Tt(t);
+}
+function Ad(e) {
+  for (let t = 0, r = e.length; t < r; t++)
+    if (e.charCodeAt(t) > 127)
+      return !0;
+  return !1;
+}
+function Ti(e, t = !0) {
+  const r = new Uint16Array(e.length + (t ? 1 : 0));
+  for (let n = t ? 1 : 0; n < r.length; n++)
+    r[n] = e.charCodeAt(n - (t ? 1 : 0));
+  const i = new Uint8Array(r.buffer, r.byteOffset, r.byteLength);
+  if (!_o)
+    for (let n = t ? 2 : 0, s = i.length - 1; n < s; n += 2) {
+      const a = i[n];
+      i[n] = i[n + 1], i[n + 1] = a;
+    }
+  return t && (i[0] = 254, i[1] = 255), i;
+}
+function _d(e) {
+  if (e > -1e21 && e < 1e21)
+    return Math.round(e * 1e6) / 1e6;
+  throw new Error(`unsupported number: ${e}`);
+}
+function Se(e, t = 0) {
+  if (typeof e == "string")
+    return e[0] === "(" && e[e.length - 1] === ")" && Ad(e) ? Se(Ti(e.substring(1, e.length - 1))) : e;
+  if (e instanceof Uint8Array)
+    return `<${Array.from(e).map((r) => r.toString(16).padStart(2, "0").toUpperCase()).join("")}>`;
+  if (e instanceof Date)
+    return `(${`D:${e.getUTCFullYear().toString(10).padStart(4, "0")}` + (e.getUTCMonth() + 1).toString(10).padStart(2, "0") + e.getUTCDate().toString(10).padStart(2, "0") + e.getUTCHours().toString(10).padStart(2, "0") + e.getUTCMinutes().toString(10).padStart(2, "0") + e.getUTCSeconds().toString(10).padStart(2, "0") + "Z"})`;
+  if (Array.isArray(e))
+    return `[${e.map((r) => Se(r, t + 1)).join(" ")}]`;
+  if (e instanceof Tt) {
+    if (e.refObj === -1)
+      throw new Error("Cannot serialize a deferred object reference");
+    return `${e.refObj} 0 R`;
+  } else if ({}.toString.call(e) === "[object Object]") {
+    const r = " ".repeat(Wn * t), i = r + " ".repeat(Wn);
+    return `<<
+${Object.entries(e).map(
+      ([n, s]) => `${i}/${n} ${Se(s, t + 1)}`
+    ).join(`
+`)}
+${r}>>`;
+  } else return typeof e == "number" ? _d(e).toString(10) : `${e}`;
+}
+class Od {
+  constructor(t) {
+    v(this, "_writer");
+    v(this, "bytesWritten", 0);
+    this._writer = t;
+  }
+  write(t) {
+    return this.bytesWritten += t.length, this._writer.write(t);
+  }
+  close() {
+    return this._writer.close();
+  }
+  waitForDrain() {
+    return this._writer.waitForDrain();
+  }
+}
+class kd {
+  constructor(t) {
+    v(this, "_writer");
+    this._writer = t.getWriter();
+  }
+  write(t) {
+    return this._writer.write(t);
+  }
+  waitForDrain() {
+    return this._writer.ready;
+  }
+  close() {
+    return this._writer.close();
+  }
+}
+class Un {
+  constructor() {
+    // TODO: A good reference seems to be the mega.nz implementation, which has always worked great for me on desktops at least:
+    // https://github.com/meganz/webclient/blob/f19289127b68ceaf19a5e884f2f48f15078304da/js/transfers/meths/memory.js
+    v(this, "_parts");
+    v(this, "_blob");
+    this._parts = [];
+  }
+  write(t) {
+    return this._blob ? Promise.reject("Cannot write to closed BlobWriter.") : (this._parts.push(t), Promise.resolve());
+  }
+  waitForDrain() {
+    return this._blob ? Promise.reject("Cannot wait on a closed BlobWriter.") : Promise.resolve();
+  }
+  close() {
+    return this._blob ? Promise.reject("BlobWriter is already closed") : (this._blob = new Blob(this._parts), this._parts = [], Promise.resolve());
+  }
+  get blob() {
+    if (!this._blob)
+      throw "BlobWriter must be closed first!";
+    return this._blob;
+  }
+}
+class Id {
+  constructor(t) {
+    v(this, "_writable");
+    v(this, "_drainWaiters", []);
+    this._writable = t, this._writable.on("drain", () => {
+      O.debug("Drained writer.");
+      for (const r of this._drainWaiters)
+        r();
+      this._drainWaiters = [];
+    }), this._writable.on("close", () => {
+      for (const r of this._drainWaiters)
+        r();
+      this._drainWaiters = [];
+    });
+  }
+  async write(t) {
+    let r = !1;
+    const i = new Promise((n, s) => {
+      this._writable.writable || s("Cannot write to closed NodeWriter."), r = !this._writable.write(
+        t,
+        (a) => a ? s(a) : n()
+      );
+    });
+    return r ? (O.debug("Waiting for writer to drain"), await this.waitForDrain()) : await i;
+  }
+  waitForDrain() {
+    return new Promise((t) => this._drainWaiters.push(t));
+  }
+  close() {
+    return new Promise((t) => this._writable.end(() => t()));
+  }
+}
+class Td {
+  constructor(t) {
+    v(this, "_buf");
+    this._buf = t;
+  }
+  read(t, r, i, n) {
+    const s = this._buf.subarray(i, i + n);
+    return t.set(s, r), Promise.resolve(s.length);
+  }
+  size() {
+    return Promise.resolve(this._buf.length);
+  }
+}
+const Ir = class Ir {
+  constructor(t) {
+    v(this, "palette");
+    v(this, "imgData");
+    v(this, "transparency");
+    v(this, "text");
+    v(this, "width");
+    v(this, "height");
+    v(this, "bits");
+    v(this, "colorType");
+    v(this, "compressionMethod");
+    v(this, "filterMethod");
+    v(this, "interlaceMethod");
+    v(this, "colors");
+    v(this, "hasAlphaChannel");
+    v(this, "pixelBitlength");
+    v(this, "colorSpace");
+    v(this, "data");
+    v(this, "pos");
+    v(this, "decode", () => {
+      const t = new Uint8Array(this.width * this.height * 4), r = this.decodePixels();
+      return this.copyImageDataToBuffer(t, r), t;
+    });
+    v(this, "copyImageDataToBuffer", (t, r) => {
+      let i = this.colors, n, s = this.hasAlphaChannel;
+      this.palette.length && (n = this.decodePalette(), i = 4, s = !0);
+      const a = t, o = a.length, c = n || r;
+      let h = 0, l = 0;
+      if (i === 1)
+        for (; h < o; ) {
+          let u = n ? r[h / 4] * 4 : l;
+          const f = c[u++];
+          a[h++] = f, a[h++] = f, a[h++] = f, a[h++] = s ? c[u++] : 255, l = u;
+        }
+      else
+        for (; h < o; ) {
+          let u = n ? r[h / 4] * 4 : l;
+          a[h++] = c[u++], a[h++] = c[u++], a[h++] = c[u++], a[h++] = s ? c[u++] : 255, l = u;
+        }
+    });
+    v(this, "decodePixels", () => {
+      const t = xd(this.imgData), r = this.width, i = this.height, n = this.pixelBitlength / 8, s = n * this.width, a = new Uint8Array(s * this.height), o = t.length;
+      let c = 0;
+      function h(l, u, f, p, d = !1) {
+        const m = Math.ceil((r - l) / f), g = Math.ceil((i - u) / p), y = n * m, b = d ? a : new Uint8Array(y * g);
+        let w = 0, F = 0;
+        for (; w < g && c < o; ) {
+          switch (t[c++]) {
+            case 0:
+              for (let x = 0; x < y; x++)
+                b[F++] = t[c++];
+              break;
+            case 1:
+              for (let x = 0; x < y; x++) {
+                const A = t[c++], I = x < n ? 0 : b[F - n];
+                b[F++] = (A + I) % 256;
+              }
+              break;
+            case 2:
+              for (let x = 0; x < y; x++) {
+                const A = t[c++], I = (x - x % n) / n, C = (w - 1) * y + I * n + x % n, S = w && b[C];
+                b[F++] = (S + A) % 256;
+              }
+              break;
+            case 3:
+              for (let x = 0; x < y; x++) {
+                const A = t[c++], I = (x - x % n) / n, C = x < n ? 0 : b[F - n], S = (w - 1) * y + I * n + x % n, E = w && b[S];
+                b[F++] = (A + Math.floor((C + E) / 2)) % 256;
+              }
+              break;
+            case 4:
+              for (let x = 0; x < y; x++) {
+                const A = t[c++], I = (x - x % n) / n, C = x < n ? 0 : b[F - n];
+                let S, E;
+                if (w === 0)
+                  S = E = 0;
+                else {
+                  const B = (w - 1) * y + I * n + x % n, D = (w - 1) * y + (I - 1) * n + x % n;
+                  S = b[B], E = I && b[D];
+                }
+                const _ = C + S - E, R = Math.abs(_ - C), V = Math.abs(_ - S), H = Math.abs(_ - E);
+                let z;
+                R <= V && R <= H ? z = C : V <= H ? z = S : z = E, b[F++] = (A + z) % 256;
+              }
+              break;
+            default:
+              throw new Error(`Invalid filter algorithm: ${t[c - 1]}`);
+          }
+          if (!d) {
+            let x = ((u + w * p) * r + l) * n, A = w * y;
+            for (let I = 0; I < m; I++) {
+              for (let C = 0; C < n; C++)
+                a[x++] = b[A++];
+              x += (f - 1) * n;
+            }
+          }
+          w++;
+        }
+      }
+      return this.interlaceMethod === 0 ? h(0, 0, 1, 1, !0) : (h(0, 0, 8, 8), h(4, 0, 8, 8), h(0, 4, 4, 8), h(2, 0, 4, 4), h(0, 2, 2, 4), h(1, 0, 2, 2), h(0, 1, 1, 2)), a;
+    });
+    v(this, "read", (t) => {
+      const r = [];
+      for (let i = 0; i < t; i++)
+        r[i] = this.data[this.pos++];
+      return r;
+    });
+    v(this, "readUInt32", () => {
+      const t = this.data[this.pos++] << 24, r = this.data[this.pos++] << 16, i = this.data[this.pos++] << 8, n = this.data[this.pos++];
+      return t | r | i | n;
+    });
+    v(this, "decodePalette", () => {
+      const t = this.palette, r = this.transparency.indexed || [], i = new Uint8Array(r.length + t.length);
+      let n = 0, s = 0;
+      for (let a = 0; a < t.length; a++) {
+        i[n++] = t[a], i[n++] = t[a + 1], i[n++] = t[a + 2];
+        const o = r[s++];
+        i[n++] = o !== void 0 ? o : 255;
+      }
+      return i;
+    });
+    this.data = t, this.pos = 8, this.palette = [];
+    const r = [];
+    for (this.transparency = {}, this.text = {}; ; ) {
+      const i = this.readUInt32();
+      let n = "";
+      for (let s = 0; s < 4; s++)
+        n += String.fromCharCode(this.data[this.pos++]);
+      switch (n) {
+        case "IHDR": {
+          this.width = this.readUInt32(), this.height = this.readUInt32(), this.bits = this.data[this.pos++], this.colorType = this.data[this.pos++], this.compressionMethod = this.data[this.pos++], this.filterMethod = this.data[this.pos++], this.interlaceMethod = this.data[this.pos++];
+          break;
+        }
+        case "PLTE": {
+          this.palette = this.read(i);
+          break;
+        }
+        case "IDAT": {
+          for (let s = 0; s < i; s++)
+            r.push(this.data[this.pos++]);
+          break;
+        }
+        case "tRNS": {
+          switch (this.transparency = {}, this.colorType) {
+            case 3: {
+              if (this.transparency.indexed = this.read(i), 255 - this.transparency.indexed.length > 0)
+                for (let a = 0; a < 255; a++)
+                  this.transparency.indexed.push(255);
+              break;
+            }
+            case 0: {
+              this.transparency.grayscale = this.read(i)[0];
+              break;
+            }
+            case 2: {
+              this.transparency.rgb = this.read(i);
+              break;
+            }
+          }
+          break;
+        }
+        case "tEXt": {
+          const s = this.read(i), a = s.indexOf(0), o = String.fromCharCode(...s.slice(0, a));
+          this.text[o] = String.fromCharCode(...s.slice(a + 1));
+          break;
+        }
+        case "IEND": {
+          const s = {
+            0: 1,
+            3: 1,
+            4: 1,
+            2: 3,
+            6: 3
+          };
+          this.colors = s[this.colorType], this.hasAlphaChannel = [4, 6].includes(this.colorType);
+          const a = this.colors + (this.hasAlphaChannel ? 1 : 0);
+          this.pixelBitlength = this.bits * a, this.colorSpace = {
+            1: "DeviceGray",
+            3: "DeviceRGB"
+          }[this.colors], this.imgData = new Uint8Array(r);
+          return;
+        }
+        default:
+          this.pos += i;
+      }
+      if (this.pos += 4, this.pos > this.data.length)
+        throw new Error("Incomplete or corrupt PNG file");
+    }
+  }
+};
+v(Ir, "load", (t) => new Ir(t));
+let Pi = Ir;
+function Nt(e, t = 0) {
+  const r = new Uint16Array(e.slice(t, t + 2).buffer)[0];
+  return _o ? r : (r & 255) << 8 | r >> 8 & 255;
+}
+class Xi {
+  static open(t) {
+    if (t.length > 2 && t[0] === 255 && t[1] === 216)
+      return new tr(t);
+    if (t.length > 8 && t[0] === 137 && t[1] === 80 && t[2] === 78 && t[3] === 71 && t[4] === 13 && t[5] === 10 && t[6] === 26 && t[7] === 10)
+      return new Pd(t);
+    throw new Error("Unknown image format.");
+  }
+}
+const mt = class mt extends Xi {
+  constructor(r) {
+    super();
+    v(this, "data");
+    v(this, "bits");
+    v(this, "width");
+    v(this, "height");
+    v(this, "colorSpace");
+    let i;
+    if (this.data = r, Nt(this.data, 0) !== 65496)
+      throw "SOI not found in JPEG";
+    let n = 2;
+    for (; n < this.data.length && (i = Nt(this.data, n), n += 2, !mt.MARKERS.includes(i)); )
+      n += Nt(this.data, n);
+    if (!i || !mt.MARKERS.includes(i))
+      throw "Invalid JPEG.";
+    n += 2, this.bits = this.data[n++], this.height = Nt(this.data, n), n += 2, this.width = Nt(this.data, n), n += 2;
+    const s = this.data[n++];
+    if ([1, 3, 4].indexOf(s) < 0)
+      throw "Bad number of channels, only 1, 3 or 4 are supported";
+    this.colorSpace = mt.COLOR_SPACE_MAP[s];
+  }
+  toObjects(r) {
+    const i = {
+      Type: "/XObject",
+      Subtype: "/Image",
+      BitsPerComponent: this.bits,
+      Width: this.width,
+      Height: this.height,
+      ColorSpace: `/${this.colorSpace}`,
+      Filter: "/DCTDecode",
+      Length: this.data.length
+    };
+    return this.colorSpace === "DeviceCMYK" && (i.Decode = [1, 0, 1, 0, 1, 0, 1, 0]), [{ num: r, data: Se(i), stream: this.data }];
+  }
+};
+v(mt, "MARKERS", [
+  65472,
+  65473,
+  65474,
+  65475,
+  65477,
+  65478,
+  65479,
+  65480,
+  65481,
+  65482,
+  65483,
+  65484,
+  65485,
+  65486,
+  65487
+]), v(mt, "COLOR_SPACE_MAP", {
+  1: "DeviceGray",
+  3: "DeviceRGB",
+  4: "DeviceCMYK"
+});
+let tr = mt;
+class Pd extends Xi {
+  constructor(r, i) {
+    super();
+    v(this, "label");
+    v(this, "image");
+    v(this, "width");
+    v(this, "height");
+    v(this, "imgData");
+    this.label = i, this.image = new Pi(r), this.width = this.image.width, this.height = this.image.height, this.imgData = this.image.imgData;
+  }
+  toObjects(r) {
+    let i = !1;
+    const n = this.image.hasAlphaChannel, s = this.image.interlaceMethod === 1, a = [];
+    let o = r;
+    const c = {
+      num: o++
+    };
+    a.push(c);
+    const h = {
+      Type: "/XObject",
+      Subtype: "/Image",
+      BitsPerComponent: n ? 8 : this.image.bits,
+      Width: this.width,
+      Height: this.height,
+      Filter: "/FlateDecode"
+    };
+    if (n || (h.DecodeParms = {
+      Predictor: s ? 1 : 15,
+      Colors: this.image.colors,
+      BitsPerComponent: this.image.bits,
+      Columns: this.width
+    }), this.image.palette.length === 0)
+      h.ColorSpace = `/${this.image.colorSpace}`;
+    else {
+      const l = {
+        num: o++,
+        data: Se({ Length: this.image.palette.length }),
+        stream: new Uint8Array(this.image.palette)
+      };
+      a.push(l), h.ColorSpace = [
+        "/Indexed",
+        "/DeviceRGB",
+        this.image.palette.length / 3 - 1,
+        M(l)
+      ];
+    }
+    if (this.image.transparency.grayscale != null) {
+      const l = this.image.transparency.grayscale;
+      h.Mask = [l, l];
+    } else if (this.image.transparency.rgb) {
+      const { rgb: l } = this.image.transparency, u = [];
+      for (let f of l)
+        u.push(f, f);
+      h.Mask = u;
+    } else if (this.image.transparency.indexed) {
+      const l = this.loadIndexedAlphaChannel(o++);
+      h.SMask = M(l), a.push(l), i = !0;
+    } else if (n) {
+      const [l, u] = this.splitAlphaChannel(o++);
+      c.stream = Wt(l), h.Length = c.stream.length, h.SMask = M(u), a.push(u);
+    }
+    if (s && !i && !c.stream ? (c.stream = Wt(this.image.decodePixels()), h.Length = c.stream.length) : c.stream || (c.stream = this.imgData, h.Length = c.stream.length), c.data = Se(h), a.length < 3)
+      for (let l = a.length; l < 3; l++)
+        a.push({ num: o++ });
+    return a;
+  }
+  splitAlphaChannel(r) {
+    const i = this.image.decodePixels(), n = this.image.colors, s = this.width * this.height, a = new Uint8Array(s * n), o = new Uint8Array(s);
+    let c = 0, h = 0, l = 0;
+    const u = i.length, f = this.image.bits === 16 ? 1 : 0;
+    for (; c < u; ) {
+      for (let d = 0; d < n; d++)
+        a[l++] = i[c++], c += f;
+      o[h++] = i[c++], c += f;
+    }
+    const p = Wt(o);
+    return [
+      a,
+      {
+        num: r,
+        data: Se({
+          Type: "/XObject",
+          Subtype: "/Image",
+          Width: this.width,
+          Height: this.height,
+          BitsPerComponent: 8,
+          Decode: [0, 1],
+          ColorSpace: "/DeviceGray",
+          Filter: "/FlateDecode",
+          Length: p.length
+        }),
+        stream: p
+      }
+    ];
+  }
+  loadIndexedAlphaChannel(r) {
+    const i = this.image.decodePixels(), n = this.image.transparency.indexed, s = new Uint8Array(this.width * this.height);
+    let a = 0;
+    for (let c = 0, h = i.length; c < h; c++)
+      s[a++] = n[i[c]];
+    const o = Wt(s);
+    return {
+      num: r,
+      data: Se({
+        Type: "/XObject",
+        Subtype: "/Image",
+        Width: this.width,
+        Height: this.height,
+        BitsPerComponent: 8,
+        Decode: [0, 1],
+        ColorSpace: "/DeviceGray",
+        Filter: "/FlateDecode",
+        Length: o.length
+      }),
+      stream: o
+    };
+  }
+}
+Uint8Array.prototype.findLastIndex || (Uint8Array.prototype.findLastIndex = function(e) {
+  let t = this.length;
+  for (; t--; )
+    if (e(this[t], t, this)) return t;
+  return -1;
+});
+const jd = {
+  n: `
+`,
+  r: "\r",
+  t: "	",
+  b: "\b",
+  f: "\f",
+  "(": "(",
+  ")": ")",
+  "\\": "\\"
+};
+async function* Oo(e, t, r) {
+  const i = new Uint8Array(r);
+  if (t += await e.read(i, 0, t, i.length), !Fe(i, 0, "xref"))
+    throw "Invalid crossreference section, did not start with `xref` line.";
+  const n = i.findIndex(
+    (u, f) => Fe(i, f, "trailer")
+  ), s = er.decode(i.subarray(0, n)).split(/[\r ]?\n/).slice(1);
+  let a;
+  for (const u of s)
+    if (u.length === 18) {
+      if (!a)
+        throw "Invalid crossreference section, entry outside of subsection.";
+      const f = u.trim().split(" ");
+      a.entries.push([
+        Number.parseInt(f[0], 10),
+        Number.parseInt(f[1], 10),
+        f[2] === "n"
+      ]);
+    } else {
+      if (a) {
+        if (a.numObjs !== a.entries.length)
+          throw `Invalid subsection, expected ${a.numObjs} objects, found ${a.entries.length}!`;
+        yield a, a = void 0;
+      }
+      if (u.length === 0 || u.indexOf("trailer") >= 0)
+        break;
+      const [f, p] = u.trimEnd().split(" ").map((d) => Number.parseInt(d, 10));
+      a = {
+        startNum: f,
+        numObjs: p,
+        entries: []
+      };
+    }
+  a && (yield a);
+  const o = i.subarray(n), c = o.findIndex(
+    (u, f) => Fe(o, f, "<<")
+  ), h = o.findIndex(
+    (u, f) => Fe(o, f, ">>")
+  ), l = new ji(
+    o.subarray(c, h + 2)
+  ).read();
+  if (l.Prev) {
+    const u = l.Prev;
+    yield* Oo(
+      e,
+      u,
+      t - u
+    );
+  }
+}
+function Fe(e, t, r, i = !1) {
+  if (i) {
+    for (let n = r.length - 1; n >= 0; n--)
+      if (e[t + n] !== r.charCodeAt(n))
+        return !1;
+  } else
+    for (let n = 0; n < r.length; n++)
+      if (e[t + n] !== r.charCodeAt(n))
+        return !1;
+  return !0;
+}
+function St(e) {
+  return !isNaN(parseInt(e, 10));
+}
+function fr(e) {
+  return e >= 48 && e <= 57 || e >= 65 && e <= 70 || e >= 97 && e <= 102;
+}
+class ji {
+  /** Construct a parser for a buffer containing one or more PDF values. */
+  constructor(t) {
+    v(this, "start", 0);
+    v(this, "current", 0);
+    v(this, "buf");
+    this.buf = t;
+  }
+  /** Get the buffer content at the current offset as a character. */
+  getChar() {
+    return String.fromCharCode(this.buf[this.current]);
+  }
+  /** Compares the buffer contents at the current offset against a string value. */
+  matchValue(t) {
+    return er.decode(
+      this.buf.subarray(
+        this.current,
+        this.current + Pe.encode(t).length
+      )
+    ) === t;
+  }
+  /** Checks if the buffer at the current offset contains a number.
+   *
+   * See ISO32000-2:2020 section 7.3.3.
+   */
+  matchInteger(t = !0) {
+    this.start = this.current;
+    let r, i = !0;
+    const n = [];
+    for (; !this.matchWhiteSpace(r = this.getChar()) && !this.matchDelimiter(r); ) {
+      if (r === "+" || r === "-") {
+        if (this.current - this.start > 0) {
+          i = !1;
+          break;
+        }
+      } else if (!St(r)) {
+        i = !1;
+        break;
+      }
+      this.current++, n.push(r);
+    }
+    return t && (this.current = this.start), i ? n.join("") : void 0;
+  }
+  /** Read a PDF value from the current offset, advancing the cursor. */
+  read() {
+    let t = this.getChar();
+    switch (this.matchWhiteSpace(t) && (this.skipWhiteSpace(), t = this.getChar()), this.getChar()) {
+      case "[":
+        return this.readArray();
+      case "<":
+        return this.matchValue("<<") ? this.readDict() : this.readHexString();
+      case "(":
+        return this.readLiteralString();
+      case "/":
+        return this.readName();
+      case "t":
+        if (this.matchValue("true"))
+          return this.current += 4, !0;
+        throw new Error("Unexpected character while parsing");
+      case "f":
+        if (this.matchValue("false"))
+          return this.current += 5, !1;
+        throw new Error("Unexpected character while parsing");
+      case "n":
+        if (this.matchValue("null"))
+          return this.current += 4, null;
+        throw new Error("Unexpected character while parsing");
+      case ".":
+        return this.readRealNumber();
+      default:
+        if (this.matchIndirectObject())
+          return this.readIndirectObject();
+        if (this.matchRealNumber())
+          return this.readRealNumber();
+        if (this.matchInteger())
+          return this.readInteger();
+        throw new Error(
+          `Encountered unexpected character during parsing: '${t}'`
+        );
+    }
+  }
+  /** Check if the input string contains PDF whitespace.
+   *
+   * See ISO32000-2:2020 section 7.2.3, Table 1.
+   */
+  matchWhiteSpace(t) {
+    return t === " " || t === "\0" || t === `
+` || t === "\r" || t === `\r
+` || t == "\f";
+  }
+  /** Read an integer from the current offset. */
+  readInteger() {
+    const t = this.matchInteger(!1);
+    if (t === void 0)
+      throw new Error("Failed to read integer.");
+    return Number.parseInt(t, 10);
+  }
+  /** Read an indirect object from the current offset. */
+  readIndirectObject() {
+    const t = this.matchIndirectObject(!1);
+    if (t === void 0)
+      throw new Error("Failed to read indirect object");
+    return new Tt(Number.parseInt(t.split(" ")[0]));
+  }
+  /** Check if the buffer contains an indirect object at the current offset.
+   *
+   * See ISO32000-2:2020 section 7.3.10.
+   */
+  matchIndirectObject(t = !0) {
+    this.start = this.current;
+    let r = this.getChar();
+    const i = [], n = () => {
+      if (!St(r))
+        return !1;
+      for (i.push(r), this.current++; St(r = this.getChar()); )
+        i.push(r), this.current++;
+      return !0;
+    }, s = () => this.skipWhiteSpace(), o = !n() || !s() || (i.push(" "), r = this.getChar(), !n()) || !s() || (i.push(" "), this.getChar() !== "R") ? !1 : (i.push("R"), this.current++, !0);
+    if (t && (this.current = this.start), o)
+      return i.join("");
+  }
+  /** Check if the buffer contains a real number at the current offset.
+   *
+   * See ISO32000-2:2020 section 7.3.3.
+   */
+  matchRealNumber(t = !0) {
+    this.start = this.current;
+    let r = !0, i = !1, n = !1;
+    const s = [];
+    let a;
+    for (; ; ) {
+      if (a = this.getChar(), a === ".") {
+        if (n) {
+          r = !1;
+          break;
+        }
+        n = !0;
+      } else if (St(a))
+        i = !0;
+      else if (a === "-" || a === "+") {
+        if (this.current - this.start > 0)
+          break;
+      } else
+        break;
+      s.push(a), this.current++;
+    }
+    if (t && (this.current = this.start), !!r && i && n)
+      return s.join("");
+  }
+  /** Read a real number from the current offset. */
+  readRealNumber() {
+    const t = this.matchRealNumber(!1);
+    if (!t)
+      throw new Error("Could not read real number.");
+    return Number.parseFloat(t);
+  }
+  /** Skip a contiguous sequence of whitespae, advancing the cursor. */
+  skipWhiteSpace() {
+    let t = !1;
+    for (; !this.atEnd() && this.matchWhiteSpace(this.getChar()); )
+      this.current++, t = !0;
+    return t;
+  }
+  /** Check if we're at the end of the buffer. */
+  atEnd() {
+    return this.current >= this.buf.length;
+  }
+  /** Read a name from the current offset.
+   *
+   * See ISO32000-2:2020 section 7.3.5.
+   */
+  readName() {
+    const t = ["/"];
+    this.current++;
+    let r;
+    for (; !this.matchWhiteSpace(r = this.getChar()) && !this.matchDelimiter(r); )
+      if (r === "#") {
+        const i = this.buf[this.current++], n = this.buf[this.current++];
+        if (!fr(i) || !fr(n))
+          throw new Error("Illegal character escape in name.");
+        t.push(
+          String.fromCharCode(
+            Number.parseInt(String.fromCharCode(i) + String.fromCharCode(n), 16)
+          )
+        );
+      } else
+        t.push(r), this.current++;
+    return t.join("");
+  }
+  /** Check if the current offset contains a delimiter.
+   *
+   * See ISO32000-2:2020 section 7.2.3, Table 2
+   */
+  matchDelimiter(t) {
+    return "[]{}()<>/%".indexOf(t) >= 0;
+  }
+  /** Read a hex string from the current offset.
+   *
+   * See ISO32000-2:2020 section 7.3.4.3
+   */
+  readHexString() {
+    this.current++;
+    const t = [];
+    for (; this.getChar() !== ">"; ) {
+      const r = this.buf[this.current++], i = this.buf[this.current++];
+      if (!fr(r) || !fr(i))
+        throw new Error(`Invalid value in hex string: '${r}${i}`);
+      t.push(
+        Number.parseInt(String.fromCharCode(r) + String.fromCharCode(i), 16)
+      );
+    }
+    return this.current++, new Uint8Array(t);
+  }
+  /** Read a literal string from the current offset.
+   *
+   * See ISO32000-2:2020 section 7.3.4.2
+   */
+  readLiteralString() {
+    this.current++;
+    const t = [];
+    let r = 0, i;
+    for (; ; ) {
+      if (i = this.getChar(), i === "\\") {
+        if (this.current++, i = this.getChar(), St(i)) {
+          let n = [i];
+          for (this.current++; St(this.getChar()); )
+            n.push(this.getChar()), this.current++;
+          n.length > 3 && (this.current -= n.length - 3, n = n.slice(0, 3)), this.current--, i = String.fromCharCode(Number.parseInt(n.join(""), 8));
+        } else if (i = jd[i], i === void 0)
+          throw new Error(
+            `Illegal escape sequence in string literal: '\\${i}`
+          );
+      } else if (i === "(")
+        r++;
+      else if (i === ")" && (r--, r < 0))
+        return this.current++, t.join("");
+      t.push(i), this.current++;
+    }
+  }
+  /** Read a dictionary from the current offset.
+   *
+   * See ISO32000-2:2020 section 7.3.7
+   */
+  readDict() {
+    this.current += 2;
+    const t = {};
+    for (this.skipWhiteSpace(); this.getChar() !== ">"; ) {
+      const r = this.read();
+      if (typeof r != "string" || !r.startsWith("/"))
+        throw new Error(`Dictionary keys must be name objects, got '${r}`);
+      this.skipWhiteSpace();
+      const i = this.read();
+      i !== null && (t[r.substring(1)] = i), this.skipWhiteSpace();
+    }
+    return this.current += 2, t;
+  }
+  /** Read an array from the current offset.
+   *
+   * See ISO32000-2:2020 section 7.3.6
+   */
+  readArray() {
+    this.current++;
+    const t = [];
+    for (; this.getChar() !== "]"; )
+      t.push(this.read()), this.skipWhiteSpace();
+    return this.current++, t;
+  }
+}
+class Ki {
+  /** Private constructor, use factory method above. */
+  constructor(t, r, i, n) {
+    v(this, "reader");
+    v(this, "objectOffsets");
+    v(this, "sortedOffsets");
+    v(this, "pdfSize");
+    v(this, "objGenerations");
+    v(this, "infoNum");
+    v(this, "catalogNum");
+    this.reader = t, this.objectOffsets = r, this.sortedOffsets = [...r].sort((s, a) => s - a), this.objGenerations = i, this.catalogNum = n.Root.refObj, this.infoNum = n.Info.refObj;
+  }
+  /** Construct a new parser from a Reader.
+   *
+   * Used instead of the constructor to allow for async initialization.
+   */
+  static async parse(t) {
+    const r = new Uint8Array(1024), n = await t.size() - r.length;
+    await t.read(r, 0, n, r.length);
+    const s = r.length - (r[r.length - 1] === 70 ? 5 : 6);
+    if (!Fe(r, s, "%%EOF"))
+      throw "Invalid PDF, missing EOF comment at end of file";
+    const a = r.findLastIndex(
+      (p, d) => Fe(r, d, "startxref")
+    );
+    if (a < 0)
+      throw "Invalid PDF, missing startxref marker in file trailer.";
+    const o = [], c = [], h = Number.parseInt(
+      er.decode(r.subarray(a + 9, s)).trim(),
+      10
+    ), l = r.findLastIndex(
+      (p, d) => Fe(r, d, ">>")
+    ) + 2, u = r.findLastIndex(
+      (p, d) => Fe(r, d, "<<")
+    ), f = new ji(
+      r.subarray(u, l)
+    ).read();
+    for await (const { startNum: p, entries: d } of Oo(
+      t,
+      h,
+      n + l - h
+    ))
+      for (const [m, [g, y, b]] of d.entries()) {
+        const w = m + p;
+        (o[w] ?? -1) > y || (o[w] = y, b ? c[w] = g : c[w] = -1);
+      }
+    if (c.length !== f.Size)
+      throw `Trailer dictionary has different number of objects than crossreference tables, ${c.length} vs. ${f.Size}`;
+    return new Ki(t, c, o, f);
+  }
+  /** Retrieve the catalog dictionary. */
+  async catalog() {
+    const t = await this.getObject(this.catalogNum);
+    if (!t)
+      throw `Document has no catalog object (num as per trailer: ${this.catalogNum}!`;
+    return t.data;
+  }
+  /** Retrieve the info dictionary. */
+  async info() {
+    const t = await this.getObject(this.infoNum);
+    if (!t)
+      throw `Document has no info object (num as per trailer: ${this.infoNum}!`;
+    return t.data;
+  }
+  /** Yield all pages referenced in the given page dictionary. */
+  async *_pagesFromPagesObj(t) {
+    for (const r of t.Kids) {
+      const i = await this.getObject(r.refObj, !0);
+      if (!i)
+        throw `Could not find Page object with number ${r.refObj}`;
+      const n = i.data;
+      n.Type === "/Pages" ? yield* this._pagesFromPagesObj(n) : yield i;
+    }
+  }
+  /** Yield all pages in the PDF. */
+  async *pages() {
+    const r = (await this.catalog()).Pages, i = await this.getObject(r.refObj);
+    if (!i)
+      throw `Could not find Pages object with number ${r.refObj}`;
+    const n = i.data;
+    yield* this._pagesFromPagesObj(n);
+  }
+  /** Yield all annotations for the given page dictionary. */
+  async *annotations(t) {
+    const r = t.Annots;
+    if (r)
+      for (const i of r) {
+        const n = await this.getObject(i.refObj);
+        if (!n)
+          throw `Could not find Annotation object with number ${i.refObj}`;
+        yield n.data;
+      }
+  }
+  /** Resolve a PDF reference to the corresponding object. */
+  resolveRef(t) {
+    return this.getObject(t.refObj, !0);
+  }
+  /** Get an object from the PDF from its number. */
+  async getObject(t, r = !1) {
+    const i = this.objectOffsets[t];
+    if (!i)
+      return;
+    this.pdfSize || (this.pdfSize = await this.reader.size());
+    const n = this.sortedOffsets[this.sortedOffsets.indexOf(i) + 1] ?? this.pdfSize, s = new Uint8Array(n - i);
+    await this.reader.read(s, 0, i, s.length);
+    const a = s.findIndex(
+      (f, p) => Fe(s, p, "endobj")
+    );
+    let o = s.findIndex(
+      (f, p) => Fe(s, p, "stream")
+    );
+    o >= 0 && (o += 6, s[o] === 13 ? o += 2 : o += 1);
+    const c = `${t} ${this.objGenerations[t]} obj`, l = new ji(
+      s.subarray(c.length, o < 0 ? a : o)
+    ).read();
+    if (typeof l != "object" || l === null)
+      throw new Error("Illegal PDF object, does not start with a dictionary.");
+    let u;
+    if (r && o > 0) {
+      const f = l.Length;
+      if (f === void 0)
+        throw new Error(
+          "Illegal stream object, missing Length entry in object dictionary."
+        );
+      u = s.subarray(o, o + f);
+    }
+    return {
+      num: t,
+      data: l,
+      stream: u
+    };
+  }
+}
+const ko = "0.2.6";
+function $d({
+  creationDate: e = /* @__PURE__ */ new Date(),
+  filename: t,
+  data: r,
+  compressedData: i,
+  extraDataLength: n
+}) {
+  const s = e.getHours() << 11 | e.getDay() << 5 | Math.round(e.getSeconds() / 2), a = e.getFullYear() - 1980 << 9 | e.getMonth() + 1 << 5 | e.getDate(), o = rs(r), c = Pe.encode(t), h = i ? i.length - 2 : r.length;
+  return new Uint8Array([
+    // PKZIP magic number
+    80,
+    75,
+    // Local File Header magic
+    3,
+    4,
+    // Required PKZip version
+    20,
+    0,
+    // General purpose bit flag, 2 bytes
+    0,
+    0,
+    // Compression method, 2 bytes little endian
+    i ? 8 : 0,
+    0,
+    // Creation time, 2 bytes little endian
+    s & 255,
+    s >> 8,
+    // Creation date, 2 bytes little endian
+    a & 255,
+    a >> 8,
+    // CRC32 of data, 4 bytes little endian
+    o & 255,
+    o >> 8 & 255,
+    o >> 16 & 255,
+    o >> 24 & 255,
+    // Compressed size, 4 bytes little endian
+    h & 255,
+    h >> 8 & 255,
+    h >> 16 & 255,
+    h >> 24 & 255,
+    // Uncompressed size, 4 bytes little endian
+    r.length & 255,
+    r.length >> 8 & 255,
+    r.length >> 16 & 255,
+    r.length >> 24 & 255,
+    // Filename length, 2 bytes little endian
+    c.length & 255,
+    c.length >> 8,
+    // Filename length in little endian
+    // Extra field length, 2 bytes little endian
+    n + 4 & 255,
+    n + 4 >> 8,
+    // Encoded file name
+    ...c,
+    // Beginning of extra field: identifier, 2 bytes
+    255,
+    255,
+    // Beginning of extra field: length, 2 bytes little endian
+    n & 255,
+    n >> 8
+  ]);
+}
+function Fd({
+  files: e,
+  trailingLength: t,
+  offset: r
+}) {
+  const i = e.map(Ed), n = i.reduce((s, a) => s + a.length, 0);
+  return i.push(new Uint8Array([
+    // PKZIP magic number
+    80,
+    75,
+    // End of central directory magic
+    5,
+    6,
+    // Disk number
+    0,
+    0,
+    // Disk with central directory
+    0,
+    0,
+    // Disk entries
+    e.length & 255,
+    e.length >> 8,
+    // Total entries
+    e.length & 255,
+    e.length >> 8,
+    // Central directory size,
+    n & 255,
+    n >> 8 & 255,
+    n >> 16 & 255,
+    n >> 24 & 255,
+    // Offset of central directory in file
+    r & 255,
+    r >> 8 & 255,
+    r >> 16 & 255,
+    r >> 24 & 255,
+    // Length of trailing comment
+    t & 255,
+    t >> 8
+  ])), new Uint8Array(
+    i.reduce((s, a) => (s.push(...a), s), [])
+  );
+}
+function Ed(e) {
+  const t = e.creationDate.getHours() << 11 | e.creationDate.getMinutes() << 5 | Math.round(e.creationDate.getSeconds() / 2), r = e.creationDate.getFullYear() - 1980 << 9 | e.creationDate.getMonth() + 1 << 5 | e.creationDate.getDate(), i = Pe.encode(e.filename);
+  return new Uint8Array([
+    // PKZIP magic number
+    80,
+    75,
+    // Central directory file header magic
+    1,
+    2,
+    // Version
+    23,
+    3,
+    //  Version needed
+    20,
+    0,
+    // Flags, none set
+    0,
+    0,
+    // Compression method, 2 bytes little endian
+    e.deflated ? 8 : 0,
+    0,
+    // Creation time, 2 bytes little endian
+    t & 255,
+    t >> 8,
+    // Creation date, 2 bytes little endian
+    r & 255,
+    r >> 8,
+    // CRC32 of data, 4 bytes little endian
+    e.crc32 & 255,
+    e.crc32 >> 8 & 255,
+    e.crc32 >> 16 & 255,
+    e.crc32 >> 24 & 255,
+    // Compressed size, 4 bytes little endian
+    e.compressedDataLength & 255,
+    e.compressedDataLength >> 8 & 255,
+    e.compressedDataLength >> 16 & 255,
+    e.compressedDataLength >> 24 & 255,
+    // Uncompressed size, 4 bytes little endian
+    e.dataLength & 255,
+    e.dataLength >> 8 & 255,
+    e.dataLength >> 16 & 255,
+    e.dataLength >> 24 & 255,
+    // Filename length, 2 bytes little endian
+    i.length & 255,
+    i.length >> 8,
+    // Filename length in little endian
+    // Extra field length, 2 bytes little endian
+    0,
+    0,
+    // File comment length, 2 bytes little endian
+    0,
+    0,
+    // Disk # start, 2 bytes little endian
+    0,
+    0,
+    // Internal Attribute, 2 bytes little endian
+    0,
+    0,
+    // External Attribute, 4 bytes little endian
+    0,
+    0,
+    164,
+    129,
+    // Offset of local header, 4 bytes little endian
+    e.localHeaderOffset & 255,
+    e.localHeaderOffset >> 8 & 255,
+    e.localHeaderOffset >> 16 & 255,
+    e.localHeaderOffset >> 24 & 255,
+    ...i
+  ]);
+}
+var Io = { exports: {} }, To = {
+  aliceblue: [240, 248, 255],
+  antiquewhite: [250, 235, 215],
+  aqua: [0, 255, 255],
+  aquamarine: [127, 255, 212],
+  azure: [240, 255, 255],
+  beige: [245, 245, 220],
+  bisque: [255, 228, 196],
+  black: [0, 0, 0],
+  blanchedalmond: [255, 235, 205],
+  blue: [0, 0, 255],
+  blueviolet: [138, 43, 226],
+  brown: [165, 42, 42],
+  burlywood: [222, 184, 135],
+  cadetblue: [95, 158, 160],
+  chartreuse: [127, 255, 0],
+  chocolate: [210, 105, 30],
+  coral: [255, 127, 80],
+  cornflowerblue: [100, 149, 237],
+  cornsilk: [255, 248, 220],
+  crimson: [220, 20, 60],
+  cyan: [0, 255, 255],
+  darkblue: [0, 0, 139],
+  darkcyan: [0, 139, 139],
+  darkgoldenrod: [184, 134, 11],
+  darkgray: [169, 169, 169],
+  darkgreen: [0, 100, 0],
+  darkgrey: [169, 169, 169],
+  darkkhaki: [189, 183, 107],
+  darkmagenta: [139, 0, 139],
+  darkolivegreen: [85, 107, 47],
+  darkorange: [255, 140, 0],
+  darkorchid: [153, 50, 204],
+  darkred: [139, 0, 0],
+  darksalmon: [233, 150, 122],
+  darkseagreen: [143, 188, 143],
+  darkslateblue: [72, 61, 139],
+  darkslategray: [47, 79, 79],
+  darkslategrey: [47, 79, 79],
+  darkturquoise: [0, 206, 209],
+  darkviolet: [148, 0, 211],
+  deeppink: [255, 20, 147],
+  deepskyblue: [0, 191, 255],
+  dimgray: [105, 105, 105],
+  dimgrey: [105, 105, 105],
+  dodgerblue: [30, 144, 255],
+  firebrick: [178, 34, 34],
+  floralwhite: [255, 250, 240],
+  forestgreen: [34, 139, 34],
+  fuchsia: [255, 0, 255],
+  gainsboro: [220, 220, 220],
+  ghostwhite: [248, 248, 255],
+  gold: [255, 215, 0],
+  goldenrod: [218, 165, 32],
+  gray: [128, 128, 128],
+  green: [0, 128, 0],
+  greenyellow: [173, 255, 47],
+  grey: [128, 128, 128],
+  honeydew: [240, 255, 240],
+  hotpink: [255, 105, 180],
+  indianred: [205, 92, 92],
+  indigo: [75, 0, 130],
+  ivory: [255, 255, 240],
+  khaki: [240, 230, 140],
+  lavender: [230, 230, 250],
+  lavenderblush: [255, 240, 245],
+  lawngreen: [124, 252, 0],
+  lemonchiffon: [255, 250, 205],
+  lightblue: [173, 216, 230],
+  lightcoral: [240, 128, 128],
+  lightcyan: [224, 255, 255],
+  lightgoldenrodyellow: [250, 250, 210],
+  lightgray: [211, 211, 211],
+  lightgreen: [144, 238, 144],
+  lightgrey: [211, 211, 211],
+  lightpink: [255, 182, 193],
+  lightsalmon: [255, 160, 122],
+  lightseagreen: [32, 178, 170],
+  lightskyblue: [135, 206, 250],
+  lightslategray: [119, 136, 153],
+  lightslategrey: [119, 136, 153],
+  lightsteelblue: [176, 196, 222],
+  lightyellow: [255, 255, 224],
+  lime: [0, 255, 0],
+  limegreen: [50, 205, 50],
+  linen: [250, 240, 230],
+  magenta: [255, 0, 255],
+  maroon: [128, 0, 0],
+  mediumaquamarine: [102, 205, 170],
+  mediumblue: [0, 0, 205],
+  mediumorchid: [186, 85, 211],
+  mediumpurple: [147, 112, 219],
+  mediumseagreen: [60, 179, 113],
+  mediumslateblue: [123, 104, 238],
+  mediumspringgreen: [0, 250, 154],
+  mediumturquoise: [72, 209, 204],
+  mediumvioletred: [199, 21, 133],
+  midnightblue: [25, 25, 112],
+  mintcream: [245, 255, 250],
+  mistyrose: [255, 228, 225],
+  moccasin: [255, 228, 181],
+  navajowhite: [255, 222, 173],
+  navy: [0, 0, 128],
+  oldlace: [253, 245, 230],
+  olive: [128, 128, 0],
+  olivedrab: [107, 142, 35],
+  orange: [255, 165, 0],
+  orangered: [255, 69, 0],
+  orchid: [218, 112, 214],
+  palegoldenrod: [238, 232, 170],
+  palegreen: [152, 251, 152],
+  paleturquoise: [175, 238, 238],
+  palevioletred: [219, 112, 147],
+  papayawhip: [255, 239, 213],
+  peachpuff: [255, 218, 185],
+  peru: [205, 133, 63],
+  pink: [255, 192, 203],
+  plum: [221, 160, 221],
+  powderblue: [176, 224, 230],
+  purple: [128, 0, 128],
+  rebeccapurple: [102, 51, 153],
+  red: [255, 0, 0],
+  rosybrown: [188, 143, 143],
+  royalblue: [65, 105, 225],
+  saddlebrown: [139, 69, 19],
+  salmon: [250, 128, 114],
+  sandybrown: [244, 164, 96],
+  seagreen: [46, 139, 87],
+  seashell: [255, 245, 238],
+  sienna: [160, 82, 45],
+  silver: [192, 192, 192],
+  skyblue: [135, 206, 235],
+  slateblue: [106, 90, 205],
+  slategray: [112, 128, 144],
+  slategrey: [112, 128, 144],
+  snow: [255, 250, 250],
+  springgreen: [0, 255, 127],
+  steelblue: [70, 130, 180],
+  tan: [210, 180, 140],
+  teal: [0, 128, 128],
+  thistle: [216, 191, 216],
+  tomato: [255, 99, 71],
+  turquoise: [64, 224, 208],
+  violet: [238, 130, 238],
+  wheat: [245, 222, 179],
+  white: [255, 255, 255],
+  whitesmoke: [245, 245, 245],
+  yellow: [255, 255, 0],
+  yellowgreen: [154, 205, 50]
+}, Po = { exports: {} }, Rd = function(t) {
+  return !t || typeof t == "string" ? !1 : t instanceof Array || Array.isArray(t) || t.length >= 0 && (t.splice instanceof Function || Object.getOwnPropertyDescriptor(t, t.length - 1) && t.constructor.name !== "String");
+}, Md = Rd, Nd = Array.prototype.concat, Dd = Array.prototype.slice, zn = Po.exports = function(t) {
+  for (var r = [], i = 0, n = t.length; i < n; i++) {
+    var s = t[i];
+    Md(s) ? r = Nd.call(r, Dd.call(s)) : r.push(s);
+  }
+  return r;
+};
+zn.wrap = function(e) {
+  return function() {
+    return e(zn(arguments));
+  };
+};
+var Ld = Po.exports, Jt = To, nr = Ld, jo = Object.hasOwnProperty, $o = /* @__PURE__ */ Object.create(null);
+for (var ni in Jt)
+  jo.call(Jt, ni) && ($o[Jt[ni]] = ni);
+var ye = Io.exports = {
+  to: {},
+  get: {}
+};
+ye.get = function(e) {
+  var t = e.substring(0, 3).toLowerCase(), r, i;
+  switch (t) {
+    case "hsl":
+      r = ye.get.hsl(e), i = "hsl";
+      break;
+    case "hwb":
+      r = ye.get.hwb(e), i = "hwb";
+      break;
+    default:
+      r = ye.get.rgb(e), i = "rgb";
+      break;
+  }
+  return r ? { model: i, value: r } : null;
+};
+ye.get.rgb = function(e) {
+  if (!e)
+    return null;
+  var t = /^#([a-f0-9]{3,4})$/i, r = /^#([a-f0-9]{6})([a-f0-9]{2})?$/i, i = /^rgba?\(\s*([+-]?\d+)(?=[\s,])\s*(?:,\s*)?([+-]?\d+)(?=[\s,])\s*(?:,\s*)?([+-]?\d+)\s*(?:[,|\/]\s*([+-]?[\d\.]+)(%?)\s*)?\)$/, n = /^rgba?\(\s*([+-]?[\d\.]+)\%\s*,?\s*([+-]?[\d\.]+)\%\s*,?\s*([+-]?[\d\.]+)\%\s*(?:[,|\/]\s*([+-]?[\d\.]+)(%?)\s*)?\)$/, s = /^(\w+)$/, a = [0, 0, 0, 1], o, c, h;
+  if (o = e.match(r)) {
+    for (h = o[2], o = o[1], c = 0; c < 3; c++) {
+      var l = c * 2;
+      a[c] = parseInt(o.slice(l, l + 2), 16);
+    }
+    h && (a[3] = parseInt(h, 16) / 255);
+  } else if (o = e.match(t)) {
+    for (o = o[1], h = o[3], c = 0; c < 3; c++)
+      a[c] = parseInt(o[c] + o[c], 16);
+    h && (a[3] = parseInt(h + h, 16) / 255);
+  } else if (o = e.match(i)) {
+    for (c = 0; c < 3; c++)
+      a[c] = parseInt(o[c + 1], 0);
+    o[4] && (o[5] ? a[3] = parseFloat(o[4]) * 0.01 : a[3] = parseFloat(o[4]));
+  } else if (o = e.match(n)) {
+    for (c = 0; c < 3; c++)
+      a[c] = Math.round(parseFloat(o[c + 1]) * 2.55);
+    o[4] && (o[5] ? a[3] = parseFloat(o[4]) * 0.01 : a[3] = parseFloat(o[4]));
+  } else return (o = e.match(s)) ? o[1] === "transparent" ? [0, 0, 0, 0] : jo.call(Jt, o[1]) ? (a = Jt[o[1]], a[3] = 1, a) : null : null;
+  for (c = 0; c < 3; c++)
+    a[c] = tt(a[c], 0, 255);
+  return a[3] = tt(a[3], 0, 1), a;
+};
+ye.get.hsl = function(e) {
+  if (!e)
+    return null;
+  var t = /^hsla?\(\s*([+-]?(?:\d{0,3}\.)?\d+)(?:deg)?\s*,?\s*([+-]?[\d\.]+)%\s*,?\s*([+-]?[\d\.]+)%\s*(?:[,|\/]\s*([+-]?(?=\.\d|\d)(?:0|[1-9]\d*)?(?:\.\d*)?(?:[eE][+-]?\d+)?)\s*)?\)$/, r = e.match(t);
+  if (r) {
+    var i = parseFloat(r[4]), n = (parseFloat(r[1]) % 360 + 360) % 360, s = tt(parseFloat(r[2]), 0, 100), a = tt(parseFloat(r[3]), 0, 100), o = tt(isNaN(i) ? 1 : i, 0, 1);
+    return [n, s, a, o];
+  }
+  return null;
+};
+ye.get.hwb = function(e) {
+  if (!e)
+    return null;
+  var t = /^hwb\(\s*([+-]?\d{0,3}(?:\.\d+)?)(?:deg)?\s*,\s*([+-]?[\d\.]+)%\s*,\s*([+-]?[\d\.]+)%\s*(?:,\s*([+-]?(?=\.\d|\d)(?:0|[1-9]\d*)?(?:\.\d*)?(?:[eE][+-]?\d+)?)\s*)?\)$/, r = e.match(t);
+  if (r) {
+    var i = parseFloat(r[4]), n = (parseFloat(r[1]) % 360 + 360) % 360, s = tt(parseFloat(r[2]), 0, 100), a = tt(parseFloat(r[3]), 0, 100), o = tt(isNaN(i) ? 1 : i, 0, 1);
+    return [n, s, a, o];
+  }
+  return null;
+};
+ye.to.hex = function() {
+  var e = nr(arguments);
+  return "#" + dr(e[0]) + dr(e[1]) + dr(e[2]) + (e[3] < 1 ? dr(Math.round(e[3] * 255)) : "");
+};
+ye.to.rgb = function() {
+  var e = nr(arguments);
+  return e.length < 4 || e[3] === 1 ? "rgb(" + Math.round(e[0]) + ", " + Math.round(e[1]) + ", " + Math.round(e[2]) + ")" : "rgba(" + Math.round(e[0]) + ", " + Math.round(e[1]) + ", " + Math.round(e[2]) + ", " + e[3] + ")";
+};
+ye.to.rgb.percent = function() {
+  var e = nr(arguments), t = Math.round(e[0] / 255 * 100), r = Math.round(e[1] / 255 * 100), i = Math.round(e[2] / 255 * 100);
+  return e.length < 4 || e[3] === 1 ? "rgb(" + t + "%, " + r + "%, " + i + "%)" : "rgba(" + t + "%, " + r + "%, " + i + "%, " + e[3] + ")";
+};
+ye.to.hsl = function() {
+  var e = nr(arguments);
+  return e.length < 4 || e[3] === 1 ? "hsl(" + e[0] + ", " + e[1] + "%, " + e[2] + "%)" : "hsla(" + e[0] + ", " + e[1] + "%, " + e[2] + "%, " + e[3] + ")";
+};
+ye.to.hwb = function() {
+  var e = nr(arguments), t = "";
+  return e.length >= 4 && e[3] !== 1 && (t = ", " + e[3]), "hwb(" + e[0] + ", " + e[1] + "%, " + e[2] + "%" + t + ")";
+};
+ye.to.keyword = function(e) {
+  return $o[e.slice(0, 3)];
+};
+function tt(e, t, r) {
+  return Math.min(Math.max(t, e), r);
+}
+function dr(e) {
+  var t = Math.round(e).toString(16).toUpperCase();
+  return t.length < 2 ? "0" + t : t;
+}
+var Wd = Io.exports;
+const rr = To, Fo = {};
+for (const e of Object.keys(rr))
+  Fo[rr[e]] = e;
+const P = {
+  rgb: { channels: 3, labels: "rgb" },
+  hsl: { channels: 3, labels: "hsl" },
+  hsv: { channels: 3, labels: "hsv" },
+  hwb: { channels: 3, labels: "hwb" },
+  cmyk: { channels: 4, labels: "cmyk" },
+  xyz: { channels: 3, labels: "xyz" },
+  lab: { channels: 3, labels: "lab" },
+  lch: { channels: 3, labels: "lch" },
+  hex: { channels: 1, labels: ["hex"] },
+  keyword: { channels: 1, labels: ["keyword"] },
+  ansi16: { channels: 1, labels: ["ansi16"] },
+  ansi256: { channels: 1, labels: ["ansi256"] },
+  hcg: { channels: 3, labels: ["h", "c", "g"] },
+  apple: { channels: 3, labels: ["r16", "g16", "b16"] },
+  gray: { channels: 1, labels: ["gray"] }
+};
+var Eo = P;
+for (const e of Object.keys(P)) {
+  if (!("channels" in P[e]))
+    throw new Error("missing channels property: " + e);
+  if (!("labels" in P[e]))
+    throw new Error("missing channel labels property: " + e);
+  if (P[e].labels.length !== P[e].channels)
+    throw new Error("channel and label counts mismatch: " + e);
+  const { channels: t, labels: r } = P[e];
+  delete P[e].channels, delete P[e].labels, Object.defineProperty(P[e], "channels", { value: t }), Object.defineProperty(P[e], "labels", { value: r });
+}
+P.rgb.hsl = function(e) {
+  const t = e[0] / 255, r = e[1] / 255, i = e[2] / 255, n = Math.min(t, r, i), s = Math.max(t, r, i), a = s - n;
+  let o, c;
+  s === n ? o = 0 : t === s ? o = (r - i) / a : r === s ? o = 2 + (i - t) / a : i === s && (o = 4 + (t - r) / a), o = Math.min(o * 60, 360), o < 0 && (o += 360);
+  const h = (n + s) / 2;
+  return s === n ? c = 0 : h <= 0.5 ? c = a / (s + n) : c = a / (2 - s - n), [o, c * 100, h * 100];
+};
+P.rgb.hsv = function(e) {
+  let t, r, i, n, s;
+  const a = e[0] / 255, o = e[1] / 255, c = e[2] / 255, h = Math.max(a, o, c), l = h - Math.min(a, o, c), u = function(f) {
+    return (h - f) / 6 / l + 1 / 2;
+  };
+  return l === 0 ? (n = 0, s = 0) : (s = l / h, t = u(a), r = u(o), i = u(c), a === h ? n = i - r : o === h ? n = 1 / 3 + t - i : c === h && (n = 2 / 3 + r - t), n < 0 ? n += 1 : n > 1 && (n -= 1)), [
+    n * 360,
+    s * 100,
+    h * 100
+  ];
+};
+P.rgb.hwb = function(e) {
+  const t = e[0], r = e[1];
+  let i = e[2];
+  const n = P.rgb.hsl(e)[0], s = 1 / 255 * Math.min(t, Math.min(r, i));
+  return i = 1 - 1 / 255 * Math.max(t, Math.max(r, i)), [n, s * 100, i * 100];
+};
+P.rgb.cmyk = function(e) {
+  const t = e[0] / 255, r = e[1] / 255, i = e[2] / 255, n = Math.min(1 - t, 1 - r, 1 - i), s = (1 - t - n) / (1 - n) || 0, a = (1 - r - n) / (1 - n) || 0, o = (1 - i - n) / (1 - n) || 0;
+  return [s * 100, a * 100, o * 100, n * 100];
+};
+function Ud(e, t) {
+  return (e[0] - t[0]) ** 2 + (e[1] - t[1]) ** 2 + (e[2] - t[2]) ** 2;
+}
+P.rgb.keyword = function(e) {
+  const t = Fo[e];
+  if (t)
+    return t;
+  let r = 1 / 0, i;
+  for (const n of Object.keys(rr)) {
+    const s = rr[n], a = Ud(e, s);
+    a < r && (r = a, i = n);
+  }
+  return i;
+};
+P.keyword.rgb = function(e) {
+  return rr[e];
+};
+P.rgb.xyz = function(e) {
+  let t = e[0] / 255, r = e[1] / 255, i = e[2] / 255;
+  t = t > 0.04045 ? ((t + 0.055) / 1.055) ** 2.4 : t / 12.92, r = r > 0.04045 ? ((r + 0.055) / 1.055) ** 2.4 : r / 12.92, i = i > 0.04045 ? ((i + 0.055) / 1.055) ** 2.4 : i / 12.92;
+  const n = t * 0.4124 + r * 0.3576 + i * 0.1805, s = t * 0.2126 + r * 0.7152 + i * 0.0722, a = t * 0.0193 + r * 0.1192 + i * 0.9505;
+  return [n * 100, s * 100, a * 100];
+};
+P.rgb.lab = function(e) {
+  const t = P.rgb.xyz(e);
+  let r = t[0], i = t[1], n = t[2];
+  r /= 95.047, i /= 100, n /= 108.883, r = r > 8856e-6 ? r ** (1 / 3) : 7.787 * r + 16 / 116, i = i > 8856e-6 ? i ** (1 / 3) : 7.787 * i + 16 / 116, n = n > 8856e-6 ? n ** (1 / 3) : 7.787 * n + 16 / 116;
+  const s = 116 * i - 16, a = 500 * (r - i), o = 200 * (i - n);
+  return [s, a, o];
+};
+P.hsl.rgb = function(e) {
+  const t = e[0] / 360, r = e[1] / 100, i = e[2] / 100;
+  let n, s, a;
+  if (r === 0)
+    return a = i * 255, [a, a, a];
+  i < 0.5 ? n = i * (1 + r) : n = i + r - i * r;
+  const o = 2 * i - n, c = [0, 0, 0];
+  for (let h = 0; h < 3; h++)
+    s = t + 1 / 3 * -(h - 1), s < 0 && s++, s > 1 && s--, 6 * s < 1 ? a = o + (n - o) * 6 * s : 2 * s < 1 ? a = n : 3 * s < 2 ? a = o + (n - o) * (2 / 3 - s) * 6 : a = o, c[h] = a * 255;
+  return c;
+};
+P.hsl.hsv = function(e) {
+  const t = e[0];
+  let r = e[1] / 100, i = e[2] / 100, n = r;
+  const s = Math.max(i, 0.01);
+  i *= 2, r *= i <= 1 ? i : 2 - i, n *= s <= 1 ? s : 2 - s;
+  const a = (i + r) / 2, o = i === 0 ? 2 * n / (s + n) : 2 * r / (i + r);
+  return [t, o * 100, a * 100];
+};
+P.hsv.rgb = function(e) {
+  const t = e[0] / 60, r = e[1] / 100;
+  let i = e[2] / 100;
+  const n = Math.floor(t) % 6, s = t - Math.floor(t), a = 255 * i * (1 - r), o = 255 * i * (1 - r * s), c = 255 * i * (1 - r * (1 - s));
+  switch (i *= 255, n) {
+    case 0:
+      return [i, c, a];
+    case 1:
+      return [o, i, a];
+    case 2:
+      return [a, i, c];
+    case 3:
+      return [a, o, i];
+    case 4:
+      return [c, a, i];
+    case 5:
+      return [i, a, o];
+  }
+};
+P.hsv.hsl = function(e) {
+  const t = e[0], r = e[1] / 100, i = e[2] / 100, n = Math.max(i, 0.01);
+  let s, a;
+  a = (2 - r) * i;
+  const o = (2 - r) * n;
+  return s = r * n, s /= o <= 1 ? o : 2 - o, s = s || 0, a /= 2, [t, s * 100, a * 100];
+};
+P.hwb.rgb = function(e) {
+  const t = e[0] / 360;
+  let r = e[1] / 100, i = e[2] / 100;
+  const n = r + i;
+  let s;
+  n > 1 && (r /= n, i /= n);
+  const a = Math.floor(6 * t), o = 1 - i;
+  s = 6 * t - a, a & 1 && (s = 1 - s);
+  const c = r + s * (o - r);
+  let h, l, u;
+  switch (a) {
+    default:
+    case 6:
+    case 0:
+      h = o, l = c, u = r;
+      break;
+    case 1:
+      h = c, l = o, u = r;
+      break;
+    case 2:
+      h = r, l = o, u = c;
+      break;
+    case 3:
+      h = r, l = c, u = o;
+      break;
+    case 4:
+      h = c, l = r, u = o;
+      break;
+    case 5:
+      h = o, l = r, u = c;
+      break;
+  }
+  return [h * 255, l * 255, u * 255];
+};
+P.cmyk.rgb = function(e) {
+  const t = e[0] / 100, r = e[1] / 100, i = e[2] / 100, n = e[3] / 100, s = 1 - Math.min(1, t * (1 - n) + n), a = 1 - Math.min(1, r * (1 - n) + n), o = 1 - Math.min(1, i * (1 - n) + n);
+  return [s * 255, a * 255, o * 255];
+};
+P.xyz.rgb = function(e) {
+  const t = e[0] / 100, r = e[1] / 100, i = e[2] / 100;
+  let n, s, a;
+  return n = t * 3.2406 + r * -1.5372 + i * -0.4986, s = t * -0.9689 + r * 1.8758 + i * 0.0415, a = t * 0.0557 + r * -0.204 + i * 1.057, n = n > 31308e-7 ? 1.055 * n ** (1 / 2.4) - 0.055 : n * 12.92, s = s > 31308e-7 ? 1.055 * s ** (1 / 2.4) - 0.055 : s * 12.92, a = a > 31308e-7 ? 1.055 * a ** (1 / 2.4) - 0.055 : a * 12.92, n = Math.min(Math.max(0, n), 1), s = Math.min(Math.max(0, s), 1), a = Math.min(Math.max(0, a), 1), [n * 255, s * 255, a * 255];
+};
+P.xyz.lab = function(e) {
+  let t = e[0], r = e[1], i = e[2];
+  t /= 95.047, r /= 100, i /= 108.883, t = t > 8856e-6 ? t ** (1 / 3) : 7.787 * t + 16 / 116, r = r > 8856e-6 ? r ** (1 / 3) : 7.787 * r + 16 / 116, i = i > 8856e-6 ? i ** (1 / 3) : 7.787 * i + 16 / 116;
+  const n = 116 * r - 16, s = 500 * (t - r), a = 200 * (r - i);
+  return [n, s, a];
+};
+P.lab.xyz = function(e) {
+  const t = e[0], r = e[1], i = e[2];
+  let n, s, a;
+  s = (t + 16) / 116, n = r / 500 + s, a = s - i / 200;
+  const o = s ** 3, c = n ** 3, h = a ** 3;
+  return s = o > 8856e-6 ? o : (s - 16 / 116) / 7.787, n = c > 8856e-6 ? c : (n - 16 / 116) / 7.787, a = h > 8856e-6 ? h : (a - 16 / 116) / 7.787, n *= 95.047, s *= 100, a *= 108.883, [n, s, a];
+};
+P.lab.lch = function(e) {
+  const t = e[0], r = e[1], i = e[2];
+  let n;
+  n = Math.atan2(i, r) * 360 / 2 / Math.PI, n < 0 && (n += 360);
+  const a = Math.sqrt(r * r + i * i);
+  return [t, a, n];
+};
+P.lch.lab = function(e) {
+  const t = e[0], r = e[1], n = e[2] / 360 * 2 * Math.PI, s = r * Math.cos(n), a = r * Math.sin(n);
+  return [t, s, a];
+};
+P.rgb.ansi16 = function(e, t = null) {
+  const [r, i, n] = e;
+  let s = t === null ? P.rgb.hsv(e)[2] : t;
+  if (s = Math.round(s / 50), s === 0)
+    return 30;
+  let a = 30 + (Math.round(n / 255) << 2 | Math.round(i / 255) << 1 | Math.round(r / 255));
+  return s === 2 && (a += 60), a;
+};
+P.hsv.ansi16 = function(e) {
+  return P.rgb.ansi16(P.hsv.rgb(e), e[2]);
+};
+P.rgb.ansi256 = function(e) {
+  const t = e[0], r = e[1], i = e[2];
+  return t === r && r === i ? t < 8 ? 16 : t > 248 ? 231 : Math.round((t - 8) / 247 * 24) + 232 : 16 + 36 * Math.round(t / 255 * 5) + 6 * Math.round(r / 255 * 5) + Math.round(i / 255 * 5);
+};
+P.ansi16.rgb = function(e) {
+  let t = e % 10;
+  if (t === 0 || t === 7)
+    return e > 50 && (t += 3.5), t = t / 10.5 * 255, [t, t, t];
+  const r = (~~(e > 50) + 1) * 0.5, i = (t & 1) * r * 255, n = (t >> 1 & 1) * r * 255, s = (t >> 2 & 1) * r * 255;
+  return [i, n, s];
+};
+P.ansi256.rgb = function(e) {
+  if (e >= 232) {
+    const s = (e - 232) * 10 + 8;
+    return [s, s, s];
+  }
+  e -= 16;
+  let t;
+  const r = Math.floor(e / 36) / 5 * 255, i = Math.floor((t = e % 36) / 6) / 5 * 255, n = t % 6 / 5 * 255;
+  return [r, i, n];
+};
+P.rgb.hex = function(e) {
+  const r = (((Math.round(e[0]) & 255) << 16) + ((Math.round(e[1]) & 255) << 8) + (Math.round(e[2]) & 255)).toString(16).toUpperCase();
+  return "000000".substring(r.length) + r;
+};
+P.hex.rgb = function(e) {
+  const t = e.toString(16).match(/[a-f0-9]{6}|[a-f0-9]{3}/i);
+  if (!t)
+    return [0, 0, 0];
+  let r = t[0];
+  t[0].length === 3 && (r = r.split("").map((o) => o + o).join(""));
+  const i = parseInt(r, 16), n = i >> 16 & 255, s = i >> 8 & 255, a = i & 255;
+  return [n, s, a];
+};
+P.rgb.hcg = function(e) {
+  const t = e[0] / 255, r = e[1] / 255, i = e[2] / 255, n = Math.max(Math.max(t, r), i), s = Math.min(Math.min(t, r), i), a = n - s;
+  let o, c;
+  return a < 1 ? o = s / (1 - a) : o = 0, a <= 0 ? c = 0 : n === t ? c = (r - i) / a % 6 : n === r ? c = 2 + (i - t) / a : c = 4 + (t - r) / a, c /= 6, c %= 1, [c * 360, a * 100, o * 100];
+};
+P.hsl.hcg = function(e) {
+  const t = e[1] / 100, r = e[2] / 100, i = r < 0.5 ? 2 * t * r : 2 * t * (1 - r);
+  let n = 0;
+  return i < 1 && (n = (r - 0.5 * i) / (1 - i)), [e[0], i * 100, n * 100];
+};
+P.hsv.hcg = function(e) {
+  const t = e[1] / 100, r = e[2] / 100, i = t * r;
+  let n = 0;
+  return i < 1 && (n = (r - i) / (1 - i)), [e[0], i * 100, n * 100];
+};
+P.hcg.rgb = function(e) {
+  const t = e[0] / 360, r = e[1] / 100, i = e[2] / 100;
+  if (r === 0)
+    return [i * 255, i * 255, i * 255];
+  const n = [0, 0, 0], s = t % 1 * 6, a = s % 1, o = 1 - a;
+  let c = 0;
+  switch (Math.floor(s)) {
+    case 0:
+      n[0] = 1, n[1] = a, n[2] = 0;
+      break;
+    case 1:
+      n[0] = o, n[1] = 1, n[2] = 0;
+      break;
+    case 2:
+      n[0] = 0, n[1] = 1, n[2] = a;
+      break;
+    case 3:
+      n[0] = 0, n[1] = o, n[2] = 1;
+      break;
+    case 4:
+      n[0] = a, n[1] = 0, n[2] = 1;
+      break;
+    default:
+      n[0] = 1, n[1] = 0, n[2] = o;
+  }
+  return c = (1 - r) * i, [
+    (r * n[0] + c) * 255,
+    (r * n[1] + c) * 255,
+    (r * n[2] + c) * 255
+  ];
+};
+P.hcg.hsv = function(e) {
+  const t = e[1] / 100, r = e[2] / 100, i = t + r * (1 - t);
+  let n = 0;
+  return i > 0 && (n = t / i), [e[0], n * 100, i * 100];
+};
+P.hcg.hsl = function(e) {
+  const t = e[1] / 100, i = e[2] / 100 * (1 - t) + 0.5 * t;
+  let n = 0;
+  return i > 0 && i < 0.5 ? n = t / (2 * i) : i >= 0.5 && i < 1 && (n = t / (2 * (1 - i))), [e[0], n * 100, i * 100];
+};
+P.hcg.hwb = function(e) {
+  const t = e[1] / 100, r = e[2] / 100, i = t + r * (1 - t);
+  return [e[0], (i - t) * 100, (1 - i) * 100];
+};
+P.hwb.hcg = function(e) {
+  const t = e[1] / 100, i = 1 - e[2] / 100, n = i - t;
+  let s = 0;
+  return n < 1 && (s = (i - n) / (1 - n)), [e[0], n * 100, s * 100];
+};
+P.apple.rgb = function(e) {
+  return [e[0] / 65535 * 255, e[1] / 65535 * 255, e[2] / 65535 * 255];
+};
+P.rgb.apple = function(e) {
+  return [e[0] / 255 * 65535, e[1] / 255 * 65535, e[2] / 255 * 65535];
+};
+P.gray.rgb = function(e) {
+  return [e[0] / 100 * 255, e[0] / 100 * 255, e[0] / 100 * 255];
+};
+P.gray.hsl = function(e) {
+  return [0, 0, e[0]];
+};
+P.gray.hsv = P.gray.hsl;
+P.gray.hwb = function(e) {
+  return [0, 100, e[0]];
+};
+P.gray.cmyk = function(e) {
+  return [0, 0, 0, e[0]];
+};
+P.gray.lab = function(e) {
+  return [e[0], 0, 0];
+};
+P.gray.hex = function(e) {
+  const t = Math.round(e[0] / 100 * 255) & 255, i = ((t << 16) + (t << 8) + t).toString(16).toUpperCase();
+  return "000000".substring(i.length) + i;
+};
+P.rgb.gray = function(e) {
+  return [(e[0] + e[1] + e[2]) / 3 / 255 * 100];
+};
+const _r = Eo;
+function zd() {
+  const e = {}, t = Object.keys(_r);
+  for (let r = t.length, i = 0; i < r; i++)
+    e[t[i]] = {
+      // http://jsperf.com/1-vs-infinity
+      // micro-opt, but this is simple.
+      distance: -1,
+      parent: null
+    };
+  return e;
+}
+function Bd(e) {
+  const t = zd(), r = [e];
+  for (t[e].distance = 0; r.length; ) {
+    const i = r.pop(), n = Object.keys(_r[i]);
+    for (let s = n.length, a = 0; a < s; a++) {
+      const o = n[a], c = t[o];
+      c.distance === -1 && (c.distance = t[i].distance + 1, c.parent = i, r.unshift(o));
+    }
+  }
+  return t;
+}
+function qd(e, t) {
+  return function(r) {
+    return t(e(r));
+  };
+}
+function Hd(e, t) {
+  const r = [t[e].parent, e];
+  let i = _r[t[e].parent][e], n = t[e].parent;
+  for (; t[n].parent; )
+    r.unshift(t[n].parent), i = qd(_r[t[n].parent][n], i), n = t[n].parent;
+  return i.conversion = r, i;
+}
+var Qd = function(e) {
+  const t = Bd(e), r = {}, i = Object.keys(t);
+  for (let n = i.length, s = 0; s < n; s++) {
+    const a = i[s];
+    t[a].parent !== null && (r[a] = Hd(a, t));
+  }
+  return r;
+};
+const $i = Eo, Gd = Qd, _t = {}, Yd = Object.keys($i);
+function Vd(e) {
+  const t = function(...r) {
+    const i = r[0];
+    return i == null ? i : (i.length > 1 && (r = i), e(r));
+  };
+  return "conversion" in e && (t.conversion = e.conversion), t;
+}
+function Jd(e) {
+  const t = function(...r) {
+    const i = r[0];
+    if (i == null)
+      return i;
+    i.length > 1 && (r = i);
+    const n = e(r);
+    if (typeof n == "object")
+      for (let s = n.length, a = 0; a < s; a++)
+        n[a] = Math.round(n[a]);
+    return n;
+  };
+  return "conversion" in e && (t.conversion = e.conversion), t;
+}
+Yd.forEach((e) => {
+  _t[e] = {}, Object.defineProperty(_t[e], "channels", { value: $i[e].channels }), Object.defineProperty(_t[e], "labels", { value: $i[e].labels });
+  const t = Gd(e);
+  Object.keys(t).forEach((i) => {
+    const n = t[i];
+    _t[e][i] = Jd(n), _t[e][i].raw = Vd(n);
+  });
+});
+var Xd = _t;
+const Ot = Wd, me = Xd, Ro = [
+  // To be honest, I don't really feel like keyword belongs in color convert, but eh.
+  "keyword",
+  // Gray conflicts with some method names, and has its own method defined.
+  "gray",
+  // Shouldn't really be in color-convert either...
+  "hex"
+], Fi = {};
+for (const e of Object.keys(me))
+  Fi[[...me[e].labels].sort().join("")] = e;
+const Or = {};
+function ce(e, t) {
+  if (!(this instanceof ce))
+    return new ce(e, t);
+  if (t && t in Ro && (t = null), t && !(t in me))
+    throw new Error("Unknown model: " + t);
+  let r, i;
+  if (e == null)
+    this.model = "rgb", this.color = [0, 0, 0], this.valpha = 1;
+  else if (e instanceof ce)
+    this.model = e.model, this.color = [...e.color], this.valpha = e.valpha;
+  else if (typeof e == "string") {
+    const n = Ot.get(e);
+    if (n === null)
+      throw new Error("Unable to parse color from string: " + e);
+    this.model = n.model, i = me[this.model].channels, this.color = n.value.slice(0, i), this.valpha = typeof n.value[i] == "number" ? n.value[i] : 1;
+  } else if (e.length > 0) {
+    this.model = t || "rgb", i = me[this.model].channels;
+    const n = Array.prototype.slice.call(e, 0, i);
+    this.color = Ei(n, i), this.valpha = typeof e[i] == "number" ? e[i] : 1;
+  } else if (typeof e == "number")
+    this.model = "rgb", this.color = [
+      e >> 16 & 255,
+      e >> 8 & 255,
+      e & 255
+    ], this.valpha = 1;
+  else {
+    this.valpha = 1;
+    const n = Object.keys(e);
+    "alpha" in e && (n.splice(n.indexOf("alpha"), 1), this.valpha = typeof e.alpha == "number" ? e.alpha : 0);
+    const s = n.sort().join("");
+    if (!(s in Fi))
+      throw new Error("Unable to parse color from object: " + JSON.stringify(e));
+    this.model = Fi[s];
+    const { labels: a } = me[this.model], o = [];
+    for (r = 0; r < a.length; r++)
+      o.push(e[a[r]]);
+    this.color = Ei(o);
+  }
+  if (Or[this.model])
+    for (i = me[this.model].channels, r = 0; r < i; r++) {
+      const n = Or[this.model][r];
+      n && (this.color[r] = n(this.color[r]));
+    }
+  this.valpha = Math.max(0, Math.min(1, this.valpha)), Object.freeze && Object.freeze(this);
+}
+ce.prototype = {
+  toString() {
+    return this.string();
+  },
+  toJSON() {
+    return this[this.model]();
+  },
+  string(e) {
+    let t = this.model in Ot.to ? this : this.rgb();
+    t = t.round(typeof e == "number" ? e : 1);
+    const r = t.valpha === 1 ? t.color : [...t.color, this.valpha];
+    return Ot.to[t.model](r);
+  },
+  percentString(e) {
+    const t = this.rgb().round(typeof e == "number" ? e : 1), r = t.valpha === 1 ? t.color : [...t.color, this.valpha];
+    return Ot.to.rgb.percent(r);
+  },
+  array() {
+    return this.valpha === 1 ? [...this.color] : [...this.color, this.valpha];
+  },
+  object() {
+    const e = {}, { channels: t } = me[this.model], { labels: r } = me[this.model];
+    for (let i = 0; i < t; i++)
+      e[r[i]] = this.color[i];
+    return this.valpha !== 1 && (e.alpha = this.valpha), e;
+  },
+  unitArray() {
+    const e = this.rgb().color;
+    return e[0] /= 255, e[1] /= 255, e[2] /= 255, this.valpha !== 1 && e.push(this.valpha), e;
+  },
+  unitObject() {
+    const e = this.rgb().object();
+    return e.r /= 255, e.g /= 255, e.b /= 255, this.valpha !== 1 && (e.alpha = this.valpha), e;
+  },
+  round(e) {
+    return e = Math.max(e || 0, 0), new ce([...this.color.map(Zd(e)), this.valpha], this.model);
+  },
+  alpha(e) {
+    return e !== void 0 ? new ce([...this.color, Math.max(0, Math.min(1, e))], this.model) : this.valpha;
+  },
+  // Rgb
+  red: K("rgb", 0, ae(255)),
+  green: K("rgb", 1, ae(255)),
+  blue: K("rgb", 2, ae(255)),
+  hue: K(["hsl", "hsv", "hsl", "hwb", "hcg"], 0, (e) => (e % 360 + 360) % 360),
+  saturationl: K("hsl", 1, ae(100)),
+  lightness: K("hsl", 2, ae(100)),
+  saturationv: K("hsv", 1, ae(100)),
+  value: K("hsv", 2, ae(100)),
+  chroma: K("hcg", 1, ae(100)),
+  gray: K("hcg", 2, ae(100)),
+  white: K("hwb", 1, ae(100)),
+  wblack: K("hwb", 2, ae(100)),
+  cyan: K("cmyk", 0, ae(100)),
+  magenta: K("cmyk", 1, ae(100)),
+  yellow: K("cmyk", 2, ae(100)),
+  black: K("cmyk", 3, ae(100)),
+  x: K("xyz", 0, ae(95.047)),
+  y: K("xyz", 1, ae(100)),
+  z: K("xyz", 2, ae(108.833)),
+  l: K("lab", 0, ae(100)),
+  a: K("lab", 1),
+  b: K("lab", 2),
+  keyword(e) {
+    return e !== void 0 ? new ce(e) : me[this.model].keyword(this.color);
+  },
+  hex(e) {
+    return e !== void 0 ? new ce(e) : Ot.to.hex(this.rgb().round().color);
+  },
+  hexa(e) {
+    if (e !== void 0)
+      return new ce(e);
+    const t = this.rgb().round().color;
+    let r = Math.round(this.valpha * 255).toString(16).toUpperCase();
+    return r.length === 1 && (r = "0" + r), Ot.to.hex(t) + r;
+  },
+  rgbNumber() {
+    const e = this.rgb().color;
+    return (e[0] & 255) << 16 | (e[1] & 255) << 8 | e[2] & 255;
+  },
+  luminosity() {
+    const e = this.rgb().color, t = [];
+    for (const [r, i] of e.entries()) {
+      const n = i / 255;
+      t[r] = n <= 0.04045 ? n / 12.92 : ((n + 0.055) / 1.055) ** 2.4;
+    }
+    return 0.2126 * t[0] + 0.7152 * t[1] + 0.0722 * t[2];
+  },
+  contrast(e) {
+    const t = this.luminosity(), r = e.luminosity();
+    return t > r ? (t + 0.05) / (r + 0.05) : (r + 0.05) / (t + 0.05);
+  },
+  level(e) {
+    const t = this.contrast(e);
+    return t >= 7 ? "AAA" : t >= 4.5 ? "AA" : "";
+  },
+  isDark() {
+    const e = this.rgb().color;
+    return (e[0] * 2126 + e[1] * 7152 + e[2] * 722) / 1e4 < 128;
+  },
+  isLight() {
+    return !this.isDark();
+  },
+  negate() {
+    const e = this.rgb();
+    for (let t = 0; t < 3; t++)
+      e.color[t] = 255 - e.color[t];
+    return e;
+  },
+  lighten(e) {
+    const t = this.hsl();
+    return t.color[2] += t.color[2] * e, t;
+  },
+  darken(e) {
+    const t = this.hsl();
+    return t.color[2] -= t.color[2] * e, t;
+  },
+  saturate(e) {
+    const t = this.hsl();
+    return t.color[1] += t.color[1] * e, t;
+  },
+  desaturate(e) {
+    const t = this.hsl();
+    return t.color[1] -= t.color[1] * e, t;
+  },
+  whiten(e) {
+    const t = this.hwb();
+    return t.color[1] += t.color[1] * e, t;
+  },
+  blacken(e) {
+    const t = this.hwb();
+    return t.color[2] += t.color[2] * e, t;
+  },
+  grayscale() {
+    const e = this.rgb().color, t = e[0] * 0.3 + e[1] * 0.59 + e[2] * 0.11;
+    return ce.rgb(t, t, t);
+  },
+  fade(e) {
+    return this.alpha(this.valpha - this.valpha * e);
+  },
+  opaquer(e) {
+    return this.alpha(this.valpha + this.valpha * e);
+  },
+  rotate(e) {
+    const t = this.hsl();
+    let r = t.color[0];
+    return r = (r + e) % 360, r = r < 0 ? 360 + r : r, t.color[0] = r, t;
+  },
+  mix(e, t) {
+    if (!e || !e.rgb)
+      throw new Error('Argument to "mix" was not a Color instance, but rather an instance of ' + typeof e);
+    const r = e.rgb(), i = this.rgb(), n = t === void 0 ? 0.5 : t, s = 2 * n - 1, a = r.alpha() - i.alpha(), o = ((s * a === -1 ? s : (s + a) / (1 + s * a)) + 1) / 2, c = 1 - o;
+    return ce.rgb(
+      o * r.red() + c * i.red(),
+      o * r.green() + c * i.green(),
+      o * r.blue() + c * i.blue(),
+      r.alpha() * n + i.alpha() * (1 - n)
+    );
+  }
+};
+for (const e of Object.keys(me)) {
+  if (Ro.includes(e))
+    continue;
+  const { channels: t } = me[e];
+  ce.prototype[e] = function(...r) {
+    return this.model === e ? new ce(this) : r.length > 0 ? new ce(r, e) : new ce([...ep(me[this.model][e].raw(this.color)), this.valpha], e);
+  }, ce[e] = function(...r) {
+    let i = r[0];
+    return typeof i == "number" && (i = Ei(r, t)), new ce(i, e);
+  };
+}
+function Kd(e, t) {
+  return Number(e.toFixed(t));
+}
+function Zd(e) {
+  return function(t) {
+    return Kd(t, e);
+  };
+}
+function K(e, t, r) {
+  e = Array.isArray(e) ? e : [e];
+  for (const i of e)
+    (Or[i] || (Or[i] = []))[t] = r;
+  return e = e[0], function(i) {
+    let n;
+    return i !== void 0 ? (r && (i = r(i)), n = this[e](), n.color[t] = i, n) : (n = this[e]().color[t], r && (n = r(n)), n);
+  };
+}
+function ae(e) {
+  return function(t) {
+    return Math.max(0, Math.min(e, t));
+  };
+}
+function ep(e) {
+  return Array.isArray(e) ? e : [e];
+}
+function Ei(e, t) {
+  for (let r = 0; r < t; r++)
+    typeof e[r] != "number" && (e[r] = 0);
+  return e;
+}
+var tp = ce;
+const rp = /* @__PURE__ */ Yi(tp);
+class ie {
+}
+// 1
+v(ie, "Text", 1), // 2
+v(ie, "ProcessingInstruction", 2), // 4
+v(ie, "SGMLDeclaration", 4), // 8
+v(ie, "Doctype", 8), // 16
+v(ie, "Comment", 16), // 32
+v(ie, "OpenTagStart", 32), // 64
+v(ie, "Attribute", 64), // 128
+v(ie, "OpenTag", 128), // 256
+v(ie, "CloseTag", 256), // 512
+v(ie, "Cdata", 512);
+class Wr {
+  constructor(t, r = 0) {
+    v(this, "data");
+    v(this, "cache", {});
+    v(this, "ptr");
+    this.data = t, this.ptr = r;
+  }
+}
+class ip {
+  constructor(t, r) {
+    v(this, "line");
+    v(this, "character");
+    this.line = t, this.character = r;
+  }
+}
+var Bn;
+(function(e) {
+  e[e.Normal = 0] = "Normal", e[e.JSX = 1] = "JSX";
+})(Bn || (Bn = {}));
+class Mo extends Wr {
+  constructor(r, i = 0) {
+    super(r, i);
+    v(this, "type");
+    v(this, "name");
+    v(this, "value");
+    this.type = r[i], i += 1;
+    const n = Ce(r, i);
+    i += 4, this.name = new $t(r, i), i += n, this.value = new $t(r, i);
+  }
+  toJSON() {
+    const { name: r, value: i, type: n } = this;
+    return { name: r, value: i, type: n };
+  }
+  toString() {
+    const { name: r, value: i } = this;
+    return `${r}="${i}"`;
+  }
+}
+class np extends Wr {
+  constructor(r, i = 0) {
+    super(r, i);
+    v(this, "target");
+    v(this, "content");
+    i += 16;
+    const n = Ce(r, i);
+    i += 4, this.target = new $t(r, i), i += n, this.content = new $t(r, i);
+  }
+  get start() {
+    return this.cache.start || (this.cache.start = Ke(this.data, this.ptr));
+  }
+  get end() {
+    return this.cache.end || (this.cache.end = Ke(this.data, this.ptr + 8));
+  }
+  toJSON() {
+    const { start: r, end: i, target: n, content: s } = this;
+    return { start: r, end: i, target: n, content: s };
+  }
+  toString() {
+    const { target: r, content: i } = this;
+    return `<? ${r} ${i} ?>`;
+  }
+}
+class $t extends Wr {
+  get start() {
+    return this.cache.start || (this.cache.start = Ke(this.data, this.ptr));
+  }
+  get end() {
+    return this.cache.end || (this.cache.end = Ke(this.data, this.ptr + 8));
+  }
+  get value() {
+    if (this.cache.value)
+      return this.cache.value;
+    const t = Ce(this.data, this.ptr + 16);
+    return this.cache.value = No(this.data, this.ptr + 20, t);
+  }
+  toJSON() {
+    const { start: t, end: r, value: i } = this;
+    return { start: t, end: r, value: i };
+  }
+  toString() {
+    return this.value;
+  }
+}
+class sp extends Wr {
+  get openStart() {
+    return this.cache.openStart || (this.cache.openStart = Ke(this.data, this.ptr + 8));
+  }
+  get openEnd() {
+    return this.cache.openEnd || (this.cache.openEnd = Ke(this.data, this.ptr + 16));
+  }
+  get closeStart() {
+    return this.cache.closeStart || (this.cache.closeStart = Ke(this.data, this.ptr + 24));
+  }
+  get closeEnd() {
+    return this.cache.closeEnd || (this.cache.closeEnd = Ke(this.data, this.ptr + 32));
+  }
+  get selfClosing() {
+    return !!this.data[this.ptr + 40];
+  }
+  get name() {
+    if (this.cache.name)
+      return this.cache.name;
+    const t = Ce(this.data, this.ptr + 41);
+    return this.cache.name = No(this.data, this.ptr + 45, t);
+  }
+  get attributes() {
+    if (this.cache.attributes)
+      return this.cache.attributes;
+    let t = Ce(this.data, this.ptr);
+    const r = Ce(this.data, t);
+    t += 4;
+    const i = [];
+    for (let n = 0; n < r; n++) {
+      const s = Ce(this.data, t);
+      t += 4, i[n] = new Mo(this.data, t), t += s;
+    }
+    return this.cache.attributes = i;
+  }
+  get textNodes() {
+    if (this.cache.textNodes)
+      return this.cache.textNodes;
+    let t = Ce(this.data, this.ptr + 4);
+    const r = Ce(this.data, t), i = [];
+    t += 4;
+    for (let n = 0; n < r; n++) {
+      const s = Ce(this.data, t);
+      t += 4, i[n] = new $t(this.data, t), t += s;
+    }
+    return this.cache.textNodes = i;
+  }
+  toJSON() {
+    const { openStart: t, openEnd: r, closeStart: i, closeEnd: n, name: s, attributes: a, textNodes: o, selfClosing: c } = this;
+    return { openStart: t, openEnd: r, closeStart: i, closeEnd: n, name: s, attributes: a, textNodes: o, selfClosing: c };
+  }
+  get value() {
+    return this.name;
+  }
+}
+class kr {
+  constructor(t = 0) {
+    // Web only
+    v(this, "events");
+    v(this, "wasmSaxParser");
+    v(this, "eventHandler");
+    v(this, "writeBuffer");
+    v(this, "eventTrap", (t, r, i) => {
+      if (!this.wasmSaxParser)
+        return;
+      const n = new Uint8Array(this.wasmSaxParser.memory.buffer, r, i), s = new Uint8Array(n);
+      let a;
+      switch (t) {
+        case ie.Attribute:
+          a = new Mo(s);
+          break;
+        case ie.ProcessingInstruction:
+          a = new np(s);
+          break;
+        case ie.OpenTag:
+        case ie.CloseTag:
+        case ie.OpenTagStart:
+          a = new sp(s);
+          break;
+        case ie.Text:
+        case ie.Cdata:
+        case ie.Comment:
+        case ie.Doctype:
+        case ie.SGMLDeclaration:
+          a = new $t(s);
+          break;
+        default:
+          throw new Error("No reader for this event type");
+      }
+      this.eventHandler && this.eventHandler(t, a);
+    });
+    const r = this;
+    Object.defineProperties(this, {
+      events: {
+        get: () => ~~t,
+        set: (i) => {
+          t = ~~i, r.wasmSaxParser && r.wasmSaxParser.parser(t);
+        },
+        configurable: !1,
+        enumerable: !0
+      }
+    });
+  }
+  async *parse(t) {
+    let r = [];
+    for (this.eventHandler = function(i, n) {
+      r.push([i, n]);
+    }; ; ) {
+      const i = await t.read();
+      if (i.done)
+        return this.end();
+      if (this.write(i.value), r.length) {
+        for (const n of r)
+          yield n;
+        r.length = 0;
+      }
+    }
+  }
+  write(t) {
+    if (!this.wasmSaxParser)
+      return;
+    const { write: r, memory: i } = this.wasmSaxParser;
+    (!this.writeBuffer || this.writeBuffer.buffer !== i.buffer) && (this.writeBuffer = new Uint8Array(i.buffer)), this.writeBuffer.set(t, 0), r(0, t.byteLength);
+  }
+  end() {
+    var t;
+    this.writeBuffer = void 0, (t = this.wasmSaxParser) == null || t.end();
+  }
+  async prepareWasm(t) {
+    let r;
+    const i = {
+      memory: new WebAssembly.Memory({ initial: 10, shared: !0, maximum: 150 }),
+      table: new WebAssembly.Table({ initial: 1, element: "anyfunc" }),
+      event_listener: this.eventTrap
+    };
+    if (t instanceof Uint8Array ? r = await WebAssembly.instantiate(t, { env: i }) : r = await WebAssembly.instantiateStreaming(t, { env: i }), r && typeof this.events == "number") {
+      const { parser: n } = this.wasmSaxParser = r.instance.exports;
+      return n(this.events), !0;
+    }
+    throw new Error("Failed to instantiate the parser.");
+  }
+}
+v(kr, "textDecoder");
+const No = (e, t, r) => globalThis.hasOwnProperty("Buffer") ? Buffer.from(e.buffer, e.byteOffset + t, r).toString() : (kr.textDecoder || (kr.textDecoder = new TextDecoder())).decode(e.subarray(t, t + r)), Ce = (e, t) => e[t + 3] << 24 | e[t + 2] << 16 | e[t + 1] << 8 | e[t], Ke = (e, t = 0) => {
+  const r = Ce(e, t), i = Ce(e, t + 4);
+  return new ip(r, i);
+}, ap = /(?<val>\d+(?:\.\d+)?)\s*(?<unit>[[a-z%]+)?/;
+function op(e) {
+  const t = new kr(ie.Text), r = [];
+  return t.eventHandler = (i, n) => {
+    r.push(n.value);
+  }, t.write(Pe.encode(e)), r.join("").trim();
+}
+function si(e, t, r) {
+  if (!e.spatial)
+    return null;
+  const i = t - e.spatial.y, n = i - e.spatial.height;
+  return {
+    Subtype: "/Square",
+    Rect: [
+      e.spatial.x * r,
+      i * r,
+      (e.spatial.x + e.spatial.width) * r,
+      n * r
+    ]
+  };
+}
+function cp(e) {
+  return rp(e).rgb().array();
+}
+function lp(e, t, r) {
+  const i = ap.exec(e);
+  if (!i || !i.groups)
+    return null;
+  const n = parseFloat(i.groups.val), s = i.groups.unit;
+  if (!s)
+    return n * t;
+  switch (s) {
+    case "%":
+      return null;
+    case "px":
+      return t * n;
+    default:
+      return console.warn(`Unsupported CSS length unit: ${s}`), null;
+  }
+}
+function hp(e, t) {
+  const r = {};
+  if ((e.stroke || e.strokeDasharray || e.strokeWidth) && (r.BS = {
+    Type: "/Border",
+    W: e.strokeWidth ?? 1,
+    S: e.strokeDasharray ? "/D" : "/S"
+  }, e.strokeDasharray && (r.BS.D = e.strokeDasharray)), e.fill) {
+    const i = cp(e.fill);
+    i && (r.IC = i.map((n) => n / 255));
+  }
+  if (e.strokeWidth) {
+    const i = lp(e.strokeWidth, t);
+    r.BS = {
+      Type: "/Border",
+      W: i
+    };
+  }
+  return r;
+}
+function qn(e, t, r) {
+  var n, s;
+  const i = e.style ? hp(e.style, t) : {};
+  switch (e.type) {
+    case "BoxSelector":
+      return {
+        Subtype: "/Square",
+        ...si(e, r, t),
+        ...i
+      };
+    case "PointSelector": {
+      const a = e;
+      if (!a.x || !a.y)
+        throw "Only PointSelectors with both x and y coordinates are supported!";
+      return {
+        Subtype: "/Circle",
+        BS: {
+          Type: "/Border",
+          W: 2,
+          S: "/S"
+        },
+        IC: [1, 1, 1],
+        Rect: [
+          a.x * t - 0.5,
+          a.y * t - 0.5,
+          a.x * t + 1,
+          a.y * t + 1
+        ]
+      };
+    }
+    case "SvgSelector": {
+      const a = e;
+      switch (a.svgShape) {
+        case "rect":
+          return {
+            Subtype: "/Square",
+            ...si(a, r, t),
+            ...i
+          };
+        case "circle":
+        case "ellipse":
+          return {
+            Subtype: "/Circle",
+            Rect: si(a, r, t),
+            ...i
+          };
+        case "polyline":
+        case "polygon":
+          return {
+            Subtype: a.svgShape === "polyline" ? "/PolyLine" : "/Polygon",
+            Vertices: ((n = a.points) == null ? void 0 : n.flatMap(([o, c]) => [
+              o * t,
+              (r - c) * t
+            ])) ?? [],
+            ...i
+          };
+        case "path":
+          return {
+            Subtype: "/Ink",
+            InkList: ((s = a.points) == null ? void 0 : s.flatMap(([o, c]) => [
+              o * t,
+              (r - c) * t
+            ])) ?? [],
+            ...i
+          };
+        default:
+          throw new Error("not implemented yet");
+      }
+    }
+    default:
+      throw `${e.type} selector is currently not supported`;
+  }
+}
+function up(e, t, r) {
+  const i = {
+    Type: "/Annot",
+    NM: `(${e.id})`,
+    Contents: `(${op(e.markup)})`,
+    F: 4,
+    C: [1, 0, 0],
+    // Red title bar
+    CA: 1,
+    // Constant opacity of 1
+    Border: [0, 0, 5]
+    //RC: `(${htmlToPdfRichText(anno.markup)})`,
+  };
+  return e.author && (i.T = `(${e.author})`), e.lastModified && (i.M = e.lastModified), e.target.selector ? [
+    {
+      ...i,
+      ...qn(e.target.selector, t, r)
+    }
+  ] : e.target.selectors && e.target.selectors.length > 0 ? e.target.selectors.map((n) => ({
+    ...i,
+    ...qn(n, t, r)
+  })) : [];
+}
+const fp = `pdiiif v${ko}`, ai = 2, Hn = new Uint8Array([
+  0,
+  1,
+  0,
+  0,
+  0,
+  10,
+  0,
+  128,
+  0,
+  3,
+  0,
+  32,
+  79,
+  83,
+  47,
+  50,
+  86,
+  222,
+  200,
+  148,
+  0,
+  0,
+  1,
+  40,
+  0,
+  0,
+  0,
+  96,
+  99,
+  109,
+  97,
+  112,
+  0,
+  10,
+  0,
+  52,
+  0,
+  0,
+  1,
+  144,
+  0,
+  0,
+  0,
+  30,
+  103,
+  108,
+  121,
+  102,
+  21,
+  34,
+  65,
+  36,
+  0,
+  0,
+  1,
+  184,
+  0,
+  0,
+  0,
+  24,
+  104,
+  101,
+  97,
+  100,
+  11,
+  120,
+  241,
+  101,
+  0,
+  0,
+  0,
+  172,
+  0,
+  0,
+  0,
+  54,
+  104,
+  104,
+  101,
+  97,
+  12,
+  2,
+  4,
+  2,
+  0,
+  0,
+  0,
+  228,
+  0,
+  0,
+  0,
+  36,
+  104,
+  109,
+  116,
+  120,
+  4,
+  0,
+  0,
+  0,
+  0,
+  0,
+  1,
+  136,
+  0,
+  0,
+  0,
+  8,
+  108,
+  111,
+  99,
+  97,
+  0,
+  12,
+  0,
+  0,
+  0,
+  0,
+  1,
+  176,
+  0,
+  0,
+  0,
+  6,
+  109,
+  97,
+  120,
+  112,
+  0,
+  4,
+  0,
+  5,
+  0,
+  0,
+  1,
+  8,
+  0,
+  0,
+  0,
+  32,
+  110,
+  97,
+  109,
+  101,
+  242,
+  235,
+  22,
+  218,
+  0,
+  0,
+  1,
+  208,
+  0,
+  0,
+  0,
+  75,
+  112,
+  111,
+  115,
+  116,
+  0,
+  1,
+  0,
+  1,
+  0,
+  0,
+  2,
+  28,
+  0,
+  0,
+  0,
+  32,
+  0,
+  1,
+  0,
+  0,
+  0,
+  1,
+  0,
+  0,
+  176,
+  148,
+  113,
+  16,
+  95,
+  15,
+  60,
+  245,
+  4,
+  7,
+  8,
+  0,
+  0,
+  0,
+  0,
+  0,
+  207,
+  154,
+  252,
+  110,
+  0,
+  0,
+  0,
+  0,
+  212,
+  195,
+  167,
+  242,
+  0,
+  0,
+  0,
+  0,
+  4,
+  0,
+  8,
+  0,
+  0,
+  0,
+  0,
+  16,
+  0,
+  2,
+  0,
+  0,
+  0,
+  0,
+  0,
+  0,
+  0,
+  1,
+  0,
+  0,
+  8,
+  0,
+  255,
+  255,
+  0,
+  0,
+  4,
+  0,
+  0,
+  0,
+  0,
+  0,
+  4,
+  0,
+  0,
+  1,
+  0,
+  0,
+  0,
+  0,
+  0,
+  0,
+  0,
+  0,
+  0,
+  0,
+  0,
+  0,
+  0,
+  0,
+  0,
+  2,
+  0,
+  1,
+  0,
+  0,
+  0,
+  2,
+  0,
+  4,
+  0,
+  1,
+  0,
+  0,
+  0,
+  0,
+  0,
+  1,
+  0,
+  0,
+  0,
+  0,
+  0,
+  0,
+  0,
+  0,
+  0,
+  0,
+  0,
+  0,
+  0,
+  0,
+  0,
+  0,
+  0,
+  3,
+  0,
+  0,
+  1,
+  144,
+  0,
+  5,
+  0,
+  0,
+  0,
+  0,
+  0,
+  0,
+  0,
+  0,
+  0,
+  0,
+  0,
+  0,
+  0,
+  0,
+  0,
+  0,
+  0,
+  0,
+  0,
+  0,
+  0,
+  0,
+  0,
+  0,
+  5,
+  0,
+  1,
+  0,
+  1,
+  0,
+  0,
+  0,
+  0,
+  0,
+  0,
+  0,
+  0,
+  0,
+  0,
+  0,
+  0,
+  0,
+  0,
+  0,
+  0,
+  0,
+  0,
+  0,
+  0,
+  0,
+  71,
+  79,
+  79,
+  71,
+  0,
+  64,
+  0,
+  0,
+  0,
+  0,
+  0,
+  1,
+  255,
+  255,
+  0,
+  0,
+  0,
+  1,
+  0,
+  1,
+  128,
+  0,
+  0,
+  0,
+  0,
+  0,
+  0,
+  0,
+  0,
+  0,
+  0,
+  0,
+  0,
+  0,
+  0,
+  1,
+  0,
+  0,
+  0,
+  0,
+  0,
+  0,
+  4,
+  0,
+  0,
+  0,
+  0,
+  0,
+  0,
+  2,
+  0,
+  1,
+  0,
+  0,
+  0,
+  0,
+  0,
+  20,
+  0,
+  3,
+  0,
+  0,
+  0,
+  0,
+  0,
+  20,
+  0,
+  6,
+  0,
+  10,
+  0,
+  0,
+  0,
+  0,
+  0,
+  0,
+  0,
+  0,
+  0,
+  0,
+  0,
+  0,
+  0,
+  12,
+  0,
+  0,
+  0,
+  1,
+  0,
+  0,
+  0,
+  0,
+  4,
+  0,
+  8,
+  0,
+  0,
+  3,
+  0,
+  0,
+  49,
+  33,
+  17,
+  33,
+  4,
+  0,
+  252,
+  0,
+  8,
+  0,
+  0,
+  0,
+  0,
+  3,
+  0,
+  42,
+  0,
+  0,
+  0,
+  3,
+  0,
+  0,
+  0,
+  5,
+  0,
+  22,
+  0,
+  0,
+  0,
+  1,
+  0,
+  0,
+  0,
+  0,
+  0,
+  5,
+  0,
+  11,
+  0,
+  22,
+  0,
+  3,
+  0,
+  1,
+  4,
+  9,
+  0,
+  5,
+  0,
+  22,
+  0,
+  0,
+  0,
+  86,
+  0,
+  101,
+  0,
+  114,
+  0,
+  115,
+  0,
+  105,
+  0,
+  111,
+  0,
+  110,
+  0,
+  32,
+  0,
+  49,
+  0,
+  46,
+  0,
+  48,
+  86,
+  101,
+  114,
+  115,
+  105,
+  111,
+  110,
+  32,
+  49,
+  46,
+  48,
+  0,
+  0,
+  1,
+  0,
+  0,
+  0,
+  0,
+  0,
+  0,
+  0,
+  0,
+  0,
+  0,
+  0,
+  0,
+  0,
+  1,
+  0,
+  0,
+  0,
+  0,
+  0,
+  0,
+  0,
+  0,
+  0,
+  0,
+  0,
+  0,
+  0,
+  0,
+  0,
+  0
+]);
+class dp {
+  /** Just basic setup of state, real setup is done in setup()
+      method since we need to call a bunch of async stuff */
+  constructor({
+    writer: t,
+    metadata: r,
+    canvasInfos: i,
+    langPref: n,
+    pageLabels: s,
+    outline: a = [],
+    readingDirection: o = "left-to-right",
+    hasText: c = !1,
+    initialCanvas: h,
+    manifestJson: l,
+    zipPolyglot: u = !1,
+    zipBaseDir: f
+  }) {
+    // Keep track of how many bytes have been written so far
+    v(this, "_offset", 0);
+    // PDF objects that are scheduled for writing, will be written on _flush()
+    v(this, "_objects", []);
+    // Number of the next PDF object
+    v(this, "_nextObjNo", 1);
+    // References to various central objects
+    v(this, "_objRefs", {});
+    // Tracks offset of every XObject
+    v(this, "_offsets", []);
+    // Writer used for outputting the PDF
+    v(this, "_writer");
+    // Have we already started writing the IIIF pages?
+    v(this, "_pagesStarted", !1);
+    // Information about each canvas, needed for pre-allocating objects
+    v(this, "_canvasInfos", []);
+    // Object number of the first page
+    v(this, "_firstPageObjectNum");
+    // Labels for every page in the PDF
+    v(this, "_pageLabels");
+    // Number of cover pages inserted at the beginning of the PDF
+    v(this, "_numCoverPages", 0);
+    // PDF outline
+    v(this, "_outline", []);
+    // Is the PDF supposed to have a hidden text layer?
+    v(this, "_hasText", !1);
+    // List of top-level entries in the PDF's logical structure tree
+    v(this, "_strucTree", []);
+    // Maps a page's object number to the marked content sequence IDs its content
+    // stream has
+    v(this, "_pageMCIds", /* @__PURE__ */ new Map());
+    // Identifier of the next structure parent entry
+    v(this, "_nextStructParentId", 0);
+    // For every page, its corresponding parent ID for the parent tree
+    v(this, "_pageParentIds", /* @__PURE__ */ new Map());
+    // Language preference
+    v(this, "_langPref");
+    v(this, "_initialCanvas");
+    v(this, "_polyglot");
+    v(this, "_manifestJson");
+    v(this, "_zipCatalog");
+    v(this, "_zipBaseDir");
+    v(this, "_readingDirection");
+    // FIXME: Overlap with _objRefs, should be unified
+    v(this, "_deferredReferences", /* @__PURE__ */ new Map());
+    this._writer = t, this._canvasInfos = i, this._pageLabels = s, this._outline = a, this._hasText = c, this._readingDirection = o, this._langPref = n, this._initialCanvas = h, this._polyglot = u, this._zipBaseDir = f, this._manifestJson = l;
+    const p = {
+      ...Object.entries(r).filter((d, m) => m !== void 0).reduce((d, [m, g]) => (d[m] = `(${g})`, d), {}),
+      Producer: `(${fp})`
+    };
+    this._addObject(p, "Info");
+  }
+  /** Set up the basic PDF document, creating neccessary objects.  */
+  async setup() {
+    const t = {
+      Type: "/Catalog"
+    };
+    this._addObject(t, "Catalog");
+    const r = this._addObject(
+      {
+        Type: "/Pages",
+        Count: this._canvasInfos.length
+      },
+      "Pages"
+    );
+    if (t.Pages = M(r), this._hasText && (t.MarkInfo = {
+      Type: "/MarkInfo",
+      Marked: !0
+    }), this._outline.length > 0) {
+      t.PageMode = "/UseOutlines";
+      const i = {
+        Type: "/Outlines",
+        Count: 0
+      }, n = this._addObject(i);
+      t.Outlines = M(n);
+      let s;
+      for (const [a, o] of this._outline.entries()) {
+        const [c, h] = this._addOutline(o, n, s);
+        i.Count += 1 + h, a === 0 ? i.First = M(c) : a === this._outline.length - 1 && (i.Last = M(c)), s = c;
+      }
+    } else
+      t.PageMode = "/UseThumbs";
+    t.ViewerPreferences = {
+      Direction: this._readingDirection === "right-to-left" ? "/R2L" : "/L2R"
+    }, this._hasText && await this._setupHiddenTextFont();
+  }
+  /** Set up neccessary fonts for the hidden text layer. */
+  async _setupHiddenTextFont() {
+    const t = this._addObject(
+      {
+        Type: "/Font",
+        Subtype: "/Type0",
+        BaseFont: "/GlyphLessFont",
+        Encoding: "/Identity-H"
+      },
+      "Type0Font"
+    ), r = this._addObject({
+      type: "/Font",
+      Subtype: "/CIDFontType2",
+      BaseFont: "/GlyphLessFont",
+      DW: 1e3 / ai,
+      CIDSystemInfo: {
+        Ordering: "(Identity)",
+        Registry: "(Adobe)",
+        Supplement: 0
+      }
+    });
+    t.data.DescendantFonts = [
+      M(r)
+    ];
+    const i = new Uint8Array(128 * 1024);
+    for (let u = 0; u < i.length; u++)
+      i[u] = u % 2 ? 1 : 0;
+    const n = await ur(i), s = this._addObject(n.dict, void 0, n.stream);
+    r.data.CIDToGIDMap = M(s);
+    const a = cd`
+      /CIDInit /ProcSet findresource begin
+        12 dict begin
+        begincmap
+            /CIDSystemInfo
+            <<
+              /Registry (Adobe)
+              /Ordering (UCS)
+              /Supplement 0
+            >> def
+            /CMapName /Identity-H def
+            /CMapType 2 def
+            1 begincodespacerange
+            <0000> <FFFF>
+            endcodespacerange
+            1 beginbfrange
+            <0000> <FFFF> <0000>
+            endbfrange
+        endcmap
+        CMapName currentdict /CMap defineresource pop
+        end
+    end`, o = this._addObject(
+      {
+        Length: a.length
+      },
+      void 0,
+      a
+    );
+    t.data.ToUnicode = M(o);
+    const c = this._addObject({
+      Type: "/FontDescriptor",
+      FontName: "/GlyphLessFont",
+      FontBBox: [0, 0, 1e3 / ai, 1e3],
+      Ascent: 1e3,
+      CapHeight: 1e3,
+      Descent: -1,
+      Flags: 5,
+      ItalicAngle: 0,
+      StemV: 80
+    });
+    r.data.FontDescriptor = M(c);
+    const h = await ur(Hn), l = this._addObject(
+      {
+        Length1: Hn.length,
+        ...h.dict
+      },
+      void 0,
+      h.stream
+    );
+    c.data.FontFile2 = M(l);
+  }
+  /** Register embedded OCR files in the PDF's catalog object. */
+  _registerEmbeddedFilesInCatalog() {
+    const t = this._objects[this._objRefs.Catalog.refObj].data, r = [
+      "(manifest.json)",
+      M(this._firstPageObjectNum - (this._polyglot ? 3 : 2))
+    ];
+    for (const [i, n] of this._canvasInfos.entries()) {
+      if (!n.ocr)
+        continue;
+      let a = this.getCanvasObjectNumber(i) + this.getObjectsPerCanvas(i) - 2;
+      this._polyglot && (a -= 1), r.push(`(${n.ocr.id})`), r.push(M(a));
+    }
+    if (!t.Names)
+      t.Names = {
+        EmbeddedFiles: { Names: r }
+      };
+    else {
+      const n = t.Names.EmbeddedFiles;
+      n.Names = n.Names.concat(r);
+    }
+  }
+  /** Create a PdfRef whose value is deferred, i.e. will be set at a later stage.
+   *
+   * Useful for bidirectional references.
+   *
+   * Prevents serialization of objects containing this reference as long as the
+   * value is not set.
+   *
+   * @param key A unique key to identify the reference
+   */
+  _makeDeferredReference(t) {
+    if (!this._deferredReferences.has(t)) {
+      const r = M(-1);
+      this._deferredReferences.set(t, r);
+    }
+    return this._deferredReferences.get(t);
+  }
+  /** Add items to the PDF's outline, based on the passed TocItem tree.
+   *
+   * @param itm The item we want to add to the outline
+   * @param parent The parent outline item
+   * @param prev The preceding sibling outline item, if present
+   * @returns A tuple containing the object reference of the added outline item and the number
+   *         of children outline items that were created
+   */
+  _addOutline(t, r, i) {
+    var o;
+    let n;
+    if (typeof t.startCanvas == "string") {
+      const c = this._canvasInfos.findIndex(
+        (h) => h.canvas.id === t.startCanvas
+      );
+      if (c < 0)
+        throw Error(
+          `Could not find canvas with id ${t.startCanvas} in manifest!`
+        );
+      n = [c, "/Fit"];
+    } else {
+      const c = t.startCanvas.id, h = 72 / t.startCanvas.ppi, l = t.startCanvas.position, { width: u, height: f } = t.startCanvas.dimensions, p = this._canvasInfos.findIndex(
+        (d) => d.canvas.id === c
+      );
+      if (p < 0)
+        throw Error(`Could not find canvas with id ${c} in manifest!`);
+      n = [
+        p,
+        "/FitR",
+        // TODO: Thoroughly test that this is actually working!
+        h * l.x,
+        // left
+        h * l.y,
+        // bottom
+        h * (u - (l.x + l.width)),
+        // right,
+        h * (f - (l.y + l.height))
+        // top,
+      ];
+    }
+    const s = {
+      Title: `( ${t.label} )`,
+      Parent: M(r),
+      // NOTE: The first entry is a number only during setup and will later be
+      //       replaced with a reference to the actual page object, once we know
+      //       how many objects are preceding the page objects.
+      Dest: n
+    }, a = this._addObject(s);
+    if (i && (s.Prev = M(i), i.data.Next = M(a)), (o = t.children) != null && o.length) {
+      let c;
+      s.Count = 0;
+      for (const [h, l] of t.children.entries()) {
+        const [u, f] = this._addOutline(l, a, c);
+        h === 0 ? s.First = M(u) : h === t.children.length - 1 && (s.Last = M(u)), s.Count = s.Count + 1 + f, c = u;
+      }
+    }
+    return [a, s.Count ?? 0];
+  }
+  /** Add a new object to the PDF document.
+   *
+   * @param val A PDF value, can be any of the supported types.
+   * @param refName An optional name to reference the object by.
+   * @param stream An optional stream to attach to the object, value must be adictionary in this case
+   * @returns The created object
+   */
+  _addObject(t, r, i) {
+    const n = (a) => typeof a == "object" && a !== null;
+    if (i) {
+      if (!n(t))
+        throw new Error(
+          "PDF Objects with a stream must have a dictionary as its value"
+        );
+      t.Length || (t.Length = i.length);
+    }
+    const s = {
+      num: this._nextObjNo,
+      data: t,
+      stream: i
+    };
+    return this._nextObjNo++, this._objects[s.num] = s, r && (this._objRefs[r] = M(s)), s;
+  }
+  /** Clone an object from a foreign PDF into the current PDF, adjusting
+   *  the encountered indirect object references.
+   *
+   * @param parser PdfParser instance for the PDF the object is from
+   * @param obj The object to transplant into our document
+   * @param seenObjects A map of object numbers to known references, used to avoid
+   *                    infinite recursion
+   * @returns A reference to the transplanted object
+   */
+  async _transplantObject(t, r, i = {}) {
+    const n = async (a) => {
+      if (a instanceof Tt) {
+        const o = await t.resolveRef(a);
+        if (o === void 0)
+          throw `Could not resolve reference to object '${a.refObj}'`;
+        if (i[o.num])
+          return i[o.num];
+        const c = o.data, h = this._addObject(c, void 0, o.stream), l = new Tt(h.num);
+        return i[o.num] = l, h.data = await n(c), c.Type === "/Page" && (h.data.Parent = this._objRefs.Pages), l;
+      } else {
+        if (typeof a == "string" && a[0] != "/")
+          return `(${a})`;
+        if (Array.isArray(a)) {
+          const o = [];
+          for (const c of a)
+            o.push(await n(c));
+          return o;
+        } else if (typeof a == "object" && a !== null) {
+          const o = {};
+          for (const [c, h] of Object.entries(a))
+            c === "StructParent" || c === "StructParents" || (o[c] = await n(h));
+          return o;
+        }
+      }
+      return a;
+    }, s = new Tt(r.num);
+    return await n(s);
+  }
+  /** Insert cover pages from another PDF into our document. */
+  async insertCoverPages(t) {
+    if (this._pagesStarted)
+      throw "Cover pages must be inserted before writing the first regular page";
+    const r = new Td(new Uint8Array(t)), i = await Ki.parse(r), n = this._objects[this._objRefs.Pages.refObj].data;
+    n.Kids = [];
+    for await (const s of i.pages()) {
+      const a = s.data;
+      delete a.StructParents, delete a.Parent;
+      const o = await this._transplantObject(i, s);
+      n.Kids.push(o), n.Count += 1, this._numCoverPages += 1;
+    }
+  }
+  /** Embed a file resource in the PDF.
+   *
+   * @param filename The filename for the embedded resource
+   * @param description A description of the file
+   * @param mimeType The MIME type of the file
+   * @param data The data to embed
+   */
+  async _embedResource(t, r, i, n) {
+    const s = {
+      Type: "/Filespec",
+      F: `(${t})`,
+      UF: Ti(t),
+      Desc: `(${r})`,
+      EF: {
+        F: M(this._nextObjNo + (this._polyglot ? 2 : 1))
+      }
+    }, a = await ur(n), o = {
+      Type: "/EmbeddedFile",
+      Subtype: `(${i})`,
+      ...a.dict
+    };
+    if (this._addObject(s), this._polyglot) {
+      let c;
+      typeof n == "string" ? c = Pe.encode(n) : c = n;
+      const h = this._getSerializedSize(
+        {
+          num: this._nextObjNo + 2,
+          data: { ...o, ...a.dict },
+          stream: a.stream
+        },
+        !0
+      );
+      this._insertZipHeaderDummyObject({
+        filename: t,
+        data: c,
+        deflatedData: a.dict.Filter ? a.stream : void 0,
+        // 2 bytes zlib header of deflated data
+        bytesUntilActualData: h + 2
+      });
+    }
+    this._addObject(o, void 0, a.stream);
+  }
+  /** Embed the IIIF Manifest JSON in the PDF.
+   *
+   * @param manifestJson The IIIF (v2 or v3) Manifest to embed
+   */
+  async _embedManifest(t) {
+    let r = "application/ld+json";
+    if (Array.isArray(t["@context"])) {
+      const i = t["@context"].find(
+        (n) => n.startsWith("http://iiif.io/api/presentation")
+      );
+      i && (r += `;profile="${i}"`);
+    } else t["@context"] && (r += `;profile="${t["@context"]}"`);
+    await this._embedResource(
+      "manifest.json",
+      "IIIF Manifest this PDF is based on",
+      r,
+      JSON.stringify(t)
+    );
+  }
+  /** Once all setup is complete and we begin rendering pages into the document,
+   *  we need to finalize the PDF header with the remaining information.
+   */
+  async finalizePdfHeader() {
+    const t = this._objects[this._objRefs.Catalog.refObj].data;
+    this._pageLabels && (t.PageLabels = M(
+      this._addObject({
+        Nums: this._pageLabels.map(
+          (n, s) => n ? [s + this._numCoverPages, { P: `( ${n} )` }] : void 0
+        ).filter((n) => n !== void 0).flat()
+      })
+    ));
+    const i = this._objects[this._objRefs.Pages.refObj].data;
+    i.Kids || (i.Kids = []), this._firstPageObjectNum = this._nextObjNo, this._manifestJson && (this._firstPageObjectNum += 2, this._polyglot && this._firstPageObjectNum++);
+    for (const [n] of this._canvasInfos.entries())
+      i.Kids.push(
+        M(this.getCanvasObjectNumber(n))
+      );
+    if (this._objects.filter((n) => {
+      var s;
+      return ((s = n.data) == null ? void 0 : s.Dest) !== void 0;
+    }).forEach((n) => {
+      const s = n.data.Dest;
+      typeof s[0] == "number" && (s[0] = M(this.getCanvasObjectNumber(s[0])));
+    }), this._hasText && (t.StructTreeRoot = M(
+      this._nextObjNo + this.totalCanvasObjects
+    )), this._canvasInfos.some((n) => n.images.some((s) => s.choiceInfo))) {
+      const n = [], s = [], a = [], o = [];
+      for (const [c, { images: h }] of this._canvasInfos.entries()) {
+        let u = this.getCanvasObjectNumber(c) + 2 + h.length;
+        this._polyglot && (u += h.length);
+        let f = 0;
+        const p = [];
+        for (const d of h) {
+          if (!d.choiceInfo)
+            continue;
+          const m = M(u + f);
+          d.choiceInfo.enabled ? n.push(m) : s.push(m), a.push(m), p.push(m), f++;
+        }
+        o.push(p);
+      }
+      t.OCProperties = {
+        OCGs: a,
+        D: {
+          BaseState: "/OFF",
+          ON: n,
+          OFF: s,
+          RBGroups: o
+        }
+      };
+    }
+    if (typeof this._initialCanvas == "string")
+      t.OpenAction = [
+        M(
+          this.getCanvasObjectNumber(
+            this._canvasInfos.findIndex(
+              (n) => n.canvas.id === this._initialCanvas
+            )
+          )
+        )
+      ];
+    else if (this._initialCanvas) {
+      const n = 72 / this._initialCanvas.ppi, s = this._initialCanvas.position, { width: a, height: o } = this._initialCanvas.dimensions;
+      t.OpenAction = [
+        M(
+          this.getCanvasObjectNumber(
+            this._canvasInfos.findIndex(
+              (c) => c.canvas.id === this._initialCanvas
+            )
+          )
+        ),
+        "/FitR",
+        // TODO: Thoroughly test that this is actually working!
+        n * s.x,
+        // left
+        n * s.y,
+        // bottom
+        n * (a - (s.x + s.width)),
+        // right,
+        n * (o - (s.y + s.height))
+        // top,
+      ];
+    }
+    this._registerEmbeddedFilesInCatalog(), await this._flush(), this._manifestJson && (await this._embedManifest(this._manifestJson), await this._flush());
+  }
+  /** Render a new page, based on a IIIF canvas, its associated annotations and OCR text.
+   *
+   * @param canvasId The ID of the canvas to render
+   * @param width The width of the canvas in pixels
+   * @param height The height of the canvas in pixels
+   * @param images The images to render on the canvas
+   * @param annotations The annotations to render on the canvas
+   * @param ocrText The OCR text to render on the canvas
+   * @param ppi The resolution of the canvas in pixels per inch, used to determine the physical
+   *            size of the PDF page. Assumes 300ppi by default.
+   */
+  async renderPage(t, {
+    width: r,
+    height: i
+  }, n, s, a, o = 300) {
+    var F;
+    this._pagesStarted || (O.debug("Initial page, finalizing PDF header structures."), await this.finalizePdfHeader(), this._pagesStarted = !0);
+    const c = 72 / o, h = {
+      Type: "/Page",
+      Parent: this._objRefs.Pages,
+      MediaBox: [0, 0, c * r, c * i],
+      Resources: {
+        ProcSet: ["/PDF", "/Text", "/ImageB", "/ImageI", "/ImageC"]
+      }
+    };
+    this._hasText && (h.StructParents = this._nextStructParentId, this._pageParentIds.set(this._nextObjNo, this._nextStructParentId), this._nextStructParentId++), a && this._objRefs.Type0Font && (h.Resources.Font = {
+      "f-0-0": this._objRefs.Type0Font
+    });
+    const l = this._addObject(h), u = [], f = {};
+    for (const [x, A] of n.entries()) {
+      if (hr(A))
+        continue;
+      const { x: I, y: C, width: S, height: E, choiceInfo: _ } = A, R = c * S, V = c * E, H = c * I, z = c * (i - E - C), B = `/Im${x + 1}`;
+      if (_ != null && _.optional) {
+        const D = `/oc${Object.keys(f).length + 1}`;
+        f[B] = D, u.push(`/OC ${D} BDC`);
+      }
+      u.push(`q ${R} 0 0 ${V} ${H} ${z} cm`), u.push(`${B} Do`), u.push("Q"), _ != null && _.optional && u.push("EMC");
+    }
+    a && u.push(this._renderOcrText(a, c)), O.debug("Trying to compress content stream.");
+    const p = await ur(u.join(`
+`)), d = this._addObject(
+      p.dict,
+      void 0,
+      p.stream
+    );
+    l.data.Contents = M(d);
+    const m = l.data.Resources, g = {}, y = {};
+    for (const [x, A] of n.entries()) {
+      if (hr(A))
+        continue;
+      const I = `/Im${x + 1}`;
+      if (g[I.substring(1)] = this._makeDeferredReference(I), (F = A.choiceInfo) != null && F.optional) {
+        const C = f[I];
+        y[C.substring(1)] = this._makeDeferredReference(C);
+      }
+    }
+    m.XObject = g, Object.keys(y).length > 0 && (m.Properties = y), O.debug("Creating image objects.");
+    const b = this._canvasInfos.findIndex(
+      (x) => x.canvas.id === t
+    );
+    for (const [x, A] of n.entries()) {
+      if (hr(A)) {
+        this._addObject({}), this._polyglot && this._addObject({});
+        continue;
+      }
+      const I = new Uint8Array(A.data), C = Xi.open(I), S = C.toObjects(
+        // Account for local zip header object if polyglot Zip-PDF is enabled
+        this._polyglot ? this._nextObjNo + 1 : this._nextObjNo
+      );
+      if (A.format !== "jpeg" && C instanceof tr) {
+        let R = S.slice(-1)[0].num;
+        for (let V = 0; S.length < 3; V++)
+          S.push({ num: R++ });
+      }
+      const E = S[0], _ = `/Im${x + 1}`;
+      if (this._deferredReferences.get(_).refObj = E.num, this._polyglot)
+        if (C instanceof tr) {
+          const R = this._getSerializedSize(E, !0), V = `img/canvas-${b}-${x}.jpg`;
+          this._insertZipHeaderDummyObject({
+            filename: V,
+            data: I,
+            bytesUntilActualData: R
+          });
+        } else
+          this._addObject({});
+      S.forEach((R) => this._objects.push(R)), this._nextObjNo = S.slice(-1)[0].num + 1;
+    }
+    if (n.some((x) => {
+      var A;
+      return (A = x == null ? void 0 : x.choiceInfo) == null ? void 0 : A.optional;
+    })) {
+      O.debug("Creating optional content groups for page");
+      for (const [x, A] of n.entries()) {
+        const I = `/Im${x + 1}`;
+        if (A != null && A.choiceInfo) {
+          if (hr(A)) {
+            this._addObject({});
+            continue;
+          }
+          this._deferredReferences.get(f[I]).refObj = this._nextObjNo, this._addObject({
+            Type: "/OCG",
+            Name: A.choiceInfo.label ? `(${$e(A.choiceInfo.label, this._langPref, "/")})` : void 0,
+            Intent: "/View",
+            Usage: A.choiceInfo.visibleByDefault ? "/ON" : "/OFF"
+          });
+        }
+      }
+    }
+    const w = this._canvasInfos[b];
+    if (a != null && a.markup) {
+      const x = this._canvasInfos.findIndex(
+        (I) => I.canvas.id === t
+      );
+      let A = `ocr/canvas-${x}`;
+      a.mimeType.indexOf("html") >= 0 ? A += ".html" : A += ".xml", await this._embedResource(
+        A,
+        `OCR for canvas #${x}`,
+        a.mimeType,
+        a.markup
+      );
+    } else w.ocr && (this._addObject({}), this._addObject({}), this._polyglot && this._addObject({}));
+    s && s.length > 0 && (O.debug("Creating annotations for page"), h.Annots = s.flatMap((x) => up(x, c, i)).map((x) => M(this._addObject(x)))), O.debug("Flushing data for page"), await this._flush(), O.debug("Finished rendering page");
+  }
+  /** Get PDF instructions to render a hidden text layer with the page's OCR.
+   *
+   * This owes *a lot* to Tesseract's PDF renderer[1] and the IA's `pdf-tools`[2]
+   * that ported it to Python. Accordingly, the license of this method is Apache 2.0.
+   *
+   * [1] https://github.com/tesseract-ocr/tesseract/blob/5.0.0-beta-20210916/src/api/pdfrenderer.cpp
+   * [2] https://github.com/internetarchive/archive-pdf-tools/blob/master/internetarchivepdf/pdfrenderer.py
+   *
+   *                            Apache License
+   *                     Version 2.0, January 2004
+   *                  http://www.apache.org/licenses/
+   */
+  _renderOcrText(t, r) {
+    const i = t.height, n = [];
+    n.push("BT"), n.push("3 Tr");
+    const s = this._nextObjNo - 1;
+    let a = 0;
+    const o = [], c = (h, l) => {
+      if (h.type === "block")
+        o.push({
+          type: "Sect",
+          children: [],
+          pageObjNum: s,
+          mcs: []
+        });
+      else if (h.type === "paragraph")
+        o.push({
+          type: "P",
+          children: [],
+          pageObjNum: s,
+          mcs: []
+        }), l && l.children.push(o.slice(-1)[0]);
+      else if (h.type === "line") {
+        n.push(
+          ...this.renderOcrLine(
+            h,
+            a,
+            r,
+            i,
+            s
+          )
+        ), l && l.children.push({
+          type: "Span",
+          children: [],
+          pageObjNum: s,
+          mcs: [a]
+        }), a++;
+        return;
+      }
+      for (const u of h.children)
+        c(u, o.slice(-1)[0]);
+    };
+    return c(t), this._strucTree.push(...o), n.push("ET"), n.join(`
+`);
+  }
+  /** Get PDF instructions to render a single line of OCR text. */
+  renderOcrLine(t, r, i, n, s) {
+    const a = "/f-0-0", u = [];
+    u.push(`/Span << /MCID ${r} >> BDC`);
+    const f = t.height * i * 0.75;
+    u.push(`${a} ${f} Tf`);
+    const p = t.x * i, d = n - t.y - t.height * 0.75, m = d * i;
+    u.push(`1 0 0 1 ${p} ${m} Tm`);
+    let g = 0, y = 0;
+    for (const b of t.words) {
+      if (!b.text || !b.width)
+        continue;
+      const w = (b.x - t.x) * i, x = (n - b.y - b.height * 0.75 - d) * i, A = b.width * i, I = b.height * i, C = w - g, S = x - y;
+      u.push(`${C * 1 + S * 0} ${C * 0 + S * 1} Td`), g = w, y = x;
+      const E = Math.pow(
+        Math.pow(A, 2) + Math.pow(I, 2),
+        0.5
+      ), _ = b.text.length;
+      u.push(
+        `${ai * (100 * E / (f * _))} Tz`
+      );
+      const R = Se(Ti(b.text + " ", !1));
+      u.push(`[ ${R} ] TJ`);
+    }
+    return u.push("EMC"), u.push(""), this._pageMCIds.has(s) || this._pageMCIds.set(s, []), this._pageMCIds.get(s).push(r), u;
+  }
+  /** How many bytes have we written to the output so far? */
+  get bytesWritten() {
+    return this._offset;
+  }
+  /** Number of objects needed to render all canvases */
+  get totalCanvasObjects() {
+    return this._canvasInfos.reduce(
+      (t, r, i) => t + this.getCanvasObjectNumber(i),
+      0
+    );
+  }
+  /** How many objects are needed to render the canvas at the given index? */
+  getObjectsPerCanvas(t) {
+    const { images: r, ocr: i, numAnnotations: n } = this._canvasInfos[t];
+    let s = (
+      // 1 XObject for JPEGs, 3 for PNGs or unknown formats
+      // The minority of PNGs actually need three XObjects, but we can't know
+      // that in advance and so we simply add empty dummy objects if we need less.
+      r.map((a) => a.format === "jpeg" ? 1 : 3).reduce((a, o) => a + o, 0) + // Page dictionary and content
+      2 + // 1 Optional Content Group per optional image
+      r.filter((a) => a.choiceInfo !== void 0).length + // 1 XObject per annotation
+      n
+    );
+    return this._polyglot && (s = s + r.length + (i ? 1 : 0)), i && (s += 2), s;
+  }
+  /** Get the object number for the canvas at the given index. */
+  getCanvasObjectNumber(t) {
+    let r = this._firstPageObjectNum;
+    for (const [i] of this._canvasInfos.entries()) {
+      if (i === t)
+        return r;
+      r += this.getObjectsPerCanvas(i);
+    }
+    throw new Error(`Canvas #${t} not found.`);
+  }
+  /** Flush remaining data to output. */
+  async _flush() {
+    this._offsets.length === 0 && (O.debug("Writing PDF header"), await this._write(`%PDF-1.5
+%
+`));
+    for (const t of this._objects)
+      t && (O.debug(`Serializing object #${t.num}`), await this._serializeObject(t));
+    this._objects = [];
+  }
+  /** Get the serialized size in bytes of a PDF object. */
+  _getSerializedSize({ num: t, data: r, stream: i }, n = !1) {
+    let s = 0;
+    if (s += `${t} 0 obj
+`.length, r && (s += Se(r).length), i) {
+      if (s += 8, n)
+        return s;
+      typeof i == "string" ? s += Pe.encode(i).byteLength : s += i.byteLength, s += 10;
+    }
+    return s += 8, s;
+  }
+  /** Serialize a PDF object to the output. */
+  async _serializeObject(t) {
+    this._offsets.push(this._offset);
+    const { num: r, data: i, stream: n } = t;
+    await this._write(`${r} 0 obj
+`), i && await this._write(Se(i)), n && (await this._write(`
+stream
+`), await this._write(n), await this._write(`
+endstream`)), await this._write(`
+endobj
+`);
+  }
+  /** Write data to the output. */
+  async _write(t) {
+    if (this._writer === void 0)
+      throw new Error(
+        "Cannot perform mutating operations on an already closed PDFGenerator."
+      );
+    typeof t == "string" && (t = Pe.encode(t)), this._offset += t.byteLength, await this._writer.write(t);
+  }
+  /** Write the PDF objects required for the structure tree */
+  async _writeStructureTree() {
+    const t = {
+      Nums: []
+    }, r = M(this._addObject(t)), i = {
+      Type: "/StructTreeRoot",
+      K: [],
+      ParentTree: r,
+      ParentTreeNextKey: this._nextStructParentId
+    }, n = /* @__PURE__ */ new Map(), s = M(this._addObject(i)), a = async (o, c, h) => {
+      const l = {
+        Type: "/StructElem",
+        S: `/${o.type}`,
+        P: h,
+        Pg: M(o.pageObjNum),
+        K: []
+      };
+      n.has(o.pageObjNum) || n.set(o.pageObjNum, []);
+      const u = M(this._addObject(l));
+      if (c.K.push(u), o.children.length > 0)
+        for (const f of o.children)
+          await a(f, l, u);
+      else o.mcs.length == 1 ? l.K = o.mcs[0] : o.mcs.length > 0 && (l.K = o.mcs);
+      if (o.mcs.length > 0) {
+        const f = n.get(o.pageObjNum);
+        for (const p of o.mcs)
+          f[p] = u;
+      }
+      this._objects.length > 1e3 && await this._flush();
+    };
+    for (const o of this._strucTree)
+      await a(o, i, s);
+    for (const [o, c] of n) {
+      const h = this._pageParentIds.get(o);
+      t.Nums.push(
+        h,
+        M(this._addObject(c))
+      );
+    }
+    await this._flush();
+  }
+  /** Finish writing the PDF and close the writer.
+   *
+   * Writes XRef table, trailer and EOF marker to the output.
+   * Also adds ZIP central directory if polyglot PDF is enabled.
+   */
+  async end() {
+    if (!this._writer)
+      return;
+    O.debug("Writing xref table");
+    const t = [
+      [0, 65535, "f"],
+      ...this._offsets.map((a) => [a, 0, "n"])
+    ], r = t.map(
+      ([a, o, c]) => [
+        a.toString(10).padStart(10, "0"),
+        o.toString(10).padStart(5, "0"),
+        c,
+        ""
+      ].join(" ")
+    ).join(`
+`), i = this._offset;
+    await this._write(`xref
+0 ${t.length}
+${r}
+`);
+    const n = {
+      Size: t.length,
+      Root: this._objRefs.Catalog,
+      Info: this._objRefs.Info,
+      ID: [Ln(32), Ln(32)]
+    };
+    await this._write(`
+trailer
+${Se(n)}`);
+    const s = `startxref
+${i}
+%%EOF`;
+    if (this._polyglot && this._zipCatalog) {
+      O.debug("Writing zip end of central directory"), await this._write(`9990 0 obj
+<<>>
+stream
+`);
+      const a = `
+endstream
+endobj
+`;
+      await this._write(
+        Fd({
+          files: this._zipCatalog,
+          trailingLength: s.length + a.length,
+          offset: this._offset
+        })
+      ), await this._write(a);
+    }
+    await this._flush(), O.debug("Writing trailer"), await this._write(s), O.debug("Flushing"), await this._flush(), O.debug("PDF finished, closing writer"), await this._writer.close(), O.debug("Writer closed"), this._writer = void 0;
+  }
+  /** Insert a 'dummy' PDF object that isn't referenced anywhere, but which
+   *  contains the data neccessary to expose the following object's data as a
+   *  file in the ZIP archive.
+   */
+  _insertZipHeaderDummyObject({
+    filename: t,
+    data: r,
+    deflatedData: i,
+    bytesUntilActualData: n
+  }) {
+    this._zipBaseDir && (t = `${this._zipBaseDir}/${t}`);
+    const s = this._offset + this._objects.reduce((h, l) => h + this._getSerializedSize(l), 0), a = /* @__PURE__ */ new Date();
+    n += 18;
+    const o = this._addObject(
+      {},
+      void 0,
+      $d({
+        filename: t,
+        data: r,
+        compressedData: i,
+        extraDataLength: n,
+        creationDate: a
+      })
+    ), c = s + this._getSerializedSize(o, !0);
+    this._zipCatalog || (this._zipCatalog = []), this._zipCatalog.push({
+      localHeaderOffset: c,
+      deflated: (i == null ? void 0 : i.length) !== r.length,
+      creationDate: /* @__PURE__ */ new Date(),
+      crc32: rs(r),
+      dataLength: r.length,
+      // skip 2 bytes for zlib header
+      compressedDataLength: i ? i.length - 2 : r.length,
+      filename: t
+    });
+  }
+}
+const pp = {
+  "http://creativecommons.org/licenses/by-nc-sa/2.0/fr/": {
+    text: "Creative Commons Attribution-NonCommercial-ShareAlike 2.0 France (CC-BY-NC-SA-2.0-FR)",
+    logo: "https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nc-sa.svg"
+  },
+  "http://creativecommons.org/licenses/by-sa/4.0/": {
+    text: "Creative Commons Attribution Share Alike 4.0 International (CC-BY-SA-4.0)",
+    logo: "https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-sa.svg"
+  },
+  "http://creativecommons.org/licenses/by/3.0/de/": {
+    text: "Creative Commons Attribution 3.0 Germany (CC-BY-3.0-DE)",
+    logo: "https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by.svg"
+  },
+  "http://creativecommons.org/licenses/by-nc-nd/3.0/": {
+    text: "Creative Commons Attribution Non Commercial No Derivatives 3.0 Unported (CC-BY-NC-ND-3.0)",
+    logo: "https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nc-nd.svg"
+  },
+  "http://creativecommons.org/licenses/by/1.0/": {
+    text: "Creative Commons Attribution 1.0 Generic (CC-BY-1.0)",
+    logo: "https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by.svg"
+  },
+  "http://creativecommons.org/licenses/by-nd/1.0/": {
+    text: "Creative Commons Attribution No Derivatives 1.0 Generic (CC-BY-ND-1.0)",
+    logo: "https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nd.svg"
+  },
+  "http://creativecommons.org/licenses/by-nc-sa/3.0/de/": {
+    text: "Creative Commons Attribution Non Commercial Share Alike 3.0 Germany (CC-BY-NC-SA-3.0-DE)",
+    logo: "https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nc-sa.svg"
+  },
+  "http://creativecommons.org/licenses/by-nc-sa/1.0/": {
+    text: "Creative Commons Attribution Non Commercial Share Alike 1.0 Generic (CC-BY-NC-SA-1.0)",
+    logo: "https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nc-sa.svg"
+  },
+  "http://creativecommons.org/licenses/by-nd/4.0/": {
+    text: "Creative Commons Attribution No Derivatives 4.0 International (CC-BY-ND-4.0)",
+    logo: "https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nd.svg"
+  },
+  "http://creativecommons.org/licenses/by-sa/3.0/at/": {
+    text: "Creative Commons Attribution Share Alike 3.0 Austria (CC-BY-SA-3.0-AT)",
+    logo: "https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-sa.svg"
+  },
+  "http://creativecommons.org/licenses/by/3.0/at/": {
+    text: "Creative Commons Attribution 3.0 Austria (CC-BY-3.0-AT)",
+    logo: "https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by.svg"
+  },
+  "http://creativecommons.org/licenses/by/3.0/": {
+    text: "Creative Commons Attribution 3.0 Unported (CC-BY-3.0)",
+    logo: "https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by.svg"
+  },
+  "http://creativecommons.org/licenses/by-nc/2.0/": {
+    text: "Creative Commons Attribution Non Commercial 2.0 Generic (CC-BY-NC-2.0)",
+    logo: "https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nc.svg"
+  },
+  "http://creativecommons.org/licenses/by-nc-sa/2.5/": {
+    text: "Creative Commons Attribution Non Commercial Share Alike 2.5 Generic (CC-BY-NC-SA-2.5)",
+    logo: "https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nc-sa.svg"
+  },
+  "http://creativecommons.org/licenses/by-nc/2.5/": {
+    text: "Creative Commons Attribution Non Commercial 2.5 Generic (CC-BY-NC-2.5)",
+    logo: "https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nc.svg"
+  },
+  "http://creativecommons.org/licenses/by-nd-nc/1.0/": {
+    text: "Creative Commons Attribution Non Commercial No Derivatives 1.0 Generic (CC-BY-NC-ND-1.0)",
+    logo: "https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nc-nd.svg"
+  },
+  "http://creativecommons.org/licenses/by-nd/3.0/": {
+    text: "Creative Commons Attribution No Derivatives 3.0 Unported (CC-BY-ND-3.0)",
+    logo: "https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nd.svg"
+  },
+  "http://creativecommons.org/licenses/by-sa/2.5/": {
+    text: "Creative Commons Attribution Share Alike 2.5 Generic (CC-BY-SA-2.5)",
+    logo: "https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-sa.svg"
+  },
+  "http://creativecommons.org/licenses/by-nc-sa/2.0/uk/": {
+    text: "Creative Commons Attribution Non Commercial Share Alike 2.0 England and Wales (CC-BY-NC-SA-2.0-UK)",
+    logo: "https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nc-sa.svg"
+  },
+  "http://creativecommons.org/licenses/by/2.0/": {
+    text: "Creative Commons Attribution 2.0 Generic (CC-BY-2.0)",
+    logo: "https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by.svg"
+  },
+  "http://creativecommons.org/licenses/by-nd/2.5/": {
+    text: "Creative Commons Attribution No Derivatives 2.5 Generic (CC-BY-ND-2.5)",
+    logo: "https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nd.svg"
+  },
+  "http://creativecommons.org/licenses/by-nc-nd/2.0/": {
+    text: "Creative Commons Attribution Non Commercial No Derivatives 2.0 Generic (CC-BY-NC-ND-2.0)",
+    logo: "https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nc-nd.svg"
+  },
+  "http://creativecommons.org/licenses/by-nc-sa/3.0/igo/": {
+    text: "Creative Commons Attribution Non Commercial Share Alike 3.0 IGO (CC-BY-NC-SA-3.0-IGO)",
+    logo: "https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nc-sa.svg"
+  },
+  "http://creativecommons.org/licenses/publicdomain//": {
+    text: "Creative Commons Public Domain Dedication and Certification (CC-PDDC)",
+    logo: "https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/publicdomain.svg"
+  },
+  "http://creativecommons.org/licenses/by-nc-sa/2.0/": {
+    text: "Creative Commons Attribution Non Commercial Share Alike 2.0 Generic (CC-BY-NC-SA-2.0)",
+    logo: "https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nc-sa.svg"
+  },
+  "http://creativecommons.org/licenses/by-nc-nd/3.0/de/": {
+    text: "Creative Commons Attribution Non Commercial No Derivatives 3.0 Germany (CC-BY-NC-ND-3.0-DE)",
+    logo: "https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nc-nd.svg"
+  },
+  "http://creativecommons.org/licenses/by-nc/3.0/": {
+    text: "Creative Commons Attribution Non Commercial 3.0 Unported (CC-BY-NC-3.0)",
+    logo: "https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nc.svg"
+  },
+  "http://creativecommons.org/licenses/by-nc/3.0/de/": {
+    text: "Creative Commons Attribution Non Commercial 3.0 Germany (CC-BY-NC-3.0-DE)",
+    logo: "https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nc.svg"
+  },
+  "http://creativecommons.org/licenses/by-sa/1.0/": {
+    text: "Creative Commons Attribution Share Alike 1.0 Generic (CC-BY-SA-1.0)",
+    logo: "https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-sa.svg"
+  },
+  "http://creativecommons.org/licenses/by-nd/3.0/de/": {
+    text: "Creative Commons Attribution No Derivatives 3.0 Germany (CC-BY-ND-3.0-DE)",
+    logo: "https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nd.svg"
+  },
+  "http://creativecommons.org/licenses/by-nc-nd/2.5/": {
+    text: "Creative Commons Attribution Non Commercial No Derivatives 2.5 Generic (CC-BY-NC-ND-2.5)",
+    logo: "https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nc-nd.svg"
+  },
+  "http://creativecommons.org/licenses/by-sa/3.0/": {
+    text: "Creative Commons Attribution Share Alike 3.0 Unported (CC-BY-SA-3.0)",
+    logo: "https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-sa.svg"
+  },
+  "http://creativecommons.org/licenses/by-nc-sa/4.0/": {
+    text: "Creative Commons Attribution Non Commercial Share Alike 4.0 International (CC-BY-NC-SA-4.0)",
+    logo: "https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nc-sa.svg"
+  },
+  "http://creativecommons.org/licenses/by-sa/2.0/": {
+    text: "Creative Commons Attribution Share Alike 2.0 Generic (CC-BY-SA-2.0)",
+    logo: "https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-sa.svg"
+  },
+  "http://creativecommons.org/licenses/by-sa/2.1/jp/": {
+    text: "Creative Commons Attribution Share Alike 2.1 Japan (CC-BY-SA-2.1-JP)",
+    logo: "https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-sa.svg"
+  },
+  "http://creativecommons.org/licenses/by/2.5/": {
+    text: "Creative Commons Attribution 2.5 Generic (CC-BY-2.5)",
+    logo: "https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by.svg"
+  },
+  "http://creativecommons.org/licenses/by-sa/2.0/uk/": {
+    text: "Creative Commons Attribution Share Alike 2.0 England and Wales (CC-BY-SA-2.0-UK)",
+    logo: "https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-sa.svg"
+  },
+  "http://creativecommons.org/licenses/by/3.0/nl/": {
+    text: "Creative Commons Attribution 3.0 Netherlands (CC-BY-3.0-NL)",
+    logo: "https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by.svg"
+  },
+  "http://creativecommons.org/licenses/by-nc-sa/3.0/": {
+    text: "Creative Commons Attribution Non Commercial Share Alike 3.0 Unported (CC-BY-NC-SA-3.0)",
+    logo: "https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nc-sa.svg"
+  },
+  "http://creativecommons.org/licenses/by/4.0/": {
+    text: "Creative Commons Attribution 4.0 International (CC-BY-4.0)",
+    logo: "https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by.svg"
+  },
+  "http://creativecommons.org/licenses/by/3.0/us/": {
+    text: "Creative Commons Attribution 3.0 United States (CC-BY-3.0-US)",
+    logo: "https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by.svg"
+  },
+  "http://creativecommons.org/licenses/by-nc-nd/4.0/": {
+    text: "Creative Commons Attribution Non Commercial No Derivatives 4.0 International (CC-BY-NC-ND-4.0)",
+    logo: "https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nc-nd.svg"
+  },
+  "http://creativecommons.org/licenses/by-sa/3.0/de/": {
+    text: "Creative Commons Attribution Share Alike 3.0 Germany (CC-BY-SA-3.0-DE)",
+    logo: "https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-sa.svg"
+  },
+  "http://creativecommons.org/licenses/by-nc-nd/3.0/igo/": {
+    text: "Creative Commons Attribution Non Commercial No Derivatives 3.0 IGO (CC-BY-NC-ND-3.0-IGO)",
+    logo: "https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nc-nd.svg"
+  },
+  "http://creativecommons.org/publicdomain/zero/1.0/": {
+    text: "Creative Commons Zero v1.0 Universal (CC0-1.0)",
+    logo: "https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/cc-zero.svg"
+  },
+  "http://creativecommons.org/publicdomain/mark/1.0/": {
+    text: "Public Domain Mark 1.0: No Copyright",
+    logo: "https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/publicdomain.svg"
+  },
+  "http://creativecommons.org/licenses/by/2.5/au/": {
+    text: "Creative Commons Attribution 2.5 Australia (CC-BY-2.5-AU)",
+    logo: "https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by.svg"
+  },
+  "http://creativecommons.org/licenses/by-nd/2.0/": {
+    text: "Creative Commons Attribution No Derivatives 2.0 Generic (CC-BY-ND-2.0)",
+    logo: "https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nd.svg"
+  },
+  "http://creativecommons.org/licenses/by-nc/1.0/": {
+    text: "Creative Commons Attribution Non Commercial 1.0 Generic (CC-BY-NC-1.0)",
+    logo: "https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nc.svg"
+  },
+  "http://creativecommons.org/licenses/by-nc/4.0/": {
+    text: "Creative Commons Attribution Non Commercial 4.0 International (CC-BY-NC-4.0)",
+    logo: "https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nc.svg"
+  },
+  "http://rightsstatements.org/vocab/InC/1.0/": {
+    text: "In Copyright",
+    logo: "https://rightsstatements.org/files/buttons/InC.dark.svg"
+  },
+  "http://rightsstatements.org/vocab/InC-OW-EU/1.0/": {
+    text: "In Copyright - EU Orphan Work",
+    logo: "https://rightsstatements.org/files/buttons/InC-OW-EU.dark.svg"
+  },
+  "http://rightsstatements.org/vocab/InC-EDU/1.0/": {
+    text: "In Copyright - Educational Use Permitted",
+    logo: "https://rightsstatements.org/files/buttons/InC-EDU.dark.svg"
+  },
+  "http://rightsstatements.org/vocab/InC-NC/1.0/": {
+    text: "In Copyright - Non-Commercial Use Permitted",
+    logo: "https://rightsstatements.org/files/buttons/InC-NC.dark.svg"
+  },
+  "http://rightsstatements.org/vocab/InC-RUU/1.0/": {
+    text: "In Copyright - Rights-holder(s) Unlocatable or Unidentifiable",
+    logo: "https://rightsstatements.org/files/buttons/InC-RUU.dark.svg"
+  },
+  "http://rightsstatements.org/vocab/NoC-CR/1.0/": {
+    text: "No Copyright - Contractual Restrictions",
+    logo: "https://rightsstatements.org/files/buttons/NoC-CR.dark.svg"
+  },
+  "http://rightsstatements.org/vocab/NoC-NC/1.0/": {
+    text: "No Copyright - Non-Commercial Use Only",
+    logo: "https://rightsstatements.org/files/buttons/NoC-NC.dark.svg"
+  },
+  "http://rightsstatements.org/vocab/NoC-OKLR/1.0/": {
+    text: "No Copyright - Other Known Legal Restrictions",
+    logo: "https://rightsstatements.org/files/buttons/NoC-OKLR.dark.svg"
+  },
+  "http://rightsstatements.org/vocab/NoC-US/1.0/": {
+    text: "No Copyright - United States",
+    logo: "https://rightsstatements.org/files/buttons/NoC-US.dark.svg"
+  },
+  "http://rightsstatements.org/vocab/CNE/1.0/": {
+    text: "Copyright Not Evaluated",
+    logo: "https://rightsstatements.org/files/buttons/CNE.dark.svg"
+  },
+  "http://rightsstatements.org/vocab/UND/1.0/": {
+    text: "Copyright Undetermined",
+    logo: "https://rightsstatements.org/files/buttons/UND.dark.svg"
+  },
+  "http://rightsstatements.org/vocab/NKC/1.0/": {
+    text: "No Known Copyright",
+    logo: "https://rightsstatements.org/files/buttons/NKC.dark.svg"
+  }
+};
+function gp(e) {
+  return e = e.replace(/^https:/, "http:").replace(/\/deed\.[a-z]{2}$/, ""), e.endsWith("/") || (e += "/"), pp[e];
+}
+function mp(e) {
+  return new Worker(
+    "" + new URL("assets/optimization.worker-Ra1-MoAS.js", import.meta.url).href,
+    {
+      type: "module",
+      name: e == null ? void 0 : e.name
+    }
+  );
+}
+class vp {
+  constructor(t) {
+    v(this, "workers", []);
+    v(this, "queue", []);
+    v(this, "pendingTasks", /* @__PURE__ */ new Map());
+    v(this, "busyWorkers", /* @__PURE__ */ new Set());
+    this.size = t;
+  }
+  start() {
+    for (let t = 0; t < this.size; t++) {
+      const r = new mp();
+      r.onmessage = this.handleMessage.bind(this, r), r.onerror = this.handleError.bind(this, r), this.workers.push(r);
+    }
+  }
+  stop() {
+    this.workers.forEach((t) => t.terminate()), this.workers = [], this.queue = [], this.busyWorkers.clear();
+  }
+  dispatch(t) {
+    return new Promise((r, i) => {
+      this.queue.push({
+        resolve: r,
+        reject: i,
+        task: {
+          id: xc(),
+          data: t
+        }
+      }), this.processQueue();
+    });
+  }
+  processQueue() {
+    if (this.queue.length === 0) return;
+    const t = this.workers.find((i) => !this.busyWorkers.has(i));
+    if (!t) return;
+    const r = this.queue.shift();
+    this.pendingTasks.set(r.task.id, r), this.busyWorkers.add(t), t.postMessage(r.task);
+  }
+  handleMessage(t, r) {
+    O.debug("worker: received message", r.data);
+    const i = this.pendingTasks.get(r.data.input.id);
+    i ? (i.resolve(r.data.result), O.debug("worker: resolved job", i.task.id), this.pendingTasks.delete(i.task.id), this.busyWorkers.delete(t), this.processQueue()) : O.warn(
+      `worker: unknown job, known jobs: ${[...this.pendingTasks.keys()].join(
+        ", "
+      )}`,
+      r.data.input.id
+    );
+  }
+  handleError(t, r) {
+    const i = r.error, n = this.queue.find((s) => s.task.id === i.taskId);
+    n && (n.reject(i.cause), this.busyWorkers.delete(t), this.processQueue());
+  }
+}
+let rt = null, Qn = !1;
+function Do(e = navigator.hardwareConcurrency) {
+  rt === null && (rt = new vp(e), rt.start());
+}
+async function yp(e) {
+  if (rt === null && Do(), Qn)
+    return;
+  const t = await e();
+  let r = [];
+  for (let i = 0; i < rt.size; i++)
+    r.push(rt.dispatch({ mozjpegWasm: t }));
+  O.debug("main: mozjpegWasm sent to workers"), await Promise.all(r), O.debug("main: workers initialized with MozJPEG encoder"), Qn = !0;
+}
+async function Lo(e) {
+  return rt === null && Do(), rt.dispatch(e);
+}
+function bp(e, t) {
+  if (e.length <= t)
+    return e;
+  const r = e.reduce((s, { width: a, height: o }) => s + a * o, 0) / e.length, i = e.filter(
+    (s) => Math.abs(r - s.width * s.height) <= 0.25 * r
+  );
+  if (i.length <= t)
+    return i;
+  const n = [];
+  for (; n.length < t; ) {
+    const s = i[Math.floor(Math.random() * i.length)];
+    n.indexOf(s) < 0 && n.push(s);
+  }
+  return n.sort(
+    (s, a) => e.indexOf(s) - e.indexOf(a)
+  );
+}
+async function Wp({
+  manifest: e,
+  concurrency: t = 1,
+  scaleFactor: r,
+  filterCanvases: i = () => !0,
+  numSamples: n = 8,
+  optimization: s,
+  saxWasmLoader: a = async () => fetch(
+    `https://unpkg.com/sax-wasm@${Ri}/lib/sax-wasm.wasm`
+  ).then((h) => h.arrayBuffer()).then((h) => new Uint8Array(h)),
+  mozjpegWasmLoader: o = async () => fetch("https://unpkg.com/@jsquash/jpeg@1.5.0/codec/enc/mozjpeg_enc.wasm").then((h) => h.arrayBuffer()).then((h) => new Uint8Array(h)),
+  sampleCanvases: c
+}) {
+  let h;
+  typeof e == "string" ? h = e : h = e.id ?? e["@id"];
+  const l = await co(h), u = await G.loadManifest(h, l);
+  if (!u)
+    throw new Error(`Failed to load manifest from ${h}`);
+  let f;
+  Array.isArray(i) ? f = (C) => i.indexOf(C) >= 0 : f = i;
+  const p = G.get(
+    u.items.filter((C) => f(C.id)).map((C) => C.id)
+  ), d = p.reduce(
+    (C, S) => C + S.width * S.height,
+    0
+  );
+  c != null && c.length || (c = bp(p, n));
+  const m = c.reduce(
+    (C, S) => C + S.width * S.height,
+    0
+  );
+  if (!yt || !Xt()) {
+    if (!yt) {
+      const C = await a();
+      is(C);
+    }
+    Xt() || (await Kn(() => Promise.resolve(yt)), O.debug.bind(O), O.info.bind(O), O.warn.bind(O), O.error.bind(O), void 0);
+  }
+  const g = new go({ concurrency: t }), y = await Promise.all(
+    c.map(
+      (C) => g.add(async () => {
+        const S = io(C);
+        return oo(C, S.images, {
+          scaleFactor: r,
+          sizeOnly: s === void 0
+        });
+      })
+    )
+  );
+  let b;
+  if (s) {
+    s.method === "mozjpeg" && await yp(o);
+    const C = y.filter((_) => _ !== void 0).flatMap((_) => _.images), S = C.reduce(
+      (_, R) => _ + R.data.byteLength,
+      0
+    );
+    await Promise.all(
+      C.map(async (_) => {
+        const R = await Lo({
+          imageData: new Uint8Array(_.data),
+          imageFormat: _.format === "jpeg" ? "image/jpeg" : "image/png",
+          ...s
+        });
+        _.data = R.jpegData.buffer, _.format = "jpeg";
+      })
+    ), b = C.reduce(
+      (_, R) => _ + R.data.byteLength,
+      0
+    ) / S;
+  }
+  const w = y.filter(bt).flatMap((C) => C.images).every((C) => C.corsAvailable), F = y.filter(bt).flatMap((C) => C.images).reduce(
+    (C, S) => {
+      var E;
+      return C + (((E = S == null ? void 0 : S.data) == null ? void 0 : E.byteLength) ?? S.numBytes);
+    },
+    0
+  ), A = y.filter(bt).flatMap((C) => C.images)[0];
+  return {
+    size: F / m * d,
+    corsSupported: w,
+    sampleImageData: A.data ? new Uint8Array(A.data) : void 0,
+    sampleImageMimeType: A.format,
+    sampleCanvases: c,
+    optimizationResult: b
+  };
+}
+async function wp(e, t, r) {
+  const i = t.map((l) => l.id), n = (l) => typeof l != "string" && l.type === "Canvas", s = (l) => typeof l != "string" && l.type == "Range", a = /* @__PURE__ */ new Set(), o = async (l) => {
+    if (a.has(l.id))
+      return;
+    const u = l.items.filter(n).filter((g) => i.indexOf(g.id) >= 0).filter(n).sort(
+      (g, y) => i.indexOf(g.id) > i.indexOf(y.id) ? -1 : 1
+    )[0], f = $e(
+      l.label ?? "<untitled>",
+      r,
+      "; "
+    ), p = G.get(l.items.filter(s)), d = (await Promise.all(p.map(o))).filter(bt);
+    let m;
+    if (l.start && (m = await ao(l)), a.add(l.id), !(d.length === 0 && !u))
+      return !m && u ? m = u.id : m || (m = d[0].startCanvas), {
+        label: f,
+        startCanvas: m,
+        children: d
+      };
+  };
+  let c = G.get(e.structures);
+  const h = c.find(
+    (l) => l.behavior.indexOf("top") >= 0
+  );
+  return h && (c = [h]), (await Promise.all(c.map(o))).filter(
+    bt
+  ) ?? [];
+}
+class xp {
+  constructor(t, r, i, n, s) {
+    v(this, "canvasPixels", 0);
+    v(this, "pixelsWritten", 0);
+    v(this, "pixelBytesFactor", 0);
+    v(this, "pixelScaleFactor", 0);
+    v(this, "timeStart");
+    v(this, "pdfGen");
+    v(this, "totalPages");
+    v(this, "totalCanvasPixels", 0);
+    v(this, "countingStream");
+    v(this, "onProgress");
+    v(this, "onNotification");
+    this.totalCanvasPixels = t.reduce(
+      (a, o) => a + o.width * o.height,
+      0
+    ), this.totalPages = t.length, this.pdfGen = i, this.countingStream = r, this.onProgress = n, this.onNotification = s;
+  }
+  /** Check if there is still data that needs to be written out. */
+  get writeOutstanding() {
+    return this.pdfGen.bytesWritten > this.countingStream.bytesWritten;
+  }
+  /** Emit a progress update, with an optional message. */
+  emitProgress(t, r) {
+    var c;
+    this.timeStart || (this.timeStart = tn());
+    const i = this.pdfGen.bytesWritten;
+    let n;
+    t === this.totalPages ? n = i : t > 0 && (n = Math.floor(
+      this.pixelBytesFactor * this.pixelScaleFactor * this.totalCanvasPixels
+    ));
+    const s = this.countingStream.bytesWritten, a = i / ((tn() - this.timeStart) / 1e3);
+    let o = Number.POSITIVE_INFINITY;
+    n && (o = (n - s) / a), (c = this.onProgress) == null || c.call(this, {
+      messageCode: r,
+      pagesWritten: t,
+      totalPages: this.totalPages,
+      bytesWritten: s,
+      bytesPushed: i,
+      estimatedFileSize: n,
+      writeSpeed: a,
+      remainingDuration: o
+    });
+  }
+  /** Emit a notification message to inform the user about unexpected stuff that
+   * happens during PDF generation */
+  emitNotification(t) {
+    var r;
+    (r = this.onNotification) == null || r.call(this, t);
+  }
+  /** Update how many actual pixels and 'canvas pixels' have been written. */
+  updatePixels(t, r) {
+    this.pixelsWritten += t, this.canvasPixels += r, this.pixelScaleFactor = this.pixelsWritten / this.canvasPixels, this.pixelBytesFactor = this.pdfGen.bytesWritten / this.pixelsWritten;
+  }
+}
+async function Cp(e, t, r, i) {
+  var h, l, u, f, p, d, m;
+  const n = {
+    // NOTE: Manifest label is mandatory, i.e. safe to assert non-null
+    // eslint-disable-next-line @typescript-eslint/no-non-null-assertion
+    title: $e(
+      e.label ?? "<untitled>",
+      t,
+      "; "
+    ),
+    manifestUrl: e.id,
+    pdiiifVersion: ko
+  }, s = await Df(e, 512);
+  if (s) {
+    n.thumbnail = { url: s };
+    const g = G.get(e.thumbnail.map((y) => y.id))[0];
+    g && "type" in g && (n.thumbnail.iiifImageService = (l = (h = g.service) == null ? void 0 : h.find(
+      (y) => {
+        var b;
+        return ((b = y == null ? void 0 : y.type) == null ? void 0 : b.startsWith("ImageService")) ?? !1;
+      }
+    )) == null ? void 0 : l.id);
+  }
+  const a = G.get(e.provider)[0], o = e.requiredStatement;
+  a && (n.provider = {
+    label: $e(a.label, t, "; "),
+    homepage: (f = (u = a.homepage) == null ? void 0 : u[0]) == null ? void 0 : f.id,
+    logo: (d = (p = a.logo) == null ? void 0 : p[0]) == null ? void 0 : d.id
+  }, n.provider.label === "Unknown" && (n.provider.label = "")), o != null && o.label && (n.requiredStatement = {
+    label: $e(o.label, t, "; "),
+    value: $e(o.value, t, "; ")
+  });
+  const c = e.rights;
+  if (c) {
+    const g = gp(c);
+    n.rights = {
+      text: (g == null ? void 0 : g.text) ?? c,
+      url: c,
+      logo: g == null ? void 0 : g.logo
+    };
+  }
+  if (n.metadata = ((m = e.metadata) == null ? void 0 : m.map((g) => {
+    const y = $e(g.label, t, "; "), b = $e(g.value, t, "|||").split(
+      "|||"
+    );
+    if (!(!y || b.length === 0))
+      return b.length === 1 ? [y, b[0]] : [y, b];
+  }).filter((g) => g !== void 0)) ?? [], i)
+    return await i(n);
+  if (r) {
+    const y = await (await Kt(r, {
+      method: "POST",
+      headers: { "Content-Type": "application/json; charset=utf-8" },
+      body: JSON.stringify(n)
+    })).arrayBuffer();
+    return new Uint8Array(y);
+  } else
+    throw "Either `endpoint` or `callback` must be specified!";
+}
+async function Up(e, t, {
+  fetchCanvasAnnotations: r = () => Promise.resolve([]),
+  filterCanvases: i = () => !0,
+  languagePreference: n = [Intl.DateTimeFormat().resolvedOptions().locale],
+  scaleFactor: s,
+  metadata: a = {},
+  onProgress: o,
+  onNotification: c,
+  ppi: h,
+  concurrency: l = 1,
+  abortController: u = new AbortController(),
+  coverPageCallback: f,
+  coverPageEndpoint: p,
+  polyglotZipPdf: d,
+  polyglotZipBaseDir: m,
+  optimization: g,
+  saxWasmLoader: y = async () => fetch(
+    `https://unpkg.com/sax-wasm@${Ri}/lib/sax-wasm.wasm`
+  ).then((w) => w.arrayBuffer()).then((w) => new Uint8Array(w)),
+  mozjpegWasmLoader: b = async () => fetch("https://unpkg.com/@jsquash/jpeg@1.5.0/codec/enc/mozjpeg_enc.wasm").then((w) => w.arrayBuffer()).then((w) => new Uint8Array(w))
+}) {
+  typeof process < "u" && zo.setMaxListeners(100, u.signal);
+  let w;
+  t ? typeof t.destroy == "function" ? (O.debug("Writing to Node writable stream"), w = new Id(t), t.on("close", () => u.abort())) : (O.debug("Writing to file system"), w = new kd(t)) : (O.debug("Writing to Blob"), w = new Un());
+  const F = new Od(w), x = {
+    fileSizeBytes: 0,
+    numPages: 0
+  };
+  let A;
+  Array.isArray(i) ? A = ($) => i.indexOf($) >= 0 : A = i;
+  let I, C;
+  typeof e == "string" ? (I = e, C = await co(I)) : (I = e["@id"] ?? e.id, C = e);
+  const S = await G.loadManifest(I, C);
+  if (!S)
+    throw new Error(`Failed to load manifest from ${I}`);
+  const E = { ...a };
+  !E.Title && S.label && (E.Title = $e(
+    S.label,
+    n,
+    "; "
+  ));
+  const _ = G.get(
+    S.items.filter(($) => A($.id))
+  ), R = !!_.find(($) => !!Qi($)), V = _.map(
+    ($) => $.label ? $e($.label, n, "; ") : ""
+  );
+  if (!yt || !Xt()) {
+    if (!yt) {
+      const $ = await y();
+      is($);
+    }
+    Xt() || (await Kn(() => Promise.resolve(yt)), O.debug.bind(O), O.info.bind(O), O.warn.bind(O), O.error.bind(O), void 0);
+  }
+  O.debug(`Setting up queue with ${l} concurrent canvas fetches.`);
+  const H = new go({ concurrency: l });
+  u.signal.addEventListener("abort", () => H.clear(), {
+    once: !0
+  });
+  const z = _.map(io), B = _.map(($, q) => H.add(async () => {
+    const ee = z[q], te = await oo($, ee.images, {
+      scaleFactor: s,
+      ppiOverride: h,
+      abortSignal: u.signal
+    });
+    return g && await Promise.all(
+      (te == null ? void 0 : te.images.map(async (L) => {
+        const de = await Lo({
+          imageData: new Uint8Array(L.data),
+          imageFormat: L.format === "jpeg" ? "image/jpeg" : "image/png",
+          ...g
+        });
+        O.debug("main: Got optimized image", L.resource.id), L.data = de.jpegData, L.format = "jpeg";
+      })) ?? []
+    ), te;
+  })), D = await wp(
+    S,
+    _,
+    n
+  ), X = new dp({
+    writer: F,
+    metadata: E,
+    canvasInfos: _.map(($, q) => ({
+      canvasIdx: q,
+      ...z[q]
+    })),
+    langPref: n,
+    pageLabels: V,
+    outline: D,
+    hasText: R,
+    initialCanvas: await ao(S),
+    readingDirection: S.viewingDirection === "right-to-left" ? "right-to-left" : "left-to-right",
+    manifestJson: C,
+    zipPolyglot: d,
+    zipBaseDir: m
+  });
+  O.debug("Initialising PDF generator."), await X.setup();
+  const W = new xp(
+    _,
+    F,
+    X,
+    o,
+    c
+  );
+  if (W.emitProgress(0), f || p) {
+    O.debug("Generating cover page"), W.emitProgress(0, "generate-cover-page");
+    try {
+      const $ = await Cp(
+        S,
+        n,
+        p,
+        f
+      );
+      O.debug("Inserting cover page into PDF"), await X.insertCoverPages($);
+    } catch ($) {
+      throw O.error("Error while generating cover page", $), u.abort(), $;
+    }
+  }
+  W.emitProgress(0, "generate-pages");
+  for (let $ = 0; $ < _.length; $++) {
+    if (u.signal.aborted) {
+      O.debug("Abort signalled, aborting while waiting for image data.");
+      break;
+    }
+    try {
+      O.debug(`Waiting for data for canvas #${$}`);
+      const q = await B[$];
+      if (!q)
+        throw "Aborted";
+      const ee = G.get(q.canvas), te = z[$], { images: L, ppi: de, text: _e, annotations: Ne, imageFailures: je } = q;
+      if (je.length > 0) {
+        x.failedImages || (x.failedImages = []);
+        const le = {
+          canvasIndex: $,
+          numFailed: je.length,
+          numTotal: L.length + je.length,
+          details: Object.fromEntries(
+            je.map((U) => [
+              U.resource.id ?? "<unknown>",
+              U.cause instanceof Error ? U.cause.toString() : U.cause
+            ])
+          )
+        };
+        x.failedImages.push(le), W.emitNotification({
+          code: "image-download-failure",
+          ...le
+        });
+      }
+      if (te.ocr && !(_e != null && _e.markup)) {
+        x.failedOcr || (x.failedOcr = []);
+        const le = {
+          canvasIndex: $,
+          ocrUrl: te.ocr.id
+        };
+        x.failedOcr.push(le), W.emitNotification({
+          code: "ocr-download-failure",
+          ...le
+        });
+      }
+      const st = await r(ee.id);
+      if (st != null) {
+        const le = await Promise.all(
+          st.map((U) => ("id" in U || (U = Sl(U)), G.load(U.id, U)))
+        );
+        le && le.filter((U) => U !== void 0).map((U) => no(U, n)).filter((U) => U !== void 0).forEach((U) => Ne.push(U));
+      }
+      const De = Ee == null ? void 0 : Ee.pageGenerationDuration.startTimer();
+      O.debug(`Rendering canvas #${$} into PDF`), await X.renderPage(
+        q.canvas.id,
+        { width: ee.width, height: ee.height },
+        [...L, ...je],
+        Ne,
+        _e,
+        de
+      ), De == null || De(), W.updatePixels(
+        L.reduce((le, U) => le + U.width * U.height, 0),
+        ee.width * ee.height
+      ), x.numPages++;
+    } catch (q) {
+      throw q !== "Aborted" && O.error("Failed to render page", q), H.clear(), u.signal.aborted || u.abort(), q;
+    } finally {
+      delete B[$];
+    }
+    W.emitProgress($ + 1);
+  }
+  O.debug("Finalizing PDF");
+  const Ae = X.end();
+  if (!u.signal.aborted) {
+    let $ = !1;
+    Ae.then(() => $ = !0);
+    const q = async () => {
+      if (!$)
+        for (W.emitProgress(_.length, "finishing"); !$ && W.writeOutstanding; )
+          await w.waitForDrain();
+    };
+    $ || (await w.waitForDrain(), await q());
+  }
+  return O.debug("Waiting for writer to close."), await Ae, x.fileSizeBytes = F.bytesWritten, w instanceof Un ? { ...x, data: w.blob } : x;
+}
+export {
+  Ho as ConsoleLogger,
+  Up as convertManifest,
+  Wp as estimatePdfSize,
+  co as fetchManifestJson,
+  Tp as setLogger,
+  G as vault,
+  ko as version
+};
+//# sourceMappingURL=index.mjs.map
diff --git a/node_modules/pdiiif/dist/index.mjs.map b/node_modules/pdiiif/dist/index.mjs.map
new file mode 100644
index 0000000..458a13e
--- /dev/null
+++ b/node_modules/pdiiif/dist/index.mjs.map
@@ -0,0 +1 @@
+{"version":3,"file":"index.mjs","sources":["../src/log.ts","../../node_modules/.pnpm/async-mutex@0.4.1/node_modules/async-mutex/index.mjs","../../node_modules/.pnpm/sax-wasm@2.2.4/node_modules/sax-wasm/lib/module/index.js","../../node_modules/.pnpm/ocr-parser@0.2.5/node_modules/ocr-parser/dist/index.js","../src/util.ts","../src/metrics.ts","../../node_modules/.pnpm/@iiif+helpers@1.3.1_@iiif+parser@2.1.8/node_modules/@iiif/helpers/dist/chunk-2I7FN7JX.js","../../node_modules/.pnpm/@iiif+parser@2.1.8/node_modules/@iiif/parser/dist/chunk-J657UVVW.js","../../node_modules/.pnpm/@iiif+parser@2.1.8/node_modules/@iiif/parser/dist/chunk-NJNTZ6QT.js","../../node_modules/.pnpm/@iiif+parser@2.1.8/node_modules/@iiif/parser/dist/chunk-D22QKJZO.js","../../node_modules/.pnpm/@iiif+parser@2.1.8/node_modules/@iiif/parser/dist/chunk-MQ6FX5SL.js","../../node_modules/.pnpm/@iiif+parser@2.1.8/node_modules/@iiif/parser/dist/upgrader.js","../../node_modules/.pnpm/@iiif+helpers@1.3.1_@iiif+parser@2.1.8/node_modules/@iiif/helpers/dist/chunk-LVD5NUFB.js","../../node_modules/.pnpm/@iiif+helpers@1.3.1_@iiif+parser@2.1.8/node_modules/@iiif/helpers/dist/chunk-CVU7FGC7.js","../../node_modules/.pnpm/@iiif+parser@2.1.8/node_modules/@iiif/parser/dist/chunk-W3DWL6UZ.js","../../node_modules/.pnpm/@iiif+parser@2.1.8/node_modules/@iiif/parser/dist/chunk-HF3WYIOE.js","../../node_modules/.pnpm/@iiif+helpers@1.3.1_@iiif+parser@2.1.8/node_modules/@iiif/helpers/dist/chunk-F2Q2OM3J.js","../../node_modules/.pnpm/@iiif+helpers@1.3.1_@iiif+parser@2.1.8/node_modules/@iiif/helpers/dist/chunk-EIMQCVDV.js","../../node_modules/.pnpm/@iiif+helpers@1.3.1_@iiif+parser@2.1.8/node_modules/@iiif/helpers/dist/chunk-YAISZCRN.js","../../node_modules/.pnpm/@iiif+helpers@1.3.1_@iiif+parser@2.1.8/node_modules/@iiif/helpers/dist/chunk-DU2KF6VF.js","../../node_modules/.pnpm/@iiif+helpers@1.3.1_@iiif+parser@2.1.8/node_modules/@iiif/helpers/dist/chunk-OFD6EF4T.js","../../node_modules/.pnpm/@iiif+helpers@1.3.1_@iiif+parser@2.1.8/node_modules/@iiif/helpers/dist/chunk-6NZ5BWVI.js","../../node_modules/.pnpm/@iiif+helpers@1.3.1_@iiif+parser@2.1.8/node_modules/@iiif/helpers/dist/chunk-G7A32JAG.js","../../node_modules/.pnpm/@iiif+helpers@1.3.1_@iiif+parser@2.1.8/node_modules/@iiif/helpers/dist/chunk-CWG5H2NE.js","../../node_modules/.pnpm/@iiif+helpers@1.3.1_@iiif+parser@2.1.8/node_modules/@iiif/helpers/dist/chunk-JVB4PJ27.js","../../node_modules/.pnpm/@iiif+helpers@1.3.1_@iiif+parser@2.1.8/node_modules/@iiif/helpers/dist/chunk-UTVB4AT4.js","../../node_modules/.pnpm/@iiif+parser@2.1.8/node_modules/@iiif/parser/dist/image-3.js","../../node_modules/.pnpm/@iiif+helpers@1.3.1_@iiif+parser@2.1.8/node_modules/@iiif/helpers/dist/chunk-4I45SZTR.js","../../node_modules/.pnpm/@iiif+helpers@1.3.1_@iiif+parser@2.1.8/node_modules/@iiif/helpers/dist/chunk-724OMJFL.js","../../node_modules/.pnpm/@iiif+helpers@1.3.1_@iiif+parser@2.1.8/node_modules/@iiif/helpers/dist/chunk-MQJNRTOE.js","../../node_modules/.pnpm/@atlas-viewer+iiif-image-api@2.2.2/node_modules/@atlas-viewer/iiif-image-api/dist/index.js","../src/iiif.ts","../src/ocr.ts","../src/download.ts","../../node_modules/.pnpm/eventemitter3@5.0.1/node_modules/eventemitter3/index.js","../../node_modules/.pnpm/p-timeout@5.1.0/node_modules/p-timeout/index.js","../../node_modules/.pnpm/p-queue@7.4.1/node_modules/p-queue/dist/lower-bound.js","../../node_modules/.pnpm/p-queue@7.4.1/node_modules/p-queue/dist/priority-queue.js","../../node_modules/.pnpm/p-queue@7.4.1/node_modules/p-queue/dist/index.js","../../node_modules/.pnpm/dedent-js@1.0.1/node_modules/dedent-js/lib/index.js","../../node_modules/.pnpm/fflate@0.8.2/node_modules/fflate/esm/browser.js","../src/pdf/util.ts","../src/pdf/common.ts","../src/io.ts","../src/pdf/png.ts","../src/pdf/image.ts","../src/pdf/parser.ts","../src/version.ts","../src/pdf/pkzip.ts","../../node_modules/.pnpm/color-name@1.1.4/node_modules/color-name/index.js","../../node_modules/.pnpm/is-arrayish@0.3.2/node_modules/is-arrayish/index.js","../../node_modules/.pnpm/simple-swizzle@0.2.2/node_modules/simple-swizzle/index.js","../../node_modules/.pnpm/color-string@1.9.1/node_modules/color-string/index.js","../../node_modules/.pnpm/color-convert@2.0.1/node_modules/color-convert/conversions.js","../../node_modules/.pnpm/color-convert@2.0.1/node_modules/color-convert/route.js","../../node_modules/.pnpm/color-convert@2.0.1/node_modules/color-convert/index.js","../../node_modules/.pnpm/color@4.2.3/node_modules/color/index.js","../../node_modules/.pnpm/sax-wasm@2.3.2/node_modules/sax-wasm/lib/esm/saxWasm.js","../src/pdf/annos.ts","../src/pdf/generator.ts","../src/res/licenses.ts","../src/optimization.ts","../src/convert.ts"],"sourcesContent":["type LogLevel = 'debug' | 'info' | 'warn' | 'error';\n\nexport interface Logger {\n  setLevel(level: LogLevel): void;\n  debug(message: string, ...args: any[]): void;\n  info(message: string, ...args: any[]): void;\n  warn(message: string, ...args: any[]): void;\n  error(message: string, ...args: any[]): void;\n}\n\n/** Simple logger that simply outputs to the console */\nexport class ConsoleLogger implements Logger {\n  private level: LogLevel;\n  constructor(level: LogLevel = 'warn') {\n    this.level = level;\n  }\n\n  setLevel(level: LogLevel): void {\n    this.level = level;\n  }\n\n  debug(message: string, ...args: any[]): void {\n    if (this.level === 'debug') {\n      console.debug(message, ...args);\n    }\n  }\n\n  info(message: string, ...args: any[]): void {\n    if (this.level !== 'error' && this.level !== 'warn') {\n      console.info(message, ...args);\n    }\n  }\n\n  warn(message: string, ...args: any[]): void {\n    if (this.level !== 'error') {\n      console.warn(message, ...args);\n    }\n  }\n\n  error(message: string, ...args: any[]): void {\n    console.error(message, ...args);\n  }\n}\n\nlet logger: Logger = new ConsoleLogger();\n\nexport function setLogger(newLogger: Logger): void {\n  logger = newLogger;\n}\n\nexport { logger as default };\n","const E_TIMEOUT = new Error('timeout while waiting for mutex to become available');\nconst E_ALREADY_LOCKED = new Error('mutex already locked');\nconst E_CANCELED = new Error('request for lock canceled');\n\nvar __awaiter$2 = (undefined && undefined.__awaiter) || function (thisArg, _arguments, P, generator) {\n    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }\n    return new (P || (P = Promise))(function (resolve, reject) {\n        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\n        function rejected(value) { try { step(generator[\"throw\"](value)); } catch (e) { reject(e); } }\n        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }\n        step((generator = generator.apply(thisArg, _arguments || [])).next());\n    });\n};\nclass Semaphore {\n    constructor(_value, _cancelError = E_CANCELED) {\n        this._value = _value;\n        this._cancelError = _cancelError;\n        this._weightedQueues = [];\n        this._weightedWaiters = [];\n    }\n    acquire(weight = 1) {\n        if (weight <= 0)\n            throw new Error(`invalid weight ${weight}: must be positive`);\n        return new Promise((resolve, reject) => {\n            if (!this._weightedQueues[weight - 1])\n                this._weightedQueues[weight - 1] = [];\n            this._weightedQueues[weight - 1].push({ resolve, reject });\n            this._dispatch();\n        });\n    }\n    runExclusive(callback, weight = 1) {\n        return __awaiter$2(this, void 0, void 0, function* () {\n            const [value, release] = yield this.acquire(weight);\n            try {\n                return yield callback(value);\n            }\n            finally {\n                release();\n            }\n        });\n    }\n    waitForUnlock(weight = 1) {\n        if (weight <= 0)\n            throw new Error(`invalid weight ${weight}: must be positive`);\n        return new Promise((resolve) => {\n            if (!this._weightedWaiters[weight - 1])\n                this._weightedWaiters[weight - 1] = [];\n            this._weightedWaiters[weight - 1].push(resolve);\n            this._dispatch();\n        });\n    }\n    isLocked() {\n        return this._value <= 0;\n    }\n    getValue() {\n        return this._value;\n    }\n    setValue(value) {\n        this._value = value;\n        this._dispatch();\n    }\n    release(weight = 1) {\n        if (weight <= 0)\n            throw new Error(`invalid weight ${weight}: must be positive`);\n        this._value += weight;\n        this._dispatch();\n    }\n    cancel() {\n        this._weightedQueues.forEach((queue) => queue.forEach((entry) => entry.reject(this._cancelError)));\n        this._weightedQueues = [];\n    }\n    _dispatch() {\n        var _a;\n        for (let weight = this._value; weight > 0; weight--) {\n            const queueEntry = (_a = this._weightedQueues[weight - 1]) === null || _a === void 0 ? void 0 : _a.shift();\n            if (!queueEntry)\n                continue;\n            const previousValue = this._value;\n            const previousWeight = weight;\n            this._value -= weight;\n            weight = this._value + 1;\n            queueEntry.resolve([previousValue, this._newReleaser(previousWeight)]);\n        }\n        this._drainUnlockWaiters();\n    }\n    _newReleaser(weight) {\n        let called = false;\n        return () => {\n            if (called)\n                return;\n            called = true;\n            this.release(weight);\n        };\n    }\n    _drainUnlockWaiters() {\n        for (let weight = this._value; weight > 0; weight--) {\n            if (!this._weightedWaiters[weight - 1])\n                continue;\n            this._weightedWaiters[weight - 1].forEach((waiter) => waiter());\n            this._weightedWaiters[weight - 1] = [];\n        }\n    }\n}\n\nvar __awaiter$1 = (undefined && undefined.__awaiter) || function (thisArg, _arguments, P, generator) {\n    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }\n    return new (P || (P = Promise))(function (resolve, reject) {\n        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\n        function rejected(value) { try { step(generator[\"throw\"](value)); } catch (e) { reject(e); } }\n        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }\n        step((generator = generator.apply(thisArg, _arguments || [])).next());\n    });\n};\nclass Mutex {\n    constructor(cancelError) {\n        this._semaphore = new Semaphore(1, cancelError);\n    }\n    acquire() {\n        return __awaiter$1(this, void 0, void 0, function* () {\n            const [, releaser] = yield this._semaphore.acquire();\n            return releaser;\n        });\n    }\n    runExclusive(callback) {\n        return this._semaphore.runExclusive(() => callback());\n    }\n    isLocked() {\n        return this._semaphore.isLocked();\n    }\n    waitForUnlock() {\n        return this._semaphore.waitForUnlock();\n    }\n    release() {\n        if (this._semaphore.isLocked())\n            this._semaphore.release();\n    }\n    cancel() {\n        return this._semaphore.cancel();\n    }\n}\n\nvar __awaiter = (undefined && undefined.__awaiter) || function (thisArg, _arguments, P, generator) {\n    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }\n    return new (P || (P = Promise))(function (resolve, reject) {\n        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\n        function rejected(value) { try { step(generator[\"throw\"](value)); } catch (e) { reject(e); } }\n        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }\n        step((generator = generator.apply(thisArg, _arguments || [])).next());\n    });\n};\nfunction withTimeout(sync, timeout, timeoutError = E_TIMEOUT) {\n    return {\n        acquire: (weight) => {\n            if (weight !== undefined && weight <= 0) {\n                throw new Error(`invalid weight ${weight}: must be positive`);\n            }\n            return new Promise((resolve, reject) => __awaiter(this, void 0, void 0, function* () {\n                let isTimeout = false;\n                const handle = setTimeout(() => {\n                    isTimeout = true;\n                    reject(timeoutError);\n                }, timeout);\n                try {\n                    const ticket = yield sync.acquire(weight);\n                    if (isTimeout) {\n                        const release = Array.isArray(ticket) ? ticket[1] : ticket;\n                        release();\n                    }\n                    else {\n                        clearTimeout(handle);\n                        resolve(ticket);\n                    }\n                }\n                catch (e) {\n                    if (!isTimeout) {\n                        clearTimeout(handle);\n                        reject(e);\n                    }\n                }\n            }));\n        },\n        runExclusive(callback, weight) {\n            return __awaiter(this, void 0, void 0, function* () {\n                let release = () => undefined;\n                try {\n                    const ticket = yield this.acquire(weight);\n                    if (Array.isArray(ticket)) {\n                        release = ticket[1];\n                        return yield callback(ticket[0]);\n                    }\n                    else {\n                        release = ticket;\n                        return yield callback();\n                    }\n                }\n                finally {\n                    release();\n                }\n            });\n        },\n        release(weight) {\n            sync.release(weight);\n        },\n        cancel() {\n            return sync.cancel();\n        },\n        waitForUnlock: (weight) => {\n            if (weight !== undefined && weight <= 0) {\n                throw new Error(`invalid weight ${weight}: must be positive`);\n            }\n            return new Promise((resolve, reject) => {\n                const handle = setTimeout(() => reject(timeoutError), timeout);\n                sync.waitForUnlock(weight).then(() => {\n                    clearTimeout(handle);\n                    resolve();\n                });\n            });\n        },\n        isLocked: () => sync.isLocked(),\n        getValue: () => sync.getValue(),\n        setValue: (value) => sync.setValue(value),\n    };\n}\n\n// eslint-disable-next-lisne @typescript-eslint/explicit-module-boundary-types\nfunction tryAcquire(sync, alreadyAcquiredError = E_ALREADY_LOCKED) {\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\n    return withTimeout(sync, 0, alreadyAcquiredError);\n}\n\nexport { E_ALREADY_LOCKED, E_CANCELED, E_TIMEOUT, Mutex, Semaphore, tryAcquire, withTimeout };\n","class SaxEventType {\n    // 1\n    static Text = 0b1;\n    // 2\n    static ProcessingInstruction = 0b10;\n    // 4\n    static SGMLDeclaration = 0b100;\n    // 8\n    static Doctype = 0b1000;\n    // 16\n    static Comment = 0b10000;\n    // 32\n    static OpenTagStart = 0b100000;\n    // 64\n    static Attribute = 0b1000000;\n    // 128\n    static OpenTag = 0b10000000;\n    // 256\n    static CloseTag = 0b100000000;\n    // 512\n    static Cdata = 0b1000000000;\n}\nclass Reader {\n    data;\n    cache = {};\n    ptr;\n    constructor(data, ptr = 0) {\n        this.data = data;\n        this.ptr = ptr;\n    }\n}\nclass Position {\n    line;\n    character;\n    constructor(line, character) {\n        this.line = line;\n        this.character = character;\n    }\n}\nvar AttributeType;\n(function (AttributeType) {\n    AttributeType[AttributeType[\"Normal\"] = 0] = \"Normal\";\n    AttributeType[AttributeType[\"JSX\"] = 1] = \"JSX\";\n})(AttributeType || (AttributeType = {}));\nclass Attribute extends Reader {\n    type;\n    name;\n    value;\n    constructor(buffer, ptr = 0) {\n        super(buffer, ptr);\n        this.type = buffer[ptr];\n        ptr += 1;\n        const len = readU32(buffer, ptr);\n        ptr += 4;\n        this.name = new Text(buffer, ptr);\n        ptr += len;\n        this.value = new Text(buffer, ptr);\n    }\n    toJSON() {\n        const { name, value, type } = this;\n        return { name, value, type };\n    }\n    toString() {\n        const { name, value } = this;\n        return `${name}=\"${value}\"`;\n    }\n}\nclass ProcInst extends Reader {\n    target;\n    content;\n    constructor(buffer, ptr = 0) {\n        super(buffer, ptr);\n        ptr += 16;\n        const len = readU32(buffer, ptr);\n        ptr += 4;\n        this.target = new Text(buffer, ptr);\n        ptr += len;\n        this.content = new Text(buffer, ptr);\n    }\n    get start() {\n        return this.cache.start || (this.cache.start = readPosition(this.data, this.ptr));\n    }\n    get end() {\n        return this.cache.end || (this.cache.end = readPosition(this.data, this.ptr + 8));\n    }\n    toJSON() {\n        const { start, end, target, content } = this;\n        return { start, end, target, content };\n    }\n    toString() {\n        const { target, content } = this;\n        return `<? ${target} ${content} ?>`;\n    }\n}\nclass Text extends Reader {\n    get start() {\n        return this.cache.start || (this.cache.start = readPosition(this.data, this.ptr));\n    }\n    get end() {\n        return this.cache.end || (this.cache.end = readPosition(this.data, this.ptr + 8));\n    }\n    get value() {\n        if (this.cache.value) {\n            return this.cache.value;\n        }\n        const valueLen = readU32(this.data, this.ptr + 16);\n        return (this.cache.value = readString(this.data, this.ptr + 20, valueLen));\n    }\n    toJSON() {\n        const { start, end, value } = this;\n        return { start, end, value };\n    }\n    toString() {\n        return this.value;\n    }\n}\nclass Tag extends Reader {\n    get openStart() {\n        return this.cache.openStart || (this.cache.openStart = readPosition(this.data, this.ptr + 8));\n    }\n    get openEnd() {\n        return this.cache.openEnd || (this.cache.openEnd = readPosition(this.data, this.ptr + 16));\n    }\n    get closeStart() {\n        return this.cache.closeStart || (this.cache.closeStart = readPosition(this.data, this.ptr + 24));\n    }\n    get closeEnd() {\n        return this.cache.closeEnd || (this.cache.closeEnd = readPosition(this.data, this.ptr + 32));\n    }\n    get selfClosing() {\n        return !!this.data[this.ptr + 40];\n    }\n    get name() {\n        if (this.cache.name) {\n            return this.cache.name;\n        }\n        const nameLen = readU32(this.data, this.ptr + 41);\n        return (this.cache.name = readString(this.data, this.ptr + 45, nameLen));\n    }\n    get attributes() {\n        if (this.cache.attributes) {\n            return this.cache.attributes;\n        }\n        // starting location of the attribute block\n        let ptr = readU32(this.data, this.ptr);\n        const numAttrs = readU32(this.data, ptr);\n        ptr += 4;\n        const attributes = [];\n        for (let i = 0; i < numAttrs; i++) {\n            const attrLen = readU32(this.data, ptr);\n            ptr += 4;\n            attributes[i] = new Attribute(this.data, ptr);\n            ptr += attrLen;\n        }\n        return (this.cache.attributes = attributes);\n    }\n    get textNodes() {\n        if (this.cache.textNodes) {\n            return this.cache.textNodes;\n        }\n        // starting location of the text nodes block\n        let ptr = readU32(this.data, this.ptr + 4);\n        const numTextNodes = readU32(this.data, ptr);\n        const textNodes = [];\n        ptr += 4;\n        for (let i = 0; i < numTextNodes; i++) {\n            const textLen = readU32(this.data, ptr);\n            ptr += 4;\n            textNodes[i] = new Text(this.data, ptr);\n            ptr += textLen;\n        }\n        return (this.cache.textNodes = textNodes);\n    }\n    toJSON() {\n        const { openStart, openEnd, closeStart, closeEnd, name, attributes, textNodes, selfClosing } = this;\n        return { openStart, openEnd, closeStart, closeEnd, name, attributes, textNodes, selfClosing };\n    }\n    get value() {\n        return this.name;\n    }\n}\nclass SAXParser {\n    static textDecoder; // Web only\n    events;\n    wasmSaxParser;\n    eventHandler;\n    options;\n    writeBuffer;\n    constructor(events = 0, options = { highWaterMark: 32 * 1024 }) {\n        this.options = options;\n        const self = this;\n        Object.defineProperties(this, {\n            events: {\n                get: () => ~~events,\n                set: (value) => {\n                    events = ~~value;\n                    if (self.wasmSaxParser) {\n                        self.wasmSaxParser.parser(events);\n                    }\n                }, configurable: false, enumerable: true\n            }\n        });\n    }\n    write(chunk) {\n        if (!this.wasmSaxParser) {\n            return;\n        }\n        const { write, memory } = this.wasmSaxParser;\n        // Allocations within the WASM process\n        // invalidate reference to the memory buffer.\n        // We check for this and create a new Uint8Array\n        // with the new memory buffer reference if needed.\n        // **NOTE** These allocations can slow down parsing\n        // if they become excessive. Consider adjusting the\n        // highWaterMark in the options up or down to find the optimal\n        // memory allocation to prevent too many new Uint8Array instances.\n        if (!this.writeBuffer || this.writeBuffer.buffer !== memory.buffer) {\n            this.writeBuffer = new Uint8Array(memory.buffer);\n        }\n        this.writeBuffer.set(chunk, 0);\n        write(0, chunk.byteLength);\n    }\n    end() {\n        this.writeBuffer = undefined;\n        this.wasmSaxParser?.end();\n    }\n    async prepareWasm(saxWasm) {\n        let result;\n        if (saxWasm instanceof Uint8Array) {\n            result = await WebAssembly.instantiate(saxWasm, {\n                env: {\n                    memoryBase: 0,\n                    tableBase: 0,\n                    memory: new WebAssembly.Memory({ initial: 10 }),\n                    table: new WebAssembly.Table({ initial: 1, element: 'anyfunc' }),\n                    event_listener: this.eventTrap\n                }\n            });\n        }\n        else {\n            result = await WebAssembly.instantiateStreaming(saxWasm);\n        }\n        if (result && typeof this.events === 'number') {\n            const { parser } = this.wasmSaxParser = result.instance.exports;\n            parser(this.events);\n            return true;\n        }\n        throw new Error(`Failed to instantiate the parser.`);\n    }\n    eventTrap = (event, ptr, len) => {\n        if (!this.wasmSaxParser) {\n            return;\n        }\n        const uint8array = new Uint8Array(this.wasmSaxParser.memory.buffer, ptr, len).slice();\n        let detail;\n        switch (event) {\n            case SaxEventType.Attribute:\n                detail = new Attribute(uint8array);\n                break;\n            case SaxEventType.ProcessingInstruction:\n                detail = new ProcInst(uint8array);\n                break;\n            case SaxEventType.OpenTag:\n            case SaxEventType.CloseTag:\n            case SaxEventType.OpenTagStart:\n                detail = new Tag(uint8array);\n                break;\n            case SaxEventType.Text:\n            case SaxEventType.Cdata:\n            case SaxEventType.Comment:\n            case SaxEventType.Doctype:\n            case SaxEventType.SGMLDeclaration:\n                detail = new Text(uint8array);\n                break;\n            default:\n                throw new Error('No reader for this event type');\n        }\n        if (this.eventHandler) {\n            this.eventHandler(event, detail);\n        }\n    };\n}\nconst readString = (data, offset, length) => {\n    // Node\n    if (globalThis.hasOwnProperty('Buffer')) {\n        return Buffer.from(data.buffer, data.byteOffset + offset, length).toString();\n    }\n    // Web\n    return (SAXParser.textDecoder || (SAXParser.textDecoder = new TextDecoder()))\n        .decode(data.subarray(offset, offset + length));\n};\nconst readU32 = (uint8Array, ptr) => (uint8Array[ptr + 3] << 24) | (uint8Array[ptr + 2] << 16) | (uint8Array[ptr + 1] << 8) | uint8Array[ptr];\nconst readPosition = (uint8Array, ptr = 0) => {\n    const line = readU32(uint8Array, ptr);\n    const character = readU32(uint8Array, ptr + 4);\n    return new Position(line, character);\n};\n\nexport { Attribute, AttributeType, Position, ProcInst, Reader, SAXParser, SaxEventType, Tag, Text };\n","// src/hocr.ts\nimport { SaxEventType as SaxEventType2 } from \"sax-wasm\";\n\n// src/model.ts\nfunction makeLine(spec) {\n  return {\n    ...spec,\n    type: \"line\",\n    children: [],\n    get words() {\n      return this.children.filter((c) => typeof c !== \"string\");\n    },\n    get text() {\n      return this.children.map((c) => typeof c === \"string\" ? c : c.text).join(\"\");\n    }\n  };\n}\nfunction makeParagraph(spec) {\n  return {\n    ...spec,\n    type: \"paragraph\",\n    children: [],\n    get lines() {\n      return this.children;\n    },\n    get words() {\n      return this.children.flatMap((l) => l.words);\n    },\n    get text() {\n      var _a;\n      const out = [];\n      for (const [idx, child] of this.children.entries()) {\n        out.push(child.text);\n        if (idx < this.children.length - 1 && !((_a = child.words.slice(-1)[0]) == null ? void 0 : _a.hyphenStart)) {\n          out.push(\" \");\n        }\n      }\n      return out.join(\"\");\n    }\n  };\n}\nfunction makeBlock(spec) {\n  return {\n    ...spec,\n    type: \"block\",\n    children: [],\n    get paragraphs() {\n      return this.children.filter((c) => \"lines\" in c);\n    },\n    get lines() {\n      return this.children.reduce((acc, c) => {\n        if (\"lines\" in c) {\n          acc.push(...c.lines);\n        } else if (\"words\" in c) {\n          acc.push(c);\n        }\n        return acc;\n      }, []);\n    },\n    get words() {\n      return this.lines.flatMap((l) => l.words);\n    },\n    get text() {\n      var _a;\n      const out = [];\n      for (const [idx, child] of this.children.entries()) {\n        out.push(child.text);\n        if (idx < this.children.length - 1 && !((_a = child.words.slice(-1)[0]) == null ? void 0 : _a.hyphenStart)) {\n          if (child.type === \"line\") {\n            out.push(\" \");\n          } else {\n            out.push(\"\\n\");\n          }\n        }\n      }\n      return out.join(\"\");\n    }\n  };\n}\nfunction makePage(spec) {\n  return {\n    ...spec,\n    type: \"page\",\n    children: [],\n    get blocks() {\n      return this.children.filter((c) => \"paragraphs\" in c);\n    },\n    get paragraphs() {\n      return this.children.reduce((acc, c) => {\n        if (\"paragraphs\" in c) {\n          acc.push(...c.paragraphs);\n        } else if (\"lines\" in c) {\n          acc.push(c);\n        }\n        return acc;\n      }, []);\n    },\n    get lines() {\n      return this.children.reduce((acc, c) => {\n        if (\"lines\" in c) {\n          acc.push(...c.lines);\n        } else if (\"words\" in c) {\n          acc.push(c);\n        }\n        return acc;\n      }, []);\n    },\n    get words() {\n      return this.children.flatMap((l) => l.words);\n    },\n    get text() {\n      var _a;\n      const out = [];\n      for (const [idx, child] of this.children.entries()) {\n        out.push(child.text);\n        if (idx < this.children.length - 1 && !((_a = child.words.slice(-1)[0]) == null ? void 0 : _a.hyphenStart)) {\n          if (child.type === \"line\") {\n            out.push(\" \");\n          } else {\n            out.push(\"\\n\");\n          }\n        }\n      }\n      return out.join(\"\");\n    }\n  };\n}\n\n// src/util.ts\nimport {\n  SAXParser,\n  SaxEventType\n} from \"sax-wasm\";\nvar SAX_WASM_VERSION = \"2.2.4\";\nvar xmlParserWasm = null;\nvar logger = {\n  debug: console.debug,\n  info: console.info,\n  warn: console.warn,\n  error: console.error\n};\nasync function initialize(loadSaxWasm = () => fetch(`https://unpkg.com/sax-wasm@${SAX_WASM_VERSION}/lib/sax-wasm.wasm`).then((res) => res.arrayBuffer()).then((buf) => new Uint8Array(buf))) {\n  xmlParserWasm = await loadSaxWasm();\n}\nfunction isInitialized() {\n  return xmlParserWasm !== null;\n}\nasync function getParser(readable, events) {\n  const parser = new StaxParser(\n    readable,\n    events != null ? events : /* @__PURE__ */ new Set([\n      SaxEventType.OpenTag,\n      SaxEventType.Text,\n      SaxEventType.CloseTag\n    ]),\n    {\n      highWaterMark: 64 * 1024\n    }\n  );\n  if (!isInitialized()) {\n    throw new Error(\n      \"XML parser WASM not initialized, call initialize() first!\"\n    );\n  }\n  const ready = await parser.prepareWasm(xmlParserWasm);\n  if (!ready) {\n    throw new Error(\"Failed to initialize parser with WASM\");\n  }\n  return parser;\n}\nvar NUMERIC_ENTITY_REGEX = /&#(\\d+);/g;\nvar HEX_ENTITY_REGEX = /&#x([A-Fa-f0-9]+);/g;\nvar ENTITY_MAP = {\n  amp: \"&\",\n  apos: \"'\",\n  quot: '\"',\n  lt: \"<\",\n  gt: \">\"\n};\nvar ENTITY_REGEX = new RegExp(\n  `&(${Object.keys(ENTITY_MAP).join(\"|\")});`,\n  \"g\"\n);\nfunction resolveXmlEntities(str) {\n  str = str.replace(ENTITY_REGEX, function(match, entity) {\n    return ENTITY_MAP[entity];\n  });\n  str = str.replace(NUMERIC_ENTITY_REGEX, function(match, entityCode) {\n    const decimalCode = parseInt(entityCode, 10);\n    return String.fromCharCode(decimalCode);\n  });\n  str = str.replace(HEX_ENTITY_REGEX, function(match, entityCode) {\n    const decimalCode = parseInt(entityCode, 16);\n    return String.fromCharCode(decimalCode);\n  });\n  return str;\n}\nfunction toReadableStream(data) {\n  const encoder = new TextEncoder();\n  return new ReadableStream({\n    start(controller) {\n      controller.enqueue(\n        data instanceof Uint8Array ? data : encoder.encode(data)\n      );\n      controller.close();\n    }\n  });\n}\nfunction getAttributeValue(tag, attrName) {\n  var _a;\n  const attr = tag.attributes.find((a) => a.name.value === attrName);\n  return (_a = attr == null ? void 0 : attr.value) == null ? void 0 : _a.value;\n}\nfunction getAllAttributes(tag) {\n  return Object.fromEntries(\n    tag.attributes.map((a) => [a.name.value, a.value.value])\n  );\n}\nvar StaxParser = class {\n  constructor(readable, events, options) {\n    this.accumulator = [];\n    this.readable = readable;\n    let eventMask;\n    if (events) {\n      eventMask = 0;\n      for (const event of events) {\n        eventMask |= event;\n      }\n    }\n    this.saxParser = new SAXParser(eventMask, options);\n    this.saxParser.eventHandler = (type, detail) => this.accumulator.push([type, detail]);\n  }\n  prepareWasm(wasm) {\n    return this.saxParser.prepareWasm(xmlParserWasm);\n  }\n  [Symbol.asyncIterator]() {\n    return this.iterate();\n  }\n  async *iterate() {\n    const reader = this.readable.getReader();\n    try {\n      while (true) {\n        const chunk = await reader.read();\n        if (chunk.done) {\n          break;\n        }\n        this.saxParser.write(chunk.value);\n        while (this.accumulator.length > 0) {\n          yield this.accumulator.shift();\n        }\n      }\n    } finally {\n      reader.releaseLock();\n    }\n    while (this.accumulator.length > 0) {\n      yield this.accumulator.shift();\n    }\n  }\n};\nfunction setupLogging(l) {\n  if (l) {\n    logger = l;\n  } else {\n    logger = {\n      debug: () => {\n      },\n      info: () => {\n      },\n      warn: () => {\n      },\n      error: console.error\n    };\n  }\n}\nfunction logWithPosition(msg, level = \"log\", tag) {\n  console[level](\n    `At line ${tag.openStart.line}, column ${tag.openStart.character}: ${msg}`\n  );\n}\n\n// src/hocr.ts\nfunction parseHocrAttribs(tag) {\n  const titleAttrib = getAttributeValue(tag, \"title\");\n  if (!titleAttrib) {\n    return {};\n  }\n  const vals = titleAttrib.split(\";\").map((x) => x.trim());\n  return vals.reduce((acc, val) => {\n    const key = val.split(\" \")[0];\n    if (key === \"bbox\") {\n      acc[key] = val.split(\" \").slice(1, 5).map((x) => Number.parseInt(x, 10));\n    } else {\n      acc[key] = val.split(\" \").slice(1, 5).join(\" \");\n      if (acc[key].startsWith('\"') && acc[key].endsWith('\"')) {\n        acc[key] = acc[key].slice(1, -1);\n      }\n    }\n    return acc;\n  }, {});\n}\nfunction parsePolygon(polyAttr, scaleFactor) {\n  return polyAttr.split(\" \").map((x) => Number.parseFloat(x)).reduce((acc, c) => {\n    const last = acc.slice(-1)[0];\n    if (!last || last.length === 2) {\n      acc.push([c]);\n    } else {\n      last.push(c);\n    }\n    return acc;\n  }, []).map(([x, y]) => ({ x: scaleFactor * x, y: scaleFactor * y }));\n}\nasync function handleChildren(eventIter, allowedTypes, ctx) {\n  let openTags = 0;\n  let result;\n  while (openTags >= 0 && !(result = await eventIter.next()).done) {\n    const [evt, data] = result.value;\n    if (evt === SaxEventType2.Text && allowedTypes.has(\"text\")) {\n      const parentElem = ctx.elementStack.slice(-1)[0];\n      if (typeof parentElem !== \"string\" && parentElem.type === \"line\") {\n        const txt = data.value.replace(/\\s+/g, \" \");\n        const whitespaceOnly = txt === \" \";\n        if ((parentElem.children.length > 0 || !whitespaceOnly) && !(parentElem.children.slice(-1)[0] === \" \" && whitespaceOnly)) {\n          parentElem.children.push(txt);\n        }\n      }\n    }\n    if (evt === SaxEventType2.CloseTag) {\n      openTags--;\n    }\n    if (evt !== SaxEventType2.OpenTag) {\n      continue;\n    }\n    openTags++;\n    const tag = data;\n    const hocrType = getHocrType(tag);\n    if (hocrType === null) {\n      continue;\n    }\n    if (!allowedTypes.has(hocrType)) {\n      logWithPosition(\n        `Unexpected hOCR element type: ${hocrType}, expected one of [${Array.from(\n          allowedTypes\n        ).join(\", \")}]`,\n        \"warn\",\n        tag\n      );\n      continue;\n    }\n    switch (hocrType) {\n      case \"block\":\n        await handleBlock(eventIter, tag, ctx);\n        openTags--;\n        break;\n      case \"paragraph\":\n        await handleParagraph(eventIter, tag, ctx);\n        openTags--;\n        break;\n      case \"line\":\n        await handleLine(eventIter, tag, ctx);\n        openTags--;\n        break;\n      case \"word\":\n        await handleWord(eventIter, tag, ctx);\n        openTags--;\n        break;\n      default:\n        break;\n    }\n  }\n  ctx.elementStack.pop();\n}\nasync function handlePage(eventIter, tag, ctx, referenceSize) {\n  var _a;\n  const hocrAttribs = parseHocrAttribs(tag);\n  const pageSize = hocrAttribs.bbox;\n  ctx.scaleFactor = referenceSize ? determineScaleFactor(pageSize, referenceSize) : 1;\n  const page = makePage({\n    features: [],\n    width: pageSize[2] * ctx.scaleFactor,\n    height: pageSize[3] * ctx.scaleFactor\n  });\n  if (\"ppageno\" in hocrAttribs) {\n    page.physicalPageNumber = Number.parseInt(hocrAttribs.ppageno, 10);\n  }\n  if (\"lpageno\" in hocrAttribs) {\n    page.logicalPageNumber = hocrAttribs.lpageno;\n  }\n  if (\"image\" in hocrAttribs) {\n    page.imageSource = {\n      fileName: hocrAttribs.image\n    };\n  }\n  if (\"x_source\" in hocrAttribs) {\n    if (!page.imageSource) {\n      page.imageSource = {};\n    }\n    page.imageSource.documentIdentifier = hocrAttribs.x_source;\n  }\n  if (\"imagemd5\" in hocrAttribs) {\n    if (!page.imageSource) {\n      page.imageSource = {};\n    }\n    page.imageSource.checksum = hocrAttribs.imagemd5;\n    page.imageSource.checksumType = \"MD5\";\n  }\n  if (\"scan_res\" in hocrAttribs) {\n    if (!page.imageSource) {\n      page.imageSource = {};\n    }\n    page.imageSource.ppi = Number.parseInt(hocrAttribs.scan_res.split(\" \")[0], 10);\n  }\n  ctx.elementStack.push(page);\n  await handleChildren(\n    eventIter,\n    /* @__PURE__ */ new Set([\"block\", \"paragraph\", \"line\"]),\n    ctx\n  );\n  for (const elem of [\"blocks\", \"paragraphs\", \"lines\"]) {\n    if (((_a = page[elem]) != null ? _a : []).some((e) => e.polygon !== void 0)) {\n      page.features.push(\"POLYGONS\");\n    }\n  }\n  if (page.words.some((w) => w.choices !== void 0)) {\n    page.features.push(\"CHOICES\");\n  }\n  if (page.words.some((w) => w.hyphenStart)) {\n    page.features.push(\"HYPHEN\");\n  }\n  if (page.words.some((w) => w.confidence !== void 0)) {\n    page.features.push(\"CONFIDENCE\");\n  }\n  return page;\n}\nasync function handleBlock(eventIter, tag, ctx) {\n  const hocrAttribs = parseHocrAttribs(tag);\n  const [ulx, uly, lrx, lry] = hocrAttribs.bbox.map(\n    (dim) => dim * ctx.scaleFactor\n  );\n  const block = makeBlock({\n    x: ulx,\n    y: uly,\n    width: lrx - ulx,\n    height: lry - uly\n  });\n  if (\"poly\" in hocrAttribs) {\n    block.polygon = parsePolygon(hocrAttribs.poly, ctx.scaleFactor);\n  }\n  ctx.elementStack.slice(-1)[0].children.push(block);\n  ctx.elementStack.push(block);\n  await handleChildren(eventIter, /* @__PURE__ */ new Set([\"paragraph\", \"line\"]), ctx);\n}\nasync function handleParagraph(eventIter, tag, ctx) {\n  const hocrAttribs = parseHocrAttribs(tag);\n  let x;\n  let y;\n  let width;\n  let height;\n  if (hocrAttribs.bbox) {\n    const coords = hocrAttribs.bbox.map(\n      (dim) => dim * ctx.scaleFactor\n    );\n    x = coords[0];\n    y = coords[1];\n    width = coords[2] - x;\n    height = coords[3] - y;\n  }\n  const paragraph = makeParagraph({\n    x,\n    y,\n    width,\n    height\n  });\n  if (\"poly\" in hocrAttribs) {\n    paragraph.polygon = parsePolygon(hocrAttribs.poly, ctx.scaleFactor);\n  }\n  const parentElem = ctx.elementStack.slice(-1)[0];\n  parentElem.children.push(paragraph);\n  ctx.elementStack.push(paragraph);\n  await handleChildren(eventIter, /* @__PURE__ */ new Set([\"line\"]), ctx);\n}\nasync function handleLine(eventIter, tag, ctx) {\n  const parsedAttribs = parseHocrAttribs(tag);\n  if (!(\"bbox\" in parsedAttribs)) {\n    logWithPosition(\"Missing bbox attribute on line element\", \"warn\", tag);\n    return;\n  }\n  const [ulx, uly, lrx, lry] = parsedAttribs.bbox.map(\n    (dim) => dim * ctx.scaleFactor\n  );\n  const line = makeLine({\n    x: ulx,\n    y: uly,\n    width: lrx - ulx,\n    height: lry - uly\n  });\n  if (\"poly\" in parsedAttribs) {\n    line.polygon = parsePolygon(parsedAttribs.poly, ctx.scaleFactor);\n  }\n  if (\"baseline\" in parsedAttribs) {\n    const parts = parsedAttribs.baseline.split(\" \");\n    const slope = Number.parseFloat(parts[0]);\n    const intercept = Number.parseInt(parts[1], 10);\n    const ulx2 = line.x;\n    const uly2 = line.y;\n    line.baseline = [\n      { x: ulx2, y: uly2 + intercept },\n      { x: ulx2 + line.width, y: uly2 + intercept + line.width * slope }\n    ];\n  }\n  const parentElem = ctx.elementStack.slice(-1)[0];\n  parentElem.children.push(line);\n  ctx.elementStack.push(line);\n  await handleChildren(eventIter, /* @__PURE__ */ new Set([\"word\", \"text\"]), ctx);\n  if (line.children.slice(-1)[0] === \" \") {\n    line.children = line.children.slice(0, -1);\n  }\n  const needsNormalization = line.words.some(\n    (w) => w.confidence !== void 0 && w.confidence > 1\n  );\n  if (needsNormalization) {\n    for (const word of line.words) {\n      if (word.confidence !== void 0) {\n        word.confidence /= 100;\n      }\n    }\n  }\n}\nasync function handleWord(eventIter, tag, ctx) {\n  const parsedAttribs = parseHocrAttribs(tag);\n  const [ulx, uly, lrx, lry] = parsedAttribs.bbox.map(\n    (dim) => dim * ctx.scaleFactor\n  );\n  let wordText = \"\";\n  let wordChoices;\n  let openTags = 0;\n  while (openTags >= 0) {\n    const result = await eventIter.next();\n    if (result.done) {\n      throw new Error(\"Unexpected end of stream while parsing word\");\n    }\n    const [evt, data] = result.value;\n    if (evt === SaxEventType2.OpenTag) {\n      openTags++;\n      const tag2 = data;\n      if (tag2.name === \"span\" && getHocrType(tag2) === \"alternatives\") {\n        wordChoices = [];\n      }\n    } else if (evt === SaxEventType2.CloseTag) {\n      openTags--;\n      const tag2 = data;\n      if (wordChoices && tag2.name === \"ins\") {\n        wordText = tag2.textNodes.map((t) => t.value.trim()).join(\"\");\n      } else if (wordChoices && tag2.name === \"del\") {\n        const nlp = getAttributeValue(tag2, \"nlp\");\n        const choice = {\n          text: tag2.textNodes.map((t) => t.value.trim()).join(\"\")\n        };\n        if (choice.text.includes(\"&\")) {\n          choice.text = resolveXmlEntities(choice.text);\n        }\n        if (nlp) {\n          choice.probability = Math.exp(-Number.parseFloat(nlp));\n        }\n        wordChoices.push(choice);\n      }\n    } else if (evt === SaxEventType2.Text && !wordChoices) {\n      const txt = data.value;\n      wordText += txt.trim();\n    }\n  }\n  if (!wordText.length) {\n    logWithPosition(\"Word element has no text, skipping.\", \"debug\", tag);\n    return;\n  }\n  const word = {\n    type: \"word\",\n    x: ulx,\n    y: uly,\n    width: lrx - ulx,\n    height: lry - uly,\n    text: wordText\n  };\n  if (wordChoices == null ? void 0 : wordChoices.length) {\n    word.choices = wordChoices;\n  }\n  word.hyphenStart = word.text.endsWith(\"\\xAD\");\n  if (word.hyphenStart) {\n    word.text = word.text.slice(0, -1);\n  }\n  if (word.text.includes(\"&\")) {\n    word.text = resolveXmlEntities(word.text);\n  }\n  if (\"poly\" in parsedAttribs) {\n    word.polygon = parsePolygon(parsedAttribs.poly, ctx.scaleFactor);\n  }\n  if (\"x_wconf\" in parsedAttribs) {\n    word.confidence = Number.parseFloat(parsedAttribs.x_wconf);\n  }\n  ctx.elementStack.slice(-1)[0].children.push(word);\n}\nfunction determineScaleFactor(pageSize, referenceSize) {\n  if (pageSize[2] === referenceSize.width && pageSize[3] === referenceSize.height) {\n    return 1;\n  }\n  const scaleFactorX = referenceSize.width / pageSize[2];\n  const scaleFactorY = referenceSize.height / pageSize[3];\n  const scaledWidth = Math.round(scaleFactorY * pageSize[2]);\n  const scaledHeight = Math.round(scaleFactorX * pageSize[3]);\n  if (scaledWidth !== referenceSize.width || scaledHeight !== referenceSize.height) {\n    console.warn(\n      `Differing scale factors for x and y axis while parsing hOCR, will use X factor: x=${scaleFactorX}, y=${scaleFactorY}`\n    );\n  }\n  return scaleFactorX;\n}\nfunction getHocrType(tag) {\n  const hocrType = getAttributeValue(tag, \"class\");\n  switch (hocrType) {\n    case \"ocr_page\":\n      return \"page\";\n    case \"ocr_carea\":\n    case \"ocrx_block\":\n      return \"block\";\n    case \"ocr_par\":\n      return \"paragraph\";\n    case \"ocr_line\":\n    case \"ocrx_line\":\n      return \"line\";\n    case \"ocrx_word\":\n      return \"word\";\n    case \"ocrx_cinfo\":\n      return \"char\";\n    case \"alternatives\":\n      return \"alternatives\";\n    case \"alt\":\n      return \"alt\";\n    default:\n      return null;\n  }\n}\nasync function* parseHocrPages(hocr, referenceSizes) {\n  var _a;\n  if (Array.isArray(referenceSizes)) {\n    const sizeArr = referenceSizes;\n    referenceSizes = (idx) => {\n      var _a2;\n      return (_a2 = sizeArr[idx]) != null ? _a2 : null;\n    };\n  }\n  const readable = typeof hocr === \"string\" || hocr instanceof Uint8Array ? toReadableStream(hocr) : hocr;\n  const parser = await getParser(readable);\n  const ctx = {\n    scaleFactor: 1,\n    elementStack: []\n  };\n  let pageIdx = 0;\n  const eventIter = parser.iterate();\n  let result;\n  while (!(result = await eventIter.next()).done) {\n    const [evt, data] = result.value;\n    if (evt !== SaxEventType2.OpenTag || data.name !== \"div\" || getHocrType(data) !== \"page\") {\n      continue;\n    }\n    const page = await handlePage(\n      eventIter,\n      data,\n      ctx,\n      (_a = referenceSizes == null ? void 0 : referenceSizes(pageIdx, getAllAttributes(data))) != null ? _a : void 0\n    );\n    if (!page) {\n      continue;\n    }\n    yield page;\n  }\n}\n\n// src/alto.ts\nimport { SaxEventType as SaxEventType3 } from \"sax-wasm\";\nvar NUMERIC_ATTRIBS = [\"HEIGHT\", \"WIDTH\", \"HPOS\", \"VPOS\", \"WC\"];\nfunction getAttributes(data, names) {\n  return Object.fromEntries(\n    data.attributes.filter((attr) => !names || names.includes(attr.name.value)).map((attr) => [\n      attr.name.value,\n      NUMERIC_ATTRIBS.includes(attr.name.value) ? Number.parseFloat(attr.value.value) : attr.value.value\n    ])\n  );\n}\nfunction getCoordinates(data) {\n  const attrs = getAttributes(data, [\"HEIGHT\", \"WIDTH\", \"HPOS\", \"VPOS\"]);\n  return {\n    height: attrs.HEIGHT,\n    width: attrs.WIDTH,\n    x: attrs.HPOS,\n    y: attrs.VPOS\n  };\n}\nasync function handlePage2(eventIter, ctx, tag, referenceSize) {\n  var _a;\n  const dims = getCoordinates(tag);\n  if (!dims.width || !dims.height) {\n    throw new Error(\"Could not get Page dimensions\");\n  }\n  const scaleFactorX = referenceSize ? referenceSize.width / dims.width : 1;\n  const scaleFactorY = referenceSize ? referenceSize.height / dims.height : 1;\n  if (scaleFactorX !== scaleFactorY) {\n    console.warn(\n      `Scale factors differ: x=${scaleFactorX} vs y=${scaleFactorY}, using X scale factor.`\n    );\n  }\n  ctx.scaleFactor = scaleFactorX;\n  const page = makePage({\n    features: [],\n    width: dims.width * scaleFactorX,\n    height: dims.height * scaleFactorX\n  });\n  ctx.elementStack.push(page);\n  const pageAttribs = getAllAttributes(tag);\n  if (\"PHYSICAL_IMG_NR\" in pageAttribs) {\n    page.physicalPageNumber = Number.parseInt(pageAttribs.PHYSICAL_IMG_NR);\n  }\n  if (\"PRINTED_IMG_NR\" in pageAttribs) {\n    page.logicalPageNumber = pageAttribs.PRINTED_IMG_NR;\n  }\n  let openTags = 0;\n  let result;\n  while (openTags >= 0 && !(result = await eventIter.next()).done) {\n    const [evt, data] = result.value;\n    if (evt === SaxEventType3.CloseTag) {\n      openTags--;\n    } else if (evt !== SaxEventType3.OpenTag) {\n      continue;\n    }\n    openTags++;\n    const tag2 = data;\n    if (tag2.name === \"TextBlock\") {\n      await handleBlock2(eventIter, ctx, data);\n    }\n  }\n  ctx.elementStack.pop();\n  for (const elem of [\"blocks\", \"paragraphs\", \"lines\"]) {\n    if (((_a = page[elem]) != null ? _a : []).some((e) => e.polygon !== void 0)) {\n      page.features.push(\"POLYGONS\");\n    }\n  }\n  if (page.words.some((w) => w.choices !== void 0)) {\n    page.features.push(\"CHOICES\");\n  }\n  if (page.words.some((w) => w.hyphenStart)) {\n    page.features.push(\"HYPHEN\");\n  }\n  if (page.words.some((w) => w.confidence !== void 0)) {\n    page.features.push(\"CONFIDENCE\");\n  }\n  if (ctx.sourceImageInformation) {\n    page.imageSource = ctx.sourceImageInformation;\n    ctx.sourceImageInformation = void 0;\n  }\n  return page;\n}\nasync function handleBlock2(eventIter, ctx, tag) {\n  const dims = getCoordinates(tag);\n  const block = makeBlock({\n    x: dims.x ? dims.x * ctx.scaleFactor : -1,\n    y: dims.y ? dims.y * ctx.scaleFactor : -1,\n    width: dims.width ? dims.width * ctx.scaleFactor : -1,\n    height: dims.height ? dims.height * ctx.scaleFactor : -1\n  });\n  ctx.elementStack.slice(-1)[0].children.push(block);\n  ctx.elementStack.push(block);\n  let openTags = 0;\n  let result;\n  while (openTags >= 0 && !(result = await eventIter.next()).done) {\n    const [evt, data] = result.value;\n    if (evt === SaxEventType3.CloseTag) {\n      openTags--;\n    } else if (evt !== SaxEventType3.OpenTag) {\n      continue;\n    }\n    openTags++;\n    const tag2 = data;\n    if (tag2.name === \"TextLine\") {\n      await handleLine2(eventIter, ctx, data);\n    } else if (tag2.name === \"Shape\") {\n      const polygon = await handleShape(eventIter, ctx, tag2);\n      if (polygon != null) {\n        block.polygon = polygon;\n      }\n    }\n  }\n  ctx.elementStack.pop();\n}\nasync function handleLine2(eventIter, ctx, tag) {\n  const dims = getCoordinates(tag);\n  const line = makeLine({\n    x: dims.x ? dims.x * ctx.scaleFactor : -1,\n    y: dims.y ? dims.y * ctx.scaleFactor : -1,\n    width: dims.width ? dims.width * ctx.scaleFactor : -1,\n    height: dims.height ? dims.height * ctx.scaleFactor : -1\n  });\n  ctx.elementStack.slice(-1)[0].children.push(line);\n  ctx.elementStack.push(line);\n  let openTags = 0;\n  let result;\n  while (openTags >= 0 && !(result = await eventIter.next()).done) {\n    const [evt, data] = result.value;\n    if (evt === SaxEventType3.CloseTag) {\n      openTags--;\n    }\n    if (evt !== SaxEventType3.OpenTag) {\n      continue;\n    }\n    openTags++;\n    const tag2 = data;\n    if (tag2.name === \"String\") {\n      await handleWord2(eventIter, ctx, data);\n      openTags--;\n    } else if (tag2.name === \"SP\") {\n      line.children.push(\" \");\n    } else if (tag2.name === \"Shape\") {\n      const polygon = await handleShape(eventIter, ctx, tag2);\n      if (polygon != null) {\n        line.polygon = polygon;\n      }\n    }\n  }\n  ctx.elementStack.pop();\n  if (!line.children.find((c) => c === \" \")) {\n    line.children = line.children.flatMap(\n      (c, i) => i === line.children.length - 1 ? [c] : [c, \" \"]\n    );\n  }\n}\nasync function handleShape(eventIter, ctx, tag) {\n  let polygon = null;\n  let openTags = 0;\n  let result;\n  while (openTags >= 0 && !(result = await eventIter.next()).done) {\n    const [evt, data] = result.value;\n    if (evt === SaxEventType3.CloseTag) {\n      openTags--;\n    }\n    if (evt !== SaxEventType3.OpenTag) {\n      continue;\n    }\n    openTags++;\n    const tag2 = data;\n    if (tag2.name === \"Polygon\") {\n      const points = getAttributeValue(tag2, \"POINTS\");\n      if (!points) {\n        logWithPosition(\n          \"<Polygon> without POINTS attribute, ignoring\",\n          \"warn\",\n          tag2\n        );\n        continue;\n      }\n      polygon = points.split(\" \").map((p) => p.split(/(,| )/).map((c) => Number.parseFloat(c))).reduce((acc, [c]) => {\n        const lastElem = acc.slice(-1)[0];\n        if (!lastElem || lastElem.length === 2) {\n          acc.push([c]);\n        } else {\n          lastElem.push(c);\n        }\n        return acc;\n      }, []).map(([x, y]) => ({ x: x * ctx.scaleFactor, y: y * ctx.scaleFactor }));\n    }\n  }\n  const parent = ctx.elementStack.slice(-1)[0];\n  if (parent.x < 0 || parent.y < 0 || parent.width < 0 || parent.height < 0) {\n    if (polygon) {\n      parent.x = Math.min(...polygon.map((p) => p.x));\n      parent.y = Math.min(...polygon.map((p) => p.y));\n      parent.width = Math.max(...polygon.map((p) => p.x)) - parent.x;\n      parent.height = Math.max(...polygon.map((p) => p.y)) - parent.y;\n    } else {\n      throw new Error(\n        `Could not get dimensions for ${parent.type}, no HPOS/VPOS/WIDTH/HEIGHT attribs and no associated Shape`\n      );\n    }\n  }\n  return polygon;\n}\nasync function handleWord2(eventIter, ctx, tag) {\n  const dims = getCoordinates(tag);\n  let text = getAttributeValue(tag, \"CONTENT\");\n  if (!text) {\n    throw new Error(\"Could not get String text\");\n  }\n  if (text.includes(\"&\")) {\n    text = resolveXmlEntities(text);\n  }\n  const word = {\n    type: \"word\",\n    x: dims.x ? dims.x * ctx.scaleFactor : -1,\n    y: dims.y ? dims.y * ctx.scaleFactor : -1,\n    width: dims.width ? dims.width * ctx.scaleFactor : -1,\n    height: dims.height ? dims.height * ctx.scaleFactor : -1,\n    text\n  };\n  ctx.elementStack.push(word);\n  const subsType = getAttributeValue(tag, \"SUBS_TYPE\");\n  if (subsType === \"HypPart1\") {\n    word.hyphenStart = true;\n  }\n  const wordConfidence = getAttributeValue(tag, \"WC\");\n  if (wordConfidence !== void 0) {\n    word.confidence = Number.parseFloat(wordConfidence);\n  }\n  let openTags = 0;\n  let result;\n  while (openTags >= 0 && !(result = await eventIter.next()).done) {\n    const [evt, data] = result.value;\n    if (evt === SaxEventType3.CloseTag) {\n      openTags--;\n      if (data.name === \"ALTERNATIVE\") {\n        if (!(\"choices\" in word)) {\n          word.choices = [];\n        }\n        let altText = data.textNodes.filter((t) => t.value.trim() !== \"\").map((t) => t.value.trim()).join(\"\");\n        if (altText.includes(\"&\")) {\n          altText = resolveXmlEntities(altText);\n        }\n        word.choices.push({\n          text: altText\n        });\n      }\n    } else if (evt === SaxEventType3.OpenTag) {\n      openTags++;\n      if (data.name === \"Shape\") {\n        const polygon = await handleShape(eventIter, ctx, tag);\n        openTags--;\n        if (polygon != null) {\n          word.polygon = polygon;\n        }\n      }\n    }\n  }\n  const line = ctx.elementStack.slice(-2)[0];\n  line.children.push(word);\n  ctx.elementStack.pop();\n}\nasync function handleSourceImageInformation(eventIter, ctx, _tag) {\n  let openTags = 0;\n  let result;\n  ctx.sourceImageInformation = {};\n  while (openTags >= 0 && !(result = await eventIter.next()).done) {\n    const [evt, data] = result.value;\n    const tag = data;\n    if (evt === SaxEventType3.CloseTag) {\n      openTags--;\n      if (tag.name === \"fileName\") {\n        ctx.sourceImageInformation.fileName = tag.textNodes.map((t) => t.value).join(\"\");\n      } else if (tag.name === \"fileIdentifier\") {\n        let ident = tag.textNodes.map((t) => t.value).join(\"\");\n        const location = getAttributeValue(tag, \"fileIdentifierLocation\");\n        if (location) {\n          ident = `${location}:${ident}`;\n        }\n        ctx.sourceImageInformation.fileIdentifier = ident;\n      } else if (tag.name === \"documentIdentifier\") {\n        let ident = tag.textNodes.map((t) => t.value).join(\"\");\n        const location = getAttributeValue(tag, \"documentIdentifierLocation\");\n        if (location) {\n          ident = `${location}:${ident}`;\n        }\n        ctx.sourceImageInformation.documentIdentifier = ident;\n      }\n    } else if (evt === SaxEventType3.OpenTag) {\n      openTags++;\n    }\n  }\n}\nasync function* parseAltoPages(alto, referenceSizes) {\n  var _a;\n  if (Array.isArray(referenceSizes)) {\n    const sizeArr = referenceSizes;\n    referenceSizes = (idx) => {\n      var _a2;\n      return (_a2 = sizeArr[idx]) != null ? _a2 : null;\n    };\n  }\n  const readable = typeof alto === \"string\" || alto instanceof Uint8Array ? toReadableStream(alto) : alto;\n  const parser = await getParser(readable);\n  const ctx = {\n    scaleFactor: 1,\n    elementStack: []\n  };\n  const eventIter = parser.iterate();\n  let result;\n  let pageIdx = 0;\n  while (!(result = await eventIter.next()).done) {\n    const [evt, data] = result.value;\n    if (evt === SaxEventType3.CloseTag && data.name === \"MeasurementUnit\") {\n      const unit = data.textNodes[0].value.trim();\n      if (unit !== \"pixel\" && !referenceSizes) {\n        throw new Error(`Measurement unit ${unit} requires a reference size.`);\n      }\n    }\n    if (evt !== SaxEventType3.OpenTag) {\n      continue;\n    }\n    const tag = data;\n    if (tag.name === \"Page\") {\n      const page = await handlePage2(\n        eventIter,\n        ctx,\n        data,\n        (_a = referenceSizes == null ? void 0 : referenceSizes(pageIdx, getAllAttributes(data))) != null ? _a : void 0\n      );\n      if (page) {\n        yield page;\n        pageIdx++;\n      }\n    } else if (tag.name === \"sourceImageInformation\") {\n      await handleSourceImageInformation(eventIter, ctx, tag);\n    }\n  }\n}\n\n// src/index.ts\nasync function parseOcrPage(markup, format, referenceSize) {\n  if (!isInitialized()) {\n    throw new Error(\n      \"XML parser WASM not initialized, call initialize() first!\"\n    );\n  }\n  let page;\n  if (format === \"hocr\") {\n    page = (await parseHocrPages(\n      markup,\n      referenceSize ? [referenceSize] : void 0\n    ).next()).value;\n  } else if (format === \"alto\") {\n    page = (await parseAltoPages(\n      markup,\n      referenceSize ? [referenceSize] : void 0\n    ).next()).value;\n  } else {\n    throw new Error(`Unsupported format: ${format}`);\n  }\n  if (!page) {\n    throw new Error(\"Failed to parse page\");\n  }\n  return page;\n}\nasync function* parseOcrPages(markup, format, referenceSizes) {\n  if (!isInitialized()) {\n    throw new Error(\n      \"XML parser WASM not initialized, call initialize() first!\"\n    );\n  }\n  if (!(markup instanceof ReadableStream)) {\n    markup = toReadableStream(markup);\n  }\n  switch (format) {\n    case \"hocr\":\n      yield* parseHocrPages(markup, referenceSizes);\n      break;\n    case \"alto\":\n      yield* parseAltoPages(markup, referenceSizes);\n      break;\n  }\n}\nexport {\n  SAX_WASM_VERSION,\n  initialize,\n  isInitialized,\n  parseAltoPages,\n  parseHocrPages,\n  parseOcrPage,\n  parseOcrPages,\n  setupLogging\n};\n//# sourceMappingURL=index.js.map","export let saxParserWasm: Uint8Array | null = null;\n\n/** Get a timestamp in milliseconds, prefereably high-resolution */\nexport function now(): number {\n  if (typeof window !== 'undefined' && window.performance) {\n    return window.performance.now();\n  } else {\n    return Date.now();\n  }\n}\n\nexport function isDefined<T>(val: T | undefined | null | void): val is T {\n  return val != undefined && val !== null && val !== void 0;\n}\n\nconst CRC_TABLE = (() => {\n  const t = new Int32Array(256);\n  for (let i = 0; i < 256; ++i) {\n    let c = i, k = 9;\n    while (--k) c = ((c & 1) && -306674912) ^ (c >>> 1);\n    t[i] = c;\n  }\n  return t;\n})();\n\nexport function crc32(data: Uint8Array): number {\n  let c = -1;\n  for (let i = 0; i < data.length; ++i) {\n    c = CRC_TABLE[(c & 255) ^ data[i]] ^ (c >>> 8);\n  }\n  return ~c;\n}\n\nexport function runningInNode(): boolean {\n  return typeof process !== 'undefined' && typeof process.versions?.node !== 'undefined';\n}\n\nexport function initializeSaxParser(parserWasm: Uint8Array): void {\n  saxParserWasm = parserWasm;\n}\n\nexport function randomUUIDv4() {\n  if (typeof crypto !== 'undefined' && crypto.randomUUID) {\n    return crypto.randomUUID();\n  }\n\n  return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {\n    if (c !== 'x') {\n      return c;\n    }\n    const randomInteger = (Math.random() * 16) | 0;\n    const encoded = (randomInteger & 0x3) | 0x8;\n    return encoded.toString(16);\n  });\n}\n","import type { Histogram } from 'prom-client';\nimport prometheus from 'prom-client';\n\nimport { runningInNode } from './util.js';\n\ntype Metrics =\n  | {\n      pageGenerationDuration: Histogram<string>;\n      imageFetchDuration: Histogram<string>;\n      imageInfoDuration: Histogram<string>;\n      ocrFetchDuration: Histogram<string>;\n    }\n  | undefined;\n\nlet metrics: Metrics;\n\n// Prometheus metrics are only defined when running in node\nif (runningInNode()) {\n  metrics = {\n    pageGenerationDuration: new prometheus.Histogram({\n      name: 'pdiiif_page_generation_duration_seconds',\n      help: 'Latency for generating the PDF for a single page',\n      buckets: [0.001, 0.005, 0.015, 0.05, 0.1, 0.5, 1, 2],\n      labelNames: ['status'],\n    }),\n    imageFetchDuration: new prometheus.Histogram({\n      name: 'pdiiif_image_fetch_duration_seconds',\n      help: 'Latency for fetching data from IIIF Image API endpoints',\n      buckets: [0.01, 0.05, 0.15, 0.5, 1, 5, 10],\n      labelNames: ['status', 'iiif_host', 'limited'],\n    }),\n    imageInfoDuration: new prometheus.Histogram({\n      name: 'pdiiif_image_info_duration_seconds',\n      help: 'Latency for fetching info from IIIF Image API endpoints',\n      buckets: [0.01, 0.05, 0.15, 0.5, 1, 5, 10],\n      labelNames: ['status', 'iiif_host', 'limited'],\n    }),\n    ocrFetchDuration: new prometheus.Histogram({\n      name: 'pdiiif_ocr_fetch_duration_seconds',\n      help: 'Latency for fetching OCR data',\n      buckets: [0.01, 0.05, 0.15, 0.5, 1, 5, 10],\n      labelNames: ['status', 'ocr_host', 'limited'],\n    }),\n  };\n}\n\nexport default metrics;\n","// node_modules/.pnpm/zustand@4.5.2_react@18.2.0/node_modules/zustand/esm/vanilla.mjs\nvar createStoreImpl = (createState) => {\n  let state;\n  const listeners = /* @__PURE__ */ new Set();\n  const setState = (partial, replace) => {\n    const nextState = typeof partial === \"function\" ? partial(state) : partial;\n    if (!Object.is(nextState, state)) {\n      const previousState = state;\n      state = (replace != null ? replace : typeof nextState !== \"object\" || nextState === null) ? nextState : Object.assign({}, state, nextState);\n      listeners.forEach((listener) => listener(state, previousState));\n    }\n  };\n  const getState = () => state;\n  const getInitialState = () => initialState;\n  const subscribe = (listener) => {\n    listeners.add(listener);\n    return () => listeners.delete(listener);\n  };\n  const destroy = () => {\n    if ((import.meta.env ? import.meta.env.MODE : void 0) !== \"production\") {\n      console.warn(\n        \"[DEPRECATED] The `destroy` method will be unsupported in a future version. Instead use unsubscribe function returned by subscribe. Everything will be garbage-collected if store is garbage-collected.\"\n      );\n    }\n    listeners.clear();\n  };\n  const api = { setState, getState, getInitialState, subscribe, destroy };\n  const initialState = state = createState(setState, getState, api);\n  return api;\n};\nvar createStore = (createState) => createState ? createStoreImpl(createState) : createStoreImpl;\n\nexport {\n  createStore\n};\n","var e=\"http://library.stanford.edu/iiif/image-api/compliance.html#level0\",i=\"http://library.stanford.edu/iiif/image-api/compliance.html#level1\",t=\"http://library.stanford.edu/iiif/image-api/compliance.html#level2\",o=\"http://library.stanford.edu/iiif/image-api/conformance.html#level0\",r=\"http://library.stanford.edu/iiif/image-api/conformance.html#level1\",a=\"http://library.stanford.edu/iiif/image-api/conformance.html#level2\",_=\"http://library.stanford.edu/iiif/image-api/1.1/compliance.html#level0\",I=\"http://library.stanford.edu/iiif/image-api/1.1/compliance.html#level1\",l=\"http://library.stanford.edu/iiif/image-api/1.1/compliance.html#level2\",p=\"http://library.stanford.edu/iiif/image-api/1.1/conformance.html#level0\",s=\"http://library.stanford.edu/iiif/image-api/1.1/conformance.html#level1\",n=\"http://library.stanford.edu/iiif/image-api/1.1/conformance.html#level2\",E=\"http://iiif.io/api/image/1/level0.json\",c=\"http://iiif.io/api/image/1/profiles/level0.json\",F=\"http://iiif.io/api/image/1/level1.json\",m=\"http://iiif.io/api/image/1/profiles/level1.json\",f=\"http://iiif.io/api/image/1/level2.json\",x=\"http://iiif.io/api/image/1/profiles/level2.json\",A=\"http://iiif.io/api/image/2/level0.json\",L=\"http://iiif.io/api/image/2/profiles/level0.json\",h=\"http://iiif.io/api/image/2/level1.json\",y=\"http://iiif.io/api/image/2/profiles/level1.json\",d=\"http://iiif.io/api/image/2/level2.json\",g=\"http://iiif.io/api/image/2/profiles/level2.json\",M=\"level0\",O=\"level1\",v=\"level2\",u=\"http://iiif.io/api/image/2/level0\",N=\"http://iiif.io/api/image/2/level1\",G=\"http://iiif.io/api/image/2/level2\",R=[G,t,a,l,n,f,x,d,g,v],C=[...R,N,i,r,I,s,F,m,h,y,O],B=[u,N,G,e,i,t,o,r,a,_,I,l,p,s,n,E,c,F,m,f,x,A,L,h,y,d,g,M,O,v],P=B,S=[u,e,o,_,p,E,c,A,L,M],z={extraFormats:[\"jpg\"],extraQualities:[\"default\"],extraFeatures:[\"sizeByWhListed\"]},b={extraFormats:[\"jpg\"],extraQualities:[\"default\"],extraFeatures:[\"baseUriRedirect\",\"cors\",\"jsonldMediaType\",\"regionByPx\",\"regionSquare\",\"sizeByWhListed\",\"sizeByH\",\"sizeByW\",\"sizeByWh\"]},j={extraFormats:[\"jpg\",\"png\"],extraQualities:[\"default\"],extraFeatures:[\"baseUriRedirect\",\"cors\",\"jsonldMediaType\",\"regionByPct\",\"regionByPx\",\"regionSquare\",\"rotationBy90s\",\"sizeByWhListed\",\"sizeByConfinedWh\",\"sizeByH\",\"sizeByPct\",\"sizeByW\",\"sizeByWh\"]},V=[\"baseUriRedirect\",\"canonicalLinkHeader\",\"cors\",\"jsonldMediaType\",\"mirroring\",\"profileLinkHeader\",\"regionByPct\",\"regionByPx\",\"regionSquare\",\"rotationArbitrary\",\"rotationBy90s\",\"sizeByConfinedWh\",\"sizeByH\",\"sizeByPct\",\"sizeByW\",\"sizeByWh\",\"sizeUpscaling\",\"sizeByWhListed\",\"sizeByDistortedWh\",\"sizeByForcedWh\"];export{e as a,i as b,t as c,o as d,r as e,a as f,_ as g,I as h,l as i,p as j,s as k,n as l,E as m,c as n,F as o,m as p,f as q,x as r,A as s,L as t,h as u,y as v,d as w,g as x,M as y,O as z,v as A,u as B,N as C,G as D,R as E,C as F,B as G,P as H,S as I,z as J,b as K,j as L,V as M};\n","function r(e){for(let n in e)(typeof e[n]>\"u\"||e[n]===null)&&delete e[n];return e}function i(e){return Array.isArray(e)?e:e?[e]:[]}export{i as a,r as b};\n","var d=Object.defineProperty;var e=(b,a,c)=>a in b?d(b,a,{enumerable:!0,configurable:!0,writable:!0,value:c}):b[a]=c;var f=(b,a,c)=>(e(b,typeof a!=\"symbol\"?a+\"\":a,c),c);export{f as a};\n","import{E as C,H as A}from\"./chunk-J657UVVW.js\";import{a as m,b as o}from\"./chunk-NJNTZ6QT.js\";import{a as v}from\"./chunk-D22QKJZO.js\";var I=[\"sc:Collection\",\"sc:Manifest\",\"sc:Canvas\",\"sc:AnnotationList\",\"oa:Annotation\",\"sc:Range\",\"sc:Layer\",\"sc:Sequence\",\"oa:Choice\",\"Service\",\"ContentResource\"];function S(t){if(typeof t>\"u\"||t===null)throw new Error(\"Null or undefined is not a valid entity.\");if(Array.isArray(t))throw new Error(\"Array is not a valid entity\");if(typeof t!=\"object\")throw new Error(`${typeof t} is not a valid entity`);if(typeof t[\"@type\"]==\"string\"){let e=I.indexOf(t[\"@type\"]);if(e!==-1)return I[e]}if(t.profile)return\"Service\";if(t.format||t[\"@type\"])return\"ContentResource\";throw new Error(\"Resource type is not known\")}var u=class t{constructor(e,n={}){v(this,\"traversals\");v(this,\"options\");this.traversals={collection:[],manifest:[],canvas:[],annotationList:[],sequence:[],annotation:[],contentResource:[],choice:[],range:[],service:[],layer:[],...e},this.options={convertPropsToArray:!0,mergeMemberProperties:!0,allowUndefinedReturn:!1,...n}}static all(e){return new t({collection:[e],manifest:[e],canvas:[e],annotationList:[e],sequence:[e],annotation:[e],contentResource:[e],choice:[e],range:[e],service:[e],layer:[e]})}traverseCollection(e){return this.traverseType(this.traverseDescriptive(this.traverseLinking(this.traverseCollectionItems(e))),this.traversals.collection)}traverseCollectionItems(e){if(this.options.mergeMemberProperties){let n=[...(e.manifests||[]).map(i=>typeof i==\"string\"?{\"@id\":i,\"@type\":\"sc:Manifest\"}:i),...(e.collections||[]).map(i=>typeof i==\"string\"?{\"@id\":i,\"@type\":\"sc:Collection\"}:i),...e.members||[]];delete e.collections,delete e.manifests,e.members=n}return e.manifests&&(e.manifests=e.manifests.map(n=>this.traverseManifest(typeof n==\"string\"?{\"@id\":n,\"@type\":\"sc:Manifest\"}:n))),e.collections&&(e.collections=e.collections.map(n=>this.traverseCollection(typeof n==\"string\"?{\"@id\":n,\"@type\":\"sc:Collection\"}:n))),e.members&&(e.members=e.members.map(n=>typeof n==\"string\"?n:this.traverseUnknown(n))),e}traverseManifest(e){return this.traverseType(this.traverseDescriptive(this.traverseLinking(this.traverseManifestItems(e))),this.traversals.manifest)}traverseManifestItems(e){return e.sequences&&(e.sequences=e.sequences.map(n=>this.traverseSequence(n))),e.structures&&(e.structures=e.structures.map(n=>this.traverseRange(n))),e}traverseSequence(e){return this.traverseType(this.traverseDescriptive(this.traverseLinking(this.traverseSequenceItems(e))),this.traversals.sequence)}traverseSequenceItems(e){return e.canvases&&(e.canvases=e.canvases.map(n=>this.traverseCanvas(n))),e}traverseCanvas(e){return this.traverseType(this.traverseDescriptive(this.traverseLinking(this.traverseCanvasItems(e))),this.traversals.canvas)}traverseCanvasItems(e){return e.images&&(e.images=e.images.map(n=>this.traverseAnnotation(n))),e.otherContent&&(e.otherContent=e.otherContent.map(n=>this.traverseAnnotationList(n))),e}traverseRange(e){return this.traverseType(this.traverseDescriptive(this.traverseLinking(this.traverseRangeItems(e))),this.traversals.range)}traverseRangeItems(e){if(this.options.mergeMemberProperties){let n=[...(e.ranges||[]).map(i=>typeof i==\"string\"?{\"@id\":i,\"@type\":\"sc:Range\"}:i),...(e.canvases||[]).map(i=>typeof i==\"string\"?{\"@id\":i,\"@type\":\"sc:Canvas\"}:i),...e.members||[]];delete e.ranges,delete e.canvases,e.members=n.length?n.map(i=>this.traverseUnknown(i)):void 0}return e}traverseAnnotationList(e){let n=typeof e==\"string\"?{\"@id\":e,\"@type\":\"sc:AnnotationList\"}:e;return this.traverseType(this.traverseDescriptive(this.traverseAnnotationListItems(n)),this.traversals.annotationList)}traverseAnnotationListItems(e){return e.resources&&(e.resources=e.resources.map(n=>this.traverseAnnotation(n))),e}traverseAnnotation(e){return this.traverseType(this.traverseDescriptive(this.traverseLinking(this.traverseAnnotationItems(e))),this.traversals.annotation)}traverseAnnotationItems(e){return e.resource&&(Array.isArray(e.resource)?e.resource=e.resource.map(n=>this.traverseContentResource(n)):e.resource=this.traverseContentResource(e.resource)),e.on,e}traverseLayer(e){return this.traverseType(this.traverseLinking(this.traverseLayerItems(e)),this.traversals.layer)}traverseLayerItems(e){return e.otherContent&&(e.otherContent=e.otherContent.map(n=>this.traverseAnnotationList(n))),e}traverseChoice(e){return this.traverseType(this.traverseChoiceItems(e),this.traversals.choice)}traverseChoiceItems(e){return e.default&&e.default!==\"rdf:nil\"&&(e.default=this.traverseContentResource(e.default)),e.item&&e.item!==\"rdf:nil\"&&(e.item=e.item.map(n=>this.traverseContentResource(n))),e}traverseService(e){return this.traverseType(this.traverseLinking(e),this.traversals.service)}traverseContentResource(e){return e[\"@type\"]===\"oa:Choice\"?this.traverseChoice(e):this.traverseType(this.traverseDescriptive(this.traverseLinking(e)),this.traversals.contentResource)}traverseUnknown(e){if(!e[\"@type\"]||typeof e==\"string\")return e;switch(S(e)){case\"sc:Collection\":return this.traverseCollection(e);case\"sc:Manifest\":return this.traverseManifest(e);case\"sc:Canvas\":return this.traverseCanvas(e);case\"sc:Sequence\":return this.traverseSequence(e);case\"sc:Range\":return this.traverseRange(e);case\"oa:Annotation\":return this.traverseAnnotation(e);case\"sc:AnnotationList\":return this.traverseAnnotationList(e);case\"sc:Layer\":return this.traverseLayer(e);case\"Service\":return this.traverseService(e);case\"oa:Choice\":return this.traverseChoice(e);case\"ContentResource\":return this.traverseContentResource(e)}return e.profile?this.traverseService(e):e}traverseImageResource(e){let n=Array.isArray(e),i=Array.isArray(e)?e:[e],a=[];for(let r of i)typeof r==\"string\"?a.push(this.traverseContentResource({\"@id\":r,\"@type\":\"dctypes:Image\"})):a.push(this.traverseContentResource(r));return!n&&!this.options.convertPropsToArray?a[0]:a}traverseDescriptive(e){return e.thumbnail&&(e.thumbnail=this.traverseImageResource(e.thumbnail)),e.logo&&(e.logo=this.traverseImageResource(e.logo)),e}traverseOneOrMoreServices(e){let n=Array.isArray(e),i=Array.isArray(e)?e:[e],a=[];for(let r of i)a.push(this.traverseService(r));return!n&&!this.options.convertPropsToArray?a[0]:a}traverseLinking(e){return e.related&&(e.related=this.traverseOneOrManyType(e.related,this.traversals.contentResource)),e.rendering&&(e.rendering=this.traverseOneOrManyType(e.rendering,this.traversals.contentResource)),e.service&&(e.service=this.traverseOneOrMoreServices(e.service)),e.seeAlso&&(e.seeAlso=this.traverseOneOrManyType(e.seeAlso,this.traversals.contentResource)),e.within&&(typeof e.within==\"string\"||(e.within=this.traverseOneOrManyType(e.within,this.traversals.contentResource))),e.startCanvas&&(typeof e.startCanvas==\"string\"?e.startCanvas=this.traverseType({\"@id\":e.startCanvas,\"@type\":\"sc:Canvas\"},this.traversals.canvas):e.startCanvas&&this.traverseType(e.startCanvas,this.traversals.canvas)),e.contentLayer&&(typeof e.contentLayer==\"string\"?e.contentLayer=this.traverseLayer({\"@id\":e.contentLayer,\"@type\":\"sc:Layer\"}):e.contentLayer=this.traverseLayer(e.contentLayer)),e}traverseOneOrManyType(e,n){if(!Array.isArray(e))if(this.options.convertPropsToArray)e=[e];else return this.traverseType(e,n);return e.map(i=>this.traverseType(i,n))}traverseType(e,n){return n.reduce((i,a)=>{let r=a(i);return typeof r>\"u\"&&!this.options.allowUndefinedReturn?i:r},e)}};var M=\"http://library.stanford.edu/iiif/image-api/compliance.html#level1\",O=\"http://library.stanford.edu/iiif/image-api/compliance.html#level2\";var b=\"http://library.stanford.edu/iiif/image-api/conformance.html#level1\",w=\"http://library.stanford.edu/iiif/image-api/conformance.html#level2\";var F=\"http://library.stanford.edu/iiif/image-api/1.1/compliance.html#level1\",D=\"http://library.stanford.edu/iiif/image-api/1.1/compliance.html#level2\";var N=\"http://library.stanford.edu/iiif/image-api/1.1/conformance.html#level1\",k=\"http://library.stanford.edu/iiif/image-api/1.1/conformance.html#level2\";var j=\"http://iiif.io/api/image/1/level1.json\",G=\"http://iiif.io/api/image/1/profiles/level1.json\",q=\"http://iiif.io/api/image/1/level2.json\",V=\"http://iiif.io/api/image/1/profiles/level2.json\";var U=\"http://iiif.io/api/image/2/level1.json\",$=\"http://iiif.io/api/image/2/profiles/level1.json\",W=\"http://iiif.io/api/image/2/level2.json\",B=\"http://iiif.io/api/image/2/profiles/level2.json\";var H=\"level1\",J=\"level2\";var z=\"http://iiif.io/api/image/2/level1\",K=\"http://iiif.io/api/image/2/level2\",P=[z,K,M,O,b,w,F,D,N,k,j,G,q,V,U,$,W,B,H,J];var d={attributionLabel:\"Attribution\",lang:\"none\",providerId:\"http://example.org/provider\",providerName:\"Unknown\"};function Q(t){if(typeof t==\"string\")return[t];if(!t)return[];let e=Array.isArray(t)?t:[t],n=[];for(let i of e){if(typeof i==\"string\"){n.push(i);continue}n.push({\"@language\":i[\"@language\"]||i.language,\"@value\":i[\"@value\"]||i.value})}return n}function h(t,e=\"none\"){if(!t)return{none:[\"\"]};let n=Q(t),i={};for(let a of n){if(typeof a==\"string\"){i[e]=i[e]?i[e]:[],i[e].push(a||\"\");continue}if(!a[\"@language\"]){i[e]=i[e]?i[e]:[],i[e].push(a[\"@value\"]||\"\");continue}let r=a[\"@language\"];i[r]=i[r]?i[r]:[],i[r].push(a[\"@value\"]||\"\")}return Object.keys(i).length===0?{none:[\"\"]}:i}function L(t){if(Array.isArray(t))return L(t.find(e=>typeof e==\"string\"));if(C.indexOf(t)!==-1)return\"level2\";if(P.indexOf(t)!==-1)return\"level1\";if(A.indexOf(t)!==-1)return\"level0\";if(typeof t==\"string\")return t}function X(t){let e=Array.isArray(t)?t:[t];for(let n of e)switch(n){case\"http://iiif.io/api/image/2/context.json\":case\"http://library.stanford.edu/iiif/image-api/1.1/compliance.html#level2\":return\"ImageService2\";case\"http://iiif.io/api/image/1/context.json\":case\"http://library.stanford.edu/iiif/image-api/1.1/context.json\":return\"ImageService1\";case\"http://iiif.io/api/annex/openannotation/context.json\":return\"ImageApiSelector\"}}function Y(t){switch(t){case\"http://iiif.io/api/image/2/level0.json\":case\"http://iiif.io/api/image/2/level1.json\":case\"http://iiif.io/api/image/2/level2.json\":return\"ImageService2\";case\"http://iiif.io/api/auth/1/kiosk\":case\"http://iiif.io/api/auth/1/login\":case\"http://iiif.io/api/auth/1/clickthrough\":case\"http://iiif.io/api/auth/1/external\":case\"http://iiif.io/api/auth/0/kiosk\":case\"http://iiif.io/api/auth/0/login\":case\"http://iiif.io/api/auth/0/clickthrough\":case\"http://iiif.io/api/auth/0/external\":return\"AuthCookieService1\";case\"http://iiif.io/api/auth/1/token\":case\"http://iiif.io/api/auth/0/token\":return\"AuthTokenService1\";case\"http://iiif.io/api/auth/1/logout\":case\"http://iiif.io/api/auth/0/logout\":return\"AuthLogoutService1\";case\"http://iiif.io/api/search/1/search\":case\"http://iiif.io/api/search/0/search\":return\"SearchService1\";case\"http://iiif.io/api/search/1/autocomplete\":case\"http://iiif.io/api/search/0/autocomplete\":return\"AutoCompleteService1\"}}function _(t){for(let e of[\"sc\",\"oa\",\"dcterms\",\"dctypes\",\"iiif\"])if(t.startsWith(`${e}:`))return t.slice(e.length+1);return t}var Z=[\"Collection\",\"Manifest\",\"Annotation\",\"AnnotationPage\",\"Range\",\"Service\"];function g(t){let e=t[\"@id\"]||t.id,n=t[\"@type\"]||t.type,i=t.profile||void 0,a=t[\"@context\"]||void 0;if(i){let r=Y(i);if(r)return r}if(a){let r=X(a);if(r)return r}if(n){if(Array.isArray(n)){if(n.indexOf(\"oa:CssStylesheet\")!==-1)return\"CssStylesheet\";if(n.indexOf(\"cnt:ContentAsText\")!==-1)return\"TextualBody\";n=n[0]}for(let r of[\"sc\",\"oa\",\"dcterms\",\"dctypes\",\"iiif\"])if(n.startsWith(`${r}:`)){n=n.slice(r.length+1);break}switch(n){case\"Layer\":return\"AnnotationCollection\";case\"AnnotationList\":return\"AnnotationPage\";case\"cnt:ContentAsText\":return\"TextualBody\"}}if(n&&Z.indexOf(n)!==-1)return n;if(t.format){if(t.format.startsWith(\"image/\"))return\"Image\";if(t.format.startsWith(\"text/\")||t.format===\"application/pdf\")return\"Text\";if(t.format.startsWith(\"application/\"))return\"Dataset\"}return e&&(e.endsWith(\".jpg\")||e.endsWith(\".png\")||e.endsWith(\".jpeg\"))?\"Image\":n||\"unknown\"}var ee=/http(s)?:\\/\\/(creativecommons.org|rightsstatements.org)[^\"'\\\\<\\n]+/gm;function te(t){let e=t.match(ee);return e?e[0]:t}function ne(t,e=\"Rights/License\",n=\"none\"){let i=null,a=[],r=Array.isArray(t)?t:[t];for(let s of r){let c=s?te(s):void 0;if(c&&(c.indexOf(\"creativecommons.org\")!==-1||c.indexOf(\"rightsstatements.org\")!==-1)){c.startsWith(\"https://\")?i=`http://${c.slice(8)}`:i=c;continue}c&&a.push({label:{[n]:[e]},value:{[n]:[c]}})}return[i,a]}var ie=[\"http://iiif.io/api/presentation/2/context.json\",\"http://iiif.io/api/image/2/context.json\",\"http://iiif.io/api/image/1/context.json\",\"http://library.stanford.edu/iiif/image-api/1.1/context.json\",\"http://iiif.io/api/search/1/context.json\",\"http://iiif.io/api/search/0/context.json\",\"http://iiif.io/api/auth/1/context.json\",\"http://iiif.io/api/auth/0/context.json\",\"http://iiif.io/api/annex/openannotation/context.json\"];function re(t){if(t){let e=Array.isArray(t)?t:[t],n=[];for(let i of e)i===\"http://iiif.io/api/presentation/2/context.json\"&&n.push(\"http://iiif.io/api/presentation/3/context.json\"),ie.indexOf(i)===-1&&n.push(i);if(e.length)return n.length===1?n[0]:n}}function ae(t){return t?t.map(e=>({label:h(e.label),value:h(e.value)})):[]}var R=0;function x(t,e){let n=encodeURI(t.id||t[\"@id\"]||\"\").trim();return n&&e?`${n}/${e}`:n||(R++,`http://example.org/${t[\"@type\"]}${e?`/${e}`:\"\"}/${R}`)}function p(t){let e=[...t.behavior||[]];t.viewingHint&&e.push(t.viewingHint);let n;return Array.isArray(t.motivation)?n=t.motivation.map(_):t.motivation&&(n=_(t.motivation)),{\"@context\":t[\"@context\"]?re(t[\"@context\"]):void 0,id:(t[\"@id\"]||x(t)).trim(),type:g(t),behavior:e.length?e:void 0,height:t.height?t.height:void 0,width:t.width?t.width:void 0,motivation:n,viewingDirection:t.viewingDirection,profile:t.profile,format:t.format?t.format:void 0,duration:void 0,timeMode:void 0}}function f(t){let[e,n]=ne(t.license),i=[...t.metadata?ae(t.metadata):[],...n];return{rights:e,metadata:i.length?i:void 0,label:t.label?h(t.label):void 0,requiredStatement:t.attribution?{label:h(d.attributionLabel),value:h(t.attribution)}:void 0,navDate:t.navDate,summary:t.description?h(t.description):void 0,thumbnail:se(t.thumbnail)}}function se(t){return t&&(Array.isArray(t)?t:[t]).map(n=>typeof n==\"string\"?{id:n,type:\"Image\"}:(n.type===\"unknown\"&&(n.type=\"Image\"),n))}function oe(t){if(!t.within)return;let e=Array.isArray(t.within)?t.within:[t.within],n=[];for(let i of e)if(typeof i==\"string\"){if(i)switch(t[\"@type\"]){case\"sc:Manifest\":n.push({id:i,type:\"Collection\"});break}}else i[\"@id\"]&&n.push({id:i[\"@id\"],type:g(i)});return n.length?n:void 0}function l(t){let e=t.related?Array.isArray(t.related)?t.related:[t.related]:[],n=t.contentLayer;return{provider:t.logo||e.length?[{id:d.providerId,type:\"Agent\",homepage:e.length?[e[0]]:void 0,logo:t.logo?Array.isArray(t.logo)?t.logo:[t.logo]:void 0,label:h(d.providerName)}]:void 0,partOf:oe(t),rendering:t.rendering,seeAlso:t.seeAlso,start:t.startCanvas,service:t.service?m(t.service):void 0,supplementary:n?[n]:void 0}}function pe(t){return{chars:t.chars,format:t.format?t.format:void 0,language:t.language}}function fe(t){return o({...p(t),...f(t),...l(t),items:t.members})}function ce(t){let e=[],n=[],i,a;for(let s of t.sequences||[])console.log(s),s.canvases.length&&e.push(...s.canvases),s.behavior&&n.push(...s.behavior),s.viewingDirection&&(a=s.viewingDirection),s.startCanvas&&(i=s.startCanvas);let r=p(t);return n.length&&(r.behavior?r.behavior.push(...n):r.behavior=n),o({...r,...f(t),...l(t),viewingDirection:a,start:i,items:e,structures:le(t.structures)})}function le(t){if(!t)return t;let e=new Map;for(let i of t)e.set(i.id,i);let n=[];for(let i of t)if(i.items){let a=i.items.map(r=>typeof r==\"string\"?(n.push(r),e.get(r)||r):r&&r.id?(n.push(r.id),e.get(r.id)||r):r);i.items=a}return t.filter(i=>n.indexOf(i.id)===-1)}function he(t){return o({...p(t),...f(t),...l(t),annotations:t.otherContent&&t.otherContent.length?t.otherContent:void 0,items:t.images&&t.images.length?[{id:x(t,\"annotation-page\"),type:\"AnnotationPage\",items:t.images}]:void 0})}function ue(t){return o({...p(t),...f(t),...l(t),items:t.resources&&t.resources.length?t.resources:void 0})}function ve(t){return!t.canvases||t.canvases.length===0?{canvases:[],behavior:[]}:{canvases:t.canvases,behavior:t.viewingHint?[t.viewingHint]:[],viewingDirection:t.viewingDirection,startCanvas:t.startCanvas}}function de(t){function e(n){if(Array.isArray(n)){if(n.length>1)return{type:\"List\",items:n.map(e)};n=n[0]}if(typeof n==\"string\")return encodeURI(n).trim();if(\"@type\"in n){let i;if(typeof n.full==\"string\")i=n.full;else if(n.full[\"@type\"]===\"dctypes:Image\")i={id:n.full[\"@id\"],type:\"Image\"};else if(n.full[\"@type\"]===\"sc:Canvas\")i={id:n.full[\"@id\"],type:\"Canvas\"};else throw new Error(`Unsupported source type on annotation: ${n.full[\"@type\"]}`);return{type:\"SpecificResource\",source:i,selector:y(n.selector)}}else return encodeURI(n[\"@id\"]).trim()}return o({...p(t),...f(t),...l(t),target:e(t.on),body:Array.isArray(t.resource)?t.resource.map(T):T(t.resource)})}function T(t){return t.type===\"Choice\"?t:E(t)}function E(t){let e=t;return o({...p(e),...f(e),...l(e),...pe(e)})}function ye(t){let e=[];return t.default&&t.default!==\"rdf:nil\"&&e.push(t.default),t.item&&t.item!==\"rdf:nil\"&&e.push(...t.item),o({...p(t),...f(t),items:e})}function ge(t){return o({...p(t),...f(t),...l(t),items:t.members})}function me(t){let{\"@id\":e,\"@type\":n,\"@context\":i,profile:a,...r}=t,s={};return e&&(s[\"@id\"]=e),s[\"@type\"]=g(t),s[\"@type\"]===\"unknown\"&&(i&&i.length&&(s[\"@context\"]=i),s[\"@type\"]=\"Service\"),a&&(s.profile=L(a)),o({...s,...r})}function Ce(t){return o({...p(t),...f(t),...l(t)})}var Ae=new u({collection:[fe],manifest:[ce],canvas:[he],annotationList:[ue],sequence:[ve],annotation:[de],contentResource:[E],choice:[ye],range:[ge],service:[me],layer:[Ce]});function Me(t){return t&&t[\"@context\"]&&(t[\"@context\"]===\"http://iiif.io/api/presentation/2/context.json\"||t[\"@context\"].indexOf(\"http://iiif.io/api/presentation/2/context.json\")!==-1||t[\"@context\"]===\"http://www.shared-canvas.org/ns/context.json\")||t[\"@context\"]===\"http://iiif.io/api/image/2/context.json\"?Ae.traverseUnknown(t):t}function y(t){if((Array.isArray(t[\"@type\"])&&t[\"@type\"].includes(\"oa:SvgSelector\")||t[\"@type\"]==\"oa:SvgSelector\")&&(\"chars\"in t||\"value\"in t))return{type:\"SvgSelector\",value:\"chars\"in t?t.chars:t.value};if(t[\"@type\"]===\"oa:FragmentSelector\")return{type:\"FragmentSelector\",value:t.value};if(t[\"@type\"]===\"oa:Choice\")return[y(t.default),...(Array.isArray(t.item)?t.item:[t.item]).map(y)];if(t[\"@type\"]==\"iiif:ImageApiSelector\")return{type:\"ImageApiSelector\",region:\"region\"in t?t.region:void 0,rotation:\"rotation\"in t?t.rotation:void 0};throw new Error(`Unsupported selector type: ${t[\"@type\"]}`)}export{I as a,S as b,u as c,h as d,L as e,X as f,Ae as g,Me as h};\n","import{h as o}from\"./chunk-MQ6FX5SL.js\";import\"./chunk-J657UVVW.js\";import\"./chunk-NJNTZ6QT.js\";import\"./chunk-D22QKJZO.js\";var t=o;export{t as upgrade};\n","// src/compat.ts\nvar metaState = {};\nvar compatVault = {\n  get(nonRef) {\n    return nonRef;\n  },\n  setMetaValue([id, meta, key], value) {\n    const oldValue = compatVault.getResourceMeta(id, meta);\n    const oldValueItem = oldValue ? oldValue[key] : void 0;\n    const newValue = typeof value === \"function\" ? value(oldValueItem) : value;\n    metaState[id] = {\n      ...metaState[id] || {},\n      [meta]: {\n        ...(metaState[id] || {})[meta] || {},\n        [key]: newValue\n      }\n    };\n  },\n  getResourceMeta: (resource, metaKey) => {\n    const resourceMeta = metaState[resource];\n    if (!resourceMeta) {\n      return void 0;\n    }\n    if (!metaKey) {\n      return resourceMeta;\n    }\n    return resourceMeta[metaKey];\n  },\n  async load(id) {\n    const idToLoad = typeof id === \"string\" ? id : id.id;\n    return fetch(idToLoad).then((response) => response.json());\n  },\n  requestStatus(id) {\n    return void 0;\n  }\n};\n\nexport {\n  compatVault\n};\n","import {\n  compatVault\n} from \"./chunk-LVD5NUFB.js\";\n\n// src/painting-annotations/parse-specific-resource.ts\nfunction parseSpecificResource(resource) {\n  if (resource.type === \"SpecificResource\") {\n    return [resource.source, { selector: resource.selector }];\n  }\n  return [resource, { selector: null }];\n}\n\n// src/painting-annotations/helper.ts\nfunction createPaintingAnnotationsHelper(vault = compatVault) {\n  function getAllPaintingAnnotations(canvasOrId) {\n    const canvas = canvasOrId ? typeof canvasOrId === \"string\" ? vault.get(canvasOrId) : canvasOrId : null;\n    if (!canvas) {\n      return [];\n    }\n    const annotationPages = vault.get(canvas.items, { parent: canvas });\n    const flatAnnotations = [];\n    for (const page of annotationPages) {\n      flatAnnotations.push(...vault.get(page.items, { parent: page }));\n    }\n    return flatAnnotations;\n  }\n  function getPaintables(paintingAnnotationsOrCanvas, enabledChoices = []) {\n    const paintingAnnotations = Array.isArray(paintingAnnotationsOrCanvas) ? paintingAnnotationsOrCanvas : getAllPaintingAnnotations(paintingAnnotationsOrCanvas);\n    const types = [];\n    let choices = {\n      items: [],\n      type: \"complex-choice\"\n    };\n    const items = [];\n    for (const annotation of paintingAnnotations) {\n      if (annotation.type !== \"Annotation\") {\n        throw new Error(`getPaintables() accept either a canvas or list of annotations`);\n      }\n      const references = Array.from(Array.isArray(annotation.body) ? annotation.body : [annotation.body]);\n      for (const reference of references) {\n        const [ref, { selector }] = parseSpecificResource(reference);\n        const body = vault.get(ref);\n        const type = (body.type || \"unknown\").toLowerCase();\n        if (type === \"choice\") {\n          const nestedBodies = vault.get(body.items, { parent: body.id });\n          const selected = enabledChoices.length ? enabledChoices.map((cid) => nestedBodies.find((b) => b.id === cid)).filter(Boolean) : [nestedBodies[0]];\n          if (selected.length === 0) {\n            selected.push(nestedBodies[0]);\n          }\n          choices.items.push({\n            type: \"single-choice\",\n            items: nestedBodies.map((b) => ({\n              id: b.id,\n              label: b.label,\n              selected: selected.indexOf(b) !== -1\n            })),\n            label: ref.label\n          });\n          references.push(...selected);\n          continue;\n        }\n        if (types.indexOf(type) === -1) {\n          types.push(type);\n        }\n        items.push({\n          type,\n          annotationId: annotation.id,\n          annotation,\n          resource: body,\n          target: annotation.target,\n          selector\n        });\n      }\n    }\n    return {\n      types,\n      items,\n      choice: choices.items.length < 2 ? choices.items[0] || null : choices,\n      allChoices: choices.items.length ? choices : null\n    };\n  }\n  function extractChoices(paintingAnnotationsOrCanvas) {\n    const { choice } = getPaintables(paintingAnnotationsOrCanvas);\n    return choice;\n  }\n  return {\n    getAllPaintingAnnotations,\n    getPaintables,\n    extractChoices\n  };\n}\n\nexport {\n  parseSpecificResource,\n  createPaintingAnnotationsHelper\n};\n","import{a as i}from\"./chunk-NJNTZ6QT.js\";import{a as r}from\"./chunk-D22QKJZO.js\";function v(a){return typeof a==\"string\"?!1:a&&!a.type&&\"source\"in a?(a.type=\"SpecificResource\",!0):!!a&&a.type===\"SpecificResource\"}function o(...a){return e=>a.reduce((t,n)=>n(t),e)}var p=[\"Collection\",\"Manifest\",\"Canvas\",\"AnnotationPage\",\"AnnotationCollection\",\"Annotation\",\"ContentResource\",\"Range\",\"Service\",\"Selector\",\"Agent\"];function y(a,e){if(typeof a>\"u\"||a===null)throw new Error(\"Null or undefined is not a valid entity.\");if(Array.isArray(a))throw new Error(\"Array is not a valid entity\");if(typeof a!=\"object\"){if(e)return e;throw new Error(`${typeof a} is not a valid entity`)}if(typeof a.type==\"string\"){let t=p.indexOf(a.type);if(t!==-1)return p[t]}if(a.profile)return\"Service\";throw new Error(\"Resource type is not known\")}var l=class a{constructor(e,t={}){r(this,\"traversals\");r(this,\"options\");r(this,\"_traverseManifest\",o(this.traverseManifestItems.bind(this),this.traverseLinking.bind(this),this.traverseDescriptive.bind(this),this.traverseLinkedCanvases.bind(this),this.traverseManifestStructures.bind(this),this.traverseInlineAnnotationPages.bind(this)));r(this,\"_traverseCanvas\",o(this.traverseCanvasItems.bind(this),this.traverseLinking.bind(this),this.traverseDescriptive.bind(this),this.traverseLinkedCanvases.bind(this),this.traverseInlineAnnotationPages.bind(this)));r(this,\"_traverseAnnotationPage\",o(this.traverseAnnotationPageItems.bind(this),this.traverseLinking.bind(this),this.traverseDescriptive.bind(this)));r(this,\"_traverseRange\",o(this.traverseRangeRanges.bind(this),this.traverseLinking.bind(this),this.traverseDescriptive.bind(this),this.traverseLinkedCanvases.bind(this)));this.traversals={collection:[],manifest:[],canvas:[],annotationCollection:[],annotationPage:[],annotation:[],contentResource:[],choice:[],range:[],service:[],agent:[],specificResource:[],geoJson:[],...e},this.options={allowUndefinedReturn:!1,...t}}static all(e){return new a({collection:[e],manifest:[e],canvas:[e],annotationCollection:[e],annotationPage:[e],annotation:[e],contentResource:[e],choice:[e],range:[e],service:[e],geoJson:[e],specificResource:[e],agent:[e]})}traverseDescriptive(e){return e.thumbnail&&(e.thumbnail=i(e.thumbnail).map(t=>this.traverseType(t,{parent:e},this.traversals.contentResource))),e.provider&&(e.provider=e.provider.map(t=>this.traverseAgent(t,e))),e}traverseLinking(e){return e.seeAlso&&(e.seeAlso=e.seeAlso.map(t=>this.traverseType(t,{parent:e},this.traversals.contentResource))),e.service&&(e.service=i(e.service).map(t=>this.traverseService(t))),e.services&&(e.services=i(e.services).map(t=>this.traverseService(t,e))),e.logo&&(e.logo=e.logo.map(t=>this.traverseType(t,{parent:e},this.traversals.contentResource))),e.homepage&&(e.homepage=i(e.homepage).map(t=>this.traverseType(t,{parent:e},this.traversals.contentResource))),e.partOf&&(e.partOf=e.partOf.map(t=>typeof t==\"string\"||!t.type?this.traverseType(t,{parent:e},this.traversals.contentResource):t.type===\"Canvas\"?this.traverseType(t,{parent:e},this.traversals.canvas):t.type===\"AnnotationCollection\"?this.traverseType(t,{parent:e},this.traversals.annotationCollection):t.type===\"Collection\"?this.traverseType(t,{parent:e},this.traversals.collection):this.traverseType(t,{parent:e},this.traversals.contentResource))),e.start&&(v(e.start)?e.start=this.traverseSpecificResource(e.start,\"Canvas\",e):e.start=this.traverseType(e.start,{parent:e},this.traversals.canvas)),e.rendering&&(e.rendering=e.rendering.map(t=>this.traverseType(t,{parent:e},this.traversals.contentResource))),e.supplementary&&(e.supplementary=e.supplementary.map(t=>this.traverseType(t,{parent:e},this.traversals.contentResource))),e}traverseCollectionItems(e){return e.items&&e.items.map(t=>t.type===\"Collection\"?this.traverseCollection(t):this.traverseManifest(t)),e}traverseCollection(e,t){return this.traverseType(this.traverseDescriptive(this.traverseInlineAnnotationPages(this.traverseLinking(this.traverseLinkedCanvases(this.traverseCollectionItems(e))))),{parent:t},this.traversals.collection)}traverseGeoJson(e,t){return this.traverseType(e,{parent:t},this.traversals.geoJson)}traverseNavPlace(e){return e.navPlace&&(e.navPlace=this.traverseGeoJson(e.navPlace,e)),e}traverseManifestItems(e){return e.items&&(e.items=e.items.map(t=>this.traverseCanvas(t))),e}traverseManifestStructures(e){return e.structures&&(e.structures=e.structures.map(t=>this.traverseRange(t))),e}traverseManifest(e,t){return this.traverseType(this._traverseManifest(e),{parent:t},this.traversals.manifest)}traverseCanvasItems(e){return e.items=(e.items||[]).map(t=>this.traverseAnnotationPage(t,e)),e}traverseInlineAnnotationPages(e){return typeof e==\"string\"||!e||e.annotations&&(e.annotations=e.annotations.map(t=>this.traverseAnnotationPage(t,e))),e}traverseCanvas(e,t){return this.traverseType(this._traverseCanvas(e),{parent:t},this.traversals.canvas)}traverseAnnotationPageItems(e){return e.items&&(e.items=e.items.map(t=>this.traverseAnnotation(t,e))),e}traverseAnnotationPage(e,t){return this.traverseType(this._traverseAnnotationPage(e),{parent:t},this.traversals.annotationPage)}traverseAnnotationBody(e){return Array.isArray(e.body)?e.body=e.body.map(t=>this.traverseContentResource(t,e)):e.body&&(e.body=this.traverseContentResource(e.body,e)),e}traverseLinkedCanvases(e){return e.placeholderCanvas&&(e.placeholderCanvas=this.traverseCanvas(e.placeholderCanvas)),e.accompanyingCanvas&&(e.accompanyingCanvas=this.traverseCanvas(e.accompanyingCanvas)),e}traverseAnnotation(e,t){return this.traverseType(this.traverseLinking(this.traverseAnnotationBody(this.traverseDescriptive(e))),{parent:t},this.traversals.annotation)}traverseContentResourceLinking(e){return typeof e==\"string\"||!e||e&&e.service&&(e.service=i(e.service||[]).map(t=>this.traverseService(t,e))),e}traverseContentResource(e,t){return e.type===\"Choice\"&&(e.items=e.items.map(n=>this.traverseContentResource(n,e))),v(e)?this.traverseSpecificResource(e,\"ContentResource\"):this.traverseType(this.traverseInlineAnnotationPages(this.traverseContentResourceLinking(e)),{parent:t},this.traversals.contentResource)}traverseSpecificResource(e,t,n){let s=e.source;return typeof e.source==\"string\"&&(s={id:e.source,type:t||\"unknown\"}),this.traverseType({...e,source:t===\"Canvas\"||s.type===\"Canvas\"?this.traverseType(s,{parent:n},this.traversals.canvas):t===\"ContentResource\"?this.traverseContentResource(s,{parent:n}):this.traverseUnknown(s,{parent:n,typeHint:t})},{parent:n},this.traversals.specificResource)}traverseRangeRanges(e){return e.items&&(e.items=e.items.map(t=>typeof t==\"string\"?this.traverseCanvas({id:t,type:\"Canvas\"},e):v(t)?this.traverseSpecificResource(t,\"Canvas\",e):t.type===\"Manifest\"?this.traverseManifest(t,e):this.traverseRange(t,e))),e}traverseRange(e,t){return this.traverseType(this._traverseRange(e),{parent:t},this.traversals.range)}traverseAgent(e,t){return this.traverseType(this.traverseDescriptive(this.traverseLinking(e)),{parent:t},this.traversals.agent)}traverseType(e,t,n){return n.reduce((s,c)=>{let h=c(s,t);return typeof h>\"u\"&&!this.options.allowUndefinedReturn?s:h},e)}traverseService(e,t){let n=Object.assign({},e);return n&&n.service&&(n.service=i(n.service).map(s=>this.traverseService(s))),this.traverseType(n,{parent:t},this.traversals.service)}traverseUnknown(e,{parent:t,typeHint:n}={}){let s=y(e,n);switch(s){case\"Collection\":return this.traverseCollection(e,t);case\"Manifest\":return this.traverseManifest(e,t);case\"Canvas\":return this.traverseCanvas(e,t);case\"AnnotationPage\":return this.traverseAnnotationPage(e,t);case\"Annotation\":return this.traverseAnnotation(e,t);case\"ContentResource\":return this.traverseContentResource(e,t);case\"Range\":return this.traverseRange(e,t);case\"Service\":return this.traverseService(e,t);case\"Agent\":return this.traverseAgent(e,t);default:throw new Error(`Unknown or unsupported resource type of ${s}`)}}};export{v as a,p as b,y as c,l as d};\n","import{h as V}from\"./chunk-MQ6FX5SL.js\";import{a as z,d as H}from\"./chunk-W3DWL6UZ.js\";function L(e,n){let i=n||\"unknown\";if(!e)return;if(typeof e==\"string\")return{id:e,type:i};if(z(e))return L(e.source,n);let r=i&&i!==\"unknown\"?i:e.type||e[\"@type\"],t=e.id||e[\"@id\"];if(r&&r.indexOf(\":\")!==-1&&(r=r.split(\":\").pop()),t&&r)return{id:t,type:r}}var w={},f=\"iiif-parser:hasPart\",g=\"iiif-parser:partOf\",T=\"iiif-parser:isExternal\",m=\"__$UNSET$__\",I=\"__$UNWRAP$__\",o=[];Object.freeze(o);Object.freeze(w);function te(e){if(e===w||Object.keys(e).length===0)return!0;for(let n in e)return!1;return!0}function oe(e,n){if(n&&n[\"@explicit\"]){let i={},r=Object.keys(n);for(let t of r)t===g||t===\"@explicit\"||(te(n[t])?i[t]=e[t]:i[t]=n[t]);return i}return e}function F(e,n,i){let r=L(n);if(!r)return[void 0,void 0];let t=e.requests[r.id],a=r.type||e.mapping[r.id];if(!a||t&&t.resourceUri&&(!e.entities[a]||!e.entities[a][t.resourceUri]))return[void 0,void 0];let s=e.entities[a][t?t.resourceUri:r.id];if(r.type&&!s)return F(e,{id:r.id},i);if(s&&s[f]){let c=s[f].find(l=>i?l[g]===i.id:l[g]===s.id);return[oe(s,c),s]}return[s,s]}var xe={id:\"https://iiif-parser/annotation\",type:\"Annotation\",behavior:o,label:null,thumbnail:o,summary:null,requiredStatement:null,metadata:o,seeAlso:o,homepage:o,rendering:o,service:o,accessibility:o,audience:o,body:o,bodyValue:null,canonical:null,created:null,creator:o,generated:null,generator:o,modified:null,motivation:o,rights:null,stylesheet:null,target:o,timeMode:void 0,via:o,partOf:o},K={id:\"https://iiif-parser/annotation-page\",type:\"AnnotationPage\",behavior:o,label:null,thumbnail:o,summary:null,requiredStatement:null,metadata:o,rights:null,provider:o,items:o,seeAlso:o,homepage:o,rendering:o,service:o},G={id:\"https://iiif-parser/empty-canvas\",type:\"Canvas\",label:null,behavior:o,thumbnail:o,accompanyingCanvas:null,placeholderCanvas:null,summary:null,requiredStatement:null,metadata:o,rights:null,navDate:null,provider:o,items:o,annotations:o,seeAlso:o,homepage:o,partOf:o,rendering:o,service:o,duration:0,height:0,width:0},X={id:\"https://iiif-parser/empty-collection\",type:\"Collection\",label:null,viewingDirection:\"left-to-right\",behavior:o,thumbnail:o,accompanyingCanvas:null,placeholderCanvas:null,summary:null,requiredStatement:null,metadata:o,rights:null,navDate:null,provider:o,items:o,annotations:o,seeAlso:o,homepage:o,partOf:o,rendering:o,service:o,services:o},Y={id:\"https://iiif-parser/empty-manifest\",type:\"Manifest\",annotations:o,behavior:o,homepage:o,items:o,label:null,metadata:o,navDate:null,provider:o,partOf:o,accompanyingCanvas:null,placeholderCanvas:null,rendering:o,requiredStatement:null,rights:null,seeAlso:o,service:o,services:o,start:null,structures:o,summary:null,thumbnail:o,viewingDirection:\"left-to-right\"},J={id:\"https://iiif-parser/empty-canvas\",type:\"Range\",label:null,behavior:o,thumbnail:o,accompanyingCanvas:null,placeholderCanvas:null,summary:null,requiredStatement:null,metadata:o,rights:null,navDate:null,provider:o,items:o,annotations:o,seeAlso:o,homepage:o,partOf:o,rendering:o,service:o,start:null,supplementary:null,viewingDirection:\"left-to-right\"},B={id:\"https://iiif-parser/empty-agent\",type:\"Agent\",label:{},logo:o,seeAlso:o,homepage:o},Q={id:\"https://iiif-parser/empty-service\",type:\"UnknownService\"};function _(e,n={}){if(Array.isArray(e))return _(e[0]);if(typeof e==\"string\"){let[i,r]=e.split(\"#\");return r?{type:\"SpecificResource\",source:{id:i,type:n.typeHint||\"Unknown\"},selector:{type:\"FragmentSelector\",value:r}}:{type:\"SpecificResource\",source:{id:i,type:n.typeMap&&n.typeMap[i]||n.typeHint||\"Unknown\"}}}if(e.type===\"Choice\"||e.type===\"List\"||e.type===\"Composite\"||e.type===\"Independents\")return _(e.items[0]);if(!e.type&&\"source\"in e&&(e.type=\"SpecificResource\"),e.type===\"SpecificResource\")return e.source.type===\"Canvas\"&&e.source.partOf&&typeof e.source.partOf==\"string\"&&(e.source.partOf=[{id:e.source.partOf,type:\"Manifest\"}]),e.selector?{type:\"SpecificResource\",source:e.source,selector:e.selector}:{type:\"SpecificResource\",source:e.source};if(e.id){e.type===\"Canvas\"&&e.partOf&&typeof e.partOf==\"string\"&&(e.partOf=[{id:e.partOf,type:\"Manifest\"}]);let[i,r]=e.id.split(\"#\");return r?{type:\"SpecificResource\",source:{...e,id:i},selector:{type:\"FragmentSelector\",value:r}}:{type:\"SpecificResource\",source:{...e,id:i}}}return{type:\"SpecificResource\",source:e}}var Le={Collection:{},Manifest:{},Canvas:{},AnnotationPage:{},AnnotationCollection:{},Annotation:{},ContentResource:{},Range:{},Service:{},Selector:{},Agent:{}};function ae(){return{Collection:{},Manifest:{},Canvas:{},AnnotationPage:{},AnnotationCollection:{},Annotation:{},ContentResource:{},Range:{},Service:{},Selector:{},Agent:{}}}function Z(e,n){if(typeof e==\"string\")return{id:e,type:n};if(!e.id)throw new Error(`Invalid resource does not have an ID (${JSON.stringify(e)}, ${n})`);return e}function se(e,n){return(i,r)=>{let t=e[i]?e[i]:{};return(a,s)=>{let c=Z(a,r||i);return c&&c.id&&i?(t[c.id]=t[c.id]?W(t[c.id],c,{parent:s.parent,isTopLevel:n.id===c.id}):W({id:c.id,type:c.type},c,{parent:s.parent,isTopLevel:n.id===c.id}),{id:c.id,type:i===\"ContentResource\"?i:c.type}):c}}}function $(e,n,i){if(!n)return e;if(Array.isArray(e)){if(!Array.isArray(n))throw new Error(\"Cannot merge array with non-array\");let r=[...e];for(let t of n)if(t[\"@id\"]&&!t.id&&(t.id=t[\"@id\"]),t[\"@type\"]&&!t.type&&(t.type=t[\"@type\"]),t!=null)if(Array.isArray(t))r.push(t);else if(typeof t==\"object\"&&t.id&&t.type){let a=r.findIndex(s=>s.id===t.id&&s.type===t.type);a>=0&&(r[a]=$(r[a],t))}else e.indexOf(t)===-1&&r.push(t);return r}else if(typeof e==\"object\"){if(Array.isArray(n)||typeof n!=\"object\")throw new Error(\"Cannot merge object with non-object\");let r={...e},t=[],a=[],s=Object.keys(e).filter(l=>l!==f&&l!==\"id\"&&l!==\"type\"),c={},A={};for(let[l,u]of Object.entries(n)){if(l===f||l===\"id\"||l===\"type\")continue;let y=r[l];y===u?a.push(l):y===o||!y?(t.push(l),r[l]=u):(y&&u&&(c[l]=y,A[l]=u),r[l]=$(y,u),r[l]===c[l]&&(a.push(l),delete c[l]))}if(i&&(i.parent&&i.parent.id||i.isTopLevel)){let l=[],u={};if(i.parent?u[g]=i.parent.id:i.isTopLevel&&(u[g]=e.id),r[f]&&r[f].length){let y=!(r[f]||[]).find(v=>v[\"@explicit\"]),C=t.length>0||a.length!==s.length;if(y&&C)for(let v of r[f]){let p={...v},j=Object.keys(c);if(p){p[\"@explicit\"]=!0;for(let M of s)M!==f&&(p[M]=w);for(let M of j)p[M]=c[M]}l.push(p)}else l.push(...r[f]);if(C){let v=Object.keys(A);u[\"@explicit\"]=!0;for(let p of t)u[p]=w;for(let p of a)u[p]=w;for(let p of v)u[p]=A[p]}}u.id=r.id,u.type=r.type,l.push(u),r[f]=l}return r}else if(e)return e;return n}function W(e,n,i){if(typeof e==\"string\")return e;if(n.id!==e.id||n.type!==e.type){if(n.type===\"ImageService3\")return n;if(e.type===\"ImageService3\")return e;throw new Error(`Can only merge entities with identical identifiers and type! ${n.type}(${n.id}) => ${e.type}(${e.id})`)}return $({...e},n,i)}function le(e){return(n,i)=>r=>{let{id:t,type:a}=Z(r,i||n);if(typeof t>\"u\")throw new Error(\"Found invalid entity without an ID.\");return n===\"ContentResource\"||n===\"Service\"?e[t]=n:e[t]=a,r}}function ce(e){let n=Object.assign({},e);if(n[\"@id\"]&&(n.id=n[\"@id\"]),n[\"@type\"]&&(n.type=n[\"@type\"]),n.service){let i=[];n.service=Array.isArray(n.service)?n.service:[n.service];for(let r of n.service)i.push({id:r[\"@id\"]||r.id,type:r[\"@type\"]||r.type});n.service=i}return Object.assign({},Q,n)}function de(e){return n=>{e.Service=e.Service?e.Service:{};let i=n.id||n[\"@id\"],r=ce(n);return r&&r.id&&(e.Service[r.id]?e.Service[i]=W(e.Service[i],r):e.Service[i]=r),n}}function ue(e){let n=JSON.stringify(e),i=5381,r=n.length;for(;r;)i=i*33^n.charCodeAt(--r);let a=(i>>>0).toString(16);return a.length%2?\"0\"+a:a}function U(e){return n=>typeof n==\"string\"?{id:n,type:e}:n.id?n.type?n:{type:e,...n}:{id:`vault://${ue(n)}`,type:e,...n}}function E(e){return n=>({...e,...n})}function D(e){return Array.isArray(e)?e:[e]}function fe(e){return e.body&&(e.body=D(e.body)),e.seeAlso&&(e.seeAlso=D(e.seeAlso)),e.audience&&(e.audience=D(e.audience)),e.accessibility&&(e.accessibility=D(e.accessibility)),e.motivation&&(e.motivation=D(e.motivation)),e}function ee(e,{typeHint:n,partOfTypeHint:i}={}){if(typeof e==\"string\"&&(e={id:e,type:n||\"unknown\"}),z(e))return typeof e.source==\"string\"&&(e.source={id:e.source,type:n||\"unknown\"}),e.source.type===\"Canvas\"&&e.source.partOf&&typeof e.source.partOf==\"string\"&&(e.source.partOf=[{id:e.source.partOf,type:i||\"Manifest\"}]),e;let r;if((e.id||\"\").indexOf(\"#\")!==-1){let[t,a]=(e.id||\"\").split(\"#\");e.id=t,a&&(r={type:\"FragmentSelector\",value:a})}return{type:\"SpecificResource\",source:e,selector:r}}function pe(e){let n=Object.assign({},e);return e&&e.items&&(n.items=e.items.map(i=>typeof i==\"string\"||i.type===\"Canvas\"?ee(i):i)),n}function ye(e){let n=Object.assign({},e);return n.start?(n.start=ee(n.start,{typeHint:\"Canvas\"}),n):e}function me(e){let n=Object.assign({},e);return n.target?(n.target=_(n.target,{typeHint:\"Canvas\"}),n):e}function ve(e){return e}function q(e){return typeof e.items>\"u\"&&(e[T]=!0),e}function Fe(e){let n=V(e),i=ae(),r={},t=se(i,n),a=le(r),c=new H({collection:[q,E(X),a(\"Collection\"),t(\"Collection\")],manifest:[q,E(Y),ye,a(\"Manifest\"),t(\"Manifest\")],canvas:[E(G),a(\"Canvas\"),t(\"Canvas\")],annotationPage:[q,U(\"AnnotationPage\"),E(K),a(\"AnnotationPage\"),t(\"AnnotationPage\")],annotation:[U(\"Annotation\"),fe,me,a(\"Annotation\"),t(\"Annotation\")],contentResource:[U(\"ContentResource\"),a(\"ContentResource\"),t(\"ContentResource\")],range:[E(J),pe,a(\"Range\",\"Canvas\"),t(\"Range\",\"Canvas\")],agent:[E(B),a(\"Agent\"),t(\"Agent\")],specificResource:[ve],service:[de(i)]}).traverseUnknown(n);return{entities:i,resource:c,mapping:r}}function ge(e){let n={};for(let[i,r]of e){if(i===I&&r!==m)return r;r!==m&&typeof r<\"u\"&&r!==null&&(n[i]=r)}return n}function $e(e,n,i){if(!n.type||!n.id)throw new Error(\"Unknown entity\");if(!i[n.type])throw new Error(`Serializer not found for ${n.type}`);function r(t,a,s=0){let c=i[t.type];if(!c)return m;if(s>20)throw new Error(\"Circular reference: \"+t.id+\" \"+t.type);let[A,l]=F(e,t.type?t:t.id,a)||(t.id&&t.type?t:null);if(!A)return m;let u=c(A,e,{parent:a,isTopLevel:n.id===t.id,fullResource:l}),y=u.next();for(;!y.done;){let C=y.value,v=m;if(C)if(Array.isArray(C)){let p=[];for(let j of C)p.push(r(j,t,s+1));v=p}else v=r(C,t,s+1);y=u.next(v)}return y.value===m?m:ge(y.value)}return r(n)}function P(e,{allowSourceString:n=!0,allowString:i=!1,allowedStringType:r}={}){let t=a=>{if(n&&a&&a.source&&typeof a.source!=\"string\"){let s=Object.keys(a.source);if(a.source.id&&a.source.type&&s.length===2)return{...a,source:a.source.id}}return a};if(e){if(e.source&&e.source.partOf)return t(e);let a=Object.keys(e);if(a.length===2&&e.type&&e.source||a.length===3&&e.type&&e.source&&a.indexOf(\"selector\")!==-1&&!e.selector)return i&&(!r||r===e.source.type)?e.source.id:e.source.type===\"ContentResource\"?{type:\"SpecificResource\",source:e.source.id}:e.source;if(e.selector&&!Array.isArray(e.selector)&&typeof e.selector!=\"string\"&&e.selector.type===\"FragmentSelector\"){let s=`${e.source.id}#${e.selector.value}`;return i?s:{id:s,type:e.source.type}}}return t(e)}function O(e){if(!e)return;let n=Object.keys(e);if(n.length!==0){if(n.length===1){let i=n[0];if(!i)return\"\";let r=(e[i]||[]).join(\"\");return i===\"@none\"||i===\"none\"||i===\"en\"?r:{\"@language\":i,\"@value\":r}}return n.map(i=>({\"@language\":i,\"@value\":(e[i]||[]).join(\"\")}))}}function ne(e){return Array.isArray(e)?e.map(n=>ne(n)):typeof e==\"string\"?e:e.type&&e.type===\"Canvas\"?e.id:e}function h(e,n=!1){if(e)return e.length>1&&!n?e:e[0]||void 0}function he(e){if(e){if(typeof e==\"string\")return{\"@id\":e};if(\"@id\"in e){let n={...e};return delete n[\"@type\"],n}return{\"@context\":\"http://iiif.io/api/image/2/context.json\",\"@id\":e.id,profile:`http://iiif.io/api/image/2/profiles/${e.profile}.json`}}}function N(e,n){return[[\"@id\",e.id],[\"@type\",n],[\"format\",e.format],[\"height\",e.height],[\"width\",e.width],[\"viewingDirection\",e.viewingDirection!==\"left-to-right\"?e.viewingDirection:void 0],[\"license\",e.license?e.license:void 0]]}function*b(e){let n=e.provider?yield e.provider[0]:void 0;return[[\"label\",O(e.label)],[\"metadata\",e.metadata&&e.metadata.length?e.metadata.map(i=>({label:O(i.label)||\"\",value:O(i.value)||\"\"})):void 0],[\"description\",O(e.summary)],[\"thumbnail\",h(yield e.thumbnail)],[\"navDate\",e.navDate],[\"logo\",n?h(n.logo):void 0],[\"homepage\",n?n.homepage:void 0],[\"attribution\",e.requiredStatement?O(e.requiredStatement.value):void 0]]}function*k(e){let n=e.start&&e.start.type&&e.start.type===\"SpecificResource\"?P(e.start):e.start;return[[\"seeAlso\",h(yield e.seeAlso)],[\"service\",h((e.service||[]).map(he))],[\"rendering\",h(yield e.rendering)],[\"startCanvas\",n?n.id:void 0]]}function Se(e){return e.type===\"SpecificResource\"}function Re(e){return e&&e.type===\"FragmentSelector\"}function Ae(e){if(e&&Se(e)){let n=e.id,i=e.selector?Array.isArray(e.selector)?e.selector[0]:e.selector:void 0;return Re(i)&&(n+=\"#\"+i.value),n}return e?.id}var Ke={Manifest:function*(e,n,{isTopLevel:i}){return[...i?[[\"@context\",\"http://iiif.io/api/presentation/2/context.json\"]]:[],...N(e,\"sc:Manifest\"),...yield*b(e),...yield*k(e),[\"sequences\",[{\"@id\":`${e.id}/sequence0`,\"@type\":\"sc:Sequence\",canvases:yield e.items}]],[\"structures\",yield e.structures]]},Canvas:function*(e){let i=(yield e.items)[0];return[...N(e,\"sc:Canvas\"),...yield*b(e),...yield*k(e),[\"images\",i?[i.resources]:void 0],[\"annotations\",e.annotations&&e.annotations.length?h(yield e.annotations):void 0]]},AnnotationPage:function*(e){return[...N(e,\"sc:AnnotationList\"),...yield*b(e),[\"resources\",e.items&&e.items.length?h(yield e.items):void 0]]},Annotation:function*(e){return[[\"@id\",e.id],[\"@type\",\"oa:Annotation\"],[\"motivation\",\"sc:painting\"],[\"on\",ne(e.target)],[\"resource\",h(yield e.body,!0)]]},ContentResource:function*(e){switch(e.type){case\"Image\":return[...N(e,\"dctypes:Image\"),...yield*b(e),...yield*k(e)];case\"Text\":case\"Dataset\":default:return[...N(e,void 0),...yield*b(e)]}},AnnotationCollection:function*(e){return[[\"@id\",e.id],[\"@type\",\"sc:Layer\"],[\"label\",O(e.label)]]},Collection:function*(e){return[...N(e,\"sc:Collection\"),...yield*b(e),...yield*k(e),[\"members\",yield*e.items]]},Range:function*(e){let n=[],i=[];if(e.items)for(let r of e.items){let t=r.type===\"SpecificResource\"?r.source:r;if(t){let a=yield t;n.push({\"@id\":Ae(r),\"@type\":t.type,label:a?a.label:void 0,within:e.id}),t.type===\"Canvas\"&&i.push(t.id)}}return[...N(e,\"sc:Range\"),...yield*b(e),...yield*k(e),[\"canvases\",i.length===n.length?i:void 0],[\"members\",i.length!==n.length?n:void 0]]}};function x(e){return[[\"id\",e.id?.startsWith(\"vault://\")?void 0:e.id],[\"type\",e.type],[\"format\",e.format],[\"profile\",e.profile],[\"height\",e.height||void 0],[\"width\",e.width||void 0],[\"duration\",e.duration||void 0],[\"viewingDirection\",e.viewingDirection!==\"left-to-right\"?e.viewingDirection:void 0],[\"behavior\",e.behavior&&e.behavior.length?e.behavior:void 0],[\"timeMode\",e.timeMode],[\"motivation\",Array.isArray(e.motivation)?e.motivation[0]:e.motivation],[f,m]]}function d(e){if(e===m||!e||e.length===0)return;let n=e.filter(i=>i!==m);if(n.length!==0)return n}function re(e){if(e&&e.type&&e.type===\"ImageService2\"){let{id:n,type:i,profile:r,...t}=e,a=typeof r==\"string\"?r:Array.isArray(r)?r.find(s=>typeof s==\"string\"):\"\";return{\"@id\":n,\"@type\":i,profile:a?a.startsWith(\"http\")?a:`http://iiif.io/api/image/2/${a}.json`:\"http://iiif.io/api/image/2/level0.json\",...t}}return e}function ie(e){if(Array.isArray(e)||(e=e?[e]:[]),!(!e||e.length===0))return e.map(re)}function*S(e){return[[\"label\",e.label],[\"metadata\",d(e.metadata)],[\"summary\",e.summary],[\"requiredStatement\",e.requiredStatement],[\"rights\",Array.isArray(e.rights)?e.rights[0]||void 0:e.rights||void 0],[\"navDate\",e.navDate],[\"language\",e.language],[\"thumbnail\",d(yield e.thumbnail)],[\"placeholderCanvas\",yield e.placeholderCanvas],[\"accompanyingCanvas\",yield e.accompanyingCanvas],[\"provider\",d(yield e.provider)]]}function*R(e,n){let i=[];for(let r of e.partOf||[])r.type===\"Manifest\"&&n.type===\"Manifest\"||i.push(yield r);return[[\"seeAlso\",d(yield e.seeAlso)],[\"service\",d(ie(e.service))],[\"services\",d(ie(e.services))],[\"rendering\",d(yield e.rendering)],[\"supplementary\",d(yield e.supplementary)],[\"homepage\",d(yield e.homepage)],[\"logo\",d(yield e.logo)],[\"partOf\",d(i)],[\"start\",e.start?P(e.start):e.start]]}var Be={Manifest:function*(e,n,{isTopLevel:i}){return i?[[\"@context\",e[\"@context\"]?e[\"@context\"]:\"http://iiif.io/api/presentation/3/context.json\"],...x(e),...yield*S(e),...yield*R(e),[\"items\",yield e.items],[\"structures\",d(yield e.structures)],[\"annotations\",d(yield e.annotations)],[\"navPlace\",e.navPlace]]:[...x(e),...yield*S(e)]},Canvas:function*(e,n,{parent:i}){return i&&i.type!==\"Manifest\"&&i.type!==\"Canvas\"?[[\"id\",e.id]]:[...x(e),...yield*S(e),...yield*R(e,i),[\"items\",yield e.items],[\"annotations\",d(yield e.annotations)],[\"navPlace\",e.navPlace]]},Agent:function*(e){return[[\"id\",e.id],[\"type\",\"Agent\"],[\"label\",e.label],...yield*R(e)]},AnnotationPage:function*(e){let n=Object.entries(e).map(([r,t])=>[r,Array.isArray(t)?d(t):t]).filter(([r,t])=>r!==\"items\"&&r!==\"id\"&&r!==f&&r!==g&&r!==T),i=yield e.items;return[[\"id\",e.id?.startsWith(\"vault://\")?void 0:e.id],...n,...yield*R(e),[\"items\",i.length||e[T]===!1?i:m]]},Service:function*(e){return[[I,re(e)]]},Annotation:function*(e){let n=Object.entries(e).map(([r,t])=>r===\"motivation\"?[r,Array.isArray(t)?t[0]:t]:r===\"target\"?[r,P(t,{allowString:!0,allowSourceString:!0,allowedStringType:\"Canvas\"})]:[r,Array.isArray(t)?d(t):t]).filter(([r])=>r!==\"body\"&&r!==f&&r!==T),i;if(Array.isArray(e.body)){let r=[];for(let t of e.body)if(t&&z(t)){let a={...t};t.source.type!==\"Canvas\"?a.source=yield t.source:a.source=t.source,r.push(P(a,{allowSourceString:!0}))}else r.push(yield t);i=r}else e.body&&z(e.body)?(i={...e.body},i.source=yield e.body.source):i=yield e.body;return[...n,...yield*S(e),...yield*R(e),[\"body\",i.length===1?i[0]:i]]},ContentResource:function*(e){return Ce([...x(e),...yield*S(e),...yield*R(e),[\"annotations\",d(yield e.annotations)],[\"items\",d(yield e.items)]],e)},AnnotationCollection:function*(e){return[[\"id\",e.id],[\"type\",\"AnnotationCollection\"],[\"label\",e.label]]},Collection:function*(e,n,{isTopLevel:i}){return i?[[\"@context\",\"http://iiif.io/api/presentation/3/context.json\"],...x(e),...yield*S(e),...yield*R(e),[\"items\",d(yield e.items)],[\"navPlace\",e.navPlace]]:[...x(e),...yield*S(e)]},Range:function*(e){let n=[];for(let i of e.items)i.type===\"Range\"?n.push(yield i):i&&i.type===\"SpecificResource\"?n.push(P(i)):n.push(i);return[...x(e),...yield*S(e),...yield*R(e),[\"items\",n],[\"annotations\",d(yield e.annotations)],[\"navPlace\",e.navPlace]]}};function Ce(e,n){let i=Object.keys(n),r=e.map(([t])=>t);for(let t of i)t===f||t===T||r.indexOf(t)===-1&&typeof n[t]<\"u\"&&e.push([t,n[t]]);return e}export{L as a,w as b,f as c,g as d,T as e,m as f,I as g,o as h,te as i,oe as j,F as k,xe as l,K as m,G as n,X as o,Y as p,J as q,B as r,Q as s,Le as t,ae as u,$ as v,W as w,ve as x,q as y,Fe as z,ge as A,$e as B,P as C,O as D,Ke as E,Be as F};\n","// src/vault/utility/typesafe-actions-runtime.ts\nvar createAction = function createAction2(type) {\n  return function() {\n    const base = { type, getType: () => type, toString: () => type };\n    return (payload, meta) => ({\n      ...base,\n      ...payload !== void 0 && { payload },\n      ...meta !== void 0 && { meta }\n    });\n  };\n};\n\n// src/vault/actions/entity-actions.ts\nvar IMPORT_ENTITIES = \"@iiif/IMPORT_ENTITIES\";\nvar MODIFY_ENTITY_FIELD = \"@iiif/MODIFY_ENTITY_FIELD\";\nvar REORDER_ENTITY_FIELD = \"@iiif/REORDER_ENTITY_FIELD\";\nvar ADD_REFERENCE = \"@iiif/ADD_REFERENCE\";\nvar UPDATE_REFERENCE = \"@iiif/UPDATE_REFERENCE\";\nvar REMOVE_REFERENCE = \"@iiif/REMOVE_REFERENCE\";\nvar ADD_METADATA = \"@iiif/ADD_METADATA\";\nvar REMOVE_METADATA = \"@iiif/REMOVE_METADATA\";\nvar UPDATE_METADATA = \"@iiif/UPDATE_METADATA\";\nvar REORDER_METADATA = \"@iiif/REORDER_METADATA\";\nvar importEntities = createAction(IMPORT_ENTITIES)();\nvar modifyEntityField = createAction(MODIFY_ENTITY_FIELD)();\nvar reorderEntityField = createAction(REORDER_ENTITY_FIELD)();\nvar addReference = createAction(ADD_REFERENCE)();\nvar removeReference = createAction(REMOVE_REFERENCE)();\nvar updateReference = createAction(UPDATE_REFERENCE)();\nvar addMetadata = createAction(ADD_METADATA)();\nvar updateMetadata = createAction(UPDATE_METADATA)();\nvar removeMetadata = createAction(REMOVE_METADATA)();\nvar reorderMetadata = createAction(REORDER_METADATA)();\nvar entityActions = {\n  importEntities,\n  modifyEntityField,\n  reorderEntityField,\n  addReference,\n  removeReference,\n  updateReference,\n  addMetadata,\n  removeMetadata,\n  updateMetadata,\n  reorderMetadata\n};\n\n// src/vault/actions/mapping-actions.ts\nvar ADD_MAPPING = \"@iiif/ADD_MAPPING\";\nvar ADD_MAPPINGS = \"@iiif/ADD_MAPPINGS\";\nvar addMapping = createAction(ADD_MAPPING)();\nvar addMappings = createAction(ADD_MAPPINGS)();\nvar mappingActions = { addMapping, addMappings };\n\n// src/vault/actions/request-actions.ts\nvar RESOURCE_ERROR = \"RESOURCE_ERROR\";\nvar RESOURCE_LOADING = \"RESOURCE_LOADING\";\nvar RESOURCE_READY = \"RESOURCE_READY\";\nvar REQUEST_RESOURCE = \"@iiif/REQUEST_RESOURCE\";\nvar REQUEST_ERROR = \"@iiif/REQUEST_ERROR\";\nvar REQUEST_MISMATCH = \"@iiif/REQUEST_MISMATCH\";\nvar REQUEST_COMPLETE = \"@iiif/REQUEST_COMPLETE\";\nvar REQUEST_OFFLINE_RESOURCE = \"@iiif/REQUEST_OFFLINE_RESOURCE\";\nvar requestResource = createAction(REQUEST_RESOURCE)();\nvar requestError = createAction(REQUEST_ERROR)();\nvar requestMismatch = createAction(REQUEST_MISMATCH)();\nvar requestComplete = createAction(REQUEST_COMPLETE)();\nvar requestOfflineResource = createAction(REQUEST_OFFLINE_RESOURCE)();\nvar requestActions = {\n  requestResource,\n  requestError,\n  requestMismatch,\n  requestComplete,\n  requestOfflineResource\n};\n\n// src/vault/actions/batch-actions.ts\nvar BATCH_ACTIONS = \"@iiif/BATCH\";\nvar BATCH_IMPORT = \"@iiif/BATCH_IMPORT\";\nvar batchActions = createAction(BATCH_ACTIONS)();\nvar batchImport = createAction(BATCH_IMPORT)();\n\nexport {\n  createAction,\n  IMPORT_ENTITIES,\n  MODIFY_ENTITY_FIELD,\n  REORDER_ENTITY_FIELD,\n  ADD_REFERENCE,\n  UPDATE_REFERENCE,\n  REMOVE_REFERENCE,\n  ADD_METADATA,\n  REMOVE_METADATA,\n  UPDATE_METADATA,\n  REORDER_METADATA,\n  importEntities,\n  modifyEntityField,\n  reorderEntityField,\n  addReference,\n  removeReference,\n  updateReference,\n  addMetadata,\n  updateMetadata,\n  removeMetadata,\n  reorderMetadata,\n  entityActions,\n  ADD_MAPPING,\n  ADD_MAPPINGS,\n  addMapping,\n  addMappings,\n  mappingActions,\n  RESOURCE_ERROR,\n  RESOURCE_LOADING,\n  RESOURCE_READY,\n  REQUEST_RESOURCE,\n  REQUEST_ERROR,\n  REQUEST_MISMATCH,\n  REQUEST_COMPLETE,\n  REQUEST_OFFLINE_RESOURCE,\n  requestResource,\n  requestError,\n  requestMismatch,\n  requestComplete,\n  requestOfflineResource,\n  requestActions,\n  BATCH_ACTIONS,\n  BATCH_IMPORT,\n  batchActions,\n  batchImport\n};\n","import {\n  RESOURCE_ERROR,\n  RESOURCE_LOADING,\n  RESOURCE_READY,\n  addMapping,\n  addMappings,\n  batchActions,\n  importEntities,\n  requestComplete,\n  requestError,\n  requestMismatch,\n  requestResource\n} from \"./chunk-F2Q2OM3J.js\";\n\n// src/vault/utility/action-list-from-resource.ts\nimport { normalize } from \"@iiif/parser\";\nvar actionListFromResource = (id, response) => {\n  const { entities, resource, mapping } = normalize(response);\n  if (resource.id === void 0) {\n    return [requestError({ id, message: \"ID is not defined in resource.\" })];\n  }\n  const actions = [importEntities({ entities }), addMappings({ mapping })];\n  if (resource.id !== id) {\n    actions.push(addMapping({ id, type: resource.type }));\n    actions.push(requestMismatch({ requestId: id, actualId: resource.id }));\n  }\n  actions.push(requestComplete({ id }));\n  return actions;\n};\n\n// src/vault/utility/are-inputs-equal.ts\nvar safeIsNaN = Number.isNaN || function ponyfill(value) {\n  return typeof value === \"number\" && value !== value;\n};\nfunction isEqual(first, second) {\n  if (first === second) {\n    return true;\n  }\n  if (safeIsNaN(first) && safeIsNaN(second)) {\n    return true;\n  }\n  return false;\n}\nfunction areInputsEqual(newInputs, lastInputs) {\n  if (!Array.isArray(newInputs) || !Array.isArray(lastInputs)) {\n    return newInputs === lastInputs;\n  }\n  if (newInputs.length !== lastInputs.length) {\n    return false;\n  }\n  for (let i = 0; i < newInputs.length; i++) {\n    if (!isEqual(newInputs[i], lastInputs[i])) {\n      return false;\n    }\n  }\n  return true;\n}\n\n// src/vault/utility/resolve-if-exists.ts\nimport { frameResource, HAS_PART, PART_OF } from \"@iiif/parser\";\nfunction resolveIfExists(state, url, parent) {\n  const request = state.iiif.requests[url];\n  const resourceType = state.iiif.mapping[url];\n  if (!resourceType || !state.iiif.entities[resourceType][request.resourceUri]) {\n    return void 0;\n  }\n  const fullEntity = state.iiif.entities[resourceType][request.resourceUri];\n  if (fullEntity && fullEntity[HAS_PART]) {\n    const framing = fullEntity[HAS_PART].find((t) => {\n      return parent ? t[PART_OF] === parent.id : t[PART_OF] === fullEntity.id;\n    });\n    return frameResource(fullEntity, framing);\n  }\n  return fullEntity;\n}\n\n// src/vault/utility/is-promise.ts\nfunction isPromise(value) {\n  return value && typeof value.then === \"function\";\n}\n\n// src/vault/utility/create-fetch-helper.ts\nfunction createFetchHelper(vault, fetcher, { waitTimeout = 30 } = {}) {\n  return (url, options) => {\n    const store = vault.getStore();\n    const state = store.getState();\n    const request = state.iiif.requests[url];\n    if (request) {\n      if (request.loadingState === RESOURCE_READY) {\n        const resolvedEntity = resolveIfExists(state, url);\n        if (resolvedEntity) {\n          return resolvedEntity;\n        }\n      }\n      switch (request.loadingState) {\n        case RESOURCE_ERROR:\n          break;\n        case RESOURCE_LOADING: {\n          return (async () => {\n            let cleanupSubscription;\n            let didContinue = false;\n            try {\n              const resolvedEntity = await Promise.race([\n                new Promise((resolve, reject) => {\n                  if (didContinue) {\n                    return;\n                  }\n                  cleanupSubscription = store.subscribe(() => {\n                    const latestState = store.getState();\n                    if (latestState.iiif.requests[url].loadingState === RESOURCE_ERROR) {\n                      reject();\n                      return;\n                    }\n                    if (latestState.iiif.requests[url].loadingState === RESOURCE_READY) {\n                      const maybeResolvedEntity = resolveIfExists(latestState, url);\n                      if (maybeResolvedEntity) {\n                        resolve(maybeResolvedEntity);\n                      } else {\n                        reject();\n                      }\n                    }\n                  });\n                }),\n                new Promise(\n                  (resolve, reject) => setTimeout(\n                    () => {\n                      didContinue = true;\n                      reject();\n                    },\n                    waitTimeout * 60 * 1e3\n                  )\n                )\n              ]);\n              if (cleanupSubscription) {\n                cleanupSubscription();\n              }\n              if (resolvedEntity) {\n                return resolvedEntity;\n              }\n            } catch (e) {\n              if (cleanupSubscription) {\n                cleanupSubscription();\n              }\n            }\n          })();\n        }\n      }\n    }\n    vault.dispatch(requestResource({ id: url }));\n    const importResource = (resource) => {\n      if (!resource) {\n        return void 0;\n      }\n      if (!resource.id && !resource[\"@id\"]) {\n        if (resource[\"@type\"]) {\n          resource[\"@id\"] = url;\n          resource.id = url;\n        } else {\n          resource.id = url;\n        }\n      }\n      const toDispatch = actionListFromResource(url, resource);\n      vault.dispatch(batchActions({ actions: toDispatch }));\n      return resolveIfExists(store.getState(), url);\n    };\n    try {\n      const resourceOrPromise = fetcher(url, options);\n      if (isPromise(resourceOrPromise)) {\n        return (async () => {\n          try {\n            return importResource(await resourceOrPromise);\n          } catch (err) {\n            vault.dispatch(requestError({ id: url, message: err.toString() }));\n            throw err;\n          }\n        })();\n      }\n      return importResource(resourceOrPromise);\n    } catch (err) {\n      vault.dispatch(requestError({ id: url, message: err.toString() }));\n      throw err;\n    }\n  };\n}\n\nexport {\n  actionListFromResource,\n  areInputsEqual,\n  resolveIfExists,\n  createFetchHelper\n};\n","import {\n  createAction\n} from \"./chunk-F2Q2OM3J.js\";\n\n// src/vault/actions/meta-actions.ts\nvar SET_META_VALUE = \"@iiif/SET_META_VALUE\";\nvar SET_META_VALUE_DYNAMIC = \"@iiif/SET_META_VALUE_DYNAMIC\";\nvar UNSET_META_VALUE = \"@iiif/UNSET_META_VALUE\";\nvar setMetaValue = createAction(SET_META_VALUE)();\nvar setMetaValueDynamic = createAction(SET_META_VALUE_DYNAMIC)();\nvar unsetMetaValue = createAction(UNSET_META_VALUE)();\nvar metaActions = {\n  setMetaValue,\n  setMetaValueDynamic,\n  unsetMetaValue\n};\n\nexport {\n  SET_META_VALUE,\n  SET_META_VALUE_DYNAMIC,\n  UNSET_META_VALUE,\n  metaActions\n};\n","// src/vault/utility/get-default-entities.ts\nfunction getDefaultEntities() {\n  return {\n    Collection: {},\n    Manifest: {},\n    Canvas: {},\n    AnnotationPage: {},\n    AnnotationCollection: {},\n    Annotation: {},\n    ContentResource: {},\n    Range: {},\n    Service: {},\n    Selector: {},\n    Agent: {}\n  };\n}\n\nexport {\n  getDefaultEntities\n};\n","import {\n  SET_META_VALUE,\n  SET_META_VALUE_DYNAMIC,\n  UNSET_META_VALUE\n} from \"./chunk-YAISZCRN.js\";\nimport {\n  getDefaultEntities\n} from \"./chunk-DU2KF6VF.js\";\nimport {\n  ADD_MAPPING,\n  ADD_MAPPINGS,\n  ADD_METADATA,\n  ADD_REFERENCE,\n  BATCH_ACTIONS,\n  BATCH_IMPORT,\n  IMPORT_ENTITIES,\n  MODIFY_ENTITY_FIELD,\n  REMOVE_METADATA,\n  REMOVE_REFERENCE,\n  REORDER_ENTITY_FIELD,\n  REORDER_METADATA,\n  REQUEST_COMPLETE,\n  REQUEST_ERROR,\n  REQUEST_MISMATCH,\n  REQUEST_OFFLINE_RESOURCE,\n  REQUEST_RESOURCE,\n  RESOURCE_ERROR,\n  RESOURCE_LOADING,\n  RESOURCE_READY,\n  UPDATE_METADATA,\n  UPDATE_REFERENCE\n} from \"./chunk-F2Q2OM3J.js\";\nimport {\n  createStore\n} from \"./chunk-2I7FN7JX.js\";\n\n// node_modules/.pnpm/zustand@4.5.2_react@18.2.0/node_modules/zustand/esm/middleware.mjs\nvar reduxImpl = (reducer, initial) => (set, _get, api) => {\n  api.dispatch = (action) => {\n    set((state) => reducer(state, action), false, action);\n    return action;\n  };\n  api.dispatchFromDevtools = true;\n  return { dispatch: (...a) => api.dispatch(...a), ...initial };\n};\nvar redux = reduxImpl;\nvar trackedConnections = /* @__PURE__ */ new Map();\nvar getTrackedConnectionState = (name) => {\n  const api = trackedConnections.get(name);\n  if (!api)\n    return {};\n  return Object.fromEntries(\n    Object.entries(api.stores).map(([key, api2]) => [key, api2.getState()])\n  );\n};\nvar extractConnectionInformation = (store, extensionConnector, options) => {\n  if (store === void 0) {\n    return {\n      type: \"untracked\",\n      connection: extensionConnector.connect(options)\n    };\n  }\n  const existingConnection = trackedConnections.get(options.name);\n  if (existingConnection) {\n    return { type: \"tracked\", store, ...existingConnection };\n  }\n  const newConnection = {\n    connection: extensionConnector.connect(options),\n    stores: {}\n  };\n  trackedConnections.set(options.name, newConnection);\n  return { type: \"tracked\", store, ...newConnection };\n};\nvar devtoolsImpl = (fn, devtoolsOptions = {}) => (set, get, api) => {\n  const { enabled, anonymousActionType, store, ...options } = devtoolsOptions;\n  let extensionConnector;\n  try {\n    extensionConnector = (enabled != null ? enabled : (import.meta.env ? import.meta.env.MODE : void 0) !== \"production\") && window.__REDUX_DEVTOOLS_EXTENSION__;\n  } catch (e) {\n  }\n  if (!extensionConnector) {\n    if ((import.meta.env ? import.meta.env.MODE : void 0) !== \"production\" && enabled) {\n      console.warn(\n        \"[zustand devtools middleware] Please install/enable Redux devtools extension\"\n      );\n    }\n    return fn(set, get, api);\n  }\n  const { connection, ...connectionInformation } = extractConnectionInformation(store, extensionConnector, options);\n  let isRecording = true;\n  api.setState = (state, replace, nameOrAction) => {\n    const r = set(state, replace);\n    if (!isRecording)\n      return r;\n    const action = nameOrAction === void 0 ? { type: anonymousActionType || \"anonymous\" } : typeof nameOrAction === \"string\" ? { type: nameOrAction } : nameOrAction;\n    if (store === void 0) {\n      connection == null ? void 0 : connection.send(action, get());\n      return r;\n    }\n    connection == null ? void 0 : connection.send(\n      {\n        ...action,\n        type: `${store}/${action.type}`\n      },\n      {\n        ...getTrackedConnectionState(options.name),\n        [store]: api.getState()\n      }\n    );\n    return r;\n  };\n  const setStateFromDevtools = (...a) => {\n    const originalIsRecording = isRecording;\n    isRecording = false;\n    set(...a);\n    isRecording = originalIsRecording;\n  };\n  const initialState = fn(api.setState, get, api);\n  if (connectionInformation.type === \"untracked\") {\n    connection == null ? void 0 : connection.init(initialState);\n  } else {\n    connectionInformation.stores[connectionInformation.store] = api;\n    connection == null ? void 0 : connection.init(\n      Object.fromEntries(\n        Object.entries(connectionInformation.stores).map(([key, store2]) => [\n          key,\n          key === connectionInformation.store ? initialState : store2.getState()\n        ])\n      )\n    );\n  }\n  if (api.dispatchFromDevtools && typeof api.dispatch === \"function\") {\n    let didWarnAboutReservedActionType = false;\n    const originalDispatch = api.dispatch;\n    api.dispatch = (...a) => {\n      if ((import.meta.env ? import.meta.env.MODE : void 0) !== \"production\" && a[0].type === \"__setState\" && !didWarnAboutReservedActionType) {\n        console.warn(\n          '[zustand devtools middleware] \"__setState\" action type is reserved to set state from the devtools. Avoid using it.'\n        );\n        didWarnAboutReservedActionType = true;\n      }\n      originalDispatch(...a);\n    };\n  }\n  connection.subscribe((message) => {\n    var _a;\n    switch (message.type) {\n      case \"ACTION\":\n        if (typeof message.payload !== \"string\") {\n          console.error(\n            \"[zustand devtools middleware] Unsupported action format\"\n          );\n          return;\n        }\n        return parseJsonThen(\n          message.payload,\n          (action) => {\n            if (action.type === \"__setState\") {\n              if (store === void 0) {\n                setStateFromDevtools(action.state);\n                return;\n              }\n              if (Object.keys(action.state).length !== 1) {\n                console.error(\n                  `\n                    [zustand devtools middleware] Unsupported __setState action format. \n                    When using 'store' option in devtools(), the 'state' should have only one key, which is a value of 'store' that was passed in devtools(),\n                    and value of this only key should be a state object. Example: { \"type\": \"__setState\", \"state\": { \"abc123Store\": { \"foo\": \"bar\" } } }\n                    `\n                );\n              }\n              const stateFromDevtools = action.state[store];\n              if (stateFromDevtools === void 0 || stateFromDevtools === null) {\n                return;\n              }\n              if (JSON.stringify(api.getState()) !== JSON.stringify(stateFromDevtools)) {\n                setStateFromDevtools(stateFromDevtools);\n              }\n              return;\n            }\n            if (!api.dispatchFromDevtools)\n              return;\n            if (typeof api.dispatch !== \"function\")\n              return;\n            api.dispatch(action);\n          }\n        );\n      case \"DISPATCH\":\n        switch (message.payload.type) {\n          case \"RESET\":\n            setStateFromDevtools(initialState);\n            if (store === void 0) {\n              return connection == null ? void 0 : connection.init(api.getState());\n            }\n            return connection == null ? void 0 : connection.init(getTrackedConnectionState(options.name));\n          case \"COMMIT\":\n            if (store === void 0) {\n              connection == null ? void 0 : connection.init(api.getState());\n              return;\n            }\n            return connection == null ? void 0 : connection.init(getTrackedConnectionState(options.name));\n          case \"ROLLBACK\":\n            return parseJsonThen(message.state, (state) => {\n              if (store === void 0) {\n                setStateFromDevtools(state);\n                connection == null ? void 0 : connection.init(api.getState());\n                return;\n              }\n              setStateFromDevtools(state[store]);\n              connection == null ? void 0 : connection.init(getTrackedConnectionState(options.name));\n            });\n          case \"JUMP_TO_STATE\":\n          case \"JUMP_TO_ACTION\":\n            return parseJsonThen(message.state, (state) => {\n              if (store === void 0) {\n                setStateFromDevtools(state);\n                return;\n              }\n              if (JSON.stringify(api.getState()) !== JSON.stringify(state[store])) {\n                setStateFromDevtools(state[store]);\n              }\n            });\n          case \"IMPORT_STATE\": {\n            const { nextLiftedState } = message.payload;\n            const lastComputedState = (_a = nextLiftedState.computedStates.slice(-1)[0]) == null ? void 0 : _a.state;\n            if (!lastComputedState)\n              return;\n            if (store === void 0) {\n              setStateFromDevtools(lastComputedState);\n            } else {\n              setStateFromDevtools(lastComputedState[store]);\n            }\n            connection == null ? void 0 : connection.send(\n              null,\n              // FIXME no-any\n              nextLiftedState\n            );\n            return;\n          }\n          case \"PAUSE_RECORDING\":\n            return isRecording = !isRecording;\n        }\n        return;\n    }\n  });\n  return initialState;\n};\nvar devtools = devtoolsImpl;\nvar parseJsonThen = (stringified, f) => {\n  let parsed;\n  try {\n    parsed = JSON.parse(stringified);\n  } catch (e) {\n    console.error(\n      \"[zustand devtools middleware] Could not parse the received json\",\n      e\n    );\n  }\n  if (parsed !== void 0)\n    f(parsed);\n};\nvar subscribeWithSelectorImpl = (fn) => (set, get, api) => {\n  const origSubscribe = api.subscribe;\n  api.subscribe = (selector, optListener, options) => {\n    let listener = selector;\n    if (optListener) {\n      const equalityFn = (options == null ? void 0 : options.equalityFn) || Object.is;\n      let currentSlice = selector(api.getState());\n      listener = (state) => {\n        const nextSlice = selector(state);\n        if (!equalityFn(currentSlice, nextSlice)) {\n          const previousSlice = currentSlice;\n          optListener(currentSlice = nextSlice, previousSlice);\n        }\n      };\n      if (options == null ? void 0 : options.fireImmediately) {\n        optListener(currentSlice, currentSlice);\n      }\n    }\n    return origSubscribe(listener);\n  };\n  const initialState = fn(set, get, api);\n  return initialState;\n};\nvar subscribeWithSelector = subscribeWithSelectorImpl;\n\n// src/vault/store/reducers/mapping-reducer.ts\nvar mappingReducer = (state = {}, action) => {\n  switch (action.type) {\n    case ADD_MAPPING:\n      return {\n        ...state,\n        [action.payload.id]: action.payload.type\n      };\n    case ADD_MAPPINGS:\n      return {\n        ...state,\n        ...action.payload.mapping\n      };\n    default:\n      return state;\n  }\n};\n\n// src/vault/utility/is-reference-list.ts\nfunction isReferenceList(state, id, type, key) {\n  return !(!state[type] || !state[type][id] || !state[type][id][key] || !Array.isArray(state[type][id][key]));\n}\n\n// src/vault/utility/quick-merge.ts\nfunction quickMerge(a, b) {\n  const newResource = {};\n  const added = [];\n  for (const [key, value] of Object.entries(a || {})) {\n    added.push(key);\n    const bValue = (b || {})[key];\n    if (!bValue || bValue.length === 0) {\n      newResource[key] = value;\n      continue;\n    }\n    newResource[key] = bValue;\n  }\n  for (const [key, value] of Object.entries(b || {})) {\n    if (added.indexOf(key) !== -1) {\n      continue;\n    }\n    newResource[key] = value;\n  }\n  return newResource;\n}\n\n// src/vault/store/reducers/entities-reducer.ts\nfunction payload(action) {\n  return action.payload;\n}\nfunction numberOr(a, b) {\n  return typeof a === \"undefined\" ? b : a;\n}\nvar entitiesReducer = (state = getDefaultEntities(), action) => {\n  const updateField = (entity, values) => {\n    return {\n      ...state,\n      [payload(action).type]: {\n        ...state[payload(action).type],\n        [payload(action).id]: {\n          ...entity,\n          ...values\n        }\n      }\n    };\n  };\n  switch (action.type) {\n    case MODIFY_ENTITY_FIELD: {\n      if (!state[payload(action).type] || !state[payload(action).type][payload(action).id]) {\n        return state;\n      }\n      const entity = state[payload(action).type][payload(action).id];\n      if (typeof entity === \"string\") {\n        return state;\n      }\n      return updateField(entity, { [payload(action).key]: payload(action).value });\n    }\n    case REORDER_ENTITY_FIELD: {\n      if (!isReferenceList(state, payload(action).id, payload(action).type, payload(action).key)) {\n        return state;\n      }\n      const entity = state[payload(action).type][payload(action).id];\n      if (typeof entity === \"string\") {\n        return state;\n      }\n      const result = Array.from(entity[payload(action).key]);\n      const [removed] = result.splice(payload(action).startIndex, 1);\n      result.splice(payload(action).endIndex, 0, removed);\n      return updateField(entity, { [payload(action).key]: result });\n    }\n    case IMPORT_ENTITIES: {\n      const keys = Object.keys(payload(action).entities);\n      const toReturn = { ...state };\n      for (const key of keys) {\n        const entities = payload(action).entities[key];\n        const newEntities = { ...state[key] || {} };\n        let changed = false;\n        const ids = Object.keys(entities || {}) || [];\n        if (entities && ids) {\n          for (const id of ids) {\n            changed = true;\n            newEntities[id] = state[key][id] ? quickMerge(state[key][id], entities[id]) : entities[id];\n          }\n          if (changed) {\n            toReturn[key] = newEntities;\n          }\n        }\n      }\n      return toReturn;\n    }\n    case ADD_REFERENCE: {\n      if (!isReferenceList(state, payload(action).id, payload(action).type, payload(action).key)) {\n        return state;\n      }\n      const entity = state[payload(action).type][payload(action).id];\n      const result = Array.from(entity[payload(action).key]);\n      result.splice(numberOr(payload(action).index, result.length + 1), 0, payload(action).reference);\n      return updateField(entity, { [payload(action).key]: result });\n    }\n    case UPDATE_REFERENCE:\n    case REMOVE_REFERENCE: {\n      if (!isReferenceList(state, payload(action).id, payload(action).type, payload(action).key)) {\n        return state;\n      }\n      const entity = state[payload(action).type][payload(action).id];\n      const result = Array.from(entity[payload(action).key]);\n      const indexToRemove = numberOr(\n        payload(action).index,\n        result.findIndex((e) => e && e.id === payload(action).reference.id)\n      );\n      if (indexToRemove === -1 || result[indexToRemove]?.id !== payload(action).reference.id) {\n        return state;\n      }\n      if (action.type === UPDATE_REFERENCE) {\n        result.splice(indexToRemove, 1, payload(action).reference);\n      } else {\n        result.splice(indexToRemove, 1);\n      }\n      return updateField(entity, { [payload(action).key]: result });\n    }\n    case ADD_METADATA: {\n      const entity = state[payload(action).type][payload(action).id];\n      if (!entity) {\n        return state;\n      }\n      const metadata = Array.from(entity.metadata || []);\n      const actionPayload = payload(action);\n      metadata.splice(numberOr(action.payload.beforeIndex, metadata.length + 1), 0, {\n        label: actionPayload.label,\n        value: actionPayload.label\n      });\n      return updateField(entity, { metadata });\n    }\n    case REORDER_METADATA: {\n      const entity = state[payload(action).type][payload(action).id];\n      if (typeof entity === \"string\" || !entity) {\n        return state;\n      }\n      const metadata = Array.from(entity.metadata || []);\n      const [removed] = metadata.splice(payload(action).startIndex, 1);\n      metadata.splice(payload(action).endIndex, 0, removed);\n      return updateField(entity, { metadata });\n    }\n    case UPDATE_METADATA:\n    case REMOVE_METADATA: {\n      const entity = state[payload(action).type][payload(action).id];\n      const metadata = Array.from(entity.metadata || []);\n      const indexToRemove = payload(action).atIndex;\n      if (typeof indexToRemove === \"undefined\" || indexToRemove === -1 || !metadata[indexToRemove]) {\n        return state;\n      }\n      if (action.type === UPDATE_METADATA) {\n        metadata.splice(indexToRemove, 1, { label: payload(action).label, value: payload(action).value });\n      } else {\n        metadata.splice(indexToRemove, 1);\n      }\n      return updateField(entity, { metadata });\n    }\n    default:\n      return state;\n  }\n};\n\n// src/vault/store/reducers/request-reducer.ts\nvar requestReducer = (state = {}, action) => {\n  switch (action.type) {\n    case REQUEST_RESOURCE:\n    case REQUEST_OFFLINE_RESOURCE:\n      return {\n        ...state,\n        [action.payload.id]: {\n          requestUri: action.payload.id,\n          loadingState: RESOURCE_LOADING,\n          uriMismatch: false,\n          resourceUri: action.payload.id\n        }\n      };\n    case REQUEST_MISMATCH:\n      return {\n        ...state,\n        [action.payload.requestId]: {\n          ...state[action.payload.requestId] || {},\n          uriMismatch: true,\n          resourceUri: action.payload.actualId\n        },\n        [action.payload.actualId]: {\n          requestUri: action.payload.requestId,\n          loadingState: state[action.payload.requestId].loadingState,\n          uriMismatch: true,\n          resourceUri: action.payload.actualId\n        }\n      };\n    case REQUEST_ERROR:\n      return {\n        ...state,\n        [action.payload.id]: {\n          ...state[action.payload.id] || {},\n          loadingState: RESOURCE_ERROR,\n          error: action.payload.message\n        }\n      };\n    case REQUEST_COMPLETE:\n      return {\n        ...state,\n        [action.payload.id]: {\n          ...state[action.payload.id] || {},\n          loadingState: RESOURCE_READY,\n          error: void 0\n        }\n      };\n  }\n  return state;\n};\n\n// src/vault/store/reducers/meta-reducer.ts\nvar metaReducer = (state = {}, action) => {\n  const { id, updateValue, value, meta, key } = action && action.payload || {};\n  switch (action.type) {\n    case SET_META_VALUE: {\n      return {\n        ...state,\n        [id]: {\n          ...state[id] || {},\n          [meta]: {\n            ...state[id] ? state[id][meta] || {} : {},\n            [key]: value\n          }\n        }\n      };\n    }\n    case SET_META_VALUE_DYNAMIC: {\n      return {\n        ...state,\n        [id]: {\n          ...state[id] || {},\n          [meta]: {\n            ...state[id] ? state[id][meta] || {} : {},\n            [key]: state[id] && state[id][meta] ? updateValue(state[id][meta][key]) : updateValue(void 0)\n          }\n        }\n      };\n    }\n    case UNSET_META_VALUE: {\n      if (state[id] && state[id][meta] && state[id][meta][key]) {\n        return {\n          ...state,\n          [id]: {\n            ...state[id] || {},\n            [meta]: {\n              ...state[id] ? state[id][meta] || {} : {},\n              [key]: void 0\n            }\n          }\n        };\n      }\n      return state;\n    }\n    default:\n      return state;\n  }\n};\n\n// src/vault/utility/combine-reducers.ts\nfunction combineReducers(reducers2 = {}) {\n  const reducerKeys = Object.keys(reducers2);\n  return function combination(state = {}, action) {\n    let hasChanged = false;\n    const nextState = {};\n    for (let i = 0; i < reducerKeys.length; i++) {\n      const key = reducerKeys[i];\n      nextState[key] = reducers2[key](state[key], action);\n      hasChanged = hasChanged || nextState[key] !== state[key];\n    }\n    return hasChanged ? nextState : state;\n  };\n}\n\n// src/vault/store/reducers/batch-reducer.ts\nfunction createBatchReducer(rootReducer) {\n  return (state, action) => {\n    if (action && action.type === BATCH_ACTIONS) {\n      return action.payload.actions.reduce(rootReducer, state);\n    }\n    if (action && action.type === BATCH_IMPORT) {\n      return {\n        ...state,\n        iiif: {\n          ...state.iiif,\n          ...action.payload.state\n        }\n      };\n    }\n    return rootReducer(state, action);\n  };\n}\n\n// src/vault/store/index.ts\nvar reducers = combineReducers({\n  mapping: mappingReducer,\n  entities: entitiesReducer,\n  requests: requestReducer,\n  meta: metaReducer\n});\nfunction getDefaultState() {\n  return {\n    iiif: {\n      entities: getDefaultEntities(),\n      meta: {},\n      mapping: {},\n      requests: {}\n    }\n  };\n}\nfunction createStore2(options = {}) {\n  const {\n    enableDevtools = false,\n    iiifStoreName = \"iiif\",\n    defaultState = getDefaultState(),\n    customReducers = {}\n  } = options;\n  const rootReducer = createBatchReducer(combineReducers({ [iiifStoreName]: reducers, ...customReducers }));\n  const enabled = Boolean(typeof window !== \"undefined\" && window.__REDUX_DEVTOOLS_EXTENSION__);\n  const dv = !enabled || false ? (a, r) => a : devtools;\n  return createStore(\n    //\n    subscribeWithSelector(\n      //\n      dv(\n        //\n        redux(rootReducer, defaultState),\n        { enabled: enableDevtools }\n      )\n    )\n  );\n}\n\nexport {\n  reducers,\n  createStore2 as createStore\n};\n","// node_modules/.pnpm/mitt@3.0.1/node_modules/mitt/dist/mitt.mjs\nfunction mitt_default(n) {\n  return { all: n = n || /* @__PURE__ */ new Map(), on: function(t, e) {\n    var i = n.get(t);\n    i ? i.push(e) : n.set(t, [e]);\n  }, off: function(t, e) {\n    var i = n.get(t);\n    i && (e ? i.splice(i.indexOf(e) >>> 0, 1) : n.set(t, []));\n  }, emit: function(t, e) {\n    var i = n.get(t);\n    i && i.slice().map(function(n2) {\n      n2(e);\n    }), (i = n.get(\"*\")) && i.slice().map(function(n2) {\n      n2(t, e);\n    });\n  } };\n}\n\nexport {\n  mitt_default\n};\n","var __create = Object.create;\nvar __defProp = Object.defineProperty;\nvar __getOwnPropDesc = Object.getOwnPropertyDescriptor;\nvar __getOwnPropNames = Object.getOwnPropertyNames;\nvar __getProtoOf = Object.getPrototypeOf;\nvar __hasOwnProp = Object.prototype.hasOwnProperty;\nvar __defNormalProp = (obj, key, value) => key in obj ? __defProp(obj, key, { enumerable: true, configurable: true, writable: true, value }) : obj[key] = value;\nvar __commonJS = (cb, mod) => function __require() {\n  return mod || (0, cb[__getOwnPropNames(cb)[0]])((mod = { exports: {} }).exports, mod), mod.exports;\n};\nvar __copyProps = (to, from, except, desc) => {\n  if (from && typeof from === \"object\" || typeof from === \"function\") {\n    for (let key of __getOwnPropNames(from))\n      if (!__hasOwnProp.call(to, key) && key !== except)\n        __defProp(to, key, { get: () => from[key], enumerable: !(desc = __getOwnPropDesc(from, key)) || desc.enumerable });\n  }\n  return to;\n};\nvar __toESM = (mod, isNodeMode, target) => (target = mod != null ? __create(__getProtoOf(mod)) : {}, __copyProps(\n  // If the importer is in node compatibility mode or this is not an ESM\n  // file that has been converted to a CommonJS file using a Babel-\n  // compatible transform (i.e. \"__esModule\" has not been set), then set\n  // \"default\" to the CommonJS \"module.exports\" for node compatibility.\n  isNodeMode || !mod || !mod.__esModule ? __defProp(target, \"default\", { value: mod, enumerable: true }) : target,\n  mod\n));\nvar __publicField = (obj, key, value) => {\n  __defNormalProp(obj, typeof key !== \"symbol\" ? key + \"\" : key, value);\n  return value;\n};\n\nexport {\n  __commonJS,\n  __toESM,\n  __publicField\n};\n","import {\n  areInputsEqual,\n  createFetchHelper\n} from \"./chunk-EIMQCVDV.js\";\nimport {\n  createStore\n} from \"./chunk-OFD6EF4T.js\";\nimport {\n  metaActions\n} from \"./chunk-YAISZCRN.js\";\nimport {\n  BATCH_ACTIONS,\n  batchActions,\n  entityActions\n} from \"./chunk-F2Q2OM3J.js\";\nimport {\n  mitt_default\n} from \"./chunk-6NZ5BWVI.js\";\nimport {\n  __publicField\n} from \"./chunk-G7A32JAG.js\";\n\n// src/vault/vault.ts\nimport {\n  frameResource,\n  HAS_PART,\n  isSpecificResource,\n  PART_OF,\n  serialize,\n  serializeConfigPresentation2,\n  serializeConfigPresentation3\n} from \"@iiif/parser\";\n\n// src/vault/utility/objects.ts\nfunction defineProperty(name, prototype, vault, enumerable = true) {\n  prototype[DEFINED] = prototype[DEFINED] || [];\n  prototype[DEFINED].push(name);\n  const cache = /* @__PURE__ */ new Map();\n  Object.defineProperty(prototype, name, {\n    enumerable,\n    get() {\n      if (typeof prototype[REFS][name] === \"undefined\") {\n        return void 0;\n      }\n      const ref = prototype[REFS][name];\n      if (!ref) {\n        return ref;\n      }\n      const object = vault.get(prototype[REFS][name], {\n        parent: this.id ? { id: this.id, type: this.type } : void 0\n      });\n      if (!cache.has(object)) {\n        cache.clear();\n        cache.set(object, wrapObject(object, vault));\n      }\n      return cache.get(object);\n    },\n    set(items) {\n      const existing = prototype[REFS][name];\n      if (existing !== items) {\n        if (this[REACTIVE]) {\n          vault.modifyEntityField({ id: this.id, type: this.type }, name, unwrapObject(items));\n        } else {\n          this[REFS][name] = items;\n        }\n      }\n    }\n  });\n}\nvar REFS = Symbol.for(\"_refs_\");\nvar REACTIVE = Symbol.for(\"_reactive_\");\nvar DEFINED = Symbol.for(\"_defined_\");\nvar PARENT = Symbol.for(\"_parent_\");\nfunction createPrototype(vault, reactive = false, parent) {\n  const prototype = {\n    id: \"\",\n    type: \"unknown\",\n    [DEFINED]: [],\n    [REFS]: {},\n    [PARENT]: parent || null,\n    [REACTIVE]: null,\n    is(refOrObject) {\n      if (typeof refOrObject === \"string\") {\n        return this.id === refOrObject;\n      }\n      if (refOrObject.id) {\n        return refOrObject.id === this.id;\n      }\n      return false;\n    },\n    reactive() {\n      if (this[REACTIVE]) {\n        return;\n      }\n      this[REACTIVE] = this.subscribe(() => this.refresh(), true);\n      return () => {\n        this.unreactive();\n      };\n    },\n    refresh() {\n      if (this.id) {\n        const fresh = this.unwrap();\n        for (const key of Object.keys(fresh || {})) {\n          if (this[DEFINED].includes(key)) {\n            this[REFS][key] = fresh[key];\n          } else {\n            this[key] = fresh[key];\n          }\n        }\n      }\n    },\n    unreactive() {\n      if (this[REACTIVE]) {\n        this[REACTIVE]();\n        this[REACTIVE] = null;\n      }\n    },\n    unwrap() {\n      if (!this.id) {\n        throw new Error(\"Invalid object\");\n      }\n      const parent2 = this[PARENT];\n      return vault.get(this.id, { parent: parent2 ? { id: parent2, type: \"unknown\" } : void 0 });\n    },\n    toPresentation3() {\n      return vault.toPresentation3(this.unwrap());\n    },\n    toPresentation2() {\n      return vault.toPresentation2(this.unwrap());\n    },\n    valueOf() {\n      return this.unwrap();\n    },\n    toJSON() {\n      const that = this;\n      return {\n        ...that,\n        items: that.items,\n        annotations: that.annotations,\n        structures: that.structures,\n        seeAlso: that.seeAlso,\n        service: that.service,\n        services: that.services,\n        rendering: that.rendering,\n        partOf: that.partOf,\n        start: that.start,\n        supplementary: that.supplementary,\n        homepage: that.homepage,\n        thumbnail: that.thumbnail,\n        placeholderCanvas: that.placeholderCanvas,\n        accompanyingCanvas: that.accompanyingCanvas,\n        provider: that.provider\n      };\n    },\n    subscribe(subscription, skipInitial = true) {\n      return vault.subscribe(\n        () => {\n          return this.id ? vault.get(this.id) : null;\n        },\n        subscription,\n        skipInitial\n      );\n    }\n  };\n  defineProperty(\"items\", prototype, vault);\n  defineProperty(\"annotations\", prototype, vault);\n  defineProperty(\"structures\", prototype, vault);\n  defineProperty(\"seeAlso\", prototype, vault);\n  defineProperty(\"rendering\", prototype, vault);\n  defineProperty(\"partOf\", prototype, vault);\n  defineProperty(\"start\", prototype, vault, false);\n  defineProperty(\"supplementary\", prototype, vault);\n  defineProperty(\"homepage\", prototype, vault);\n  defineProperty(\"thumbnail\", prototype, vault);\n  defineProperty(\"placeholderCanvas\", prototype, vault, false);\n  defineProperty(\"accompanyingCanvas\", prototype, vault, false);\n  defineProperty(\"provider\", prototype, vault);\n  defineProperty(\"body\", prototype, vault);\n  defineProperty(\"logo\", prototype, vault);\n  return prototype;\n}\nfunction isWrapped(object) {\n  return !!object[DEFINED];\n}\nfunction unwrapObject(object) {\n  if (Array.isArray(object)) {\n    return object.map((o) => unwrapObject(o));\n  }\n  if (!object || !object.type) {\n    return object;\n  }\n  return { id: object.id, type: object.type };\n}\nfunction wrapObject(object, vault, reactive = false, parent) {\n  if (Array.isArray(object)) {\n    return object.map((o) => wrapObject(o, vault, reactive));\n  }\n  if (!object || !object.type || !object.id) {\n    return object;\n  }\n  const prototype = createPrototype(vault, reactive);\n  const newObject = Object.create(prototype);\n  const wrapped = Object.assign(newObject, object);\n  if (reactive) {\n    wrapped.reactive();\n  }\n  return wrapped;\n}\n\n// src/vault/utility/resolve-type.ts\nfunction resolveType(type) {\n  switch (type) {\n    case \"Image\":\n    case \"Video\":\n    case \"Sound\":\n    case \"Dataset\":\n    case \"Text\":\n    case \"Composite\":\n    case \"List\":\n    case \"Independents\":\n    case \"Audience\":\n      return \"ContentResource\";\n    case \"ImageService1\":\n    case \"ImageService2\":\n    case \"ImageService3\":\n      return \"Service\";\n  }\n  return type;\n}\n\n// src/vault/vault.ts\nvar Vault = class {\n  constructor(options, store) {\n    __publicField(this, \"options\");\n    __publicField(this, \"store\");\n    __publicField(this, \"emitter\");\n    __publicField(this, \"isBatching\", false);\n    __publicField(this, \"batchQueue\", []);\n    __publicField(this, \"remoteFetcher\");\n    __publicField(this, \"staticFetcher\");\n    __publicField(this, \"defaultFetcher\", (url) => {\n      return fetch(url).then((r) => {\n        if (r.status === 200) {\n          return r.json();\n        } else {\n          const err = new Error(`${r.status} ${r.statusText}`);\n          err.name = `HTTPError`;\n          throw err;\n        }\n      });\n    });\n    this.options = Object.assign(\n      {\n        reducers: {},\n        customFetcher: this.defaultFetcher,\n        enableDevtools: true\n      },\n      options || {}\n    );\n    this.store = store || createStore({\n      customReducers: this.options.reducers,\n      defaultState: this.options.defaultState,\n      enableDevtools: this.options.enableDevtools\n    });\n    this.emitter = mitt_default();\n    this.remoteFetcher = createFetchHelper(this, this.options.customFetcher);\n    this.staticFetcher = createFetchHelper(this, (id, json) => json);\n  }\n  batch(cb) {\n    this.isBatching = true;\n    try {\n      cb(this);\n      this.isBatching = false;\n      this.dispatch(batchActions({ actions: this.batchQueue }));\n    } catch (e) {\n      this.batchQueue = [];\n      this.isBatching = false;\n      throw e;\n    }\n    this.batchQueue = [];\n  }\n  async asyncBatch(cb) {\n    this.isBatching = true;\n    try {\n      await cb(this);\n      this.isBatching = false;\n      this.dispatch(batchActions({ actions: this.batchQueue }));\n    } catch (e) {\n      this.batchQueue = [];\n      this.isBatching = false;\n      throw e;\n    }\n    this.batchQueue = [];\n  }\n  modifyEntityField(entity, key, value) {\n    this.dispatch(\n      entityActions.modifyEntityField({\n        id: entity.id,\n        type: entity.type,\n        key,\n        value\n      })\n    );\n  }\n  dispatch(action) {\n    if (!this.isBatching) {\n      if (action.type === BATCH_ACTIONS) {\n        for (const realAction of action.payload.actions) {\n          this.emitter.emit(realAction.type, { action: realAction, state: this.store.getState() });\n        }\n        this.store.dispatch(action);\n        const state2 = this.getState();\n        for (const realAction of action.payload.actions) {\n          this.emitter.emit(`after:${realAction.type}`, { action: realAction, state: state2 });\n        }\n        return;\n      }\n      this.emitter.emit(action.type, { action, state: this.store.getState() });\n      this.store.dispatch(action);\n      const state = this.store.getState();\n      this.emitter.emit(`after:${action.type}`, { action, state });\n      return;\n    } else {\n      this.batchQueue.push(action);\n    }\n  }\n  on(event, handler) {\n    this.emitter.on(event, handler);\n    return () => {\n      this.emitter.off(event, handler);\n    };\n  }\n  serialize(entity, config) {\n    return serialize(this.getState().iiif, entity, config);\n  }\n  toPresentation2(entity) {\n    return this.serialize(entity, serializeConfigPresentation2);\n  }\n  toPresentation3(entity) {\n    return this.serialize(entity, serializeConfigPresentation3);\n  }\n  hydrate(reference, type, options = {}) {\n    return this.get(reference, type, { ...options, skipSelfReturn: false });\n  }\n  get(reference, type, options = {}) {\n    if (typeof type !== \"string\") {\n      options = type || {};\n      type = void 0;\n    }\n    const { skipSelfReturn = true } = options || {};\n    let parent = options.parent ? typeof options.parent === \"string\" ? options.parent : options.parent.id : void 0;\n    if (Array.isArray(reference)) {\n      return reference.map((i) => this.get(i, options));\n    }\n    const state = this.getState();\n    if (isSpecificResource(reference) && !options.preserveSpecificResources) {\n      reference = reference.source;\n    }\n    if (typeof reference === \"string\") {\n      const _type2 = resolveType(type ? type : state.iiif.mapping[reference]);\n      if (!_type2) {\n        if (skipSelfReturn) {\n          return null;\n        }\n        return { id: reference, type: \"unknown\" };\n      }\n      reference = { id: reference, type: _type2 };\n    }\n    if (reference && reference.partOf && !parent && !options.skipPartOfCheck) {\n      const first = Array.isArray(reference.partOf) ? reference.partOf[0] : reference.partOf;\n      if (first) {\n        if (typeof first === \"string\") {\n          parent = first;\n        }\n        if (typeof first.id === \"string\") {\n          parent = first.id;\n        }\n      }\n    }\n    const _type = resolveType(type ? type : reference?.type);\n    const _id = reference?.id;\n    const entities = state.iiif.entities[_type];\n    if (!entities) {\n      const request = state.iiif.requests[_id];\n      if (request && request.resourceUri !== _id) {\n        return this.get(request.resourceUri, options);\n      }\n      if (skipSelfReturn) {\n        return null;\n      }\n      return reference;\n    }\n    const found = entities[reference.id];\n    if (found && found[HAS_PART]) {\n      const framing = found[HAS_PART].find((t) => {\n        return parent ? t[PART_OF] === parent : t[PART_OF] === found.id;\n      });\n      return frameResource(found, framing);\n    }\n    return entities[reference.id] || (skipSelfReturn ? null : reference);\n  }\n  select(selector) {\n    return selector(this.getState());\n  }\n  getStore() {\n    return this.store;\n  }\n  getState() {\n    return this.store.getState();\n  }\n  deep(input, prev) {\n    if (typeof input === \"undefined\") {\n      return this.get(prev, { skipSelfReturn: false });\n    }\n    if (typeof input === \"function\") {\n      try {\n        const next = input(this.get(prev, { skipSelfReturn: false }));\n        const fn2 = (newInput) => this.deep(newInput, next);\n        fn2.size = Array.isArray(next) ? next.length : 1;\n        return fn2;\n      } catch (e) {\n        const fn2 = (newInput) => this.deep(newInput, void 0);\n        fn2.size = 0;\n        return fn2;\n      }\n    }\n    const fn = (newInput) => this.deep(newInput, input);\n    fn.size = Array.isArray(input) ? input.length : 1;\n    return fn;\n  }\n  loadManifest(id, json) {\n    const _id = typeof id === \"string\" ? id : id.id;\n    return this.load(_id, json);\n  }\n  loadCollection(id, json) {\n    const _id = typeof id === \"string\" ? id : id.id;\n    return this.load(_id, json);\n  }\n  load(id, json) {\n    const _id = typeof id === \"string\" ? id : id.id;\n    if (json) {\n      return Promise.resolve(this.staticFetcher(_id, json));\n    }\n    return Promise.resolve(this.remoteFetcher(_id));\n  }\n  loadSync(id, json) {\n    const _id = typeof id === \"string\" ? id : id.id;\n    return this.staticFetcher(_id, json);\n  }\n  loadManifestSync(id, json) {\n    const _id = typeof id === \"string\" ? id : id.id;\n    return this.loadSync(_id, json);\n  }\n  loadCollectionSync(id, json) {\n    const _id = typeof id === \"string\" ? id : id.id;\n    return this.loadSync(_id, json);\n  }\n  areInputsEqual(newInputs, lastInputs) {\n    return areInputsEqual(newInputs, lastInputs);\n  }\n  subscribe(selector, subscription, skipInitial) {\n    if (typeof skipInitial === \"undefined\" && (typeof subscription === \"undefined\" || subscription === false || subscription === true)) {\n      skipInitial = subscription;\n      subscription = selector;\n      selector = (a) => a;\n    }\n    return this.store.subscribe(selector, (s) => subscription(s, this), {\n      equalityFn: areInputsEqual,\n      fireImmediately: !skipInitial\n    });\n  }\n  async ensureLoaded(_id) {\n    const id = typeof _id === \"string\" ? _id : _id.id;\n    if (!this.requestStatus(id)) {\n      await this.load(id);\n    }\n  }\n  requestStatus(id) {\n    return this.select((state) => {\n      return state.iiif.requests[id];\n    });\n  }\n  getResourceMeta(resource, metaKey) {\n    const resourceMeta = this.getState().iiif.meta[resource];\n    if (!resourceMeta) {\n      return void 0;\n    }\n    if (!metaKey) {\n      return resourceMeta;\n    }\n    return resourceMeta[metaKey];\n  }\n  getObject(reference, type, options = {}) {\n    const { reactive, ...otherOptions } = options;\n    return wrapObject(this.get(reference, type, otherOptions), this, reactive);\n  }\n  async loadObject(id, json) {\n    return wrapObject(await this.load(id, json), this);\n  }\n  async loadManifestObject(id, json) {\n    return wrapObject(await this.loadManifest(id, json), this);\n  }\n  async loadCollectionObject(id, json) {\n    return wrapObject(await this.loadCollection(id, json), this);\n  }\n  wrapObject(objectType) {\n    return wrapObject(this.get(objectType, { skipSelfReturn: false }), this);\n  }\n  isWrapped(object) {\n    return isWrapped(object);\n  }\n  setMetaValue([id, meta, key], newValueOrUpdate) {\n    this.dispatch(\n      typeof newValueOrUpdate === \"function\" ? metaActions.setMetaValueDynamic({\n        id,\n        meta,\n        key,\n        updateValue: newValueOrUpdate\n      }) : metaActions.setMetaValue({\n        id,\n        meta,\n        key,\n        value: newValueOrUpdate\n      })\n    );\n  }\n};\n\n// src/vault/utility/get-global.ts\nfunction getGlobal() {\n  if (typeof self !== \"undefined\") {\n    return self;\n  }\n  if (typeof window !== \"undefined\") {\n    return window;\n  }\n  if (typeof global !== \"undefined\") {\n    return global;\n  }\n  return {};\n}\n\nexport {\n  Vault,\n  getGlobal\n};\n","import {\n  Vault,\n  getGlobal\n} from \"./chunk-CWG5H2NE.js\";\n\n// src/vault/global-vault.ts\nfunction globalVault(options) {\n  const g = getGlobal();\n  try {\n    const gv = g[\"IIIF_VAULT\"];\n    if (gv) {\n      return gv;\n    }\n  } catch (e) {\n  }\n  const newVault = new Vault(options);\n  try {\n    g[\"IIIF_VAULT\"] = newVault;\n  } catch (e) {\n  }\n  return newVault;\n}\n\nexport {\n  globalVault\n};\n","// src/i18n.ts\nimport { Traverse } from \"@iiif/parser\";\nfunction getClosestLanguage(i18nLanguage, languages, i18nLanguages = [], strictFallback = false, skipLanguages = []) {\n  if (skipLanguages.length) {\n    languages = languages.filter((l) => skipLanguages.indexOf(l) === -1);\n  }\n  if (!languages || languages.length === 0) {\n    return void 0;\n  }\n  if (languages.length === 1) {\n    return languages[0];\n  }\n  if (!i18nLanguage) {\n    if (languages.indexOf(\"none\") !== -1) {\n      return \"none\";\n    }\n    return languages[0];\n  }\n  if (languages.indexOf(i18nLanguage) !== -1) {\n    return i18nLanguage;\n  }\n  const root = i18nLanguage.indexOf(\"-\") !== -1 ? i18nLanguage.slice(0, i18nLanguage.indexOf(\"-\")) : null;\n  if (root && languages.indexOf(root) !== -1) {\n    return root;\n  }\n  for (const lang of i18nLanguages) {\n    if (languages.indexOf(lang) !== -1) {\n      return lang;\n    }\n  }\n  if (!strictFallback && i18nLanguage) {\n    const inverseRoot = languages.map((l) => l.indexOf(\"-\") !== -1 ? l.slice(0, l.indexOf(\"-\")) : null);\n    const inverseIdx = inverseRoot.indexOf(i18nLanguage);\n    if (inverseIdx !== -1) {\n      return languages[inverseIdx];\n    }\n    for (const lang of i18nLanguages) {\n      const root2 = lang.indexOf(\"-\") !== -1 ? lang.slice(0, lang.indexOf(\"-\")) : null;\n      const inverseIdx2 = root2 ? languages.indexOf(root2) : -1;\n      if (inverseIdx2 !== -1) {\n        return languages[inverseIdx2];\n      }\n    }\n  }\n  if (languages.indexOf(\"none\") !== -1) {\n    return \"none\";\n  }\n  if (languages.indexOf(\"@none\") !== -1) {\n    return \"@none\";\n  }\n  return languages[0];\n}\nfunction buildLocaleString(inputText, i18nLanguage, options = {}) {\n  const {\n    strictFallback = false,\n    defaultText = \"\",\n    separator = \"\\n\",\n    fallbackLanguages = [],\n    closest,\n    skipLanguages\n  } = options;\n  const languages = Object.keys(inputText || {});\n  const language = closest ? i18nLanguage : getClosestLanguage(i18nLanguage, languages, fallbackLanguages, strictFallback, skipLanguages);\n  if (!inputText) {\n    return defaultText;\n  }\n  if (typeof inputText === \"string\") {\n    return inputText;\n  }\n  const candidateText = language ? inputText[language] : void 0;\n  if (candidateText && language) {\n    if (typeof candidateText === \"string\") {\n      return candidateText;\n    }\n    if (candidateText.length === 1 && candidateText[0] === \"\") {\n      const skip = options.skipLanguages || [];\n      return buildLocaleString(inputText, i18nLanguage, {\n        ...options,\n        skipLanguages: [...skip, language]\n      });\n    }\n    return candidateText.join(separator);\n  }\n  return \"\";\n}\nfunction getValue(inputText, options = {}) {\n  return buildLocaleString(\n    inputText,\n    options.language || (typeof navigator !== \"undefined\" ? navigator.language : \"en\"),\n    options\n  );\n}\nfunction getLanguagesFromLanguageMap(languageMap) {\n  if (!languageMap)\n    return [];\n  if (typeof languageMap === \"string\")\n    return [];\n  if (Array.isArray(languageMap))\n    return [];\n  return Object.keys(languageMap).filter((l) => l !== \"none\");\n}\nfunction getAvailableLanguagesFromResource(item) {\n  const foundLanguages = /* @__PURE__ */ new Set();\n  const findLanguages = Traverse.all((resource) => {\n    if (\"label\" in resource) {\n      const languages = getLanguagesFromLanguageMap(resource.label);\n      languages.forEach((l) => foundLanguages.add(l));\n    }\n    if (\"summary\" in resource) {\n      const languages = getLanguagesFromLanguageMap(resource.summary);\n      languages.forEach((l) => foundLanguages.add(l));\n    }\n    if (\"language\" in resource) {\n      if (typeof resource.language === \"string\") {\n        foundLanguages.add(resource.language);\n      }\n    }\n    if (\"requiredStatement\" in resource) {\n      if (resource.requiredStatement && !Array.isArray(resource.requiredStatement)) {\n        if (\"label\" in resource.requiredStatement) {\n          const languages = getLanguagesFromLanguageMap(resource.requiredStatement.label);\n          languages.forEach((l) => foundLanguages.add(l));\n        }\n        if (\"value\" in resource.requiredStatement) {\n          const languages = getLanguagesFromLanguageMap(resource.requiredStatement.value);\n          languages.forEach((l) => foundLanguages.add(l));\n        }\n      }\n    }\n    if (\"metadata\" in resource) {\n      if (Array.isArray(resource.metadata)) {\n        resource.metadata.forEach((m) => {\n          if (\"label\" in m) {\n            const languages = getLanguagesFromLanguageMap(m.label);\n            languages.forEach((l) => foundLanguages.add(l));\n          }\n          if (\"value\" in m) {\n            const languages = getLanguagesFromLanguageMap(m.value);\n            languages.forEach((l) => foundLanguages.add(l));\n          }\n        });\n      }\n    }\n  });\n  findLanguages.traverseUnknown(item);\n  return Array.from(foundLanguages);\n}\n\nexport {\n  getClosestLanguage,\n  buildLocaleString,\n  getValue,\n  getAvailableLanguagesFromResource\n};\n","import{A as le,B as xe,C as ge,D as ce,E as g,F as u,G as I,H as he,I as c,J as v,K as w,L as F,M as z,a as U,b as N,c as C,d as k,e as Z,f as D,g as G,h as J,i as K,j as V,k as X,l as Y,m as _,n as q,o as ee,p as ie,q as te,r as re,s as oe,t as ae,u as ne,v as fe,w as se,x as me,y as ue,z as pe}from\"./chunk-J657UVVW.js\";import\"./chunk-D22QKJZO.js\";function de(i){let e=i.replace(/(https?:\\/\\/)?(www.)?/i,\"\");return e.indexOf(\"/\")!==-1?e.split(\"/\")[0]:e}function A(i){try{if(i===\"full\")return{full:!0};if(i===\"square\")return{square:!0};let e=i.startsWith(\"pct:\"),o=i.substr(e?4:0).split(\",\").map(r=>parseFloat(r));return{x:o[0],y:o[1],w:o[2],h:o[3],percent:e}}catch{throw new Error(\"Expected 'full', 'square' or 'x,y,w,h'. Found \"+i)}}function P(i){let e={upscaled:!1,max:!1,confined:!1};if(i[0]===\"^\"&&(e.upscaled=!0,i=i.slice(1)),i===\"max\"||i===\"full\")return e.max=!0,e.serialiseAsFull=i===\"full\",e;if(i[0]===\"!\"&&(e.confined=!0,i=i.slice(1)),i[0]===\"p\")return e.percentScale=parseFloat(i.slice(4)),e;let t=i.split(\",\").map(o=>o.trim());return t.length&&(t[0]!==\"\"&&(e.width=parseInt(t[0],10)),t[1]!==\"\"&&(e.height=parseInt(t[1],10))),e}function $(i){let e={angle:0};if(i[0]===\"!\"&&(e.mirror=!0,i=i.substr(1)),e.angle=parseFloat(i)%360,Number.isNaN(e.angle))throw new Error(`Invalid rotation ${i}`);return e}function R(i,e=\"\"){let t=i.match(/^(([a-zA-Z]+):\\/\\/([^/]+))?((.*)+)/);if(!t)throw new Error(`Invalid or unknown input ${i}`);let o=t[2],r=t[3],a=t[4];if(a[0]===\"/\"&&(a=a.substring(1)),e.length>0){if(e[0]===\"/\"&&(e=e.substring(1)),e!==a.substring(0,e.length))throw new Error(`Path does not start with prefix (path: ${a}, prefix: ${e})`);a=a.substring(e.length)}return{scheme:o,server:r,path:a,prefix:e}}function O(i,e=\"\"){let{path:t,scheme:o,server:r,prefix:a}=R(i,e),n=t.split(\"/\").reverse(),[s,f,p,l,...y]=n,x=y.reverse().filter(Boolean).join(\"/\");if(n.length===1||s===\"\")return{type:\"base\",scheme:o,server:r,prefix:a,identifier:x};if(s===\"info.json\"){let[,...E]=n;return{type:\"info\",scheme:o,server:r,prefix:a,identifier:E.reverse().filter(Boolean).join(\"/\")}}if(typeof o>\"u\"||typeof r>\"u\"||typeof t>\"u\"||typeof l>\"u\"||typeof p>\"u\"||typeof f>\"u\"||typeof s>\"u\")throw new Error(\"Invalid image service URL\");let[M=\"\",T=\"\"]=s.split(\".\");return{type:\"image\",scheme:o,server:r,prefix:a,identifier:x,originalPath:t,region:A(l),size:P(p),rotation:$(f),quality:M,format:T}}function b(i){return g.indexOf(i)!==-1?F:u.indexOf(i)!==-1?w:v}function h(i){let e=i?Array.isArray(i.profile)?i.profile:[i.profile]:[],t={extraQualities:[],extraFormats:[],extraFeatures:[]};for(let o of e)if(typeof o==\"string\"&&(o=b(o)),!!o){if(o.formats)for(let r of o.formats)t.extraFormats.indexOf(r)===-1&&t.extraFormats.push(r);if(o.qualities)for(let r of o.qualities)t.extraQualities.indexOf(r)===-1&&t.extraQualities.push(r);if(o.supports)for(let r of o.supports)t.extraFeatures.indexOf(r)===-1&&t.extraFeatures.push(r);if(o.maxHeight&&(t.maxHeight=o.maxHeight),o.maxWidth&&(t.maxWidth=o.maxWidth),o.maxArea&&(t.maxArea=o.maxArea),o.extraFormats)for(let r of o.extraFormats)t.extraFormats.indexOf(r)===-1&&t.extraFormats.push(r);if(o.extraQualities)for(let r of o.extraQualities)t.extraQualities.indexOf(r)===-1&&t.extraQualities.push(r);if(o.extraFeatures)for(let r of o.extraFeatures)t.extraFeatures.indexOf(r)===-1&&t.extraFeatures.push(r);o.maxHeight&&(t.maxHeight=o.maxHeight),o.maxWidth&&(t.maxWidth=o.maxWidth),o.maxArea&&(t.maxArea=o.maxArea)}if(i.extraFormats)for(let o of i.extraFormats)t.extraFormats.indexOf(o)===-1&&t.extraFormats.push(o);if(i.extraFeatures)for(let o of i.extraFeatures)t.extraFeatures.indexOf(o)===-1&&t.extraFeatures.push(o);if(i.extraQualities)for(let o of i.extraQualities)t.extraQualities.indexOf(o)===-1&&t.extraQualities.push(o);return t}function Qe(i){let e=Array.isArray(i.profile)?i.profile:[i.profile];for(let t of e)if(typeof t==\"string\"&&c.indexOf(t)!==-1)return!0;return!1}function W(i){if(i[\"@id\"])return i[\"@id\"];if(i.id)return i.id}function m(i){if(!i||!i.profile||!W(i))return!1;let e=Array.isArray(i.profile)?i.profile:[i.profile];for(let t of e)if(typeof t==\"string\"&&I.indexOf(t)!==-1)return!0;return!1}function d(i,e){if(!m(i))return[!1,\"Not a valid image service\"];e.extraFeatures=e.extraFeatures?e.extraFeatures:[];let t=h(i);if(e.exactSize){let o=!1;if(i.sizes)for(let r of i.sizes)r.width&&r.width===e.exactSize.width&&(z.indexOf(\"sizeByW\")!==-1||r.height&&r.height===e.exactSize.height)&&(o=!0),r.height&&r.height===e.exactSize.height&&(z.indexOf(\"sizeByH\")!==-1||r.width&&r.width===e.exactSize.width)&&(o=!0);o||(e.maxWidth=Math.max(e.maxWidth||0,e.exactSize.width||0)||void 0,e.maxHeight=Math.max(e.maxHeight||0,e.exactSize.height||0)||void 0,e.maxArea=Math.max(e.maxArea||0,(e.exactSize.width&&e.exactSize.height?e.exactSize.width*e.exactSize.height:e.maxArea)||0)||void 0,!e.exactSize.height&&e.exactSize.width?e.extraFeatures.indexOf(\"sizeByW\")===-1&&e.extraFeatures.push(\"sizeByW\"):!e.exactSize.width&&e.exactSize.height&&e.extraFeatures.indexOf(\"sizeByH\")===-1&&e.extraFeatures.push(\"sizeByH\"))}if(e.maxArea&&t.maxArea&&e.maxArea>t.maxArea)return[!1,`Max area is ${t.maxArea}`];if(e.maxWidth&&t.maxWidth&&e.maxWidth>t.maxWidth)return[!1,`Max width is ${t.maxWidth}`];if(e.maxHeight&&t.maxHeight&&e.maxHeight>t.maxHeight)return[!1,`Max height is ${t.maxHeight}`];if(e.extraFeatures){let o=[];for(let r of e.extraFeatures)t.extraFeatures.indexOf(r)===-1&&o.push(r);if(o.length)return[!1,`Missing features: ${o.join(\", \")}`]}if(e.extraFormats){let o=[];for(let r of e.extraFormats)t.extraFormats.indexOf(r)===-1&&o.push(r);if(o.length)return[!1,`Missing formats: ${o.join(\", \")}`]}if(e.extraQualities){let o=[];for(let r of e.extraQualities)t.extraQualities.indexOf(r)===-1&&o.push(r);if(o.length)return[!1,`Missing qualities: ${o.join(\", \")}`]}return[!0]}function Ke(i){if(!m(i))return!1;let e=Array.isArray(i.profile)?i.profile:[i.profile];for(let t of e)if(typeof t==\"string\"){if(u.indexOf(t)!==-1)return!0}else{let o=[...t.supports||[],...t.extraFeatures||[]];if(o.indexOf(\"regionByPx\")!==-1&&(o.indexOf(\"sizeByW\")!==-1||o.indexOf(\"sizeByWh\")!==-1))return!0}return!1}function Ye(i,e){return d(i,{extraFormats:[e]})}function ei(i,e){if(e.type!==\"image\")return[!0];let t=[];e.rotation.mirror&&t.push(\"mirroring\"),e.region.percent&&t.push(\"regionByPct\"),e.region.square?t.push(\"regionSquare\"):e.region.full||t.push(\"regionByPx\"),e.rotation.angle&&(e.rotation.angle%90?t.push(\"rotationArbitrary\"):t.push(\"rotationBy90s\")),e.size.confined&&t.push(\"sizeByConfinedWh\"),!e.size.width&&e.size.height&&t.push(\"sizeByH\"),e.size.percentScale&&t.push(\"sizeByPct\"),(i.sizes||[]).find(n=>n.width===e.size.width&&!e.size.height||n.height===e.size.height&&!e.size.width||n.height===e.size.height&&n.width===e.size.width)?t.push(\"sizeByWhListed\"):(e.size.width&&!e.size.height&&t.push(\"sizeByW\"),e.size.width&&e.size.height&&t.push(\"sizeByWh\")),e.size.upscaled&&t.push(\"sizeUpscaling\");let[r,a]=d(i,{extraFeatures:t,extraQualities:[e.quality],extraFormats:[e.format],exactSize:e.size});return r?[!0]:[!1,a]}function B({x:i=0,y:e=0,w:t,h:o,full:r,square:a,percent:n}){if(r)return\"full\";if(a)return\"square\";if(typeof t>\"u\"||typeof o>\"u\")throw new Error(\"RegionParameter: invalid region\");let s=`${i},${e},${t},${o}`;return n?`pct:${s}`:s}function j({max:i,percentScale:e,upscaled:t,confined:o,width:r,height:a,serialiseAsFull:n,version:s}){let f=[];return t&&f.push(\"^\"),i?(f.push(n?\"full\":\"max\"),f.join(\"\")):(o&&f.push(\"!\"),e&&f.push(`pct:${e}`),r&&f.push(`${r}`),f.push(\",\"),a&&s===3&&f.push(`${a}`),f.join(\"\"))}function Q(i){return`${i.mirror?\"!\":\"\"}${(i.angle||0)%360}`}function H(i,e){let t=i.prefix.startsWith(\"/\")?i.prefix.substring(1):i.prefix,o=`${i.scheme}://${i.server}/${t?`${t}/`:\"\"}${i.identifier}`;if(i.type===\"base\")return o;if(i.type===\"info\")return`${o}/info.json`;let{size:r}=i,{region:a,rotation:n,format:s,quality:f}=i;if(e){let p=e[\"@context\"]?Array.isArray(e[\"@context\"])?e[\"@context\"]:[e[\"@context\"]]:[],l=p.indexOf(\"http://iiif.io/api/image/2/context.json\")!==-1,y=p.indexOf(\"http://iiif.io/api/image/3/context.json\")!==-1;if((r.width===e.width&&!r.height||r.height===e.height&&!r.width||r.width===e.width&&r.height===e.height)&&(r={...r,max:!0}),l&&(r.max&&!r.serialiseAsFull&&(r={...r,serialiseAsFull:!0}),!r.max&&r.width&&r.height&&(r={...r,height:void 0}),r={...r,version:2}),y){if(r.max&&r.serialiseAsFull&&(r={...r,serialiseAsFull:!1}),r.width&&!r.height&&e.width&&e.height){let x=e.height/e.width;r={...r,height:Math.ceil(r.width*x)}}r={...r,version:3}}}return[o,B(a),j(r),Q(n),`${f}.${s}`].filter(Boolean).join(\"/\")}function ui(i,e){return H({...i,type:\"info\"},e)}function L(i){return i.endsWith(\"info.json\")?i:i.endsWith(\"/\")?`${i}info.json`:`${i}/info.json`}function hi(i){let e=O(L(i.id));if(e.type!==\"info\")throw new Error(\"Invalid service URL\");let t=h(i);return{identifier:e.identifier,originalPath:\"\",server:e.server,prefix:e.prefix,scheme:e.scheme,type:\"image\",quality:t.extraQualities.indexOf(\"default\")===-1?t.extraQualities[0]:\"default\",region:{full:!0},size:{max:!0,upscaled:!1,confined:!1},format:\"jpg\",rotation:{angle:0}}}function Si(i,e,t){let o=t.length,r=[];for(let a=0;a<o;a++){let n=t[a];if(!n)continue;let s=n.width;r.push(i/s)}return r}function zi(i,e,t){let o=t.length,r=[];for(let a=0;a<o;a++){let n=t[a];n&&r.push({width:Math.floor(i/n),height:Math.floor(e/n)})}return r}function S(i,e){if(e&&e.profile){let t=e.profile;if(t){let o=Array.isArray(t)?t:[t];if(o.includes(`level${i}`)||o.includes(`http://iiif.io/api/image/2/level${i}.json`)||o.includes(`http://iiif.io/api/image/1/level${i}.json`)||o.includes(`http://iiif.io/api/image/1/profiles/level${i}.json`))return!0;if(i===2){for(let r of o)if(g.includes(r))return!0}if(i===1){for(let r of o)if(u.includes(r))return!0}if(i===0){for(let r of o)if(c.includes(r))return!0}}}return!1}function Pi(i){return m(i)?S(0,i)?0:S(1,i)?1:S(2,i)?2:null:null}function Oi(i){let e=i.service?Array.isArray(i.service)?i.service:[i.service]:[],t=e.length,o=[];for(let r=0;r<t;r++)m(e[r])&&o.push(e[r]);return o}function Wi(i){if(i[\"@type\"])return i[\"@type\"];if(i.type)return i.type}function ji(i){let e=i.replace(/(https?:\\/\\/)?(www.)?/i,\"\");return e.indexOf(\"/\")!==-1?e.split(\"/\")[0]:e}export{_ as IIIF_1_IMAGE_LEVEL_0,q as IIIF_1_IMAGE_LEVEL_0_PROFILE,ee as IIIF_1_IMAGE_LEVEL_1,ie as IIIF_1_IMAGE_LEVEL_1_PROFILE,te as IIIF_1_IMAGE_LEVEL_2,re as IIIF_1_IMAGE_LEVEL_2_PROFILE,oe as IIIF_2_IMAGE_LEVEL_0,xe as IIIF_2_IMAGE_LEVEL_0_NO_JSON,ae as IIIF_2_IMAGE_LEVEL_0_PROFILE,ne as IIIF_2_IMAGE_LEVEL_1,ge as IIIF_2_IMAGE_LEVEL_1_NO_JSON,fe as IIIF_2_IMAGE_LEVEL_1_PROFILE,se as IIIF_2_IMAGE_LEVEL_2,ce as IIIF_2_IMAGE_LEVEL_2_NO_JSON,me as IIIF_2_IMAGE_LEVEL_2_PROFILE,ue as IIIF_3_IMAGE_LEVEL_0,pe as IIIF_3_IMAGE_LEVEL_1,le as IIIF_3_IMAGE_LEVEL_2,G as STANFORD_IIIF_1_IMAGE_COMPLIANCE_0,J as STANFORD_IIIF_1_IMAGE_COMPLIANCE_1,K as STANFORD_IIIF_1_IMAGE_COMPLIANCE_2,V as STANFORD_IIIF_1_IMAGE_CONFORMANCE_0,X as STANFORD_IIIF_1_IMAGE_CONFORMANCE_1,Y as STANFORD_IIIF_1_IMAGE_CONFORMANCE_2,U as STANFORD_IIIF_IMAGE_COMPLIANCE_0,N as STANFORD_IIIF_IMAGE_COMPLIANCE_1,C as STANFORD_IIIF_IMAGE_COMPLIANCE_2,k as STANFORD_IIIF_IMAGE_CONFORMANCE_0,Z as STANFORD_IIIF_IMAGE_CONFORMANCE_1,D as STANFORD_IIIF_IMAGE_CONFORMANCE_2,L as canonicalServiceUrl,h as combineProfiles,hi as createImageServiceRequest,z as extraFeatures,Si as extractFixedSizeScales,zi as fixedSizesFromScales,W as getId,Pi as getImageServiceLevel,Oi as getImageServices,Wi as getType,ji as identifyImageServer,I as imageServiceProfiles,ui as imageServiceRequestInfo,H as imageServiceRequestToString,Ye as imageServiceSupportsFormat,ei as imageServiceSupportsRequest,m as isImageService,S as isImageServiceLevel,Qe as isLevel0,v as level0,he as level0Support,w as level1,u as level1Support,F as level2,g as level2Support,b as levelToProfile,c as onlyLevel0,de as parseImageServerFromId,O as parseImageServiceRequest,R as parseImageServiceUrl,A as parseRegionParameter,$ as parseRotationParameter,P as parseSizeParameter,B as regionParameterToString,Q as rotationParameterToString,j as sizeParameterToString,d as supports,Ke as supportsCustomSizes};\n","import {\n  mitt_default\n} from \"./chunk-6NZ5BWVI.js\";\nimport {\n  createStore\n} from \"./chunk-2I7FN7JX.js\";\nimport {\n  __publicField\n} from \"./chunk-G7A32JAG.js\";\n\n// src/image-service/image-service-loader.ts\nimport {\n  isLevel0,\n  getId as getId6,\n  canonicalServiceUrl as canonicalServiceUrl2,\n  extractFixedSizeScales,\n  fixedSizesFromScales,\n  getImageServices as getImageServices2\n} from \"@iiif/parser/image-3\";\n\n// src/image-service/get-image-server-from-id.ts\nfunction getImageServerFromId(url) {\n  const id = url.replace(/(https?:\\/\\/)?(www.)?/i, \"\");\n  if (id.indexOf(\"/\") !== -1) {\n    return id.split(\"/\")[0];\n  }\n  return id;\n}\n\n// src/image-service/sampled-tiles-to-tiles.ts\nfunction sampledTilesToTiles(width, height, sampledTiles) {\n  const maxDim = width > height ? width : height;\n  const len = sampledTiles.length;\n  const newTiles = [];\n  for (let i = 0; i < len; i++) {\n    const tile = sampledTiles[i];\n    if (!tile)\n      continue;\n    if (tile.scaleFactors.length === 0)\n      continue;\n    let lastSize = tile.scaleFactors[0];\n    if (!lastSize)\n      continue;\n    let curWidth = maxDim / lastSize;\n    const scaleFactors = [lastSize];\n    while (curWidth >= tile.width) {\n      lastSize = lastSize * 2;\n      scaleFactors.push(lastSize);\n      curWidth = curWidth / 2;\n    }\n    newTiles.push({\n      ...tile,\n      scaleFactors\n    });\n  }\n  return newTiles;\n}\n\n// src/image-service/get-image-from-tile-source.ts\nimport {\n  canonicalServiceUrl,\n  createImageServiceRequest,\n  getId,\n  imageServiceRequestToString\n} from \"@iiif/parser/image-3\";\nfunction getImageFromTileSource(image, targetWidth, targetHeight) {\n  const req = createImageServiceRequest({\n    \"@context\": image.version === 3 ? \"http://iiif.io/api/image/3/context.json\" : \"http://iiif.io/api/image/2/context.json\",\n    id: canonicalServiceUrl(getId(image)),\n    profile: image.level === null || typeof image.level === \"undefined\" ? \"level0\" : `level${image.level}`,\n    type: image.version === 3 ? \"ImageService3\" : \"ImageService2\"\n  });\n  if (req.type !== \"image\") {\n    throw new Error(\"Invalid service\");\n  }\n  req.size.max = false;\n  req.size.width = targetWidth;\n  req.size.height = targetHeight;\n  const url = imageServiceRequestToString(req);\n  return {\n    id: url,\n    type: \"fixed\",\n    width: targetWidth,\n    height: targetHeight || image.height / (image.width || 1) * targetWidth,\n    unsafe: image.width > targetWidth\n  };\n}\n\n// src/image-service/is-best-match.ts\nfunction isBestMatch(request, current, candidate) {\n  const width = !request.width ? request.maxWidth : request.width;\n  return candidate.height <= request.maxHeight && candidate.width <= request.maxWidth && candidate.height >= request.minHeight && candidate.width >= request.minWidth && (!current || Math.abs(candidate.width - width) < Math.abs(current.width - width));\n}\n\n// src/image-service/pick-best-from-candidates.ts\nfunction pickBestFromCandidates(inputRequest, candidates) {\n  const log = [];\n  const request = Object.assign(\n    {\n      unsafeImageService: false,\n      atAnyCost: true,\n      fallback: true,\n      minHeight: 64,\n      minWidth: 64,\n      maxHeight: Infinity,\n      maxWidth: Infinity,\n      returnAllOptions: false,\n      preferFixedSize: false,\n      allowUnsafe: false,\n      explain: false,\n      height: 0,\n      width: 0\n    },\n    inputRequest\n  );\n  const explain = (text, indent = 0) => request.explain ? log.push(\n    new Array(indent).fill(0).map((e) => \"    \").join(\"\") + text().trim()\n  ) : void 0;\n  const lastResorts = [];\n  const fallback = [];\n  let currentChoice = null;\n  explain(() => `Using configuration: ${JSON.stringify(request, null, 2)}`);\n  const swapChoice = (candidate, current) => {\n    explain(() => \"Swapping choice\", 3);\n    if (isBestMatch(request, current, candidate)) {\n      if (request.preferFixedSize && candidate.unsafe) {\n        explain(() => `We found an image that was marked as unsafe, but it was the best size. (${candidate.id})`, 4);\n        fallback.push(candidate);\n        return;\n      }\n      if (request.returnAllOptions && current) {\n        fallback.push(current);\n      }\n      explain(() => `We found a new image that was the best size. (${candidate.id})`, 4);\n      currentChoice = candidate;\n    } else if (request.returnAllOptions) {\n      fallback.push(candidate);\n    }\n  };\n  explain(() => `The input shows we have ${candidates.length} list(s) of candidates to choose from.`);\n  const candidateGroups = candidates.length;\n  for (let x = 0; x < candidateGroups; x++) {\n    const group = candidates[x]();\n    explain(() => `Candidate group ${x}: ${JSON.stringify(group, null, 2)}`, 1);\n    const candidatesLength = group.length;\n    explain(\n      () => `Checking candidate list number ${x} and found ${candidatesLength} potential ways of creating image(s)`,\n      1\n    );\n    for (let y = 0; y < candidatesLength; y++) {\n      const candidate = group[y];\n      explain(() => `-> Checking candidate ${y}`, 1);\n      if (candidate.type === \"unknown\" && request.atAnyCost) {\n        explain(() => `We've found an unknown image type, adding this to the \"last resort\" list`, 2);\n        lastResorts.push(candidate);\n      }\n      if (candidate.type === \"fixed\") {\n        if (candidate.unsafe) {\n          explain(() => `We've found an unsafe fixed image type, adding this to the \"last resort\" list`, 2);\n          lastResorts.push(candidate);\n        } else {\n          explain(() => `We've found a fixed size image, checking if it matches the request`, 2);\n          swapChoice(candidate, currentChoice);\n        }\n      }\n      if (candidate.type === \"fixed-service\") {\n        if (request.unsafeImageService) {\n          explain(\n            () => `Checking for an image from the tile source, without calculating the right height and width (unsafeImageService)`,\n            2\n          );\n          const choice = getImageFromTileSource(candidate, request.width, request.height);\n          swapChoice(choice, currentChoice);\n        } else {\n          explain(() => `Checking for an image from the tile source 3`, 2);\n          const choice = getImageFromTileSource(candidate, candidate.width, candidate.height);\n          swapChoice(choice, currentChoice);\n        }\n      }\n      if (candidate.type === \"variable\") {\n        if (candidate.maxWidth) {\n          const choice = getImageFromTileSource(\n            {\n              id: candidate.id,\n              type: \"fixed-service\",\n              width: candidate.maxWidth,\n              height: candidate.maxWidth,\n              level: candidate.level,\n              version: candidate.version\n            },\n            candidate.maxWidth\n          );\n          swapChoice(choice, currentChoice);\n        }\n      }\n    }\n    if (currentChoice && !request.returnAllOptions) {\n      if (currentChoice.unsafe || request.allowUnsafe) {\n        continue;\n      }\n      explain(() => `We found a match in choice list number ${x}, no searching any more`);\n      break;\n    }\n  }\n  if (request.atAnyCost && fallback.length === 0) {\n    explain(\n      () => currentChoice ? `We found an image! ${currentChoice.id} of type ${currentChoice.type}` : `We found no images, but \"atAnyCost\" is set, so returning that`\n    );\n    return {\n      best: currentChoice || lastResorts[0] || null,\n      fallback: lastResorts.slice(1),\n      log\n    };\n  }\n  if (request.returnAllOptions) {\n    explain(() => `Returning all options that we have found`);\n    return {\n      best: (request.atAnyCost ? currentChoice || fallback[0] || lastResorts[0] : currentChoice || fallback[0]) || null,\n      fallback: [...fallback, ...lastResorts],\n      log\n    };\n  }\n  explain(() => `Returning the best image that we found, and a fallback`);\n  return {\n    best: currentChoice || fallback[0] || null,\n    fallback: currentChoice ? fallback : fallback.slice(1),\n    log\n  };\n}\n\n// src/image-service/get-fixed-sizes-from-service.ts\nimport { getId as getId2, isImageService, getImageServiceLevel } from \"@iiif/parser/image-3\";\n\n// src/image-service/is-image-3.ts\nfunction isImage3(service) {\n  const context = service[\"@context\"] ? Array.isArray(service[\"@context\"]) ? service[\"@context\"] : [service[\"@context\"]] : [];\n  return context.indexOf(\"http://iiif.io/api/image/3/context.json\") !== -1;\n}\n\n// src/image-service/get-fixed-sizes-from-service.ts\nfunction getFixedSizesFromService(service) {\n  if (!isImageService(service)) {\n    return [];\n  }\n  return (service && service.sizes ? service.sizes : []).map((size) => {\n    return {\n      id: getId2(service),\n      type: \"fixed-service\",\n      height: size.height,\n      width: size.width,\n      level: getImageServiceLevel(service),\n      version: isImage3(service) ? 3 : 2\n    };\n  });\n}\n\n// src/image-service/get-custom-size-from-service.ts\nimport { getId as getId3, supportsCustomSizes, getImageServiceLevel as getImageServiceLevel2 } from \"@iiif/parser/image-3\";\nfunction getCustomSizeFromService(service) {\n  if (!supportsCustomSizes(service)) {\n    return [];\n  }\n  const imagesSizes = [];\n  const profiles = Array.isArray(service.profile) ? service.profile : [service.profile];\n  const pLen = profiles.length;\n  for (let x = 0; x < pLen; x++) {\n    const profile = profiles[x];\n    if (profile && typeof profile !== \"string\") {\n      if (profile.maxHeight || profile.maxWidth) {\n        return [\n          {\n            id: getId3(service),\n            type: \"variable\",\n            minWidth: 0,\n            minHeight: 0,\n            maxHeight: profile.maxHeight || profile.maxWidth,\n            maxWidth: profile.maxWidth || profile.maxHeight,\n            level: getImageServiceLevel2(service),\n            version: service[\"@context\"] === \"http://iiif.io/api/image/3/context.json\" ? 3 : 2\n          }\n        ];\n      }\n    }\n  }\n  if (service.tiles) {\n    const len = service.tiles.length;\n    for (let y = 0; y < len; y++) {\n      const tile = service.tiles[y];\n      if (tile && (tile.height || tile.width)) {\n        imagesSizes.push({\n          id: getId3(service),\n          type: \"variable\",\n          minHeight: 0,\n          minWidth: 0,\n          maxHeight: tile.height || tile.width,\n          maxWidth: tile.width,\n          level: getImageServiceLevel2(service),\n          version: isImage3(service) ? 3 : 2\n        });\n      }\n    }\n  }\n  return imagesSizes;\n}\n\n// src/image-service/get-image-candidates-from-service.ts\nfunction getImageCandidatesFromService(service) {\n  const candidates = [];\n  const totalServices = service.length;\n  for (let s = 0; s < totalServices; s++) {\n    const single = service[s];\n    if (!single)\n      continue;\n    const fixedSizes = getFixedSizesFromService(single);\n    if (fixedSizes.length) {\n      candidates.push(...fixedSizes);\n    }\n    const customSizes = getCustomSizeFromService(single);\n    if (customSizes.length) {\n      candidates.push(...customSizes);\n    }\n  }\n  return candidates;\n}\n\n// src/image-service/infer-size-from-url.ts\nfunction inferImageSizeFromUrl(image) {\n  const regex = /^.*\\/(full)\\/(((\\d+),(\\d+)?)|max)\\/(\\d+)\\/default\\.(jpg|png|jpeg)$/;\n  const match = image.match(regex);\n  if (match && match[4] && match[5]) {\n    const region = match[1];\n    const width = parseInt(match[4], 10);\n    const height = parseInt(match[5], 10);\n    const format = match[7];\n    if ((region === \"max\" || region === \"full\") && width && height && format) {\n      return {\n        type: \"fixed\",\n        id: image,\n        height,\n        width\n      };\n    }\n  }\n  return { type: \"unknown\", id: image };\n}\n\n// src/image-service/get-fixed-size-from-image.ts\nimport { getId as getId4, getType } from \"@iiif/parser/image-3\";\nfunction getFixedSizeFromImage(contentResource) {\n  if (typeof contentResource === \"string\") {\n    return inferImageSizeFromUrl(contentResource);\n  }\n  const type = getType(contentResource);\n  if (type !== \"Image\" && type !== \"sc:Image\") {\n    return null;\n  }\n  const image = contentResource;\n  const id = getId4(image);\n  if (!id) {\n    return null;\n  }\n  if (id && image.width && image.height) {\n    return {\n      id,\n      type: \"fixed\",\n      width: image.width,\n      height: image.height,\n      unsafe: true\n    };\n  }\n  return inferImageSizeFromUrl(id);\n}\n\n// src/image-service/get-image-candidates.ts\nimport { getId as getId5, getImageServices } from \"@iiif/parser/image-3\";\nfunction getImageCandidates(unknownResource, dereference = true, loader) {\n  const candidates = [];\n  const fixedSizeFromImage = getFixedSizeFromImage(unknownResource);\n  if (fixedSizeFromImage === null) {\n    return candidates;\n  }\n  const resource = unknownResource;\n  candidates.push(fixedSizeFromImage);\n  if (dereference && resource && resource.width && resource.height) {\n    const refCandidates = [];\n    const imageServices2 = getImageServices(resource);\n    for (const service of imageServices2) {\n      const request = {\n        id: getId5(service),\n        width: resource.width,\n        height: resource.height\n      };\n      if (loader.canLoadSync(request)) {\n        const externalService = loader.loadServiceSync(request);\n        if (externalService) {\n          if (!externalService.height) {\n            externalService.height = resource.height;\n          }\n          if (!externalService.width) {\n            externalService.width = resource.width;\n          }\n          refCandidates.push(...getImageCandidatesFromService([externalService]));\n        }\n      }\n    }\n    if (refCandidates.length) {\n      candidates.push(...refCandidates);\n      return candidates;\n    }\n  }\n  if (resource.service) {\n    candidates.push(...getImageCandidatesFromService(resource.service));\n  }\n  return candidates;\n}\n\n// src/image-service/image-sizes-match.ts\nfunction imageSizesMatch(sizesA, sizesB) {\n  if (sizesA.length !== sizesB.length) {\n    return false;\n  }\n  if (sizesA.length === 0 && sizesB.length === 0) {\n    return true;\n  }\n  const len = sizesA.length;\n  let matchOrder = true;\n  for (let i = 0; i < len; i++) {\n    const a = sizesA[i];\n    const b = sizesB[i];\n    if (a.width !== b.width || a.height !== b.height) {\n      matchOrder = false;\n      break;\n    }\n  }\n  if (matchOrder) {\n    return true;\n  }\n  let matching = 0;\n  for (let a = 0; a < len; a++) {\n    for (let b = 0; b < len; b++) {\n      if (sizesA[a].width === sizesB[b].width && sizesA[a].height === sizesB[b].height) {\n        matching++;\n        break;\n      }\n    }\n  }\n  return matching === len;\n}\n\n// src/image-service/image-service-loader.ts\nvar ImageServiceLoader = class {\n  constructor(options = {}) {\n    __publicField(this, \"config\", {\n      verificationsRequired: 1,\n      approximateServices: false,\n      enableFetching: true,\n      disableThrottling: false\n    });\n    __publicField(this, \"fetchingCount\", 0);\n    __publicField(this, \"imageServices\", {});\n    __publicField(this, \"knownImageServers\", {});\n    this.config = Object.assign(this.config, options);\n  }\n  /**\n   * Preload image service\n   *\n   * This will preload an image service, fetching details and recording the image server that served\n   * the request. Based on this it will make a template for predicting other image sources from this\n   * server. You can optionally pass in other ids to verify that the prediction is accurate.\n   *\n   */\n  // async preload(id: string, verify?: string[]): Promise<void> {}\n  setConfig(config) {\n    Object.assign(this.config, config);\n  }\n  /**\n   * Sample pre-fetched service\n   *\n   * If you have already fetched an image service, or are creating a viewer that only talks to a single\n   * image server and want to avoid calls, you can sample a service up-front. This will allow you to make\n   * completely synchronous calls to `loadServiceSync` and avoid any network calls for image services.\n   *\n   * @param service\n   * @param preLoaded Mark this as being pre-loaded (default: true)\n   */\n  sample(service, imageServiceRequest, preLoaded = true) {\n    const server = getImageServerFromId(getId6(service));\n    const serviceUrl = canonicalServiceUrl2(getId6(service));\n    const existing = this.knownImageServers[server];\n    this.imageServices[serviceUrl] = Object.assign(service, { real: true });\n    if (!existing && service.tiles && !isLevel0(service)) {\n      this.knownImageServers[server] = {\n        verifications: 0,\n        malformed: false,\n        root: server,\n        preLoaded,\n        sampledId: getId6(service),\n        verified: false,\n        server: null,\n        result: {\n          context: service[\"@context\"] || [],\n          sampledProfile: service.profile,\n          resourceServiceRatio: imageServiceRequest && service.height ? imageServiceRequest.height / service.height : 1,\n          sampledSizes: service.sizes || [],\n          sizeRatios: extractFixedSizeScales(service.width, service.height, service.sizes || []),\n          sampledTiles: service.tiles || []\n        }\n      };\n      return true;\n    }\n    return this.verify(service);\n  }\n  /**\n   * Preload an image server\n   *\n   * Similar to sample, but faster. This will bypass any checks and the logic contained in this implementation\n   * allowing you to correct mistakes this implementation might have made.\n   *\n   * @param server\n   * @param forceVerify\n   */\n  preLoad(server, forceVerify = true) {\n    this.knownImageServers[server.root] = server;\n    if (forceVerify) {\n      this.knownImageServers[server.root].malformed = false;\n      this.knownImageServers[server.root].verifications = this.config.verificationsRequired;\n    }\n  }\n  /**\n   * Predict\n   *\n   * Predicts what the image service will be for a content resource.\n   *\n   * @param resource\n   * @param verify\n   * @param force\n   */\n  predict(resource, verify = false, force = false) {\n    const source = resource?.source;\n    const serverId = getImageServerFromId(getId6(resource));\n    const imageServer = this.knownImageServers[serverId];\n    const serviceUrl = canonicalServiceUrl2(getId6(resource));\n    if (this.imageServices[serviceUrl]) {\n      return this.imageServices[serviceUrl] || null;\n    }\n    if (!this.config.approximateServices) {\n      return null;\n    }\n    if (!imageServer || !imageServer.result || !(source?.height || resource.height) || !(source?.width || resource.width) || !force && (imageServer.malformed || imageServer.verifications < this.config.verificationsRequired) || resource.source && isLevel0(resource.source)) {\n      return null;\n    }\n    if (!this.imageServices[serviceUrl]) {\n      this.imageServices[serviceUrl] = {\n        \"@context\": imageServer.result.context,\n        \"@id\": getId6(resource),\n        id: getId6(resource),\n        protocol: \"http://iiif.io/api/image\",\n        tiles: source?.tiles || sampledTilesToTiles(resource.width, resource.height, imageServer.result.sampledTiles),\n        sizes: source?.sizes || fixedSizesFromScales(\n          Math.round(resource.width / imageServer.result.resourceServiceRatio),\n          Math.round(resource.height / imageServer.result.resourceServiceRatio),\n          imageServer.result.sizeRatios\n        ),\n        profile: source?.profile || imageServer.result.sampledProfile,\n        height: source?.height || resource.height,\n        width: source?.width || resource.width,\n        real: false\n      };\n    }\n    return this.imageServices[serviceUrl] || null;\n  }\n  async getThumbnailFromResource(unknownResource, request, dereference = true, otherCandidates = []) {\n    const candidates = unknownResource ? await this.getImageCandidates(unknownResource, dereference) : [];\n    return pickBestFromCandidates(request, [() => otherCandidates, () => candidates]);\n  }\n  async getImageCandidates(unknownResource, dereference = true) {\n    const resource = unknownResource;\n    if (dereference && resource && resource.height && resource.width) {\n      const imageServices2 = getImageServices2(resource);\n      for (const service of imageServices2) {\n        const request = {\n          id: getId6(service),\n          width: service.width ? service.width : resource.width,\n          height: service.height ? service.height : resource.height,\n          source: service\n        };\n        await this.loadService(request);\n      }\n    }\n    return getImageCandidates(unknownResource, dereference, this);\n  }\n  /**\n   * Verify approximation\n   *\n   * Given an image service, it will dereference that image service and compare the result with what\n   * would have been generated if we used internal guessing.\n   *\n   * @param resource\n   * @return Promise<boolean>\n   */\n  async verify(resource) {\n    const prediction = this.predict(resource, false, true);\n    const imageService = await this.fetchService(getId6(resource));\n    if (!prediction) {\n      return false;\n    }\n    const isValid = prediction.height === imageService.height && prediction.width === imageService.width && prediction[\"@context\"] === imageService[\"@context\"] && imageSizesMatch(prediction.sizes || [], imageService.sizes || []);\n    if (isValid) {\n      const serverId = getImageServerFromId(getId6(resource));\n      const server = this.knownImageServers[serverId];\n      if (server) {\n        server.verifications += 1;\n        if (server.verifications >= this.config.verificationsRequired) {\n          server.verified = true;\n        }\n      }\n    }\n    return isValid;\n  }\n  canLoadSync(service) {\n    const serviceId = typeof service === \"string\" ? service : getId6(service);\n    const canonical = canonicalServiceUrl2(serviceId);\n    if (this.imageServices[canonical]) {\n      return true;\n    }\n    const server = this.knownImageServers[getImageServerFromId(serviceId)];\n    return !!(server && !server.malformed && server.verifications >= this.config.verificationsRequired);\n  }\n  /**\n   * Mark image service as malformed\n   *\n   * If you run into issues requesting images, you can mark an image service as malformed, and it will\n   * return you a new one. Future image services will also be requested fresh, and the system will have\n   * failed. Report a bug if this happens.\n   *\n   * @param resource\n   */\n  async markAsMalformed(resource) {\n    this.knownImageServers[getImageServerFromId(getId6(resource))].malformed = true;\n    return this.loadService(resource, true);\n  }\n  /**\n   * Fetch an image service (use loadService instead)\n   *\n   * @param serviceId\n   * @param forceFresh\n   */\n  async fetchService(serviceId, forceFresh = false) {\n    const serviceUrl = canonicalServiceUrl2(serviceId);\n    const service = this.imageServices[serviceUrl];\n    if (service && (!forceFresh || service.real)) {\n      return service;\n    }\n    if (!this.config.enableFetching) {\n      throw new Error(\"Fetching is not enabled\");\n    }\n    const json = await this.fetch(serviceUrl).then((service2) => service2.json());\n    if (!json.id && json[\"@id\"]) {\n      json.id = json[\"@id\"];\n    }\n    if (json.id !== serviceId) {\n      json.id = serviceId;\n      if (json[\"@id\"]) {\n        json[\"@id\"] = serviceId;\n      }\n    }\n    this.imageServices[serviceUrl] = Object.assign(json, { real: true });\n    return this.imageServices[serviceUrl];\n  }\n  async fetch(input, init) {\n    return fetch(input, init);\n  }\n  /**\n   * Load an image service\n   *\n   * @param resource\n   * @param forceFresh\n   *\n   * @todo make this batched, so only the maximum required can be done at once, to allow\n   *       for the prediction engine to kick in.\n   */\n  async loadService(resource, forceFresh = false) {\n    if (!this.config.disableThrottling) {\n      let running = true;\n      while (running) {\n        if (this.fetchingCount >= this.config.verificationsRequired) {\n          await new Promise((resolve) => setTimeout(resolve, 500));\n        } else {\n          running = false;\n          break;\n        }\n      }\n    }\n    const imageServer = this.knownImageServers[getImageServerFromId(getId6(resource))];\n    if (imageServer && !imageServer.malformed && !forceFresh) {\n      await imageServer.result;\n      const service = this.loadServiceSync(resource);\n      if (service) {\n        return service;\n      }\n    }\n    this.fetchingCount++;\n    const serviceJson = await this.fetchService(getId6(resource), forceFresh);\n    this.fetchingCount--;\n    if (serviceJson.real) {\n      this.sample(serviceJson, resource);\n    }\n    return serviceJson;\n  }\n  /**\n   * Load service synchronously\n   *\n   * If you know that the image service you are\n   * @param resource\n   */\n  loadServiceSync(resource) {\n    const serviceId = canonicalServiceUrl2(getId6(resource));\n    if (this.imageServices[serviceId]) {\n      return this.imageServices[serviceId];\n    }\n    if (!this.config.approximateServices) {\n      return null;\n    }\n    return this.predict(resource);\n  }\n};\n\n// src/image-service/image-service-store.ts\nimport { getId as getId7 } from \"@iiif/parser/image-3\";\nfunction createImageServiceStore(options = {}) {\n  const events = options.events || mitt_default();\n  const loader = options.loader || new ImageServiceLoader();\n  const store = createStore((set, get) => ({\n    loaded: {},\n    loadServiceSync: (service, detail, backgroundRequest) => {\n      const id = service.id || service[\"@id\"];\n      const existing = get().loaded[id];\n      if (existing && existing.status === \"done\") {\n        return existing.service;\n      }\n      if (existing && existing.status === \"loading\") {\n        return null;\n      }\n      if (existing && existing.status === \"error\") {\n        throw new Error(\"Failed to load image service\");\n      }\n      const request = {\n        id: getId7(service),\n        width: service.width || detail?.width || 0,\n        height: service.height || detail?.height || 0,\n        source: service\n      };\n      const loaded = loader.loadServiceSync(request);\n      if (loaded) {\n        set((state) => ({\n          loaded: {\n            ...state.loaded,\n            [id]: {\n              status: \"done\",\n              service: loaded,\n              real: true\n            }\n          }\n        }));\n        events.emit(\"image-service.loaded\", { id, service: loaded });\n      } else {\n        if (backgroundRequest) {\n          get().loadService(service, detail).then(() => {\n          });\n        }\n      }\n      return loaded;\n    },\n    loadService: async (service, detail) => {\n      const id = service.id || service[\"@id\"];\n      const existing = get().loaded[id];\n      if (existing && existing.status === \"done\") {\n        return existing.service;\n      }\n      if (existing && existing.status === \"loading\") {\n        return new Promise((resolve, reject) => {\n          const handler = (e) => {\n            if (e.id === id) {\n              events.off(\"image-service.loaded\", handler);\n              resolve(e.service || service);\n            }\n          };\n          events.on(\"image-service.loaded\", handler);\n        });\n      }\n      if (existing && existing.status === \"error\" && !detail?.force) {\n        throw new Error(\"Failed to load image service\");\n      }\n      events.emit(\"image-service.loading\", { id });\n      try {\n        const request = {\n          id: getId7(service),\n          width: service.width || 0,\n          height: service.height || 0,\n          source: service\n        };\n        const loaded = await loader.loadService(request, detail?.force);\n        set((state) => ({\n          loaded: {\n            ...state.loaded,\n            [id]: {\n              status: \"done\",\n              service: loaded,\n              real: loaded.real\n            }\n          }\n        }));\n        events.emit(\"image-service.loaded\", { id, service: loaded });\n        return loaded;\n      } catch (error) {\n        events.emit(\"image-service.error\", { id, error });\n        throw error;\n      }\n    }\n  }));\n  return {\n    store,\n    events\n  };\n}\nvar imageServices = createImageServiceStore();\n\n// src/image-service/get-smallest-scale-factor-as-single-image.ts\nimport { getId as getId8, getImageServiceLevel as getImageServiceLevel3 } from \"@iiif/parser/image-3\";\nfunction getSmallestScaleFactorAsSingleImage(service) {\n  if (!service.width || !service.height) {\n    return null;\n  }\n  if (service.tiles) {\n    const tiles = service.tiles.sort((a, b) => {\n      return Math.max(...b.scaleFactors) - Math.max(...a.scaleFactors);\n    });\n    const len = tiles.length;\n    for (let i = 0; i < len; i++) {\n      const tile = tiles[i];\n      if (!tile)\n        continue;\n      const targetSize = tile.width;\n      if (!targetSize) {\n        continue;\n      }\n      const sizeLen = tile.scaleFactors.length;\n      const sortedScales = tile.scaleFactors.sort();\n      for (let j = 0; j < sizeLen; j++) {\n        const size = sortedScales[j];\n        if (!size)\n          continue;\n        if (service.width / size <= targetSize && service.height / size <= targetSize) {\n          return {\n            id: getId8(service),\n            type: \"fixed-service\",\n            width: service.width / size | 0,\n            height: service.height / size | 0,\n            level: getImageServiceLevel3(service),\n            version: isImage3(service) ? 3 : 2\n          };\n        }\n      }\n    }\n  }\n  return null;\n}\n\nexport {\n  getImageServerFromId,\n  sampledTilesToTiles,\n  getImageFromTileSource,\n  isBestMatch,\n  pickBestFromCandidates,\n  isImage3,\n  getFixedSizesFromService,\n  getCustomSizeFromService,\n  getImageCandidatesFromService,\n  inferImageSizeFromUrl,\n  getFixedSizeFromImage,\n  getImageCandidates,\n  imageSizesMatch,\n  ImageServiceLoader,\n  createImageServiceStore,\n  imageServices,\n  getSmallestScaleFactorAsSingleImage\n};\n","import {\n  ImageServiceLoader,\n  getFixedSizeFromImage\n} from \"./chunk-4I45SZTR.js\";\nimport {\n  compatVault\n} from \"./chunk-LVD5NUFB.js\";\n\n// src/thumbnail.ts\nvar imageServiceLoader = new ImageServiceLoader();\nvar helpers = /* @__PURE__ */ new Map();\nfunction getThumbnail(input, {\n  vault = compatVault,\n  dereference = false,\n  ...options\n} = {}) {\n  let helper = helpers.get(vault);\n  if (!helper) {\n    helper = createThumbnailHelper(vault);\n    helpers.set(vault, helper);\n  }\n  return helper.getBestThumbnailAtSize(input, options, dereference);\n}\nfunction createThumbnailHelper(vault = compatVault, dependencies = {}) {\n  const loader = dependencies.imageServiceLoader || imageServiceLoader;\n  async function getBestThumbnailAtSize(input, request, dereference = false, candidates = [], dimensions) {\n    const thumbnailNotFound = () => loader.getThumbnailFromResource(void 0, request, dereference, candidates);\n    if (!input) {\n      return await loader.getThumbnailFromResource(void 0, request, dereference, candidates);\n    }\n    if (typeof input === \"string\") {\n      const fixed = getFixedSizeFromImage(input);\n      if (fixed) {\n        candidates.push(fixed);\n      }\n      return await loader.getThumbnailFromResource(void 0, request, dereference, candidates);\n    }\n    const fullInput = vault.get(input, { skipSelfReturn: false });\n    if (typeof fullInput === \"string\") {\n      return { best: getFixedSizeFromImage(fullInput), fallback: [], log: [] };\n    }\n    if (!fullInput) {\n      return await thumbnailNotFound();\n    }\n    const parseThumbnail = async (resource) => {\n      if (resource && resource.thumbnail && resource.thumbnail.length) {\n        const thumbnail = vault.get(resource.thumbnail[0]);\n        const potentialThumbnails = await loader.getImageCandidates(thumbnail, dereference);\n        if (potentialThumbnails && potentialThumbnails.length) {\n          candidates.push(...potentialThumbnails);\n        }\n      }\n    };\n    await parseThumbnail(fullInput);\n    switch (fullInput.type) {\n      case \"Annotation\": {\n        const contentResources = Array.isArray(fullInput.body) ? fullInput.body : [fullInput.body];\n        const firstContentResources = vault.get(contentResources[0]);\n        if (dimensions && !firstContentResources.width) {\n          firstContentResources.width = dimensions.width;\n          firstContentResources.height = dimensions.height;\n        }\n        return await loader.getThumbnailFromResource(firstContentResources, request, dereference, candidates);\n      }\n      case \"Canvas\": {\n        const canvas = fullInput;\n        return getBestThumbnailAtSize(canvas.items[0], request, dereference, candidates, {\n          width: canvas.width,\n          height: canvas.height\n        });\n      }\n      case \"AnnotationPage\": {\n        const annotationPage = fullInput;\n        return getBestThumbnailAtSize(annotationPage.items[0], request, dereference, candidates, dimensions);\n      }\n      case \"Choice\": {\n        const choice = fullInput;\n        if (!choice.items || choice.items[0]) {\n          return await thumbnailNotFound();\n        }\n        return getBestThumbnailAtSize(choice.items[0], request, dereference, candidates, dimensions);\n      }\n      case \"Collection\": {\n        const collection = fullInput;\n        const firstManifest = collection.items[0];\n        if (!firstManifest) {\n          return await thumbnailNotFound();\n        }\n        return getBestThumbnailAtSize(firstManifest, request, dereference, candidates, dimensions);\n      }\n      case \"Manifest\": {\n        const manifest = fullInput;\n        const firstCanvas = manifest.items[0];\n        if (!firstCanvas) {\n          return await thumbnailNotFound();\n        }\n        return getBestThumbnailAtSize(firstCanvas, request, dereference, candidates, dimensions);\n      }\n      case \"SpecificResource\":\n      case \"Image\":\n      case \"Dataset\":\n      case \"Sound\":\n      case \"Text\":\n      case \"TextualBody\":\n      case \"Video\":\n        if (dimensions && !fullInput.width) {\n          fullInput.width = dimensions.width;\n          fullInput.height = dimensions.height;\n        }\n        return loader.getThumbnailFromResource(fullInput, request, dereference, candidates);\n    }\n    return await thumbnailNotFound();\n  }\n  return {\n    getBestThumbnailAtSize\n  };\n}\n\nexport {\n  imageServiceLoader,\n  getThumbnail,\n  createThumbnailHelper\n};\n","import {\n  __commonJS,\n  __publicField,\n  __toESM\n} from \"./chunk-G7A32JAG.js\";\n\n// node_modules/.pnpm/parse-svg-path@0.1.2/node_modules/parse-svg-path/index.js\nvar require_parse_svg_path = __commonJS({\n  \"node_modules/.pnpm/parse-svg-path@0.1.2/node_modules/parse-svg-path/index.js\"(exports, module) {\n    \"use strict\";\n    module.exports = parse;\n    var length = { a: 7, c: 6, h: 1, l: 2, m: 2, q: 4, s: 4, t: 2, v: 1, z: 0 };\n    var segment = /([astvzqmhlc])([^astvzqmhlc]*)/ig;\n    function parse(path) {\n      var data = [];\n      path.replace(segment, function(_, command, args) {\n        var type = command.toLowerCase();\n        args = parseValues(args);\n        if (type == \"m\" && args.length > 2) {\n          data.push([command].concat(args.splice(0, 2)));\n          type = \"l\";\n          command = command == \"m\" ? \"l\" : \"L\";\n        }\n        while (true) {\n          if (args.length == length[type]) {\n            args.unshift(command);\n            return data.push(args);\n          }\n          if (args.length < length[type])\n            throw new Error(\"malformed path data\");\n          data.push([command].concat(args.splice(0, length[type])));\n        }\n      });\n      return data;\n    }\n    var number = /-?[0-9]*\\.?[0-9]+(?:e[-+]?\\d+)?/ig;\n    function parseValues(args) {\n      var numbers = args.match(number);\n      return numbers ? numbers.map(Number) : [];\n    }\n  }\n});\n\n// node_modules/.pnpm/abs-svg-path@0.1.1/node_modules/abs-svg-path/index.js\nvar require_abs_svg_path = __commonJS({\n  \"node_modules/.pnpm/abs-svg-path@0.1.1/node_modules/abs-svg-path/index.js\"(exports, module) {\n    \"use strict\";\n    module.exports = absolutize;\n    function absolutize(path) {\n      var startX = 0;\n      var startY = 0;\n      var x = 0;\n      var y = 0;\n      return path.map(function(seg) {\n        seg = seg.slice();\n        var type = seg[0];\n        var command = type.toUpperCase();\n        if (type != command) {\n          seg[0] = command;\n          switch (type) {\n            case \"a\":\n              seg[6] += x;\n              seg[7] += y;\n              break;\n            case \"v\":\n              seg[1] += y;\n              break;\n            case \"h\":\n              seg[1] += x;\n              break;\n            default:\n              for (var i = 1; i < seg.length; ) {\n                seg[i++] += x;\n                seg[i++] += y;\n              }\n          }\n        }\n        switch (command) {\n          case \"Z\":\n            x = startX;\n            y = startY;\n            break;\n          case \"H\":\n            x = seg[1];\n            break;\n          case \"V\":\n            y = seg[1];\n            break;\n          case \"M\":\n            x = startX = seg[1];\n            y = startY = seg[2];\n            break;\n          default:\n            x = seg[seg.length - 2];\n            y = seg[seg.length - 1];\n        }\n        return seg;\n      });\n    }\n  }\n});\n\n// node_modules/.pnpm/svg-arc-to-cubic-bezier@3.2.0/node_modules/svg-arc-to-cubic-bezier/modules/index.js\nvar _slicedToArray = /* @__PURE__ */ function() {\n  function sliceIterator(arr, i) {\n    var _arr = [];\n    var _n = true;\n    var _d = false;\n    var _e = void 0;\n    try {\n      for (var _i = arr[Symbol.iterator](), _s; !(_n = (_s = _i.next()).done); _n = true) {\n        _arr.push(_s.value);\n        if (i && _arr.length === i)\n          break;\n      }\n    } catch (err) {\n      _d = true;\n      _e = err;\n    } finally {\n      try {\n        if (!_n && _i[\"return\"])\n          _i[\"return\"]();\n      } finally {\n        if (_d)\n          throw _e;\n      }\n    }\n    return _arr;\n  }\n  return function(arr, i) {\n    if (Array.isArray(arr)) {\n      return arr;\n    } else if (Symbol.iterator in Object(arr)) {\n      return sliceIterator(arr, i);\n    } else {\n      throw new TypeError(\"Invalid attempt to destructure non-iterable instance\");\n    }\n  };\n}();\nvar TAU = Math.PI * 2;\nvar mapToEllipse = function mapToEllipse2(_ref, rx, ry, cosphi, sinphi, centerx, centery) {\n  var x = _ref.x, y = _ref.y;\n  x *= rx;\n  y *= ry;\n  var xp = cosphi * x - sinphi * y;\n  var yp = sinphi * x + cosphi * y;\n  return {\n    x: xp + centerx,\n    y: yp + centery\n  };\n};\nvar approxUnitArc = function approxUnitArc2(ang1, ang2) {\n  var a = ang2 === 1.5707963267948966 ? 0.551915024494 : ang2 === -1.5707963267948966 ? -0.551915024494 : 4 / 3 * Math.tan(ang2 / 4);\n  var x1 = Math.cos(ang1);\n  var y1 = Math.sin(ang1);\n  var x2 = Math.cos(ang1 + ang2);\n  var y2 = Math.sin(ang1 + ang2);\n  return [{\n    x: x1 - y1 * a,\n    y: y1 + x1 * a\n  }, {\n    x: x2 + y2 * a,\n    y: y2 - x2 * a\n  }, {\n    x: x2,\n    y: y2\n  }];\n};\nvar vectorAngle = function vectorAngle2(ux, uy, vx, vy) {\n  var sign = ux * vy - uy * vx < 0 ? -1 : 1;\n  var dot = ux * vx + uy * vy;\n  if (dot > 1) {\n    dot = 1;\n  }\n  if (dot < -1) {\n    dot = -1;\n  }\n  return sign * Math.acos(dot);\n};\nvar getArcCenter = function getArcCenter2(px, py, cx, cy, rx, ry, largeArcFlag, sweepFlag, sinphi, cosphi, pxp, pyp) {\n  var rxsq = Math.pow(rx, 2);\n  var rysq = Math.pow(ry, 2);\n  var pxpsq = Math.pow(pxp, 2);\n  var pypsq = Math.pow(pyp, 2);\n  var radicant = rxsq * rysq - rxsq * pypsq - rysq * pxpsq;\n  if (radicant < 0) {\n    radicant = 0;\n  }\n  radicant /= rxsq * pypsq + rysq * pxpsq;\n  radicant = Math.sqrt(radicant) * (largeArcFlag === sweepFlag ? -1 : 1);\n  var centerxp = radicant * rx / ry * pyp;\n  var centeryp = radicant * -ry / rx * pxp;\n  var centerx = cosphi * centerxp - sinphi * centeryp + (px + cx) / 2;\n  var centery = sinphi * centerxp + cosphi * centeryp + (py + cy) / 2;\n  var vx1 = (pxp - centerxp) / rx;\n  var vy1 = (pyp - centeryp) / ry;\n  var vx2 = (-pxp - centerxp) / rx;\n  var vy2 = (-pyp - centeryp) / ry;\n  var ang1 = vectorAngle(1, 0, vx1, vy1);\n  var ang2 = vectorAngle(vx1, vy1, vx2, vy2);\n  if (sweepFlag === 0 && ang2 > 0) {\n    ang2 -= TAU;\n  }\n  if (sweepFlag === 1 && ang2 < 0) {\n    ang2 += TAU;\n  }\n  return [centerx, centery, ang1, ang2];\n};\nvar arcToBezier = function arcToBezier2(_ref2) {\n  var px = _ref2.px, py = _ref2.py, cx = _ref2.cx, cy = _ref2.cy, rx = _ref2.rx, ry = _ref2.ry, _ref2$xAxisRotation = _ref2.xAxisRotation, xAxisRotation = _ref2$xAxisRotation === void 0 ? 0 : _ref2$xAxisRotation, _ref2$largeArcFlag = _ref2.largeArcFlag, largeArcFlag = _ref2$largeArcFlag === void 0 ? 0 : _ref2$largeArcFlag, _ref2$sweepFlag = _ref2.sweepFlag, sweepFlag = _ref2$sweepFlag === void 0 ? 0 : _ref2$sweepFlag;\n  var curves = [];\n  if (rx === 0 || ry === 0) {\n    return [];\n  }\n  var sinphi = Math.sin(xAxisRotation * TAU / 360);\n  var cosphi = Math.cos(xAxisRotation * TAU / 360);\n  var pxp = cosphi * (px - cx) / 2 + sinphi * (py - cy) / 2;\n  var pyp = -sinphi * (px - cx) / 2 + cosphi * (py - cy) / 2;\n  if (pxp === 0 && pyp === 0) {\n    return [];\n  }\n  rx = Math.abs(rx);\n  ry = Math.abs(ry);\n  var lambda = Math.pow(pxp, 2) / Math.pow(rx, 2) + Math.pow(pyp, 2) / Math.pow(ry, 2);\n  if (lambda > 1) {\n    rx *= Math.sqrt(lambda);\n    ry *= Math.sqrt(lambda);\n  }\n  var _getArcCenter = getArcCenter(px, py, cx, cy, rx, ry, largeArcFlag, sweepFlag, sinphi, cosphi, pxp, pyp), _getArcCenter2 = _slicedToArray(_getArcCenter, 4), centerx = _getArcCenter2[0], centery = _getArcCenter2[1], ang1 = _getArcCenter2[2], ang2 = _getArcCenter2[3];\n  var ratio = Math.abs(ang2) / (TAU / 4);\n  if (Math.abs(1 - ratio) < 1e-7) {\n    ratio = 1;\n  }\n  var segments = Math.max(Math.ceil(ratio), 1);\n  ang2 /= segments;\n  for (var i = 0; i < segments; i++) {\n    curves.push(approxUnitArc(ang1, ang2));\n    ang1 += ang2;\n  }\n  return curves.map(function(curve) {\n    var _mapToEllipse = mapToEllipse(curve[0], rx, ry, cosphi, sinphi, centerx, centery), x1 = _mapToEllipse.x, y1 = _mapToEllipse.y;\n    var _mapToEllipse2 = mapToEllipse(curve[1], rx, ry, cosphi, sinphi, centerx, centery), x2 = _mapToEllipse2.x, y2 = _mapToEllipse2.y;\n    var _mapToEllipse3 = mapToEllipse(curve[2], rx, ry, cosphi, sinphi, centerx, centery), x = _mapToEllipse3.x, y = _mapToEllipse3.y;\n    return { x1, y1, x2, y2, x, y };\n  });\n};\nvar modules_default = arcToBezier;\n\n// src/annotation-targets/normalize-svg.ts\nvar import_parse_svg_path = __toESM(require_parse_svg_path(), 1);\nvar import_abs_svg_path = __toESM(require_abs_svg_path(), 1);\nfunction parseAndNormalizeSvgPath(path) {\n  const parsed = (0, import_parse_svg_path.default)(path);\n  const absolute = (0, import_abs_svg_path.default)(parsed);\n  let prevCmd;\n  let startX = 0;\n  let startY = 0;\n  let bezierX = 0;\n  let bezierY = 0;\n  let quadX;\n  let quadY;\n  let x = 0;\n  let y = 0;\n  const out = [];\n  for (let i = 0; i < absolute.length; i++) {\n    let seg = absolute[i];\n    const cmd = seg[0];\n    switch (cmd) {\n      case \"M\":\n        startX = seg[1];\n        startY = seg[2];\n        break;\n      case \"H\":\n        seg = [\"L\", seg[1], startY];\n        break;\n      case \"V\":\n        seg = [\"L\", startX, seg[1]];\n        break;\n      case \"S\":\n        {\n          let cx = x;\n          let cy = y;\n          if (prevCmd === \"C\" || prevCmd == \"S\") {\n            cx += cx - bezierX;\n            cy += cy - bezierY;\n          }\n          seg = [\"C\", cx, cy, seg[1], seg[2], seg[3], seg[4]];\n        }\n        break;\n      case \"T\":\n        if (prevCmd === \"Q\" || prevCmd == \"T\") {\n          quadX = x * 2 - quadX;\n          quadY = y * 2 - quadY;\n        } else {\n          quadX = x;\n          quadY = y;\n        }\n        seg = [\"Q\", quadX, quadY, seg[1], seg[2]];\n        break;\n      case \"Q\":\n        quadX = seg[1];\n        quadY = seg[2];\n        break;\n      case \"A\":\n        {\n          const curves = modules_default({\n            px: x,\n            py: y,\n            cx: seg[6],\n            cy: seg[7],\n            rx: seg[1],\n            ry: seg[2],\n            xAxisRotation: seg[3],\n            largeArcFlag: seg[4],\n            sweepFlag: seg[5]\n          });\n          if (!curves.length) {\n            continue;\n          }\n          for (const [j, curve] of curves.entries()) {\n            seg = [\"C\", curve.x1, curve.y1, curve.x2, curve.y2, curve.x, curve.y];\n            if (j < curves.length - 1) {\n              out.push(seg);\n            }\n          }\n          seg = seg;\n        }\n        break;\n      case \"Z\":\n        seg = [\"L\", startX, startY];\n        break;\n    }\n    prevCmd = cmd;\n    x = seg[seg.length - 2];\n    y = seg[seg.length - 1];\n    if ([\"C\", \"Q\", \"A\"].indexOf(cmd) > -1) {\n      bezierX = seg[seg.length - 4];\n      bezierY = seg[seg.length - 3];\n    } else {\n      bezierX = x;\n      bezierY = y;\n    }\n    out.push(seg);\n  }\n  return out;\n}\n\n// src/annotation-targets/bezier.ts\nfunction flattenQuadraticBezier(start, control, end, tolerance = 1) {\n  return new QuadraticBezier(start, control, end).subdivide(tolerance);\n}\nfunction flattenCubicBezier(start, startControl, end, endControl, tolerance = 1) {\n  return new CubicBezier(\n    new Float64Array([start.x, start.y, startControl.x, startControl.y, end.x, end.y, endControl.x, endControl.y])\n  ).subdivide(tolerance);\n}\nfunction hypot2(p) {\n  return p.x * p.x + p.y * p.y;\n}\nfunction approx_myint(x) {\n  const d = 0.67;\n  return x / (1 - d + Math.pow(Math.pow(d, 4) + 0.25 * x * x, 0.25));\n}\nfunction approx_inv_myint(x) {\n  const b = 0.39;\n  return x * (1 - b + Math.sqrt(b * b + 0.25 * x * x));\n}\nvar QuadraticBezier = class {\n  constructor(start, control, end) {\n    __publicField(this, \"start\");\n    __publicField(this, \"control\");\n    __publicField(this, \"end\");\n    this.start = start;\n    this.control = control;\n    this.end = end;\n  }\n  eval(t) {\n    const mt = 1 - t;\n    return {\n      x: this.start.x * mt * mt + 2 * this.control.x * mt * t + this.end.x * t * t,\n      y: this.start.y * mt * mt + 2 * this.control.y * mt * t + this.end.y * t * t\n    };\n  }\n  mapToBasic() {\n    const { x: x0, y: y0 } = this.start;\n    const { x: x1, y: y1 } = this.control;\n    const { x: x2, y: y2 } = this.end;\n    const ddx = 2 * x1 - x0 - x2;\n    const ddy = 2 * y1 - y0 - y2;\n    const u0 = (x1 - x0) * ddx + (y1 - y0) * ddy;\n    const u2 = (x2 - x1) * ddx + (y2 - y1) * ddy;\n    const cross = (x2 - x0) * ddy - (y2 - y0) * ddx;\n    const paramX0 = u0 / cross;\n    const paramX2 = u2 / cross;\n    const scale = Math.abs(cross) / (Math.hypot(ddx, ddy) * Math.abs(paramX2 - paramX0));\n    return { x0, x2, scale, cross };\n  }\n  subdivide(tolerance) {\n    const params = this.mapToBasic();\n    const a0 = approx_myint(params.x0);\n    const a2 = approx_myint(params.x2);\n    const count = 0.5 * Math.abs(a2 - a0) * Math.sqrt(params.scale / tolerance);\n    const n = Math.ceil(count);\n    const u0 = approx_inv_myint(a0);\n    const u2 = approx_inv_myint(a2);\n    const tValues = [0];\n    for (let i = 1; i < n; i++) {\n      const u = approx_inv_myint(a0 + (a2 - a0) * i / n);\n      const t = (u - u0) / (u2 - u0);\n      tValues.push(t);\n    }\n    tValues.push(1);\n    return tValues.map((t) => this.eval(t));\n  }\n};\nvar CubicBezier = class _CubicBezier {\n  /// Argument is array of coordinate values [x0, y0, x1, y1, x2, y2, x3, y3].\n  constructor(coords) {\n    __publicField(this, \"c\");\n    this.c = coords;\n  }\n  weightsum(c0, c1, c2, c3) {\n    const x = c0 * this.c[0] + c1 * this.c[2] + c2 * this.c[4] + c3 * this.c[6];\n    const y = c0 * this.c[1] + c1 * this.c[3] + c2 * this.c[5] + c3 * this.c[7];\n    return { x, y };\n  }\n  eval(t) {\n    const mt = 1 - t;\n    const c0 = mt * mt * mt;\n    const c1 = 3 * mt * mt * t;\n    const c2 = 3 * mt * t * t;\n    const c3 = t * t * t;\n    return this.weightsum(c0, c1, c2, c3);\n  }\n  deriv(t) {\n    const mt = 1 - t;\n    const c0 = -3 * mt * mt;\n    const c3 = 3 * t * t;\n    const c1 = -6 * t * mt - c0;\n    const c2 = 6 * t * mt - c3;\n    return this.weightsum(c0, c1, c2, c3);\n  }\n  // quadratic bezier with matching endpoints and minimum max vector error\n  midpoint_quadbez() {\n    const p1 = this.weightsum(-0.25, 0.75, 0.75, -0.25);\n    return new QuadraticBezier({ x: this.c[0], y: this.c[1] }, p1, { x: this.c[6], y: this.c[7] });\n  }\n  subsegment(t0, t1) {\n    const c = new Float64Array(8);\n    const p0 = this.eval(t0);\n    const p3 = this.eval(t1);\n    c[0] = p0.x;\n    c[1] = p0.y;\n    const scale = (t1 - t0) / 3;\n    const d1 = this.deriv(t0);\n    c[2] = p0.x + scale * d1.x;\n    c[3] = p0.y + scale * d1.y;\n    const d2 = this.deriv(t1);\n    c[4] = p3.x - scale * d2.x;\n    c[5] = p3.y - scale * d2.y;\n    c[6] = p3.x;\n    c[7] = p3.y;\n    return new _CubicBezier(c);\n  }\n  // Very fancy subdivision scheme\n  subdivide(tol) {\n    const tol1 = 0.1 * tol;\n    const tol2 = tol - tol1;\n    const sqrt_tol2 = Math.sqrt(tol2);\n    const err2 = hypot2(this.weightsum(1, -3, 3, -1));\n    const n_quads = Math.ceil(Math.pow(err2 / (432 * tol1 * tol1), 1 / 6));\n    const quads = [];\n    let sum = 0;\n    for (let i2 = 0; i2 < n_quads; i2++) {\n      const t0 = i2 / n_quads;\n      const t1 = (i2 + 1) / n_quads;\n      const quad = this.subsegment(t0, t1).midpoint_quadbez();\n      const params = quad.mapToBasic();\n      const a0 = approx_myint(params.x0);\n      const a2 = approx_myint(params.x2);\n      const scale = Math.sqrt(params.scale);\n      let val2 = Math.abs(a2 - a0) * scale;\n      if (Math.sign(params.x0) != Math.sign(params.x2)) {\n        const xmin = sqrt_tol2 / scale;\n        const cusp_val = sqrt_tol2 * Math.abs(a2 - a0) / approx_myint(xmin);\n        val2 = Math.max(val2, cusp_val);\n      }\n      quads.push({\n        quad,\n        a0,\n        a2,\n        val: val2\n      });\n      sum += val2;\n    }\n    const count = 0.5 * sum / sqrt_tol2;\n    const n = Math.ceil(count);\n    const result = [{ x: this.c[0], y: this.c[1] }];\n    let val = 0;\n    let i = 0;\n    for (let j = 1; j < n; j++) {\n      const target = sum * j / n;\n      while (val + quads[i].val < target) {\n        val += quads[i].val;\n        i++;\n      }\n      const a0 = quads[i].a0;\n      const a2 = quads[i].a2;\n      const u0 = approx_inv_myint(a0);\n      const u2 = approx_inv_myint(a2);\n      const a = a0 + (a2 - a0) * (target - val) / quads[i].val;\n      const u = approx_inv_myint(a);\n      const t = (u - u0) / (u2 - u0);\n      result.push(quads[i].quad.eval(t));\n    }\n    result.push({ x: this.c[6], y: this.c[7] });\n    return result;\n  }\n};\n\n// src/annotation-targets/parse-selector.ts\nvar BOX_SELECTOR = /&?(xywh=)?(pixel:|percent:|pct:)?([0-9]+(?:\\.[0-9]+)?),([0-9]+(?:\\.[0-9]+)?),([0-9]+(?:\\.[0-9]+)?),([0-9]+(?:\\.[0-9]+)?)/;\nvar TEMPORAL_SELECTOR = /&?(t=)(npt:)?([0-9]+(\\.[0-9]+)?)?(,([0-9]+(\\.[0-9]+)?))?/;\nvar RGBA_COLOR = /^rgba\\((\\d+),(\\d+),(\\d+),([0-9.]+)\\)$/;\nfunction parseSelector(source, {\n  domParser,\n  svgPreprocessor,\n  iiifRenderingHints\n} = {}) {\n  if (Array.isArray(source)) {\n    return resolveHints(\n      source.reduce(\n        (data, nextSource) => {\n          const {\n            selector,\n            selectors,\n            iiifRenderingHints: newIiifRenderingHints\n          } = parseSelector(nextSource, { domParser, svgPreprocessor, iiifRenderingHints });\n          if (selector) {\n            if (!data.selector) {\n              data.selector = selector;\n            }\n            data.selectors.push(...selectors);\n          }\n          if (newIiifRenderingHints) {\n            data.iiifRenderingHints = data.iiifRenderingHints || { type: \"ImageApiSelector\" };\n            Object.assign(data.iiifRenderingHints, newIiifRenderingHints);\n          }\n          return data;\n        },\n        {\n          selector: null,\n          selectors: [],\n          iiifRenderingHints\n        }\n      )\n    );\n  }\n  if (!source) {\n    return resolveHints({\n      selector: null,\n      selectors: [],\n      iiifRenderingHints\n    });\n  }\n  if (typeof source === \"string\") {\n    const [id, fragment] = source.split(\"#\");\n    if (!fragment) {\n      return resolveHints({\n        selector: null,\n        selectors: [],\n        iiifRenderingHints\n      });\n    }\n    return parseSelector(\n      { type: \"FragmentSelector\", value: fragment },\n      { svgPreprocessor, iiifRenderingHints, domParser }\n    );\n  }\n  if (source.type) {\n    if (source.type === \"PointSelector\" && (source.t || source.t === 0)) {\n      const selector = {\n        type: \"TemporalSelector\",\n        temporal: {\n          startTime: source.t\n        }\n      };\n      return resolveHints({\n        selector,\n        selectors: [selector],\n        iiifRenderingHints\n      });\n    }\n    if (source.type === \"PointSelector\" && source.x && source.y) {\n      const selector = {\n        type: \"PointSelector\",\n        spatial: {\n          x: source.x,\n          y: source.y\n        }\n      };\n      return resolveHints({\n        selector,\n        selectors: [selector],\n        iiifRenderingHints\n      });\n    }\n  }\n  if (isImageApiSelector(source)) {\n    const selectors = [];\n    if (source.region) {\n      const parsedRegion = parseSelector(\n        { type: \"FragmentSelector\", value: \"xywh=\" + source.region },\n        { domParser, svgPreprocessor, iiifRenderingHints }\n      );\n      selectors.push(...parsedRegion.selectors);\n    }\n    return resolveHints({\n      selector: selectors[0],\n      selectors,\n      iiifRenderingHints: iiifRenderingHints ? { ...iiifRenderingHints, ...source } : source\n    });\n  }\n  if (source.type === \"FragmentSelector\") {\n    const matchBoxSelector = BOX_SELECTOR.exec(source.value);\n    if (matchBoxSelector) {\n      let selector = {\n        type: \"BoxSelector\",\n        spatial: {\n          unit: matchBoxSelector[2] === \"percent:\" || matchBoxSelector[2] === \"pct:\" ? \"percent\" : \"pixel\",\n          x: parseFloat(matchBoxSelector[3]),\n          y: parseFloat(matchBoxSelector[4]),\n          width: parseFloat(matchBoxSelector[5]),\n          height: parseFloat(matchBoxSelector[6])\n        }\n      };\n      const matchBoxTimeSelector = source.value.match(TEMPORAL_SELECTOR);\n      if (matchBoxTimeSelector) {\n        selector = {\n          type: \"TemporalBoxSelector\",\n          spatial: selector.spatial,\n          temporal: {\n            startTime: matchBoxTimeSelector[3] ? parseFloat(matchBoxTimeSelector[3]) : 0,\n            endTime: matchBoxTimeSelector[6] ? parseFloat(matchBoxTimeSelector[6]) : void 0\n          }\n        };\n      }\n      return resolveHints({\n        selector,\n        selectors: [selector],\n        iiifRenderingHints\n      });\n    }\n    const matchTimeSelector = source.value.match(TEMPORAL_SELECTOR);\n    if (matchTimeSelector) {\n      const selector = {\n        type: \"TemporalSelector\",\n        temporal: {\n          startTime: matchTimeSelector[3] ? parseFloat(matchTimeSelector[3]) : 0,\n          endTime: matchTimeSelector[6] ? parseFloat(matchTimeSelector[6]) : void 0\n        }\n      };\n      return resolveHints({\n        selector,\n        selectors: [selector],\n        iiifRenderingHints\n      });\n    }\n    return resolveHints({\n      selector: null,\n      selectors: [],\n      iiifRenderingHints\n    });\n  }\n  if (source.type === \"SvgSelector\" && \"value\" in source) {\n    if (!domParser) {\n      if (typeof window !== \"undefined\") {\n        domParser = new window.DOMParser();\n      } else {\n        console.warn(\n          \"No DOMParser available, cannot parse SVG selector, `points`, `spatial` and `style` will be unavailable and the SVG will not be normalized.\"\n        );\n      }\n    }\n    let points = [];\n    let rect;\n    let style;\n    let svg = svgPreprocessor?.(source.value) ?? source.value;\n    let svgShape;\n    if (domParser) {\n      const svgElement = domParser.parseFromString(source.value, \"image/svg+xml\").querySelector(\"svg\");\n      if (!svgElement) {\n        console.warn(`Illegal SVG selector: ${source.value}`);\n        return resolveHints({\n          selector: null,\n          selectors: [],\n          iiifRenderingHints\n        });\n      }\n      const selectorElem = getSelectorElement(svgElement);\n      if (selectorElem) {\n        points = selectorElem.points;\n        svgShape = selectorElem.shapeType;\n        rect = [\n          Math.min(...points.map((p) => p[0])),\n          // llx\n          Math.min(...points.map((p) => p[1])),\n          // lly\n          Math.max(...points.map((p) => p[0])),\n          // urx\n          Math.max(...points.map((p) => p[1]))\n          // ury\n        ];\n        ({ style, svg } = extractStyles(selectorElem.element) ?? { svg });\n      }\n    }\n    const sel = {\n      type: \"SvgSelector\",\n      svg,\n      svgShape,\n      style,\n      points: points.length ? points : void 0,\n      spatial: rect ? { unit: \"pixel\", x: rect[0], y: rect[1], width: rect[2] - rect[0], height: rect[3] - rect[1] } : void 0\n    };\n    return resolveHints({\n      selector: sel,\n      selectors: [sel],\n      iiifRenderingHints\n    });\n  }\n  return resolveHints({\n    selector: null,\n    selectors: [],\n    iiifRenderingHints\n  });\n}\nfunction getShapeTypeFromPath(svgPath) {\n  const cmdFrequencies = svgPath.map((seg) => seg[0]).reduce(\n    (acc, cmd) => {\n      acc[cmd] += 1;\n      return acc;\n    },\n    { C: 0, Q: 0, L: 0, M: 0 }\n  );\n  const cmdTypes = new Set(svgPath.map((seg) => seg[0]));\n  if (cmdFrequencies.C > 0 || cmdFrequencies.Q > 0) {\n    return \"path\";\n  }\n  if (cmdFrequencies.L > 0 && (cmdTypes.size === 1 || cmdTypes.size === 2 && cmdTypes.has(\"M\"))) {\n    if (cmdFrequencies.L === 4) {\n      return \"rect\";\n    }\n    const lastSeg = svgPath.slice(-1)[0];\n    if (svgPath[0][0] === \"M\" && lastSeg[0] === \"L\" && lastSeg[1] == svgPath[0][1] && lastSeg[2] === svgPath[0][2] || lastSeg[1] === 0 && lastSeg[2] === 0) {\n      return \"polygon\";\n    } else {\n      return \"polyline\";\n    }\n  }\n  return \"path\";\n}\nfunction getSelectorElement(svgElem) {\n  for (const element of Array.from(svgElem.children)) {\n    switch (element?.tagName.toLowerCase()) {\n      case \"g\":\n        {\n          const res = getSelectorElement(element);\n          if (res) {\n            return res;\n          }\n        }\n        continue;\n      case \"path\": {\n        const p = element.getAttribute(\"d\");\n        if (!p) {\n          continue;\n        }\n        const normalized = parseAndNormalizeSvgPath(p);\n        return { element, points: pathToPoints(normalized), shapeType: getShapeTypeFromPath(normalized) };\n      }\n      case \"circle\": {\n        const cx = parseFloat(element.getAttribute(\"cx\") ?? \"0\");\n        const cy = parseFloat(element.getAttribute(\"cy\") ?? \"0\");\n        const r = parseFloat(element.getAttribute(\"r\") ?? \"0\");\n        if (!r) {\n          continue;\n        }\n        const points = [];\n        for (let angle = 0; angle <= 360; angle += 12) {\n          const rad = angle * Math.PI / 180;\n          points.push([cx + r * Math.cos(rad), cy + r * Math.sin(rad)]);\n        }\n        return { element, points, shapeType: \"circle\" };\n      }\n      case \"ellipse\": {\n        const cx = parseFloat(element.getAttribute(\"cx\") ?? \"0\");\n        const cy = parseFloat(element.getAttribute(\"cy\") ?? \"0\");\n        const rx = parseFloat(element.getAttribute(\"rx\") ?? \"0\");\n        const ry = parseFloat(element.getAttribute(\"ry\") ?? \"0\");\n        if (!rx && !ry) {\n          continue;\n        }\n        const points = [];\n        for (let angle = 0; angle <= 360; angle += 12) {\n          const t = Math.tan(angle / 360 * Math.PI);\n          const px = rx * (1 - t ** 2) / (1 + t ** 2);\n          const py = ry * 2 * t / (1 + t ** 2);\n          points.push([cx + px, cy + py]);\n        }\n        return { element, points, shapeType: \"ellipse\" };\n      }\n      case \"line\": {\n        const x0 = parseFloat(element.getAttribute(\"x0\") ?? \"0\");\n        const y0 = parseFloat(element.getAttribute(\"y0\") ?? \"0\");\n        const x1 = parseFloat(element.getAttribute(\"x1\") ?? \"0\");\n        const y1 = parseFloat(element.getAttribute(\"y1\") ?? \"0\");\n        if (x0 === x1 && y0 === y1) {\n          continue;\n        }\n        return {\n          element,\n          points: [\n            [x0, y0],\n            [x1, y1]\n          ],\n          shapeType: \"polyline\"\n        };\n      }\n      case \"polygon\":\n      case \"polyline\": {\n        const points = element.getAttribute(\"points\")?.split(\" \").map((ps) => ps.split(\",\").map(parseFloat)) ?? [];\n        if (!points.length) {\n          continue;\n        }\n        let shapeType = \"polyline\";\n        if (element.tagName.toLowerCase() === \"polygon\") {\n          points.push(points[0]);\n          shapeType = \"polygon\";\n        }\n        return { element, points, shapeType };\n      }\n      case \"rect\": {\n        const x = parseFloat(element.getAttribute(\"x\") ?? \"0\");\n        const y = parseFloat(element.getAttribute(\"y\") ?? \"0\");\n        const width = parseFloat(element.getAttribute(\"width\") ?? \"0\");\n        const height = parseFloat(element.getAttribute(\"height\") ?? \"0\");\n        if (!width || !height) {\n          continue;\n        }\n        return {\n          element,\n          points: [\n            [x, y],\n            [x + width, y],\n            [x + width, y + height],\n            [x, y + height],\n            [x, y]\n          ],\n          shapeType: \"rect\"\n        };\n      }\n      default:\n        continue;\n    }\n  }\n  return null;\n}\nfunction pathToPoints(normalizedPath) {\n  const out = [];\n  for (let i = 0; i < normalizedPath.length; i++) {\n    const startPoint = out[out.length - 1] ?? [0, 0];\n    const seg = normalizedPath[i];\n    switch (seg[0]) {\n      case \"M\":\n      case \"L\":\n        out.push([seg[1], seg[2]]);\n        continue;\n      case \"C\":\n        out.push(\n          ...flattenCubicBezier(\n            { x: startPoint[0], y: startPoint[1] },\n            { x: seg[1], y: seg[2] },\n            { x: seg[3], y: seg[4] },\n            { x: seg[5], y: seg[6] }\n          ).map((p) => [p.x, p.y]).slice(1)\n          // skip first point, already part of output\n        );\n        continue;\n      case \"Q\":\n        out.push(\n          ...flattenQuadraticBezier(\n            { x: startPoint[0], y: startPoint[1] },\n            { x: seg[1], y: seg[2] },\n            { x: seg[3], y: seg[4] }\n          ).map((p) => [p.x, p.y]).slice(1)\n          // skip first point, already part of output\n        );\n        continue;\n    }\n  }\n  return out;\n}\nfunction extractStyles(selectorElement) {\n  const style = {};\n  if (selectorElement.hasAttribute(\"fill\")) {\n    style.fill = selectorElement.getAttribute(\"fill\");\n    selectorElement.removeAttribute(\"fill\");\n  } else if (selectorElement.style && selectorElement.style.fill) {\n    style.fill = selectorElement.style.fill;\n  }\n  if (style.fill) {\n    const rgbaMatch = RGBA_COLOR.exec(style.fill);\n    if (rgbaMatch) {\n      style.fillOpacity = parseFloat(rgbaMatch[4]);\n      style.fill = `rgb(${rgbaMatch[1]}, ${rgbaMatch[2]}, ${rgbaMatch[3]})`;\n    }\n  }\n  if (selectorElement.hasAttribute(\"fill-opacity\")) {\n    style.fillOpacity = parseFloat(selectorElement.getAttribute(\"fill-opacity\"));\n    selectorElement.removeAttribute(\"fill-opacity\");\n  } else if (selectorElement.style && selectorElement.style.fillOpacity) {\n    style.fillOpacity = parseFloat(selectorElement.style.fillOpacity);\n  }\n  if (selectorElement.hasAttribute(\"stroke\")) {\n    style.stroke = selectorElement.getAttribute(\"stroke\");\n    selectorElement.removeAttribute(\"stroke\");\n  } else if (selectorElement.style && selectorElement.style.stroke) {\n    style.stroke = selectorElement.style.stroke;\n  }\n  if (style.stroke) {\n    const rgbaMatch = RGBA_COLOR.exec(style.stroke);\n    if (rgbaMatch) {\n      style.strokeOpacity = parseFloat(rgbaMatch[4]);\n      style.stroke = `rgb(${rgbaMatch[1]}, ${rgbaMatch[2]}, ${rgbaMatch[3]})`;\n    }\n  }\n  if (selectorElement.hasAttribute(\"stroke-opacity\")) {\n    style.strokeOpacity = parseFloat(selectorElement.getAttribute(\"stroke-opacity\"));\n    selectorElement.removeAttribute(\"stroke-opacity\");\n  } else if (selectorElement.style && selectorElement.style.strokeOpacity) {\n    style.strokeOpacity = parseFloat(selectorElement.style.strokeOpacity);\n  }\n  if (selectorElement.hasAttribute(\"stroke-width\")) {\n    style.strokeWidth = selectorElement.getAttribute(\"stroke-width\");\n    selectorElement.removeAttribute(\"stroke-width\");\n  } else if (selectorElement.style && selectorElement.style.strokeWidth) {\n    style.strokeWidth = selectorElement.style.strokeWidth;\n  }\n  if (selectorElement.hasAttribute(\"stroke-dasharray\")) {\n    style.strokeDasharray = selectorElement.getAttribute(\"stroke-dasharray\");\n    selectorElement.removeAttribute(\"stroke-dasharray\");\n  } else if (selectorElement.style && selectorElement.style.strokeDasharray) {\n    style.strokeDasharray = selectorElement.style.strokeDasharray;\n  }\n  let rootElem = selectorElement;\n  while (rootElem.tagName.toLowerCase() !== \"svg\") {\n    rootElem = rootElem.parentElement;\n    if (rootElem === null) {\n      throw new Error(\"Could not find root SVG element\");\n    }\n  }\n  return { svg: rootElem.outerHTML, style: Object.keys(style).length > 0 ? style : void 0 };\n}\nfunction isImageApiSelector(t) {\n  return !!t && t.type === \"iiif:ImageApiSelector\" && t.type === \"iiif:ImageApiSelector\";\n}\nfunction resolveHints(supported) {\n  if (supported.iiifRenderingHints) {\n    const source = supported.iiifRenderingHints;\n    if (source.rotation) {\n      const parsedRotation = parseRotation(`${source.rotation}`);\n      if (parsedRotation) {\n        if (supported.selectors.length) {\n          for (const selector of supported.selectors) {\n            selector.rotation = parsedRotation;\n          }\n        } else {\n          supported.selectors.push({\n            type: \"RotationSelector\",\n            rotation: parsedRotation\n          });\n        }\n      }\n    }\n  } else {\n    delete supported.iiifRenderingHints;\n  }\n  return supported;\n}\nfunction parseRotation(input) {\n  let num = parseFloat(input);\n  if (num && input.startsWith(\"!\")) {\n    num = 360 - num;\n  }\n  if (num) {\n    num = num % 360;\n  }\n  if (num !== num) {\n    return 0;\n  }\n  return num || 0;\n}\n\n// src/annotation-targets/expand-target.ts\nfunction expandTarget(target, options = {}) {\n  if (Array.isArray(target)) {\n    return expandTarget(target[0]);\n  }\n  if (typeof target === \"string\") {\n    const [id, fragment] = target.split(\"#\");\n    if (!fragment) {\n      return {\n        type: \"SpecificResource\",\n        source: { id, type: options.typeMap && options.typeMap[id] || \"Unknown\" },\n        selector: null,\n        selectors: []\n      };\n    }\n    return expandTarget({\n      type: \"SpecificResource\",\n      source: { id, type: \"Unknown\" },\n      selector: {\n        type: \"FragmentSelector\",\n        value: fragment\n      }\n    });\n  }\n  if (target.type === \"Choice\" || target.type === \"List\" || target.type === \"Composite\" || target.type === \"Independents\") {\n    return expandTarget(target.items[0]);\n  }\n  if (!target.type && \"source\" in target) {\n    target.type = \"SpecificResource\";\n  }\n  if (target.type === \"SpecificResource\") {\n    if (target.source.type === \"Canvas\" && target.source.partOf && typeof target.source.partOf === \"string\") {\n      target.source.partOf = [\n        {\n          id: target.source.partOf,\n          type: \"Manifest\"\n        }\n      ];\n    }\n    const { selector, selectors } = target.selector ? parseSelector(target.selector, options) : { selector: null, selectors: [] };\n    return {\n      type: \"SpecificResource\",\n      source: target.source,\n      selector,\n      selectors\n    };\n  }\n  if (target.id) {\n    if (target.type === \"Canvas\" && target.partOf && typeof target.partOf === \"string\") {\n      target.partOf = [\n        {\n          id: target.partOf,\n          type: \"Manifest\"\n        }\n      ];\n    }\n    const [id, fragment] = target.id.split(\"#\");\n    if (!fragment) {\n      return {\n        type: \"SpecificResource\",\n        source: {\n          ...target,\n          id\n        },\n        selector: null,\n        selectors: []\n      };\n    }\n    return expandTarget({\n      type: \"SpecificResource\",\n      source: {\n        ...target,\n        id\n      },\n      selector: {\n        type: \"FragmentSelector\",\n        value: fragment\n      }\n    });\n  }\n  return {\n    type: \"SpecificResource\",\n    source: target,\n    selector: null,\n    selectors: []\n  };\n}\n\nexport {\n  parseSelector,\n  isImageApiSelector,\n  parseRotation,\n  expandTarget\n};\n/** Code to \"flatten\" quadratic and cubic Bzier curves to polylines.\n *\n * All code in this module is based on JavaScript code by Raph Levien, published on his blog at\n * https://raphlinus.github.io/.\n * I merely changed the structure a bit, removed some unneeded parts and added some comments and type hints.\n *\n * Flattening of quadratic Bzier curves:\n * - Article: https://raphlinus.github.io/graphics/curves/2019/12/23/flatten-quadbez.html\n * - Code: https://github.com/raphlinus/raphlinus.github.io/blob/master/_posts/2019-12-23-flatten-quadbez.md?plain=1#L73-L212\n *\n * Flattening of cubic Bzier curves: https://levien.com/tmp/flatten.html\n *\n * Note that the code in this module has a different license than the rest of the package,\n * due to the inclusion of Apache-licensed third party code.\n *\n * @license\n * Copyright 2022 Johannes Baiter <johannes.baiter@gmail.com>\n * Copyright 2019, 2022 Raph Levien <raph.levien@gmail.com>\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n","var Ce=Object.defineProperty;var Le=(i,e,t)=>e in i?Ce(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t;var w=(i,e,t)=>(Le(i,typeof e!=\"symbol\"?e+\"\":e,t),t);function u(i){return i.endsWith(\"info.json\")?i:i.endsWith(\"/\")?`${i}info.json`:`${i}/info.json`}var Oe=\"http://library.stanford.edu/iiif/image-api/compliance.html#level0\",j=\"http://library.stanford.edu/iiif/image-api/compliance.html#level1\",T=\"http://library.stanford.edu/iiif/image-api/compliance.html#level2\",Pe=\"http://library.stanford.edu/iiif/image-api/conformance.html#level0\",$=\"http://library.stanford.edu/iiif/image-api/conformance.html#level1\",B=\"http://library.stanford.edu/iiif/image-api/conformance.html#level2\",Me=\"http://library.stanford.edu/iiif/image-api/1.1/compliance.html#level0\",N=\"http://library.stanford.edu/iiif/image-api/1.1/compliance.html#level1\",k=\"http://library.stanford.edu/iiif/image-api/1.1/compliance.html#level2\",We=\"http://library.stanford.edu/iiif/image-api/1.1/conformance.html#level0\",G=\"http://library.stanford.edu/iiif/image-api/1.1/conformance.html#level1\",H=\"http://library.stanford.edu/iiif/image-api/1.1/conformance.html#level2\",je=\"http://iiif.io/api/image/1/level0.json\",Te=\"http://iiif.io/api/image/1/profiles/level0.json\",U=\"http://iiif.io/api/image/1/level1.json\",V=\"http://iiif.io/api/image/1/profiles/level1.json\",Q=\"http://iiif.io/api/image/1/level2.json\",D=\"http://iiif.io/api/image/1/profiles/level2.json\",$e=\"http://iiif.io/api/image/2/level0.json\",Be=\"http://iiif.io/api/image/2/profiles/level0.json\",J=\"http://iiif.io/api/image/2/level1.json\",Z=\"http://iiif.io/api/image/2/profiles/level1.json\",K=\"http://iiif.io/api/image/2/level2.json\",X=\"http://iiif.io/api/image/2/profiles/level2.json\",Ne=\"level0\",Y=\"level1\",q=\"level2\",ke=\"http://iiif.io/api/image/2/level0\",ee=\"http://iiif.io/api/image/2/level1\",ie=\"http://iiif.io/api/image/2/level2\",Ge=\"https://iiif.io/api/image/1.1/compliance/#level0\",te=\"https://iiif.io/api/image/1.1/compliance/#level1\",re=\"https://iiif.io/api/image/1.1/compliance/#level2\",R=[ie,T,B,k,H,Q,D,K,X,q,re],_=[...R,ee,j,$,N,G,U,V,J,Z,Y,te],C=[ke,ee,ie,Oe,j,T,Pe,$,B,Me,N,k,We,G,H,je,Te,U,V,Q,D,$e,Be,J,Z,K,X,Ne,Y,q,Ge,te,re],Ve=C,oe={extraFormats:[\"jpg\"],extraQualities:[\"default\"],extraFeatures:[\"sizeByWhListed\"]},ae={extraFormats:[\"jpg\"],extraQualities:[\"default\"],extraFeatures:[\"baseUriRedirect\",\"cors\",\"jsonldMediaType\",\"regionByPx\",\"regionSquare\",\"sizeByWhListed\",\"sizeByH\",\"sizeByW\",\"sizeByWh\"]},ne={extraFormats:[\"jpg\",\"png\"],extraQualities:[\"default\"],extraFeatures:[\"baseUriRedirect\",\"cors\",\"jsonldMediaType\",\"regionByPct\",\"regionByPx\",\"regionSquare\",\"rotationBy90s\",\"sizeByWhListed\",\"sizeByConfinedWh\",\"sizeByH\",\"sizeByPct\",\"sizeByW\",\"sizeByWh\"]},L=[\"baseUriRedirect\",\"canonicalLinkHeader\",\"cors\",\"jsonldMediaType\",\"mirroring\",\"profileLinkHeader\",\"regionByPct\",\"regionByPx\",\"regionSquare\",\"rotationArbitrary\",\"rotationBy90s\",\"sizeByConfinedWh\",\"sizeByH\",\"sizeByPct\",\"sizeByW\",\"sizeByWh\",\"sizeUpscaling\",\"sizeByWhListed\",\"sizeByDistortedWh\",\"sizeByForcedWh\"];function se(i){return R.indexOf(i)!==-1?ne:_.indexOf(i)!==-1?ae:oe}function z(i){let e=i?Array.isArray(i.profile)?i.profile:[i.profile]:[],t={extraQualities:[],extraFormats:[],extraFeatures:[]};for(let r of e)if(typeof r==\"string\"&&(r=se(r)),!!r){if(r.formats)for(let o of r.formats)t.extraFormats.indexOf(o)===-1&&t.extraFormats.push(o);if(r.qualities)for(let o of r.qualities)t.extraQualities.indexOf(o)===-1&&t.extraQualities.push(o);if(r.supports)for(let o of r.supports)t.extraFeatures.indexOf(o)===-1&&t.extraFeatures.push(o);if(r.maxHeight&&(t.maxHeight=r.maxHeight),r.maxWidth&&(t.maxWidth=r.maxWidth),r.maxArea&&(t.maxArea=r.maxArea),r.extraFormats)for(let o of r.extraFormats)t.extraFormats.indexOf(o)===-1&&t.extraFormats.push(o);if(r.extraQualities)for(let o of r.extraQualities)t.extraQualities.indexOf(o)===-1&&t.extraQualities.push(o);if(r.extraFeatures)for(let o of r.extraFeatures)t.extraFeatures.indexOf(o)===-1&&t.extraFeatures.push(o);r.maxHeight&&(t.maxHeight=r.maxHeight),r.maxWidth&&(t.maxWidth=r.maxWidth),r.maxArea&&(t.maxArea=r.maxArea)}if(i.extraFormats)for(let r of i.extraFormats)t.extraFormats.indexOf(r)===-1&&t.extraFormats.push(r);if(i.extraFeatures)for(let r of i.extraFeatures)t.extraFeatures.indexOf(r)===-1&&t.extraFeatures.push(r);if(i.extraQualities)for(let r of i.extraQualities)t.extraQualities.indexOf(r)===-1&&t.extraQualities.push(r);return t}function fe(i){try{if(i===\"full\")return{full:!0};if(i===\"square\")return{square:!0};let e=i.startsWith(\"pct:\"),r=i.substr(e?4:0).split(\",\").map(o=>parseFloat(o));return{x:r[0],y:r[1],w:r[2],h:r[3],percent:e}}catch{throw new Error(\"Expected 'full', 'square' or 'x,y,w,h'. Found \"+i)}}function me(i){let e={upscaled:!1,max:!1,confined:!1};if(i[0]===\"^\"&&(e.upscaled=!0,i=i.slice(1)),i===\"max\"||i===\"full\")return e.max=!0,e.serialiseAsFull=i===\"full\",e;if(i[0]===\"!\"&&(e.confined=!0,i=i.slice(1)),i[0]===\"p\")return e.percentScale=parseFloat(i.slice(4)),e;let t=i.split(\",\").map(r=>r.trim());return t.length&&typeof t[0]<\"u\"&&(t[0]!==\"\"&&(e.width=parseInt(t[0],10)),typeof t[1]<\"u\"&&t[1]!==\"\"?(e.height=parseInt(t[1],10),e.version=2):e.version=3),e}function le(i){let e={angle:0};if(i[0]===\"!\"&&(e.mirror=!0,i=i.substr(1)),e.angle=parseFloat(i)%360,Number.isNaN(e.angle))throw new Error(`Invalid rotation ${i}`);return e}function pe(i,e=\"\"){let t=i.match(/^(([a-zA-Z]+):\\/\\/([^/]+))?((.*)+)/);if(!t)throw new Error(`Invalid or unknown input ${i}`);let r=t[2],o=t[3],a=t[4];if(a[0]===\"/\"&&(a=a.substring(1)),e.length>0){if(e[0]===\"/\"&&(e=e.substring(1)),e!==a.substring(0,e.length))throw new Error(`Path does not start with prefix (path: ${a}, prefix: ${e})`);a=a.substring(e.length)}return{scheme:r,server:o,path:a,prefix:e}}function ce(i,e=\"\"){let{path:t,scheme:r,server:o,prefix:a}=pe(i,e),n=(t||\"\").split(\"/\").reverse(),[s,f,c,m,...h]=n,x=h.reverse().filter(Boolean).join(\"/\");if(n.length===1||s===\"\")return{type:\"base\",scheme:r,server:o,prefix:a,identifier:x};if(s===\"info.json\"){let[,...p]=n;return{type:\"info\",scheme:r,server:o,prefix:a,identifier:p.reverse().filter(Boolean).join(\"/\")}}let g=(s||\"\").split(\".\");if(typeof g[1]>\"u\"||typeof g[0]>\"u\"||typeof m>\"u\"||typeof c>\"u\"||typeof f>\"u\")throw new Error(\"Invalid image request\");return{type:\"image\",scheme:r,server:o,prefix:a,identifier:x,originalPath:t,region:fe(m),size:me(c),rotation:le(f),quality:g[0],format:g[1]}}function he(i){let e=ce(u(i.id));if(e.type!==\"info\")throw new Error(\"Invalid service URL\");let t=z(i);return{identifier:e.identifier,originalPath:\"\",server:e.server,prefix:e.prefix,scheme:e.scheme,type:\"image\",quality:t.extraQualities.indexOf(\"default\")===-1?t.extraQualities[0]:\"default\",region:{full:!0},size:{max:!0,upscaled:!1,confined:!1},format:\"jpg\",rotation:{angle:0}}}function ge(i,e,t){let r=t.length,o=[];for(let a=0;a<r;a++){let n=t[a];if(n){let s=n.width;o.push(i/s)}}return o}function ue(i,e,t){let r=t.length,o=[];for(let a=0;a<r;a++){let n=t[a];n&&o.push({width:Math.floor(i/n),height:Math.floor(e/n)})}return o}function l(i){if(i[\"@id\"])return i[\"@id\"];if(i.id)return i.id}function d(i){if(!i||!i.profile||!l(i))return!1;let e=Array.isArray(i.profile)?i.profile:[i.profile];for(let t of e)if(typeof t==\"string\"&&C.indexOf(t)!==-1)return!0;return!1}function de(i){if(!d(i))return!1;let e=Array.isArray(i.profile)?i.profile:[i.profile];for(let t of e)if(typeof t==\"string\"){if(_.indexOf(t)!==-1)return!0}else{let r=[...t.supports||[],...t.extraFeatures||[]];if(r.indexOf(\"regionByPx\")!==-1&&(r.indexOf(\"sizeByW\")!==-1||r.indexOf(\"sizeByWh\")!==-1))return!0}return!1}function v(i,e){if(e&&e.profile){let t=e.profile;if(t){let r=Array.isArray(t)?t:[t];return r.includes(`level${i}`)||r.includes(`http://iiif.io/api/image/2/level${i}.json`)||r.includes(`http://iiif.io/api/image/1/level${i}.json`)||r.includes(`http://iiif.io/api/image/1/profiles/level${i}.json`)}}return!1}function I(i){return d(i)?v(0,i)?0:v(1,i)?1:v(2,i)?2:null:null}function y(i){return(i[\"@context\"]?Array.isArray(i[\"@context\"])?i[\"@context\"]:[i[\"@context\"]]:[]).indexOf(\"http://iiif.io/api/image/3/context.json\")!==-1}function xe(i){if(!de(i))return[];let e=[],t=Array.isArray(i.profile)?i.profile:[i.profile],r=t.length;for(let o=0;o<r;o++){let a=t[o];if(a&&typeof a!=\"string\"&&(a.maxHeight||a.maxWidth))return[{id:l(i),type:\"variable\",minWidth:0,minHeight:0,maxHeight:a.maxHeight||a.maxWidth,maxWidth:a.maxWidth||a.maxHeight,level:I(i),version:i[\"@context\"]===\"http://iiif.io/api/image/3/context.json\"?3:2}]}if(i.tiles){let o=i.tiles.length;for(let a=0;a<o;a++){let n=i.tiles[a];n&&(n.height||n.width)&&e.push({id:l(i),type:\"variable\",minHeight:0,minWidth:0,maxHeight:n.height||n.width,maxWidth:n.width,level:I(i),version:y(i)?3:2})}}return e}function O(i){let e=/^.*\\/(full)\\/(((\\d+),(\\d+)?)|max)\\/(\\d+)\\/default\\.(jpg|png|jpeg)$/,t=i.match(e);if(t&&t[4]&&t[5]){let r=t[1],o=parseInt(t[4],10),a=parseInt(t[5],10),n=t[7];if((r===\"max\"||r===\"full\")&&o&&a&&n)return{type:\"fixed\",id:i,height:a,width:o}}return{type:\"unknown\",id:i}}function Ie(i){if(i[\"@type\"])return i[\"@type\"];if(i.type)return i.type}function Se(i){if(typeof i==\"string\")return O(i);let e=Ie(i);if(e!==\"Image\"&&e!==\"sc:Image\")return null;let t=i,r=l(t);return r?r&&t.width&&t.height?{id:r,type:\"fixed\",width:t.width,height:t.height,unsafe:!0}:O(r):null}function ve(i){return d(i)?(i&&i.sizes?i.sizes:[]).map(e=>({id:l(i),type:\"fixed-service\",height:e.height,width:e.width,level:I(i),version:y(i)?3:2})):[]}function P(i){let e=[],t=i.length;for(let r=0;r<t;r++){let o=i[r];if(!o)continue;let a=ve(o);a.length&&e.push(...a);let n=xe(o);n.length&&e.push(...n)}return e}function b(i){let e=i.service?Array.isArray(i.service)?i.service:[i.service]:[],t=e.length,r=[];for(let o=0;o<t;o++)d(e[o])&&r.push(e[o]);return r}function ye(i,e=!0,t){let r=[],o=Se(i);if(o===null)return r;let a=i;if(r.push(o),e&&a&&a.width&&a.height){let n=[],s=b(a);for(let f of s){let c={id:l(f),width:a.width,height:a.height};if(t.canLoadSync(c)){let m=t.loadServiceSync(c);m&&(m.height||(m.height=a.height),m.width||(m.width=a.width),n.push(...P([m])))}}if(n.length)return r.push(...n),r}return a.service&&r.push(...P(a.service)),r}function Fe({x:i=0,y:e=0,w:t,h:r,full:o,square:a,percent:n}){if(o)return\"full\";if(a)return\"square\";if(typeof t>\"u\"||typeof r>\"u\")throw new Error(\"RegionParameter: invalid region\");let s=`${i},${e},${t},${r}`;return n?`pct:${s}`:s}function we({max:i,percentScale:e,upscaled:t,confined:r,width:o,height:a,serialiseAsFull:n,version:s}){let f=[];return t&&f.push(\"^\"),i?(f.push(n?\"full\":\"max\"),f.join(\"\")):(r&&f.push(\"!\"),e&&f.push(`pct:${e}`),o&&f.push(`${o}`),f.push(\",\"),a&&s===3&&f.push(`${a}`),f.join(\"\"))}function _e(i){return`${i.mirror?\"!\":\"\"}${(i.angle||0)%360}`}function ze(i,e){let t=i.prefix.startsWith(\"/\")?i.prefix.substr(1):i.prefix,r=`${i.scheme}://${i.server}/${t?`${t}/`:\"\"}${i.identifier}`;if(i.type===\"base\")return r;if(i.type===\"info\")return`${r}/info.json`;let{size:o}=i,{region:a,rotation:n,format:s,quality:f}=i;if(e){let c=e[\"@context\"]?Array.isArray(e[\"@context\"])?e[\"@context\"]:[e[\"@context\"]]:[],m=e.profile,h=c.indexOf(\"http://iiif.io/api/image/2/context.json\")!==-1||m===\"level2\",x=c.indexOf(\"http://iiif.io/api/image/3/context.json\")!==-1;if((o.width===e.width&&!o.height||o.height===e.height&&!o.width||o.width===e.width&&o.height===e.height)&&(o={...o,max:!0}),h&&(o.max&&!o.serialiseAsFull&&(o={...o,serialiseAsFull:!0}),!o.max&&o.width&&o.height&&(o={...o,height:void 0}),o={...o,version:2}),x){if(o.max&&o.serialiseAsFull&&(o={...o,serialiseAsFull:!1}),o.width&&!o.height&&e.width&&e.height){let g=e.height/e.width;o={...o,height:Math.ceil(o.width*g)}}o={...o,version:3}}}return[r,Fe(a),we(o),_e(n),`${f}.${s}`].filter(Boolean).join(\"/\")}function E(i,e,t){let r=he({\"@context\":i.version===3?\"http://iiif.io/api/image/3/context.json\":\"http://iiif.io/api/image/2/context.json\",id:u(l(i)),profile:i.level===null||typeof i.level>\"u\"?\"level0\":`level${i.level}`,type:i.version===3?\"ImageService3\":\"ImageService2\"});if(r.type!==\"image\")throw new Error(\"Invalid service\");return r.size.max=!1,r.size.width=e,r.size.height=t,{id:ze(r),type:\"fixed\",width:e,height:t||i.height/(i.width||1)*e,unsafe:i.width>e}}function S(i){let e=i.replace(/(https?:\\/\\/)?(www.)?/i,\"\");return e.indexOf(\"/\")!==-1?e.split(\"/\")[0]:e}function gt(i){if(!i.width||!i.height)return null;if(i.tiles){let e=i.tiles.sort((r,o)=>Math.max(...o.scaleFactors)-Math.max(...r.scaleFactors)),t=e.length;for(let r=0;r<t;r++){let o=e[r];if(!o)continue;let a=o.width;if(!a)continue;let n=o.scaleFactors.length,s=o.scaleFactors.sort();for(let f=0;f<n;f++){let c=s[f];if(c&&i.width/c<=a&&i.height/c<=a)return{id:l(i),type:\"fixed-service\",width:i.width/c|0,height:i.height/c|0,level:I(i),version:y(i)?3:2}}}}return null}function A(i,e){if(!d(i))return[!1,\"Not a valid image service\"];e.extraFeatures=e.extraFeatures?e.extraFeatures:[];let t=z(i);if(e.exactSize){let r=!1;if(i.sizes)for(let o of i.sizes)o.width&&o.width===e.exactSize.width&&(L.indexOf(\"sizeByW\")!==-1||o.height&&o.height===e.exactSize.height)&&(r=!0),o.height&&o.height===e.exactSize.height&&(L.indexOf(\"sizeByH\")!==-1||o.width&&o.width===e.exactSize.width)&&(r=!0);r||(e.maxWidth=Math.max(e.maxWidth||0,e.exactSize.width||0)||void 0,e.maxHeight=Math.max(e.maxHeight||0,e.exactSize.height||0)||void 0,e.maxArea=Math.max(e.maxArea||0,(e.exactSize.width&&e.exactSize.height?e.exactSize.width*e.exactSize.height:e.maxArea)||0)||void 0,!e.exactSize.height&&e.exactSize.width?e.extraFeatures.indexOf(\"sizeByW\")===-1&&e.extraFeatures.push(\"sizeByW\"):!e.exactSize.width&&e.exactSize.height&&e.extraFeatures.indexOf(\"sizeByH\")===-1&&e.extraFeatures.push(\"sizeByH\"))}if(e.maxArea&&t.maxArea&&e.maxArea>t.maxArea)return[!1,`Max area is ${t.maxArea}`];if(e.maxWidth&&t.maxWidth&&e.maxWidth>t.maxWidth)return[!1,`Max width is ${t.maxWidth}`];if(e.maxHeight&&t.maxHeight&&e.maxHeight>t.maxHeight)return[!1,`Max height is ${t.maxHeight}`];if(e.extraFeatures){let r=[];for(let o of e.extraFeatures)t.extraFeatures.indexOf(o)===-1&&r.push(o);if(r.length)return[!1,`Missing features: ${r.join(\", \")}`]}if(e.extraFormats){let r=[];for(let o of e.extraFormats)t.extraFormats.indexOf(o)===-1&&r.push(o);if(r.length)return[!1,`Missing formats: ${r.join(\", \")}`]}if(e.extraQualities){let r=[];for(let o of e.extraQualities)t.extraQualities.indexOf(o)===-1&&r.push(o);if(r.length)return[!1,`Missing qualities: ${r.join(\", \")}`]}return[!0]}function Ft(i,e){return A(i,{extraFormats:[e]})}function zt(i,e){if(e.type!==\"image\")return[!0];let t=[];e.rotation.mirror&&t.push(\"mirroring\"),e.region.percent&&t.push(\"regionByPct\"),e.region.square?t.push(\"regionSquare\"):e.region.full||t.push(\"regionByPx\"),e.rotation.angle&&(e.rotation.angle%90?t.push(\"rotationArbitrary\"):t.push(\"rotationBy90s\")),e.size.confined&&t.push(\"sizeByConfinedWh\"),!e.size.width&&e.size.height&&t.push(\"sizeByH\"),e.size.percentScale&&t.push(\"sizeByPct\"),(i.sizes||[]).find(n=>n.width===e.size.width&&!e.size.height||n.height===e.size.height&&!e.size.width||n.height===e.size.height&&n.width===e.size.width)?t.push(\"sizeByWhListed\"):(e.size.width&&!e.size.height&&t.push(\"sizeByW\"),e.size.width&&e.size.height&&t.push(\"sizeByWh\")),e.size.upscaled&&t.push(\"sizeUpscaling\");let[o,a]=A(i,{extraFeatures:t,extraQualities:[e.quality],extraFormats:[e.format],exactSize:e.size});return o?[!0]:[!1,a]}function be(i,e,t){let r=i.width?i.width:i.maxWidth;return t.height<=i.maxHeight&&t.width<=i.maxWidth&&t.height>=i.minHeight&&t.width>=i.minWidth&&(!e||Math.abs(t.width-r)<Math.abs(e.width-r))}function Ee(i,e){let t=[],r=Object.assign({unsafeImageService:!1,atAnyCost:!0,fallback:!0,minHeight:64,minWidth:64,maxHeight:1/0,maxWidth:1/0,returnAllOptions:!1,preferFixedSize:!1,allowUnsafe:!1,explain:!1,height:0,width:0},i),o=(m,h=0)=>r.explain?t.push(new Array(h).fill(0).map(x=>\"    \").join(\"\")+m().trim()):void 0,a=[],n=[],s=null;o(()=>`Using configuration: ${JSON.stringify(r,null,2)}`);let f=(m,h)=>{if(o(()=>\"Swapping choice\",3),be(r,h,m)){if(r.preferFixedSize&&m.unsafe){o(()=>`We found an image that was marked as unsafe, but it was the best size. (${m.id})`,4),n.push(m);return}r.returnAllOptions&&h&&n.push(h),o(()=>`We found a new image that was the best size. (${m.id})`,4),s=m}else r.returnAllOptions&&n.push(m)};o(()=>`The input shows we have ${e.length} list(s) of candidates to choose from.`);let c=e.length;for(let m=0;m<c;m++){let h=e[m]();o(()=>`Candidate group ${m}: ${JSON.stringify(h,null,2)}`,1);let x=h.length;o(()=>`Checking candidate list number ${m} and found ${x} potential ways of creating image(s)`,1);for(let g=0;g<x;g++){let p=h[g];if(o(()=>`-> Checking candidate ${g}`,1),p.type===\"unknown\"&&r.atAnyCost&&(o(()=>`We've found an unknown image type, adding this to the \"last resort\" list`,2),a.push(p)),p.type===\"fixed\"&&(p.unsafe?(o(()=>`We've found an unsafe fixed image type, adding this to the \"last resort\" list`,2),a.push(p)):(o(()=>\"We've found a fixed size image, checking if it matches the request\",2),f(p,s))),p.type===\"fixed-service\")if(r.unsafeImageService){o(()=>\"Checking for an image from the tile source, without calculating the right height and width (unsafeImageService)\",2);let F=E(p,r.width,r.height);f(F,s)}else{o(()=>\"Checking for an image from the tile source 3\",2);let F=E(p,p.width,p.height);f(F,s)}if(p.type===\"variable\"&&p.maxWidth){let F=E({id:p.id,type:\"fixed-service\",width:p.maxWidth,height:p.maxWidth,level:p.level,version:p.version},p.maxWidth);f(F,s)}}if(s&&!r.returnAllOptions){if(s.unsafe||r.allowUnsafe)continue;o(()=>`We found a match in choice list number ${m}, no searching any more`);break}}return r.atAnyCost&&n.length===0?(o(()=>s?`We found an image! ${s.id} of type ${s.type}`:'We found no images, but \"atAnyCost\" is set, so returning that'),{best:s||a[0]||null,fallback:a.slice(1),log:t}):r.returnAllOptions?(o(()=>\"Returning all options that we have found\"),{best:(r.atAnyCost?s||n[0]||a[0]:s||n[0])||null,fallback:[...n,...a],log:t}):(o(()=>\"Returning the best image that we found, and a fallback\"),{best:s||n[0]||null,fallback:s?n:n.slice(1),log:t})}function Ae(i,e,t){let r=i>e?i:e,o=t.length,a=[];for(let n=0;n<o;n++){let s=t[n];if(!s||s.scaleFactors.length===0)continue;let f=s.scaleFactors[0];if(!f)continue;let c=r/f,m=[f];for(;c>=s.width;)f=f*2,m.push(f),c=c/2;a.push({...s,scaleFactors:m})}return a}function Re(i,e){if(i.length!==e.length)return!1;if(i.length===0&&e.length===0)return!0;let t=i.length,r=!0;for(let a=0;a<t;a++){let n=i[a],s=e[a];if(n.width!==s.width||n.height!==s.height){r=!1;break}}if(r)return!0;let o=0;for(let a=0;a<t;a++)for(let n=0;n<t;n++)if(i[a].width===e[n].width&&i[a].height===e[n].height){o++;break}return o===t}function M(i){return v(0,i)}var W=class{constructor(e={}){w(this,\"config\",{verificationsRequired:1,approximateServices:!1,enableFetching:!0,disableThrottling:!1});w(this,\"fetchingCount\",0);w(this,\"imageServices\",{});w(this,\"knownImageServers\",{});this.config=Object.assign(this.config,e)}setConfig(e){Object.assign(this.config,e)}sample(e,t,r=!0){let o=S(l(e)),a=u(l(e)),n=this.knownImageServers[o];return this.imageServices[a]=Object.assign(e,{real:!0}),!n&&e.tiles&&!M(e)?(this.knownImageServers[o]={verifications:0,malformed:!1,root:o,preLoaded:r,sampledId:l(e),verified:!1,server:null,result:{context:e[\"@context\"]||[],sampledProfile:e.profile,resourceServiceRatio:t&&e.height?t.height/e.height:1,sampledSizes:e.sizes||[],sizeRatios:ge(e.width,e.height,e.sizes||[]),sampledTiles:e.tiles||[]}},!0):this.verify(e)}preLoad(e,t=!0){this.knownImageServers[e.root]=e,t&&(this.knownImageServers[e.root].malformed=!1,this.knownImageServers[e.root].verifications=this.config.verificationsRequired)}predict(e,t=!1,r=!1){let o=e?.source,a=S(l(e)),n=this.knownImageServers[a],s=u(l(e));return this.imageServices[s]?this.imageServices[s]||null:!this.config.approximateServices||!n||!n.result||!(o?.height||e.height)||!(o?.width||e.width)||!r&&(n.malformed||n.verifications<this.config.verificationsRequired)||M(e.source)?null:(this.imageServices[s]||(this.imageServices[s]={\"@context\":n.result.context,\"@id\":l(e),id:l(e),protocol:\"http://iiif.io/api/image\",tiles:o?.tiles||Ae(e.width,e.height,n.result.sampledTiles),sizes:o?.sizes||ue(Math.round(e.width/n.result.resourceServiceRatio),Math.round(e.height/n.result.resourceServiceRatio),n.result.sizeRatios),profile:o?.profile||n.result.sampledProfile,height:o?.height||e.height,width:o?.width||e.width,real:!1}),this.imageServices[s]||null)}async getThumbnailFromResource(e,t,r=!0,o=[]){let a=e?await this.getImageCandidates(e,r):[];return Ee(t,[()=>o,()=>a])}async getImageCandidates(e,t=!0){let r=e;if(t&&r&&r.height&&r.width){let o=b(r);for(let a of o){let n={id:l(a),width:a.width?a.width:r.width,height:a.height?a.height:r.height,source:a};await this.loadService(n)}}return ye(e,t,this)}async verify(e){let t=this.predict(e,!1,!0),r=await this.fetchService(l(e));if(!t)return!1;let o=t.height===r.height&&t.width===r.width&&t[\"@context\"]===r[\"@context\"]&&Re(t.sizes||[],r.sizes||[]);if(o){let a=S(l(e)),n=this.knownImageServers[a];n&&(n.verifications+=1,n.verifications>=this.config.verificationsRequired&&(n.verified=!0))}return o}canLoadSync(e){let t=typeof e==\"string\"?e:l(e),r=u(t);if(this.imageServices[r])return!0;let o=this.knownImageServers[S(t)];return!!(o&&!o.malformed&&o.verifications>=this.config.verificationsRequired)}async markAsMalformed(e){return this.knownImageServers[S(l(e))].malformed=!0,this.loadService(e,!0)}async fetchService(e,t=!1){let r=u(e),o=this.imageServices[r];if(o&&(!t||o.real))return o;if(!this.config.enableFetching)throw new Error(\"Fetching is not enabled\");let a=await this.fetch(r).then(n=>n.json());return!a.id&&a[\"@id\"]&&(a.id=a[\"@id\"]),a.id!==e&&(a.id=e,a[\"@id\"]&&(a[\"@id\"]=e)),this.imageServices[r]=Object.assign(a,{real:!0}),this.imageServices[r]}async fetch(e,t){return fetch(e,t)}async loadService(e,t=!1){if(!this.config.disableThrottling){let a=!0;for(;a;)if(this.fetchingCount>=this.config.verificationsRequired)await new Promise(n=>setTimeout(n,500));else{a=!1;break}}let r=this.knownImageServers[S(l(e))];if(r&&!r.malformed&&!t){await r.result;let a=this.loadServiceSync(e);if(a)return a}this.fetchingCount++;let o=await this.fetchService(l(e),t);return this.fetchingCount--,o.real&&this.sample(o,e),o}loadServiceSync(e){let t=u(l(e));return this.imageServices[t]?this.imageServices[t]:this.config.approximateServices?this.predict(e):null}},Qt=new W;export{je as IIIF_1_IMAGE_LEVEL_0,Ge as IIIF_1_IMAGE_LEVEL_0_COMPLIANCE,Te as IIIF_1_IMAGE_LEVEL_0_PROFILE,U as IIIF_1_IMAGE_LEVEL_1,te as IIIF_1_IMAGE_LEVEL_1_COMPLIANCE,V as IIIF_1_IMAGE_LEVEL_1_PROFILE,Q as IIIF_1_IMAGE_LEVEL_2,re as IIIF_1_IMAGE_LEVEL_2_COMPLIANCE,D as IIIF_1_IMAGE_LEVEL_2_PROFILE,$e as IIIF_2_IMAGE_LEVEL_0,ke as IIIF_2_IMAGE_LEVEL_0_NO_JSON,Be as IIIF_2_IMAGE_LEVEL_0_PROFILE,J as IIIF_2_IMAGE_LEVEL_1,ee as IIIF_2_IMAGE_LEVEL_1_NO_JSON,Z as IIIF_2_IMAGE_LEVEL_1_PROFILE,K as IIIF_2_IMAGE_LEVEL_2,ie as IIIF_2_IMAGE_LEVEL_2_NO_JSON,X as IIIF_2_IMAGE_LEVEL_2_PROFILE,Ne as IIIF_3_IMAGE_LEVEL_0,Y as IIIF_3_IMAGE_LEVEL_1,q as IIIF_3_IMAGE_LEVEL_2,W as ImageServiceLoader,Me as STANFORD_IIIF_1_IMAGE_COMPLIANCE_0,N as STANFORD_IIIF_1_IMAGE_COMPLIANCE_1,k as STANFORD_IIIF_1_IMAGE_COMPLIANCE_2,We as STANFORD_IIIF_1_IMAGE_CONFORMANCE_0,G as STANFORD_IIIF_1_IMAGE_CONFORMANCE_1,H as STANFORD_IIIF_1_IMAGE_CONFORMANCE_2,Oe as STANFORD_IIIF_IMAGE_COMPLIANCE_0,j as STANFORD_IIIF_IMAGE_COMPLIANCE_1,T as STANFORD_IIIF_IMAGE_COMPLIANCE_2,Pe as STANFORD_IIIF_IMAGE_CONFORMANCE_0,$ as STANFORD_IIIF_IMAGE_CONFORMANCE_1,B as STANFORD_IIIF_IMAGE_CONFORMANCE_2,u as canonicalServiceUrl,z as combineProfiles,he as createImageServiceRequest,L as extraFeatures,ge as extractFixedSizeScales,ue as fixedSizesFromScales,xe as getCustomSizeFromService,Se as getFixedSizeFromImage,ve as getFixedSizesFromService,l as getId,ye as getImageCandidates,P as getImageCandidatesFromService,E as getImageFromTileSource,S as getImageServerFromId,b as getImageServices,gt as getSmallestScaleFactorAsSingleImage,Ie as getType,Qt as imageServiceLoader,C as imageServiceProfiles,ze as imageServiceRequestToString,Ft as imageServiceSupportsFormat,zt as imageServiceSupportsRequest,O as inferSizeFromUrl,be as isBestMatch,d as isImageService,oe as level0,Ve as level0Support,ae as level1,_ as level1Support,ne as level2,R as level2Support,se as levelToProfile,ce as parseImageServiceRequest,pe as parseImageServiceUrl,fe as parseRegionParameter,le as parseRotationParameter,me as parseSizeParameter,Ee as pickBestFromCandidates,Fe as regionParameterToString,_e as rotationParameterToString,Ae as sampledTilesToTiles,we as sizeParameterToString,Re as sizesMatch,A as supports,de as supportsCustomSizes};\n","import {\n  InternationalString,\n  ExternalWebResource,\n  IIIFExternalWebResource,\n  ContentResource,\n  ImageProfile,\n  ImageService,\n  Reference,\n  Creator,\n  Agent,\n  W3CAnnotationTarget,\n} from '@iiif/presentation-3';\nimport {\n  ManifestNormalized,\n  CanvasNormalized,\n  AnnotationPageNormalized,\n  AnnotationNormalized,\n} from '@iiif/presentation-3-normalized';\nimport {\n  globalVault, Vault,\n  buildLocaleString,\n  createPaintingAnnotationsHelper,\n  createThumbnailHelper,\n  expandTarget,\n  SupportedTarget,\n} from '@iiif/helpers';\nimport { ImageServiceLoader as ImageServiceLoader_ } from '@atlas-viewer/iiif-image-api';\n\nimport { getOcrReferences } from './ocr.js';\nimport log from './log.js';\nimport { fetchRespectfully } from './download.js';\n\nconst PURPOSE_ORDER = ['commenting', 'describing', 'tagging', 'no-purpose'];\nconst PURPOSE_LABELS: { [purpose: string]: string } = {\n  commenting: 'Comment',\n  describing: 'Description',\n  tagging: 'Tags',\n};\n\nexport const vault = globalVault() as Vault;\n\n/** Given a language preference in descending order,\n * determine the best set of strings from the\n * internationalized string.\n */\nexport function getI18nValue(\n  val: string | InternationalString,\n  languagePreference: readonly string[]\n): string[];\nexport function getI18nValue(\n  val: string | InternationalString,\n  languagePreference: readonly string[],\n  separator: string\n): string;\nexport function getI18nValue(\n  val: string | InternationalString,\n  languagePreference: readonly string[],\n  separator?: string\n): string | string[] {\n  let splitAfter = false;\n  if (!separator) {\n    separator = '<<<SNIP>>>';\n    splitAfter = true;\n  }\n  const localized = buildLocaleString(val, languagePreference[0] ?? 'none', {\n    defaultText: '',\n    fallbackLanguages: languagePreference.slice(1),\n    separator,\n  });\n  if (splitAfter) {\n    return localized.split(separator).filter((s) => s.length > 0);\n  } else {\n    return localized;\n  }\n}\n\n/** Custom image loader to deal with browser + node intercompatibility.\n *\n * Used for the thumbnail helper.\n */\nclass ImageServiceLoader extends ImageServiceLoader_ {\n  async fetch(input: RequestInfo, init?: RequestInit): Promise<Response> {\n    return fetchRespectfully(input as any, init as any) as any;\n  }\n}\n\nconst thumbHelper = createThumbnailHelper(vault, {\n  imageServiceLoader: new ImageServiceLoader(),\n});\n\n// A few helpers to deal with painting annotations\nexport const { getPaintables, getAllPaintingAnnotations, extractChoices } =\n  createPaintingAnnotationsHelper(vault);\n\n/** Determine best thumbnail image for the manifest. */\nexport async function getThumbnail(\n  manifest: ManifestNormalized,\n  maxDimension: number\n): Promise<string | undefined> {\n  const thumb = await thumbHelper.getBestThumbnailAtSize(manifest, {\n    maxWidth: maxDimension,\n    maxHeight: maxDimension,\n  });\n  return thumb.best?.id;\n}\n\n/** Like a regular external web resource, but with an associated\n profile URI, needed for OCR discovery */\nexport interface ExternalWebResourceWithProfile extends ExternalWebResource {\n  profile: string;\n}\n\n/** Check if a resource is an external resource with an\n * associated profile. */\nexport function isExternalWebResourceWithProfile(\n  res: ContentResource\n): res is ExternalWebResourceWithProfile {\n  return (\n    res.type !== undefined &&\n    ['Dataset', 'Image', 'Video', 'Sound', 'Text', 'unknown'].indexOf(\n      res.type\n    ) >= 0 &&\n    (res as ExternalWebResourceWithProfile).profile !== undefined\n  );\n}\n\n/** See https://iiif.io/api/annex/services/#physical-dimensions */\nexport interface PhysicalDimensionService {\n  '@context': 'http://iiif.io/api/annex/services/physdim/1/context.json';\n  profile: 'http://iiif.io/api/annex/services/physdim';\n  '@id': string;\n  physicalScale: number;\n  physicalUnits: 'in' | 'cm' | 'mm';\n}\n\n/** Check if a service is a IIIF Physical Dimensions service */\nexport function isPhysicalDimensionService(\n  service: any // eslint-disable-line @typescript-eslint/explicit-module-boundary-types\n): service is PhysicalDimensionService {\n  return (\n    typeof service.profile === 'string' &&\n    service.profile === 'http://iiif.io/api/annex/services/physdim'\n  );\n}\n\n/** Check if a IIIF Image endpoint supports arbitrary downscaling. */\nexport function supportsScaling(profile: ImageProfile): boolean {\n  if (typeof profile === 'string') {\n    return profile.indexOf('level2') >= 0;\n  } else {\n    return (profile.supports?.indexOf('sizeByWh') ?? -1) >= 0;\n  }\n}\n\nexport type ImageInfo = {\n  // The 'Image' content resource\n  resource: (ExternalWebResource | IIIFExternalWebResource) & { type: 'Image' };\n  // Where to draw on the corresponding canvas\n  x: number;\n  y: number;\n  // At what size to draw on the canvas?\n  width: number;\n  height: number;\n  // What is the image's size, if available?\n  nativeWidth?: number;\n  nativeHeight?: number;\n  ppi?: number;\n  format?: 'jpeg' | 'png' | 'unsupported';\n  choiceInfo?: {\n    enabled: boolean;\n    optional: boolean;\n    visibleByDefault: boolean;\n    label?: InternationalString;\n  };\n};\n\n/** Information about a canvas that can be obtained without\n *  fetching any external resources */\nexport type CanvasInfo = {\n  canvas: Reference<'Canvas'>;\n  ocr?: {\n    id: string;\n  };\n  images: ImageInfo[];\n  numAnnotations: number;\n};\n\n/** Extract all non-painting annotations that are of interest for PDF generation\n * from a canvas */\nexport function getCanvasAnnotations(canvas: CanvasNormalized): Annotation[] {\n  return vault\n    .get<AnnotationPageNormalized>(canvas.annotations)\n    .flatMap((p) => vault.get<AnnotationNormalized>(p.items))\n    .filter((a) =>\n      Array.isArray(a.motivation)\n        ? a.motivation.find((m) => PURPOSE_LABELS[m] !== undefined) !==\n          undefined\n        : PURPOSE_LABELS[a.motivation ?? 'invalid'] !== undefined\n    )\n    .map((a) => parseAnnotation(a, []))\n    .filter((a): a is Annotation => a !== undefined);\n}\n\n/** Obtain all information about a canvas and its images\n * without hitting any external endpoints.\n */\nexport function getCanvasInfo(canvas: CanvasNormalized): CanvasInfo {\n  const imageInfos = getImageInfos(canvas);\n  const text = getOcrReferences(canvas);\n  return {\n    canvas: { id: canvas.id, type: 'Canvas' },\n    images: imageInfos,\n    // eslint-disable-next-line @typescript-eslint/no-non-null-assertion\n    ocr: text ? { id: text.id! } : undefined,\n    numAnnotations: getCanvasAnnotations(canvas).length,\n  };\n}\n\n/** A annotation prepared for rendering to PDF. */\nexport interface Annotation {\n  id: string;\n  target: SupportedTarget;\n  markup: string;\n  lastModified?: Date;\n  author?: string;\n}\n\n/** Format an annotation agent to a human readable string. */\nfunction agentToString(agent: Agent): string {\n  let name = Array.isArray(agent.name) ? agent.name.join('; ') : agent.name;\n  if (!name) {\n    name = agent.nickname ?? 'unknown';\n  }\n  if (agent.email) {\n    return `${name} <${agent.email}>`;\n  }\n  return name;\n}\n\n/** Format a annotation creator definition to a human readable\n * string. */\nfunction creatorToString(creator: Creator): string {\n  if (Array.isArray(creator)) {\n    if (typeof creator[0] === 'string') {\n      return creator.join('; ');\n    } else {\n      return creator.map((a) => agentToString(a as Agent)).join('; ');\n    }\n  }\n  if (typeof creator === 'string') {\n    return creator;\n  }\n  return agentToString(creator);\n}\n\n/** Parse a IIIF annotation into a format that is more\n *  suitable for rendering to a PDF. */\nexport function parseAnnotation(\n  anno: AnnotationNormalized,\n  langPrefs: readonly string[]\n): Annotation | undefined {\n  if (!anno.target) {\n    return;\n  }\n  // TODO: i18n?\n  const annoBody = anno.body.map((bodyRef) =>\n    vault.get<ContentResource>(bodyRef.id)\n  );\n  const creatorNames: Array<string> = annoBody\n    .map((body) => body.creator)\n    .filter((v: Creator | undefined): v is Creator => v !== undefined)\n    .map(creatorToString);\n  const modifiedDates: Array<number> = annoBody\n    .map((body) => body.modified)\n    .filter((v: string | undefined): v is string => v !== undefined)\n    .map((v: string) => new Date(v).getTime());\n  if (typeof anno.target === 'string') {\n    return;\n  }\n  const targets = vault.get<Exclude<W3CAnnotationTarget, string>>(anno.target.map(t => t.id));\n  const target = expandTarget(targets);\n  const markup = buildAnnotationMarkup(annoBody);\n  if (!markup) {\n    // TODO: Log?\n    throw `No valid textual content in annotation.`;\n  }\n  return {\n    id: anno.id,\n    target,\n    markup,\n    lastModified:\n      modifiedDates.length > 0\n        ? new Date(Math.max(...modifiedDates))\n        : undefined,\n    author: creatorNames.length > 0 ? creatorNames.join('; ') : undefined,\n  };\n}\n\n/** Convert Annotation HTML to PDF Markup */\nfunction buildAnnotationMarkup(\n  bodies: Array<ContentResource>\n): string | undefined {\n  const parts: { [purpose: string]: Array<string> } = {};\n  for (const body of bodies) {\n    if (\n      body.type !== 'TextualBody' ||\n      (body.format !== 'text/plain' && body.format !== 'text/html') ||\n      body.value === undefined\n    ) {\n      continue;\n    }\n    let { purpose } = body;\n    if (Array.isArray(purpose)) {\n      purpose = purpose[0];\n    } else if (!purpose) {\n      purpose = 'no-purpose';\n    }\n    if (!parts[purpose]) {\n      parts[purpose] = [];\n    }\n    parts[purpose].push(body.value);\n  }\n  if (Object.keys(parts).length === 0) {\n    return undefined;\n  }\n  const out: Array<string> = [];\n  for (const purpose of PURPOSE_ORDER) {\n    const purposeLabel = PURPOSE_LABELS[purpose];\n    if (!parts[purpose]) {\n      continue;\n    }\n    if (parts[purpose].length > 1) {\n      if (purposeLabel) {\n        out.push(`<p><b>${purposeLabel}:</b></p>`);\n      }\n      for (const part of parts[purpose]) {\n        // TODO: Convert HTML to PDF rich text\n        out.push(`<p>${part}</p>`);\n      }\n    } else {\n      out.push('<p>');\n      if (purposeLabel) {\n        out.push(`<b>${purposeLabel}:</b> `);\n      }\n      out.push(`${parts[purpose][0]}</p>`);\n    }\n  }\n  if (out.length === 0) {\n    return undefined;\n  }\n  return out.join('\\n');\n}\n\nexport interface CompatibilityReport {\n  compatibility: 'compatible' | 'incompatible' | 'degraded';\n  incompatibleElements: {\n    [canvasId: string]: Set<\n      | 'no-jpeg' // At least one image doesn't have a JPEG representation\n      | 'no-image' // Canvas does not have a single image annotation\n      | 'annotations' // Canvas has non-painting annotations\n      | 'unsupported-painting'\n    >;\n  };\n}\n\nexport function checkCompatibility(\n  manifest: ManifestNormalized\n): CompatibilityReport | undefined {\n  const report = {\n    compatibility: 'compatible',\n    incompatibleElements: {},\n  };\n  for (const canvas of vault.get<CanvasNormalized>(manifest.items)) {\n    const paintingResources = vault\n      .get<AnnotationPageNormalized>(canvas.items)\n      .flatMap((ap) => vault.get<AnnotationNormalized>(ap.items))\n      .flatMap((a) => vault.get<ContentResource>(a.body.map(b => b.id)));\n    const nonPaintingAnnos = manifest.annotations;\n    // TODO: Check if canvas has an image\n    // TODO: Check if every painting annotation is an image with a JPEG available\n    // TODO: Check for the presence of non-painting annotations\n  }\n  return undefined;\n}\n\n/** Parse a IIIF target specification */\nexport function parseTarget(targetStr: string): {\n  x: number;\n  y: number;\n  width: number;\n  height: number;\n} {\n  const [canvasId, fragment] = targetStr.split('#xywh=');\n  if (fragment) {\n    const [x, y, width, height] = fragment\n      .split(',')\n      .map((x) => parseInt(x, 10));\n    return { x, y, width, height };\n  } else {\n    const canvas = vault.get<CanvasNormalized>(canvasId);\n    // Draw to fit canvas\n    return { x: 0, y: 0, width: canvas.width, height: canvas.height };\n  }\n}\n\nexport function getImageFormat(\n  image: ExternalWebResource | IIIFExternalWebResource\n): 'jpeg' | 'png' | 'unsupported' | undefined {\n  if (image.format === 'image/jpeg') {\n    return 'jpeg';\n  } else if (image.format === 'image/png') {\n    return 'png';\n  } else if (image.format === undefined) {\n    if (image.id?.endsWith('.jpg') || image.id?.endsWith('.jpeg')) {\n      return 'jpeg';\n    } else if (image.id?.endsWith('.png')) {\n      return 'png';\n    }\n  } else {\n    return 'unsupported';\n  }\n}\n\n/** Get information about images on a Canvas. */\nexport function getImageInfos(canvas: CanvasNormalized): ImageInfo[] {\n  const imageInfos: ImageInfo[] = [];\n  const paintingAnnos = vault.get<AnnotationPageNormalized>(canvas.items)\n    .flatMap((ap) => vault.get<AnnotationNormalized>(ap.items));\n  for (const anno of paintingAnnos) {\n    const annoTarget = anno.target as any;\n    let target;\n    if (typeof annoTarget === 'string') {\n      target = parseTarget(annoTarget);\n    } else if (annoTarget.type === 'SpecificResource') {\n      target = parseTarget(annoTarget.source.id);\n    } else {\n      console.error(`Unsupported target type for annotation on canvas ${canvas.id}: '${annoTarget.type}'`);\n      continue;\n    }\n\n\n    const body = vault.get<ContentResource>(anno.body.map(b => b.id));\n    for (const resource of body) {\n      if (resource.type !== 'Image') {\n        continue;\n      }\n      imageInfos.push({\n        resource: resource as (\n          | ExternalWebResource\n          | IIIFExternalWebResource\n        ) & { type: 'Image' },\n        ...target,\n        format: getImageFormat(resource),\n        nativeWidth: (resource as any).width as number | undefined,\n        nativeHeight: (resource as any).height as number | undefined,\n      });\n    }\n  }\n\n  const choice = extractChoices(paintingAnnos);\n  if (choice?.type !== 'single-choice') {\n    // Return early if there are no choices available\n    return imageInfos;\n  }\n\n  for (const choiceItem of choice.items) {\n    const resource = vault.get<ContentResource>(choiceItem.id);\n    if (resource.type !== 'Image') {\n      continue;\n    }\n    imageInfos.push({\n      resource: resource as (ExternalWebResource | IIIFExternalWebResource) & {\n        type: 'Image';\n      },\n      // FIXME: Can't choice images have a location and rendering dimensions?\n      x: 0,\n      y: 0,\n      width: canvas.width,\n      height: canvas.height,\n      nativeWidth: (resource as any).width as number | undefined,\n      nativeHeight: (resource as any).height as number | undefined,\n      format: getImageFormat(resource),\n      choiceInfo: {\n        enabled: choiceItem.selected ?? false,\n        optional: true,\n        label: (resource as any).label,\n        visibleByDefault: choiceItem.selected ?? false,\n      },\n    });\n  }\n\n  return imageInfos;\n}\n","/* eslint-disable @typescript-eslint/no-non-null-assertion */\n/* eslint-disable complexity */\n/// Utilities for parsing OCR text from hOCR, ALTO and IIIF Annotations\nimport {\n  Annotation,\n  ContentResource,\n} from '@iiif/presentation-3';\nimport {\n  AnnotationNormalized,\n  CanvasNormalized,\n} from '@iiif/presentation-3-normalized';\nimport {\n  parseAltoPages,\n  parseHocrPages,\n  type OcrPage,\n  type OcrLine,\n  Dimensions,\n} from 'ocr-parser';\n\nimport metrics from './metrics.js';\nimport { fetchRespectfully, rateLimitRegistry } from './download.js';\nimport {\n  isExternalWebResourceWithProfile,\n  ExternalWebResourceWithProfile,\n  vault,\n} from './iiif.js';\n\nexport type OcrPageWithMarkup = OcrPage & {\n  id: string;\n  markup: string;\n  mimeType: string;\n};\n\n/** Helper to calculate a rough fallback image size from the line coordinates\n *\n * @param {array} lines the parsed OCR lines\n * @returns {object} the page size estimated from the line coordinates\n */\nfunction getFallbackImageSize(lines: OcrLine[]): Dimensions {\n  return {\n    width: Math.max(...lines.map(({ x, width }) => x + (width ?? 0))) ?? 0,\n    height: Math.max(...lines.map(({ y, height }) => y + height)) ?? 0,\n  };\n}\n\n/**\n * Parse an OCR document (currently hOCR or ALTO)\n *\n * @param {string} ocrText  ALTO or hOCR markup\n * @param {object} referenceSize Reference size to scale coordinates to\n * @returns {OcrPage} the parsed OCR page\n */\nexport async function parseOcr(\n  id: string,\n  ocrText: string,\n  referenceSize: Dimensions\n): Promise<OcrPageWithMarkup | null> {\n  let pageIter: AsyncGenerator<OcrPage>;\n  const isAlto = ocrText.indexOf('<alto') >= 0;\n  if (isAlto) {\n    pageIter = parseAltoPages(ocrText, [referenceSize]);\n  } else {\n    pageIter = parseHocrPages(ocrText, [referenceSize]);\n  }\n  const page = (await pageIter.next()).value as OcrPage | undefined;\n  if (!page) {\n    return null;\n  }\n  return {\n    ...page,\n    id,\n    markup: ocrText,\n    mimeType: isAlto ? 'application/xml+alto' : 'text/vnd.hocr+html',\n  };\n}\n\n/** Parse OCR data from IIIF annotations.\n *\n * Annotations should be pre-filtered so that they all refer to a single canvas/page.\n * Annotations should only contain a single text granularity, that is either line or word.\n *\n * @param {object} annos IIIF annotations with a plaintext body and line or word granularity\n * @param {Dimensions} imgSize Reference width and height of the rendered target image\n * @returns {OcrPage} parsed OCR boxes\n */\nexport function parseIiifAnnotations(\n  annos: Array<Annotation>,\n  imgSize: Dimensions\n): OcrPage {\n  throw 'Currently not supported';\n}\n\n/** Checks if a given resource points to an ALTO OCR document */\nconst isAlto = (resource: ExternalWebResourceWithProfile) =>\n  resource.format === 'application/xml+alto' ||\n  resource.profile?.startsWith('http://www.loc.gov/standards/alto/');\n\n/** Checks if a given resource points to an hOCR document */\nconst isHocr = (resource: ExternalWebResourceWithProfile) =>\n  resource.format === 'text/vnd.hocr+html' ||\n  resource.profile ===\n    'https://github.com/kba/hocr-spec/blob/master/hocr-spec.md' ||\n  resource.profile?.startsWith('http://kba.cloud/hocr-spec/') ||\n  resource.profile?.startsWith('http://kba.github.io/hocr-spec/');\n\n/** Wrapper around fetch() that returns the content as text */\nasync function fetchOcrMarkup(url: string): Promise<string | undefined> {\n  const resp = await fetchRespectfully(url);\n  if (resp.status === 404) {\n    return undefined;\n  }\n  if (resp.status != 200) {\n    throw new Error(\n      `Could not fetch OCR markup from ${url}, got status code ${resp.status}`\n    );\n  }\n  return resp.text();\n}\n\n/** Fetch external annotation resource JSON */\nexport async function fetchAnnotationResource(url: string): Promise<any> {\n  const resp = await fetchRespectfully(url);\n  return resp.json();\n}\n\n/** Retrieve a supported OCR references from a Canvas' `seeAlso` or `rendering`, if present.\n *\n * 'Supported' currently means external ALTO or hOCR markup.\n */\nexport function getOcrReferences(\n  canvas: CanvasNormalized\n): ExternalWebResourceWithProfile | undefined {\n  const refs = vault.get<ContentResource>(canvas.seeAlso.map((r) => r.id));\n  refs.push(...vault.get<ContentResource>(canvas.rendering.map((r) => r.id)));\n  return refs\n    .filter(isExternalWebResourceWithProfile)\n    .find((r) => isAlto(r) || isHocr(r));\n}\n\nexport async function fetchAndParseText(\n  canvas: CanvasNormalized,\n  annotations?: AnnotationNormalized[]\n): Promise<OcrPageWithMarkup | undefined> {\n  // TODO: Annotations are a major PITA due to all the indirection and multiple\n  //       levels of fetching of external resources that might be neccessary,\n  //       save for later once text rendering is properly done.\n  const ocrRefs = getOcrReferences(canvas);\n  if (ocrRefs) {\n    const stopMeasuring = metrics?.ocrFetchDuration.startTimer({\n      ocr_host: new URL(ocrRefs.id!).host,\n    });\n    let markup;\n    try {\n      markup = await fetchOcrMarkup(ocrRefs.id!);\n      stopMeasuring?.({\n        status: 'success',\n        limited: rateLimitRegistry.isLimited(ocrRefs.id!).toString(),\n      });\n      if (!markup) {\n        return undefined;\n      }\n    } catch (err) {\n      stopMeasuring?.({\n        status: 'error',\n        limited: rateLimitRegistry.isLimited(ocrRefs.id!).toString(),\n      });\n      throw err;\n    }\n    return (\n      (await parseOcr(ocrRefs.id!, markup, {\n        width: canvas.width,\n        height: canvas.height,\n      })) ?? undefined\n    );\n  }\n}\n","/* eslint-disable @typescript-eslint/no-non-null-assertion */\nimport { Mutex } from 'async-mutex';\nimport {\n  ExternalWebResource,\n  FragmentSelector,\n  IIIFExternalWebResource,\n  ImageService,\n  ImageService3,\n  Reference,\n  Selector,\n  Service,\n} from '@iiif/presentation-3';\nimport {\n  CanvasNormalized,\n  ManifestNormalized,\n  RangeNormalized,\n} from '@iiif/presentation-3-normalized'\n\nimport { OcrPageWithMarkup, fetchAndParseText } from './ocr.js';\nimport metrics from './metrics.js';\nimport log from './log.js';\nimport {\n  vault,\n  isPhysicalDimensionService,\n  PhysicalDimensionService,\n  supportsScaling,\n  getCanvasAnnotations,\n  Annotation,\n  ImageInfo,\n} from './iiif.js';\nimport { isDefined } from './util.js';\n\n/// In absence of more detailed information (from physical dimensions service), use this resolution\nconst FALLBACK_PPI = 300;\n\n// HTTP Accept header to make sure we get IIIFv3, if available, via content negotiation\n// Thanks to @jcoyne:\n// https://github.com/ProjectMirador/mirador/pull/3770/files#diff-166256fe28a89c78ada7b08488a3233671fc0511fd39d323c5cfc9433026e2a1R108-R112\nconst MANIFEST_ACCEPT_HEADER = 'application/ld+json;q=0.9;profile=\"http://iiif.io/api/presentation/3/context.json\", '\n  + 'application/ld+json;q=0.7;profile=\"http://iiif.io/api/presentation/2/context.json\", '\n  + 'application/ld+json;q=0.5, '\n  + 'application/json;q=0.2';\n\n/** Maps rate-limited hosts to a mutex that limits the concurrent fetching. */\nclass RateLimitingRegistry {\n  private hostMutexes = new Map<string, Mutex>();\n  private callbacks: Array<(host: string, limited: boolean) => void> = [];\n\n  getMutex(host: string): Mutex | undefined {\n    return this.hostMutexes.get(host);\n  }\n\n  limitHost(host: string): Mutex {\n    const mutex = new Mutex();\n    this.hostMutexes.set(host, mutex);\n    this.callbacks.forEach((cb) => cb(host, true));\n    return mutex;\n  }\n\n  unlimitHost(host: string): void {\n    this.hostMutexes.delete(host);\n    this.callbacks.forEach((cb) => cb(host, false));\n  }\n\n  subscribe(cb: (host: string, limited: boolean) => void): number {\n    this.callbacks.push(cb);\n    return this.callbacks.length - 1;\n  }\n\n  unsubscribe(ticket: number) {\n    this.callbacks.splice(ticket, 1);\n  }\n\n  isLimited(url: string): boolean {\n    return this.hostMutexes.has(new URL(url).host);\n  }\n}\n\nexport const rateLimitRegistry = new RateLimitingRegistry();\n\n/** Tracks for which domains we need and safely can include credentials for */\nconst includedCredentialsHosts = new Set<string>();\n\n/** Check if requests to the given host should include credentials */\nexport function requestsShouldIncludeCredentials(host: string): boolean {\n  return includedCredentialsHosts.has(host);\n}\n\n/** A 'respectful' wrapper around `fetch` that tries to respect rate-limiting headers.\n *\n * Will also retry with exponential backoff in case of server errors.\n */\nexport async function fetchRespectfully(\n  url: string,\n  init: RequestInit = {},\n  maxRetries = 3\n): Promise<Response> {\n  const { host } = new URL(url);\n  // If the host associated with the URL is rate-limited, limit concurrency to a single\n  // fetch at a time by acquiring the mutex for the host.\n  let rateLimitMutex = rateLimitRegistry.getMutex(host);\n  let numRetries = -1;\n  let resp: Response | undefined;\n  let waitMs = 5000;\n  let fetchOptions = { ...init };\n  if (includedCredentialsHosts.has(host)) {\n    fetchOptions.credentials = 'include';\n  }\n  // If we're fetching from a rate-limited host, wait until there's no other fetch for it\n  // going on\n  const release = await rateLimitMutex?.acquire();\n  try {\n    do {\n      resp = await fetch(url, fetchOptions);\n      if (resp.ok) {\n        if (fetchOptions.credentials === 'include') {\n          // If we successfully fetched with credentials, remember that for next request to that host\n          includedCredentialsHosts.add(host);\n        }\n        break;\n      }\n\n      if ((resp.status == 401 || resp.status == 403) && fetchOptions.credentials !== 'include') {\n        // Retry with included credentials and don't increment counter\n        fetchOptions.credentials = 'include';\n        continue;\n      }\n\n\n      numRetries++;\n\n      const retryAfter = resp?.headers.get('retry-after');\n      if (isDefined(retryAfter)) {\n        if (Number.isInteger(retryAfter)) {\n          waitMs = Number.parseInt(retryAfter, 10) * 1000;\n        } else {\n          const waitUntil = Date.parse(retryAfter);\n          waitMs = waitUntil - Date.now();\n        }\n      } else {\n        // Exponential backoff with a random multiplier on the base wait time\n        waitMs = Math.pow(Math.random() * 2 * waitMs, numRetries);\n      }\n\n      // Check if the server response has headers corresponding to the IETF `RateLimit Header Fiels for HTTP` spec draft[1]\n      // [1] https://www.ietf.org/archive/id/draft-polli-ratelimit-headers-05.html\n      const getHeaderValue = (ietfHeader: string): number | undefined => {\n        const headerVariants = [\n          ietfHeader,\n          `x-${ietfHeader}`,\n          `x-${ietfHeader.replace('ratelimit', 'rate-limit')}`,\n        ];\n        return headerVariants\n          .map((header) => resp?.headers.get(header))\n          .filter(isDefined<string>)\n          .map((limit) => Number.parseInt(limit, 10))\n          .find((limit) => limit != null);\n      };\n      const limit = getHeaderValue('ratelimit-limit');\n      const remaining = getHeaderValue('ratelimit-remaining');\n      const reset = getHeaderValue('ratelimit-reset');\n      if (\n        limit !== undefined &&\n        remaining !== undefined &&\n        reset !== undefined\n      ) {\n        // At this point we're pretty sure that we're being rate-limited, so let's\n        // limit concurrency from here on out.\n        rateLimitMutex = rateLimitRegistry.limitHost(host);\n\n        // We assume a sliding window implemention here\n        const secsPerQuotaUnit = reset / (limit - remaining);\n        if (remaining > 0) {\n          // If we have remaining quota units but were blocked, we wait until we have enough\n          // quota to fetch remaining*2 quota units (i.e. we assume that the units in `remaining`\n          // were not enough to fully fetch the resource)\n          waitMs = 2 * remaining * secsPerQuotaUnit * 1000;\n        } else {\n          waitMs = secsPerQuotaUnit * 1000;\n        }\n      }\n\n      // Add a 100ms buffer just to be safe and wait until the next attempt\n      await new Promise((resolve) => setTimeout(resolve, waitMs + 100));\n    } while (numRetries < maxRetries);\n  } finally {\n    if (rateLimitMutex) {\n      // We're being rate-limited, so wait some more so the next request doesn't\n      // encounter a server error on fetching\n      await new Promise((resolve) => setTimeout(resolve, waitMs + 100));\n    }\n    release?.();\n  }\n  return resp;\n}\n\n/** Container for image size along with its corresponding IIIF Image API string. */\nexport type SizeInfo = {\n  iiifSize: string;\n  width: number;\n  height: number;\n};\n\n/** Calculate the image size to fetch, based on user constraints and available sizes\n *  in the Image API info.json response.\n */\nexport function getImageSize(\n  imgService: ImageService,\n  scaleFactor = 1\n): SizeInfo {\n  let sizeStr: string;\n  const isIIIFv3 = (imgService as ImageService3).id !== undefined;\n  const maxWidth = imgService.maxWidth ?? imgService.width!;\n  let requestedWidth = Math.floor(scaleFactor * maxWidth);\n  const aspectRatio = imgService.width! / imgService.height!;\n  const supportsScaleByWh = Array.isArray(imgService.profile)\n    ? imgService.profile.find(supportsScaling) !== undefined\n    : supportsScaling(imgService.profile);\n  if (scaleFactor < 1 && !supportsScaleByWh) {\n    if (imgService.sizes) {\n      // AR-compliant downscaling is not supported, find the closest available size\n      requestedWidth = Math.min(...imgService.sizes.map((dims) => Math.abs(requestedWidth - dims.width)));\n      sizeStr = `${requestedWidth},`;\n    } else {\n      // No sizes available, so we can't downscale.\n      sizeStr = `${maxWidth},`;\n    }\n  } else if (scaleFactor == 1) {\n    sizeStr =\n      isIIIFv3 || imgService.maxWidth || imgService.maxArea ? 'max' : 'full';\n    if (imgService.maxWidth) {\n      requestedWidth = imgService.maxWidth;\n    } else if (imgService.maxHeight) {\n      requestedWidth = Math.round(aspectRatio * imgService.maxHeight);\n    } else if (imgService.maxArea) {\n      const fullArea = imgService.width! * imgService.height!;\n      const scaleFactor = imgService.maxArea / fullArea;\n      requestedWidth = Math.round(scaleFactor * imgService.width!);\n    } else {\n      requestedWidth = imgService.width!;\n    }\n  } else {\n    sizeStr = `${requestedWidth},`;\n  }\n  return {\n    iiifSize: sizeStr,\n    width: requestedWidth as number,\n    height: (requestedWidth as number) / aspectRatio,\n  };\n}\n\n/** Use a IIIF Physical Dimensions service to obtain the PPI for a canvas. */\nexport function getPointsPerInch(services: Service[]): number | null {\n  const physDimService = services.find(isPhysicalDimensionService) as\n    | PhysicalDimensionService\n    | undefined;\n  if (!physDimService) {\n    return null;\n  }\n  const { physicalScale, physicalUnits } = physDimService;\n  let ppi;\n  if (physicalUnits === 'in') {\n    ppi = 1 / physicalScale;\n  } else if (physicalUnits === 'mm') {\n    ppi = 25.4 / physicalScale;\n  } else if (physicalUnits === 'cm') {\n    ppi = 2.54 / physicalScale;\n  } else {\n    ppi = FALLBACK_PPI;\n  }\n  return ppi;\n}\n\nexport function isImageFetchFailure(obj: CanvasImageData | ImageFetchFailure): obj is ImageFetchFailure {\n  return (obj as ImageFetchFailure).cause !== undefined;\n}\n\n/** All the data relevant for the canvas: images and text */\nexport type CanvasData = {\n  canvas: Reference<'Canvas'>;\n  text?: OcrPageWithMarkup;\n  images: CanvasImage[];\n  annotations: Annotation[];\n  ppi?: number;\n  imageFailures: ImageFetchFailure[];\n};\n\nexport type ImageFetchFailure = ImageInfo & {\n  cause: Error | string;\n}\n\n\n/** Data and additional information for an image on a canvas. */\nexport type CanvasImage = ImageInfo & CanvasImageData;\n\n/** Data and additional info for a canvas image, based on retrieval\n *  of external resources.\n */\nexport type CanvasImageData = {\n  data?: ArrayBuffer;\n  numBytes: number;\n  format: 'jpeg' | 'png';\n  corsAvailable: boolean;\n  ppi?: number;\n  nativeWidth?: number;\n  nativeHeight?: number;\n  downscaled?: boolean;\n};\n\n/** Options for fetching image */\nexport type FetchImageOptions = {\n  /// Factor to downscale the image by, number between 0.1 and 1\n  scaleFactor?: number;\n  /// PPI override, will be fetched from physical dimensions serivce by default\n  ppiOverride?: number;\n  // Optional signal to use for aborting the image fetching\n  abortSignal?: AbortSignal;\n  /// Only obtain the size of the image, don't fetch any data\n  sizeOnly?: boolean;\n};\n\n/** Download (or only determine size in bytes of) a canvas image. */\nasync function fetchCanvasImage(\n  image: IIIFExternalWebResource | ExternalWebResource,\n  { scaleFactor, abortSignal, sizeOnly = false }: FetchImageOptions\n): Promise<CanvasImageData | null> {\n  // NOTE: Here be dragons, who'd have thought downloading an image\n  //       could be so complicated?\n  if (abortSignal?.aborted) {\n    log.debug(\n      'Abort signalled, aborting before initiating image data fetching.'\n    );\n    throw new Error('Aborted due to client request', { cause: { type: 'abort' } });\n  }\n  if (image.type !== 'Image') {\n    throw new Error(`Can only fetch image resources, got ${image.type}`);\n  }\n  let imgService: ImageService | undefined;\n  if ('service' in image) {\n    imgService = image.service?.find(\n      (s: Service): s is ImageService =>\n        ((s as ImageService | undefined)?.type?.startsWith('ImageService') ??\n          false) ||\n        ((s as any)?.['@type']?.startsWith('ImageService') ?? false)\n    );\n  }\n  let ppi: number | undefined;\n  let imageUrl: string;\n  let downscaled = false;\n  if (imgService) {\n    if (!imgService.width) {\n      imgService = await fetchFullImageService(imgService);\n    }\n    const sizeInfo = getImageSize(imgService, scaleFactor);\n    imageUrl = `${imgService.id ?? imgService['@id']}/full/${sizeInfo.iiifSize\n      }/0/default.jpg`;\n    ppi = getPointsPerInch(imgService.service ?? []) ?? undefined;\n    if (ppi) {\n      ppi = ppi * (sizeInfo.width / imgService.width!);\n    }\n    if (sizeInfo.width < imgService.width!) {\n      downscaled = true;\n    }\n  } else if (image.id && ['image/jpeg', 'image/png'].indexOf(image.format ?? 'unknown') >= 0) {\n    imageUrl = image.id;\n  } else {\n    log.error(\n      `No JPEG or PNG image identifier for resource ${image.id} could be found!`\n    );\n    return null;\n  }\n\n  let data: ArrayBuffer | undefined;\n  let numBytes: number;\n  let corsAvailable = true;\n  let format: 'jpeg' | 'png' | null = null;\n  const stopMeasuring = metrics?.imageFetchDuration.startTimer({\n    iiif_host: new URL(imageUrl).host,\n  });\n  try {\n    const imgResp = await fetchRespectfully(imageUrl, {\n      method: 'GET',\n      signal: abortSignal,\n    });\n    if (imgResp.status >= 400) {\n      throw new Error(\n        `Failed to fetch page image from ${imageUrl}, server returned status ${imgResp.status}`,\n        { cause: { type: 'http-status', status: imgResp.status } }\n      );\n    }\n    if (abortSignal?.aborted) {\n      throw new Error('Aborted due to client request', { cause: { type: 'abort' } });\n    }\n    numBytes = Number.parseInt(imgResp.headers.get('Content-Length') ?? '-1');\n    data = sizeOnly && numBytes >= 0 ? undefined : await imgResp.arrayBuffer();\n    if (imgResp.headers.get('Content-Type')?.startsWith('image/jpeg')) {\n      format = 'jpeg';\n    } else if (imgResp.headers.get('Content-Type')?.startsWith('image/png')) {\n      format = 'png';\n    } else {\n      throw new Error('Unsupported image content type', { cause: { type: 'content-type' } });\n    }\n    if (numBytes < 0) {\n      numBytes = data?.byteLength ?? -1;\n    }\n    stopMeasuring?.({\n      status: 'success',\n      limited: rateLimitRegistry.isLimited(imageUrl).toString(),\n    });\n  } catch (err) {\n    // In browsers, we can't differentiate between a 'normal' network error\n    // (like an unavailable server) and a CORS error just from the response\n    // alone, so we we use a small hack involving the DOM\n    const isCorsError = typeof document !== 'undefined' && await isImageUnavailableDueToCors(imageUrl);\n    // No CORS error or CORS error, but need data? Can't continue\n    if (!isCorsError) {\n      log.error(`Failed to fetch image data from ${imageUrl}: ${err}`);\n      stopMeasuring?.({\n        status: 'error',\n        limited: rateLimitRegistry.isLimited(imageUrl).toString(),\n        cause: err instanceof Error ? (err.cause as any).type : err\n      });\n      throw err;\n    } else if (!sizeOnly) {\n      throw new Error('Data requested, but no CORS for the image endpoint', { cause: { type: 'no-cors' } });\n    }\n    corsAvailable = false;\n    log.warn(\n      `Failed to fetch image data from ${imageUrl}: CORS headers missing!`\n    );\n    // We can get the size without CORS\n    const imgResp = await fetchRespectfully(imageUrl, {\n      method: 'GET',\n      signal: abortSignal,\n      mode: 'no-cors',\n    });\n    numBytes = Number.parseInt(imgResp.headers.get('Content-Length') ?? '-1');\n  }\n\n  return {\n    data,\n    ppi,\n    numBytes,\n    corsAvailable,\n    format: format!,\n    downscaled,\n  };\n}\n\n/** Check if an image is unavailable due to missing CORS headers. */\nasync function isImageUnavailableDueToCors(imageUrl: string): Promise<boolean> {\n  const imgElem = document.createElement('img');\n  imgElem.src = imageUrl;\n  return new Promise((resolve) => {\n    // Image loads fine for element => Unavailable due to missing CORS headers\n    imgElem.onload = () => resolve(true);\n    // Image also errors when loading via element => Server can't be reached\n    imgElem.onerror = () => resolve(false);\n  });\n}\n\n/** Information about the starting canvas of a Manifet or a Range.\n * Can point to a whole canvas or to a part of it. */\nexport type StartCanvasInfo =\n  | string\n  | {\n    id: string;\n    ppi: number;  // Needed to create link in PDF\n    dimensions: { width: number; height: number };\n    position: {\n      x: number;\n      y: number;\n      width: number;\n      height: number;\n    };\n  };\n\n/** Fetch all of the information needed for a start canvas. */\nexport async function fetchStartCanvasInfo(\n  resource: ManifestNormalized | RangeNormalized\n): Promise<StartCanvasInfo | undefined> {\n  const startRef = resource.start;\n  if (!startRef) {\n    return;\n  }\n  let canvasId: string | undefined;\n  let fragment: string | undefined;\n  if (typeof startRef === 'string') {\n    const [ident, selectorStr] = (startRef as string).split('#xywh=');\n    if (!selectorStr) {\n      return ident;\n    }\n    canvasId = ident;\n    fragment = `xywh=${selectorStr}`;\n  } else if (startRef.type === 'SpecificResource') {\n    return startRef.id;\n  } else {\n    const selector = vault.get<Exclude<Selector, string>>(startRef.id!);\n    if (typeof selector === 'string' || selector.type !== 'FragmentSelector') {\n      log.warn(\n        `Unsupported selector type, cannot determine start canvas for ${resource.id}`\n      );\n      return;\n    }\n    const fragSel = selector as FragmentSelector;\n    if (fragSel.conformsTo !== 'http://www.w3.org/TR/media-frags/') {\n      log.warn(\n        `Unsupported selector type, cannot determine start canvas for ${resource.id} (fragment selector type was ${fragSel.conformsTo})`\n      );\n      return;\n    }\n    canvasId = fragSel.value;\n  }\n  if (!fragment || !canvasId) {\n    log.error(\n      `Couldn't parse either canvas identifier or selector for ${resource.id} start canvas.`\n    );\n    return;\n  }\n  const [selX, selY, selWidth, selHeight] = fragment\n    .substring(5)\n    .split(',')\n    .map((v) => Number.parseInt(v, 10));\n  const canvas = vault.get<CanvasNormalized>(canvasId);\n  const ppi = getPointsPerInch(canvas.service) ?? FALLBACK_PPI;\n  return {\n    id: canvasId,\n    ppi,\n    dimensions: { width: canvas.width, height: canvas.height },\n    position: {\n      x: selX,\n      y: selY,\n      width: selWidth,\n      height: selHeight,\n    },\n  };\n}\n\n/** Fetch all of the data associated with a canvas, including external services. */\nexport async function fetchCanvasData(\n  canvas: CanvasNormalized,\n  imageInfos: ImageInfo[],\n  { scaleFactor, ppiOverride, abortSignal, sizeOnly = false }: FetchImageOptions\n): Promise<CanvasData | undefined> {\n  const imagePromises = imageInfos.map(i => i.resource).map(r => fetchCanvasImage(r, { scaleFactor, abortSignal, sizeOnly }));\n  const results = await Promise.allSettled(imagePromises);\n  const canvasImages = results\n    .reduce((acc, x, idx) => {\n      if (x.status !== 'fulfilled' || x.value === null) {\n        return acc;\n      }\n      const imgInfo = imageInfos[idx];\n      acc.push({\n        ...imgInfo,\n        ...x.value,\n        // FIXME: How can we get rid of the cast?\n      } as CanvasImage);\n      return acc;\n    }, [] as CanvasImage[])\n  const failures: ImageFetchFailure[] = results\n    .filter((x): x is PromiseRejectedResult => x.status === 'rejected')\n    .map((x, idx) => {\n      const info = imageInfos[idx];\n      return {\n        ...info,\n        cause: x.reason,\n      }\n    });\n  const ppi = ppiOverride;\n  if (!ppiOverride) {\n    let ppi = getPointsPerInch(canvas.service) ?? undefined;\n    if (ppi && scaleFactor) {\n      ppi = ppi * scaleFactor;\n    }\n  }\n  let text;\n  if (!sizeOnly) {\n    try {\n      text = await fetchAndParseText(canvas, undefined);\n    } catch (err) {\n      log.warn(`Failed to fetch text for canvas ${canvas.id}: ${err}`);\n    }\n  }\n  return {\n    canvas,\n    images: canvasImages,\n    imageFailures: failures,\n    ppi,\n    text,\n    annotations: getCanvasAnnotations(canvas),\n  };\n}\n\n/** Download the JSON data for a manifest, handling stuff like broken CORS implementations\n *  and Content-Negotiation for IIIFv3 */\nexport async function fetchManifestJson(manifestUrl: string): Promise<any> {\n  try {\n    const resp = await fetch(manifestUrl, {\n      headers: {\n        Accept: MANIFEST_ACCEPT_HEADER\n      }\n    });\n    return await resp.json();\n  } catch (err) {\n    // Check if fetching failed due to CORS by downgrading the request to a\n    // 'simple' request by removing the `Accept` header, which makes the\n    // request CORS-unsafe due to double quotes and the colon in the URL\n    const resp = await fetch(manifestUrl);\n    return await resp.json();\n  }\n}\n\n/** Fetch the full IIIF Image service definition from\n * its info.json endpoint. */\nexport async function fetchFullImageService(\n  serviceRef: ImageService\n): Promise<ImageService> {\n  const serviceUrl = `${serviceRef['@id'] ?? serviceRef.id}/info.json`;\n  const resp = await fetch(serviceUrl);\n  const res = await resp.json();\n  return res as ImageService;\n}","'use strict';\n\nvar has = Object.prototype.hasOwnProperty\n  , prefix = '~';\n\n/**\n * Constructor to create a storage for our `EE` objects.\n * An `Events` instance is a plain object whose properties are event names.\n *\n * @constructor\n * @private\n */\nfunction Events() {}\n\n//\n// We try to not inherit from `Object.prototype`. In some engines creating an\n// instance in this way is faster than calling `Object.create(null)` directly.\n// If `Object.create(null)` is not supported we prefix the event names with a\n// character to make sure that the built-in object properties are not\n// overridden or used as an attack vector.\n//\nif (Object.create) {\n  Events.prototype = Object.create(null);\n\n  //\n  // This hack is needed because the `__proto__` property is still inherited in\n  // some old browsers like Android 4, iPhone 5.1, Opera 11 and Safari 5.\n  //\n  if (!new Events().__proto__) prefix = false;\n}\n\n/**\n * Representation of a single event listener.\n *\n * @param {Function} fn The listener function.\n * @param {*} context The context to invoke the listener with.\n * @param {Boolean} [once=false] Specify if the listener is a one-time listener.\n * @constructor\n * @private\n */\nfunction EE(fn, context, once) {\n  this.fn = fn;\n  this.context = context;\n  this.once = once || false;\n}\n\n/**\n * Add a listener for a given event.\n *\n * @param {EventEmitter} emitter Reference to the `EventEmitter` instance.\n * @param {(String|Symbol)} event The event name.\n * @param {Function} fn The listener function.\n * @param {*} context The context to invoke the listener with.\n * @param {Boolean} once Specify if the listener is a one-time listener.\n * @returns {EventEmitter}\n * @private\n */\nfunction addListener(emitter, event, fn, context, once) {\n  if (typeof fn !== 'function') {\n    throw new TypeError('The listener must be a function');\n  }\n\n  var listener = new EE(fn, context || emitter, once)\n    , evt = prefix ? prefix + event : event;\n\n  if (!emitter._events[evt]) emitter._events[evt] = listener, emitter._eventsCount++;\n  else if (!emitter._events[evt].fn) emitter._events[evt].push(listener);\n  else emitter._events[evt] = [emitter._events[evt], listener];\n\n  return emitter;\n}\n\n/**\n * Clear event by name.\n *\n * @param {EventEmitter} emitter Reference to the `EventEmitter` instance.\n * @param {(String|Symbol)} evt The Event name.\n * @private\n */\nfunction clearEvent(emitter, evt) {\n  if (--emitter._eventsCount === 0) emitter._events = new Events();\n  else delete emitter._events[evt];\n}\n\n/**\n * Minimal `EventEmitter` interface that is molded against the Node.js\n * `EventEmitter` interface.\n *\n * @constructor\n * @public\n */\nfunction EventEmitter() {\n  this._events = new Events();\n  this._eventsCount = 0;\n}\n\n/**\n * Return an array listing the events for which the emitter has registered\n * listeners.\n *\n * @returns {Array}\n * @public\n */\nEventEmitter.prototype.eventNames = function eventNames() {\n  var names = []\n    , events\n    , name;\n\n  if (this._eventsCount === 0) return names;\n\n  for (name in (events = this._events)) {\n    if (has.call(events, name)) names.push(prefix ? name.slice(1) : name);\n  }\n\n  if (Object.getOwnPropertySymbols) {\n    return names.concat(Object.getOwnPropertySymbols(events));\n  }\n\n  return names;\n};\n\n/**\n * Return the listeners registered for a given event.\n *\n * @param {(String|Symbol)} event The event name.\n * @returns {Array} The registered listeners.\n * @public\n */\nEventEmitter.prototype.listeners = function listeners(event) {\n  var evt = prefix ? prefix + event : event\n    , handlers = this._events[evt];\n\n  if (!handlers) return [];\n  if (handlers.fn) return [handlers.fn];\n\n  for (var i = 0, l = handlers.length, ee = new Array(l); i < l; i++) {\n    ee[i] = handlers[i].fn;\n  }\n\n  return ee;\n};\n\n/**\n * Return the number of listeners listening to a given event.\n *\n * @param {(String|Symbol)} event The event name.\n * @returns {Number} The number of listeners.\n * @public\n */\nEventEmitter.prototype.listenerCount = function listenerCount(event) {\n  var evt = prefix ? prefix + event : event\n    , listeners = this._events[evt];\n\n  if (!listeners) return 0;\n  if (listeners.fn) return 1;\n  return listeners.length;\n};\n\n/**\n * Calls each of the listeners registered for a given event.\n *\n * @param {(String|Symbol)} event The event name.\n * @returns {Boolean} `true` if the event had listeners, else `false`.\n * @public\n */\nEventEmitter.prototype.emit = function emit(event, a1, a2, a3, a4, a5) {\n  var evt = prefix ? prefix + event : event;\n\n  if (!this._events[evt]) return false;\n\n  var listeners = this._events[evt]\n    , len = arguments.length\n    , args\n    , i;\n\n  if (listeners.fn) {\n    if (listeners.once) this.removeListener(event, listeners.fn, undefined, true);\n\n    switch (len) {\n      case 1: return listeners.fn.call(listeners.context), true;\n      case 2: return listeners.fn.call(listeners.context, a1), true;\n      case 3: return listeners.fn.call(listeners.context, a1, a2), true;\n      case 4: return listeners.fn.call(listeners.context, a1, a2, a3), true;\n      case 5: return listeners.fn.call(listeners.context, a1, a2, a3, a4), true;\n      case 6: return listeners.fn.call(listeners.context, a1, a2, a3, a4, a5), true;\n    }\n\n    for (i = 1, args = new Array(len -1); i < len; i++) {\n      args[i - 1] = arguments[i];\n    }\n\n    listeners.fn.apply(listeners.context, args);\n  } else {\n    var length = listeners.length\n      , j;\n\n    for (i = 0; i < length; i++) {\n      if (listeners[i].once) this.removeListener(event, listeners[i].fn, undefined, true);\n\n      switch (len) {\n        case 1: listeners[i].fn.call(listeners[i].context); break;\n        case 2: listeners[i].fn.call(listeners[i].context, a1); break;\n        case 3: listeners[i].fn.call(listeners[i].context, a1, a2); break;\n        case 4: listeners[i].fn.call(listeners[i].context, a1, a2, a3); break;\n        default:\n          if (!args) for (j = 1, args = new Array(len -1); j < len; j++) {\n            args[j - 1] = arguments[j];\n          }\n\n          listeners[i].fn.apply(listeners[i].context, args);\n      }\n    }\n  }\n\n  return true;\n};\n\n/**\n * Add a listener for a given event.\n *\n * @param {(String|Symbol)} event The event name.\n * @param {Function} fn The listener function.\n * @param {*} [context=this] The context to invoke the listener with.\n * @returns {EventEmitter} `this`.\n * @public\n */\nEventEmitter.prototype.on = function on(event, fn, context) {\n  return addListener(this, event, fn, context, false);\n};\n\n/**\n * Add a one-time listener for a given event.\n *\n * @param {(String|Symbol)} event The event name.\n * @param {Function} fn The listener function.\n * @param {*} [context=this] The context to invoke the listener with.\n * @returns {EventEmitter} `this`.\n * @public\n */\nEventEmitter.prototype.once = function once(event, fn, context) {\n  return addListener(this, event, fn, context, true);\n};\n\n/**\n * Remove the listeners of a given event.\n *\n * @param {(String|Symbol)} event The event name.\n * @param {Function} fn Only remove the listeners that match this function.\n * @param {*} context Only remove the listeners that have this context.\n * @param {Boolean} once Only remove one-time listeners.\n * @returns {EventEmitter} `this`.\n * @public\n */\nEventEmitter.prototype.removeListener = function removeListener(event, fn, context, once) {\n  var evt = prefix ? prefix + event : event;\n\n  if (!this._events[evt]) return this;\n  if (!fn) {\n    clearEvent(this, evt);\n    return this;\n  }\n\n  var listeners = this._events[evt];\n\n  if (listeners.fn) {\n    if (\n      listeners.fn === fn &&\n      (!once || listeners.once) &&\n      (!context || listeners.context === context)\n    ) {\n      clearEvent(this, evt);\n    }\n  } else {\n    for (var i = 0, events = [], length = listeners.length; i < length; i++) {\n      if (\n        listeners[i].fn !== fn ||\n        (once && !listeners[i].once) ||\n        (context && listeners[i].context !== context)\n      ) {\n        events.push(listeners[i]);\n      }\n    }\n\n    //\n    // Reset the array, or remove it completely if we have no more listeners.\n    //\n    if (events.length) this._events[evt] = events.length === 1 ? events[0] : events;\n    else clearEvent(this, evt);\n  }\n\n  return this;\n};\n\n/**\n * Remove all listeners, or those of the specified event.\n *\n * @param {(String|Symbol)} [event] The event name.\n * @returns {EventEmitter} `this`.\n * @public\n */\nEventEmitter.prototype.removeAllListeners = function removeAllListeners(event) {\n  var evt;\n\n  if (event) {\n    evt = prefix ? prefix + event : event;\n    if (this._events[evt]) clearEvent(this, evt);\n  } else {\n    this._events = new Events();\n    this._eventsCount = 0;\n  }\n\n  return this;\n};\n\n//\n// Alias methods names because people roll like that.\n//\nEventEmitter.prototype.off = EventEmitter.prototype.removeListener;\nEventEmitter.prototype.addListener = EventEmitter.prototype.on;\n\n//\n// Expose the prefix.\n//\nEventEmitter.prefixed = prefix;\n\n//\n// Allow `EventEmitter` to be imported as module namespace.\n//\nEventEmitter.EventEmitter = EventEmitter;\n\n//\n// Expose the module.\n//\nif ('undefined' !== typeof module) {\n  module.exports = EventEmitter;\n}\n","export class TimeoutError extends Error {\n\tconstructor(message) {\n\t\tsuper(message);\n\t\tthis.name = 'TimeoutError';\n\t}\n}\n\n/**\nAn error to be thrown when the request is aborted by AbortController.\nDOMException is thrown instead of this Error when DOMException is available.\n*/\nexport class AbortError extends Error {\n\tconstructor(message) {\n\t\tsuper();\n\t\tthis.name = 'AbortError';\n\t\tthis.message = message;\n\t}\n}\n\n/**\nTODO: Remove AbortError and just throw DOMException when targeting Node 18.\n*/\nconst getDOMException = errorMessage => globalThis.DOMException === undefined ?\n\tnew AbortError(errorMessage) :\n\tnew DOMException(errorMessage);\n\n/**\nTODO: Remove below function and just 'reject(signal.reason)' when targeting Node 18.\n*/\nconst getAbortedReason = signal => {\n\tconst reason = signal.reason === undefined ?\n\t\tgetDOMException('This operation was aborted.') :\n\t\tsignal.reason;\n\n\treturn reason instanceof Error ? reason : getDOMException(reason);\n};\n\nexport default function pTimeout(promise, milliseconds, fallback, options) {\n\tlet timer;\n\n\tconst cancelablePromise = new Promise((resolve, reject) => {\n\t\tif (typeof milliseconds !== 'number' || Math.sign(milliseconds) !== 1) {\n\t\t\tthrow new TypeError(`Expected \\`milliseconds\\` to be a positive number, got \\`${milliseconds}\\``);\n\t\t}\n\n\t\tif (milliseconds === Number.POSITIVE_INFINITY) {\n\t\t\tresolve(promise);\n\t\t\treturn;\n\t\t}\n\n\t\toptions = {\n\t\t\tcustomTimers: {setTimeout, clearTimeout},\n\t\t\t...options\n\t\t};\n\n\t\tif (options.signal) {\n\t\t\tconst {signal} = options;\n\t\t\tif (signal.aborted) {\n\t\t\t\treject(getAbortedReason(signal));\n\t\t\t}\n\n\t\t\tsignal.addEventListener('abort', () => {\n\t\t\t\treject(getAbortedReason(signal));\n\t\t\t});\n\t\t}\n\n\t\ttimer = options.customTimers.setTimeout.call(undefined, () => {\n\t\t\tif (typeof fallback === 'function') {\n\t\t\t\ttry {\n\t\t\t\t\tresolve(fallback());\n\t\t\t\t} catch (error) {\n\t\t\t\t\treject(error);\n\t\t\t\t}\n\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst message = typeof fallback === 'string' ? fallback : `Promise timed out after ${milliseconds} milliseconds`;\n\t\t\tconst timeoutError = fallback instanceof Error ? fallback : new TimeoutError(message);\n\n\t\t\tif (typeof promise.cancel === 'function') {\n\t\t\t\tpromise.cancel();\n\t\t\t}\n\n\t\t\treject(timeoutError);\n\t\t}, milliseconds);\n\n\t\t(async () => {\n\t\t\ttry {\n\t\t\t\tresolve(await promise);\n\t\t\t} catch (error) {\n\t\t\t\treject(error);\n\t\t\t} finally {\n\t\t\t\toptions.customTimers.clearTimeout.call(undefined, timer);\n\t\t\t}\n\t\t})();\n\t});\n\n\tcancelablePromise.clear = () => {\n\t\tclearTimeout(timer);\n\t\ttimer = undefined;\n\t};\n\n\treturn cancelablePromise;\n}\n","// Port of lower_bound from https://en.cppreference.com/w/cpp/algorithm/lower_bound\n// Used to compute insertion index to keep queue sorted after insertion\nexport default function lowerBound(array, value, comparator) {\n    let first = 0;\n    let count = array.length;\n    while (count > 0) {\n        const step = Math.trunc(count / 2);\n        let it = first + step;\n        if (comparator(array[it], value) <= 0) {\n            first = ++it;\n            count -= step + 1;\n        }\n        else {\n            count = step;\n        }\n    }\n    return first;\n}\n","var __classPrivateFieldGet = (this && this.__classPrivateFieldGet) || function (receiver, state, kind, f) {\n    if (kind === \"a\" && !f) throw new TypeError(\"Private accessor was defined without a getter\");\n    if (typeof state === \"function\" ? receiver !== state || !f : !state.has(receiver)) throw new TypeError(\"Cannot read private member from an object whose class did not declare it\");\n    return kind === \"m\" ? f : kind === \"a\" ? f.call(receiver) : f ? f.value : state.get(receiver);\n};\nvar _PriorityQueue_queue;\nimport lowerBound from './lower-bound.js';\nclass PriorityQueue {\n    constructor() {\n        _PriorityQueue_queue.set(this, []);\n    }\n    enqueue(run, options) {\n        options = {\n            priority: 0,\n            ...options,\n        };\n        const element = {\n            priority: options.priority,\n            run,\n        };\n        if (this.size && __classPrivateFieldGet(this, _PriorityQueue_queue, \"f\")[this.size - 1].priority >= options.priority) {\n            __classPrivateFieldGet(this, _PriorityQueue_queue, \"f\").push(element);\n            return;\n        }\n        const index = lowerBound(__classPrivateFieldGet(this, _PriorityQueue_queue, \"f\"), element, (a, b) => b.priority - a.priority);\n        __classPrivateFieldGet(this, _PriorityQueue_queue, \"f\").splice(index, 0, element);\n    }\n    dequeue() {\n        const item = __classPrivateFieldGet(this, _PriorityQueue_queue, \"f\").shift();\n        return item === null || item === void 0 ? void 0 : item.run;\n    }\n    filter(options) {\n        return __classPrivateFieldGet(this, _PriorityQueue_queue, \"f\").filter((element) => element.priority === options.priority).map((element) => element.run);\n    }\n    get size() {\n        return __classPrivateFieldGet(this, _PriorityQueue_queue, \"f\").length;\n    }\n}\n_PriorityQueue_queue = new WeakMap();\nexport default PriorityQueue;\n","var __classPrivateFieldSet = (this && this.__classPrivateFieldSet) || function (receiver, state, value, kind, f) {\n    if (kind === \"m\") throw new TypeError(\"Private method is not writable\");\n    if (kind === \"a\" && !f) throw new TypeError(\"Private accessor was defined without a setter\");\n    if (typeof state === \"function\" ? receiver !== state || !f : !state.has(receiver)) throw new TypeError(\"Cannot write private member to an object whose class did not declare it\");\n    return (kind === \"a\" ? f.call(receiver, value) : f ? f.value = value : state.set(receiver, value)), value;\n};\nvar __classPrivateFieldGet = (this && this.__classPrivateFieldGet) || function (receiver, state, kind, f) {\n    if (kind === \"a\" && !f) throw new TypeError(\"Private accessor was defined without a getter\");\n    if (typeof state === \"function\" ? receiver !== state || !f : !state.has(receiver)) throw new TypeError(\"Cannot read private member from an object whose class did not declare it\");\n    return kind === \"m\" ? f : kind === \"a\" ? f.call(receiver) : f ? f.value : state.get(receiver);\n};\nvar _PQueue_instances, _PQueue_carryoverConcurrencyCount, _PQueue_isIntervalIgnored, _PQueue_intervalCount, _PQueue_intervalCap, _PQueue_interval, _PQueue_intervalEnd, _PQueue_intervalId, _PQueue_timeoutId, _PQueue_queue, _PQueue_queueClass, _PQueue_pending, _PQueue_concurrency, _PQueue_isPaused, _PQueue_throwOnTimeout, _PQueue_doesIntervalAllowAnother_get, _PQueue_doesConcurrentAllowAnother_get, _PQueue_next, _PQueue_onResumeInterval, _PQueue_isIntervalPaused_get, _PQueue_tryToStartAnother, _PQueue_initializeIntervalIfNeeded, _PQueue_onInterval, _PQueue_processQueue, _PQueue_throwOnAbort, _PQueue_onEvent;\nimport { EventEmitter } from 'eventemitter3';\nimport pTimeout, { TimeoutError } from 'p-timeout';\nimport PriorityQueue from './priority-queue.js';\n/**\nThe error thrown by `queue.add()` when a job is aborted before it is run. See `signal`.\n*/\nexport class AbortError extends Error {\n}\n/**\nPromise queue with concurrency control.\n*/\nclass PQueue extends EventEmitter {\n    // TODO: The `throwOnTimeout` option should affect the return types of `add()` and `addAll()`\n    constructor(options) {\n        var _a, _b, _c, _d;\n        super();\n        _PQueue_instances.add(this);\n        _PQueue_carryoverConcurrencyCount.set(this, void 0);\n        _PQueue_isIntervalIgnored.set(this, void 0);\n        _PQueue_intervalCount.set(this, 0);\n        _PQueue_intervalCap.set(this, void 0);\n        _PQueue_interval.set(this, void 0);\n        _PQueue_intervalEnd.set(this, 0);\n        _PQueue_intervalId.set(this, void 0);\n        _PQueue_timeoutId.set(this, void 0);\n        _PQueue_queue.set(this, void 0);\n        _PQueue_queueClass.set(this, void 0);\n        _PQueue_pending.set(this, 0);\n        // The `!` is needed because of https://github.com/microsoft/TypeScript/issues/32194\n        _PQueue_concurrency.set(this, void 0);\n        _PQueue_isPaused.set(this, void 0);\n        _PQueue_throwOnTimeout.set(this, void 0);\n        /**\n        Per-operation timeout in milliseconds. Operations fulfill once `timeout` elapses if they haven't already.\n    \n        Applies to each future operation.\n        */\n        Object.defineProperty(this, \"timeout\", {\n            enumerable: true,\n            configurable: true,\n            writable: true,\n            value: void 0\n        });\n        // eslint-disable-next-line @typescript-eslint/consistent-type-assertions\n        options = {\n            carryoverConcurrencyCount: false,\n            intervalCap: Number.POSITIVE_INFINITY,\n            interval: 0,\n            concurrency: Number.POSITIVE_INFINITY,\n            autoStart: true,\n            queueClass: PriorityQueue,\n            ...options,\n        };\n        if (!(typeof options.intervalCap === 'number' && options.intervalCap >= 1)) {\n            throw new TypeError(`Expected \\`intervalCap\\` to be a number from 1 and up, got \\`${(_b = (_a = options.intervalCap) === null || _a === void 0 ? void 0 : _a.toString()) !== null && _b !== void 0 ? _b : ''}\\` (${typeof options.intervalCap})`);\n        }\n        if (options.interval === undefined || !(Number.isFinite(options.interval) && options.interval >= 0)) {\n            throw new TypeError(`Expected \\`interval\\` to be a finite number >= 0, got \\`${(_d = (_c = options.interval) === null || _c === void 0 ? void 0 : _c.toString()) !== null && _d !== void 0 ? _d : ''}\\` (${typeof options.interval})`);\n        }\n        __classPrivateFieldSet(this, _PQueue_carryoverConcurrencyCount, options.carryoverConcurrencyCount, \"f\");\n        __classPrivateFieldSet(this, _PQueue_isIntervalIgnored, options.intervalCap === Number.POSITIVE_INFINITY || options.interval === 0, \"f\");\n        __classPrivateFieldSet(this, _PQueue_intervalCap, options.intervalCap, \"f\");\n        __classPrivateFieldSet(this, _PQueue_interval, options.interval, \"f\");\n        __classPrivateFieldSet(this, _PQueue_queue, new options.queueClass(), \"f\");\n        __classPrivateFieldSet(this, _PQueue_queueClass, options.queueClass, \"f\");\n        this.concurrency = options.concurrency;\n        this.timeout = options.timeout;\n        __classPrivateFieldSet(this, _PQueue_throwOnTimeout, options.throwOnTimeout === true, \"f\");\n        __classPrivateFieldSet(this, _PQueue_isPaused, options.autoStart === false, \"f\");\n    }\n    get concurrency() {\n        return __classPrivateFieldGet(this, _PQueue_concurrency, \"f\");\n    }\n    set concurrency(newConcurrency) {\n        if (!(typeof newConcurrency === 'number' && newConcurrency >= 1)) {\n            throw new TypeError(`Expected \\`concurrency\\` to be a number from 1 and up, got \\`${newConcurrency}\\` (${typeof newConcurrency})`);\n        }\n        __classPrivateFieldSet(this, _PQueue_concurrency, newConcurrency, \"f\");\n        __classPrivateFieldGet(this, _PQueue_instances, \"m\", _PQueue_processQueue).call(this);\n    }\n    async add(function_, options = {}) {\n        options = {\n            timeout: this.timeout,\n            throwOnTimeout: __classPrivateFieldGet(this, _PQueue_throwOnTimeout, \"f\"),\n            ...options,\n        };\n        return new Promise((resolve, reject) => {\n            __classPrivateFieldGet(this, _PQueue_queue, \"f\").enqueue(async () => {\n                var _a;\n                var _b, _c;\n                __classPrivateFieldSet(this, _PQueue_pending, (_b = __classPrivateFieldGet(this, _PQueue_pending, \"f\"), _b++, _b), \"f\");\n                __classPrivateFieldSet(this, _PQueue_intervalCount, (_c = __classPrivateFieldGet(this, _PQueue_intervalCount, \"f\"), _c++, _c), \"f\");\n                try {\n                    // TODO: Use options.signal?.throwIfAborted() when targeting Node.js 18\n                    if ((_a = options.signal) === null || _a === void 0 ? void 0 : _a.aborted) {\n                        // TODO: Use ABORT_ERR code when targeting Node.js 16 (https://nodejs.org/docs/latest-v16.x/api/errors.html#abort_err)\n                        throw new AbortError('The task was aborted.');\n                    }\n                    let operation = function_({ signal: options.signal });\n                    if (options.timeout) {\n                        operation = pTimeout(Promise.resolve(operation), options.timeout);\n                    }\n                    if (options.signal) {\n                        operation = Promise.race([operation, __classPrivateFieldGet(this, _PQueue_instances, \"m\", _PQueue_throwOnAbort).call(this, options.signal)]);\n                    }\n                    const result = await operation;\n                    resolve(result);\n                    this.emit('completed', result);\n                }\n                catch (error) {\n                    if (error instanceof TimeoutError && !options.throwOnTimeout) {\n                        resolve();\n                        return;\n                    }\n                    reject(error);\n                    this.emit('error', error);\n                }\n                finally {\n                    __classPrivateFieldGet(this, _PQueue_instances, \"m\", _PQueue_next).call(this);\n                }\n            }, options);\n            this.emit('add');\n            __classPrivateFieldGet(this, _PQueue_instances, \"m\", _PQueue_tryToStartAnother).call(this);\n        });\n    }\n    async addAll(functions, options) {\n        return Promise.all(functions.map(async (function_) => this.add(function_, options)));\n    }\n    /**\n    Start (or resume) executing enqueued tasks within concurrency limit. No need to call this if queue is not paused (via `options.autoStart = false` or by `.pause()` method.)\n    */\n    start() {\n        if (!__classPrivateFieldGet(this, _PQueue_isPaused, \"f\")) {\n            return this;\n        }\n        __classPrivateFieldSet(this, _PQueue_isPaused, false, \"f\");\n        __classPrivateFieldGet(this, _PQueue_instances, \"m\", _PQueue_processQueue).call(this);\n        return this;\n    }\n    /**\n    Put queue execution on hold.\n    */\n    pause() {\n        __classPrivateFieldSet(this, _PQueue_isPaused, true, \"f\");\n    }\n    /**\n    Clear the queue.\n    */\n    clear() {\n        __classPrivateFieldSet(this, _PQueue_queue, new (__classPrivateFieldGet(this, _PQueue_queueClass, \"f\"))(), \"f\");\n    }\n    /**\n    Can be called multiple times. Useful if you for example add additional items at a later time.\n\n    @returns A promise that settles when the queue becomes empty.\n    */\n    async onEmpty() {\n        // Instantly resolve if the queue is empty\n        if (__classPrivateFieldGet(this, _PQueue_queue, \"f\").size === 0) {\n            return;\n        }\n        await __classPrivateFieldGet(this, _PQueue_instances, \"m\", _PQueue_onEvent).call(this, 'empty');\n    }\n    /**\n    @returns A promise that settles when the queue size is less than the given limit: `queue.size < limit`.\n\n    If you want to avoid having the queue grow beyond a certain size you can `await queue.onSizeLessThan()` before adding a new item.\n\n    Note that this only limits the number of items waiting to start. There could still be up to `concurrency` jobs already running that this call does not include in its calculation.\n    */\n    async onSizeLessThan(limit) {\n        // Instantly resolve if the queue is empty.\n        if (__classPrivateFieldGet(this, _PQueue_queue, \"f\").size < limit) {\n            return;\n        }\n        await __classPrivateFieldGet(this, _PQueue_instances, \"m\", _PQueue_onEvent).call(this, 'next', () => __classPrivateFieldGet(this, _PQueue_queue, \"f\").size < limit);\n    }\n    /**\n    The difference with `.onEmpty` is that `.onIdle` guarantees that all work from the queue has finished. `.onEmpty` merely signals that the queue is empty, but it could mean that some promises haven't completed yet.\n\n    @returns A promise that settles when the queue becomes empty, and all promises have completed; `queue.size === 0 && queue.pending === 0`.\n    */\n    async onIdle() {\n        // Instantly resolve if none pending and if nothing else is queued\n        if (__classPrivateFieldGet(this, _PQueue_pending, \"f\") === 0 && __classPrivateFieldGet(this, _PQueue_queue, \"f\").size === 0) {\n            return;\n        }\n        await __classPrivateFieldGet(this, _PQueue_instances, \"m\", _PQueue_onEvent).call(this, 'idle');\n    }\n    /**\n    Size of the queue, the number of queued items waiting to run.\n    */\n    get size() {\n        return __classPrivateFieldGet(this, _PQueue_queue, \"f\").size;\n    }\n    /**\n    Size of the queue, filtered by the given options.\n\n    For example, this can be used to find the number of items remaining in the queue with a specific priority level.\n    */\n    sizeBy(options) {\n        // eslint-disable-next-line unicorn/no-array-callback-reference\n        return __classPrivateFieldGet(this, _PQueue_queue, \"f\").filter(options).length;\n    }\n    /**\n    Number of running items (no longer in the queue).\n    */\n    get pending() {\n        return __classPrivateFieldGet(this, _PQueue_pending, \"f\");\n    }\n    /**\n    Whether the queue is currently paused.\n    */\n    get isPaused() {\n        return __classPrivateFieldGet(this, _PQueue_isPaused, \"f\");\n    }\n}\n_PQueue_carryoverConcurrencyCount = new WeakMap(), _PQueue_isIntervalIgnored = new WeakMap(), _PQueue_intervalCount = new WeakMap(), _PQueue_intervalCap = new WeakMap(), _PQueue_interval = new WeakMap(), _PQueue_intervalEnd = new WeakMap(), _PQueue_intervalId = new WeakMap(), _PQueue_timeoutId = new WeakMap(), _PQueue_queue = new WeakMap(), _PQueue_queueClass = new WeakMap(), _PQueue_pending = new WeakMap(), _PQueue_concurrency = new WeakMap(), _PQueue_isPaused = new WeakMap(), _PQueue_throwOnTimeout = new WeakMap(), _PQueue_instances = new WeakSet(), _PQueue_doesIntervalAllowAnother_get = function _PQueue_doesIntervalAllowAnother_get() {\n    return __classPrivateFieldGet(this, _PQueue_isIntervalIgnored, \"f\") || __classPrivateFieldGet(this, _PQueue_intervalCount, \"f\") < __classPrivateFieldGet(this, _PQueue_intervalCap, \"f\");\n}, _PQueue_doesConcurrentAllowAnother_get = function _PQueue_doesConcurrentAllowAnother_get() {\n    return __classPrivateFieldGet(this, _PQueue_pending, \"f\") < __classPrivateFieldGet(this, _PQueue_concurrency, \"f\");\n}, _PQueue_next = function _PQueue_next() {\n    var _a;\n    __classPrivateFieldSet(this, _PQueue_pending, (_a = __classPrivateFieldGet(this, _PQueue_pending, \"f\"), _a--, _a), \"f\");\n    __classPrivateFieldGet(this, _PQueue_instances, \"m\", _PQueue_tryToStartAnother).call(this);\n    this.emit('next');\n}, _PQueue_onResumeInterval = function _PQueue_onResumeInterval() {\n    __classPrivateFieldGet(this, _PQueue_instances, \"m\", _PQueue_onInterval).call(this);\n    __classPrivateFieldGet(this, _PQueue_instances, \"m\", _PQueue_initializeIntervalIfNeeded).call(this);\n    __classPrivateFieldSet(this, _PQueue_timeoutId, undefined, \"f\");\n}, _PQueue_isIntervalPaused_get = function _PQueue_isIntervalPaused_get() {\n    const now = Date.now();\n    if (__classPrivateFieldGet(this, _PQueue_intervalId, \"f\") === undefined) {\n        const delay = __classPrivateFieldGet(this, _PQueue_intervalEnd, \"f\") - now;\n        if (delay < 0) {\n            // Act as the interval was done\n            // We don't need to resume it here because it will be resumed on line 160\n            __classPrivateFieldSet(this, _PQueue_intervalCount, (__classPrivateFieldGet(this, _PQueue_carryoverConcurrencyCount, \"f\")) ? __classPrivateFieldGet(this, _PQueue_pending, \"f\") : 0, \"f\");\n        }\n        else {\n            // Act as the interval is pending\n            if (__classPrivateFieldGet(this, _PQueue_timeoutId, \"f\") === undefined) {\n                __classPrivateFieldSet(this, _PQueue_timeoutId, setTimeout(() => {\n                    __classPrivateFieldGet(this, _PQueue_instances, \"m\", _PQueue_onResumeInterval).call(this);\n                }, delay), \"f\");\n            }\n            return true;\n        }\n    }\n    return false;\n}, _PQueue_tryToStartAnother = function _PQueue_tryToStartAnother() {\n    if (__classPrivateFieldGet(this, _PQueue_queue, \"f\").size === 0) {\n        // We can clear the interval (\"pause\")\n        // Because we can redo it later (\"resume\")\n        if (__classPrivateFieldGet(this, _PQueue_intervalId, \"f\")) {\n            clearInterval(__classPrivateFieldGet(this, _PQueue_intervalId, \"f\"));\n        }\n        __classPrivateFieldSet(this, _PQueue_intervalId, undefined, \"f\");\n        this.emit('empty');\n        if (__classPrivateFieldGet(this, _PQueue_pending, \"f\") === 0) {\n            this.emit('idle');\n        }\n        return false;\n    }\n    if (!__classPrivateFieldGet(this, _PQueue_isPaused, \"f\")) {\n        const canInitializeInterval = !__classPrivateFieldGet(this, _PQueue_instances, \"a\", _PQueue_isIntervalPaused_get);\n        if (__classPrivateFieldGet(this, _PQueue_instances, \"a\", _PQueue_doesIntervalAllowAnother_get) && __classPrivateFieldGet(this, _PQueue_instances, \"a\", _PQueue_doesConcurrentAllowAnother_get)) {\n            const job = __classPrivateFieldGet(this, _PQueue_queue, \"f\").dequeue();\n            if (!job) {\n                return false;\n            }\n            this.emit('active');\n            job();\n            if (canInitializeInterval) {\n                __classPrivateFieldGet(this, _PQueue_instances, \"m\", _PQueue_initializeIntervalIfNeeded).call(this);\n            }\n            return true;\n        }\n    }\n    return false;\n}, _PQueue_initializeIntervalIfNeeded = function _PQueue_initializeIntervalIfNeeded() {\n    if (__classPrivateFieldGet(this, _PQueue_isIntervalIgnored, \"f\") || __classPrivateFieldGet(this, _PQueue_intervalId, \"f\") !== undefined) {\n        return;\n    }\n    __classPrivateFieldSet(this, _PQueue_intervalId, setInterval(() => {\n        __classPrivateFieldGet(this, _PQueue_instances, \"m\", _PQueue_onInterval).call(this);\n    }, __classPrivateFieldGet(this, _PQueue_interval, \"f\")), \"f\");\n    __classPrivateFieldSet(this, _PQueue_intervalEnd, Date.now() + __classPrivateFieldGet(this, _PQueue_interval, \"f\"), \"f\");\n}, _PQueue_onInterval = function _PQueue_onInterval() {\n    if (__classPrivateFieldGet(this, _PQueue_intervalCount, \"f\") === 0 && __classPrivateFieldGet(this, _PQueue_pending, \"f\") === 0 && __classPrivateFieldGet(this, _PQueue_intervalId, \"f\")) {\n        clearInterval(__classPrivateFieldGet(this, _PQueue_intervalId, \"f\"));\n        __classPrivateFieldSet(this, _PQueue_intervalId, undefined, \"f\");\n    }\n    __classPrivateFieldSet(this, _PQueue_intervalCount, __classPrivateFieldGet(this, _PQueue_carryoverConcurrencyCount, \"f\") ? __classPrivateFieldGet(this, _PQueue_pending, \"f\") : 0, \"f\");\n    __classPrivateFieldGet(this, _PQueue_instances, \"m\", _PQueue_processQueue).call(this);\n}, _PQueue_processQueue = function _PQueue_processQueue() {\n    // eslint-disable-next-line no-empty\n    while (__classPrivateFieldGet(this, _PQueue_instances, \"m\", _PQueue_tryToStartAnother).call(this)) { }\n}, _PQueue_throwOnAbort = async function _PQueue_throwOnAbort(signal) {\n    return new Promise((_resolve, reject) => {\n        signal.addEventListener('abort', () => {\n            // TODO: Reject with signal.throwIfAborted() when targeting Node.js 18\n            // TODO: Use ABORT_ERR code when targeting Node.js 16 (https://nodejs.org/docs/latest-v16.x/api/errors.html#abort_err)\n            reject(new AbortError('The task was aborted.'));\n        }, { once: true });\n    });\n}, _PQueue_onEvent = async function _PQueue_onEvent(event, filter) {\n    return new Promise(resolve => {\n        const listener = () => {\n            if (filter && !filter()) {\n                return;\n            }\n            this.off(event, listener);\n            resolve();\n        };\n        this.on(event, listener);\n    });\n};\nexport default PQueue;\n","module.exports = function dedent(templateStrings) {\r\n    var values = [];\r\n    for (var _i = 1; _i < arguments.length; _i++) {\r\n        values[_i - 1] = arguments[_i];\r\n    }\r\n    var matches = [];\r\n    var strings = typeof templateStrings === 'string' ? [templateStrings] : templateStrings.slice();\r\n    // 1. Remove trailing whitespace.\r\n    strings[strings.length - 1] = strings[strings.length - 1].replace(/\\r?\\n([\\t ]*)$/, '');\r\n    // 2. Find all line breaks to determine the highest common indentation level.\r\n    for (var i = 0; i < strings.length; i++) {\r\n        var match = void 0;\r\n        if (match = strings[i].match(/\\n[\\t ]+/g)) {\r\n            matches.push.apply(matches, match);\r\n        }\r\n    }\r\n    // 3. Remove the common indentation from all strings.\r\n    if (matches.length) {\r\n        var size = Math.min.apply(Math, matches.map(function (value) { return value.length - 1; }));\r\n        var pattern = new RegExp(\"\\n[\\t ]{\" + size + \"}\", 'g');\r\n        for (var i = 0; i < strings.length; i++) {\r\n            strings[i] = strings[i].replace(pattern, '\\n');\r\n        }\r\n    }\r\n    // 4. Remove leading whitespace.\r\n    strings[0] = strings[0].replace(/^\\r?\\n/, '');\r\n    // 5. Perform interpolation.\r\n    var string = strings[0];\r\n    for (var i = 0; i < values.length; i++) {\r\n        string += values[i] + strings[i + 1];\r\n    }\r\n    return string;\r\n};\r\n//# sourceMappingURL=index.js.map","// DEFLATE is a complex format; to read this code, you should probably check the RFC first:\n// https://tools.ietf.org/html/rfc1951\n// You may also wish to take a look at the guide I made about this program:\n// https://gist.github.com/101arrowz/253f31eb5abc3d9275ab943003ffecad\n// Some of the following code is similar to that of UZIP.js:\n// https://github.com/photopea/UZIP.js\n// However, the vast majority of the codebase has diverged from UZIP.js to increase performance and reduce bundle size.\n// Sometimes 0 will appear where -1 would be more appropriate. This is because using a uint\n// is better for memory in most engines (I *think*).\nvar ch2 = {};\nvar wk = (function (c, id, msg, transfer, cb) {\n    var w = new Worker(ch2[id] || (ch2[id] = URL.createObjectURL(new Blob([\n        c + ';addEventListener(\"error\",function(e){e=e.error;postMessage({$e$:[e.message,e.code,e.stack]})})'\n    ], { type: 'text/javascript' }))));\n    w.onmessage = function (e) {\n        var d = e.data, ed = d.$e$;\n        if (ed) {\n            var err = new Error(ed[0]);\n            err['code'] = ed[1];\n            err.stack = ed[2];\n            cb(err, null);\n        }\n        else\n            cb(null, d);\n    };\n    w.postMessage(msg, transfer);\n    return w;\n});\n\n// aliases for shorter compressed code (most minifers don't do this)\nvar u8 = Uint8Array, u16 = Uint16Array, i32 = Int32Array;\n// fixed length extra bits\nvar fleb = new u8([0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 2, 2, 2, 2, 3, 3, 3, 3, 4, 4, 4, 4, 5, 5, 5, 5, 0, /* unused */ 0, 0, /* impossible */ 0]);\n// fixed distance extra bits\nvar fdeb = new u8([0, 0, 0, 0, 1, 1, 2, 2, 3, 3, 4, 4, 5, 5, 6, 6, 7, 7, 8, 8, 9, 9, 10, 10, 11, 11, 12, 12, 13, 13, /* unused */ 0, 0]);\n// code length index map\nvar clim = new u8([16, 17, 18, 0, 8, 7, 9, 6, 10, 5, 11, 4, 12, 3, 13, 2, 14, 1, 15]);\n// get base, reverse index map from extra bits\nvar freb = function (eb, start) {\n    var b = new u16(31);\n    for (var i = 0; i < 31; ++i) {\n        b[i] = start += 1 << eb[i - 1];\n    }\n    // numbers here are at max 18 bits\n    var r = new i32(b[30]);\n    for (var i = 1; i < 30; ++i) {\n        for (var j = b[i]; j < b[i + 1]; ++j) {\n            r[j] = ((j - b[i]) << 5) | i;\n        }\n    }\n    return { b: b, r: r };\n};\nvar _a = freb(fleb, 2), fl = _a.b, revfl = _a.r;\n// we can ignore the fact that the other numbers are wrong; they never happen anyway\nfl[28] = 258, revfl[258] = 28;\nvar _b = freb(fdeb, 0), fd = _b.b, revfd = _b.r;\n// map of value to reverse (assuming 16 bits)\nvar rev = new u16(32768);\nfor (var i = 0; i < 32768; ++i) {\n    // reverse table algorithm from SO\n    var x = ((i & 0xAAAA) >> 1) | ((i & 0x5555) << 1);\n    x = ((x & 0xCCCC) >> 2) | ((x & 0x3333) << 2);\n    x = ((x & 0xF0F0) >> 4) | ((x & 0x0F0F) << 4);\n    rev[i] = (((x & 0xFF00) >> 8) | ((x & 0x00FF) << 8)) >> 1;\n}\n// create huffman tree from u8 \"map\": index -> code length for code index\n// mb (max bits) must be at most 15\n// TODO: optimize/split up?\nvar hMap = (function (cd, mb, r) {\n    var s = cd.length;\n    // index\n    var i = 0;\n    // u16 \"map\": index -> # of codes with bit length = index\n    var l = new u16(mb);\n    // length of cd must be 288 (total # of codes)\n    for (; i < s; ++i) {\n        if (cd[i])\n            ++l[cd[i] - 1];\n    }\n    // u16 \"map\": index -> minimum code for bit length = index\n    var le = new u16(mb);\n    for (i = 1; i < mb; ++i) {\n        le[i] = (le[i - 1] + l[i - 1]) << 1;\n    }\n    var co;\n    if (r) {\n        // u16 \"map\": index -> number of actual bits, symbol for code\n        co = new u16(1 << mb);\n        // bits to remove for reverser\n        var rvb = 15 - mb;\n        for (i = 0; i < s; ++i) {\n            // ignore 0 lengths\n            if (cd[i]) {\n                // num encoding both symbol and bits read\n                var sv = (i << 4) | cd[i];\n                // free bits\n                var r_1 = mb - cd[i];\n                // start value\n                var v = le[cd[i] - 1]++ << r_1;\n                // m is end value\n                for (var m = v | ((1 << r_1) - 1); v <= m; ++v) {\n                    // every 16 bit value starting with the code yields the same result\n                    co[rev[v] >> rvb] = sv;\n                }\n            }\n        }\n    }\n    else {\n        co = new u16(s);\n        for (i = 0; i < s; ++i) {\n            if (cd[i]) {\n                co[i] = rev[le[cd[i] - 1]++] >> (15 - cd[i]);\n            }\n        }\n    }\n    return co;\n});\n// fixed length tree\nvar flt = new u8(288);\nfor (var i = 0; i < 144; ++i)\n    flt[i] = 8;\nfor (var i = 144; i < 256; ++i)\n    flt[i] = 9;\nfor (var i = 256; i < 280; ++i)\n    flt[i] = 7;\nfor (var i = 280; i < 288; ++i)\n    flt[i] = 8;\n// fixed distance tree\nvar fdt = new u8(32);\nfor (var i = 0; i < 32; ++i)\n    fdt[i] = 5;\n// fixed length map\nvar flm = /*#__PURE__*/ hMap(flt, 9, 0), flrm = /*#__PURE__*/ hMap(flt, 9, 1);\n// fixed distance map\nvar fdm = /*#__PURE__*/ hMap(fdt, 5, 0), fdrm = /*#__PURE__*/ hMap(fdt, 5, 1);\n// find max of array\nvar max = function (a) {\n    var m = a[0];\n    for (var i = 1; i < a.length; ++i) {\n        if (a[i] > m)\n            m = a[i];\n    }\n    return m;\n};\n// read d, starting at bit p and mask with m\nvar bits = function (d, p, m) {\n    var o = (p / 8) | 0;\n    return ((d[o] | (d[o + 1] << 8)) >> (p & 7)) & m;\n};\n// read d, starting at bit p continuing for at least 16 bits\nvar bits16 = function (d, p) {\n    var o = (p / 8) | 0;\n    return ((d[o] | (d[o + 1] << 8) | (d[o + 2] << 16)) >> (p & 7));\n};\n// get end of byte\nvar shft = function (p) { return ((p + 7) / 8) | 0; };\n// typed array slice - allows garbage collector to free original reference,\n// while being more compatible than .slice\nvar slc = function (v, s, e) {\n    if (s == null || s < 0)\n        s = 0;\n    if (e == null || e > v.length)\n        e = v.length;\n    // can't use .constructor in case user-supplied\n    return new u8(v.subarray(s, e));\n};\n/**\n * Codes for errors generated within this library\n */\nexport var FlateErrorCode = {\n    UnexpectedEOF: 0,\n    InvalidBlockType: 1,\n    InvalidLengthLiteral: 2,\n    InvalidDistance: 3,\n    StreamFinished: 4,\n    NoStreamHandler: 5,\n    InvalidHeader: 6,\n    NoCallback: 7,\n    InvalidUTF8: 8,\n    ExtraFieldTooLong: 9,\n    InvalidDate: 10,\n    FilenameTooLong: 11,\n    StreamFinishing: 12,\n    InvalidZipData: 13,\n    UnknownCompressionMethod: 14\n};\n// error codes\nvar ec = [\n    'unexpected EOF',\n    'invalid block type',\n    'invalid length/literal',\n    'invalid distance',\n    'stream finished',\n    'no stream handler',\n    ,\n    'no callback',\n    'invalid UTF-8 data',\n    'extra field too long',\n    'date not in range 1980-2099',\n    'filename too long',\n    'stream finishing',\n    'invalid zip data'\n    // determined by unknown compression method\n];\n;\nvar err = function (ind, msg, nt) {\n    var e = new Error(msg || ec[ind]);\n    e.code = ind;\n    if (Error.captureStackTrace)\n        Error.captureStackTrace(e, err);\n    if (!nt)\n        throw e;\n    return e;\n};\n// expands raw DEFLATE data\nvar inflt = function (dat, st, buf, dict) {\n    // source length       dict length\n    var sl = dat.length, dl = dict ? dict.length : 0;\n    if (!sl || st.f && !st.l)\n        return buf || new u8(0);\n    var noBuf = !buf;\n    // have to estimate size\n    var resize = noBuf || st.i != 2;\n    // no state\n    var noSt = st.i;\n    // Assumes roughly 33% compression ratio average\n    if (noBuf)\n        buf = new u8(sl * 3);\n    // ensure buffer can fit at least l elements\n    var cbuf = function (l) {\n        var bl = buf.length;\n        // need to increase size to fit\n        if (l > bl) {\n            // Double or set to necessary, whichever is greater\n            var nbuf = new u8(Math.max(bl * 2, l));\n            nbuf.set(buf);\n            buf = nbuf;\n        }\n    };\n    //  last chunk         bitpos           bytes\n    var final = st.f || 0, pos = st.p || 0, bt = st.b || 0, lm = st.l, dm = st.d, lbt = st.m, dbt = st.n;\n    // total bits\n    var tbts = sl * 8;\n    do {\n        if (!lm) {\n            // BFINAL - this is only 1 when last chunk is next\n            final = bits(dat, pos, 1);\n            // type: 0 = no compression, 1 = fixed huffman, 2 = dynamic huffman\n            var type = bits(dat, pos + 1, 3);\n            pos += 3;\n            if (!type) {\n                // go to end of byte boundary\n                var s = shft(pos) + 4, l = dat[s - 4] | (dat[s - 3] << 8), t = s + l;\n                if (t > sl) {\n                    if (noSt)\n                        err(0);\n                    break;\n                }\n                // ensure size\n                if (resize)\n                    cbuf(bt + l);\n                // Copy over uncompressed data\n                buf.set(dat.subarray(s, t), bt);\n                // Get new bitpos, update byte count\n                st.b = bt += l, st.p = pos = t * 8, st.f = final;\n                continue;\n            }\n            else if (type == 1)\n                lm = flrm, dm = fdrm, lbt = 9, dbt = 5;\n            else if (type == 2) {\n                //  literal                            lengths\n                var hLit = bits(dat, pos, 31) + 257, hcLen = bits(dat, pos + 10, 15) + 4;\n                var tl = hLit + bits(dat, pos + 5, 31) + 1;\n                pos += 14;\n                // length+distance tree\n                var ldt = new u8(tl);\n                // code length tree\n                var clt = new u8(19);\n                for (var i = 0; i < hcLen; ++i) {\n                    // use index map to get real code\n                    clt[clim[i]] = bits(dat, pos + i * 3, 7);\n                }\n                pos += hcLen * 3;\n                // code lengths bits\n                var clb = max(clt), clbmsk = (1 << clb) - 1;\n                // code lengths map\n                var clm = hMap(clt, clb, 1);\n                for (var i = 0; i < tl;) {\n                    var r = clm[bits(dat, pos, clbmsk)];\n                    // bits read\n                    pos += r & 15;\n                    // symbol\n                    var s = r >> 4;\n                    // code length to copy\n                    if (s < 16) {\n                        ldt[i++] = s;\n                    }\n                    else {\n                        //  copy   count\n                        var c = 0, n = 0;\n                        if (s == 16)\n                            n = 3 + bits(dat, pos, 3), pos += 2, c = ldt[i - 1];\n                        else if (s == 17)\n                            n = 3 + bits(dat, pos, 7), pos += 3;\n                        else if (s == 18)\n                            n = 11 + bits(dat, pos, 127), pos += 7;\n                        while (n--)\n                            ldt[i++] = c;\n                    }\n                }\n                //    length tree                 distance tree\n                var lt = ldt.subarray(0, hLit), dt = ldt.subarray(hLit);\n                // max length bits\n                lbt = max(lt);\n                // max dist bits\n                dbt = max(dt);\n                lm = hMap(lt, lbt, 1);\n                dm = hMap(dt, dbt, 1);\n            }\n            else\n                err(1);\n            if (pos > tbts) {\n                if (noSt)\n                    err(0);\n                break;\n            }\n        }\n        // Make sure the buffer can hold this + the largest possible addition\n        // Maximum chunk size (practically, theoretically infinite) is 2^17\n        if (resize)\n            cbuf(bt + 131072);\n        var lms = (1 << lbt) - 1, dms = (1 << dbt) - 1;\n        var lpos = pos;\n        for (;; lpos = pos) {\n            // bits read, code\n            var c = lm[bits16(dat, pos) & lms], sym = c >> 4;\n            pos += c & 15;\n            if (pos > tbts) {\n                if (noSt)\n                    err(0);\n                break;\n            }\n            if (!c)\n                err(2);\n            if (sym < 256)\n                buf[bt++] = sym;\n            else if (sym == 256) {\n                lpos = pos, lm = null;\n                break;\n            }\n            else {\n                var add = sym - 254;\n                // no extra bits needed if less\n                if (sym > 264) {\n                    // index\n                    var i = sym - 257, b = fleb[i];\n                    add = bits(dat, pos, (1 << b) - 1) + fl[i];\n                    pos += b;\n                }\n                // dist\n                var d = dm[bits16(dat, pos) & dms], dsym = d >> 4;\n                if (!d)\n                    err(3);\n                pos += d & 15;\n                var dt = fd[dsym];\n                if (dsym > 3) {\n                    var b = fdeb[dsym];\n                    dt += bits16(dat, pos) & (1 << b) - 1, pos += b;\n                }\n                if (pos > tbts) {\n                    if (noSt)\n                        err(0);\n                    break;\n                }\n                if (resize)\n                    cbuf(bt + 131072);\n                var end = bt + add;\n                if (bt < dt) {\n                    var shift = dl - dt, dend = Math.min(dt, end);\n                    if (shift + bt < 0)\n                        err(3);\n                    for (; bt < dend; ++bt)\n                        buf[bt] = dict[shift + bt];\n                }\n                for (; bt < end; ++bt)\n                    buf[bt] = buf[bt - dt];\n            }\n        }\n        st.l = lm, st.p = lpos, st.b = bt, st.f = final;\n        if (lm)\n            final = 1, st.m = lbt, st.d = dm, st.n = dbt;\n    } while (!final);\n    // don't reallocate for streams or user buffers\n    return bt != buf.length && noBuf ? slc(buf, 0, bt) : buf.subarray(0, bt);\n};\n// starting at p, write the minimum number of bits that can hold v to d\nvar wbits = function (d, p, v) {\n    v <<= p & 7;\n    var o = (p / 8) | 0;\n    d[o] |= v;\n    d[o + 1] |= v >> 8;\n};\n// starting at p, write the minimum number of bits (>8) that can hold v to d\nvar wbits16 = function (d, p, v) {\n    v <<= p & 7;\n    var o = (p / 8) | 0;\n    d[o] |= v;\n    d[o + 1] |= v >> 8;\n    d[o + 2] |= v >> 16;\n};\n// creates code lengths from a frequency table\nvar hTree = function (d, mb) {\n    // Need extra info to make a tree\n    var t = [];\n    for (var i = 0; i < d.length; ++i) {\n        if (d[i])\n            t.push({ s: i, f: d[i] });\n    }\n    var s = t.length;\n    var t2 = t.slice();\n    if (!s)\n        return { t: et, l: 0 };\n    if (s == 1) {\n        var v = new u8(t[0].s + 1);\n        v[t[0].s] = 1;\n        return { t: v, l: 1 };\n    }\n    t.sort(function (a, b) { return a.f - b.f; });\n    // after i2 reaches last ind, will be stopped\n    // freq must be greater than largest possible number of symbols\n    t.push({ s: -1, f: 25001 });\n    var l = t[0], r = t[1], i0 = 0, i1 = 1, i2 = 2;\n    t[0] = { s: -1, f: l.f + r.f, l: l, r: r };\n    // efficient algorithm from UZIP.js\n    // i0 is lookbehind, i2 is lookahead - after processing two low-freq\n    // symbols that combined have high freq, will start processing i2 (high-freq,\n    // non-composite) symbols instead\n    // see https://reddit.com/r/photopea/comments/ikekht/uzipjs_questions/\n    while (i1 != s - 1) {\n        l = t[t[i0].f < t[i2].f ? i0++ : i2++];\n        r = t[i0 != i1 && t[i0].f < t[i2].f ? i0++ : i2++];\n        t[i1++] = { s: -1, f: l.f + r.f, l: l, r: r };\n    }\n    var maxSym = t2[0].s;\n    for (var i = 1; i < s; ++i) {\n        if (t2[i].s > maxSym)\n            maxSym = t2[i].s;\n    }\n    // code lengths\n    var tr = new u16(maxSym + 1);\n    // max bits in tree\n    var mbt = ln(t[i1 - 1], tr, 0);\n    if (mbt > mb) {\n        // more algorithms from UZIP.js\n        // TODO: find out how this code works (debt)\n        //  ind    debt\n        var i = 0, dt = 0;\n        //    left            cost\n        var lft = mbt - mb, cst = 1 << lft;\n        t2.sort(function (a, b) { return tr[b.s] - tr[a.s] || a.f - b.f; });\n        for (; i < s; ++i) {\n            var i2_1 = t2[i].s;\n            if (tr[i2_1] > mb) {\n                dt += cst - (1 << (mbt - tr[i2_1]));\n                tr[i2_1] = mb;\n            }\n            else\n                break;\n        }\n        dt >>= lft;\n        while (dt > 0) {\n            var i2_2 = t2[i].s;\n            if (tr[i2_2] < mb)\n                dt -= 1 << (mb - tr[i2_2]++ - 1);\n            else\n                ++i;\n        }\n        for (; i >= 0 && dt; --i) {\n            var i2_3 = t2[i].s;\n            if (tr[i2_3] == mb) {\n                --tr[i2_3];\n                ++dt;\n            }\n        }\n        mbt = mb;\n    }\n    return { t: new u8(tr), l: mbt };\n};\n// get the max length and assign length codes\nvar ln = function (n, l, d) {\n    return n.s == -1\n        ? Math.max(ln(n.l, l, d + 1), ln(n.r, l, d + 1))\n        : (l[n.s] = d);\n};\n// length codes generation\nvar lc = function (c) {\n    var s = c.length;\n    // Note that the semicolon was intentional\n    while (s && !c[--s])\n        ;\n    var cl = new u16(++s);\n    //  ind      num         streak\n    var cli = 0, cln = c[0], cls = 1;\n    var w = function (v) { cl[cli++] = v; };\n    for (var i = 1; i <= s; ++i) {\n        if (c[i] == cln && i != s)\n            ++cls;\n        else {\n            if (!cln && cls > 2) {\n                for (; cls > 138; cls -= 138)\n                    w(32754);\n                if (cls > 2) {\n                    w(cls > 10 ? ((cls - 11) << 5) | 28690 : ((cls - 3) << 5) | 12305);\n                    cls = 0;\n                }\n            }\n            else if (cls > 3) {\n                w(cln), --cls;\n                for (; cls > 6; cls -= 6)\n                    w(8304);\n                if (cls > 2)\n                    w(((cls - 3) << 5) | 8208), cls = 0;\n            }\n            while (cls--)\n                w(cln);\n            cls = 1;\n            cln = c[i];\n        }\n    }\n    return { c: cl.subarray(0, cli), n: s };\n};\n// calculate the length of output from tree, code lengths\nvar clen = function (cf, cl) {\n    var l = 0;\n    for (var i = 0; i < cl.length; ++i)\n        l += cf[i] * cl[i];\n    return l;\n};\n// writes a fixed block\n// returns the new bit pos\nvar wfblk = function (out, pos, dat) {\n    // no need to write 00 as type: TypedArray defaults to 0\n    var s = dat.length;\n    var o = shft(pos + 2);\n    out[o] = s & 255;\n    out[o + 1] = s >> 8;\n    out[o + 2] = out[o] ^ 255;\n    out[o + 3] = out[o + 1] ^ 255;\n    for (var i = 0; i < s; ++i)\n        out[o + i + 4] = dat[i];\n    return (o + 4 + s) * 8;\n};\n// writes a block\nvar wblk = function (dat, out, final, syms, lf, df, eb, li, bs, bl, p) {\n    wbits(out, p++, final);\n    ++lf[256];\n    var _a = hTree(lf, 15), dlt = _a.t, mlb = _a.l;\n    var _b = hTree(df, 15), ddt = _b.t, mdb = _b.l;\n    var _c = lc(dlt), lclt = _c.c, nlc = _c.n;\n    var _d = lc(ddt), lcdt = _d.c, ndc = _d.n;\n    var lcfreq = new u16(19);\n    for (var i = 0; i < lclt.length; ++i)\n        ++lcfreq[lclt[i] & 31];\n    for (var i = 0; i < lcdt.length; ++i)\n        ++lcfreq[lcdt[i] & 31];\n    var _e = hTree(lcfreq, 7), lct = _e.t, mlcb = _e.l;\n    var nlcc = 19;\n    for (; nlcc > 4 && !lct[clim[nlcc - 1]]; --nlcc)\n        ;\n    var flen = (bl + 5) << 3;\n    var ftlen = clen(lf, flt) + clen(df, fdt) + eb;\n    var dtlen = clen(lf, dlt) + clen(df, ddt) + eb + 14 + 3 * nlcc + clen(lcfreq, lct) + 2 * lcfreq[16] + 3 * lcfreq[17] + 7 * lcfreq[18];\n    if (bs >= 0 && flen <= ftlen && flen <= dtlen)\n        return wfblk(out, p, dat.subarray(bs, bs + bl));\n    var lm, ll, dm, dl;\n    wbits(out, p, 1 + (dtlen < ftlen)), p += 2;\n    if (dtlen < ftlen) {\n        lm = hMap(dlt, mlb, 0), ll = dlt, dm = hMap(ddt, mdb, 0), dl = ddt;\n        var llm = hMap(lct, mlcb, 0);\n        wbits(out, p, nlc - 257);\n        wbits(out, p + 5, ndc - 1);\n        wbits(out, p + 10, nlcc - 4);\n        p += 14;\n        for (var i = 0; i < nlcc; ++i)\n            wbits(out, p + 3 * i, lct[clim[i]]);\n        p += 3 * nlcc;\n        var lcts = [lclt, lcdt];\n        for (var it = 0; it < 2; ++it) {\n            var clct = lcts[it];\n            for (var i = 0; i < clct.length; ++i) {\n                var len = clct[i] & 31;\n                wbits(out, p, llm[len]), p += lct[len];\n                if (len > 15)\n                    wbits(out, p, (clct[i] >> 5) & 127), p += clct[i] >> 12;\n            }\n        }\n    }\n    else {\n        lm = flm, ll = flt, dm = fdm, dl = fdt;\n    }\n    for (var i = 0; i < li; ++i) {\n        var sym = syms[i];\n        if (sym > 255) {\n            var len = (sym >> 18) & 31;\n            wbits16(out, p, lm[len + 257]), p += ll[len + 257];\n            if (len > 7)\n                wbits(out, p, (sym >> 23) & 31), p += fleb[len];\n            var dst = sym & 31;\n            wbits16(out, p, dm[dst]), p += dl[dst];\n            if (dst > 3)\n                wbits16(out, p, (sym >> 5) & 8191), p += fdeb[dst];\n        }\n        else {\n            wbits16(out, p, lm[sym]), p += ll[sym];\n        }\n    }\n    wbits16(out, p, lm[256]);\n    return p + ll[256];\n};\n// deflate options (nice << 13) | chain\nvar deo = /*#__PURE__*/ new i32([65540, 131080, 131088, 131104, 262176, 1048704, 1048832, 2114560, 2117632]);\n// empty\nvar et = /*#__PURE__*/ new u8(0);\n// compresses data into a raw DEFLATE buffer\nvar dflt = function (dat, lvl, plvl, pre, post, st) {\n    var s = st.z || dat.length;\n    var o = new u8(pre + s + 5 * (1 + Math.ceil(s / 7000)) + post);\n    // writing to this writes to the output buffer\n    var w = o.subarray(pre, o.length - post);\n    var lst = st.l;\n    var pos = (st.r || 0) & 7;\n    if (lvl) {\n        if (pos)\n            w[0] = st.r >> 3;\n        var opt = deo[lvl - 1];\n        var n = opt >> 13, c = opt & 8191;\n        var msk_1 = (1 << plvl) - 1;\n        //    prev 2-byte val map    curr 2-byte val map\n        var prev = st.p || new u16(32768), head = st.h || new u16(msk_1 + 1);\n        var bs1_1 = Math.ceil(plvl / 3), bs2_1 = 2 * bs1_1;\n        var hsh = function (i) { return (dat[i] ^ (dat[i + 1] << bs1_1) ^ (dat[i + 2] << bs2_1)) & msk_1; };\n        // 24576 is an arbitrary number of maximum symbols per block\n        // 424 buffer for last block\n        var syms = new i32(25000);\n        // length/literal freq   distance freq\n        var lf = new u16(288), df = new u16(32);\n        //  l/lcnt  exbits  index          l/lind  waitdx          blkpos\n        var lc_1 = 0, eb = 0, i = st.i || 0, li = 0, wi = st.w || 0, bs = 0;\n        for (; i + 2 < s; ++i) {\n            // hash value\n            var hv = hsh(i);\n            // index mod 32768    previous index mod\n            var imod = i & 32767, pimod = head[hv];\n            prev[imod] = pimod;\n            head[hv] = imod;\n            // We always should modify head and prev, but only add symbols if\n            // this data is not yet processed (\"wait\" for wait index)\n            if (wi <= i) {\n                // bytes remaining\n                var rem = s - i;\n                if ((lc_1 > 7000 || li > 24576) && (rem > 423 || !lst)) {\n                    pos = wblk(dat, w, 0, syms, lf, df, eb, li, bs, i - bs, pos);\n                    li = lc_1 = eb = 0, bs = i;\n                    for (var j = 0; j < 286; ++j)\n                        lf[j] = 0;\n                    for (var j = 0; j < 30; ++j)\n                        df[j] = 0;\n                }\n                //  len    dist   chain\n                var l = 2, d = 0, ch_1 = c, dif = imod - pimod & 32767;\n                if (rem > 2 && hv == hsh(i - dif)) {\n                    var maxn = Math.min(n, rem) - 1;\n                    var maxd = Math.min(32767, i);\n                    // max possible length\n                    // not capped at dif because decompressors implement \"rolling\" index population\n                    var ml = Math.min(258, rem);\n                    while (dif <= maxd && --ch_1 && imod != pimod) {\n                        if (dat[i + l] == dat[i + l - dif]) {\n                            var nl = 0;\n                            for (; nl < ml && dat[i + nl] == dat[i + nl - dif]; ++nl)\n                                ;\n                            if (nl > l) {\n                                l = nl, d = dif;\n                                // break out early when we reach \"nice\" (we are satisfied enough)\n                                if (nl > maxn)\n                                    break;\n                                // now, find the rarest 2-byte sequence within this\n                                // length of literals and search for that instead.\n                                // Much faster than just using the start\n                                var mmd = Math.min(dif, nl - 2);\n                                var md = 0;\n                                for (var j = 0; j < mmd; ++j) {\n                                    var ti = i - dif + j & 32767;\n                                    var pti = prev[ti];\n                                    var cd = ti - pti & 32767;\n                                    if (cd > md)\n                                        md = cd, pimod = ti;\n                                }\n                            }\n                        }\n                        // check the previous match\n                        imod = pimod, pimod = prev[imod];\n                        dif += imod - pimod & 32767;\n                    }\n                }\n                // d will be nonzero only when a match was found\n                if (d) {\n                    // store both dist and len data in one int32\n                    // Make sure this is recognized as a len/dist with 28th bit (2^28)\n                    syms[li++] = 268435456 | (revfl[l] << 18) | revfd[d];\n                    var lin = revfl[l] & 31, din = revfd[d] & 31;\n                    eb += fleb[lin] + fdeb[din];\n                    ++lf[257 + lin];\n                    ++df[din];\n                    wi = i + l;\n                    ++lc_1;\n                }\n                else {\n                    syms[li++] = dat[i];\n                    ++lf[dat[i]];\n                }\n            }\n        }\n        for (i = Math.max(i, wi); i < s; ++i) {\n            syms[li++] = dat[i];\n            ++lf[dat[i]];\n        }\n        pos = wblk(dat, w, lst, syms, lf, df, eb, li, bs, i - bs, pos);\n        if (!lst) {\n            st.r = (pos & 7) | w[(pos / 8) | 0] << 3;\n            // shft(pos) now 1 less if pos & 7 != 0\n            pos -= 7;\n            st.h = head, st.p = prev, st.i = i, st.w = wi;\n        }\n    }\n    else {\n        for (var i = st.w || 0; i < s + lst; i += 65535) {\n            // end\n            var e = i + 65535;\n            if (e >= s) {\n                // write final block\n                w[(pos / 8) | 0] = lst;\n                e = s;\n            }\n            pos = wfblk(w, pos + 1, dat.subarray(i, e));\n        }\n        st.i = s;\n    }\n    return slc(o, 0, pre + shft(pos) + post);\n};\n// CRC32 table\nvar crct = /*#__PURE__*/ (function () {\n    var t = new Int32Array(256);\n    for (var i = 0; i < 256; ++i) {\n        var c = i, k = 9;\n        while (--k)\n            c = ((c & 1) && -306674912) ^ (c >>> 1);\n        t[i] = c;\n    }\n    return t;\n})();\n// CRC32\nvar crc = function () {\n    var c = -1;\n    return {\n        p: function (d) {\n            // closures have awful performance\n            var cr = c;\n            for (var i = 0; i < d.length; ++i)\n                cr = crct[(cr & 255) ^ d[i]] ^ (cr >>> 8);\n            c = cr;\n        },\n        d: function () { return ~c; }\n    };\n};\n// Adler32\nvar adler = function () {\n    var a = 1, b = 0;\n    return {\n        p: function (d) {\n            // closures have awful performance\n            var n = a, m = b;\n            var l = d.length | 0;\n            for (var i = 0; i != l;) {\n                var e = Math.min(i + 2655, l);\n                for (; i < e; ++i)\n                    m += n += d[i];\n                n = (n & 65535) + 15 * (n >> 16), m = (m & 65535) + 15 * (m >> 16);\n            }\n            a = n, b = m;\n        },\n        d: function () {\n            a %= 65521, b %= 65521;\n            return (a & 255) << 24 | (a & 0xFF00) << 8 | (b & 255) << 8 | (b >> 8);\n        }\n    };\n};\n;\n// deflate with opts\nvar dopt = function (dat, opt, pre, post, st) {\n    if (!st) {\n        st = { l: 1 };\n        if (opt.dictionary) {\n            var dict = opt.dictionary.subarray(-32768);\n            var newDat = new u8(dict.length + dat.length);\n            newDat.set(dict);\n            newDat.set(dat, dict.length);\n            dat = newDat;\n            st.w = dict.length;\n        }\n    }\n    return dflt(dat, opt.level == null ? 6 : opt.level, opt.mem == null ? (st.l ? Math.ceil(Math.max(8, Math.min(13, Math.log(dat.length))) * 1.5) : 20) : (12 + opt.mem), pre, post, st);\n};\n// Walmart object spread\nvar mrg = function (a, b) {\n    var o = {};\n    for (var k in a)\n        o[k] = a[k];\n    for (var k in b)\n        o[k] = b[k];\n    return o;\n};\n// worker clone\n// This is possibly the craziest part of the entire codebase, despite how simple it may seem.\n// The only parameter to this function is a closure that returns an array of variables outside of the function scope.\n// We're going to try to figure out the variable names used in the closure as strings because that is crucial for workerization.\n// We will return an object mapping of true variable name to value (basically, the current scope as a JS object).\n// The reason we can't just use the original variable names is minifiers mangling the toplevel scope.\n// This took me three weeks to figure out how to do.\nvar wcln = function (fn, fnStr, td) {\n    var dt = fn();\n    var st = fn.toString();\n    var ks = st.slice(st.indexOf('[') + 1, st.lastIndexOf(']')).replace(/\\s+/g, '').split(',');\n    for (var i = 0; i < dt.length; ++i) {\n        var v = dt[i], k = ks[i];\n        if (typeof v == 'function') {\n            fnStr += ';' + k + '=';\n            var st_1 = v.toString();\n            if (v.prototype) {\n                // for global objects\n                if (st_1.indexOf('[native code]') != -1) {\n                    var spInd = st_1.indexOf(' ', 8) + 1;\n                    fnStr += st_1.slice(spInd, st_1.indexOf('(', spInd));\n                }\n                else {\n                    fnStr += st_1;\n                    for (var t in v.prototype)\n                        fnStr += ';' + k + '.prototype.' + t + '=' + v.prototype[t].toString();\n                }\n            }\n            else\n                fnStr += st_1;\n        }\n        else\n            td[k] = v;\n    }\n    return fnStr;\n};\nvar ch = [];\n// clone bufs\nvar cbfs = function (v) {\n    var tl = [];\n    for (var k in v) {\n        if (v[k].buffer) {\n            tl.push((v[k] = new v[k].constructor(v[k])).buffer);\n        }\n    }\n    return tl;\n};\n// use a worker to execute code\nvar wrkr = function (fns, init, id, cb) {\n    if (!ch[id]) {\n        var fnStr = '', td_1 = {}, m = fns.length - 1;\n        for (var i = 0; i < m; ++i)\n            fnStr = wcln(fns[i], fnStr, td_1);\n        ch[id] = { c: wcln(fns[m], fnStr, td_1), e: td_1 };\n    }\n    var td = mrg({}, ch[id].e);\n    return wk(ch[id].c + ';onmessage=function(e){for(var k in e.data)self[k]=e.data[k];onmessage=' + init.toString() + '}', id, td, cbfs(td), cb);\n};\n// base async inflate fn\nvar bInflt = function () { return [u8, u16, i32, fleb, fdeb, clim, fl, fd, flrm, fdrm, rev, ec, hMap, max, bits, bits16, shft, slc, err, inflt, inflateSync, pbf, gopt]; };\nvar bDflt = function () { return [u8, u16, i32, fleb, fdeb, clim, revfl, revfd, flm, flt, fdm, fdt, rev, deo, et, hMap, wbits, wbits16, hTree, ln, lc, clen, wfblk, wblk, shft, slc, dflt, dopt, deflateSync, pbf]; };\n// gzip extra\nvar gze = function () { return [gzh, gzhl, wbytes, crc, crct]; };\n// gunzip extra\nvar guze = function () { return [gzs, gzl]; };\n// zlib extra\nvar zle = function () { return [zlh, wbytes, adler]; };\n// unzlib extra\nvar zule = function () { return [zls]; };\n// post buf\nvar pbf = function (msg) { return postMessage(msg, [msg.buffer]); };\n// get opts\nvar gopt = function (o) { return o && {\n    out: o.size && new u8(o.size),\n    dictionary: o.dictionary\n}; };\n// async helper\nvar cbify = function (dat, opts, fns, init, id, cb) {\n    var w = wrkr(fns, init, id, function (err, dat) {\n        w.terminate();\n        cb(err, dat);\n    });\n    w.postMessage([dat, opts], opts.consume ? [dat.buffer] : []);\n    return function () { w.terminate(); };\n};\n// auto stream\nvar astrm = function (strm) {\n    strm.ondata = function (dat, final) { return postMessage([dat, final], [dat.buffer]); };\n    return function (ev) {\n        if (ev.data.length) {\n            strm.push(ev.data[0], ev.data[1]);\n            postMessage([ev.data[0].length]);\n        }\n        else\n            strm.flush();\n    };\n};\n// async stream attach\nvar astrmify = function (fns, strm, opts, init, id, flush, ext) {\n    var t;\n    var w = wrkr(fns, init, id, function (err, dat) {\n        if (err)\n            w.terminate(), strm.ondata.call(strm, err);\n        else if (!Array.isArray(dat))\n            ext(dat);\n        else if (dat.length == 1) {\n            strm.queuedSize -= dat[0];\n            if (strm.ondrain)\n                strm.ondrain(dat[0]);\n        }\n        else {\n            if (dat[1])\n                w.terminate();\n            strm.ondata.call(strm, err, dat[0], dat[1]);\n        }\n    });\n    w.postMessage(opts);\n    strm.queuedSize = 0;\n    strm.push = function (d, f) {\n        if (!strm.ondata)\n            err(5);\n        if (t)\n            strm.ondata(err(4, 0, 1), null, !!f);\n        strm.queuedSize += d.length;\n        w.postMessage([d, t = f], [d.buffer]);\n    };\n    strm.terminate = function () { w.terminate(); };\n    if (flush) {\n        strm.flush = function () { w.postMessage([]); };\n    }\n};\n// read 2 bytes\nvar b2 = function (d, b) { return d[b] | (d[b + 1] << 8); };\n// read 4 bytes\nvar b4 = function (d, b) { return (d[b] | (d[b + 1] << 8) | (d[b + 2] << 16) | (d[b + 3] << 24)) >>> 0; };\nvar b8 = function (d, b) { return b4(d, b) + (b4(d, b + 4) * 4294967296); };\n// write bytes\nvar wbytes = function (d, b, v) {\n    for (; v; ++b)\n        d[b] = v, v >>>= 8;\n};\n// gzip header\nvar gzh = function (c, o) {\n    var fn = o.filename;\n    c[0] = 31, c[1] = 139, c[2] = 8, c[8] = o.level < 2 ? 4 : o.level == 9 ? 2 : 0, c[9] = 3; // assume Unix\n    if (o.mtime != 0)\n        wbytes(c, 4, Math.floor(new Date(o.mtime || Date.now()) / 1000));\n    if (fn) {\n        c[3] = 8;\n        for (var i = 0; i <= fn.length; ++i)\n            c[i + 10] = fn.charCodeAt(i);\n    }\n};\n// gzip footer: -8 to -4 = CRC, -4 to -0 is length\n// gzip start\nvar gzs = function (d) {\n    if (d[0] != 31 || d[1] != 139 || d[2] != 8)\n        err(6, 'invalid gzip data');\n    var flg = d[3];\n    var st = 10;\n    if (flg & 4)\n        st += (d[10] | d[11] << 8) + 2;\n    for (var zs = (flg >> 3 & 1) + (flg >> 4 & 1); zs > 0; zs -= !d[st++])\n        ;\n    return st + (flg & 2);\n};\n// gzip length\nvar gzl = function (d) {\n    var l = d.length;\n    return (d[l - 4] | d[l - 3] << 8 | d[l - 2] << 16 | d[l - 1] << 24) >>> 0;\n};\n// gzip header length\nvar gzhl = function (o) { return 10 + (o.filename ? o.filename.length + 1 : 0); };\n// zlib header\nvar zlh = function (c, o) {\n    var lv = o.level, fl = lv == 0 ? 0 : lv < 6 ? 1 : lv == 9 ? 3 : 2;\n    c[0] = 120, c[1] = (fl << 6) | (o.dictionary && 32);\n    c[1] |= 31 - ((c[0] << 8) | c[1]) % 31;\n    if (o.dictionary) {\n        var h = adler();\n        h.p(o.dictionary);\n        wbytes(c, 2, h.d());\n    }\n};\n// zlib start\nvar zls = function (d, dict) {\n    if ((d[0] & 15) != 8 || (d[0] >> 4) > 7 || ((d[0] << 8 | d[1]) % 31))\n        err(6, 'invalid zlib data');\n    if ((d[1] >> 5 & 1) == +!dict)\n        err(6, 'invalid zlib data: ' + (d[1] & 32 ? 'need' : 'unexpected') + ' dictionary');\n    return (d[1] >> 3 & 4) + 2;\n};\nfunction StrmOpt(opts, cb) {\n    if (typeof opts == 'function')\n        cb = opts, opts = {};\n    this.ondata = cb;\n    return opts;\n}\n/**\n * Streaming DEFLATE compression\n */\nvar Deflate = /*#__PURE__*/ (function () {\n    function Deflate(opts, cb) {\n        if (typeof opts == 'function')\n            cb = opts, opts = {};\n        this.ondata = cb;\n        this.o = opts || {};\n        this.s = { l: 0, i: 32768, w: 32768, z: 32768 };\n        // Buffer length must always be 0 mod 32768 for index calculations to be correct when modifying head and prev\n        // 98304 = 32768 (lookback) + 65536 (common chunk size)\n        this.b = new u8(98304);\n        if (this.o.dictionary) {\n            var dict = this.o.dictionary.subarray(-32768);\n            this.b.set(dict, 32768 - dict.length);\n            this.s.i = 32768 - dict.length;\n        }\n    }\n    Deflate.prototype.p = function (c, f) {\n        this.ondata(dopt(c, this.o, 0, 0, this.s), f);\n    };\n    /**\n     * Pushes a chunk to be deflated\n     * @param chunk The chunk to push\n     * @param final Whether this is the last chunk\n     */\n    Deflate.prototype.push = function (chunk, final) {\n        if (!this.ondata)\n            err(5);\n        if (this.s.l)\n            err(4);\n        var endLen = chunk.length + this.s.z;\n        if (endLen > this.b.length) {\n            if (endLen > 2 * this.b.length - 32768) {\n                var newBuf = new u8(endLen & -32768);\n                newBuf.set(this.b.subarray(0, this.s.z));\n                this.b = newBuf;\n            }\n            var split = this.b.length - this.s.z;\n            this.b.set(chunk.subarray(0, split), this.s.z);\n            this.s.z = this.b.length;\n            this.p(this.b, false);\n            this.b.set(this.b.subarray(-32768));\n            this.b.set(chunk.subarray(split), 32768);\n            this.s.z = chunk.length - split + 32768;\n            this.s.i = 32766, this.s.w = 32768;\n        }\n        else {\n            this.b.set(chunk, this.s.z);\n            this.s.z += chunk.length;\n        }\n        this.s.l = final & 1;\n        if (this.s.z > this.s.w + 8191 || final) {\n            this.p(this.b, final || false);\n            this.s.w = this.s.i, this.s.i -= 2;\n        }\n    };\n    /**\n     * Flushes buffered uncompressed data. Useful to immediately retrieve the\n     * deflated output for small inputs.\n     */\n    Deflate.prototype.flush = function () {\n        if (!this.ondata)\n            err(5);\n        if (this.s.l)\n            err(4);\n        this.p(this.b, false);\n        this.s.w = this.s.i, this.s.i -= 2;\n    };\n    return Deflate;\n}());\nexport { Deflate };\n/**\n * Asynchronous streaming DEFLATE compression\n */\nvar AsyncDeflate = /*#__PURE__*/ (function () {\n    function AsyncDeflate(opts, cb) {\n        astrmify([\n            bDflt,\n            function () { return [astrm, Deflate]; }\n        ], this, StrmOpt.call(this, opts, cb), function (ev) {\n            var strm = new Deflate(ev.data);\n            onmessage = astrm(strm);\n        }, 6, 1);\n    }\n    return AsyncDeflate;\n}());\nexport { AsyncDeflate };\nexport function deflate(data, opts, cb) {\n    if (!cb)\n        cb = opts, opts = {};\n    if (typeof cb != 'function')\n        err(7);\n    return cbify(data, opts, [\n        bDflt,\n    ], function (ev) { return pbf(deflateSync(ev.data[0], ev.data[1])); }, 0, cb);\n}\n/**\n * Compresses data with DEFLATE without any wrapper\n * @param data The data to compress\n * @param opts The compression options\n * @returns The deflated version of the data\n */\nexport function deflateSync(data, opts) {\n    return dopt(data, opts || {}, 0, 0);\n}\n/**\n * Streaming DEFLATE decompression\n */\nvar Inflate = /*#__PURE__*/ (function () {\n    function Inflate(opts, cb) {\n        // no StrmOpt here to avoid adding to workerizer\n        if (typeof opts == 'function')\n            cb = opts, opts = {};\n        this.ondata = cb;\n        var dict = opts && opts.dictionary && opts.dictionary.subarray(-32768);\n        this.s = { i: 0, b: dict ? dict.length : 0 };\n        this.o = new u8(32768);\n        this.p = new u8(0);\n        if (dict)\n            this.o.set(dict);\n    }\n    Inflate.prototype.e = function (c) {\n        if (!this.ondata)\n            err(5);\n        if (this.d)\n            err(4);\n        if (!this.p.length)\n            this.p = c;\n        else if (c.length) {\n            var n = new u8(this.p.length + c.length);\n            n.set(this.p), n.set(c, this.p.length), this.p = n;\n        }\n    };\n    Inflate.prototype.c = function (final) {\n        this.s.i = +(this.d = final || false);\n        var bts = this.s.b;\n        var dt = inflt(this.p, this.s, this.o);\n        this.ondata(slc(dt, bts, this.s.b), this.d);\n        this.o = slc(dt, this.s.b - 32768), this.s.b = this.o.length;\n        this.p = slc(this.p, (this.s.p / 8) | 0), this.s.p &= 7;\n    };\n    /**\n     * Pushes a chunk to be inflated\n     * @param chunk The chunk to push\n     * @param final Whether this is the final chunk\n     */\n    Inflate.prototype.push = function (chunk, final) {\n        this.e(chunk), this.c(final);\n    };\n    return Inflate;\n}());\nexport { Inflate };\n/**\n * Asynchronous streaming DEFLATE decompression\n */\nvar AsyncInflate = /*#__PURE__*/ (function () {\n    function AsyncInflate(opts, cb) {\n        astrmify([\n            bInflt,\n            function () { return [astrm, Inflate]; }\n        ], this, StrmOpt.call(this, opts, cb), function (ev) {\n            var strm = new Inflate(ev.data);\n            onmessage = astrm(strm);\n        }, 7, 0);\n    }\n    return AsyncInflate;\n}());\nexport { AsyncInflate };\nexport function inflate(data, opts, cb) {\n    if (!cb)\n        cb = opts, opts = {};\n    if (typeof cb != 'function')\n        err(7);\n    return cbify(data, opts, [\n        bInflt\n    ], function (ev) { return pbf(inflateSync(ev.data[0], gopt(ev.data[1]))); }, 1, cb);\n}\n/**\n * Expands DEFLATE data with no wrapper\n * @param data The data to decompress\n * @param opts The decompression options\n * @returns The decompressed version of the data\n */\nexport function inflateSync(data, opts) {\n    return inflt(data, { i: 2 }, opts && opts.out, opts && opts.dictionary);\n}\n// before you yell at me for not just using extends, my reason is that TS inheritance is hard to workerize.\n/**\n * Streaming GZIP compression\n */\nvar Gzip = /*#__PURE__*/ (function () {\n    function Gzip(opts, cb) {\n        this.c = crc();\n        this.l = 0;\n        this.v = 1;\n        Deflate.call(this, opts, cb);\n    }\n    /**\n     * Pushes a chunk to be GZIPped\n     * @param chunk The chunk to push\n     * @param final Whether this is the last chunk\n     */\n    Gzip.prototype.push = function (chunk, final) {\n        this.c.p(chunk);\n        this.l += chunk.length;\n        Deflate.prototype.push.call(this, chunk, final);\n    };\n    Gzip.prototype.p = function (c, f) {\n        var raw = dopt(c, this.o, this.v && gzhl(this.o), f && 8, this.s);\n        if (this.v)\n            gzh(raw, this.o), this.v = 0;\n        if (f)\n            wbytes(raw, raw.length - 8, this.c.d()), wbytes(raw, raw.length - 4, this.l);\n        this.ondata(raw, f);\n    };\n    /**\n     * Flushes buffered uncompressed data. Useful to immediately retrieve the\n     * GZIPped output for small inputs.\n     */\n    Gzip.prototype.flush = function () {\n        Deflate.prototype.flush.call(this);\n    };\n    return Gzip;\n}());\nexport { Gzip };\n/**\n * Asynchronous streaming GZIP compression\n */\nvar AsyncGzip = /*#__PURE__*/ (function () {\n    function AsyncGzip(opts, cb) {\n        astrmify([\n            bDflt,\n            gze,\n            function () { return [astrm, Deflate, Gzip]; }\n        ], this, StrmOpt.call(this, opts, cb), function (ev) {\n            var strm = new Gzip(ev.data);\n            onmessage = astrm(strm);\n        }, 8, 1);\n    }\n    return AsyncGzip;\n}());\nexport { AsyncGzip };\nexport function gzip(data, opts, cb) {\n    if (!cb)\n        cb = opts, opts = {};\n    if (typeof cb != 'function')\n        err(7);\n    return cbify(data, opts, [\n        bDflt,\n        gze,\n        function () { return [gzipSync]; }\n    ], function (ev) { return pbf(gzipSync(ev.data[0], ev.data[1])); }, 2, cb);\n}\n/**\n * Compresses data with GZIP\n * @param data The data to compress\n * @param opts The compression options\n * @returns The gzipped version of the data\n */\nexport function gzipSync(data, opts) {\n    if (!opts)\n        opts = {};\n    var c = crc(), l = data.length;\n    c.p(data);\n    var d = dopt(data, opts, gzhl(opts), 8), s = d.length;\n    return gzh(d, opts), wbytes(d, s - 8, c.d()), wbytes(d, s - 4, l), d;\n}\n/**\n * Streaming single or multi-member GZIP decompression\n */\nvar Gunzip = /*#__PURE__*/ (function () {\n    function Gunzip(opts, cb) {\n        this.v = 1;\n        this.r = 0;\n        Inflate.call(this, opts, cb);\n    }\n    /**\n     * Pushes a chunk to be GUNZIPped\n     * @param chunk The chunk to push\n     * @param final Whether this is the last chunk\n     */\n    Gunzip.prototype.push = function (chunk, final) {\n        Inflate.prototype.e.call(this, chunk);\n        this.r += chunk.length;\n        if (this.v) {\n            var p = this.p.subarray(this.v - 1);\n            var s = p.length > 3 ? gzs(p) : 4;\n            if (s > p.length) {\n                if (!final)\n                    return;\n            }\n            else if (this.v > 1 && this.onmember) {\n                this.onmember(this.r - p.length);\n            }\n            this.p = p.subarray(s), this.v = 0;\n        }\n        // necessary to prevent TS from using the closure value\n        // This allows for workerization to function correctly\n        Inflate.prototype.c.call(this, final);\n        // process concatenated GZIP\n        if (this.s.f && !this.s.l && !final) {\n            this.v = shft(this.s.p) + 9;\n            this.s = { i: 0 };\n            this.o = new u8(0);\n            this.push(new u8(0), final);\n        }\n    };\n    return Gunzip;\n}());\nexport { Gunzip };\n/**\n * Asynchronous streaming single or multi-member GZIP decompression\n */\nvar AsyncGunzip = /*#__PURE__*/ (function () {\n    function AsyncGunzip(opts, cb) {\n        var _this = this;\n        astrmify([\n            bInflt,\n            guze,\n            function () { return [astrm, Inflate, Gunzip]; }\n        ], this, StrmOpt.call(this, opts, cb), function (ev) {\n            var strm = new Gunzip(ev.data);\n            strm.onmember = function (offset) { return postMessage(offset); };\n            onmessage = astrm(strm);\n        }, 9, 0, function (offset) { return _this.onmember && _this.onmember(offset); });\n    }\n    return AsyncGunzip;\n}());\nexport { AsyncGunzip };\nexport function gunzip(data, opts, cb) {\n    if (!cb)\n        cb = opts, opts = {};\n    if (typeof cb != 'function')\n        err(7);\n    return cbify(data, opts, [\n        bInflt,\n        guze,\n        function () { return [gunzipSync]; }\n    ], function (ev) { return pbf(gunzipSync(ev.data[0], ev.data[1])); }, 3, cb);\n}\n/**\n * Expands GZIP data\n * @param data The data to decompress\n * @param opts The decompression options\n * @returns The decompressed version of the data\n */\nexport function gunzipSync(data, opts) {\n    var st = gzs(data);\n    if (st + 8 > data.length)\n        err(6, 'invalid gzip data');\n    return inflt(data.subarray(st, -8), { i: 2 }, opts && opts.out || new u8(gzl(data)), opts && opts.dictionary);\n}\n/**\n * Streaming Zlib compression\n */\nvar Zlib = /*#__PURE__*/ (function () {\n    function Zlib(opts, cb) {\n        this.c = adler();\n        this.v = 1;\n        Deflate.call(this, opts, cb);\n    }\n    /**\n     * Pushes a chunk to be zlibbed\n     * @param chunk The chunk to push\n     * @param final Whether this is the last chunk\n     */\n    Zlib.prototype.push = function (chunk, final) {\n        this.c.p(chunk);\n        Deflate.prototype.push.call(this, chunk, final);\n    };\n    Zlib.prototype.p = function (c, f) {\n        var raw = dopt(c, this.o, this.v && (this.o.dictionary ? 6 : 2), f && 4, this.s);\n        if (this.v)\n            zlh(raw, this.o), this.v = 0;\n        if (f)\n            wbytes(raw, raw.length - 4, this.c.d());\n        this.ondata(raw, f);\n    };\n    /**\n     * Flushes buffered uncompressed data. Useful to immediately retrieve the\n     * zlibbed output for small inputs.\n     */\n    Zlib.prototype.flush = function () {\n        Deflate.prototype.flush.call(this);\n    };\n    return Zlib;\n}());\nexport { Zlib };\n/**\n * Asynchronous streaming Zlib compression\n */\nvar AsyncZlib = /*#__PURE__*/ (function () {\n    function AsyncZlib(opts, cb) {\n        astrmify([\n            bDflt,\n            zle,\n            function () { return [astrm, Deflate, Zlib]; }\n        ], this, StrmOpt.call(this, opts, cb), function (ev) {\n            var strm = new Zlib(ev.data);\n            onmessage = astrm(strm);\n        }, 10, 1);\n    }\n    return AsyncZlib;\n}());\nexport { AsyncZlib };\nexport function zlib(data, opts, cb) {\n    if (!cb)\n        cb = opts, opts = {};\n    if (typeof cb != 'function')\n        err(7);\n    return cbify(data, opts, [\n        bDflt,\n        zle,\n        function () { return [zlibSync]; }\n    ], function (ev) { return pbf(zlibSync(ev.data[0], ev.data[1])); }, 4, cb);\n}\n/**\n * Compress data with Zlib\n * @param data The data to compress\n * @param opts The compression options\n * @returns The zlib-compressed version of the data\n */\nexport function zlibSync(data, opts) {\n    if (!opts)\n        opts = {};\n    var a = adler();\n    a.p(data);\n    var d = dopt(data, opts, opts.dictionary ? 6 : 2, 4);\n    return zlh(d, opts), wbytes(d, d.length - 4, a.d()), d;\n}\n/**\n * Streaming Zlib decompression\n */\nvar Unzlib = /*#__PURE__*/ (function () {\n    function Unzlib(opts, cb) {\n        Inflate.call(this, opts, cb);\n        this.v = opts && opts.dictionary ? 2 : 1;\n    }\n    /**\n     * Pushes a chunk to be unzlibbed\n     * @param chunk The chunk to push\n     * @param final Whether this is the last chunk\n     */\n    Unzlib.prototype.push = function (chunk, final) {\n        Inflate.prototype.e.call(this, chunk);\n        if (this.v) {\n            if (this.p.length < 6 && !final)\n                return;\n            this.p = this.p.subarray(zls(this.p, this.v - 1)), this.v = 0;\n        }\n        if (final) {\n            if (this.p.length < 4)\n                err(6, 'invalid zlib data');\n            this.p = this.p.subarray(0, -4);\n        }\n        // necessary to prevent TS from using the closure value\n        // This allows for workerization to function correctly\n        Inflate.prototype.c.call(this, final);\n    };\n    return Unzlib;\n}());\nexport { Unzlib };\n/**\n * Asynchronous streaming Zlib decompression\n */\nvar AsyncUnzlib = /*#__PURE__*/ (function () {\n    function AsyncUnzlib(opts, cb) {\n        astrmify([\n            bInflt,\n            zule,\n            function () { return [astrm, Inflate, Unzlib]; }\n        ], this, StrmOpt.call(this, opts, cb), function (ev) {\n            var strm = new Unzlib(ev.data);\n            onmessage = astrm(strm);\n        }, 11, 0);\n    }\n    return AsyncUnzlib;\n}());\nexport { AsyncUnzlib };\nexport function unzlib(data, opts, cb) {\n    if (!cb)\n        cb = opts, opts = {};\n    if (typeof cb != 'function')\n        err(7);\n    return cbify(data, opts, [\n        bInflt,\n        zule,\n        function () { return [unzlibSync]; }\n    ], function (ev) { return pbf(unzlibSync(ev.data[0], gopt(ev.data[1]))); }, 5, cb);\n}\n/**\n * Expands Zlib data\n * @param data The data to decompress\n * @param opts The decompression options\n * @returns The decompressed version of the data\n */\nexport function unzlibSync(data, opts) {\n    return inflt(data.subarray(zls(data, opts && opts.dictionary), -4), { i: 2 }, opts && opts.out, opts && opts.dictionary);\n}\n// Default algorithm for compression (used because having a known output size allows faster decompression)\nexport { gzip as compress, AsyncGzip as AsyncCompress };\nexport { gzipSync as compressSync, Gzip as Compress };\n/**\n * Streaming GZIP, Zlib, or raw DEFLATE decompression\n */\nvar Decompress = /*#__PURE__*/ (function () {\n    function Decompress(opts, cb) {\n        this.o = StrmOpt.call(this, opts, cb) || {};\n        this.G = Gunzip;\n        this.I = Inflate;\n        this.Z = Unzlib;\n    }\n    // init substream\n    // overriden by AsyncDecompress\n    Decompress.prototype.i = function () {\n        var _this = this;\n        this.s.ondata = function (dat, final) {\n            _this.ondata(dat, final);\n        };\n    };\n    /**\n     * Pushes a chunk to be decompressed\n     * @param chunk The chunk to push\n     * @param final Whether this is the last chunk\n     */\n    Decompress.prototype.push = function (chunk, final) {\n        if (!this.ondata)\n            err(5);\n        if (!this.s) {\n            if (this.p && this.p.length) {\n                var n = new u8(this.p.length + chunk.length);\n                n.set(this.p), n.set(chunk, this.p.length);\n            }\n            else\n                this.p = chunk;\n            if (this.p.length > 2) {\n                this.s = (this.p[0] == 31 && this.p[1] == 139 && this.p[2] == 8)\n                    ? new this.G(this.o)\n                    : ((this.p[0] & 15) != 8 || (this.p[0] >> 4) > 7 || ((this.p[0] << 8 | this.p[1]) % 31))\n                        ? new this.I(this.o)\n                        : new this.Z(this.o);\n                this.i();\n                this.s.push(this.p, final);\n                this.p = null;\n            }\n        }\n        else\n            this.s.push(chunk, final);\n    };\n    return Decompress;\n}());\nexport { Decompress };\n/**\n * Asynchronous streaming GZIP, Zlib, or raw DEFLATE decompression\n */\nvar AsyncDecompress = /*#__PURE__*/ (function () {\n    function AsyncDecompress(opts, cb) {\n        Decompress.call(this, opts, cb);\n        this.queuedSize = 0;\n        this.G = AsyncGunzip;\n        this.I = AsyncInflate;\n        this.Z = AsyncUnzlib;\n    }\n    AsyncDecompress.prototype.i = function () {\n        var _this = this;\n        this.s.ondata = function (err, dat, final) {\n            _this.ondata(err, dat, final);\n        };\n        this.s.ondrain = function (size) {\n            _this.queuedSize -= size;\n            if (_this.ondrain)\n                _this.ondrain(size);\n        };\n    };\n    /**\n     * Pushes a chunk to be decompressed\n     * @param chunk The chunk to push\n     * @param final Whether this is the last chunk\n     */\n    AsyncDecompress.prototype.push = function (chunk, final) {\n        this.queuedSize += chunk.length;\n        Decompress.prototype.push.call(this, chunk, final);\n    };\n    return AsyncDecompress;\n}());\nexport { AsyncDecompress };\nexport function decompress(data, opts, cb) {\n    if (!cb)\n        cb = opts, opts = {};\n    if (typeof cb != 'function')\n        err(7);\n    return (data[0] == 31 && data[1] == 139 && data[2] == 8)\n        ? gunzip(data, opts, cb)\n        : ((data[0] & 15) != 8 || (data[0] >> 4) > 7 || ((data[0] << 8 | data[1]) % 31))\n            ? inflate(data, opts, cb)\n            : unzlib(data, opts, cb);\n}\n/**\n * Expands compressed GZIP, Zlib, or raw DEFLATE data, automatically detecting the format\n * @param data The data to decompress\n * @param opts The decompression options\n * @returns The decompressed version of the data\n */\nexport function decompressSync(data, opts) {\n    return (data[0] == 31 && data[1] == 139 && data[2] == 8)\n        ? gunzipSync(data, opts)\n        : ((data[0] & 15) != 8 || (data[0] >> 4) > 7 || ((data[0] << 8 | data[1]) % 31))\n            ? inflateSync(data, opts)\n            : unzlibSync(data, opts);\n}\n// flatten a directory structure\nvar fltn = function (d, p, t, o) {\n    for (var k in d) {\n        var val = d[k], n = p + k, op = o;\n        if (Array.isArray(val))\n            op = mrg(o, val[1]), val = val[0];\n        if (val instanceof u8)\n            t[n] = [val, op];\n        else {\n            t[n += '/'] = [new u8(0), op];\n            fltn(val, n, t, o);\n        }\n    }\n};\n// text encoder\nvar te = typeof TextEncoder != 'undefined' && /*#__PURE__*/ new TextEncoder();\n// text decoder\nvar td = typeof TextDecoder != 'undefined' && /*#__PURE__*/ new TextDecoder();\n// text decoder stream\nvar tds = 0;\ntry {\n    td.decode(et, { stream: true });\n    tds = 1;\n}\ncatch (e) { }\n// decode UTF8\nvar dutf8 = function (d) {\n    for (var r = '', i = 0;;) {\n        var c = d[i++];\n        var eb = (c > 127) + (c > 223) + (c > 239);\n        if (i + eb > d.length)\n            return { s: r, r: slc(d, i - 1) };\n        if (!eb)\n            r += String.fromCharCode(c);\n        else if (eb == 3) {\n            c = ((c & 15) << 18 | (d[i++] & 63) << 12 | (d[i++] & 63) << 6 | (d[i++] & 63)) - 65536,\n                r += String.fromCharCode(55296 | (c >> 10), 56320 | (c & 1023));\n        }\n        else if (eb & 1)\n            r += String.fromCharCode((c & 31) << 6 | (d[i++] & 63));\n        else\n            r += String.fromCharCode((c & 15) << 12 | (d[i++] & 63) << 6 | (d[i++] & 63));\n    }\n};\n/**\n * Streaming UTF-8 decoding\n */\nvar DecodeUTF8 = /*#__PURE__*/ (function () {\n    /**\n     * Creates a UTF-8 decoding stream\n     * @param cb The callback to call whenever data is decoded\n     */\n    function DecodeUTF8(cb) {\n        this.ondata = cb;\n        if (tds)\n            this.t = new TextDecoder();\n        else\n            this.p = et;\n    }\n    /**\n     * Pushes a chunk to be decoded from UTF-8 binary\n     * @param chunk The chunk to push\n     * @param final Whether this is the last chunk\n     */\n    DecodeUTF8.prototype.push = function (chunk, final) {\n        if (!this.ondata)\n            err(5);\n        final = !!final;\n        if (this.t) {\n            this.ondata(this.t.decode(chunk, { stream: true }), final);\n            if (final) {\n                if (this.t.decode().length)\n                    err(8);\n                this.t = null;\n            }\n            return;\n        }\n        if (!this.p)\n            err(4);\n        var dat = new u8(this.p.length + chunk.length);\n        dat.set(this.p);\n        dat.set(chunk, this.p.length);\n        var _a = dutf8(dat), s = _a.s, r = _a.r;\n        if (final) {\n            if (r.length)\n                err(8);\n            this.p = null;\n        }\n        else\n            this.p = r;\n        this.ondata(s, final);\n    };\n    return DecodeUTF8;\n}());\nexport { DecodeUTF8 };\n/**\n * Streaming UTF-8 encoding\n */\nvar EncodeUTF8 = /*#__PURE__*/ (function () {\n    /**\n     * Creates a UTF-8 decoding stream\n     * @param cb The callback to call whenever data is encoded\n     */\n    function EncodeUTF8(cb) {\n        this.ondata = cb;\n    }\n    /**\n     * Pushes a chunk to be encoded to UTF-8\n     * @param chunk The string data to push\n     * @param final Whether this is the last chunk\n     */\n    EncodeUTF8.prototype.push = function (chunk, final) {\n        if (!this.ondata)\n            err(5);\n        if (this.d)\n            err(4);\n        this.ondata(strToU8(chunk), this.d = final || false);\n    };\n    return EncodeUTF8;\n}());\nexport { EncodeUTF8 };\n/**\n * Converts a string into a Uint8Array for use with compression/decompression methods\n * @param str The string to encode\n * @param latin1 Whether or not to interpret the data as Latin-1. This should\n *               not need to be true unless decoding a binary string.\n * @returns The string encoded in UTF-8/Latin-1 binary\n */\nexport function strToU8(str, latin1) {\n    if (latin1) {\n        var ar_1 = new u8(str.length);\n        for (var i = 0; i < str.length; ++i)\n            ar_1[i] = str.charCodeAt(i);\n        return ar_1;\n    }\n    if (te)\n        return te.encode(str);\n    var l = str.length;\n    var ar = new u8(str.length + (str.length >> 1));\n    var ai = 0;\n    var w = function (v) { ar[ai++] = v; };\n    for (var i = 0; i < l; ++i) {\n        if (ai + 5 > ar.length) {\n            var n = new u8(ai + 8 + ((l - i) << 1));\n            n.set(ar);\n            ar = n;\n        }\n        var c = str.charCodeAt(i);\n        if (c < 128 || latin1)\n            w(c);\n        else if (c < 2048)\n            w(192 | (c >> 6)), w(128 | (c & 63));\n        else if (c > 55295 && c < 57344)\n            c = 65536 + (c & 1023 << 10) | (str.charCodeAt(++i) & 1023),\n                w(240 | (c >> 18)), w(128 | ((c >> 12) & 63)), w(128 | ((c >> 6) & 63)), w(128 | (c & 63));\n        else\n            w(224 | (c >> 12)), w(128 | ((c >> 6) & 63)), w(128 | (c & 63));\n    }\n    return slc(ar, 0, ai);\n}\n/**\n * Converts a Uint8Array to a string\n * @param dat The data to decode to string\n * @param latin1 Whether or not to interpret the data as Latin-1. This should\n *               not need to be true unless encoding to binary string.\n * @returns The original UTF-8/Latin-1 string\n */\nexport function strFromU8(dat, latin1) {\n    if (latin1) {\n        var r = '';\n        for (var i = 0; i < dat.length; i += 16384)\n            r += String.fromCharCode.apply(null, dat.subarray(i, i + 16384));\n        return r;\n    }\n    else if (td) {\n        return td.decode(dat);\n    }\n    else {\n        var _a = dutf8(dat), s = _a.s, r = _a.r;\n        if (r.length)\n            err(8);\n        return s;\n    }\n}\n;\n// deflate bit flag\nvar dbf = function (l) { return l == 1 ? 3 : l < 6 ? 2 : l == 9 ? 1 : 0; };\n// skip local zip header\nvar slzh = function (d, b) { return b + 30 + b2(d, b + 26) + b2(d, b + 28); };\n// read zip header\nvar zh = function (d, b, z) {\n    var fnl = b2(d, b + 28), fn = strFromU8(d.subarray(b + 46, b + 46 + fnl), !(b2(d, b + 8) & 2048)), es = b + 46 + fnl, bs = b4(d, b + 20);\n    var _a = z && bs == 4294967295 ? z64e(d, es) : [bs, b4(d, b + 24), b4(d, b + 42)], sc = _a[0], su = _a[1], off = _a[2];\n    return [b2(d, b + 10), sc, su, fn, es + b2(d, b + 30) + b2(d, b + 32), off];\n};\n// read zip64 extra field\nvar z64e = function (d, b) {\n    for (; b2(d, b) != 1; b += 4 + b2(d, b + 2))\n        ;\n    return [b8(d, b + 12), b8(d, b + 4), b8(d, b + 20)];\n};\n// extra field length\nvar exfl = function (ex) {\n    var le = 0;\n    if (ex) {\n        for (var k in ex) {\n            var l = ex[k].length;\n            if (l > 65535)\n                err(9);\n            le += l + 4;\n        }\n    }\n    return le;\n};\n// write zip header\nvar wzh = function (d, b, f, fn, u, c, ce, co) {\n    var fl = fn.length, ex = f.extra, col = co && co.length;\n    var exl = exfl(ex);\n    wbytes(d, b, ce != null ? 0x2014B50 : 0x4034B50), b += 4;\n    if (ce != null)\n        d[b++] = 20, d[b++] = f.os;\n    d[b] = 20, b += 2; // spec compliance? what's that?\n    d[b++] = (f.flag << 1) | (c < 0 && 8), d[b++] = u && 8;\n    d[b++] = f.compression & 255, d[b++] = f.compression >> 8;\n    var dt = new Date(f.mtime == null ? Date.now() : f.mtime), y = dt.getFullYear() - 1980;\n    if (y < 0 || y > 119)\n        err(10);\n    wbytes(d, b, (y << 25) | ((dt.getMonth() + 1) << 21) | (dt.getDate() << 16) | (dt.getHours() << 11) | (dt.getMinutes() << 5) | (dt.getSeconds() >> 1)), b += 4;\n    if (c != -1) {\n        wbytes(d, b, f.crc);\n        wbytes(d, b + 4, c < 0 ? -c - 2 : c);\n        wbytes(d, b + 8, f.size);\n    }\n    wbytes(d, b + 12, fl);\n    wbytes(d, b + 14, exl), b += 16;\n    if (ce != null) {\n        wbytes(d, b, col);\n        wbytes(d, b + 6, f.attrs);\n        wbytes(d, b + 10, ce), b += 14;\n    }\n    d.set(fn, b);\n    b += fl;\n    if (exl) {\n        for (var k in ex) {\n            var exf = ex[k], l = exf.length;\n            wbytes(d, b, +k);\n            wbytes(d, b + 2, l);\n            d.set(exf, b + 4), b += 4 + l;\n        }\n    }\n    if (col)\n        d.set(co, b), b += col;\n    return b;\n};\n// write zip footer (end of central directory)\nvar wzf = function (o, b, c, d, e) {\n    wbytes(o, b, 0x6054B50); // skip disk\n    wbytes(o, b + 8, c);\n    wbytes(o, b + 10, c);\n    wbytes(o, b + 12, d);\n    wbytes(o, b + 16, e);\n};\n/**\n * A pass-through stream to keep data uncompressed in a ZIP archive.\n */\nvar ZipPassThrough = /*#__PURE__*/ (function () {\n    /**\n     * Creates a pass-through stream that can be added to ZIP archives\n     * @param filename The filename to associate with this data stream\n     */\n    function ZipPassThrough(filename) {\n        this.filename = filename;\n        this.c = crc();\n        this.size = 0;\n        this.compression = 0;\n    }\n    /**\n     * Processes a chunk and pushes to the output stream. You can override this\n     * method in a subclass for custom behavior, but by default this passes\n     * the data through. You must call this.ondata(err, chunk, final) at some\n     * point in this method.\n     * @param chunk The chunk to process\n     * @param final Whether this is the last chunk\n     */\n    ZipPassThrough.prototype.process = function (chunk, final) {\n        this.ondata(null, chunk, final);\n    };\n    /**\n     * Pushes a chunk to be added. If you are subclassing this with a custom\n     * compression algorithm, note that you must push data from the source\n     * file only, pre-compression.\n     * @param chunk The chunk to push\n     * @param final Whether this is the last chunk\n     */\n    ZipPassThrough.prototype.push = function (chunk, final) {\n        if (!this.ondata)\n            err(5);\n        this.c.p(chunk);\n        this.size += chunk.length;\n        if (final)\n            this.crc = this.c.d();\n        this.process(chunk, final || false);\n    };\n    return ZipPassThrough;\n}());\nexport { ZipPassThrough };\n// I don't extend because TypeScript extension adds 1kB of runtime bloat\n/**\n * Streaming DEFLATE compression for ZIP archives. Prefer using AsyncZipDeflate\n * for better performance\n */\nvar ZipDeflate = /*#__PURE__*/ (function () {\n    /**\n     * Creates a DEFLATE stream that can be added to ZIP archives\n     * @param filename The filename to associate with this data stream\n     * @param opts The compression options\n     */\n    function ZipDeflate(filename, opts) {\n        var _this = this;\n        if (!opts)\n            opts = {};\n        ZipPassThrough.call(this, filename);\n        this.d = new Deflate(opts, function (dat, final) {\n            _this.ondata(null, dat, final);\n        });\n        this.compression = 8;\n        this.flag = dbf(opts.level);\n    }\n    ZipDeflate.prototype.process = function (chunk, final) {\n        try {\n            this.d.push(chunk, final);\n        }\n        catch (e) {\n            this.ondata(e, null, final);\n        }\n    };\n    /**\n     * Pushes a chunk to be deflated\n     * @param chunk The chunk to push\n     * @param final Whether this is the last chunk\n     */\n    ZipDeflate.prototype.push = function (chunk, final) {\n        ZipPassThrough.prototype.push.call(this, chunk, final);\n    };\n    return ZipDeflate;\n}());\nexport { ZipDeflate };\n/**\n * Asynchronous streaming DEFLATE compression for ZIP archives\n */\nvar AsyncZipDeflate = /*#__PURE__*/ (function () {\n    /**\n     * Creates an asynchronous DEFLATE stream that can be added to ZIP archives\n     * @param filename The filename to associate with this data stream\n     * @param opts The compression options\n     */\n    function AsyncZipDeflate(filename, opts) {\n        var _this = this;\n        if (!opts)\n            opts = {};\n        ZipPassThrough.call(this, filename);\n        this.d = new AsyncDeflate(opts, function (err, dat, final) {\n            _this.ondata(err, dat, final);\n        });\n        this.compression = 8;\n        this.flag = dbf(opts.level);\n        this.terminate = this.d.terminate;\n    }\n    AsyncZipDeflate.prototype.process = function (chunk, final) {\n        this.d.push(chunk, final);\n    };\n    /**\n     * Pushes a chunk to be deflated\n     * @param chunk The chunk to push\n     * @param final Whether this is the last chunk\n     */\n    AsyncZipDeflate.prototype.push = function (chunk, final) {\n        ZipPassThrough.prototype.push.call(this, chunk, final);\n    };\n    return AsyncZipDeflate;\n}());\nexport { AsyncZipDeflate };\n// TODO: Better tree shaking\n/**\n * A zippable archive to which files can incrementally be added\n */\nvar Zip = /*#__PURE__*/ (function () {\n    /**\n     * Creates an empty ZIP archive to which files can be added\n     * @param cb The callback to call whenever data for the generated ZIP archive\n     *           is available\n     */\n    function Zip(cb) {\n        this.ondata = cb;\n        this.u = [];\n        this.d = 1;\n    }\n    /**\n     * Adds a file to the ZIP archive\n     * @param file The file stream to add\n     */\n    Zip.prototype.add = function (file) {\n        var _this = this;\n        if (!this.ondata)\n            err(5);\n        // finishing or finished\n        if (this.d & 2)\n            this.ondata(err(4 + (this.d & 1) * 8, 0, 1), null, false);\n        else {\n            var f = strToU8(file.filename), fl_1 = f.length;\n            var com = file.comment, o = com && strToU8(com);\n            var u = fl_1 != file.filename.length || (o && (com.length != o.length));\n            var hl_1 = fl_1 + exfl(file.extra) + 30;\n            if (fl_1 > 65535)\n                this.ondata(err(11, 0, 1), null, false);\n            var header = new u8(hl_1);\n            wzh(header, 0, file, f, u, -1);\n            var chks_1 = [header];\n            var pAll_1 = function () {\n                for (var _i = 0, chks_2 = chks_1; _i < chks_2.length; _i++) {\n                    var chk = chks_2[_i];\n                    _this.ondata(null, chk, false);\n                }\n                chks_1 = [];\n            };\n            var tr_1 = this.d;\n            this.d = 0;\n            var ind_1 = this.u.length;\n            var uf_1 = mrg(file, {\n                f: f,\n                u: u,\n                o: o,\n                t: function () {\n                    if (file.terminate)\n                        file.terminate();\n                },\n                r: function () {\n                    pAll_1();\n                    if (tr_1) {\n                        var nxt = _this.u[ind_1 + 1];\n                        if (nxt)\n                            nxt.r();\n                        else\n                            _this.d = 1;\n                    }\n                    tr_1 = 1;\n                }\n            });\n            var cl_1 = 0;\n            file.ondata = function (err, dat, final) {\n                if (err) {\n                    _this.ondata(err, dat, final);\n                    _this.terminate();\n                }\n                else {\n                    cl_1 += dat.length;\n                    chks_1.push(dat);\n                    if (final) {\n                        var dd = new u8(16);\n                        wbytes(dd, 0, 0x8074B50);\n                        wbytes(dd, 4, file.crc);\n                        wbytes(dd, 8, cl_1);\n                        wbytes(dd, 12, file.size);\n                        chks_1.push(dd);\n                        uf_1.c = cl_1, uf_1.b = hl_1 + cl_1 + 16, uf_1.crc = file.crc, uf_1.size = file.size;\n                        if (tr_1)\n                            uf_1.r();\n                        tr_1 = 1;\n                    }\n                    else if (tr_1)\n                        pAll_1();\n                }\n            };\n            this.u.push(uf_1);\n        }\n    };\n    /**\n     * Ends the process of adding files and prepares to emit the final chunks.\n     * This *must* be called after adding all desired files for the resulting\n     * ZIP file to work properly.\n     */\n    Zip.prototype.end = function () {\n        var _this = this;\n        if (this.d & 2) {\n            this.ondata(err(4 + (this.d & 1) * 8, 0, 1), null, true);\n            return;\n        }\n        if (this.d)\n            this.e();\n        else\n            this.u.push({\n                r: function () {\n                    if (!(_this.d & 1))\n                        return;\n                    _this.u.splice(-1, 1);\n                    _this.e();\n                },\n                t: function () { }\n            });\n        this.d = 3;\n    };\n    Zip.prototype.e = function () {\n        var bt = 0, l = 0, tl = 0;\n        for (var _i = 0, _a = this.u; _i < _a.length; _i++) {\n            var f = _a[_i];\n            tl += 46 + f.f.length + exfl(f.extra) + (f.o ? f.o.length : 0);\n        }\n        var out = new u8(tl + 22);\n        for (var _b = 0, _c = this.u; _b < _c.length; _b++) {\n            var f = _c[_b];\n            wzh(out, bt, f, f.f, f.u, -f.c - 2, l, f.o);\n            bt += 46 + f.f.length + exfl(f.extra) + (f.o ? f.o.length : 0), l += f.b;\n        }\n        wzf(out, bt, this.u.length, tl, l);\n        this.ondata(null, out, true);\n        this.d = 2;\n    };\n    /**\n     * A method to terminate any internal workers used by the stream. Subsequent\n     * calls to add() will fail.\n     */\n    Zip.prototype.terminate = function () {\n        for (var _i = 0, _a = this.u; _i < _a.length; _i++) {\n            var f = _a[_i];\n            f.t();\n        }\n        this.d = 2;\n    };\n    return Zip;\n}());\nexport { Zip };\nexport function zip(data, opts, cb) {\n    if (!cb)\n        cb = opts, opts = {};\n    if (typeof cb != 'function')\n        err(7);\n    var r = {};\n    fltn(data, '', r, opts);\n    var k = Object.keys(r);\n    var lft = k.length, o = 0, tot = 0;\n    var slft = lft, files = new Array(lft);\n    var term = [];\n    var tAll = function () {\n        for (var i = 0; i < term.length; ++i)\n            term[i]();\n    };\n    var cbd = function (a, b) {\n        mt(function () { cb(a, b); });\n    };\n    mt(function () { cbd = cb; });\n    var cbf = function () {\n        var out = new u8(tot + 22), oe = o, cdl = tot - o;\n        tot = 0;\n        for (var i = 0; i < slft; ++i) {\n            var f = files[i];\n            try {\n                var l = f.c.length;\n                wzh(out, tot, f, f.f, f.u, l);\n                var badd = 30 + f.f.length + exfl(f.extra);\n                var loc = tot + badd;\n                out.set(f.c, loc);\n                wzh(out, o, f, f.f, f.u, l, tot, f.m), o += 16 + badd + (f.m ? f.m.length : 0), tot = loc + l;\n            }\n            catch (e) {\n                return cbd(e, null);\n            }\n        }\n        wzf(out, o, files.length, cdl, oe);\n        cbd(null, out);\n    };\n    if (!lft)\n        cbf();\n    var _loop_1 = function (i) {\n        var fn = k[i];\n        var _a = r[fn], file = _a[0], p = _a[1];\n        var c = crc(), size = file.length;\n        c.p(file);\n        var f = strToU8(fn), s = f.length;\n        var com = p.comment, m = com && strToU8(com), ms = m && m.length;\n        var exl = exfl(p.extra);\n        var compression = p.level == 0 ? 0 : 8;\n        var cbl = function (e, d) {\n            if (e) {\n                tAll();\n                cbd(e, null);\n            }\n            else {\n                var l = d.length;\n                files[i] = mrg(p, {\n                    size: size,\n                    crc: c.d(),\n                    c: d,\n                    f: f,\n                    m: m,\n                    u: s != fn.length || (m && (com.length != ms)),\n                    compression: compression\n                });\n                o += 30 + s + exl + l;\n                tot += 76 + 2 * (s + exl) + (ms || 0) + l;\n                if (!--lft)\n                    cbf();\n            }\n        };\n        if (s > 65535)\n            cbl(err(11, 0, 1), null);\n        if (!compression)\n            cbl(null, file);\n        else if (size < 160000) {\n            try {\n                cbl(null, deflateSync(file, p));\n            }\n            catch (e) {\n                cbl(e, null);\n            }\n        }\n        else\n            term.push(deflate(file, p, cbl));\n    };\n    // Cannot use lft because it can decrease\n    for (var i = 0; i < slft; ++i) {\n        _loop_1(i);\n    }\n    return tAll;\n}\n/**\n * Synchronously creates a ZIP file. Prefer using `zip` for better performance\n * with more than one file.\n * @param data The directory structure for the ZIP archive\n * @param opts The main options, merged with per-file options\n * @returns The generated ZIP archive\n */\nexport function zipSync(data, opts) {\n    if (!opts)\n        opts = {};\n    var r = {};\n    var files = [];\n    fltn(data, '', r, opts);\n    var o = 0;\n    var tot = 0;\n    for (var fn in r) {\n        var _a = r[fn], file = _a[0], p = _a[1];\n        var compression = p.level == 0 ? 0 : 8;\n        var f = strToU8(fn), s = f.length;\n        var com = p.comment, m = com && strToU8(com), ms = m && m.length;\n        var exl = exfl(p.extra);\n        if (s > 65535)\n            err(11);\n        var d = compression ? deflateSync(file, p) : file, l = d.length;\n        var c = crc();\n        c.p(file);\n        files.push(mrg(p, {\n            size: file.length,\n            crc: c.d(),\n            c: d,\n            f: f,\n            m: m,\n            u: s != fn.length || (m && (com.length != ms)),\n            o: o,\n            compression: compression\n        }));\n        o += 30 + s + exl + l;\n        tot += 76 + 2 * (s + exl) + (ms || 0) + l;\n    }\n    var out = new u8(tot + 22), oe = o, cdl = tot - o;\n    for (var i = 0; i < files.length; ++i) {\n        var f = files[i];\n        wzh(out, f.o, f, f.f, f.u, f.c.length);\n        var badd = 30 + f.f.length + exfl(f.extra);\n        out.set(f.c, f.o + badd);\n        wzh(out, o, f, f.f, f.u, f.c.length, f.o, f.m), o += 16 + badd + (f.m ? f.m.length : 0);\n    }\n    wzf(out, o, files.length, cdl, oe);\n    return out;\n}\n/**\n * Streaming pass-through decompression for ZIP archives\n */\nvar UnzipPassThrough = /*#__PURE__*/ (function () {\n    function UnzipPassThrough() {\n    }\n    UnzipPassThrough.prototype.push = function (data, final) {\n        this.ondata(null, data, final);\n    };\n    UnzipPassThrough.compression = 0;\n    return UnzipPassThrough;\n}());\nexport { UnzipPassThrough };\n/**\n * Streaming DEFLATE decompression for ZIP archives. Prefer AsyncZipInflate for\n * better performance.\n */\nvar UnzipInflate = /*#__PURE__*/ (function () {\n    /**\n     * Creates a DEFLATE decompression that can be used in ZIP archives\n     */\n    function UnzipInflate() {\n        var _this = this;\n        this.i = new Inflate(function (dat, final) {\n            _this.ondata(null, dat, final);\n        });\n    }\n    UnzipInflate.prototype.push = function (data, final) {\n        try {\n            this.i.push(data, final);\n        }\n        catch (e) {\n            this.ondata(e, null, final);\n        }\n    };\n    UnzipInflate.compression = 8;\n    return UnzipInflate;\n}());\nexport { UnzipInflate };\n/**\n * Asynchronous streaming DEFLATE decompression for ZIP archives\n */\nvar AsyncUnzipInflate = /*#__PURE__*/ (function () {\n    /**\n     * Creates a DEFLATE decompression that can be used in ZIP archives\n     */\n    function AsyncUnzipInflate(_, sz) {\n        var _this = this;\n        if (sz < 320000) {\n            this.i = new Inflate(function (dat, final) {\n                _this.ondata(null, dat, final);\n            });\n        }\n        else {\n            this.i = new AsyncInflate(function (err, dat, final) {\n                _this.ondata(err, dat, final);\n            });\n            this.terminate = this.i.terminate;\n        }\n    }\n    AsyncUnzipInflate.prototype.push = function (data, final) {\n        if (this.i.terminate)\n            data = slc(data, 0);\n        this.i.push(data, final);\n    };\n    AsyncUnzipInflate.compression = 8;\n    return AsyncUnzipInflate;\n}());\nexport { AsyncUnzipInflate };\n/**\n * A ZIP archive decompression stream that emits files as they are discovered\n */\nvar Unzip = /*#__PURE__*/ (function () {\n    /**\n     * Creates a ZIP decompression stream\n     * @param cb The callback to call whenever a file in the ZIP archive is found\n     */\n    function Unzip(cb) {\n        this.onfile = cb;\n        this.k = [];\n        this.o = {\n            0: UnzipPassThrough\n        };\n        this.p = et;\n    }\n    /**\n     * Pushes a chunk to be unzipped\n     * @param chunk The chunk to push\n     * @param final Whether this is the last chunk\n     */\n    Unzip.prototype.push = function (chunk, final) {\n        var _this = this;\n        if (!this.onfile)\n            err(5);\n        if (!this.p)\n            err(4);\n        if (this.c > 0) {\n            var len = Math.min(this.c, chunk.length);\n            var toAdd = chunk.subarray(0, len);\n            this.c -= len;\n            if (this.d)\n                this.d.push(toAdd, !this.c);\n            else\n                this.k[0].push(toAdd);\n            chunk = chunk.subarray(len);\n            if (chunk.length)\n                return this.push(chunk, final);\n        }\n        else {\n            var f = 0, i = 0, is = void 0, buf = void 0;\n            if (!this.p.length)\n                buf = chunk;\n            else if (!chunk.length)\n                buf = this.p;\n            else {\n                buf = new u8(this.p.length + chunk.length);\n                buf.set(this.p), buf.set(chunk, this.p.length);\n            }\n            var l = buf.length, oc = this.c, add = oc && this.d;\n            var _loop_2 = function () {\n                var _a;\n                var sig = b4(buf, i);\n                if (sig == 0x4034B50) {\n                    f = 1, is = i;\n                    this_1.d = null;\n                    this_1.c = 0;\n                    var bf = b2(buf, i + 6), cmp_1 = b2(buf, i + 8), u = bf & 2048, dd = bf & 8, fnl = b2(buf, i + 26), es = b2(buf, i + 28);\n                    if (l > i + 30 + fnl + es) {\n                        var chks_3 = [];\n                        this_1.k.unshift(chks_3);\n                        f = 2;\n                        var sc_1 = b4(buf, i + 18), su_1 = b4(buf, i + 22);\n                        var fn_1 = strFromU8(buf.subarray(i + 30, i += 30 + fnl), !u);\n                        if (sc_1 == 4294967295) {\n                            _a = dd ? [-2] : z64e(buf, i), sc_1 = _a[0], su_1 = _a[1];\n                        }\n                        else if (dd)\n                            sc_1 = -1;\n                        i += es;\n                        this_1.c = sc_1;\n                        var d_1;\n                        var file_1 = {\n                            name: fn_1,\n                            compression: cmp_1,\n                            start: function () {\n                                if (!file_1.ondata)\n                                    err(5);\n                                if (!sc_1)\n                                    file_1.ondata(null, et, true);\n                                else {\n                                    var ctr = _this.o[cmp_1];\n                                    if (!ctr)\n                                        file_1.ondata(err(14, 'unknown compression type ' + cmp_1, 1), null, false);\n                                    d_1 = sc_1 < 0 ? new ctr(fn_1) : new ctr(fn_1, sc_1, su_1);\n                                    d_1.ondata = function (err, dat, final) { file_1.ondata(err, dat, final); };\n                                    for (var _i = 0, chks_4 = chks_3; _i < chks_4.length; _i++) {\n                                        var dat = chks_4[_i];\n                                        d_1.push(dat, false);\n                                    }\n                                    if (_this.k[0] == chks_3 && _this.c)\n                                        _this.d = d_1;\n                                    else\n                                        d_1.push(et, true);\n                                }\n                            },\n                            terminate: function () {\n                                if (d_1 && d_1.terminate)\n                                    d_1.terminate();\n                            }\n                        };\n                        if (sc_1 >= 0)\n                            file_1.size = sc_1, file_1.originalSize = su_1;\n                        this_1.onfile(file_1);\n                    }\n                    return \"break\";\n                }\n                else if (oc) {\n                    if (sig == 0x8074B50) {\n                        is = i += 12 + (oc == -2 && 8), f = 3, this_1.c = 0;\n                        return \"break\";\n                    }\n                    else if (sig == 0x2014B50) {\n                        is = i -= 4, f = 3, this_1.c = 0;\n                        return \"break\";\n                    }\n                }\n            };\n            var this_1 = this;\n            for (; i < l - 4; ++i) {\n                var state_1 = _loop_2();\n                if (state_1 === \"break\")\n                    break;\n            }\n            this.p = et;\n            if (oc < 0) {\n                var dat = f ? buf.subarray(0, is - 12 - (oc == -2 && 8) - (b4(buf, is - 16) == 0x8074B50 && 4)) : buf.subarray(0, i);\n                if (add)\n                    add.push(dat, !!f);\n                else\n                    this.k[+(f == 2)].push(dat);\n            }\n            if (f & 2)\n                return this.push(buf.subarray(i), final);\n            this.p = buf.subarray(i);\n        }\n        if (final) {\n            if (this.c)\n                err(13);\n            this.p = null;\n        }\n    };\n    /**\n     * Registers a decoder with the stream, allowing for files compressed with\n     * the compression type provided to be expanded correctly\n     * @param decoder The decoder constructor\n     */\n    Unzip.prototype.register = function (decoder) {\n        this.o[decoder.compression] = decoder;\n    };\n    return Unzip;\n}());\nexport { Unzip };\nvar mt = typeof queueMicrotask == 'function' ? queueMicrotask : typeof setTimeout == 'function' ? setTimeout : function (fn) { fn(); };\nexport function unzip(data, opts, cb) {\n    if (!cb)\n        cb = opts, opts = {};\n    if (typeof cb != 'function')\n        err(7);\n    var term = [];\n    var tAll = function () {\n        for (var i = 0; i < term.length; ++i)\n            term[i]();\n    };\n    var files = {};\n    var cbd = function (a, b) {\n        mt(function () { cb(a, b); });\n    };\n    mt(function () { cbd = cb; });\n    var e = data.length - 22;\n    for (; b4(data, e) != 0x6054B50; --e) {\n        if (!e || data.length - e > 65558) {\n            cbd(err(13, 0, 1), null);\n            return tAll;\n        }\n    }\n    ;\n    var lft = b2(data, e + 8);\n    if (lft) {\n        var c = lft;\n        var o = b4(data, e + 16);\n        var z = o == 4294967295 || c == 65535;\n        if (z) {\n            var ze = b4(data, e - 12);\n            z = b4(data, ze) == 0x6064B50;\n            if (z) {\n                c = lft = b4(data, ze + 32);\n                o = b4(data, ze + 48);\n            }\n        }\n        var fltr = opts && opts.filter;\n        var _loop_3 = function (i) {\n            var _a = zh(data, o, z), c_1 = _a[0], sc = _a[1], su = _a[2], fn = _a[3], no = _a[4], off = _a[5], b = slzh(data, off);\n            o = no;\n            var cbl = function (e, d) {\n                if (e) {\n                    tAll();\n                    cbd(e, null);\n                }\n                else {\n                    if (d)\n                        files[fn] = d;\n                    if (!--lft)\n                        cbd(null, files);\n                }\n            };\n            if (!fltr || fltr({\n                name: fn,\n                size: sc,\n                originalSize: su,\n                compression: c_1\n            })) {\n                if (!c_1)\n                    cbl(null, slc(data, b, b + sc));\n                else if (c_1 == 8) {\n                    var infl = data.subarray(b, b + sc);\n                    // Synchronously decompress under 512KB, or barely-compressed data\n                    if (su < 524288 || sc > 0.8 * su) {\n                        try {\n                            cbl(null, inflateSync(infl, { out: new u8(su) }));\n                        }\n                        catch (e) {\n                            cbl(e, null);\n                        }\n                    }\n                    else\n                        term.push(inflate(infl, { size: su }, cbl));\n                }\n                else\n                    cbl(err(14, 'unknown compression type ' + c_1, 1), null);\n            }\n            else\n                cbl(null, null);\n        };\n        for (var i = 0; i < c; ++i) {\n            _loop_3(i);\n        }\n    }\n    else\n        cbd(null, {});\n    return tAll;\n}\n/**\n * Synchronously decompresses a ZIP archive. Prefer using `unzip` for better\n * performance with more than one file.\n * @param data The raw compressed ZIP file\n * @param opts The ZIP extraction options\n * @returns The decompressed files\n */\nexport function unzipSync(data, opts) {\n    var files = {};\n    var e = data.length - 22;\n    for (; b4(data, e) != 0x6054B50; --e) {\n        if (!e || data.length - e > 65558)\n            err(13);\n    }\n    ;\n    var c = b2(data, e + 8);\n    if (!c)\n        return {};\n    var o = b4(data, e + 16);\n    var z = o == 4294967295 || c == 65535;\n    if (z) {\n        var ze = b4(data, e - 12);\n        z = b4(data, ze) == 0x6064B50;\n        if (z) {\n            c = b4(data, ze + 32);\n            o = b4(data, ze + 48);\n        }\n    }\n    var fltr = opts && opts.filter;\n    for (var i = 0; i < c; ++i) {\n        var _a = zh(data, o, z), c_2 = _a[0], sc = _a[1], su = _a[2], fn = _a[3], no = _a[4], off = _a[5], b = slzh(data, off);\n        o = no;\n        if (!fltr || fltr({\n            name: fn,\n            size: sc,\n            originalSize: su,\n            compression: c_2\n        })) {\n            if (!c_2)\n                files[fn] = slc(data, b, b + sc);\n            else if (c_2 == 8)\n                files[fn] = inflateSync(data.subarray(b, b + sc), { out: new u8(su) });\n            else\n                err(14, 'unknown compression type ' + c_2);\n        }\n    }\n    return files;\n}\n","import util from 'util';\nimport zlib from 'zlib';\nimport { zlibSync } from 'fflate';\nimport nodeCrypto from 'crypto';\n\nimport { StartCanvasInfo } from '../download.js';\nimport { PdfDictionary } from './common.js';\nimport log from '../log.js';\nimport { runningInNode } from '../util.js';\n\n// Browsers have native encoders/decoders in the global namespace, use these\nexport let textEncoder: TextEncoder | util.TextEncoder;\nexport let textDecoder: TextDecoder | util.TextDecoder;\nif (typeof TextEncoder !== 'undefined' && typeof TextDecoder !== 'undefined') {\n  textEncoder = new TextEncoder();\n  textDecoder = new TextDecoder();\n} else {\n  textEncoder = new util.TextEncoder();\n  textDecoder = new util.TextDecoder();\n}\n\n// If running in node, use the web compatible crypto implementation\nlet cryptoImpl: Crypto;\nif (runningInNode()) {\n  cryptoImpl = nodeCrypto.webcrypto as Crypto;\n} else {\n  cryptoImpl = crypto;\n}\n\nexport const IS_BIG_ENDIAN = (() => {\n  const array = new Uint8Array(4);\n  const view = new Uint32Array(array.buffer);\n  return !((view[0] = 1) & array[0]);\n})();\n\nexport interface TocItem {\n  label: string;\n  children?: Array<TocItem>;\n  startCanvas: StartCanvasInfo;\n}\n\nexport function getNumChildren(itm: TocItem): number {\n  const children = itm.children ?? [];\n  return (\n    children.length + children.map(getNumChildren).reduce((a, b) => a + b, 0)\n  );\n}\n\nexport function randomData(length: number): Uint8Array {\n  if (length > 2 ** 16) {\n    length = 2 ** 16;\n  }\n  const buf = new Uint8Array(length);\n  if (cryptoImpl !== undefined) {\n    cryptoImpl.getRandomValues(buf);\n  } else {\n    const u32View = new Uint32Array(buf.buffer);\n    for (let i = 0; i < u32View.length; i++) {\n      u32View[i] = Math.floor(Math.random() * 2 ** 32);\n    }\n  }\n  return buf;\n}\n\nexport async function tryDeflateStream(\n  pdfStream: Uint8Array | string\n): Promise<{ stream: Uint8Array | string; dict: PdfDictionary }> {\n  const data =\n    pdfStream instanceof Uint8Array ? pdfStream : textEncoder.encode(pdfStream);\n  let compressed: Uint8Array;\n  if (!runningInNode()) {\n    if (typeof CompressionStream === 'undefined') {\n      // Browser doesn't support CompressionStream API, try to use the JS implementation\n      try {\n        let bytes: Uint8Array;\n        if (pdfStream instanceof Uint8Array) {\n          bytes = pdfStream;\n        } else {\n          bytes = textEncoder.encode(pdfStream);\n        }\n        compressed = zlibSync(bytes);\n        return Promise.resolve({\n          stream: compressed,\n          dict: { Length: compressed.length, Filter: '/FlateDecode' },\n        });\n      } catch (err) {\n        log.warn(\n          `Failed to use JS deflate implementation, data will be written uncompressed: ${err}`\n        );\n        return Promise.resolve({\n          stream: pdfStream,\n          dict: { Length: pdfStream.length },\n        });\n      }\n    }\n    const compStream = new CompressionStream('deflate');\n    const c = new Blob([data]).stream().pipeThrough(compStream);\n    compressed = new Uint8Array(await new Response(c).arrayBuffer());\n  } else {\n    compressed = await new Promise((resolve, reject) =>\n      zlib.deflate(data, (err, buf) => (err ? reject(err) : resolve(buf)))\n    );\n  }\n  return {\n    dict: {\n      Length: compressed.length,\n      Filter: '/FlateDecode',\n    },\n    stream: compressed,\n  };\n}\n","import { IS_BIG_ENDIAN } from './util.js';\n\nconst PDF_INDENTATION = 2;\n\nexport interface Metadata {\n  Producer?: string;\n  Creator?: string;\n  CreationDate?: Date;\n  Title?: string;\n  Author?: string;\n  Keywords?: string;\n  ModDate?: Date;\n}\n\nexport interface PdfObject {\n  num: number;\n  data?: PdfValue;\n  stream?: Uint8Array | string;\n}\n\nexport class PdfRef {\n  refObj: number;\n\n  constructor(num: number) {\n    this.refObj = num;\n  }\n}\nexport type PdfPrimitive =\n  | string\n  | number\n  | boolean\n  | Uint8Array\n  | null\n  | Date\n  | PdfRef;\nexport interface PdfDictionary {\n  [member: string]: PdfPrimitive | PdfArray | PdfDictionary;\n}\nexport type PdfArray = Array<PdfPrimitive | PdfArray | PdfDictionary>;\nexport type PdfValue = PdfPrimitive | PdfDictionary | PdfArray | null;\n\nexport interface PdfAnnotation {\n  Type: 'Annot';\n  Subtype: string;\n  Rect: [number, number, number, number];\n  Contents: string | undefined;\n  P?: PdfRef;\n  NM?: string;\n  M?: Date;\n  F?: number;\n  AP?: PdfDictionary;\n  AS?: string;\n  Border?: [number, number, number] | [number, number, number, number];\n  C?:\n    | []\n    | [number]\n    | [number, number, number]\n    | [number, number, number, number];\n}\n\nexport interface StructTreeEntry {\n  type: 'Sect' | 'P' | 'Span';\n  children: Array<StructTreeEntry>; // Only for `Sect` and `P` entries\n  pageObjNum: number;\n  mcs: Array<number>; // Only for `Span` entries\n}\n\nexport function makeRef(target: number | PdfObject): PdfRef {\n  const num = typeof target === 'number' ? target : target.num;\n  return new PdfRef(num);\n}\n\nfunction isUnicode(str: string): boolean {\n  for (let i = 0, end = str.length; i < end; i++) {\n    if (str.charCodeAt(i) > 0x7f) {\n      return true;\n    }\n  }\n  return false;\n}\n\n/** Convert a JS UTF8 string to a UTF16 Big Endian string */\nexport function toUTF16BE(str: string, includeBom = true): Uint8Array {\n  const buf = new Uint16Array(str.length + (includeBom ? 1 : 0));\n  for (let i = includeBom ? 1 : 0; i < buf.length; i++) {\n    buf[i] = str.charCodeAt(i - (includeBom ? 1 : 0));\n  }\n  const outBuf = new Uint8Array(buf.buffer, buf.byteOffset, buf.byteLength);\n  if (!IS_BIG_ENDIAN) {\n    // PDF needs UTF16-BE, so in little endian systems we need to swap each\n    // codepoint's byte pair\n    for (let i = includeBom ? 2 : 0, end = outBuf.length - 1; i < end; i += 2) {\n      const a = outBuf[i];\n      outBuf[i] = outBuf[i + 1];\n      outBuf[i + 1] = a;\n    }\n  }\n  // UTF16BE BOM\n  if (includeBom) {\n    outBuf[0] = 254;\n    outBuf[1] = 255;\n  }\n  return outBuf;\n}\n\nfunction safeNumber(num: number): number {\n  if (num > -1e21 && num < 1e21) {\n    return Math.round(num * 1e6) / 1e6;\n  }\n  throw new Error(`unsupported number: ${num}`);\n}\n\nexport function serialize(value: PdfValue, dictIndent = 0): string {\n  if (typeof value === 'string') {\n    if (\n      value[0] === '(' &&\n      value[value.length - 1] === ')' &&\n      isUnicode(value)\n    ) {\n      return serialize(toUTF16BE(value.substring(1, value.length - 1)));\n    }\n    return value;\n  } else if (value instanceof Uint8Array) {\n    return `<${Array.from(value)\n      .map((x) => x.toString(16).padStart(2, '0').toUpperCase())\n      .join('')}>`;\n  } else if (value instanceof Date) {\n    const dateString =\n      `D:${value.getUTCFullYear().toString(10).padStart(4, '0')}` +\n      (value.getUTCMonth() + 1).toString(10).padStart(2, '0') +\n      value.getUTCDate().toString(10).padStart(2, '0') +\n      value.getUTCHours().toString(10).padStart(2, '0') +\n      value.getUTCMinutes().toString(10).padStart(2, '0') +\n      value.getUTCSeconds().toString(10).padStart(2, '0') +\n      'Z';\n    return `(${dateString})`;\n  } else if (Array.isArray(value)) {\n    return `[${value.map((v) => serialize(v, dictIndent + 1)).join(' ')}]`;\n  } else if (value instanceof PdfRef) {\n    if (value.refObj === -1) {\n      throw new Error('Cannot serialize a deferred object reference');\n    }\n    return `${value.refObj} 0 R`;\n  } else if ({}.toString.call(value) === '[object Object]') {\n    const outsideIndent = ' '.repeat(PDF_INDENTATION * dictIndent);\n    const insideIndent = outsideIndent + ' '.repeat(PDF_INDENTATION);\n    return `<<\\n${Object.entries(value as any)\n      .map(\n        ([k, v]) =>\n          `${insideIndent}/${k} ${serialize(v as any, dictIndent + 1)}`\n      )\n      .join('\\n')}\\n${outsideIndent}>>`;\n  } else if (typeof value === 'number') {\n    return safeNumber(value).toString(10);\n  } else {\n    return `${value}`;\n  }\n}\n","/** Types for writing to an output stream, with support for Node and Browsers. */\nimport type { Writable as NodeWritable } from 'stream';\nimport type nodeFs from 'fs';\n\nimport log from './log.js';\n\n/** Base interface to be implemented by all readers.  */\nexport interface Reader {\n  read(\n    dst: Uint8Array,\n    offset: number,\n    position: number,\n    length: number\n  ): Promise<number>;\n  size(): Promise<number>;\n}\n\n/** Base interface to be implemented by all writers. */\nexport interface Writer {\n  /** Write a chunk to the writer */\n  write(buffer: Uint8Array | string): Promise<void>;\n\n  /** Close the writer */\n  close(): Promise<void>;\n\n  /** Wait for the next drainage/flush event */\n  waitForDrain(): Promise<void>;\n}\n\n/** Reader implementation using the Web `File` API.  */\nexport class WebReader implements Reader {\n  private file: File;\n\n  constructor(file: File) {\n    this.file = file;\n  }\n\n  async read(\n    dst: Uint8Array,\n    offset: number,\n    position: number,\n    length: number\n  ): Promise<number> {\n    const blob = this.file.slice(position, position + length);\n    const buf = await blob.arrayBuffer();\n    dst.set(new Uint8Array(buf), offset);\n    return buf.byteLength;\n  }\n\n  size(): Promise<number> {\n    return new Promise((resolve) => resolve(this.file.size));\n  }\n}\n\n/** Wraps a writer and counts the bytes written to it. */\nexport class CountingWriter implements Writer {\n  private _writer: Writer;\n  bytesWritten = 0;\n\n  constructor(writer: Writer) {\n    this._writer = writer;\n  }\n\n  write(buffer: string | Uint8Array): Promise<void> {\n    this.bytesWritten += buffer.length;\n    return this._writer.write(buffer);\n  }\n\n  close(): Promise<void> {\n    return this._writer.close();\n  }\n\n  waitForDrain(): Promise<void> {\n    return this._writer.waitForDrain();\n  }\n}\n\n/** A Writer implemented using the `File System Access API` available in\n *  recent Chrome, Edge and Opera browsers. */\nexport class WebWriter implements Writer {\n  private _writer: WritableStreamDefaultWriter<any>;\n\n  constructor(stream: WritableStream) {\n    this._writer = stream.getWriter();\n  }\n\n  write(buffer: string | Uint8Array): Promise<void> {\n    return this._writer.write(buffer);\n  }\n\n  waitForDrain(): Promise<void> {\n    return this._writer.ready;\n  }\n\n  close(): Promise<void> {\n    return this._writer.close();\n  }\n}\n\n\n/** Writer implementation using the `Blob` API available in all browsers. */\nexport class BlobWriter implements Writer {\n  // TODO: A good reference seems to be the mega.nz implementation, which has always worked great for me on desktops at least:\n  // https://github.com/meganz/webclient/blob/f19289127b68ceaf19a5e884f2f48f15078304da/js/transfers/meths/memory.js\n  private _parts: Array<Uint8Array | string>;\n  private _blob?: Blob;\n\n  constructor() {\n    this._parts = [];\n  }\n\n  write(buffer: string | Uint8Array): Promise<void> {\n    if (this._blob) {\n      return Promise.reject('Cannot write to closed BlobWriter.');\n    }\n    this._parts.push(buffer);\n    return Promise.resolve();\n  }\n\n  waitForDrain(): Promise<void> {\n    if (this._blob) {\n      return Promise.reject('Cannot wait on a closed BlobWriter.');\n    }\n    return Promise.resolve();\n  }\n\n  close(): Promise<void> {\n    if (this._blob) {\n      return Promise.reject('BlobWriter is already closed');\n    }\n    this._blob = new Blob(this._parts);\n    this._parts = [];\n    return Promise.resolve();\n  }\n\n  get blob(): Blob {\n    if (!this._blob) {\n      throw 'BlobWriter must be closed first!';\n    }\n    return this._blob;\n  }\n}\n\n/** Reader implentation using the node.js filesystem API. */\nexport class NodeReader implements Reader {\n  private fileHandle: nodeFs.promises.FileHandle;\n\n  constructor(handle: nodeFs.promises.FileHandle) {\n    this.fileHandle = handle;\n  }\n\n  async read(\n    dst: Uint8Array,\n    offset: number,\n    position: number,\n    length: number\n  ): Promise<number> {\n    const { bytesRead } = await this.fileHandle.read(\n      dst,\n      offset,\n      length,\n      position\n    );\n    return bytesRead;\n  }\n\n  async size(): Promise<number> {\n    const stat = await this.fileHandle.stat();\n    return stat.size;\n  }\n}\n/** Writer implementation using the node.js filesystem API. */\nexport class NodeWriter implements Writer {\n  _writable: NodeWritable;\n  _drainWaiters: Array<() => void> = [];\n\n  constructor(writable: NodeWritable) {\n    this._writable = writable;\n    this._writable.on('drain', () => {\n      log.debug('Drained writer.');\n      for (const waiter of this._drainWaiters) {\n        waiter();\n      }\n      this._drainWaiters = [];\n    });\n    this._writable.on('close', () => {\n      for (const waiter of this._drainWaiters) {\n        waiter();\n      }\n      this._drainWaiters = [];\n    });\n  }\n\n  async write(buffer: string | Uint8Array): Promise<void> {\n    let waitForDrain = false;\n    const out = new Promise<void>((resolve, reject) => {\n      if (!this._writable.writable) {\n        reject('Cannot write to closed NodeWriter.');\n      }\n      waitForDrain = !this._writable.write(buffer, (err) =>\n        err ? reject(err) : resolve()\n      );\n    });\n    if (waitForDrain) {\n      log.debug('Waiting for writer to drain');\n      return await this.waitForDrain();\n    } else {\n      return await out;\n    }\n  }\n\n  waitForDrain(): Promise<void> {\n    return new Promise((resolve) => this._drainWaiters.push(resolve));\n  }\n\n  close(): Promise<void> {\n    return new Promise((resolve) => this._writable.end(() => resolve()));\n  }\n}\n\n/** Very basic Reader implementation using an Array. */\nexport class ArrayReader implements Reader {\n  _buf: Uint8Array;\n\n  constructor(buf: Uint8Array) {\n    this._buf = buf;\n  }\n\n  read(\n    dst: Uint8Array,\n    offset: number,\n    position: number,\n    length: number\n  ): Promise<number> {\n    const sub = this._buf.subarray(position, position + length);\n    dst.set(sub, offset);\n    return Promise.resolve(sub.length);\n  }\n\n  size(): Promise<number> {\n    return Promise.resolve(this._buf.length);\n  }\n}\n","/*\nTaken from Hopding/png-ts, which is a TypeScript port by Andrew Dillon of the\nPNG decoder from pdfkit written by Devon Govett.\nThe original code can be found at:\nhttps://github.com/Hopding/png-ts/blob/master/src/png.ts\n\nModified by me (@jbaiter):\n- use `fflate` instead of `pako` for decompression.\n- add support for decoding interlaced images\n\nMIT License\n\nCopyright (c) 2018 Andrew Dillon\nCopyright (c) 2017 Devon Govett\n\nPermission is hereby granted, free of charge, to any person obtaining a copy\nof this software and associated documentation files (the \"Software\"), to deal\nin the Software without restriction, including without limitation the rights\nto use, copy, modify, merge, publish, distribute, sublicense, and/or sell\ncopies of the Software, and to permit persons to whom the Software is\nfurnished to do so, subject to the following conditions:\n\nThe above copyright notice and this permission notice shall be included in all\ncopies or substantial portions of the Software.\n\nTHE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\nIMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\nFITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\nAUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\nLIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\nOUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\nSOFTWARE.\n*/\nimport { unzipSync, unzlibSync } from \"fflate\";\n\nexport type ColorSpace = 'DeviceGray' | 'DeviceRGB';\n\nexport default class PNG {\n  static load = (data: Uint8Array) => new PNG(data);\n\n  palette: number[];\n  imgData: Uint8Array;\n  transparency: {\n    indexed?: number[];\n    grayscale?: number;\n    rgb?: number[];\n  };\n  text: { [key: string]: string };\n  width!: number;\n  height!: number;\n  bits!: number;\n  colorType!: number;\n  compressionMethod!: number;\n  filterMethod!: number;\n  interlaceMethod!: number;\n  colors: 1 | 3;\n  hasAlphaChannel: boolean;\n  pixelBitlength: number;\n  colorSpace: ColorSpace;\n\n  private data: Uint8Array;\n  private pos: number;\n\n  constructor(data: Uint8Array) {\n    this.data = data;\n    this.pos = 8; // Skip the default header;\n\n    this.palette = [];\n    const imgDataBuff = [];\n    this.transparency = {};\n    this.text = {};\n\n    while (true) {\n      const chunkSize = this.readUInt32();\n\n      let section = '';\n      for (let i = 0; i < 4; i++) {\n        section += String.fromCharCode(this.data[this.pos++]);\n      }\n\n      switch (section) {\n        case 'IHDR': {\n          // We can grab interesting values from here (like width, height, etc...)\n          this.width = this.readUInt32();\n          this.height = this.readUInt32();\n          this.bits = this.data[this.pos++];\n          this.colorType = this.data[this.pos++];\n          this.compressionMethod = this.data[this.pos++];\n          this.filterMethod = this.data[this.pos++];\n          this.interlaceMethod = this.data[this.pos++];\n          break;\n        }\n\n        case 'PLTE': {\n          this.palette = this.read(chunkSize);\n          break;\n        }\n\n        case 'IDAT': {\n          for (let i = 0; i < chunkSize; i++) {\n            imgDataBuff.push(this.data[this.pos++]);\n          }\n          break;\n        }\n\n        case 'tRNS': {\n          // This chunk can only occur once and it must occur after the\n          // PLTE chunk and before the IDAT chunk.\n          this.transparency = {};\n          switch (this.colorType) {\n            case 3: {\n              // Indexed color, RGB. Each byte in this chunk is an alpha for the\n              // palette index in the PLTE (\"palette\") chunk up until the last\n              // non-opaque entry. Set up an array, stretching over all palette\n              // entries which will be 0 (opaque) or 1 (transparent).\n              this.transparency.indexed = this.read(chunkSize);\n              const short = 255 - this.transparency.indexed.length;\n              if (short > 0) {\n                for (let i = 0; i < 255; i++) {\n                  this.transparency.indexed.push(255);\n                }\n              }\n              break;\n            }\n            case 0: {\n              // Greyscale. Corresponding to entries in the PLTE chunk.\n              // Grey is two bytes, range 0 .. (2 ^ bit-depth) - 1\n              this.transparency.grayscale = this.read(chunkSize)[0];\n              break;\n            }\n            case 2: {\n              // True color with proper alpha channel.\n              this.transparency.rgb = this.read(chunkSize);\n              break;\n            }\n          }\n          break;\n        }\n\n        case 'tEXt': {\n          const text = this.read(chunkSize);\n          const index = text.indexOf(0);\n          const key = String.fromCharCode(...text.slice(0, index));\n          this.text[key] = String.fromCharCode(...text.slice(index + 1));\n          break;\n        }\n\n        case 'IEND': {\n          // We've got everything we need!\n          const colorTypeMap: { [colorType: number]: 1 | 3 } = {\n            0: 1,\n            3: 1,\n            4: 1,\n            2: 3,\n            6: 3,\n          };\n          this.colors = colorTypeMap[this.colorType];\n\n          this.hasAlphaChannel = [4, 6].includes(this.colorType);\n          const colors = this.colors + (this.hasAlphaChannel ? 1 : 0);\n          this.pixelBitlength = this.bits * colors;\n          this.colorSpace = {\n            1: 'DeviceGray',\n            3: 'DeviceRGB',\n          }[this.colors] as ColorSpace;\n          this.imgData = new Uint8Array(imgDataBuff);\n\n          return;\n        }\n\n        default: {\n          // Unknown (or unimportant) section, skip it\n          this.pos += chunkSize;\n        }\n      }\n\n      this.pos += 4; // Skip the CRC\n      if (this.pos > this.data.length) {\n        throw new Error('Incomplete or corrupt PNG file');\n      }\n    }\n  }\n\n  decode = () => {\n    const retVal = new Uint8Array(this.width * this.height * 4);\n    const pixels = this.decodePixels();\n    this.copyImageDataToBuffer(retVal, pixels);\n    return retVal;\n  };\n\n  copyImageDataToBuffer = (imageData: Uint8Array, pixels: Uint8Array): void => {\n    let colors: 1 | 3 | 4 = this.colors;\n    let palette;\n    let alpha = this.hasAlphaChannel;\n\n    if (this.palette.length) {\n      palette = this.decodePalette();\n      colors = 4;\n      alpha = true;\n    }\n\n    const data = imageData;\n    const length = data.length;\n    const input = palette || pixels;\n\n    let i = 0;\n    let j = 0;\n\n    if (colors === 1) {\n      while (i < length) {\n        let k = palette ? pixels[i / 4] * 4 : j;\n        const v = input[k++];\n        data[i++] = v;\n        data[i++] = v;\n        data[i++] = v;\n        data[i++] = alpha ? input[k++] : 255;\n        j = k;\n      }\n    } else {\n      while (i < length) {\n        let k = palette ? pixels[i / 4] * 4 : j;\n        data[i++] = input[k++];\n        data[i++] = input[k++];\n        data[i++] = input[k++];\n        data[i++] = alpha ? input[k++] : 255;\n        j = k;\n      }\n    }\n  };\n\n  decodePixels = (): Uint8Array => {\n    const data = unzlibSync(this.imgData);\n\n    const width = this.width;\n    const height = this.height;\n    const pixelBytes = this.pixelBitlength / 8;\n    const scanlineLength = pixelBytes * this.width;\n\n    const pixels = new Uint8Array(scanlineLength * this.height);\n    const length = data.length;\n    let row = 0;\n    let pos = 0;\n    let c = 0;\n\n    function pass(x0: number, y0: number, dx: number, dy: number, singlePass = false): void {\n      const w = Math.ceil((width - x0) / dx);\n      const h = Math.ceil((height - y0) / dy);\n      const scanlineLength = pixelBytes * w;\n      const buffer = singlePass ? pixels : new Uint8Array(scanlineLength * h);\n      let row = 0;\n      let c = 0;\n      while (row < h && pos < length) {\n        switch (data[pos++]) {\n          case 0: // None\n            for (let i = 0; i < scanlineLength; i++) {\n              buffer[c++] = data[pos++];\n            }\n            break;\n          case 1: // Sub\n            for (let i = 0; i < scanlineLength; i++) {\n              const byte = data[pos++];\n              const left = i < pixelBytes ? 0 : buffer[c - pixelBytes];\n              buffer[c++] = (byte + left) % 256;\n            }\n            break;\n          case 2: // Up\n            for (let i = 0; i < scanlineLength; i++) {\n              const byte = data[pos++];\n              const col = (i - (i % pixelBytes)) / pixelBytes;\n              const pixelsIdx = (row - 1) * scanlineLength + col * pixelBytes + (i % pixelBytes);\n              const upper = row && buffer[pixelsIdx];\n              buffer[c++] = (upper + byte) % 256;\n            }\n            break;\n          case 3: // Average\n            for (let i = 0; i < scanlineLength; i++) {\n              const byte = data[pos++];\n              const col = (i - (i % pixelBytes)) / pixelBytes;\n              const left = i < pixelBytes ? 0 : buffer[c - pixelBytes];\n              const pixelsIdx = (row - 1) * scanlineLength + col * pixelBytes + (i % pixelBytes);\n              const upper = row && buffer[pixelsIdx];\n              buffer[c++] = (byte + Math.floor((left + upper) / 2)) % 256;\n            }\n            break;\n          case 4: // Paeth\n            for (let i = 0; i < scanlineLength; i++) {\n              const byte = data[pos++];\n              const col = (i - (i % pixelBytes)) / pixelBytes;\n              const left = i < pixelBytes ? 0 : buffer[c - pixelBytes];\n              let upper;\n              let upperLeft;\n              if (row === 0) {\n                upper = upperLeft = 0;\n              } else {\n                const upperIdx = (row - 1) * scanlineLength + col * pixelBytes + (i % pixelBytes);\n                const upperLeftIdx = (row - 1) * scanlineLength + (col - 1) * pixelBytes + (i % pixelBytes);\n                upper = buffer[upperIdx];\n                upperLeft = col && buffer[upperLeftIdx];\n              }\n              const p = left + upper - upperLeft;\n              const pa = Math.abs(p - left);\n              const pb = Math.abs(p - upper);\n              const pc = Math.abs(p - upperLeft);\n              let paeth;\n              if (pa <= pb && pa <= pc) {\n                paeth = left;\n              } else if (pb <= pc) {\n                paeth = upper;\n              } else {\n                paeth = upperLeft;\n              }\n              buffer[c++] = (byte + paeth) % 256;\n            }\n            break;\n          default:\n            throw new Error(`Invalid filter algorithm: ${data[pos - 1]}`);\n          }\n\n          if (!singlePass) {\n            let pixelsPos = ((y0 + row * dy) * width + x0) * pixelBytes;\n            let bufferPos = row * scanlineLength;\n            for (let i = 0; i < w; i++) {\n              for (let j = 0; j < pixelBytes; j++) {\n                pixels[pixelsPos++] = buffer[bufferPos++];\n              }\n              pixelsPos += (dx - 1) * pixelBytes;\n            }\n          }\n\n          row++;\n      }\n    }\n\n    if (this.interlaceMethod === 0) {\n      // Single pass from top to bottom with no skips\n      pass(0, 0, 1, 1, true);\n    } else {\n      /*\n        Adam7 interlacing consists of 7 passes over the data, each one\n        starting at a different x,y offset and covering a different fraction of the pixels.\n\n        1 6 4 6 2 6 4 6\n        7 7 7 7 7 7 7 7\n        5 6 5 6 5 6 5 6\n        7 7 7 7 7 7 7 7\n        3 6 4 6 3 6 4 6\n        7 7 7 7 7 7 7 7\n        5 6 5 6 5 6 5 6\n        7 7 7 7 7 7 7 7\n      */\n      pass(0, 0, 8, 8); // 1\n      pass(4, 0, 8, 8); // 2\n      pass(0, 4, 4, 8); // 3\n      pass(2, 0, 4, 4); // 4\n      pass(0, 2, 2, 4); // 5\n      pass(1, 0, 2, 2); // 6\n      pass(0, 1, 1, 2); // 7\n    }\n\n\n    return pixels;\n  };\n\n  private read = (numBytes: number): number[] => {\n    const results = [];\n    for (let i = 0; i < numBytes; i++) {\n      results[i] = this.data[this.pos++];\n    }\n    return results;\n  };\n\n  private readUInt32 = (): number => {\n    const b1 = this.data[this.pos++] << 24;\n    const b2 = this.data[this.pos++] << 16;\n    const b3 = this.data[this.pos++] << 8;\n    const b4 = this.data[this.pos++];\n    return b1 | b2 | b3 | b4;\n  };\n\n  private decodePalette = (): Uint8Array => {\n    const palette = this.palette;\n    const transparency = this.transparency.indexed || [];\n    const retVal = new Uint8Array(transparency.length + palette.length);\n    let pos = 0;\n    let c = 0;\n\n    for (let i = 0; i < palette.length; i++) {\n      retVal[pos++] = palette[i];\n      retVal[pos++] = palette[i + 1];\n      retVal[pos++] = palette[i + 2];\n      const temp = transparency[c++];\n      retVal[pos++] = temp !== undefined ? temp : 255;\n    }\n\n    return retVal;\n  };\n}","/* Based on the `images` modules in `pdfkit` by Devon Govett, licensed under MIT.\n *\n * Ported to TypeScript and modified to better fit a web use case, by using Uint8Array\n * instead of Buffer.\n *\n * https://github.com/foliojs/pdfkit/blob/master/lib/image/jpeg.js\n * https://github.com/foliojs/pdfkit/blob/master/lib/image/png.js\n *\n * MIT LICENSE\n * Copyright (c) 2011 Devon Govett\n *\n * Permission is hereby granted, free of charge, to any person obtaining a copy of this\n * software and associated documentation files (the \"Software\"), to deal in the Software\n * without restriction, including without limitation the rights to use, copy, modify, merge,\n * publish, distribute, sublicense, and/or sell copies of the Software, and to permit persons\n * to whom the Software is furnished to do so, subject to the following conditions:\n *\n * The above copyright notice and this permission notice shall be included in all copies or\n * substantial portions of the Software.\n *\n * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING\n * BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND\n * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM,\n * DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.\n */\nimport { zlibSync } from 'fflate';\nimport { PdfDictionary, serialize, PdfObject, makeRef } from './common.js';\nimport PNG from './png.js';\nimport { IS_BIG_ENDIAN } from './util.js';\n\nfunction readUint16BE(buf: Uint8Array, pos = 0): number {\n  const val = new Uint16Array(buf.slice(pos, pos + 2).buffer)[0];\n  if (IS_BIG_ENDIAN) {\n    return val;\n  } else {\n    // system is little endian, swap bytes in value from buffer\n    return ((val & 0xff) << 8) | ((val >> 8) & 0xff);\n  }\n}\n\nabstract class PdfImage {\n  static open(data: Uint8Array): PdfImage {\n    if (data.length > 2 && data[0] === 0xff && data[1] === 0xd8) {\n      return new JPEGImage(data);\n    } else if (\n      data.length > 8 &&\n      data[0] === 0x89 &&\n      data[1] === 0x50 &&\n      data[2] === 0x4e &&\n      data[3] === 0x47 &&\n      data[4] === 0x0d &&\n      data[5] === 0x0a &&\n      data[6] === 0x1a &&\n      data[7] === 0x0a\n    ) {\n      return new PNGImage(data);\n    } else {\n      throw new Error('Unknown image format.');\n    }\n  }\n\n  abstract toObjects(\n    startNum: number,\n    isOptional?: boolean,\n    optionalTitle?: string,\n    optionalDefaultState?: boolean\n  ): Array<PdfObject>;\n}\n\nexport class JPEGImage extends PdfImage {\n  static MARKERS = [\n    0xffc0, 0xffc1, 0xffc2, 0xffc3, 0xffc5, 0xffc6, 0xffc7, 0xffc8, 0xffc9,\n    0xffca, 0xffcb, 0xffcc, 0xffcd, 0xffce, 0xffcf,\n  ];\n  static COLOR_SPACE_MAP = {\n    1: 'DeviceGray',\n    3: 'DeviceRGB',\n    4: 'DeviceCMYK',\n  };\n  data: Uint8Array;\n\n  bits: number;\n  width: number;\n  height: number;\n  colorSpace: string;\n\n  constructor(data: Uint8Array) {\n    super();\n    let marker;\n    this.data = data;\n    if (readUint16BE(this.data, 0) !== 0xffd8) {\n      throw 'SOI not found in JPEG';\n    }\n\n    let pos = 2;\n    while (pos < this.data.length) {\n      marker = readUint16BE(this.data, pos);\n      pos += 2;\n      if (JPEGImage.MARKERS.includes(marker)) {\n        break;\n      }\n      pos += readUint16BE(this.data, pos);\n    }\n\n    if (!marker || !JPEGImage.MARKERS.includes(marker)) {\n      throw 'Invalid JPEG.';\n    }\n    pos += 2;\n\n    this.bits = this.data[pos++];\n    this.height = readUint16BE(this.data, pos);\n    pos += 2;\n\n    this.width = readUint16BE(this.data, pos);\n    pos += 2;\n\n    const channels = this.data[pos++];\n    if ([1, 3, 4].indexOf(channels) < 0) {\n      throw 'Bad number of channels, only 1, 3 or 4 are supported';\n    }\n    this.colorSpace = JPEGImage.COLOR_SPACE_MAP[channels as 1 | 3 | 4];\n  }\n\n  toObjects(startNum: number): Array<PdfObject> {\n    const obj: PdfDictionary = {\n      Type: '/XObject',\n      Subtype: '/Image',\n      BitsPerComponent: this.bits,\n      Width: this.width,\n      Height: this.height,\n      ColorSpace: `/${this.colorSpace}`,\n      Filter: '/DCTDecode',\n      Length: this.data.length,\n    };\n\n    // add extra decode params for CMYK images. By swapping the\n    // min and max values from the default, we invert the colors. See\n    // section 4.8.4 of the spec.\n    if (this.colorSpace === 'DeviceCMYK') {\n      obj.Decode = [1.0, 0.0, 1.0, 0.0, 1.0, 0.0, 1.0, 0.0];\n    }\n    return [{ num: startNum, data: serialize(obj), stream: this.data }];\n  }\n}\n\nexport class PNGImage extends PdfImage {\n  label: string | undefined;\n  image: PNG;\n  width: number;\n  height: number;\n  imgData: Uint8Array;\n\n  constructor(data: Uint8Array, label?: string) {\n    super();\n    this.label = label;\n    this.image = new PNG(data);\n    this.width = this.image.width;\n    this.height = this.image.height;\n    this.imgData = this.image.imgData;\n  }\n\n  toObjects(startNum: number): Array<PdfObject> {\n    let dataDecoded = false;\n\n    const hasAlphaChannel = this.image.hasAlphaChannel;\n    const isInterlaced = this.image.interlaceMethod === 1;\n\n    const out: Array<PdfObject> = [];\n    let nextNum = startNum;\n    const imgObj: PdfObject = {\n      num: nextNum++,\n    };\n    out.push(imgObj);\n\n    const imgDict: PdfDictionary = {\n      Type: '/XObject',\n      Subtype: '/Image',\n      BitsPerComponent: hasAlphaChannel ? 8 : this.image.bits,\n      Width: this.width,\n      Height: this.height,\n      Filter: '/FlateDecode',\n    };\n\n    if (!hasAlphaChannel) {\n      imgDict.DecodeParms = {\n        Predictor: isInterlaced ? 1 : 15,\n        Colors: this.image.colors,\n        BitsPerComponent: this.image.bits,\n        Columns: this.width,\n      };\n    }\n\n    if (this.image.palette.length === 0) {\n      imgDict.ColorSpace = `/${this.image.colorSpace}`;\n    } else {\n      // embed the color palette in the PDF as an object stream\n      const paletteObj: PdfObject = {\n        num: nextNum++,\n        data: serialize({ Length: this.image.palette.length }),\n        stream: new Uint8Array(this.image.palette),\n      };\n      out.push(paletteObj);\n      // build the color space array for the image\n      imgDict.ColorSpace = [\n        '/Indexed',\n        '/DeviceRGB',\n        this.image.palette.length / 3 - 1,\n        makeRef(paletteObj),\n      ];\n    }\n\n    // For PNG color types 0, 2 and 3, the transparency data is stored in\n    // a dedicated PNG chunk.\n    if (this.image.transparency.grayscale != null) {\n      // Use Color Key Masking (spec section 4.8.5)\n      // An array with N elements, where N is two times the number of color components.\n      const val = this.image.transparency.grayscale;\n      imgDict.Mask = [val, val];\n    } else if (this.image.transparency.rgb) {\n      // Use Color Key Masking (spec section 4.8.5)\n      // An array with N elements, where N is two times the number of color components.\n      const { rgb } = this.image.transparency;\n      const mask = [];\n      for (let x of rgb) {\n        mask.push(x, x);\n      }\n\n      imgDict.Mask = mask;\n    } else if (this.image.transparency.indexed) {\n      // Create a transparency SMask for the image based on the data\n      // in the PLTE and tRNS sections. See below for details on SMasks.\n      const alphaChannelObj = this.loadIndexedAlphaChannel(nextNum++);\n      imgDict.SMask = makeRef(alphaChannelObj);\n      out.push(alphaChannelObj);\n      dataDecoded = true;\n    } else if (hasAlphaChannel) {\n      // For PNG color types 4 and 6, the transparency data is stored as a alpha\n      // channel mixed in with the main image data. Separate this data out into an\n      // SMask object and store it separately in the PDF.\n      const [imageData, alphaChannelObj] = this.splitAlphaChannel(nextNum++);\n      imgObj.stream = zlibSync(imageData);\n      imgDict.Length = imgObj.stream.length;\n      imgDict.SMask = makeRef(alphaChannelObj);\n      out.push(alphaChannelObj);\n    }\n\n    if (isInterlaced && !dataDecoded && !imgObj.stream) {\n      imgObj.stream = zlibSync(this.image.decodePixels());\n      imgDict.Length = imgObj.stream.length;\n    } else if (!imgObj.stream) {\n      imgObj.stream = this.imgData;\n      imgDict.Length = imgObj.stream.length;\n    }\n\n    imgObj.data = serialize(imgDict);\n\n    if (out.length < 3) {\n      // Add empty dummy objects until we have 3 objects for the image, to stay true\n      // to our pre-determined object numbering\n      for (let i = out.length; i < 3; i++) {\n        out.push({ num: nextNum++ });\n      }\n    }\n    return out;\n  }\n\n  splitAlphaChannel(objNum: number): [Uint8Array, PdfObject] {\n    const pixels = this.image.decodePixels();\n    const colorCount = this.image.colors;\n    const pixelCount = this.width * this.height;\n    const imgData = new Uint8Array(pixelCount * colorCount);\n    const alphaChannel = new Uint8Array(pixelCount);\n\n    let i = 0;\n    let a = 0;\n    let p = 0;\n    const len = pixels.length;\n    // For 16bit images copy only most significant byte (MSB) - PNG data is always stored in network byte order (MSB first)\n    const skipByteCount = this.image.bits === 16 ? 1 : 0;\n    while (i < len) {\n      for (let colorIndex = 0; colorIndex < colorCount; colorIndex++) {\n        imgData[p++] = pixels[i++];\n        i += skipByteCount;\n      }\n      alphaChannel[a++] = pixels[i++];\n      i += skipByteCount;\n    }\n\n    const alphaChannelDeflated = zlibSync(alphaChannel);\n    return [\n      imgData,\n      {\n        num: objNum,\n        data: serialize({\n          Type: '/XObject',\n          Subtype: '/Image',\n          Width: this.width,\n          Height: this.height,\n          BitsPerComponent: 8,\n          Decode: [0, 1],\n          ColorSpace: '/DeviceGray',\n          Filter: '/FlateDecode',\n          Length: alphaChannelDeflated.length,\n        }),\n        stream: alphaChannelDeflated,\n      },\n    ];\n  }\n\n  loadIndexedAlphaChannel(objNum: number): PdfObject {\n    const pixels = this.image.decodePixels();\n    const transparency = this.image.transparency.indexed!;\n    const alphaChannel = new Uint8Array(this.width * this.height);\n\n    let i = 0;\n    for (let j = 0, end = pixels.length; j < end; j++) {\n      alphaChannel[i++] = transparency[pixels[j]];\n    }\n\n    const alphaChannelDeflated = zlibSync(alphaChannel);\n    return {\n      num: objNum,\n      data: serialize({\n        Type: '/XObject',\n        Subtype: '/Image',\n        Width: this.width,\n        Height: this.height,\n        BitsPerComponent: 8,\n        Decode: [0, 1],\n        ColorSpace: '/DeviceGray',\n        Filter: '/FlateDecode',\n        Length: alphaChannelDeflated.length,\n      }),\n      stream: alphaChannelDeflated,\n    };\n  }\n}\n\nexport default PdfImage;\n","import { Reader } from '../io.js';\nimport { PdfObject, PdfValue, PdfDictionary, PdfRef } from './common.js';\nimport { textDecoder, textEncoder } from './util.js';\n\n// Polyfill Uint8Array.findLastIndex for older browsers\nif (!Uint8Array.prototype.findLastIndex) {\n  Uint8Array.prototype.findLastIndex = function (\n    predicate: (value: number, index: number, obj: Uint8Array) => boolean\n  ): number {\n    let l = this.length;\n    while (l--) {\n      if (predicate(this[l], l, this)) return l;\n    }\n    return -1;\n  };\n}\n\nconst ESCAPE_CHARS: Record<string, string> = {\n  n: '\\n',\n  r: '\\r',\n  t: '\\t',\n  b: '\\b',\n  f: '\\f',\n  '(': '(',\n  ')': ')',\n  '\\\\': '\\\\',\n};\n\n//          offset/nextFree|generation|inUse?\n//                                     \ntype CrossRefEntry = [number, number, boolean];\ninterface CrossRefSubSection {\n  startNum: number;\n  numObjs: number;\n  entries: Array<CrossRefEntry>;\n}\n\n/** Parse a section of the x-ref table, yielding `CrossRefSubSection` objects as\n *  we encounter them.\n *\n * @param reader The reader to read from.\n * @param offset The offset of the x-ref section in the file.\n * @param length The length of the x-ref section.\n */\nasync function* parseCrossRefSection(\n  reader: Reader,\n  offset: number,\n  length: number\n): AsyncGenerator<CrossRefSubSection> {\n  const buf = new Uint8Array(length);\n  offset += await reader.read(buf, 0, offset, buf.length);\n  if (!testForString(buf, 0, 'xref')) {\n    throw 'Invalid crossreference section, did not start with `xref` line.';\n  }\n  const trailerIdx = buf.findIndex((_x, idx) =>\n    testForString(buf, idx, 'trailer')\n  );\n  // Split into lines and skip first line (`xref`)\n  const parts = textDecoder\n    .decode(buf.subarray(0, trailerIdx))\n    .split(/[\\r ]?\\n/)\n    .slice(1);\n  let currentSection: CrossRefSubSection | undefined;\n  for (const part of parts) {\n    // Entries have length 18 (we stripped the newline already)\n    if (part.length === 18) {\n      if (!currentSection) {\n        throw 'Invalid crossreference section, entry outside of subsection.';\n      }\n      const entryParts = part.trim().split(' ');\n      currentSection.entries.push([\n        Number.parseInt(entryParts[0], 10),\n        Number.parseInt(entryParts[1], 10),\n        entryParts[2] === 'n',\n      ]);\n    } else {\n      if (currentSection) {\n        if (currentSection.numObjs !== currentSection.entries.length) {\n          throw `Invalid subsection, expected ${currentSection.numObjs} objects, found ${currentSection.entries.length}!`;\n        }\n        yield currentSection;\n        currentSection = undefined;\n      }\n      if (part.length === 0 || part.indexOf('trailer') >= 0) {\n        break;\n      }\n      const [startNum, numObjs] = part\n        .trimEnd()\n        .split(' ')\n        .map((p) => Number.parseInt(p, 10));\n      currentSection = {\n        startNum,\n        numObjs,\n        entries: [],\n      };\n    }\n  }\n  if (currentSection) {\n    yield currentSection;\n  }\n  const trailerBuf = buf.subarray(trailerIdx);\n  const trailerStartIdx = trailerBuf.findIndex((_x, idx) =>\n    testForString(trailerBuf, idx, '<<')\n  );\n  const trailerEndIdx = trailerBuf.findIndex((_x, idx) =>\n    testForString(trailerBuf, idx, '>>')\n  );\n\n  const trailerDict = new PdfValueParser(\n    trailerBuf.subarray(trailerStartIdx, trailerEndIdx + 2)\n  ).read() as PdfDictionary;\n  if (trailerDict.Prev) {\n    const previousXrefOffset = trailerDict.Prev as number;\n    yield* parseCrossRefSection(\n      reader,\n      previousXrefOffset,\n      offset - previousXrefOffset\n    );\n  }\n}\n\n/** Look for a string from a given location in a buffer. */\nfunction testForString(\n  buf: Uint8Array,\n  offset: number,\n  value: string,\n  backwards = false\n): boolean {\n  if (backwards) {\n    for (let idx = value.length - 1; idx >= 0; idx--) {\n      if (buf[offset + idx] !== value.charCodeAt(idx)) {\n        return false;\n      }\n    }\n  } else {\n    for (let idx = 0; idx < value.length; idx++) {\n      if (buf[offset + idx] !== value.charCodeAt(idx)) {\n        return false;\n      }\n    }\n  }\n  return true;\n}\n\n/** Check if a string is the representation of an integer digit */\nfunction isDigit(c: string): boolean {\n  return !isNaN(parseInt(c, 10));\n}\n\n/** Check if a character is a hexadecimal digit ([0-9a-fA-F])  */\nfunction isHex(c: number): boolean {\n  return (\n    (c >= 0x30 && c <= 0x39) ||\n    (c >= 0x41 && c <= 0x46) ||\n    (c >= 0x61 && c <= 0x66)\n  );\n}\n\n/** Parse a PDF \"value\", which can be one of:\n * - number (integer or float)\n * - string\n * - name (represented as a JS string starting with `/`)\n * - boolean\n * - null\n * - date\n * - XRef\n * - Array\n * - Dictionary\n *\n * API walkthrough:\n * - `read()` is the main entry point, it will read the next value from the\n *   buffer and advance the cursor\n *  - `match*` methods check if the buffer at the current offset matches a\n *    certain type of value, either returning a boolean or the section of the\n *    buffer containing the value as a string.\n *  - `read*` methods read a value of a specific type from the buffer and\n *    advance the cursor\n */\nexport class PdfValueParser {\n  start = 0;\n  current = 0;\n  private readonly buf: Uint8Array;\n\n  /** Construct a parser for a buffer containing one or more PDF values. */\n  constructor(buf: Uint8Array) {\n    this.buf = buf;\n  }\n\n  /** Get the buffer content at the current offset as a character. */\n  private getChar(): string {\n    return String.fromCharCode(this.buf[this.current]);\n  }\n\n  /** Compares the buffer contents at the current offset against a string value. */\n  private matchValue(value: string): boolean {\n    const valueRead = textDecoder.decode(\n      this.buf.subarray(\n        this.current,\n        this.current + textEncoder.encode(value).length\n      )\n    );\n    return valueRead === value;\n  }\n\n  /** Checks if the buffer at the current offset contains a number.\n   *\n   * See ISO32000-2:2020 section 7.3.3.\n   */\n  private matchInteger(resetAfter = true): string | undefined {\n    this.start = this.current;\n    let chr: string;\n    let isInt = true;\n    const chars: string[] = [];\n    while (\n      !this.matchWhiteSpace((chr = this.getChar())) &&\n      !this.matchDelimiter(chr)\n    ) {\n      if (chr === '+' || chr === '-') {\n        if (this.current - this.start > 0) {\n          isInt = false;\n          break;\n        }\n      } else if (!isDigit(chr)) {\n        isInt = false;\n        break;\n      }\n      this.current++;\n      chars.push(chr);\n    }\n    if (resetAfter) {\n      this.current = this.start;\n    }\n    return isInt ? chars.join('') : undefined;\n  }\n\n  /** Read a PDF value from the current offset, advancing the cursor. */\n  read(): PdfValue {\n    let c = this.getChar();\n    if (this.matchWhiteSpace(c)) {\n      this.skipWhiteSpace();\n      c = this.getChar();\n    }\n    switch (this.getChar()) {\n      case '[':\n        return this.readArray();\n      case '<':\n        return this.matchValue('<<') ? this.readDict() : this.readHexString();\n      case '(':\n        return this.readLiteralString();\n      case '/':\n        return this.readName();\n      case 't':\n        if (this.matchValue('true')) {\n          this.current += 'true'.length;\n          return true;\n        }\n        throw new Error('Unexpected character while parsing');\n      case 'f':\n        if (this.matchValue('false')) {\n          this.current += 'false'.length;\n          return false;\n        }\n        throw new Error('Unexpected character while parsing');\n      case 'n':\n        if (this.matchValue('null')) {\n          this.current += 'null'.length;\n          return null;\n        }\n        throw new Error('Unexpected character while parsing');\n      case '.':\n        return this.readRealNumber();\n      default:\n        if (this.matchIndirectObject()) {\n          return this.readIndirectObject();\n        }\n        if (this.matchRealNumber()) {\n          return this.readRealNumber();\n        }\n        if (this.matchInteger()) {\n          return this.readInteger();\n        }\n        throw new Error(\n          `Encountered unexpected character during parsing: '${c}'`\n        );\n    }\n  }\n\n  /** Check if the input string contains PDF whitespace.\n   *\n   * See ISO32000-2:2020 section 7.2.3, Table 1.\n   */\n  matchWhiteSpace(c: string): boolean {\n    return (\n      c === ' ' ||\n      c === '\\x00' ||\n      c === '\\n' ||\n      c === '\\r' ||\n      c === '\\r\\n' ||\n      c == '\\x0C'\n    );\n  }\n\n  /** Read an integer from the current offset. */\n  readInteger(): number {\n    const intStr = this.matchInteger(false);\n    if (intStr === undefined) {\n      throw new Error('Failed to read integer.');\n    }\n    return Number.parseInt(intStr, 10);\n  }\n\n  /** Read an indirect object from the current offset. */\n  readIndirectObject(): PdfRef {\n    const match = this.matchIndirectObject(false);\n    if (match === undefined) {\n      throw new Error('Failed to read indirect object');\n    }\n    return new PdfRef(Number.parseInt(match.split(' ')[0]));\n  }\n\n  /** Check if the buffer contains an indirect object at the current offset.\n   *\n   * See ISO32000-2:2020 section 7.3.10.\n   */\n  matchIndirectObject(resetAfter = true): string | undefined {\n    this.start = this.current;\n    let c = this.getChar();\n    const chars: string[] = [];\n    const matchNumber = (): boolean => {\n      if (!isDigit(c)) {\n        return false;\n      }\n      chars.push(c);\n      this.current++;\n      while (isDigit((c = this.getChar()))) {\n        chars.push(c);\n        this.current++;\n      }\n      return true;\n    };\n    const matchWhitespace = (): boolean => this.skipWhiteSpace();\n    // Using a closure makes resetting afterwards less verbose\n    const match = (): boolean => {\n      // Object number\n      if (!matchNumber()) {\n        return false;\n      }\n      if (!matchWhitespace()) {\n        return false;\n      }\n      chars.push(' ');\n      c = this.getChar();\n      // Generation number\n      if (!matchNumber()) {\n        return false;\n      }\n      if (!matchWhitespace()) {\n        return false;\n      }\n      chars.push(' ');\n      if (this.getChar() !== 'R') {\n        return false;\n      }\n      chars.push('R');\n      this.current++;\n      return true;\n    };\n    const doesMatch = match();\n    if (resetAfter) {\n      this.current = this.start;\n    }\n    if (doesMatch) {\n      return chars.join('');\n    }\n  }\n\n  /** Check if the buffer contains a real number at the current offset.\n   *\n   * See ISO32000-2:2020 section 7.3.3.\n   */\n  matchRealNumber(resetAfter = true): string | undefined {\n    this.start = this.current;\n    let isRealNumber = true;\n    let digitSeen = false;\n    let separatorSeen = false;\n    const chars: string[] = [];\n    let c: string;\n    // eslint-disable-next-line no-constant-condition\n    while (true) {\n      c = this.getChar();\n      if (c === '.') {\n        if (separatorSeen) {\n          isRealNumber = false;\n          break;\n        }\n        separatorSeen = true;\n      } else if (isDigit(c)) {\n        digitSeen = true;\n      } else if (c === '-' || c === '+') {\n        if (this.current - this.start > 0) {\n          break;\n        }\n      } else {\n        break;\n      }\n      chars.push(c);\n      this.current++;\n    }\n    if (resetAfter) {\n      this.current = this.start;\n    }\n    if (!isRealNumber) {\n      return undefined;\n    }\n    if (digitSeen && separatorSeen) {\n      return chars.join('');\n    }\n    return undefined;\n  }\n\n  /** Read a real number from the current offset. */\n  readRealNumber(): number {\n    const str = this.matchRealNumber(false);\n    if (!str) {\n      throw new Error('Could not read real number.');\n    }\n    return Number.parseFloat(str);\n  }\n\n  /** Skip a contiguous sequence of whitespae, advancing the cursor. */\n  skipWhiteSpace(): boolean {\n    let skipped = false;\n    while (!this.atEnd() && this.matchWhiteSpace(this.getChar())) {\n      this.current++;\n      skipped = true;\n    }\n    return skipped;\n  }\n\n  /** Check if we're at the end of the buffer. */\n  atEnd(): boolean {\n    return this.current >= this.buf.length;\n  }\n\n  /** Read a name from the current offset.\n   *\n   * See ISO32000-2:2020 section 7.3.5.\n   */\n  readName(): PdfValue {\n    const chars: string[] = ['/'];\n    this.current++;\n    let c: string;\n    while (\n      !this.matchWhiteSpace((c = this.getChar())) &&\n      !this.matchDelimiter(c)\n    ) {\n      if (c === '#') {\n        const a = this.buf[this.current++];\n        const b = this.buf[this.current++];\n        if (!isHex(a) || !isHex(b)) {\n          throw new Error('Illegal character escape in name.');\n        }\n        chars.push(\n          String.fromCharCode(\n            Number.parseInt(String.fromCharCode(a) + String.fromCharCode(b), 16)\n          )\n        );\n      } else {\n        chars.push(c);\n        this.current++;\n      }\n    }\n    return chars.join('');\n  }\n\n  /** Check if the current offset contains a delimiter.\n   *\n   * See ISO32000-2:2020 section 7.2.3, Table 2\n   */\n  matchDelimiter(c: string): boolean {\n    return '[]{}()<>/%'.indexOf(c) >= 0;\n  }\n\n  /** Read a hex string from the current offset.\n   *\n   * See ISO32000-2:2020 section 7.3.4.3\n   */\n  readHexString(): PdfValue {\n    this.current++;\n    const vals: Array<number> = [];\n    while (this.getChar() !== '>') {\n      const a = this.buf[this.current++];\n      const b = this.buf[this.current++];\n      if (!isHex(a) || !isHex(b)) {\n        throw new Error(`Invalid value in hex string: '${a}${b}`);\n      }\n      vals.push(\n        Number.parseInt(String.fromCharCode(a) + String.fromCharCode(b), 16)\n      );\n    }\n    this.current++;\n    return new Uint8Array(vals);\n  }\n\n  /** Read a literal string from the current offset.\n   *\n   * See ISO32000-2:2020 section 7.3.4.2\n   */\n  readLiteralString(): PdfValue {\n    this.current++;\n    const chars: string[] = [];\n    let openParens = 0;\n    let c: string;\n    // eslint-disable-next-line no-constant-condition\n    while (true) {\n      c = this.getChar();\n      if (c === '\\\\') {\n        this.current++;\n        c = this.getChar();\n        if (isDigit(c)) {\n          let cs = [c];\n          this.current++;\n          while (isDigit(this.getChar())) {\n            cs.push(this.getChar());\n            this.current++;\n          }\n          if (cs.length > 3) {\n            this.current -= cs.length - 3;\n            cs = cs.slice(0, 3);\n          }\n          this.current--;\n          c = String.fromCharCode(Number.parseInt(cs.join(''), 8));\n        } else {\n          c = ESCAPE_CHARS[c];\n          if (c === undefined) {\n            throw new Error(\n              `Illegal escape sequence in string literal: '\\\\${c}`\n            );\n          }\n        }\n      } else if (c === '(') {\n        openParens++;\n      } else if (c === ')') {\n        openParens--;\n        if (openParens < 0) {\n          this.current++;\n          return chars.join('');\n        }\n      }\n      chars.push(c);\n      this.current++;\n    }\n  }\n\n  /** Read a dictionary from the current offset.\n   *\n   * See ISO32000-2:2020 section 7.3.7\n   */\n  readDict(): PdfValue {\n    this.current += 2;\n    const obj: Record<string, PdfValue> = {};\n    this.skipWhiteSpace();\n    while (this.getChar() !== '>') {\n      const name = this.read();\n      if (typeof name !== 'string' || !name.startsWith('/')) {\n        throw new Error(`Dictionary keys must be name objects, got '${name}`);\n      }\n      this.skipWhiteSpace();\n      const val = this.read();\n      if (val !== null) {\n        obj[name.substring(1)] = val;\n      }\n      this.skipWhiteSpace();\n    }\n    this.current += 2;\n    return obj;\n  }\n\n  /** Read an array from the current offset.\n   *\n   * See ISO32000-2:2020 section 7.3.6\n   */\n  readArray(): Array<PdfValue> {\n    this.current++;\n    const arr: Array<PdfValue> = [];\n    while (this.getChar() !== ']') {\n      arr.push(this.read());\n      this.skipWhiteSpace();\n    }\n    this.current++;\n    return arr;\n  }\n}\n\n/** Minimalist low-level PDF parser operating on a Reader object.\n *\n * Currently only supports discovering page objects and annotation objects, as well\n * as obtaining arbitrary objects given the object number and generation.\n */\nexport class PdfParser {\n  private reader: Reader;\n  private objectOffsets: Array<number>;\n  private sortedOffsets: Array<number>;\n  pdfSize: any;\n  objGenerations: number[];\n  infoNum: number;\n  catalogNum: number;\n\n  /** Construct a new parser from a Reader.\n   *\n   * Used instead of the constructor to allow for async initialization.\n   */\n  static async parse(reader: Reader): Promise<PdfParser> {\n    const trailerBuf = new Uint8Array(1024);\n    const pdfSize = await reader.size();\n    const bufStart = pdfSize - trailerBuf.length;\n    await reader.read(trailerBuf, 0, bufStart, trailerBuf.length);\n    const eofIdx =\n      trailerBuf.length - (trailerBuf[trailerBuf.length - 1] === 0x46 ? 5 : 6);\n    if (!testForString(trailerBuf, eofIdx, '%%EOF')) {\n      throw 'Invalid PDF, missing EOF comment at end of file';\n    }\n    const startXrefPos = trailerBuf.findLastIndex((_x, idx) =>\n      testForString(trailerBuf, idx, 'startxref')\n    );\n    if (startXrefPos < 0) {\n      throw 'Invalid PDF, missing startxref marker in file trailer.';\n    }\n    const objGenerations: Array<number> = [];\n    const objsDeleted: Array<boolean> = [];\n    const objOffsets: Array<number> = [];\n    const xrefStartOffset = Number.parseInt(\n      textDecoder.decode(trailerBuf.subarray(startXrefPos + 9, eofIdx)).trim(),\n      10\n    );\n    const dictEnd =\n      trailerBuf.findLastIndex((_x, idx) =>\n        testForString(trailerBuf, idx, '>>')\n      ) + 2;\n    const dictStart = trailerBuf.findLastIndex((_x, idx) =>\n      testForString(trailerBuf, idx, '<<')\n    );\n    const trailerDict = new PdfValueParser(\n      trailerBuf.subarray(dictStart, dictEnd)\n    ).read() as PdfDictionary;\n    for await (const { startNum, entries } of parseCrossRefSection(\n      reader,\n      xrefStartOffset,\n      bufStart + dictEnd - xrefStartOffset\n    )) {\n      for (const [idx, [offset, gen, inUse]] of entries.entries()) {\n        const objNum = idx + startNum;\n        if ((objGenerations[objNum] ?? -1) > gen) {\n          // Outdated entry, don't consider\n          continue;\n        }\n        objGenerations[objNum] = gen;\n        if (inUse) {\n          objOffsets[objNum] = offset;\n          objsDeleted[objNum] = false;\n        } else {\n          objOffsets[objNum] = -1;\n          objsDeleted[objNum] = true;\n        }\n      }\n    }\n    if (objOffsets.length !== trailerDict.Size) {\n      throw `Trailer dictionary has different number of objects than crossreference tables, ${objOffsets.length} vs. ${trailerDict.Size}`;\n    }\n    return new PdfParser(reader, objOffsets, objGenerations, trailerDict);\n  }\n\n  /** Private constructor, use factory method above. */\n  private constructor(\n    reader: Reader,\n    objOffsets: Array<number>,\n    objGenerations: Array<number>,\n    trailerDict: PdfDictionary\n  ) {\n    this.reader = reader;\n    this.objectOffsets = objOffsets;\n    this.sortedOffsets = [...objOffsets].sort((a, b) => a - b);\n    this.objGenerations = objGenerations;\n    this.catalogNum = (trailerDict.Root as PdfRef).refObj;\n    this.infoNum = (trailerDict.Info as PdfRef).refObj;\n  }\n\n  /** Retrieve the catalog dictionary. */\n  async catalog(): Promise<PdfDictionary> {\n    const obj = await this.getObject(this.catalogNum);\n    if (!obj) {\n      throw `Document has no catalog object (num as per trailer: ${this.catalogNum}!`;\n    }\n    return obj.data as PdfDictionary;\n  }\n\n  /** Retrieve the info dictionary. */\n  async info(): Promise<PdfDictionary> {\n    const obj = await this.getObject(this.infoNum);\n    if (!obj) {\n      throw `Document has no info object (num as per trailer: ${this.infoNum}!`;\n    }\n    return obj.data as PdfDictionary;\n  }\n\n  /** Yield all pages referenced in the given page dictionary. */\n  async *_pagesFromPagesObj(\n    pagesObj: PdfDictionary\n  ): AsyncGenerator<PdfObject> {\n    for (const pageRef of pagesObj.Kids as Array<PdfRef>) {\n      const page = await this.getObject(pageRef.refObj, true);\n      if (!page) {\n        throw `Could not find Page object with number ${pageRef.refObj}`;\n      }\n      const pageDict = page.data as PdfDictionary;\n      if (pageDict.Type === '/Pages') {\n        yield* this._pagesFromPagesObj(pageDict);\n      } else {\n        yield page;\n      }\n    }\n  }\n\n  /** Yield all pages in the PDF. */\n  async *pages(): AsyncGenerator<PdfObject> {\n    const catalog = await this.catalog();\n    const pagesRef = catalog.Pages as PdfRef;\n    const pagesRoot = await this.getObject(pagesRef.refObj);\n    if (!pagesRoot) {\n      throw `Could not find Pages object with number ${pagesRef.refObj}`;\n    }\n    const pagesDict = pagesRoot.data as PdfDictionary;\n    yield* this._pagesFromPagesObj(pagesDict);\n  }\n\n  /** Yield all annotations for the given page dictionary. */\n  async *annotations(pageDict: PdfDictionary): AsyncGenerator<PdfDictionary> {\n    const annots = pageDict.Annots;\n    if (!annots) {\n      return;\n    }\n    for (const annoRef of annots as Array<PdfRef>) {\n      const anno = await this.getObject(annoRef.refObj);\n      if (!anno) {\n        throw `Could not find Annotation object with number ${annoRef.refObj}`;\n      }\n      yield anno.data as PdfDictionary;\n    }\n  }\n\n  /** Resolve a PDF reference to the corresponding object. */\n  resolveRef(ref: PdfRef): Promise<PdfObject | undefined> {\n    return this.getObject(ref.refObj, true);\n  }\n\n  /** Get an object from the PDF from its number. */\n  async getObject(\n    num: number,\n    withStream = false\n  ): Promise<PdfObject | undefined> {\n    const offset = this.objectOffsets[num];\n    if (!offset) {\n      return;\n    }\n    if (!this.pdfSize) {\n      this.pdfSize = await this.reader.size();\n    }\n    const nextOffset =\n      this.sortedOffsets[this.sortedOffsets.indexOf(offset) + 1] ??\n      this.pdfSize;\n    const buf = new Uint8Array(nextOffset - offset);\n    await this.reader.read(buf, 0, offset, buf.length);\n    const objEndIdx = buf.findIndex((_x, idx) =>\n      testForString(buf, idx, 'endobj')\n    );\n    let streamIdx = buf.findIndex((_x, idx) =>\n      testForString(buf, idx, 'stream')\n    );\n    if (streamIdx >= 0) {\n      streamIdx += 'stream'.length;\n      if (buf[streamIdx] === '\\r'.charCodeAt(0)) {\n        streamIdx += 2;\n      } else {\n        streamIdx += 1;\n      }\n    }\n    const objSig = `${num} ${this.objGenerations[num]} obj`;\n    const objParser = new PdfValueParser(\n      buf.subarray(objSig.length, streamIdx < 0 ? objEndIdx : streamIdx)\n    );\n    const data = objParser.read();\n    if (typeof data !== 'object' || data === null) {\n      throw new Error('Illegal PDF object, does not start with a dictionary.');\n    }\n    let stream: Uint8Array | undefined;\n    if (withStream && streamIdx > 0) {\n      const streamLength = (data as PdfDictionary).Length as number | undefined;\n      if (streamLength === undefined) {\n        throw new Error(\n          'Illegal stream object, missing Length entry in object dictionary.'\n        );\n      }\n      stream = buf.subarray(streamIdx, streamIdx + streamLength);\n    }\n    return {\n      num,\n      data,\n      stream,\n    };\n  }\n}\n","export default '0.2.6';\n","import { crc32 } from '../util.js';\nimport { textEncoder } from './util.js';\n\nexport type LocalHeaderParams = {\n  creationDate?: Date;\n  filename: string;\n  data: Uint8Array;\n  compressedData?: Uint8Array;\n  extraDataLength: number;\n};\n\nexport type CentralDirectoryFileSpec = {\n  localHeaderOffset: number;\n  deflated: boolean;\n  creationDate: Date;\n  crc32: number;\n  dataLength: number;\n  compressedDataLength: number;\n  filename: string;\n};\n\nexport type CentralFileDirectorySpec = {\n  files: CentralDirectoryFileSpec[];\n  trailingLength: number;\n  offset: number;\n};\n\nexport function buildLocalZipHeader({\n  creationDate = new Date(),\n  filename,\n  data,\n  compressedData,\n  extraDataLength,\n}: LocalHeaderParams): Uint8Array {\n  const creationTimeZip =\n    (creationDate.getHours() << 11) |\n    (creationDate.getDay() << 5) |\n    Math.round(creationDate.getSeconds() / 2);\n  const creationDateZip =\n    ((creationDate.getFullYear() - 1980) << 9) |\n    ((creationDate.getMonth() + 1) << 5) |\n    creationDate.getDate();\n  const dataCrc = crc32(data);\n  const filenameEncoded = textEncoder.encode(filename);\n  // 2 bytes for zlib header\n  const compressedLength = compressedData ? (compressedData.length - 2) : data.length;\n  return new Uint8Array([\n    // PKZIP magic number\n    0x50,\n    0x4b,\n    // Local File Header magic\n    0x03,\n    0x04,\n    // Required PKZip version\n    0x14,\n    0x00,\n    // General purpose bit flag, 2 bytes\n    0b00000000,\n    0b00000000,\n    // Compression method, 2 bytes little endian\n    compressedData ? 0x08 : 0x00,\n    0x00,\n    // Creation time, 2 bytes little endian\n    creationTimeZip & 0xff,\n    creationTimeZip >> 8,\n    // Creation date, 2 bytes little endian\n    creationDateZip & 0xff,\n    creationDateZip >> 8,\n    // CRC32 of data, 4 bytes little endian\n    dataCrc & 0xff,\n    (dataCrc >> 8) & 0xff,\n    (dataCrc >> 16) & 0xff,\n    (dataCrc >> 24) & 0xff,\n    // Compressed size, 4 bytes little endian\n    compressedLength & 0xff,\n    (compressedLength >> 8) & 0xff,\n    (compressedLength >> 16) & 0xff,\n    (compressedLength >> 24) & 0xff,\n    // Uncompressed size, 4 bytes little endian\n    data.length & 0xff,\n    (data.length >> 8) & 0xff,\n    (data.length >> 16) & 0xff,\n    (data.length >> 24) & 0xff,\n    // Filename length, 2 bytes little endian\n    filenameEncoded.length & 0xff,\n    filenameEncoded.length >> 8, // Filename length in little endian\n    // Extra field length, 2 bytes little endian\n    (extraDataLength + 4) & 0xff,\n    (extraDataLength + 4) >> 8,\n    // Encoded file name\n    ...filenameEncoded,\n    // Beginning of extra field: identifier, 2 bytes\n    0xff,\n    0xff,\n    // Beginning of extra field: length, 2 bytes little endian\n    extraDataLength & 0xff,\n    extraDataLength >> 8,\n  ]);\n}\n\nexport function buildCentralFileDirectory({\n  files,\n  trailingLength,\n  offset\n}: CentralFileDirectorySpec): Uint8Array {\n  const chunks = files.map(buildCentralDirectoryFileHeader);\n  const cdSize =  chunks.reduce((acc, chunk) => acc + chunk.length, 0);\n  chunks.push(new Uint8Array([\n    // PKZIP magic number\n    0x50,\n    0x4b,\n    // End of central directory magic\n    0x05,\n    0x06,\n    // Disk number\n    0x00,\n    0x00,\n    // Disk with central directory\n    0x00,\n    0x00,\n    // Disk entries\n    files.length & 0xff,\n    files.length >> 8,\n    // Total entries\n    files.length & 0xff,\n    files.length >> 8,\n    // Central directory size,\n    cdSize & 0xff,\n    (cdSize >> 8) & 0xff,\n    (cdSize >> 16) & 0xff,\n    (cdSize >> 24) & 0xff,\n    // Offset of central directory in file\n    offset & 0xff,\n    (offset >> 8) & 0xff,\n    (offset >> 16) & 0xff,\n    (offset >> 24) & 0xff,\n    // Length of trailing comment\n    trailingLength & 0xff,\n    trailingLength >> 8,\n  ]));\n  return new Uint8Array(\n    chunks.reduce((acc: number[], curr) => {\n      acc.push(...curr);\n      return acc;\n    }, [])\n  );\n}\n\nfunction buildCentralDirectoryFileHeader(\n  spec: CentralDirectoryFileSpec\n): Uint8Array {\n  const creationTimeZip =\n    (spec.creationDate.getHours() << 11) |\n    (spec.creationDate.getMinutes() << 5) |\n    Math.round(spec.creationDate.getSeconds() / 2);\n  const creationDateZip =\n    ((spec.creationDate.getFullYear() - 1980) << 9) |\n    ((spec.creationDate.getMonth() +1) << 5) |\n    spec.creationDate.getDate();\n  const filenameEncoded = textEncoder.encode(spec.filename);\n  return new Uint8Array([\n    // PKZIP magic number\n    0x50,\n    0x4b,\n    // Central directory file header magic\n    0x01,\n    0x02,\n    // Version\n    0x17,\n    0x03,\n    //  Version needed\n    0x14,\n    0x00,\n    // Flags, none set\n    0x00,\n    0x00,\n    // Compression method, 2 bytes little endian\n    spec.deflated ? 0x08 : 0x00,\n    0x00,\n    // Creation time, 2 bytes little endian\n    creationTimeZip & 0xff,\n    creationTimeZip >> 8,\n    // Creation date, 2 bytes little endian\n    creationDateZip & 0xff,\n    creationDateZip >> 8,\n    // CRC32 of data, 4 bytes little endian\n    spec.crc32 & 0xff,\n    (spec.crc32 >> 8) & 0xff,\n    (spec.crc32 >> 16) & 0xff,\n    (spec.crc32 >> 24) & 0xff,\n    // Compressed size, 4 bytes little endian\n    spec.compressedDataLength & 0xff,\n    (spec.compressedDataLength >> 8) & 0xff,\n    (spec.compressedDataLength >> 16) & 0xff,\n    (spec.compressedDataLength >> 24) & 0xff,\n    // Uncompressed size, 4 bytes little endian\n    spec.dataLength & 0xff,\n    (spec.dataLength >> 8) & 0xff,\n    (spec.dataLength >> 16) & 0xff,\n    (spec.dataLength >> 24) & 0xff,\n    // Filename length, 2 bytes little endian\n    filenameEncoded.length & 0xff,\n    filenameEncoded.length >> 8, // Filename length in little endian\n    // Extra field length, 2 bytes little endian\n    0x00,\n    0x00,\n    // File comment length, 2 bytes little endian\n    0x00,\n    0x00,\n    // Disk # start, 2 bytes little endian\n    0x00,\n    0x00,\n    // Internal Attribute, 2 bytes little endian\n    0x00,\n    0x00,\n    // External Attribute, 4 bytes little endian\n    0x00,\n    0x00,\n    0xa4,\n    0x81,\n    // Offset of local header, 4 bytes little endian\n    spec.localHeaderOffset & 0xff,\n    (spec.localHeaderOffset >> 8) &0xff,\n    (spec.localHeaderOffset >> 16) &0xff,\n    (spec.localHeaderOffset >> 24) &0xff,\n    ...filenameEncoded,\n  ]);\n}\n","'use strict'\r\n\r\nmodule.exports = {\r\n\t\"aliceblue\": [240, 248, 255],\r\n\t\"antiquewhite\": [250, 235, 215],\r\n\t\"aqua\": [0, 255, 255],\r\n\t\"aquamarine\": [127, 255, 212],\r\n\t\"azure\": [240, 255, 255],\r\n\t\"beige\": [245, 245, 220],\r\n\t\"bisque\": [255, 228, 196],\r\n\t\"black\": [0, 0, 0],\r\n\t\"blanchedalmond\": [255, 235, 205],\r\n\t\"blue\": [0, 0, 255],\r\n\t\"blueviolet\": [138, 43, 226],\r\n\t\"brown\": [165, 42, 42],\r\n\t\"burlywood\": [222, 184, 135],\r\n\t\"cadetblue\": [95, 158, 160],\r\n\t\"chartreuse\": [127, 255, 0],\r\n\t\"chocolate\": [210, 105, 30],\r\n\t\"coral\": [255, 127, 80],\r\n\t\"cornflowerblue\": [100, 149, 237],\r\n\t\"cornsilk\": [255, 248, 220],\r\n\t\"crimson\": [220, 20, 60],\r\n\t\"cyan\": [0, 255, 255],\r\n\t\"darkblue\": [0, 0, 139],\r\n\t\"darkcyan\": [0, 139, 139],\r\n\t\"darkgoldenrod\": [184, 134, 11],\r\n\t\"darkgray\": [169, 169, 169],\r\n\t\"darkgreen\": [0, 100, 0],\r\n\t\"darkgrey\": [169, 169, 169],\r\n\t\"darkkhaki\": [189, 183, 107],\r\n\t\"darkmagenta\": [139, 0, 139],\r\n\t\"darkolivegreen\": [85, 107, 47],\r\n\t\"darkorange\": [255, 140, 0],\r\n\t\"darkorchid\": [153, 50, 204],\r\n\t\"darkred\": [139, 0, 0],\r\n\t\"darksalmon\": [233, 150, 122],\r\n\t\"darkseagreen\": [143, 188, 143],\r\n\t\"darkslateblue\": [72, 61, 139],\r\n\t\"darkslategray\": [47, 79, 79],\r\n\t\"darkslategrey\": [47, 79, 79],\r\n\t\"darkturquoise\": [0, 206, 209],\r\n\t\"darkviolet\": [148, 0, 211],\r\n\t\"deeppink\": [255, 20, 147],\r\n\t\"deepskyblue\": [0, 191, 255],\r\n\t\"dimgray\": [105, 105, 105],\r\n\t\"dimgrey\": [105, 105, 105],\r\n\t\"dodgerblue\": [30, 144, 255],\r\n\t\"firebrick\": [178, 34, 34],\r\n\t\"floralwhite\": [255, 250, 240],\r\n\t\"forestgreen\": [34, 139, 34],\r\n\t\"fuchsia\": [255, 0, 255],\r\n\t\"gainsboro\": [220, 220, 220],\r\n\t\"ghostwhite\": [248, 248, 255],\r\n\t\"gold\": [255, 215, 0],\r\n\t\"goldenrod\": [218, 165, 32],\r\n\t\"gray\": [128, 128, 128],\r\n\t\"green\": [0, 128, 0],\r\n\t\"greenyellow\": [173, 255, 47],\r\n\t\"grey\": [128, 128, 128],\r\n\t\"honeydew\": [240, 255, 240],\r\n\t\"hotpink\": [255, 105, 180],\r\n\t\"indianred\": [205, 92, 92],\r\n\t\"indigo\": [75, 0, 130],\r\n\t\"ivory\": [255, 255, 240],\r\n\t\"khaki\": [240, 230, 140],\r\n\t\"lavender\": [230, 230, 250],\r\n\t\"lavenderblush\": [255, 240, 245],\r\n\t\"lawngreen\": [124, 252, 0],\r\n\t\"lemonchiffon\": [255, 250, 205],\r\n\t\"lightblue\": [173, 216, 230],\r\n\t\"lightcoral\": [240, 128, 128],\r\n\t\"lightcyan\": [224, 255, 255],\r\n\t\"lightgoldenrodyellow\": [250, 250, 210],\r\n\t\"lightgray\": [211, 211, 211],\r\n\t\"lightgreen\": [144, 238, 144],\r\n\t\"lightgrey\": [211, 211, 211],\r\n\t\"lightpink\": [255, 182, 193],\r\n\t\"lightsalmon\": [255, 160, 122],\r\n\t\"lightseagreen\": [32, 178, 170],\r\n\t\"lightskyblue\": [135, 206, 250],\r\n\t\"lightslategray\": [119, 136, 153],\r\n\t\"lightslategrey\": [119, 136, 153],\r\n\t\"lightsteelblue\": [176, 196, 222],\r\n\t\"lightyellow\": [255, 255, 224],\r\n\t\"lime\": [0, 255, 0],\r\n\t\"limegreen\": [50, 205, 50],\r\n\t\"linen\": [250, 240, 230],\r\n\t\"magenta\": [255, 0, 255],\r\n\t\"maroon\": [128, 0, 0],\r\n\t\"mediumaquamarine\": [102, 205, 170],\r\n\t\"mediumblue\": [0, 0, 205],\r\n\t\"mediumorchid\": [186, 85, 211],\r\n\t\"mediumpurple\": [147, 112, 219],\r\n\t\"mediumseagreen\": [60, 179, 113],\r\n\t\"mediumslateblue\": [123, 104, 238],\r\n\t\"mediumspringgreen\": [0, 250, 154],\r\n\t\"mediumturquoise\": [72, 209, 204],\r\n\t\"mediumvioletred\": [199, 21, 133],\r\n\t\"midnightblue\": [25, 25, 112],\r\n\t\"mintcream\": [245, 255, 250],\r\n\t\"mistyrose\": [255, 228, 225],\r\n\t\"moccasin\": [255, 228, 181],\r\n\t\"navajowhite\": [255, 222, 173],\r\n\t\"navy\": [0, 0, 128],\r\n\t\"oldlace\": [253, 245, 230],\r\n\t\"olive\": [128, 128, 0],\r\n\t\"olivedrab\": [107, 142, 35],\r\n\t\"orange\": [255, 165, 0],\r\n\t\"orangered\": [255, 69, 0],\r\n\t\"orchid\": [218, 112, 214],\r\n\t\"palegoldenrod\": [238, 232, 170],\r\n\t\"palegreen\": [152, 251, 152],\r\n\t\"paleturquoise\": [175, 238, 238],\r\n\t\"palevioletred\": [219, 112, 147],\r\n\t\"papayawhip\": [255, 239, 213],\r\n\t\"peachpuff\": [255, 218, 185],\r\n\t\"peru\": [205, 133, 63],\r\n\t\"pink\": [255, 192, 203],\r\n\t\"plum\": [221, 160, 221],\r\n\t\"powderblue\": [176, 224, 230],\r\n\t\"purple\": [128, 0, 128],\r\n\t\"rebeccapurple\": [102, 51, 153],\r\n\t\"red\": [255, 0, 0],\r\n\t\"rosybrown\": [188, 143, 143],\r\n\t\"royalblue\": [65, 105, 225],\r\n\t\"saddlebrown\": [139, 69, 19],\r\n\t\"salmon\": [250, 128, 114],\r\n\t\"sandybrown\": [244, 164, 96],\r\n\t\"seagreen\": [46, 139, 87],\r\n\t\"seashell\": [255, 245, 238],\r\n\t\"sienna\": [160, 82, 45],\r\n\t\"silver\": [192, 192, 192],\r\n\t\"skyblue\": [135, 206, 235],\r\n\t\"slateblue\": [106, 90, 205],\r\n\t\"slategray\": [112, 128, 144],\r\n\t\"slategrey\": [112, 128, 144],\r\n\t\"snow\": [255, 250, 250],\r\n\t\"springgreen\": [0, 255, 127],\r\n\t\"steelblue\": [70, 130, 180],\r\n\t\"tan\": [210, 180, 140],\r\n\t\"teal\": [0, 128, 128],\r\n\t\"thistle\": [216, 191, 216],\r\n\t\"tomato\": [255, 99, 71],\r\n\t\"turquoise\": [64, 224, 208],\r\n\t\"violet\": [238, 130, 238],\r\n\t\"wheat\": [245, 222, 179],\r\n\t\"white\": [255, 255, 255],\r\n\t\"whitesmoke\": [245, 245, 245],\r\n\t\"yellow\": [255, 255, 0],\r\n\t\"yellowgreen\": [154, 205, 50]\r\n};\r\n","module.exports = function isArrayish(obj) {\n\tif (!obj || typeof obj === 'string') {\n\t\treturn false;\n\t}\n\n\treturn obj instanceof Array || Array.isArray(obj) ||\n\t\t(obj.length >= 0 && (obj.splice instanceof Function ||\n\t\t\t(Object.getOwnPropertyDescriptor(obj, (obj.length - 1)) && obj.constructor.name !== 'String')));\n};\n","'use strict';\n\nvar isArrayish = require('is-arrayish');\n\nvar concat = Array.prototype.concat;\nvar slice = Array.prototype.slice;\n\nvar swizzle = module.exports = function swizzle(args) {\n\tvar results = [];\n\n\tfor (var i = 0, len = args.length; i < len; i++) {\n\t\tvar arg = args[i];\n\n\t\tif (isArrayish(arg)) {\n\t\t\t// http://jsperf.com/javascript-array-concat-vs-push/98\n\t\t\tresults = concat.call(results, slice.call(arg));\n\t\t} else {\n\t\t\tresults.push(arg);\n\t\t}\n\t}\n\n\treturn results;\n};\n\nswizzle.wrap = function (fn) {\n\treturn function () {\n\t\treturn fn(swizzle(arguments));\n\t};\n};\n","/* MIT license */\nvar colorNames = require('color-name');\nvar swizzle = require('simple-swizzle');\nvar hasOwnProperty = Object.hasOwnProperty;\n\nvar reverseNames = Object.create(null);\n\n// create a list of reverse color names\nfor (var name in colorNames) {\n\tif (hasOwnProperty.call(colorNames, name)) {\n\t\treverseNames[colorNames[name]] = name;\n\t}\n}\n\nvar cs = module.exports = {\n\tto: {},\n\tget: {}\n};\n\ncs.get = function (string) {\n\tvar prefix = string.substring(0, 3).toLowerCase();\n\tvar val;\n\tvar model;\n\tswitch (prefix) {\n\t\tcase 'hsl':\n\t\t\tval = cs.get.hsl(string);\n\t\t\tmodel = 'hsl';\n\t\t\tbreak;\n\t\tcase 'hwb':\n\t\t\tval = cs.get.hwb(string);\n\t\t\tmodel = 'hwb';\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tval = cs.get.rgb(string);\n\t\t\tmodel = 'rgb';\n\t\t\tbreak;\n\t}\n\n\tif (!val) {\n\t\treturn null;\n\t}\n\n\treturn {model: model, value: val};\n};\n\ncs.get.rgb = function (string) {\n\tif (!string) {\n\t\treturn null;\n\t}\n\n\tvar abbr = /^#([a-f0-9]{3,4})$/i;\n\tvar hex = /^#([a-f0-9]{6})([a-f0-9]{2})?$/i;\n\tvar rgba = /^rgba?\\(\\s*([+-]?\\d+)(?=[\\s,])\\s*(?:,\\s*)?([+-]?\\d+)(?=[\\s,])\\s*(?:,\\s*)?([+-]?\\d+)\\s*(?:[,|\\/]\\s*([+-]?[\\d\\.]+)(%?)\\s*)?\\)$/;\n\tvar per = /^rgba?\\(\\s*([+-]?[\\d\\.]+)\\%\\s*,?\\s*([+-]?[\\d\\.]+)\\%\\s*,?\\s*([+-]?[\\d\\.]+)\\%\\s*(?:[,|\\/]\\s*([+-]?[\\d\\.]+)(%?)\\s*)?\\)$/;\n\tvar keyword = /^(\\w+)$/;\n\n\tvar rgb = [0, 0, 0, 1];\n\tvar match;\n\tvar i;\n\tvar hexAlpha;\n\n\tif (match = string.match(hex)) {\n\t\thexAlpha = match[2];\n\t\tmatch = match[1];\n\n\t\tfor (i = 0; i < 3; i++) {\n\t\t\t// https://jsperf.com/slice-vs-substr-vs-substring-methods-long-string/19\n\t\t\tvar i2 = i * 2;\n\t\t\trgb[i] = parseInt(match.slice(i2, i2 + 2), 16);\n\t\t}\n\n\t\tif (hexAlpha) {\n\t\t\trgb[3] = parseInt(hexAlpha, 16) / 255;\n\t\t}\n\t} else if (match = string.match(abbr)) {\n\t\tmatch = match[1];\n\t\thexAlpha = match[3];\n\n\t\tfor (i = 0; i < 3; i++) {\n\t\t\trgb[i] = parseInt(match[i] + match[i], 16);\n\t\t}\n\n\t\tif (hexAlpha) {\n\t\t\trgb[3] = parseInt(hexAlpha + hexAlpha, 16) / 255;\n\t\t}\n\t} else if (match = string.match(rgba)) {\n\t\tfor (i = 0; i < 3; i++) {\n\t\t\trgb[i] = parseInt(match[i + 1], 0);\n\t\t}\n\n\t\tif (match[4]) {\n\t\t\tif (match[5]) {\n\t\t\t\trgb[3] = parseFloat(match[4]) * 0.01;\n\t\t\t} else {\n\t\t\t\trgb[3] = parseFloat(match[4]);\n\t\t\t}\n\t\t}\n\t} else if (match = string.match(per)) {\n\t\tfor (i = 0; i < 3; i++) {\n\t\t\trgb[i] = Math.round(parseFloat(match[i + 1]) * 2.55);\n\t\t}\n\n\t\tif (match[4]) {\n\t\t\tif (match[5]) {\n\t\t\t\trgb[3] = parseFloat(match[4]) * 0.01;\n\t\t\t} else {\n\t\t\t\trgb[3] = parseFloat(match[4]);\n\t\t\t}\n\t\t}\n\t} else if (match = string.match(keyword)) {\n\t\tif (match[1] === 'transparent') {\n\t\t\treturn [0, 0, 0, 0];\n\t\t}\n\n\t\tif (!hasOwnProperty.call(colorNames, match[1])) {\n\t\t\treturn null;\n\t\t}\n\n\t\trgb = colorNames[match[1]];\n\t\trgb[3] = 1;\n\n\t\treturn rgb;\n\t} else {\n\t\treturn null;\n\t}\n\n\tfor (i = 0; i < 3; i++) {\n\t\trgb[i] = clamp(rgb[i], 0, 255);\n\t}\n\trgb[3] = clamp(rgb[3], 0, 1);\n\n\treturn rgb;\n};\n\ncs.get.hsl = function (string) {\n\tif (!string) {\n\t\treturn null;\n\t}\n\n\tvar hsl = /^hsla?\\(\\s*([+-]?(?:\\d{0,3}\\.)?\\d+)(?:deg)?\\s*,?\\s*([+-]?[\\d\\.]+)%\\s*,?\\s*([+-]?[\\d\\.]+)%\\s*(?:[,|\\/]\\s*([+-]?(?=\\.\\d|\\d)(?:0|[1-9]\\d*)?(?:\\.\\d*)?(?:[eE][+-]?\\d+)?)\\s*)?\\)$/;\n\tvar match = string.match(hsl);\n\n\tif (match) {\n\t\tvar alpha = parseFloat(match[4]);\n\t\tvar h = ((parseFloat(match[1]) % 360) + 360) % 360;\n\t\tvar s = clamp(parseFloat(match[2]), 0, 100);\n\t\tvar l = clamp(parseFloat(match[3]), 0, 100);\n\t\tvar a = clamp(isNaN(alpha) ? 1 : alpha, 0, 1);\n\n\t\treturn [h, s, l, a];\n\t}\n\n\treturn null;\n};\n\ncs.get.hwb = function (string) {\n\tif (!string) {\n\t\treturn null;\n\t}\n\n\tvar hwb = /^hwb\\(\\s*([+-]?\\d{0,3}(?:\\.\\d+)?)(?:deg)?\\s*,\\s*([+-]?[\\d\\.]+)%\\s*,\\s*([+-]?[\\d\\.]+)%\\s*(?:,\\s*([+-]?(?=\\.\\d|\\d)(?:0|[1-9]\\d*)?(?:\\.\\d*)?(?:[eE][+-]?\\d+)?)\\s*)?\\)$/;\n\tvar match = string.match(hwb);\n\n\tif (match) {\n\t\tvar alpha = parseFloat(match[4]);\n\t\tvar h = ((parseFloat(match[1]) % 360) + 360) % 360;\n\t\tvar w = clamp(parseFloat(match[2]), 0, 100);\n\t\tvar b = clamp(parseFloat(match[3]), 0, 100);\n\t\tvar a = clamp(isNaN(alpha) ? 1 : alpha, 0, 1);\n\t\treturn [h, w, b, a];\n\t}\n\n\treturn null;\n};\n\ncs.to.hex = function () {\n\tvar rgba = swizzle(arguments);\n\n\treturn (\n\t\t'#' +\n\t\thexDouble(rgba[0]) +\n\t\thexDouble(rgba[1]) +\n\t\thexDouble(rgba[2]) +\n\t\t(rgba[3] < 1\n\t\t\t? (hexDouble(Math.round(rgba[3] * 255)))\n\t\t\t: '')\n\t);\n};\n\ncs.to.rgb = function () {\n\tvar rgba = swizzle(arguments);\n\n\treturn rgba.length < 4 || rgba[3] === 1\n\t\t? 'rgb(' + Math.round(rgba[0]) + ', ' + Math.round(rgba[1]) + ', ' + Math.round(rgba[2]) + ')'\n\t\t: 'rgba(' + Math.round(rgba[0]) + ', ' + Math.round(rgba[1]) + ', ' + Math.round(rgba[2]) + ', ' + rgba[3] + ')';\n};\n\ncs.to.rgb.percent = function () {\n\tvar rgba = swizzle(arguments);\n\n\tvar r = Math.round(rgba[0] / 255 * 100);\n\tvar g = Math.round(rgba[1] / 255 * 100);\n\tvar b = Math.round(rgba[2] / 255 * 100);\n\n\treturn rgba.length < 4 || rgba[3] === 1\n\t\t? 'rgb(' + r + '%, ' + g + '%, ' + b + '%)'\n\t\t: 'rgba(' + r + '%, ' + g + '%, ' + b + '%, ' + rgba[3] + ')';\n};\n\ncs.to.hsl = function () {\n\tvar hsla = swizzle(arguments);\n\treturn hsla.length < 4 || hsla[3] === 1\n\t\t? 'hsl(' + hsla[0] + ', ' + hsla[1] + '%, ' + hsla[2] + '%)'\n\t\t: 'hsla(' + hsla[0] + ', ' + hsla[1] + '%, ' + hsla[2] + '%, ' + hsla[3] + ')';\n};\n\n// hwb is a bit different than rgb(a) & hsl(a) since there is no alpha specific syntax\n// (hwb have alpha optional & 1 is default value)\ncs.to.hwb = function () {\n\tvar hwba = swizzle(arguments);\n\n\tvar a = '';\n\tif (hwba.length >= 4 && hwba[3] !== 1) {\n\t\ta = ', ' + hwba[3];\n\t}\n\n\treturn 'hwb(' + hwba[0] + ', ' + hwba[1] + '%, ' + hwba[2] + '%' + a + ')';\n};\n\ncs.to.keyword = function (rgb) {\n\treturn reverseNames[rgb.slice(0, 3)];\n};\n\n// helpers\nfunction clamp(num, min, max) {\n\treturn Math.min(Math.max(min, num), max);\n}\n\nfunction hexDouble(num) {\n\tvar str = Math.round(num).toString(16).toUpperCase();\n\treturn (str.length < 2) ? '0' + str : str;\n}\n","/* MIT license */\n/* eslint-disable no-mixed-operators */\nconst cssKeywords = require('color-name');\n\n// NOTE: conversions should only return primitive values (i.e. arrays, or\n//       values that give correct `typeof` results).\n//       do not use box values types (i.e. Number(), String(), etc.)\n\nconst reverseKeywords = {};\nfor (const key of Object.keys(cssKeywords)) {\n\treverseKeywords[cssKeywords[key]] = key;\n}\n\nconst convert = {\n\trgb: {channels: 3, labels: 'rgb'},\n\thsl: {channels: 3, labels: 'hsl'},\n\thsv: {channels: 3, labels: 'hsv'},\n\thwb: {channels: 3, labels: 'hwb'},\n\tcmyk: {channels: 4, labels: 'cmyk'},\n\txyz: {channels: 3, labels: 'xyz'},\n\tlab: {channels: 3, labels: 'lab'},\n\tlch: {channels: 3, labels: 'lch'},\n\thex: {channels: 1, labels: ['hex']},\n\tkeyword: {channels: 1, labels: ['keyword']},\n\tansi16: {channels: 1, labels: ['ansi16']},\n\tansi256: {channels: 1, labels: ['ansi256']},\n\thcg: {channels: 3, labels: ['h', 'c', 'g']},\n\tapple: {channels: 3, labels: ['r16', 'g16', 'b16']},\n\tgray: {channels: 1, labels: ['gray']}\n};\n\nmodule.exports = convert;\n\n// Hide .channels and .labels properties\nfor (const model of Object.keys(convert)) {\n\tif (!('channels' in convert[model])) {\n\t\tthrow new Error('missing channels property: ' + model);\n\t}\n\n\tif (!('labels' in convert[model])) {\n\t\tthrow new Error('missing channel labels property: ' + model);\n\t}\n\n\tif (convert[model].labels.length !== convert[model].channels) {\n\t\tthrow new Error('channel and label counts mismatch: ' + model);\n\t}\n\n\tconst {channels, labels} = convert[model];\n\tdelete convert[model].channels;\n\tdelete convert[model].labels;\n\tObject.defineProperty(convert[model], 'channels', {value: channels});\n\tObject.defineProperty(convert[model], 'labels', {value: labels});\n}\n\nconvert.rgb.hsl = function (rgb) {\n\tconst r = rgb[0] / 255;\n\tconst g = rgb[1] / 255;\n\tconst b = rgb[2] / 255;\n\tconst min = Math.min(r, g, b);\n\tconst max = Math.max(r, g, b);\n\tconst delta = max - min;\n\tlet h;\n\tlet s;\n\n\tif (max === min) {\n\t\th = 0;\n\t} else if (r === max) {\n\t\th = (g - b) / delta;\n\t} else if (g === max) {\n\t\th = 2 + (b - r) / delta;\n\t} else if (b === max) {\n\t\th = 4 + (r - g) / delta;\n\t}\n\n\th = Math.min(h * 60, 360);\n\n\tif (h < 0) {\n\t\th += 360;\n\t}\n\n\tconst l = (min + max) / 2;\n\n\tif (max === min) {\n\t\ts = 0;\n\t} else if (l <= 0.5) {\n\t\ts = delta / (max + min);\n\t} else {\n\t\ts = delta / (2 - max - min);\n\t}\n\n\treturn [h, s * 100, l * 100];\n};\n\nconvert.rgb.hsv = function (rgb) {\n\tlet rdif;\n\tlet gdif;\n\tlet bdif;\n\tlet h;\n\tlet s;\n\n\tconst r = rgb[0] / 255;\n\tconst g = rgb[1] / 255;\n\tconst b = rgb[2] / 255;\n\tconst v = Math.max(r, g, b);\n\tconst diff = v - Math.min(r, g, b);\n\tconst diffc = function (c) {\n\t\treturn (v - c) / 6 / diff + 1 / 2;\n\t};\n\n\tif (diff === 0) {\n\t\th = 0;\n\t\ts = 0;\n\t} else {\n\t\ts = diff / v;\n\t\trdif = diffc(r);\n\t\tgdif = diffc(g);\n\t\tbdif = diffc(b);\n\n\t\tif (r === v) {\n\t\t\th = bdif - gdif;\n\t\t} else if (g === v) {\n\t\t\th = (1 / 3) + rdif - bdif;\n\t\t} else if (b === v) {\n\t\t\th = (2 / 3) + gdif - rdif;\n\t\t}\n\n\t\tif (h < 0) {\n\t\t\th += 1;\n\t\t} else if (h > 1) {\n\t\t\th -= 1;\n\t\t}\n\t}\n\n\treturn [\n\t\th * 360,\n\t\ts * 100,\n\t\tv * 100\n\t];\n};\n\nconvert.rgb.hwb = function (rgb) {\n\tconst r = rgb[0];\n\tconst g = rgb[1];\n\tlet b = rgb[2];\n\tconst h = convert.rgb.hsl(rgb)[0];\n\tconst w = 1 / 255 * Math.min(r, Math.min(g, b));\n\n\tb = 1 - 1 / 255 * Math.max(r, Math.max(g, b));\n\n\treturn [h, w * 100, b * 100];\n};\n\nconvert.rgb.cmyk = function (rgb) {\n\tconst r = rgb[0] / 255;\n\tconst g = rgb[1] / 255;\n\tconst b = rgb[2] / 255;\n\n\tconst k = Math.min(1 - r, 1 - g, 1 - b);\n\tconst c = (1 - r - k) / (1 - k) || 0;\n\tconst m = (1 - g - k) / (1 - k) || 0;\n\tconst y = (1 - b - k) / (1 - k) || 0;\n\n\treturn [c * 100, m * 100, y * 100, k * 100];\n};\n\nfunction comparativeDistance(x, y) {\n\t/*\n\t\tSee https://en.m.wikipedia.org/wiki/Euclidean_distance#Squared_Euclidean_distance\n\t*/\n\treturn (\n\t\t((x[0] - y[0]) ** 2) +\n\t\t((x[1] - y[1]) ** 2) +\n\t\t((x[2] - y[2]) ** 2)\n\t);\n}\n\nconvert.rgb.keyword = function (rgb) {\n\tconst reversed = reverseKeywords[rgb];\n\tif (reversed) {\n\t\treturn reversed;\n\t}\n\n\tlet currentClosestDistance = Infinity;\n\tlet currentClosestKeyword;\n\n\tfor (const keyword of Object.keys(cssKeywords)) {\n\t\tconst value = cssKeywords[keyword];\n\n\t\t// Compute comparative distance\n\t\tconst distance = comparativeDistance(rgb, value);\n\n\t\t// Check if its less, if so set as closest\n\t\tif (distance < currentClosestDistance) {\n\t\t\tcurrentClosestDistance = distance;\n\t\t\tcurrentClosestKeyword = keyword;\n\t\t}\n\t}\n\n\treturn currentClosestKeyword;\n};\n\nconvert.keyword.rgb = function (keyword) {\n\treturn cssKeywords[keyword];\n};\n\nconvert.rgb.xyz = function (rgb) {\n\tlet r = rgb[0] / 255;\n\tlet g = rgb[1] / 255;\n\tlet b = rgb[2] / 255;\n\n\t// Assume sRGB\n\tr = r > 0.04045 ? (((r + 0.055) / 1.055) ** 2.4) : (r / 12.92);\n\tg = g > 0.04045 ? (((g + 0.055) / 1.055) ** 2.4) : (g / 12.92);\n\tb = b > 0.04045 ? (((b + 0.055) / 1.055) ** 2.4) : (b / 12.92);\n\n\tconst x = (r * 0.4124) + (g * 0.3576) + (b * 0.1805);\n\tconst y = (r * 0.2126) + (g * 0.7152) + (b * 0.0722);\n\tconst z = (r * 0.0193) + (g * 0.1192) + (b * 0.9505);\n\n\treturn [x * 100, y * 100, z * 100];\n};\n\nconvert.rgb.lab = function (rgb) {\n\tconst xyz = convert.rgb.xyz(rgb);\n\tlet x = xyz[0];\n\tlet y = xyz[1];\n\tlet z = xyz[2];\n\n\tx /= 95.047;\n\ty /= 100;\n\tz /= 108.883;\n\n\tx = x > 0.008856 ? (x ** (1 / 3)) : (7.787 * x) + (16 / 116);\n\ty = y > 0.008856 ? (y ** (1 / 3)) : (7.787 * y) + (16 / 116);\n\tz = z > 0.008856 ? (z ** (1 / 3)) : (7.787 * z) + (16 / 116);\n\n\tconst l = (116 * y) - 16;\n\tconst a = 500 * (x - y);\n\tconst b = 200 * (y - z);\n\n\treturn [l, a, b];\n};\n\nconvert.hsl.rgb = function (hsl) {\n\tconst h = hsl[0] / 360;\n\tconst s = hsl[1] / 100;\n\tconst l = hsl[2] / 100;\n\tlet t2;\n\tlet t3;\n\tlet val;\n\n\tif (s === 0) {\n\t\tval = l * 255;\n\t\treturn [val, val, val];\n\t}\n\n\tif (l < 0.5) {\n\t\tt2 = l * (1 + s);\n\t} else {\n\t\tt2 = l + s - l * s;\n\t}\n\n\tconst t1 = 2 * l - t2;\n\n\tconst rgb = [0, 0, 0];\n\tfor (let i = 0; i < 3; i++) {\n\t\tt3 = h + 1 / 3 * -(i - 1);\n\t\tif (t3 < 0) {\n\t\t\tt3++;\n\t\t}\n\n\t\tif (t3 > 1) {\n\t\t\tt3--;\n\t\t}\n\n\t\tif (6 * t3 < 1) {\n\t\t\tval = t1 + (t2 - t1) * 6 * t3;\n\t\t} else if (2 * t3 < 1) {\n\t\t\tval = t2;\n\t\t} else if (3 * t3 < 2) {\n\t\t\tval = t1 + (t2 - t1) * (2 / 3 - t3) * 6;\n\t\t} else {\n\t\t\tval = t1;\n\t\t}\n\n\t\trgb[i] = val * 255;\n\t}\n\n\treturn rgb;\n};\n\nconvert.hsl.hsv = function (hsl) {\n\tconst h = hsl[0];\n\tlet s = hsl[1] / 100;\n\tlet l = hsl[2] / 100;\n\tlet smin = s;\n\tconst lmin = Math.max(l, 0.01);\n\n\tl *= 2;\n\ts *= (l <= 1) ? l : 2 - l;\n\tsmin *= lmin <= 1 ? lmin : 2 - lmin;\n\tconst v = (l + s) / 2;\n\tconst sv = l === 0 ? (2 * smin) / (lmin + smin) : (2 * s) / (l + s);\n\n\treturn [h, sv * 100, v * 100];\n};\n\nconvert.hsv.rgb = function (hsv) {\n\tconst h = hsv[0] / 60;\n\tconst s = hsv[1] / 100;\n\tlet v = hsv[2] / 100;\n\tconst hi = Math.floor(h) % 6;\n\n\tconst f = h - Math.floor(h);\n\tconst p = 255 * v * (1 - s);\n\tconst q = 255 * v * (1 - (s * f));\n\tconst t = 255 * v * (1 - (s * (1 - f)));\n\tv *= 255;\n\n\tswitch (hi) {\n\t\tcase 0:\n\t\t\treturn [v, t, p];\n\t\tcase 1:\n\t\t\treturn [q, v, p];\n\t\tcase 2:\n\t\t\treturn [p, v, t];\n\t\tcase 3:\n\t\t\treturn [p, q, v];\n\t\tcase 4:\n\t\t\treturn [t, p, v];\n\t\tcase 5:\n\t\t\treturn [v, p, q];\n\t}\n};\n\nconvert.hsv.hsl = function (hsv) {\n\tconst h = hsv[0];\n\tconst s = hsv[1] / 100;\n\tconst v = hsv[2] / 100;\n\tconst vmin = Math.max(v, 0.01);\n\tlet sl;\n\tlet l;\n\n\tl = (2 - s) * v;\n\tconst lmin = (2 - s) * vmin;\n\tsl = s * vmin;\n\tsl /= (lmin <= 1) ? lmin : 2 - lmin;\n\tsl = sl || 0;\n\tl /= 2;\n\n\treturn [h, sl * 100, l * 100];\n};\n\n// http://dev.w3.org/csswg/css-color/#hwb-to-rgb\nconvert.hwb.rgb = function (hwb) {\n\tconst h = hwb[0] / 360;\n\tlet wh = hwb[1] / 100;\n\tlet bl = hwb[2] / 100;\n\tconst ratio = wh + bl;\n\tlet f;\n\n\t// Wh + bl cant be > 1\n\tif (ratio > 1) {\n\t\twh /= ratio;\n\t\tbl /= ratio;\n\t}\n\n\tconst i = Math.floor(6 * h);\n\tconst v = 1 - bl;\n\tf = 6 * h - i;\n\n\tif ((i & 0x01) !== 0) {\n\t\tf = 1 - f;\n\t}\n\n\tconst n = wh + f * (v - wh); // Linear interpolation\n\n\tlet r;\n\tlet g;\n\tlet b;\n\t/* eslint-disable max-statements-per-line,no-multi-spaces */\n\tswitch (i) {\n\t\tdefault:\n\t\tcase 6:\n\t\tcase 0: r = v;  g = n;  b = wh; break;\n\t\tcase 1: r = n;  g = v;  b = wh; break;\n\t\tcase 2: r = wh; g = v;  b = n; break;\n\t\tcase 3: r = wh; g = n;  b = v; break;\n\t\tcase 4: r = n;  g = wh; b = v; break;\n\t\tcase 5: r = v;  g = wh; b = n; break;\n\t}\n\t/* eslint-enable max-statements-per-line,no-multi-spaces */\n\n\treturn [r * 255, g * 255, b * 255];\n};\n\nconvert.cmyk.rgb = function (cmyk) {\n\tconst c = cmyk[0] / 100;\n\tconst m = cmyk[1] / 100;\n\tconst y = cmyk[2] / 100;\n\tconst k = cmyk[3] / 100;\n\n\tconst r = 1 - Math.min(1, c * (1 - k) + k);\n\tconst g = 1 - Math.min(1, m * (1 - k) + k);\n\tconst b = 1 - Math.min(1, y * (1 - k) + k);\n\n\treturn [r * 255, g * 255, b * 255];\n};\n\nconvert.xyz.rgb = function (xyz) {\n\tconst x = xyz[0] / 100;\n\tconst y = xyz[1] / 100;\n\tconst z = xyz[2] / 100;\n\tlet r;\n\tlet g;\n\tlet b;\n\n\tr = (x * 3.2406) + (y * -1.5372) + (z * -0.4986);\n\tg = (x * -0.9689) + (y * 1.8758) + (z * 0.0415);\n\tb = (x * 0.0557) + (y * -0.2040) + (z * 1.0570);\n\n\t// Assume sRGB\n\tr = r > 0.0031308\n\t\t? ((1.055 * (r ** (1.0 / 2.4))) - 0.055)\n\t\t: r * 12.92;\n\n\tg = g > 0.0031308\n\t\t? ((1.055 * (g ** (1.0 / 2.4))) - 0.055)\n\t\t: g * 12.92;\n\n\tb = b > 0.0031308\n\t\t? ((1.055 * (b ** (1.0 / 2.4))) - 0.055)\n\t\t: b * 12.92;\n\n\tr = Math.min(Math.max(0, r), 1);\n\tg = Math.min(Math.max(0, g), 1);\n\tb = Math.min(Math.max(0, b), 1);\n\n\treturn [r * 255, g * 255, b * 255];\n};\n\nconvert.xyz.lab = function (xyz) {\n\tlet x = xyz[0];\n\tlet y = xyz[1];\n\tlet z = xyz[2];\n\n\tx /= 95.047;\n\ty /= 100;\n\tz /= 108.883;\n\n\tx = x > 0.008856 ? (x ** (1 / 3)) : (7.787 * x) + (16 / 116);\n\ty = y > 0.008856 ? (y ** (1 / 3)) : (7.787 * y) + (16 / 116);\n\tz = z > 0.008856 ? (z ** (1 / 3)) : (7.787 * z) + (16 / 116);\n\n\tconst l = (116 * y) - 16;\n\tconst a = 500 * (x - y);\n\tconst b = 200 * (y - z);\n\n\treturn [l, a, b];\n};\n\nconvert.lab.xyz = function (lab) {\n\tconst l = lab[0];\n\tconst a = lab[1];\n\tconst b = lab[2];\n\tlet x;\n\tlet y;\n\tlet z;\n\n\ty = (l + 16) / 116;\n\tx = a / 500 + y;\n\tz = y - b / 200;\n\n\tconst y2 = y ** 3;\n\tconst x2 = x ** 3;\n\tconst z2 = z ** 3;\n\ty = y2 > 0.008856 ? y2 : (y - 16 / 116) / 7.787;\n\tx = x2 > 0.008856 ? x2 : (x - 16 / 116) / 7.787;\n\tz = z2 > 0.008856 ? z2 : (z - 16 / 116) / 7.787;\n\n\tx *= 95.047;\n\ty *= 100;\n\tz *= 108.883;\n\n\treturn [x, y, z];\n};\n\nconvert.lab.lch = function (lab) {\n\tconst l = lab[0];\n\tconst a = lab[1];\n\tconst b = lab[2];\n\tlet h;\n\n\tconst hr = Math.atan2(b, a);\n\th = hr * 360 / 2 / Math.PI;\n\n\tif (h < 0) {\n\t\th += 360;\n\t}\n\n\tconst c = Math.sqrt(a * a + b * b);\n\n\treturn [l, c, h];\n};\n\nconvert.lch.lab = function (lch) {\n\tconst l = lch[0];\n\tconst c = lch[1];\n\tconst h = lch[2];\n\n\tconst hr = h / 360 * 2 * Math.PI;\n\tconst a = c * Math.cos(hr);\n\tconst b = c * Math.sin(hr);\n\n\treturn [l, a, b];\n};\n\nconvert.rgb.ansi16 = function (args, saturation = null) {\n\tconst [r, g, b] = args;\n\tlet value = saturation === null ? convert.rgb.hsv(args)[2] : saturation; // Hsv -> ansi16 optimization\n\n\tvalue = Math.round(value / 50);\n\n\tif (value === 0) {\n\t\treturn 30;\n\t}\n\n\tlet ansi = 30\n\t\t+ ((Math.round(b / 255) << 2)\n\t\t| (Math.round(g / 255) << 1)\n\t\t| Math.round(r / 255));\n\n\tif (value === 2) {\n\t\tansi += 60;\n\t}\n\n\treturn ansi;\n};\n\nconvert.hsv.ansi16 = function (args) {\n\t// Optimization here; we already know the value and don't need to get\n\t// it converted for us.\n\treturn convert.rgb.ansi16(convert.hsv.rgb(args), args[2]);\n};\n\nconvert.rgb.ansi256 = function (args) {\n\tconst r = args[0];\n\tconst g = args[1];\n\tconst b = args[2];\n\n\t// We use the extended greyscale palette here, with the exception of\n\t// black and white. normal palette only has 4 greyscale shades.\n\tif (r === g && g === b) {\n\t\tif (r < 8) {\n\t\t\treturn 16;\n\t\t}\n\n\t\tif (r > 248) {\n\t\t\treturn 231;\n\t\t}\n\n\t\treturn Math.round(((r - 8) / 247) * 24) + 232;\n\t}\n\n\tconst ansi = 16\n\t\t+ (36 * Math.round(r / 255 * 5))\n\t\t+ (6 * Math.round(g / 255 * 5))\n\t\t+ Math.round(b / 255 * 5);\n\n\treturn ansi;\n};\n\nconvert.ansi16.rgb = function (args) {\n\tlet color = args % 10;\n\n\t// Handle greyscale\n\tif (color === 0 || color === 7) {\n\t\tif (args > 50) {\n\t\t\tcolor += 3.5;\n\t\t}\n\n\t\tcolor = color / 10.5 * 255;\n\n\t\treturn [color, color, color];\n\t}\n\n\tconst mult = (~~(args > 50) + 1) * 0.5;\n\tconst r = ((color & 1) * mult) * 255;\n\tconst g = (((color >> 1) & 1) * mult) * 255;\n\tconst b = (((color >> 2) & 1) * mult) * 255;\n\n\treturn [r, g, b];\n};\n\nconvert.ansi256.rgb = function (args) {\n\t// Handle greyscale\n\tif (args >= 232) {\n\t\tconst c = (args - 232) * 10 + 8;\n\t\treturn [c, c, c];\n\t}\n\n\targs -= 16;\n\n\tlet rem;\n\tconst r = Math.floor(args / 36) / 5 * 255;\n\tconst g = Math.floor((rem = args % 36) / 6) / 5 * 255;\n\tconst b = (rem % 6) / 5 * 255;\n\n\treturn [r, g, b];\n};\n\nconvert.rgb.hex = function (args) {\n\tconst integer = ((Math.round(args[0]) & 0xFF) << 16)\n\t\t+ ((Math.round(args[1]) & 0xFF) << 8)\n\t\t+ (Math.round(args[2]) & 0xFF);\n\n\tconst string = integer.toString(16).toUpperCase();\n\treturn '000000'.substring(string.length) + string;\n};\n\nconvert.hex.rgb = function (args) {\n\tconst match = args.toString(16).match(/[a-f0-9]{6}|[a-f0-9]{3}/i);\n\tif (!match) {\n\t\treturn [0, 0, 0];\n\t}\n\n\tlet colorString = match[0];\n\n\tif (match[0].length === 3) {\n\t\tcolorString = colorString.split('').map(char => {\n\t\t\treturn char + char;\n\t\t}).join('');\n\t}\n\n\tconst integer = parseInt(colorString, 16);\n\tconst r = (integer >> 16) & 0xFF;\n\tconst g = (integer >> 8) & 0xFF;\n\tconst b = integer & 0xFF;\n\n\treturn [r, g, b];\n};\n\nconvert.rgb.hcg = function (rgb) {\n\tconst r = rgb[0] / 255;\n\tconst g = rgb[1] / 255;\n\tconst b = rgb[2] / 255;\n\tconst max = Math.max(Math.max(r, g), b);\n\tconst min = Math.min(Math.min(r, g), b);\n\tconst chroma = (max - min);\n\tlet grayscale;\n\tlet hue;\n\n\tif (chroma < 1) {\n\t\tgrayscale = min / (1 - chroma);\n\t} else {\n\t\tgrayscale = 0;\n\t}\n\n\tif (chroma <= 0) {\n\t\thue = 0;\n\t} else\n\tif (max === r) {\n\t\thue = ((g - b) / chroma) % 6;\n\t} else\n\tif (max === g) {\n\t\thue = 2 + (b - r) / chroma;\n\t} else {\n\t\thue = 4 + (r - g) / chroma;\n\t}\n\n\thue /= 6;\n\thue %= 1;\n\n\treturn [hue * 360, chroma * 100, grayscale * 100];\n};\n\nconvert.hsl.hcg = function (hsl) {\n\tconst s = hsl[1] / 100;\n\tconst l = hsl[2] / 100;\n\n\tconst c = l < 0.5 ? (2.0 * s * l) : (2.0 * s * (1.0 - l));\n\n\tlet f = 0;\n\tif (c < 1.0) {\n\t\tf = (l - 0.5 * c) / (1.0 - c);\n\t}\n\n\treturn [hsl[0], c * 100, f * 100];\n};\n\nconvert.hsv.hcg = function (hsv) {\n\tconst s = hsv[1] / 100;\n\tconst v = hsv[2] / 100;\n\n\tconst c = s * v;\n\tlet f = 0;\n\n\tif (c < 1.0) {\n\t\tf = (v - c) / (1 - c);\n\t}\n\n\treturn [hsv[0], c * 100, f * 100];\n};\n\nconvert.hcg.rgb = function (hcg) {\n\tconst h = hcg[0] / 360;\n\tconst c = hcg[1] / 100;\n\tconst g = hcg[2] / 100;\n\n\tif (c === 0.0) {\n\t\treturn [g * 255, g * 255, g * 255];\n\t}\n\n\tconst pure = [0, 0, 0];\n\tconst hi = (h % 1) * 6;\n\tconst v = hi % 1;\n\tconst w = 1 - v;\n\tlet mg = 0;\n\n\t/* eslint-disable max-statements-per-line */\n\tswitch (Math.floor(hi)) {\n\t\tcase 0:\n\t\t\tpure[0] = 1; pure[1] = v; pure[2] = 0; break;\n\t\tcase 1:\n\t\t\tpure[0] = w; pure[1] = 1; pure[2] = 0; break;\n\t\tcase 2:\n\t\t\tpure[0] = 0; pure[1] = 1; pure[2] = v; break;\n\t\tcase 3:\n\t\t\tpure[0] = 0; pure[1] = w; pure[2] = 1; break;\n\t\tcase 4:\n\t\t\tpure[0] = v; pure[1] = 0; pure[2] = 1; break;\n\t\tdefault:\n\t\t\tpure[0] = 1; pure[1] = 0; pure[2] = w;\n\t}\n\t/* eslint-enable max-statements-per-line */\n\n\tmg = (1.0 - c) * g;\n\n\treturn [\n\t\t(c * pure[0] + mg) * 255,\n\t\t(c * pure[1] + mg) * 255,\n\t\t(c * pure[2] + mg) * 255\n\t];\n};\n\nconvert.hcg.hsv = function (hcg) {\n\tconst c = hcg[1] / 100;\n\tconst g = hcg[2] / 100;\n\n\tconst v = c + g * (1.0 - c);\n\tlet f = 0;\n\n\tif (v > 0.0) {\n\t\tf = c / v;\n\t}\n\n\treturn [hcg[0], f * 100, v * 100];\n};\n\nconvert.hcg.hsl = function (hcg) {\n\tconst c = hcg[1] / 100;\n\tconst g = hcg[2] / 100;\n\n\tconst l = g * (1.0 - c) + 0.5 * c;\n\tlet s = 0;\n\n\tif (l > 0.0 && l < 0.5) {\n\t\ts = c / (2 * l);\n\t} else\n\tif (l >= 0.5 && l < 1.0) {\n\t\ts = c / (2 * (1 - l));\n\t}\n\n\treturn [hcg[0], s * 100, l * 100];\n};\n\nconvert.hcg.hwb = function (hcg) {\n\tconst c = hcg[1] / 100;\n\tconst g = hcg[2] / 100;\n\tconst v = c + g * (1.0 - c);\n\treturn [hcg[0], (v - c) * 100, (1 - v) * 100];\n};\n\nconvert.hwb.hcg = function (hwb) {\n\tconst w = hwb[1] / 100;\n\tconst b = hwb[2] / 100;\n\tconst v = 1 - b;\n\tconst c = v - w;\n\tlet g = 0;\n\n\tif (c < 1) {\n\t\tg = (v - c) / (1 - c);\n\t}\n\n\treturn [hwb[0], c * 100, g * 100];\n};\n\nconvert.apple.rgb = function (apple) {\n\treturn [(apple[0] / 65535) * 255, (apple[1] / 65535) * 255, (apple[2] / 65535) * 255];\n};\n\nconvert.rgb.apple = function (rgb) {\n\treturn [(rgb[0] / 255) * 65535, (rgb[1] / 255) * 65535, (rgb[2] / 255) * 65535];\n};\n\nconvert.gray.rgb = function (args) {\n\treturn [args[0] / 100 * 255, args[0] / 100 * 255, args[0] / 100 * 255];\n};\n\nconvert.gray.hsl = function (args) {\n\treturn [0, 0, args[0]];\n};\n\nconvert.gray.hsv = convert.gray.hsl;\n\nconvert.gray.hwb = function (gray) {\n\treturn [0, 100, gray[0]];\n};\n\nconvert.gray.cmyk = function (gray) {\n\treturn [0, 0, 0, gray[0]];\n};\n\nconvert.gray.lab = function (gray) {\n\treturn [gray[0], 0, 0];\n};\n\nconvert.gray.hex = function (gray) {\n\tconst val = Math.round(gray[0] / 100 * 255) & 0xFF;\n\tconst integer = (val << 16) + (val << 8) + val;\n\n\tconst string = integer.toString(16).toUpperCase();\n\treturn '000000'.substring(string.length) + string;\n};\n\nconvert.rgb.gray = function (rgb) {\n\tconst val = (rgb[0] + rgb[1] + rgb[2]) / 3;\n\treturn [val / 255 * 100];\n};\n","const conversions = require('./conversions');\n\n/*\n\tThis function routes a model to all other models.\n\n\tall functions that are routed have a property `.conversion` attached\n\tto the returned synthetic function. This property is an array\n\tof strings, each with the steps in between the 'from' and 'to'\n\tcolor models (inclusive).\n\n\tconversions that are not possible simply are not included.\n*/\n\nfunction buildGraph() {\n\tconst graph = {};\n\t// https://jsperf.com/object-keys-vs-for-in-with-closure/3\n\tconst models = Object.keys(conversions);\n\n\tfor (let len = models.length, i = 0; i < len; i++) {\n\t\tgraph[models[i]] = {\n\t\t\t// http://jsperf.com/1-vs-infinity\n\t\t\t// micro-opt, but this is simple.\n\t\t\tdistance: -1,\n\t\t\tparent: null\n\t\t};\n\t}\n\n\treturn graph;\n}\n\n// https://en.wikipedia.org/wiki/Breadth-first_search\nfunction deriveBFS(fromModel) {\n\tconst graph = buildGraph();\n\tconst queue = [fromModel]; // Unshift -> queue -> pop\n\n\tgraph[fromModel].distance = 0;\n\n\twhile (queue.length) {\n\t\tconst current = queue.pop();\n\t\tconst adjacents = Object.keys(conversions[current]);\n\n\t\tfor (let len = adjacents.length, i = 0; i < len; i++) {\n\t\t\tconst adjacent = adjacents[i];\n\t\t\tconst node = graph[adjacent];\n\n\t\t\tif (node.distance === -1) {\n\t\t\t\tnode.distance = graph[current].distance + 1;\n\t\t\t\tnode.parent = current;\n\t\t\t\tqueue.unshift(adjacent);\n\t\t\t}\n\t\t}\n\t}\n\n\treturn graph;\n}\n\nfunction link(from, to) {\n\treturn function (args) {\n\t\treturn to(from(args));\n\t};\n}\n\nfunction wrapConversion(toModel, graph) {\n\tconst path = [graph[toModel].parent, toModel];\n\tlet fn = conversions[graph[toModel].parent][toModel];\n\n\tlet cur = graph[toModel].parent;\n\twhile (graph[cur].parent) {\n\t\tpath.unshift(graph[cur].parent);\n\t\tfn = link(conversions[graph[cur].parent][cur], fn);\n\t\tcur = graph[cur].parent;\n\t}\n\n\tfn.conversion = path;\n\treturn fn;\n}\n\nmodule.exports = function (fromModel) {\n\tconst graph = deriveBFS(fromModel);\n\tconst conversion = {};\n\n\tconst models = Object.keys(graph);\n\tfor (let len = models.length, i = 0; i < len; i++) {\n\t\tconst toModel = models[i];\n\t\tconst node = graph[toModel];\n\n\t\tif (node.parent === null) {\n\t\t\t// No possible conversion, or this node is the source model.\n\t\t\tcontinue;\n\t\t}\n\n\t\tconversion[toModel] = wrapConversion(toModel, graph);\n\t}\n\n\treturn conversion;\n};\n\n","const conversions = require('./conversions');\nconst route = require('./route');\n\nconst convert = {};\n\nconst models = Object.keys(conversions);\n\nfunction wrapRaw(fn) {\n\tconst wrappedFn = function (...args) {\n\t\tconst arg0 = args[0];\n\t\tif (arg0 === undefined || arg0 === null) {\n\t\t\treturn arg0;\n\t\t}\n\n\t\tif (arg0.length > 1) {\n\t\t\targs = arg0;\n\t\t}\n\n\t\treturn fn(args);\n\t};\n\n\t// Preserve .conversion property if there is one\n\tif ('conversion' in fn) {\n\t\twrappedFn.conversion = fn.conversion;\n\t}\n\n\treturn wrappedFn;\n}\n\nfunction wrapRounded(fn) {\n\tconst wrappedFn = function (...args) {\n\t\tconst arg0 = args[0];\n\n\t\tif (arg0 === undefined || arg0 === null) {\n\t\t\treturn arg0;\n\t\t}\n\n\t\tif (arg0.length > 1) {\n\t\t\targs = arg0;\n\t\t}\n\n\t\tconst result = fn(args);\n\n\t\t// We're assuming the result is an array here.\n\t\t// see notice in conversions.js; don't use box types\n\t\t// in conversion functions.\n\t\tif (typeof result === 'object') {\n\t\t\tfor (let len = result.length, i = 0; i < len; i++) {\n\t\t\t\tresult[i] = Math.round(result[i]);\n\t\t\t}\n\t\t}\n\n\t\treturn result;\n\t};\n\n\t// Preserve .conversion property if there is one\n\tif ('conversion' in fn) {\n\t\twrappedFn.conversion = fn.conversion;\n\t}\n\n\treturn wrappedFn;\n}\n\nmodels.forEach(fromModel => {\n\tconvert[fromModel] = {};\n\n\tObject.defineProperty(convert[fromModel], 'channels', {value: conversions[fromModel].channels});\n\tObject.defineProperty(convert[fromModel], 'labels', {value: conversions[fromModel].labels});\n\n\tconst routes = route(fromModel);\n\tconst routeModels = Object.keys(routes);\n\n\trouteModels.forEach(toModel => {\n\t\tconst fn = routes[toModel];\n\n\t\tconvert[fromModel][toModel] = wrapRounded(fn);\n\t\tconvert[fromModel][toModel].raw = wrapRaw(fn);\n\t});\n});\n\nmodule.exports = convert;\n","const colorString = require('color-string');\nconst convert = require('color-convert');\n\nconst skippedModels = [\n\t// To be honest, I don't really feel like keyword belongs in color convert, but eh.\n\t'keyword',\n\n\t// Gray conflicts with some method names, and has its own method defined.\n\t'gray',\n\n\t// Shouldn't really be in color-convert either...\n\t'hex',\n];\n\nconst hashedModelKeys = {};\nfor (const model of Object.keys(convert)) {\n\thashedModelKeys[[...convert[model].labels].sort().join('')] = model;\n}\n\nconst limiters = {};\n\nfunction Color(object, model) {\n\tif (!(this instanceof Color)) {\n\t\treturn new Color(object, model);\n\t}\n\n\tif (model && model in skippedModels) {\n\t\tmodel = null;\n\t}\n\n\tif (model && !(model in convert)) {\n\t\tthrow new Error('Unknown model: ' + model);\n\t}\n\n\tlet i;\n\tlet channels;\n\n\tif (object == null) { // eslint-disable-line no-eq-null,eqeqeq\n\t\tthis.model = 'rgb';\n\t\tthis.color = [0, 0, 0];\n\t\tthis.valpha = 1;\n\t} else if (object instanceof Color) {\n\t\tthis.model = object.model;\n\t\tthis.color = [...object.color];\n\t\tthis.valpha = object.valpha;\n\t} else if (typeof object === 'string') {\n\t\tconst result = colorString.get(object);\n\t\tif (result === null) {\n\t\t\tthrow new Error('Unable to parse color from string: ' + object);\n\t\t}\n\n\t\tthis.model = result.model;\n\t\tchannels = convert[this.model].channels;\n\t\tthis.color = result.value.slice(0, channels);\n\t\tthis.valpha = typeof result.value[channels] === 'number' ? result.value[channels] : 1;\n\t} else if (object.length > 0) {\n\t\tthis.model = model || 'rgb';\n\t\tchannels = convert[this.model].channels;\n\t\tconst newArray = Array.prototype.slice.call(object, 0, channels);\n\t\tthis.color = zeroArray(newArray, channels);\n\t\tthis.valpha = typeof object[channels] === 'number' ? object[channels] : 1;\n\t} else if (typeof object === 'number') {\n\t\t// This is always RGB - can be converted later on.\n\t\tthis.model = 'rgb';\n\t\tthis.color = [\n\t\t\t(object >> 16) & 0xFF,\n\t\t\t(object >> 8) & 0xFF,\n\t\t\tobject & 0xFF,\n\t\t];\n\t\tthis.valpha = 1;\n\t} else {\n\t\tthis.valpha = 1;\n\n\t\tconst keys = Object.keys(object);\n\t\tif ('alpha' in object) {\n\t\t\tkeys.splice(keys.indexOf('alpha'), 1);\n\t\t\tthis.valpha = typeof object.alpha === 'number' ? object.alpha : 0;\n\t\t}\n\n\t\tconst hashedKeys = keys.sort().join('');\n\t\tif (!(hashedKeys in hashedModelKeys)) {\n\t\t\tthrow new Error('Unable to parse color from object: ' + JSON.stringify(object));\n\t\t}\n\n\t\tthis.model = hashedModelKeys[hashedKeys];\n\n\t\tconst {labels} = convert[this.model];\n\t\tconst color = [];\n\t\tfor (i = 0; i < labels.length; i++) {\n\t\t\tcolor.push(object[labels[i]]);\n\t\t}\n\n\t\tthis.color = zeroArray(color);\n\t}\n\n\t// Perform limitations (clamping, etc.)\n\tif (limiters[this.model]) {\n\t\tchannels = convert[this.model].channels;\n\t\tfor (i = 0; i < channels; i++) {\n\t\t\tconst limit = limiters[this.model][i];\n\t\t\tif (limit) {\n\t\t\t\tthis.color[i] = limit(this.color[i]);\n\t\t\t}\n\t\t}\n\t}\n\n\tthis.valpha = Math.max(0, Math.min(1, this.valpha));\n\n\tif (Object.freeze) {\n\t\tObject.freeze(this);\n\t}\n}\n\nColor.prototype = {\n\ttoString() {\n\t\treturn this.string();\n\t},\n\n\ttoJSON() {\n\t\treturn this[this.model]();\n\t},\n\n\tstring(places) {\n\t\tlet self = this.model in colorString.to ? this : this.rgb();\n\t\tself = self.round(typeof places === 'number' ? places : 1);\n\t\tconst args = self.valpha === 1 ? self.color : [...self.color, this.valpha];\n\t\treturn colorString.to[self.model](args);\n\t},\n\n\tpercentString(places) {\n\t\tconst self = this.rgb().round(typeof places === 'number' ? places : 1);\n\t\tconst args = self.valpha === 1 ? self.color : [...self.color, this.valpha];\n\t\treturn colorString.to.rgb.percent(args);\n\t},\n\n\tarray() {\n\t\treturn this.valpha === 1 ? [...this.color] : [...this.color, this.valpha];\n\t},\n\n\tobject() {\n\t\tconst result = {};\n\t\tconst {channels} = convert[this.model];\n\t\tconst {labels} = convert[this.model];\n\n\t\tfor (let i = 0; i < channels; i++) {\n\t\t\tresult[labels[i]] = this.color[i];\n\t\t}\n\n\t\tif (this.valpha !== 1) {\n\t\t\tresult.alpha = this.valpha;\n\t\t}\n\n\t\treturn result;\n\t},\n\n\tunitArray() {\n\t\tconst rgb = this.rgb().color;\n\t\trgb[0] /= 255;\n\t\trgb[1] /= 255;\n\t\trgb[2] /= 255;\n\n\t\tif (this.valpha !== 1) {\n\t\t\trgb.push(this.valpha);\n\t\t}\n\n\t\treturn rgb;\n\t},\n\n\tunitObject() {\n\t\tconst rgb = this.rgb().object();\n\t\trgb.r /= 255;\n\t\trgb.g /= 255;\n\t\trgb.b /= 255;\n\n\t\tif (this.valpha !== 1) {\n\t\t\trgb.alpha = this.valpha;\n\t\t}\n\n\t\treturn rgb;\n\t},\n\n\tround(places) {\n\t\tplaces = Math.max(places || 0, 0);\n\t\treturn new Color([...this.color.map(roundToPlace(places)), this.valpha], this.model);\n\t},\n\n\talpha(value) {\n\t\tif (value !== undefined) {\n\t\t\treturn new Color([...this.color, Math.max(0, Math.min(1, value))], this.model);\n\t\t}\n\n\t\treturn this.valpha;\n\t},\n\n\t// Rgb\n\tred: getset('rgb', 0, maxfn(255)),\n\tgreen: getset('rgb', 1, maxfn(255)),\n\tblue: getset('rgb', 2, maxfn(255)),\n\n\thue: getset(['hsl', 'hsv', 'hsl', 'hwb', 'hcg'], 0, value => ((value % 360) + 360) % 360),\n\n\tsaturationl: getset('hsl', 1, maxfn(100)),\n\tlightness: getset('hsl', 2, maxfn(100)),\n\n\tsaturationv: getset('hsv', 1, maxfn(100)),\n\tvalue: getset('hsv', 2, maxfn(100)),\n\n\tchroma: getset('hcg', 1, maxfn(100)),\n\tgray: getset('hcg', 2, maxfn(100)),\n\n\twhite: getset('hwb', 1, maxfn(100)),\n\twblack: getset('hwb', 2, maxfn(100)),\n\n\tcyan: getset('cmyk', 0, maxfn(100)),\n\tmagenta: getset('cmyk', 1, maxfn(100)),\n\tyellow: getset('cmyk', 2, maxfn(100)),\n\tblack: getset('cmyk', 3, maxfn(100)),\n\n\tx: getset('xyz', 0, maxfn(95.047)),\n\ty: getset('xyz', 1, maxfn(100)),\n\tz: getset('xyz', 2, maxfn(108.833)),\n\n\tl: getset('lab', 0, maxfn(100)),\n\ta: getset('lab', 1),\n\tb: getset('lab', 2),\n\n\tkeyword(value) {\n\t\tif (value !== undefined) {\n\t\t\treturn new Color(value);\n\t\t}\n\n\t\treturn convert[this.model].keyword(this.color);\n\t},\n\n\thex(value) {\n\t\tif (value !== undefined) {\n\t\t\treturn new Color(value);\n\t\t}\n\n\t\treturn colorString.to.hex(this.rgb().round().color);\n\t},\n\n\thexa(value) {\n\t\tif (value !== undefined) {\n\t\t\treturn new Color(value);\n\t\t}\n\n\t\tconst rgbArray = this.rgb().round().color;\n\n\t\tlet alphaHex = Math.round(this.valpha * 255).toString(16).toUpperCase();\n\t\tif (alphaHex.length === 1) {\n\t\t\talphaHex = '0' + alphaHex;\n\t\t}\n\n\t\treturn colorString.to.hex(rgbArray) + alphaHex;\n\t},\n\n\trgbNumber() {\n\t\tconst rgb = this.rgb().color;\n\t\treturn ((rgb[0] & 0xFF) << 16) | ((rgb[1] & 0xFF) << 8) | (rgb[2] & 0xFF);\n\t},\n\n\tluminosity() {\n\t\t// http://www.w3.org/TR/WCAG20/#relativeluminancedef\n\t\tconst rgb = this.rgb().color;\n\n\t\tconst lum = [];\n\t\tfor (const [i, element] of rgb.entries()) {\n\t\t\tconst chan = element / 255;\n\t\t\tlum[i] = (chan <= 0.04045) ? chan / 12.92 : ((chan + 0.055) / 1.055) ** 2.4;\n\t\t}\n\n\t\treturn 0.2126 * lum[0] + 0.7152 * lum[1] + 0.0722 * lum[2];\n\t},\n\n\tcontrast(color2) {\n\t\t// http://www.w3.org/TR/WCAG20/#contrast-ratiodef\n\t\tconst lum1 = this.luminosity();\n\t\tconst lum2 = color2.luminosity();\n\n\t\tif (lum1 > lum2) {\n\t\t\treturn (lum1 + 0.05) / (lum2 + 0.05);\n\t\t}\n\n\t\treturn (lum2 + 0.05) / (lum1 + 0.05);\n\t},\n\n\tlevel(color2) {\n\t\t// https://www.w3.org/TR/WCAG/#contrast-enhanced\n\t\tconst contrastRatio = this.contrast(color2);\n\t\tif (contrastRatio >= 7) {\n\t\t\treturn 'AAA';\n\t\t}\n\n\t\treturn (contrastRatio >= 4.5) ? 'AA' : '';\n\t},\n\n\tisDark() {\n\t\t// YIQ equation from http://24ways.org/2010/calculating-color-contrast\n\t\tconst rgb = this.rgb().color;\n\t\tconst yiq = (rgb[0] * 2126 + rgb[1] * 7152 + rgb[2] * 722) / 10000;\n\t\treturn yiq < 128;\n\t},\n\n\tisLight() {\n\t\treturn !this.isDark();\n\t},\n\n\tnegate() {\n\t\tconst rgb = this.rgb();\n\t\tfor (let i = 0; i < 3; i++) {\n\t\t\trgb.color[i] = 255 - rgb.color[i];\n\t\t}\n\n\t\treturn rgb;\n\t},\n\n\tlighten(ratio) {\n\t\tconst hsl = this.hsl();\n\t\thsl.color[2] += hsl.color[2] * ratio;\n\t\treturn hsl;\n\t},\n\n\tdarken(ratio) {\n\t\tconst hsl = this.hsl();\n\t\thsl.color[2] -= hsl.color[2] * ratio;\n\t\treturn hsl;\n\t},\n\n\tsaturate(ratio) {\n\t\tconst hsl = this.hsl();\n\t\thsl.color[1] += hsl.color[1] * ratio;\n\t\treturn hsl;\n\t},\n\n\tdesaturate(ratio) {\n\t\tconst hsl = this.hsl();\n\t\thsl.color[1] -= hsl.color[1] * ratio;\n\t\treturn hsl;\n\t},\n\n\twhiten(ratio) {\n\t\tconst hwb = this.hwb();\n\t\thwb.color[1] += hwb.color[1] * ratio;\n\t\treturn hwb;\n\t},\n\n\tblacken(ratio) {\n\t\tconst hwb = this.hwb();\n\t\thwb.color[2] += hwb.color[2] * ratio;\n\t\treturn hwb;\n\t},\n\n\tgrayscale() {\n\t\t// http://en.wikipedia.org/wiki/Grayscale#Converting_color_to_grayscale\n\t\tconst rgb = this.rgb().color;\n\t\tconst value = rgb[0] * 0.3 + rgb[1] * 0.59 + rgb[2] * 0.11;\n\t\treturn Color.rgb(value, value, value);\n\t},\n\n\tfade(ratio) {\n\t\treturn this.alpha(this.valpha - (this.valpha * ratio));\n\t},\n\n\topaquer(ratio) {\n\t\treturn this.alpha(this.valpha + (this.valpha * ratio));\n\t},\n\n\trotate(degrees) {\n\t\tconst hsl = this.hsl();\n\t\tlet hue = hsl.color[0];\n\t\thue = (hue + degrees) % 360;\n\t\thue = hue < 0 ? 360 + hue : hue;\n\t\thsl.color[0] = hue;\n\t\treturn hsl;\n\t},\n\n\tmix(mixinColor, weight) {\n\t\t// Ported from sass implementation in C\n\t\t// https://github.com/sass/libsass/blob/0e6b4a2850092356aa3ece07c6b249f0221caced/functions.cpp#L209\n\t\tif (!mixinColor || !mixinColor.rgb) {\n\t\t\tthrow new Error('Argument to \"mix\" was not a Color instance, but rather an instance of ' + typeof mixinColor);\n\t\t}\n\n\t\tconst color1 = mixinColor.rgb();\n\t\tconst color2 = this.rgb();\n\t\tconst p = weight === undefined ? 0.5 : weight;\n\n\t\tconst w = 2 * p - 1;\n\t\tconst a = color1.alpha() - color2.alpha();\n\n\t\tconst w1 = (((w * a === -1) ? w : (w + a) / (1 + w * a)) + 1) / 2;\n\t\tconst w2 = 1 - w1;\n\n\t\treturn Color.rgb(\n\t\t\tw1 * color1.red() + w2 * color2.red(),\n\t\t\tw1 * color1.green() + w2 * color2.green(),\n\t\t\tw1 * color1.blue() + w2 * color2.blue(),\n\t\t\tcolor1.alpha() * p + color2.alpha() * (1 - p));\n\t},\n};\n\n// Model conversion methods and static constructors\nfor (const model of Object.keys(convert)) {\n\tif (skippedModels.includes(model)) {\n\t\tcontinue;\n\t}\n\n\tconst {channels} = convert[model];\n\n\t// Conversion methods\n\tColor.prototype[model] = function (...args) {\n\t\tif (this.model === model) {\n\t\t\treturn new Color(this);\n\t\t}\n\n\t\tif (args.length > 0) {\n\t\t\treturn new Color(args, model);\n\t\t}\n\n\t\treturn new Color([...assertArray(convert[this.model][model].raw(this.color)), this.valpha], model);\n\t};\n\n\t// 'static' construction methods\n\tColor[model] = function (...args) {\n\t\tlet color = args[0];\n\t\tif (typeof color === 'number') {\n\t\t\tcolor = zeroArray(args, channels);\n\t\t}\n\n\t\treturn new Color(color, model);\n\t};\n}\n\nfunction roundTo(number, places) {\n\treturn Number(number.toFixed(places));\n}\n\nfunction roundToPlace(places) {\n\treturn function (number) {\n\t\treturn roundTo(number, places);\n\t};\n}\n\nfunction getset(model, channel, modifier) {\n\tmodel = Array.isArray(model) ? model : [model];\n\n\tfor (const m of model) {\n\t\t(limiters[m] || (limiters[m] = []))[channel] = modifier;\n\t}\n\n\tmodel = model[0];\n\n\treturn function (value) {\n\t\tlet result;\n\n\t\tif (value !== undefined) {\n\t\t\tif (modifier) {\n\t\t\t\tvalue = modifier(value);\n\t\t\t}\n\n\t\t\tresult = this[model]();\n\t\t\tresult.color[channel] = value;\n\t\t\treturn result;\n\t\t}\n\n\t\tresult = this[model]().color[channel];\n\t\tif (modifier) {\n\t\t\tresult = modifier(result);\n\t\t}\n\n\t\treturn result;\n\t};\n}\n\nfunction maxfn(max) {\n\treturn function (v) {\n\t\treturn Math.max(0, Math.min(max, v));\n\t};\n}\n\nfunction assertArray(value) {\n\treturn Array.isArray(value) ? value : [value];\n}\n\nfunction zeroArray(array, length) {\n\tfor (let i = 0; i < length; i++) {\n\t\tif (typeof array[i] !== 'number') {\n\t\t\tarray[i] = 0;\n\t\t}\n\t}\n\n\treturn array;\n}\n\nmodule.exports = Color;\n","export class SaxEventType {\n    // 1\n    static Text = 0b1;\n    // 2\n    static ProcessingInstruction = 0b10;\n    // 4\n    static SGMLDeclaration = 0b100;\n    // 8\n    static Doctype = 0b1000;\n    // 16\n    static Comment = 0b10000;\n    // 32\n    static OpenTagStart = 0b100000;\n    // 64\n    static Attribute = 0b1000000;\n    // 128\n    static OpenTag = 0b10000000;\n    // 256\n    static CloseTag = 0b100000000;\n    // 512\n    static Cdata = 0b1000000000;\n}\nexport class Reader {\n    data;\n    cache = {};\n    ptr;\n    constructor(data, ptr = 0) {\n        this.data = data;\n        this.ptr = ptr;\n    }\n}\nexport class Position {\n    line;\n    character;\n    constructor(line, character) {\n        this.line = line;\n        this.character = character;\n    }\n}\nexport var AttributeType;\n(function (AttributeType) {\n    AttributeType[AttributeType[\"Normal\"] = 0] = \"Normal\";\n    AttributeType[AttributeType[\"JSX\"] = 1] = \"JSX\";\n})(AttributeType || (AttributeType = {}));\nexport class Attribute extends Reader {\n    type;\n    name;\n    value;\n    constructor(buffer, ptr = 0) {\n        super(buffer, ptr);\n        this.type = buffer[ptr];\n        ptr += 1;\n        const len = readU32(buffer, ptr);\n        ptr += 4;\n        this.name = new Text(buffer, ptr);\n        ptr += len;\n        this.value = new Text(buffer, ptr);\n    }\n    toJSON() {\n        const { name, value, type } = this;\n        return { name, value, type };\n    }\n    toString() {\n        const { name, value } = this;\n        return `${name}=\"${value}\"`;\n    }\n}\nexport class ProcInst extends Reader {\n    target;\n    content;\n    constructor(buffer, ptr = 0) {\n        super(buffer, ptr);\n        ptr += 16;\n        const len = readU32(buffer, ptr);\n        ptr += 4;\n        this.target = new Text(buffer, ptr);\n        ptr += len;\n        this.content = new Text(buffer, ptr);\n    }\n    get start() {\n        return this.cache.start || (this.cache.start = readPosition(this.data, this.ptr));\n    }\n    get end() {\n        return this.cache.end || (this.cache.end = readPosition(this.data, this.ptr + 8));\n    }\n    toJSON() {\n        const { start, end, target, content } = this;\n        return { start, end, target, content };\n    }\n    toString() {\n        const { target, content } = this;\n        return `<? ${target} ${content} ?>`;\n    }\n}\nexport class Text extends Reader {\n    get start() {\n        return this.cache.start || (this.cache.start = readPosition(this.data, this.ptr));\n    }\n    get end() {\n        return this.cache.end || (this.cache.end = readPosition(this.data, this.ptr + 8));\n    }\n    get value() {\n        if (this.cache.value) {\n            return this.cache.value;\n        }\n        const valueLen = readU32(this.data, this.ptr + 16);\n        return (this.cache.value = readString(this.data, this.ptr + 20, valueLen));\n    }\n    toJSON() {\n        const { start, end, value } = this;\n        return { start, end, value };\n    }\n    toString() {\n        return this.value;\n    }\n}\nexport class Tag extends Reader {\n    get openStart() {\n        return this.cache.openStart || (this.cache.openStart = readPosition(this.data, this.ptr + 8));\n    }\n    get openEnd() {\n        return this.cache.openEnd || (this.cache.openEnd = readPosition(this.data, this.ptr + 16));\n    }\n    get closeStart() {\n        return this.cache.closeStart || (this.cache.closeStart = readPosition(this.data, this.ptr + 24));\n    }\n    get closeEnd() {\n        return this.cache.closeEnd || (this.cache.closeEnd = readPosition(this.data, this.ptr + 32));\n    }\n    get selfClosing() {\n        return !!this.data[this.ptr + 40];\n    }\n    get name() {\n        if (this.cache.name) {\n            return this.cache.name;\n        }\n        const nameLen = readU32(this.data, this.ptr + 41);\n        return (this.cache.name = readString(this.data, this.ptr + 45, nameLen));\n    }\n    get attributes() {\n        if (this.cache.attributes) {\n            return this.cache.attributes;\n        }\n        // starting location of the attribute block\n        let ptr = readU32(this.data, this.ptr);\n        const numAttrs = readU32(this.data, ptr);\n        ptr += 4;\n        const attributes = [];\n        for (let i = 0; i < numAttrs; i++) {\n            const attrLen = readU32(this.data, ptr);\n            ptr += 4;\n            attributes[i] = new Attribute(this.data, ptr);\n            ptr += attrLen;\n        }\n        return (this.cache.attributes = attributes);\n    }\n    get textNodes() {\n        if (this.cache.textNodes) {\n            return this.cache.textNodes;\n        }\n        // starting location of the text nodes block\n        let ptr = readU32(this.data, this.ptr + 4);\n        const numTextNodes = readU32(this.data, ptr);\n        const textNodes = [];\n        ptr += 4;\n        for (let i = 0; i < numTextNodes; i++) {\n            const textLen = readU32(this.data, ptr);\n            ptr += 4;\n            textNodes[i] = new Text(this.data, ptr);\n            ptr += textLen;\n        }\n        return (this.cache.textNodes = textNodes);\n    }\n    toJSON() {\n        const { openStart, openEnd, closeStart, closeEnd, name, attributes, textNodes, selfClosing } = this;\n        return { openStart, openEnd, closeStart, closeEnd, name, attributes, textNodes, selfClosing };\n    }\n    get value() {\n        return this.name;\n    }\n}\nexport class SAXParser {\n    static textDecoder; // Web only\n    events;\n    wasmSaxParser;\n    eventHandler;\n    writeBuffer;\n    constructor(events = 0) {\n        const self = this;\n        Object.defineProperties(this, {\n            events: {\n                get: () => ~~events,\n                set: (value) => {\n                    events = ~~value;\n                    if (self.wasmSaxParser) {\n                        self.wasmSaxParser.parser(events);\n                    }\n                }, configurable: false, enumerable: true\n            }\n        });\n    }\n    async *parse(reader) {\n        let eventAggregator = [];\n        this.eventHandler = function (event, detail) { eventAggregator.push([event, detail]); };\n        while (true) {\n            const chunk = await reader.read();\n            if (chunk.done)\n                return this.end();\n            this.write(chunk.value);\n            if (eventAggregator.length) {\n                for (const event of eventAggregator) {\n                    yield event;\n                }\n                eventAggregator.length = 0;\n            }\n        }\n    }\n    write(chunk) {\n        if (!this.wasmSaxParser) {\n            return;\n        }\n        const { write, memory } = this.wasmSaxParser;\n        // Allocations within the WASM process\n        // invalidate reference to the memory buffer.\n        // We check for this and create a new Uint8Array\n        // with the new memory buffer reference if needed.\n        // **NOTE** These allocations can slow down parsing\n        // if they become excessive. Consider adjusting the\n        // highWaterMark in the options up or down to find the optimal\n        // memory allocation to prevent too many new Uint8Array instances.\n        if (!this.writeBuffer || this.writeBuffer.buffer !== memory.buffer) {\n            this.writeBuffer = new Uint8Array(memory.buffer);\n        }\n        this.writeBuffer.set(chunk, 0);\n        write(0, chunk.byteLength);\n    }\n    end() {\n        this.writeBuffer = undefined;\n        this.wasmSaxParser?.end();\n    }\n    async prepareWasm(saxWasm) {\n        let result;\n        const env = {\n            memory: new WebAssembly.Memory({ initial: 10, shared: true, maximum: 150 }),\n            table: new WebAssembly.Table({ initial: 1, element: 'anyfunc' }),\n            event_listener: this.eventTrap\n        };\n        if (saxWasm instanceof Uint8Array) {\n            result = await WebAssembly.instantiate(saxWasm, { env });\n        }\n        else {\n            result = await WebAssembly.instantiateStreaming(saxWasm, { env });\n        }\n        if (result && typeof this.events === 'number') {\n            const { parser } = this.wasmSaxParser = result.instance.exports;\n            parser(this.events);\n            return true;\n        }\n        throw new Error(`Failed to instantiate the parser.`);\n    }\n    eventTrap = (event, ptr, len) => {\n        if (!this.wasmSaxParser) {\n            return;\n        }\n        const array = new Uint8Array(this.wasmSaxParser.memory.buffer, ptr, len);\n        const uint8array = new Uint8Array(array);\n        let detail;\n        switch (event) {\n            case SaxEventType.Attribute:\n                detail = new Attribute(uint8array);\n                break;\n            case SaxEventType.ProcessingInstruction:\n                detail = new ProcInst(uint8array);\n                break;\n            case SaxEventType.OpenTag:\n            case SaxEventType.CloseTag:\n            case SaxEventType.OpenTagStart:\n                detail = new Tag(uint8array);\n                break;\n            case SaxEventType.Text:\n            case SaxEventType.Cdata:\n            case SaxEventType.Comment:\n            case SaxEventType.Doctype:\n            case SaxEventType.SGMLDeclaration:\n                detail = new Text(uint8array);\n                break;\n            default:\n                throw new Error('No reader for this event type');\n        }\n        if (this.eventHandler) {\n            this.eventHandler(event, detail);\n        }\n    };\n}\nconst readString = (data, offset, length) => {\n    // Node\n    if (globalThis.hasOwnProperty('Buffer')) {\n        return Buffer.from(data.buffer, data.byteOffset + offset, length).toString();\n    }\n    // Web\n    return (SAXParser.textDecoder || (SAXParser.textDecoder = new TextDecoder()))\n        .decode(data.subarray(offset, offset + length));\n};\nconst readU32 = (uint8Array, ptr) => (uint8Array[ptr + 3] << 24) | (uint8Array[ptr + 2] << 16) | (uint8Array[ptr + 1] << 8) | uint8Array[ptr];\nconst readPosition = (uint8Array, ptr = 0) => {\n    const line = readU32(uint8Array, ptr);\n    const character = readU32(uint8Array, ptr + 4);\n    return new Position(line, character);\n};\n","import { PdfDictionary } from './common.js';\nimport { Annotation } from '../iiif.js';\nimport {\n  BoxSelector,\n  SelectorStyle,\n  SupportedSelector,\n  SvgSelector,\n} from '@iiif/helpers';\nimport { PointSelector } from '@iiif/presentation-3';\nimport Color from 'color';\nimport { SAXParser, SaxEventType, Text } from 'sax-wasm';\nimport { textEncoder } from './util.js';\n\nconst ALLOWED_CSS_RULES = [\n  'text-align',\n  'vertical-align',\n  'font-size',\n  'font-weight',\n  'font-style',\n  'font-family',\n  'font',\n  'color',\n  'text-decoration',\n  'font-stretch',\n];\nconst CSS_PAT = /\\s*(?<attrib>[^:]+)\\s*:\\s*(?<val>[^;]+)(?:;|$)/gm;\nconst RGB_PAT = /rgb\\((?<r>\\d+)\\s*,\\s*(?<g>\\d+)\\s*,\\s*(?<b>\\d+)\\)/;\nconst CSS_LENGTH_PAT = /(?<val>\\d+(?:\\.\\d+)?)\\s*(?<unit>[[a-z%]+)?/;\n\nfunction sanitizeCssForPdf(styleAttrib: string): string {\n  let parts: RegExpExecArray | null;\n  const out: Array<string> = [];\n  while ((parts = CSS_PAT.exec(styleAttrib)) !== null) {\n    const [, attrib, value] = parts;\n    if (!ALLOWED_CSS_RULES.includes(attrib)) {\n      continue;\n    }\n    out.push(`${attrib}: ${value}`);\n  }\n  return out.join('; ');\n}\n\nfunction htmlToPlainText(html: string): string {\n  const parser = new SAXParser(SaxEventType.Text);\n  const txt: string[] = [];\n  parser.eventHandler = (ev, data) => {\n    txt.push((data as Text).value);\n  }\n  parser.write(textEncoder.encode(html));\n  return txt.join('').trim();\n}\n\nfunction toPdfRect(\n  selector: BoxSelector | SvgSelector,\n  pageHeight: number,\n  unitScale: number\n): PdfDictionary | null {\n  if (!selector.spatial) {\n    return null;\n  }\n  const lly = pageHeight - selector.spatial.y;\n  const ury = lly - selector.spatial.height;\n  return {\n    Subtype: '/Square',\n    Rect: [\n      selector.spatial.x * unitScale,\n      lly * unitScale,\n      (selector.spatial.x + selector.spatial.width) * unitScale,\n      ury * unitScale,\n    ],\n  };\n}\n\nfunction cssColorToRgb(cssColor: string): [number, number, number] | null {\n  return Color(cssColor).rgb().array() as [number, number, number];\n}\n\nfunction cssLengthToPdfUserspace(\n  cssLength: string,\n  unitScale: number,\n  referenceDimensionPx?: number\n): number | null {\n  const match = CSS_LENGTH_PAT.exec(cssLength);\n  if (!match || !match.groups) {\n    return null;\n  }\n  const val = parseFloat(match.groups.val);\n  const unit = match.groups.unit;\n  if (!unit) {\n    return val * unitScale;\n  }\n  switch (unit) {\n    case '%':\n      if (!referenceDimensionPx) {\n        return null;\n      }\n      return (val / 100) * referenceDimensionPx * unitScale;\n    case 'px':\n      return unitScale * val;\n    default:\n      console.warn(`Unsupported CSS length unit: ${unit}`);\n      return null;\n  }\n}\n\nfunction selectorStyleToPdf(\n  style: SelectorStyle,\n  unitScale: number\n): PdfDictionary {\n  const pdfStyle: PdfDictionary = {};\n  if (style.stroke || style.strokeDasharray || style.strokeWidth) {\n    pdfStyle.BS = {\n      Type: '/Border',\n      W: style.strokeWidth ?? 1,\n      S: style.strokeDasharray ? '/D' : '/S',\n    };\n    if (style.strokeDasharray) {\n      pdfStyle.BS.D = style.strokeDasharray;\n    }\n  }\n  if (style.fill) {\n    const rgb = cssColorToRgb(style.fill);\n    if (rgb) {\n      pdfStyle.IC = rgb.map((c) => c / 255);\n    }\n  }\n  // TODO: Check if fill-opacity is desired and use an Apperance Stream instead of IC\n  if (style.strokeWidth) {\n    const width = cssLengthToPdfUserspace(style.strokeWidth, unitScale);\n    pdfStyle.BS = {\n      Type: '/Border',\n      W: width,\n    };\n  }\n  return pdfStyle;\n}\n\nfunction selectorToPdf(\n  selector: SupportedSelector,\n  unitScale: number,\n  pageHeight: number\n): PdfDictionary {\n  const styleDict = selector.style\n    ? selectorStyleToPdf(selector.style, unitScale)\n    : {};\n  switch (selector.type) {\n    case 'BoxSelector':\n      return {\n        Subtype: '/Square',\n        ...toPdfRect(selector as BoxSelector, pageHeight, unitScale),\n        ...styleDict,\n      };\n    case 'PointSelector': {\n      // TODO: Use a /Stamp with a custom icon (flag?)\n      //       This is a bit complicated since we need to povide\n      //       an /AP dictionary with a custom /Form that\n      //       renders our icon. Luckily, this can be reused, so\n      //       we store it once and just reference it in all point-type\n      //       annotations.\n      const point = selector as PointSelector;\n      if (!point.x || !point.y) {\n        throw `Only PointSelectors with both x and y coordinates are supported!`;\n      }\n      return {\n        Subtype: '/Circle',\n        BS: {\n          Type: '/Border',\n          W: 2,\n          S: '/S',\n        },\n        IC: [1.0, 1.0, 1.0],\n        Rect: [\n          point.x * unitScale - 0.5,\n          point.y * unitScale - 0.5,\n          point.x * unitScale + 1.0,\n          point.y * unitScale + 1.0,\n        ],\n      };\n    }\n    case 'SvgSelector': {\n      const svgSel = selector as SvgSelector;\n      switch (svgSel.svgShape) {\n        case 'rect':\n          return {\n            Subtype: '/Square',\n            ...toPdfRect(svgSel, pageHeight, unitScale),\n            ...styleDict,\n          };\n        case 'circle':\n        case 'ellipse':\n          return {\n            Subtype: '/Circle',\n            Rect: toPdfRect(svgSel, pageHeight, unitScale),\n            ...styleDict,\n          };\n        case 'polyline':\n        case 'polygon':\n          return {\n            Subtype: svgSel.svgShape === 'polyline' ? '/PolyLine' : '/Polygon',\n            Vertices:\n              svgSel.points?.flatMap(([x, y]) => [\n                x * unitScale,\n                (pageHeight - y) * unitScale,\n              ]) ?? [],\n            ...styleDict,\n          };\n        case 'path':\n          return {\n            Subtype: '/Ink',\n            InkList:\n              svgSel.points?.flatMap(([x, y]) => [\n                x * unitScale,\n                (pageHeight - y) * unitScale,\n              ]) ?? [],\n            ...styleDict,\n          };\n        default:\n          throw new Error('not implemented yet');\n      }\n    }\n    default:\n      throw `${selector.type} selector is currently not supported`;\n  }\n}\n\nexport function exportPdfAnnotation(\n  anno: Annotation,\n  unitScale: number,\n  pageHeight: number\n): Array<PdfDictionary> {\n  const annoDict: PdfDictionary = {\n    Type: '/Annot',\n    NM: `(${anno.id})`,\n    Contents: `(${htmlToPlainText(anno.markup)})`,\n    F: 4,\n    C: [1, 0, 0], // Red title bar\n    CA: 1, // Constant opacity of 1\n    Border: [0, 0, 5],\n    //RC: `(${htmlToPdfRichText(anno.markup)})`,\n  };\n  if (anno.author) {\n    annoDict.T = `(${anno.author})`;\n  }\n  if (anno.lastModified) {\n    annoDict.M = anno.lastModified;\n  }\n  if (anno.target.selector) {\n    return [\n      {\n        ...annoDict,\n        ...selectorToPdf(anno.target.selector, unitScale, pageHeight),\n      },\n    ] as PdfDictionary[];\n  } else if (anno.target.selectors && anno.target.selectors.length > 0) {\n    return anno.target.selectors.map((s) => ({\n      ...annoDict,\n      ...selectorToPdf(s, unitScale, pageHeight),\n    })) as PdfDictionary[];\n  }\n  return [];\n}\n","/* eslint-disable no-new-wrappers */\n/* eslint-disable @typescript-eslint/no-non-null-assertion */\n\n/// PDF generation code\n// FIXME: This is currently one hell of a mess, learning about PDF and coming up\n// with good abstractions at the same time was too much of a challenge for me \nimport dedent from 'dedent-js';\nimport { Manifest } from '@iiif/presentation-3';\nimport { Manifest as ManifestV2 } from '@iiif/presentation-2';\nimport { OcrPage, OcrBlock, OcrParagraph, OcrLine, OcrWord } from 'ocr-parser';\n\nimport {\n  Metadata,\n  PdfObject,\n  PdfDictionary,\n  makeRef,\n  PdfArray,\n  PdfRef,\n  serialize,\n  PdfValue,\n  toUTF16BE,\n  StructTreeEntry,\n} from './common.js';\nimport { TocItem, textEncoder, randomData, tryDeflateStream } from './util.js';\nimport { ArrayReader, Writer } from '../io.js';\nimport { OcrPageWithMarkup } from '../ocr.js';\nimport PdfImage, { JPEGImage, PNGImage } from './image.js';\nimport { PdfParser } from './parser.js';\nimport pdiiifVersion from '../version.js';\nimport log from '../log.js';\nimport {\n  CanvasImage,\n  ImageFetchFailure,\n  StartCanvasInfo,\n  isImageFetchFailure,\n} from '../download.js';\nimport { Annotation, CanvasInfo, getI18nValue } from '../iiif.js';\nimport {\n  buildCentralFileDirectory,\n  buildLocalZipHeader,\n  CentralDirectoryFileSpec,\n} from './pkzip.js';\nimport { crc32 } from '../util.js';\nimport { exportPdfAnnotation } from './annos.js';\nimport { OptimizationParams } from '../optimization.js';\n\nconst PRODUCER = `pdiiif v${pdiiifVersion}`;\n\n/// If the font is 10 pts, nominal character width is 5 pts\nconst CHAR_WIDTH = 2;\n\n/// Taken from tesseract@2d6f38eebf9a14d9fbe65d785f0d7bd898ff46cb, tessdata/pdf.ttf\n/// Created by Ken Sharp\n/// (C) Copyright 2011, Google Inc.\n/// Licensed under the Apache License, Version 2.0 (the \"License\");\n/// you may not use this file except in compliance with the License.\n/// You may obtain a copy of the License at http://www.apache.org/licenses/LICENSE-2.0\n/// Unless required by applicable law or agreed to in writing, software\n/// distributed under the License is distributed on an \"AS IS\" BASIS,\n/// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n/// See the License for the specific language governing permissions and\n/// limitations under the License.\nconst FONTDATA = new Uint8Array([\n  0, 1, 0, 0, 0, 10, 0, 128, 0, 3, 0, 32, 79, 83, 47, 50, 86, 222, 200, 148, 0,\n  0, 1, 40, 0, 0, 0, 96, 99, 109, 97, 112, 0, 10, 0, 52, 0, 0, 1, 144, 0, 0, 0,\n  30, 103, 108, 121, 102, 21, 34, 65, 36, 0, 0, 1, 184, 0, 0, 0, 24, 104, 101,\n  97, 100, 11, 120, 241, 101, 0, 0, 0, 172, 0, 0, 0, 54, 104, 104, 101, 97, 12,\n  2, 4, 2, 0, 0, 0, 228, 0, 0, 0, 36, 104, 109, 116, 120, 4, 0, 0, 0, 0, 0, 1,\n  136, 0, 0, 0, 8, 108, 111, 99, 97, 0, 12, 0, 0, 0, 0, 1, 176, 0, 0, 0, 6, 109,\n  97, 120, 112, 0, 4, 0, 5, 0, 0, 1, 8, 0, 0, 0, 32, 110, 97, 109, 101, 242,\n  235, 22, 218, 0, 0, 1, 208, 0, 0, 0, 75, 112, 111, 115, 116, 0, 1, 0, 1, 0, 0,\n  2, 28, 0, 0, 0, 32, 0, 1, 0, 0, 0, 1, 0, 0, 176, 148, 113, 16, 95, 15, 60,\n  245, 4, 7, 8, 0, 0, 0, 0, 0, 207, 154, 252, 110, 0, 0, 0, 0, 212, 195, 167,\n  242, 0, 0, 0, 0, 4, 0, 8, 0, 0, 0, 0, 16, 0, 2, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0,\n  8, 0, 255, 255, 0, 0, 4, 0, 0, 0, 0, 0, 4, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0,\n  0, 0, 0, 0, 0, 0, 2, 0, 1, 0, 0, 0, 2, 0, 4, 0, 1, 0, 0, 0, 0, 0, 1, 0, 0, 0,\n  0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 0, 0, 1, 144, 0, 5, 0, 0, 0, 0,\n  0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 0, 1, 0, 1, 0,\n  0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 71, 79, 79, 71, 0,\n  64, 0, 0, 0, 0, 0, 1, 255, 255, 0, 0, 0, 1, 0, 1, 128, 0, 0, 0, 0, 0, 0, 0, 0,\n  0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 4, 0, 0, 0, 0, 0, 0, 2, 0, 1, 0, 0, 0,\n  0, 0, 20, 0, 3, 0, 0, 0, 0, 0, 20, 0, 6, 0, 10, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,\n  0, 0, 0, 12, 0, 0, 0, 1, 0, 0, 0, 0, 4, 0, 8, 0, 0, 3, 0, 0, 49, 33, 17, 33,\n  4, 0, 252, 0, 8, 0, 0, 0, 0, 3, 0, 42, 0, 0, 0, 3, 0, 0, 0, 5, 0, 22, 0, 0, 0,\n  1, 0, 0, 0, 0, 0, 5, 0, 11, 0, 22, 0, 3, 0, 1, 4, 9, 0, 5, 0, 22, 0, 0, 0, 86,\n  0, 101, 0, 114, 0, 115, 0, 105, 0, 111, 0, 110, 0, 32, 0, 49, 0, 46, 0, 48,\n  86, 101, 114, 115, 105, 111, 110, 32, 49, 46, 48, 0, 0, 1, 0, 0, 0, 0, 0, 0,\n  0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,\n]);\n\ntype ZipDummyObjectSpec = {\n  filename: string;\n  data: Uint8Array;\n  deflatedData?: Uint8Array;\n  bytesUntilActualData: number;\n};\n\nexport type GeneratorParams = {\n  // Writer to output the PDF to\n  writer: Writer;\n  // Metadata to include in the PDF\n  metadata: Metadata;\n  // Information about canvases included in the PDF\n  canvasInfos: CanvasInfo[];\n  // List of languages to use for rendering labels, in descending order of preference\n  langPref: readonly string[];\n  // Labels for pages, every position corresponds to the canvas in the same position\n  pageLabels?: string[];\n  // Outline tree for the PDF\n  outline: TocItem[];\n  // Whether the PDF should include a hidden text layer\n  hasText?: boolean;\n  // Reading direction of the PDF\n  readingDirection?: 'right-to-left' | 'left-to-right';\n  // Information about the canvas (or canvas region) that should be displayed initially\n  initialCanvas?: StartCanvasInfo;\n  // The manifest to build the PDF from\n  manifestJson?: Manifest | ManifestV2;\n  // If this is enabled, the PDF will also be a valid ZIP archive of all the resources\n  // included in the PDF\n  zipPolyglot?: boolean;\n  // Base directory name for the polyglot ZIP archive, if not set the resources will be\n  // top-level in the archive\n  zipBaseDir?: string;\n  // Optimize images to reduce size\n  optimization?: OptimizationParams;\n};\n\n/** Streaming PDF generator based on a IIIF manifest.\n *\n * This class is responsible for generating a PDF document based on a IIIF manifest.\n * It is designed to be used in a streaming fashion, i.e. it can start writing the PDF\n * before all the resources have been loaded and thus does not require a huge amount\n * of memory. On the flipside, this makes the code a lot more complex, since we need\n * to keep track of the PDF's internal state and write objects in the correct order.\n * Another complication is that we want to write out the catalog and page tree first\n * to allow viewers to quickly display the first page, which requires a bunch of\n * complicated pre-allocation of objects.\n *\n * FIXME: Can't we just write the pages first and then the catalog and page tree at\n *        the end of the file? Would make things *A LOT* easier and less complex and\n *        error-prone.\n */\nexport default class PDFGenerator {\n  // Keep track of how many bytes have been written so far\n  _offset = 0;\n  // PDF objects that are scheduled for writing, will be written on _flush()\n  _objects: Array<PdfObject> = [];\n  // Number of the next PDF object\n  _nextObjNo = 1;\n  // References to various central objects\n  _objRefs: Record<string, PdfRef> = {};\n  // Tracks offset of every XObject\n  _offsets: number[] = [];\n  // Writer used for outputting the PDF\n  _writer: Writer | undefined;\n  // Have we already started writing the IIIF pages?\n  _pagesStarted = false;\n  // Information about each canvas, needed for pre-allocating objects\n  _canvasInfos: Array<CanvasInfo> = [];\n  // Object number of the first page\n  _firstPageObjectNum: number | undefined;\n  // Labels for every page in the PDF\n  _pageLabels?: string[];\n  // Number of cover pages inserted at the beginning of the PDF\n  _numCoverPages = 0;\n  // PDF outline\n  _outline: TocItem[] = [];\n  // Is the PDF supposed to have a hidden text layer?\n  _hasText = false;\n  // List of top-level entries in the PDF's logical structure tree\n  _strucTree: StructTreeEntry[] = [];\n  // Maps a page's object number to the marked content sequence IDs its content\n  // stream has\n  _pageMCIds: Map<number, Array<number>> = new Map();\n  // Identifier of the next structure parent entry\n  _nextStructParentId = 0;\n  // For every page, its corresponding parent ID for the parent tree\n  _pageParentIds: Map<number, number> = new Map();\n  // Language preference\n  _langPref: readonly string[];\n  _initialCanvas?: StartCanvasInfo;\n  private _polyglot: boolean;\n  private _manifestJson?: Manifest | ManifestV2;\n  private _zipCatalog?: Array<CentralDirectoryFileSpec>;\n  private _zipBaseDir?: string;\n  private _readingDirection: 'right-to-left' | 'left-to-right';\n  // FIXME: Overlap with _objRefs, should be unified\n  private _deferredReferences = new Map<string, PdfRef>();\n\n  /** Just basic setup of state, real setup is done in setup()\n      method since we need to call a bunch of async stuff */\n  constructor({\n    writer,\n    metadata,\n    canvasInfos,\n    langPref,\n    pageLabels,\n    outline = [],\n    readingDirection = 'left-to-right',\n    hasText = false,\n    initialCanvas,\n    manifestJson,\n    zipPolyglot = false,\n    zipBaseDir,\n  }: GeneratorParams) {\n    this._writer = writer;\n    this._canvasInfos = canvasInfos;\n    this._pageLabels = pageLabels;\n    this._outline = outline;\n    this._hasText = hasText;\n    this._readingDirection = readingDirection;\n    this._langPref = langPref;\n    this._initialCanvas = initialCanvas;\n    this._polyglot = zipPolyglot;\n    this._zipBaseDir = zipBaseDir;\n    this._manifestJson = manifestJson;\n\n    const pdfMetadata: PdfDictionary = {\n      ...Object.entries(metadata)\n        .filter((k, v) => v !== undefined)\n        .reduce((prev, [k, v]) => {\n          prev[k] = `(${v})`;\n          return prev;\n        }, {} as PdfDictionary),\n      Producer: `(${PRODUCER})`,\n    };\n    this._addObject(pdfMetadata, 'Info');\n  }\n\n  /** Set up the basic PDF document, creating neccessary objects.  */\n  async setup(): Promise<void> {\n    // Add the catalog object, will be updated later\n    const catalog: PdfDictionary = {\n      Type: '/Catalog',\n    };\n    this._addObject(catalog, 'Catalog');\n\n    // Pages Dictionary, will be updated later\n    const pagesObj = this._addObject(\n      {\n        Type: '/Pages',\n        Count: this._canvasInfos.length,\n      },\n      'Pages'\n    );\n    catalog.Pages = makeRef(pagesObj);\n\n    // Indicate that our PDF contains structure information, attached to the text layer\n    if (this._hasText) {\n      catalog.MarkInfo = {\n        Type: '/MarkInfo',\n        Marked: true,\n      };\n    }\n\n    if (this._outline.length > 0) {\n      // If we have an outline, display the ToC by default in PDF viewers and set up\n      // the required objects\n      catalog.PageMode = '/UseOutlines';\n      const outlines: PdfDictionary = {\n        Type: '/Outlines',\n        Count: 0,\n      };\n      const outlinesObj = this._addObject(outlines);\n      catalog.Outlines = makeRef(outlinesObj);\n      let prev: PdfObject | undefined;\n      for (const [idx, itm] of this._outline.entries()) {\n        const [childObj, numKids] = this._addOutline(itm, outlinesObj, prev);\n        (outlines.Count as number) += 1 + numKids;\n        if (idx === 0) {\n          outlines.First = makeRef(childObj);\n        } else if (idx === this._outline.length - 1) {\n          outlines.Last = makeRef(childObj);\n        }\n        prev = childObj;\n      }\n    } else {\n      // Otherwise, display the thumbnails in PDF viewers\n      catalog.PageMode = '/UseThumbs';\n    }\n\n    // Adjust reading direction to RTL if neccessary\n    catalog.ViewerPreferences = {\n      Direction: this._readingDirection === 'right-to-left' ? '/R2L' : '/L2R',\n    };\n\n    if (this._hasText) {\n      await this._setupHiddenTextFont();\n    }\n  }\n\n  /** Set up neccessary fonts for the hidden text layer. */\n  async _setupHiddenTextFont(): Promise<void> {\n    const typeZeroFont = this._addObject(\n      {\n        Type: '/Font',\n        Subtype: '/Type0',\n        BaseFont: '/GlyphLessFont',\n        Encoding: '/Identity-H',\n      },\n      'Type0Font'\n    );\n\n    const typeTwoFont = this._addObject({\n      type: '/Font',\n      Subtype: '/CIDFontType2',\n      BaseFont: '/GlyphLessFont',\n      DW: 1000 / CHAR_WIDTH,\n      CIDSystemInfo: {\n        Ordering: '(Identity)',\n        Registry: '(Adobe)',\n        Supplement: 0,\n      },\n    });\n    (typeZeroFont.data as PdfDictionary).DescendantFonts = [\n      makeRef(typeTwoFont),\n    ];\n\n    // Set up character id to glyph id mapping\n    const cidtoGidMapData = new Uint8Array(128 * 1024);\n    for (let i = 0; i < cidtoGidMapData.length; i++) {\n      cidtoGidMapData[i] = i % 2 ? 1 : 0;\n    }\n    const comp = await tryDeflateStream(cidtoGidMapData);\n    const cidToGidMap = this._addObject(comp.dict, undefined, comp.stream);\n    (typeTwoFont.data as PdfDictionary).CIDToGIDMap = makeRef(cidToGidMap);\n\n    // Set up character code to unicode codepoint mapping\n    // Effectively an identity mapping, since in our font every character code\n    // exactly corresponds to the unicode codepoint\n    const cmapStream = dedent`\n      /CIDInit /ProcSet findresource begin\n        12 dict begin\n        begincmap\n            /CIDSystemInfo\n            <<\n              /Registry (Adobe)\n              /Ordering (UCS)\n              /Supplement 0\n            >> def\n            /CMapName /Identity-H def\n            /CMapType 2 def\n            1 begincodespacerange\n            <0000> <FFFF>\n            endcodespacerange\n            1 beginbfrange\n            <0000> <FFFF> <0000>\n            endbfrange\n        endcmap\n        CMapName currentdict /CMap defineresource pop\n        end\n    end`;\n    const cmap = this._addObject(\n      {\n        Length: cmapStream.length,\n      },\n      undefined,\n      cmapStream\n    );\n    (typeZeroFont.data as PdfDictionary).ToUnicode = makeRef(cmap);\n\n    // Set up the font descriptor for our hidden text font\n    const fontDesc = this._addObject({\n      Type: '/FontDescriptor',\n      FontName: '/GlyphLessFont',\n      FontBBox: [0, 0, 1000 / CHAR_WIDTH, 1000],\n      Ascent: 1000,\n      CapHeight: 1000,\n      Descent: -1,\n      Flags: 5,\n      ItalicAngle: 0,\n      StemV: 80,\n    });\n    (typeTwoFont.data as PdfDictionary).FontDescriptor = makeRef(fontDesc);\n\n    const maybeCompressedFont = await tryDeflateStream(FONTDATA);\n    const fontDataObj = this._addObject(\n      {\n        Length1: FONTDATA.length,\n        ...maybeCompressedFont.dict,\n      },\n      undefined,\n      maybeCompressedFont.stream\n    );\n    (fontDesc.data as PdfDictionary).FontFile2 = makeRef(fontDataObj);\n  }\n\n  /** Register embedded OCR files in the PDF's catalog object. */\n  _registerEmbeddedFilesInCatalog() {\n    const catalog = this._objects[this._objRefs.Catalog.refObj]\n      .data as PdfDictionary;\n    const embeddedFiles: PdfArray = [\n      `(manifest.json)`,\n      makeRef(this._firstPageObjectNum! - (this._polyglot ? 3 : 2)),\n    ];\n    for (const [idx, canvas] of this._canvasInfos.entries()) {\n      if (!canvas.ocr) {\n        continue;\n      }\n      const pageObjNum = this.getCanvasObjectNumber(idx);\n      // The file spec for embedded OCR file is the previous to last XObject for a given canvas\n      let fileObjNum = pageObjNum + this.getObjectsPerCanvas(idx) - 2;\n      if (this._polyglot) {\n        // Except if the PDF is polyglot, then it's the second to last XObject\n        fileObjNum -= 1;\n      }\n      embeddedFiles.push(`(${canvas.ocr.id})`);\n      embeddedFiles.push(makeRef(fileObjNum));\n    }\n    if (!catalog.Names) {\n      catalog.Names = {\n        EmbeddedFiles: { Names: embeddedFiles },\n      };\n    } else {\n      const names = catalog.Names as PdfDictionary;\n      const nameTree = names.EmbeddedFiles as PdfDictionary;\n      nameTree.Names = (nameTree.Names as PdfArray).concat(embeddedFiles);\n    }\n  }\n\n  /** Create a PdfRef whose value is deferred, i.e. will be set at a later stage.\n   *\n   * Useful for bidirectional references.\n   *\n   * Prevents serialization of objects containing this reference as long as the\n   * value is not set.\n   *\n   * @param key A unique key to identify the reference\n   */\n  _makeDeferredReference(key: string): PdfRef {\n    if (!this._deferredReferences.has(key)) {\n      // Placeholder reference\n      const ref = makeRef(-1);\n      this._deferredReferences.set(key, ref);\n    }\n    return this._deferredReferences.get(key)!;\n  }\n\n  /** Add items to the PDF's outline, based on the passed TocItem tree.\n   *\n   * @param itm The item we want to add to the outline\n   * @param parent The parent outline item\n   * @param prev The preceding sibling outline item, if present\n   * @returns A tuple containing the object reference of the added outline item and the number\n   *         of children outline items that were created\n   */\n  _addOutline(\n    itm: TocItem,\n    parent: PdfObject,\n    prev?: PdfObject\n  ): [PdfObject, number] {\n    let dest: PdfArray;\n    if (typeof itm.startCanvas === 'string') {\n      // Simple case, just linke to a whole canvas/page\n      const destCanvasIdx = this._canvasInfos.findIndex(\n        (ci) => ci.canvas.id === itm.startCanvas\n      );\n      if (destCanvasIdx < 0) {\n        throw Error(\n          `Could not find canvas with id ${itm.startCanvas} in manifest!`\n        );\n      }\n      dest = [destCanvasIdx, '/Fit'];\n    } else {\n      // More complex: link to a specific region on a canvas\n      const canvasId = itm.startCanvas.id;\n      const unitScale = 72 / itm.startCanvas.ppi;\n      const rect = itm.startCanvas.position;\n      const { width, height } = itm.startCanvas.dimensions;\n      const destCanvasIdx = this._canvasInfos.findIndex(\n        (ci) => ci.canvas.id === canvasId\n      );\n      if (destCanvasIdx < 0) {\n        throw Error(`Could not find canvas with id ${canvasId} in manifest!`);\n      }\n      dest = [\n        destCanvasIdx,\n        '/FitR',\n        // TODO: Thoroughly test that this is actually working!\n        unitScale * rect.x, // left\n        unitScale * rect.y, // bottom\n        unitScale * (width - (rect.x + rect.width)), // right,\n        unitScale * (height - (rect.y + rect.height)), // top,\n      ];\n    }\n\n    const rec: PdfDictionary = {\n      Title: `( ${itm.label} )`,\n      Parent: makeRef(parent),\n      // NOTE: The first entry is a number only during setup and will later be\n      //       replaced with a reference to the actual page object, once we know\n      //       how many objects are preceding the page objects.\n      Dest: dest,\n    };\n    const obj = this._addObject(rec);\n    if (prev) {\n      rec.Prev = makeRef(prev);\n      (prev.data as PdfDictionary).Next = makeRef(obj);\n    }\n\n    if (itm.children?.length) {\n      // Recursively add children\n      let prev: PdfObject | undefined;\n      rec.Count = 0;\n      for (const [idx, child] of itm.children.entries()) {\n        const [childObj, numChildren] = this._addOutline(child, obj, prev);\n        if (idx === 0) {\n          rec.First = makeRef(childObj);\n        } else if (idx === itm.children.length - 1) {\n          rec.Last = makeRef(childObj);\n        }\n        rec.Count = rec.Count + 1 + numChildren;\n        prev = childObj;\n      }\n    }\n    return [obj, (rec.Count as number) ?? 0];\n  }\n\n  /** Add a new object to the PDF document.\n   *\n   * @param val A PDF value, can be any of the supported types.\n   * @param refName An optional name to reference the object by.\n   * @param stream An optional stream to attach to the object, value must be adictionary in this case\n   * @returns The created object\n   */\n  _addObject(\n    val: PdfValue,\n    refName?: string,\n    stream?: Uint8Array | string\n  ): PdfObject {\n    const isObject = (x: unknown): x is object =>\n      typeof x === 'object' && x !== null;\n    if (stream) {\n      if (!isObject(val)) {\n        throw new Error(\n          'PDF Objects with a stream must have a dictionary as its value'\n        );\n      }\n      if (!(val as PdfDictionary).Length) {\n        (val as PdfDictionary).Length = stream.length;\n      }\n    }\n    const obj = {\n      num: this._nextObjNo,\n      data: val,\n      stream,\n    };\n    this._nextObjNo++;\n    this._objects[obj.num] = obj;\n    if (refName) {\n      this._objRefs[refName] = makeRef(obj);\n    }\n    return obj;\n  }\n\n  /** Clone an object from a foreign PDF into the current PDF, adjusting\n   *  the encountered indirect object references.\n   *\n   * @param parser PdfParser instance for the PDF the object is from\n   * @param obj The object to transplant into our document\n   * @param seenObjects A map of object numbers to known references, used to avoid\n   *                    infinite recursion\n   * @returns A reference to the transplanted object\n   */\n  private async _transplantObject(\n    parser: PdfParser,\n    obj: PdfObject,\n    seenObjects: Record<number, PdfRef> = {}\n  ): Promise<PdfRef> {\n    const handleValue = async (value: PdfValue): Promise<PdfValue> => {\n      if (value instanceof PdfRef) {\n        const o = await parser.resolveRef(value);\n        if (o === undefined) {\n          throw `Could not resolve reference to object '${value.refObj}'`;\n        }\n        // Check if we've already transplanted the object\n        if (seenObjects[o.num]) {\n          return seenObjects[o.num];\n        }\n        const objDict = o.data as PdfDictionary;\n        const newObj = this._addObject(objDict, undefined, o.stream);\n        const ref = new PdfRef(newObj.num);\n        seenObjects[o.num] = ref;\n        newObj.data = await handleValue(objDict);\n        if (objDict.Type === '/Page') {\n          // Redirect to our own Pages object\n          (newObj.data as PdfDictionary).Parent = this._objRefs.Pages;\n        }\n        return ref;\n      } else if (typeof value === 'string' && value[0] != '/') {\n        return `(${value})`;\n      } else if (Array.isArray(value)) {\n        const out = [];\n        for (const val of value) {\n          out.push(await handleValue(val));\n        }\n        return out;\n      } else if (typeof value === 'object' && value !== null) {\n        const out: PdfDictionary = {};\n        for (const [key, val] of Object.entries(value)) {\n          // Ignore structure keys for now\n          if (key === 'StructParent' || key === 'StructParents') {\n            continue;\n          }\n          out[key] = await handleValue(val as PdfDictionary);\n        }\n        return out;\n      }\n      return value;\n    };\n    const ref = new PdfRef(obj.num);\n    // TODO: Special case: if the object is a page, we need to check for\n    //       a /StructParents key, check for the /StructTreeRoot key in\n    //       the catalog, and then transplant that to our _strucTree\n    //       and _pageMCIDs structures. Quite the handful!!\n    return (await handleValue(ref)) as PdfRef;\n  }\n\n  /** Insert cover pages from another PDF into our document. */\n  async insertCoverPages(pdfData: ArrayBuffer): Promise<void> {\n    if (this._pagesStarted) {\n      throw 'Cover pages must be inserted before writing the first regular page';\n    }\n    const reader = new ArrayReader(new Uint8Array(pdfData));\n    const parser = await PdfParser.parse(reader);\n    const pagesDict = this._objects[this._objRefs.Pages.refObj]\n      .data as PdfDictionary;\n    pagesDict.Kids = [];\n    // TODO: Parse and transplant the section and parent trees from\n    //       the catalog into our own structures.\n    for await (const page of parser.pages()) {\n      const dict = page.data as PdfDictionary;\n      // Ignore associated structured content for now\n      delete dict.StructParents;\n      delete dict.Parent;\n      const newPageRef = await this._transplantObject(parser, page);\n      (pagesDict.Kids as PdfArray).push(newPageRef);\n      (pagesDict.Count as number) += 1;\n      this._numCoverPages += 1;\n    }\n    return;\n  }\n\n  /** Embed a file resource in the PDF.\n   *\n   * @param filename The filename for the embedded resource\n   * @param description A description of the file\n   * @param mimeType The MIME type of the file\n   * @param data The data to embed\n   */\n  private async _embedResource(\n    filename: string,\n    description: string,\n    mimeType: string,\n    data: string\n  ): Promise<void> {\n    // TODO: Add check that the file is actually pre-registered in\n    //       the catalog!\n    const fileSpec: PdfDictionary = {\n      Type: '/Filespec',\n      F: `(${filename})`,\n      UF: toUTF16BE(filename),\n      Desc: `(${description})`,\n      EF: {\n        F: makeRef(this._nextObjNo + (this._polyglot ? 2 : 1)),\n      },\n    };\n\n    const maybeCompressed = await tryDeflateStream(data);\n    const embeddedFile = {\n      Type: '/EmbeddedFile',\n      Subtype: `(${mimeType})`,\n      ...maybeCompressed.dict,\n    };\n\n    this._addObject(fileSpec);\n    if (this._polyglot) {\n      let zipData: Uint8Array;\n      if (typeof data === 'string') {\n        zipData = textEncoder.encode(data);\n      } else {\n        zipData = data;\n      }\n      const extraDataLength = this._getSerializedSize(\n        {\n          num: this._nextObjNo + 2,\n          data: { ...embeddedFile, ...maybeCompressed.dict },\n          stream: maybeCompressed.stream,\n        },\n        true\n      );\n      this._insertZipHeaderDummyObject({\n        filename,\n        data: zipData,\n        deflatedData: maybeCompressed.dict.Filter\n          ? (maybeCompressed.stream as Uint8Array)\n          : undefined,\n        // 2 bytes zlib header of deflated data\n        bytesUntilActualData: extraDataLength + 2,\n      });\n    }\n    this._addObject(embeddedFile, undefined, maybeCompressed.stream);\n  }\n\n  /** Embed the IIIF Manifest JSON in the PDF.\n   *\n   * @param manifestJson The IIIF (v2 or v3) Manifest to embed\n   */\n  private async _embedManifest(\n    manifestJson: ManifestV2 | Manifest\n  ): Promise<void> {\n    let manifestMime = 'application/ld+json';\n    if (Array.isArray(manifestJson['@context'])) {\n      const manifestProfile = manifestJson['@context'].find((p) =>\n        p.startsWith('http://iiif.io/api/presentation')\n      );\n      if (manifestProfile) {\n        manifestMime += `;profile=\"${manifestProfile}\"`;\n      }\n    } else if (manifestJson['@context']) {\n      manifestMime += `;profile=\"${manifestJson['@context']}\"`;\n    }\n    await this._embedResource(\n      'manifest.json',\n      'IIIF Manifest this PDF is based on',\n      manifestMime,\n      JSON.stringify(manifestJson)\n    );\n  }\n\n  /** Once all setup is complete and we begin rendering pages into the document,\n   *  we need to finalize the PDF header with the remaining information.\n   */\n  async finalizePdfHeader(): Promise<void> {\n    const catalog = this._objects[this._objRefs.Catalog.refObj]\n      .data as PdfDictionary;\n\n    // Create page tree with page labels\n    if (this._pageLabels) {\n      catalog.PageLabels = makeRef(\n        this._addObject({\n          Nums: this._pageLabels\n            .map((label, idx) =>\n              label\n                ? [idx + this._numCoverPages, { P: `( ${label} )` }]\n                : undefined\n            )\n            .filter((x) => x !== undefined)\n            .flat() as PdfArray,\n        })\n      );\n    }\n\n    const pagesObj = this._objects[this._objRefs.Pages.refObj];\n\n    // Now that we know from which object number the pages start, we can set the\n    // /Kids entry in the Pages object and update the outline destinations.\n    const pageDict = pagesObj.data as PdfDictionary;\n    if (!pageDict.Kids) {\n      pageDict.Kids = [];\n    }\n    this._firstPageObjectNum = this._nextObjNo;\n    if (this._manifestJson) {\n      this._firstPageObjectNum += 2;\n      if (this._polyglot) {\n        this._firstPageObjectNum++;\n      }\n    }\n    for (const [idx] of this._canvasInfos.entries()) {\n      (pageDict.Kids as PdfArray).push(\n        makeRef(this.getCanvasObjectNumber(idx))\n      );\n    }\n    this._objects\n      // Get ToC entry object, the first destination will be the canvas index\n      .filter((obj) => (obj.data as PdfDictionary)?.Dest !== undefined)\n      .forEach((obj: PdfObject) => {\n        const dest = (obj.data as PdfDictionary).Dest as PdfArray;\n        if (typeof dest[0] !== 'number') {\n          return;\n        }\n        dest[0] = makeRef(this.getCanvasObjectNumber(dest[0]));\n      });\n\n    // Register the structural content tree root\n    if (this._hasText) {\n      catalog.StructTreeRoot = makeRef(\n        this._nextObjNo + this.totalCanvasObjects\n      );\n    }\n\n    // Register the optional content groups, if present\n    if (this._canvasInfos.some((ci) => ci.images.some((i) => i.choiceInfo))) {\n      // We're *very* explicit with the visibility of the various OCGs to\n      // ensure as broad a viewer support as possible (especially pdf.js\n      // needed it...)\n      const initiallyEnabledOCGs: PdfRef[] = [];\n      const initiallyDisabledOCGs: PdfRef[] = [];\n      const allOCGs: PdfRef[] = [];\n      const rbGroups: PdfRef[][] = [];\n      for (const [canvasIdx, { images }] of this._canvasInfos.entries()) {\n        const pageObjNum = this.getCanvasObjectNumber(canvasIdx);\n        let ocgStart = pageObjNum + 2 + images.length;\n        if (this._polyglot) {\n          // Take 'dummy' objects for ZIP polyglot into account\n          ocgStart += images.length;\n        }\n        let ocgIdx = 0;\n        const rbGroup = [];\n        for (const img of images) {\n          if (!img.choiceInfo) {\n            continue;\n          }\n          const ref = makeRef(ocgStart + ocgIdx);\n          if (img.choiceInfo.enabled) {\n            initiallyEnabledOCGs.push(ref);\n          } else {\n            initiallyDisabledOCGs.push(ref);\n          }\n          allOCGs.push(ref);\n          rbGroup.push(ref);\n          ocgIdx++;\n        }\n        rbGroups.push(rbGroup);\n      }\n      catalog.OCProperties = {\n        OCGs: allOCGs,\n        D: {\n          BaseState: '/OFF',\n          ON: initiallyEnabledOCGs,\n          OFF: initiallyDisabledOCGs,\n          RBGroups: rbGroups,\n        },\n      };\n    }\n\n    // Set the initial view of the PDF\n    if (typeof this._initialCanvas === 'string') {\n      // ...to a whole page\n      catalog.OpenAction = [\n        makeRef(\n          this.getCanvasObjectNumber(\n            this._canvasInfos.findIndex(\n              (ci) => ci.canvas.id === this._initialCanvas\n            )\n          )\n        ),\n      ];\n    } else if (this._initialCanvas) {\n      // ...to a specific region on a page\n      const unitScale = 72 / this._initialCanvas.ppi;\n      const rect = this._initialCanvas.position;\n      const { width, height } = this._initialCanvas.dimensions;\n      catalog.OpenAction = [\n        makeRef(\n          this.getCanvasObjectNumber(\n            this._canvasInfos.findIndex(\n              (ci) => ci.canvas.id === this._initialCanvas\n            )\n          )\n        ),\n        '/FitR',\n        // TODO: Thoroughly test that this is actually working!\n        unitScale * rect.x, // left\n        unitScale * rect.y, // bottom\n        unitScale * (width - (rect.x + rect.width)), // right,\n        unitScale * (height - (rect.y + rect.height)), // top,\n      ];\n    }\n\n    this._registerEmbeddedFilesInCatalog();\n\n    await this._flush();\n\n    if (this._manifestJson) {\n      await this._embedManifest(this._manifestJson);\n      await this._flush();\n    }\n  }\n\n  /** Render a new page, based on a IIIF canvas, its associated annotations and OCR text.\n   *\n   * @param canvasId The ID of the canvas to render\n   * @param width The width of the canvas in pixels\n   * @param height The height of the canvas in pixels\n   * @param images The images to render on the canvas\n   * @param annotations The annotations to render on the canvas\n   * @param ocrText The OCR text to render on the canvas\n   * @param ppi The resolution of the canvas in pixels per inch, used to determine the physical\n   *            size of the PDF page. Assumes 300ppi by default.\n   */\n  async renderPage(\n    canvasId: string,\n    {\n      width: canvasWidth,\n      height: canvasHeight,\n    }: { width: number; height: number },\n    images: (CanvasImage | ImageFetchFailure)[],\n    annotations: Annotation[],\n    ocrText?: OcrPageWithMarkup,\n    ppi = 300\n  ): Promise<void> {\n    if (!this._pagesStarted) {\n      log.debug('Initial page, finalizing PDF header structures.');\n      await this.finalizePdfHeader();\n      this._pagesStarted = true;\n    }\n\n    // Factor to multiply pixels by to get equivalent PDF units (72 pdf units === 1 inch)\n    const unitScale = 72 / ppi;\n    const pageDict: PdfDictionary = {\n      Type: '/Page',\n      Parent: this._objRefs.Pages,\n      MediaBox: [0, 0, unitScale * canvasWidth, unitScale * canvasHeight],\n      Resources: {\n        ProcSet: ['/PDF', '/Text', '/ImageB', '/ImageI', '/ImageC'],\n      },\n    };\n\n    if (this._hasText) {\n      pageDict.StructParents = this._nextStructParentId;\n      this._pageParentIds.set(this._nextObjNo, this._nextStructParentId);\n      this._nextStructParentId++;\n    }\n\n    if (ocrText && this._objRefs.Type0Font) {\n      (pageDict.Resources as PdfDictionary).Font = {\n        'f-0-0': this._objRefs.Type0Font,\n      };\n    }\n    const page = this._addObject(pageDict);\n\n    // Draw images onto the page\n    const contentOps: string[] = [];\n    const optionalGroupIds: { [imgId: string]: string } = {};\n    for (const [idx, image] of images.entries()) {\n      if (isImageFetchFailure(image)) {\n        continue;\n      }\n      const { x, y, width, height, choiceInfo } = image;\n      const drawWidth = unitScale * width;\n      const drawHeight = unitScale * height;\n      const drawX = unitScale * x;\n      const drawY = unitScale * (canvasHeight - height - y);\n      const imageId = `/Im${idx + 1}`;\n\n      if (choiceInfo?.optional) {\n        const ocId = `/oc${Object.keys(optionalGroupIds).length + 1}`;\n        optionalGroupIds[imageId] = ocId;\n        contentOps.push(`/OC ${ocId} BDC`);\n      }\n      contentOps.push(`q ${drawWidth} 0 0 ${drawHeight} ${drawX} ${drawY} cm`);\n      contentOps.push(`${imageId} Do`);\n      contentOps.push('Q');\n      if (choiceInfo?.optional) {\n        contentOps.push('EMC');\n      }\n    }\n\n    if (ocrText) {\n      contentOps.push(this._renderOcrText(ocrText, unitScale));\n    }\n\n    log.debug('Trying to compress content stream.');\n    const contentStreamComp = await tryDeflateStream(contentOps.join('\\n'));\n    const contentsObj = this._addObject(\n      contentStreamComp.dict,\n      undefined,\n      contentStreamComp.stream\n    );\n    (page.data as PdfDictionary).Contents = makeRef(contentsObj);\n\n    // Register all resources for the page\n    const pageResources = (page.data as PdfDictionary)\n      .Resources as PdfDictionary;\n    const xObjects: PdfDictionary = {};\n    const properties: PdfDictionary = {};\n    for (const [idx, img] of images.entries()) {\n      if (isImageFetchFailure(img)) {\n        continue;\n      }\n      const imageId = `/Im${idx + 1}`;\n      xObjects[imageId.substring(1)] = this._makeDeferredReference(imageId);\n      if (img.choiceInfo?.optional) {\n        const ocgId = optionalGroupIds[imageId];\n        properties[ocgId.substring(1)] = this._makeDeferredReference(ocgId);\n      }\n    }\n    pageResources.XObject = xObjects;\n    if (Object.keys(properties).length > 0) {\n      pageResources.Properties = properties;\n    }\n\n    log.debug('Creating image objects.');\n    const canvasIdx = this._canvasInfos.findIndex(\n      (ci) => ci.canvas.id === canvasId\n    );\n    for (const [imgIdx, img] of images.entries()) {\n      if (isImageFetchFailure(img)) {\n        // Dummy image data object\n        this._addObject({});\n        if (this._polyglot) {\n          // Dummy dummy zip header object\n          this._addObject({});\n        }\n        continue;\n      }\n      const imageData = new Uint8Array(img.data!);\n      const image = PdfImage.open(imageData);\n\n      const imageObjs = image.toObjects(\n        // Account for local zip header object if polyglot Zip-PDF is enabled\n        this._polyglot ? this._nextObjNo + 1 : this._nextObjNo\n      );\n\n      if (img.format !== 'jpeg' && image instanceof JPEGImage) {\n        // We calculated with 3 objects for this image, since it was either identified\n        // as PNG or we did not have a format in the manifest. So we need to add empty\n        // dummy objects to keep the object numbers in sync.\n        let objNum = imageObjs.slice(-1)[0].num;\n        for (let i = 0; imageObjs.length < 3; i++) {\n          imageObjs.push({ num: objNum++ });\n        }\n      }\n\n      // Resolve deferred references to this image\n      const mainImageObj = imageObjs[0];\n      const imageId = `/Im${imgIdx + 1}`;\n      this._deferredReferences.get(imageId)!.refObj = mainImageObj.num;\n\n      if (this._polyglot) {\n        if (image instanceof JPEGImage) {\n          const imgPreambleSize = this._getSerializedSize(mainImageObj, true);\n          const filename = `img/canvas-${canvasIdx}-${imgIdx}.jpg`;\n          this._insertZipHeaderDummyObject({\n            filename,\n            data: imageData,\n            bytesUntilActualData: imgPreambleSize,\n          });\n        } else {\n          // Polyglot PDF is not possible for PNG images, since PNGs are not stored\n          // as-is in the PDF, but can be split and stored across multiple objects\n          // To keep our pre-calculated object numbers valid, we need to insert an\n          // empty dummy object in place of the local zip header\n          this._addObject({});\n        }\n      }\n      imageObjs.forEach((obj) => this._objects.push(obj));\n      this._nextObjNo = imageObjs.slice(-1)[0].num + 1;\n    }\n\n    if (images.some((i) => i?.choiceInfo?.optional)) {\n      log.debug('Creating optional content groups for page');\n      for (const [idx, img] of images.entries()) {\n        const imageId = `/Im${idx + 1}`;\n        if (!img?.choiceInfo) {\n          continue;\n        }\n        if (isImageFetchFailure(img)) {\n          // Dummy object to maintain precalculated object numbers\n          this._addObject({});\n          continue;\n        }\n        this._deferredReferences.get(optionalGroupIds[imageId])!.refObj =\n          this._nextObjNo;\n        this._addObject({\n          Type: '/OCG',\n          Name: img.choiceInfo.label\n            ? `(${getI18nValue(img.choiceInfo.label, this._langPref, '/')})`\n            : undefined,\n          Intent: '/View',\n          Usage: img.choiceInfo.visibleByDefault ? '/ON' : '/OFF',\n        } as PdfDictionary);\n      }\n    }\n\n    const canvasInfo = this._canvasInfos[canvasIdx];\n\n    // Embed OCR text, if present\n    if (ocrText?.markup) {\n      const canvasIdx = this._canvasInfos.findIndex(\n        (ci) => ci.canvas.id === canvasId\n      );\n      let filename = `ocr/canvas-${canvasIdx}`;\n      if (ocrText.mimeType.indexOf('html') >= 0) {\n        filename += '.html';\n      } else {\n        filename += '.xml';\n      }\n\n      await this._embedResource(\n        filename,\n        `OCR for canvas #${canvasIdx}`,\n        ocrText.mimeType,\n        ocrText.markup\n      );\n    } else if (canvasInfo.ocr) {\n      // Canvas Info says we have OCR, but none was passed, possible\n      // when the OCR doesn't have CORS or fetching failed for another reason\n      // Add two empty objects so object references are still valid\n      this._addObject({});\n      this._addObject({});\n      // Add one more if we have a polyglot PDF/ZIP\n      if (this._polyglot) {\n        this._addObject({});\n      }\n    }\n\n    // Add annotations, if present\n    if (annotations && annotations.length > 0) {\n      log.debug('Creating annotations for page');\n      pageDict.Annots = annotations\n        .flatMap((anno) => exportPdfAnnotation(anno, unitScale, canvasHeight))\n        .map((pdfAnno) => makeRef(this._addObject(pdfAnno)));\n    }\n\n    // Write out all of the objects\n    log.debug('Flushing data for page');\n    await this._flush();\n    log.debug('Finished rendering page');\n  }\n\n  /** Get PDF instructions to render a hidden text layer with the page's OCR.\n   *\n   * This owes *a lot* to Tesseract's PDF renderer[1] and the IA's `pdf-tools`[2]\n   * that ported it to Python. Accordingly, the license of this method is Apache 2.0.\n   *\n   * [1] https://github.com/tesseract-ocr/tesseract/blob/5.0.0-beta-20210916/src/api/pdfrenderer.cpp\n   * [2] https://github.com/internetarchive/archive-pdf-tools/blob/master/internetarchivepdf/pdfrenderer.py\n   *\n   *                            Apache License\n   *                     Version 2.0, January 2004\n   *                  http://www.apache.org/licenses/\n   */\n  _renderOcrText(ocr: OcrPageWithMarkup, unitScale: number): string {\n    // TODO: Handle changes in writing direction!\n    // TODO: Handle baselines, at least the simple ``cx+d` skewed-line-type, proper polyline support\n    //       requires a per-character transformation matrix, which is a bit much for the current\n    //       MVP-ish state\n    const pageHeight = ocr.height;\n    const ops: Array<string> = [];\n    ops.push('BT'); // Begin text rendering\n    ops.push('3 Tr'); // Use \"invisible ink\" (no fill, no stroke)\n    const pageObjNum = this._nextObjNo - 1;\n    let lineIdx = 0;\n    const entries: StructTreeEntry[] = [];\n    const handleChild = (\n      child: OcrPage | OcrBlock | OcrParagraph | OcrLine,\n      parent?: StructTreeEntry\n    ) => {\n      if (child.type === 'block') {\n        entries.push({\n          type: 'Sect',\n          children: [],\n          pageObjNum,\n          mcs: [],\n        });\n      } else if (child.type === 'paragraph') {\n        entries.push({\n          type: 'P',\n          children: [],\n          pageObjNum,\n          mcs: [],\n        });\n        if (parent) {\n          parent.children.push(entries.slice(-1)[0]);\n        }\n      } else if (child.type === 'line') {\n        ops.push(\n          ...this.renderOcrLine(\n            child,\n            lineIdx,\n            unitScale,\n            pageHeight,\n            pageObjNum\n          )\n        );\n        if (parent) {\n          parent.children.push({\n            type: 'Span',\n            children: [],\n            pageObjNum,\n            mcs: [lineIdx],\n          });\n        }\n        lineIdx++;\n        return;\n      }\n      for (const grandchild of child.children) {\n        handleChild(grandchild, entries.slice(-1)[0]);\n      }\n    };\n    handleChild(ocr);\n    this._strucTree.push(...entries);\n    ops.push('ET');\n    return ops.join('\\n');\n  }\n\n  /** Get PDF instructions to render a single line of OCR text. */\n  renderOcrLine(\n    line: OcrLine,\n    lineIdx: number,\n    unitScale: number,\n    pageHeight: number,\n    pageObjNum: number\n  ): string[] {\n    const fontRef = '/f-0-0';\n    const scaleX = 1;\n    const scaleY = 1;\n    const shearX = 0;\n    const shearY = 0;\n    const ops: Array<string> = [];\n    // Begin of marked content sequence that wraps the line in a Span\n    ops.push(`/Span << /MCID ${lineIdx} >> BDC`);\n    // Approximated font size for western scripts, PDF font size is specified in multiples of\n    // 'user units', which default to 1/72inch. The `userScale` gives us the units per pixel.\n    const fontSize = line.height * unitScale * 0.75;\n    //const fontSize = 8; // TODO: This is what Tesseract uses, why does this work?\n    ops.push(`${fontRef} ${fontSize} Tf`);\n    // We use a text matrix for every line. Tesseract uses a per-paragraph matrix, but we don't\n    // neccesarily have block/paragraph information available, so we'll use the next-closest\n    // thing. This means that every word on the line is positioned relative to the line, not\n    // relative to the page as in the markup.\n    const xPos = line.x * unitScale;\n    const lineY = pageHeight - line.y - line.height * 0.75;\n    const yPos = lineY * unitScale;\n    ops.push(`${scaleX} ${shearX} ${shearY} ${scaleY} ${xPos} ${yPos} Tm`);\n    let xOld = 0;\n    let yOld = 0;\n    // TODO: What to do if non-word line content?\n    for (const word of line.words) {\n      if (!word.text) {\n        continue;\n      }\n      if (!word.width) {\n        continue;\n      }\n      // Position drawing with relative moveto\n      const wordX = (word.x - line.x) * unitScale;\n      // Convert beween different y-origins in OCR and PDF\n      const wordYAbsolute = pageHeight - word.y - word.height * 0.75;\n      const wordY = (wordYAbsolute - lineY) * unitScale;\n      const wordWidth = word.width * unitScale;\n      const wordHeight = word.height * unitScale;\n      const dx = wordX - xOld;\n      const dy = wordY - yOld;\n      ops.push(`${dx * scaleX + dy * shearX} ${dx * shearY + dy * scaleY} Td`);\n      xOld = wordX;\n      yOld = wordY;\n      // Calculate horizontal stretch\n      // TODO: This is ripped straight from Tesseract, I have no clue what it does\n      // FIXME: The end of the line seems to be too far to the left sometimes,\n      // while the start seems to match\n      const wordLength = Math.pow(\n        Math.pow(wordWidth, 2) + Math.pow(wordHeight, 2),\n        0.5\n      );\n      const pdfWordLen = word.text.length;\n      ops.push(\n        `${CHAR_WIDTH * ((100 * wordLength) / (fontSize * pdfWordLen))} Tz`\n      );\n      // TODO: Account for trailing space in width calculation to prevent readers\n      //       from inserting a line break\n      const textBytes = serialize(toUTF16BE(word.text + ' ', false));\n      ops.push(`[ ${textBytes} ] TJ`);\n    }\n    ops.push('EMC');\n    // Add a newline to visually group together all statements belonging to a line\n    ops.push('');\n    if (!this._pageMCIds.has(pageObjNum)) {\n      this._pageMCIds.set(pageObjNum, []);\n    }\n    this._pageMCIds.get(pageObjNum)!.push(lineIdx);\n    return ops;\n  }\n\n  /** How many bytes have we written to the output so far? */\n  get bytesWritten(): number {\n    return this._offset;\n  }\n\n  /** Number of objects needed to render all canvases */\n  get totalCanvasObjects(): number {\n    // Every canvas needs 1 object per image, 1 for the content stream and 1 for the page definition.\n    return this._canvasInfos.reduce(\n      (sum, _, idx) => sum + this.getCanvasObjectNumber(idx),\n      0\n    );\n  }\n\n  /** How many objects are needed to render the canvas at the given index? */\n  getObjectsPerCanvas(canvasIdx: number): number {\n    const { images, ocr, numAnnotations } = this._canvasInfos[canvasIdx];\n    let numObjects =\n      // 1 XObject for JPEGs, 3 for PNGs or unknown formats\n      // The minority of PNGs actually need three XObjects, but we can't know\n      // that in advance and so we simply add empty dummy objects if we need less.\n      images\n        .map((img) => (img.format === 'jpeg' ? 1 : 3))\n        .reduce((a, b) => a + b, 0) +\n      // Page dictionary and content\n      2 +\n      // 1 Optional Content Group per optional image\n      images.filter((i) => i.choiceInfo !== undefined).length +\n      // 1 XObject per annotation\n      numAnnotations;\n    if (this._polyglot) {\n      // For a polyglot PDF, we need to precede every XObject that we'd like\n      // to expose as a file in the ZIP with a separate XObject that contains\n      // the local ZIP header for that file. Currently this concerns the\n      // images and the OCR data\n      // PNG images can't be embedded in the polyglot ZIP, so we simply add an\n      // empty object for each PNG image in place of the zip header object.\n      numObjects = numObjects + images.length + (ocr ? 1 : 0);\n    }\n    if (ocr) {\n      numObjects += 2;\n    }\n    return numObjects;\n  }\n\n  /** Get the object number for the canvas at the given index. */\n  getCanvasObjectNumber(canvasIdx: number): number {\n    let num = this._firstPageObjectNum!;\n    for (const [idx] of this._canvasInfos.entries()) {\n      if (idx === canvasIdx) {\n        return num;\n      }\n      num += this.getObjectsPerCanvas(idx);\n    }\n    throw new Error(`Canvas #${canvasIdx} not found.`);\n  }\n\n  /** Flush remaining data to output. */\n  async _flush(): Promise<void> {\n    if (this._offsets.length === 0) {\n      log.debug('Writing PDF header');\n      await this._write(`%PDF-1.5\\n%\\xde\\xad\\xbe\\xef\\n`);\n    }\n    for (const obj of this._objects) {\n      if (!obj) {\n        continue;\n      }\n      log.debug(`Serializing object #${obj.num}`);\n      await this._serializeObject(obj);\n    }\n    this._objects = [];\n  }\n\n  /** Get the serialized size in bytes of a PDF object. */\n  _getSerializedSize(\n    { num, data, stream }: PdfObject,\n    untilStreamStart = false\n  ): number {\n    let size = 0;\n    size += `${num} 0 obj\\n`.length;\n\n    if (data) {\n      size += serialize(data).length;\n    }\n    if (stream) {\n      size += '\\nstream\\n'.length;\n      if (untilStreamStart) {\n        return size;\n      }\n      if (typeof stream === 'string') {\n        size += textEncoder.encode(stream).byteLength;\n      } else {\n        size += stream.byteLength;\n      }\n      size += '\\nendstream'.length;\n    }\n    size += '\\nendobj\\n'.length;\n    return size;\n  }\n\n  /** Serialize a PDF object to the output. */\n  async _serializeObject(obj: PdfObject): Promise<void> {\n    this._offsets.push(this._offset);\n    const { num, data, stream } = obj;\n    await this._write(`${num} 0 obj\\n`);\n    if (data) {\n      await this._write(serialize(data));\n    }\n    if (stream) {\n      await this._write('\\nstream\\n');\n      await this._write(stream);\n      await this._write('\\nendstream');\n    }\n    await this._write('\\nendobj\\n');\n  }\n\n  /** Write data to the output. */\n  async _write(data: Uint8Array | string): Promise<void> {\n    if (this._writer === undefined) {\n      throw new Error(\n        'Cannot perform mutating operations on an already closed PDFGenerator.'\n      );\n    }\n    if (typeof data === 'string') {\n      data = textEncoder.encode(data);\n    }\n    this._offset += data.byteLength;\n    await this._writer.write(data);\n  }\n\n  /** Write the PDF objects required for the structure tree */\n  async _writeStructureTree(): Promise<void> {\n    const parentRoot: PdfDictionary = {\n      Nums: [],\n    };\n    const parentRootRef = makeRef(this._addObject(parentRoot));\n    const root: PdfDictionary = {\n      Type: '/StructTreeRoot',\n      K: [],\n      ParentTree: parentRootRef,\n      ParentTreeNextKey: this._nextStructParentId,\n    };\n    const pageParents: Map<number, Array<PdfRef>> = new Map();\n    const rootRef = makeRef(this._addObject(root));\n    const visitEntry = async (\n      entry: StructTreeEntry,\n      parent: PdfDictionary,\n      parentRef: PdfRef\n    ): Promise<void> => {\n      const obj: PdfDictionary = {\n        Type: '/StructElem',\n        S: `/${entry.type}`,\n        P: parentRef,\n        Pg: makeRef(entry.pageObjNum),\n        K: [],\n      };\n      if (!pageParents.has(entry.pageObjNum)) {\n        pageParents.set(entry.pageObjNum, []);\n      }\n      const objRef = makeRef(this._addObject(obj));\n      (parent.K as PdfRef[]).push(objRef);\n      if (entry.children.length > 0) {\n        for (const i of entry.children) {\n          await visitEntry(i, obj, objRef);\n        }\n      } else if (entry.mcs.length == 1) {\n        obj.K = entry.mcs[0];\n      } else if (entry.mcs.length > 0) {\n        obj.K = entry.mcs;\n      }\n      if (entry.mcs.length > 0) {\n        const parents = pageParents.get(entry.pageObjNum)!;\n        for (const mcId of entry.mcs) {\n          parents[mcId] = objRef;\n        }\n      }\n      if (this._objects.length > 1000) {\n        await this._flush();\n      }\n    };\n    for (const i of this._strucTree) {\n      await visitEntry(i, root, rootRef);\n    }\n    for (const [pageObjNum, parents] of pageParents) {\n      const pidx = this._pageParentIds.get(pageObjNum)!;\n      (parentRoot.Nums as PdfArray).push(\n        pidx,\n        makeRef(this._addObject(parents))\n      );\n    }\n    await this._flush();\n  }\n\n  /** Finish writing the PDF and close the writer.\n   *\n   * Writes XRef table, trailer and EOF marker to the output.\n   * Also adds ZIP central directory if polyglot PDF is enabled.\n   */\n  async end(): Promise<void> {\n    if (!this._writer) {\n      return;\n    }\n    /* FIXME: Disabled due to poor performance on large volumes and a strange\n     *        interaction with streamsaver, where the PDF would be prematurely\n     *        closed in the middle of writing out the structure tree.\n    log.debug(\"Writing structure tree\");\n    if (this._strucTree.length > 0) {\n      await this._writeStructureTree();\n    }\n    */\n    log.debug('Writing xref table');\n    type XrefEntry = [number, number, 'f' | 'n'];\n    const xrefEntries: Array<XrefEntry> = [\n      [0, 65535, 'f'],\n      ...this._offsets.map((offset): XrefEntry => [offset, 0, 'n']),\n    ];\n    const xRefTable = xrefEntries\n      .map(([off, gen, free]) =>\n        [\n          off.toString(10).padStart(10, '0'),\n          gen.toString(10).padStart(5, '0'),\n          free,\n          '',\n        ].join(' ')\n      )\n      .join('\\n');\n    const xrefOffset = this._offset;\n    await this._write(`xref\\n0 ${xrefEntries.length}\\n${xRefTable}\\n`);\n    const trailerDict: PdfDictionary = {\n      Size: xrefEntries.length,\n      Root: this._objRefs.Catalog,\n      Info: this._objRefs.Info,\n      ID: [randomData(32), randomData(32)],\n    };\n    await this._write(`\\ntrailer\\n${serialize(trailerDict)}`);\n    const trailer = `startxref\\n${xrefOffset}\\n%%EOF`;\n    if (this._polyglot && this._zipCatalog) {\n      log.debug('Writing zip end of central directory');\n      await this._write('9990 0 obj\\n<<>>\\nstream\\n');\n      const endObj = '\\nendstream\\nendobj\\n';\n      await this._write(\n        buildCentralFileDirectory({\n          files: this._zipCatalog,\n          trailingLength: trailer.length + endObj.length,\n          offset: this._offset,\n        })\n      );\n      await this._write(endObj);\n    }\n    await this._flush();\n    log.debug('Writing trailer');\n    await this._write(trailer);\n    log.debug('Flushing');\n    await this._flush();\n    // FIXME: Never resolves on Node.js, is it really\n    // needed in browsers?\n    //log.debug('Waiting for drainage');\n    //await this._writer.waitForDrain();\n    log.debug('PDF finished, closing writer');\n    await this._writer.close();\n    log.debug('Writer closed');\n    this._writer = undefined;\n  }\n\n  /** Insert a 'dummy' PDF object that isn't referenced anywhere, but which\n   *  contains the data neccessary to expose the following object's data as a\n   *  file in the ZIP archive.\n   */\n  private _insertZipHeaderDummyObject({\n    filename,\n    data,\n    deflatedData,\n    bytesUntilActualData,\n  }: ZipDummyObjectSpec): void {\n    if (this._zipBaseDir) {\n      filename = `${this._zipBaseDir}/${filename}`;\n    }\n    const zipObjOffset =\n      this._offset +\n      this._objects.reduce((acc, obj) => acc + this._getSerializedSize(obj), 0);\n    const creationDate = new Date();\n    bytesUntilActualData += '\\nendstream\\nendobj\\n'.length;\n    const zipObj = this._addObject(\n      {},\n      undefined,\n      buildLocalZipHeader({\n        filename,\n        data,\n        compressedData: deflatedData,\n        extraDataLength: bytesUntilActualData,\n        creationDate,\n      })\n    );\n    const localHeaderOffset =\n      zipObjOffset + this._getSerializedSize(zipObj, true);\n    if (!this._zipCatalog) {\n      this._zipCatalog = [];\n    }\n    this._zipCatalog.push({\n      localHeaderOffset,\n      deflated: deflatedData?.length !== data.length,\n      creationDate: new Date(),\n      crc32: crc32(data),\n      dataLength: data.length,\n      // skip 2 bytes for zlib header\n      compressedDataLength: deflatedData\n        ? deflatedData.length - 2\n        : data.length,\n      filename,\n    });\n  }\n}\n","export interface LicenseDescription {\n  text: string;\n  logo: string;\n}\nexport type LicenseList = Record<string, LicenseDescription>;\n\n// TODO: Re-generate this list based on the official CC RDF files:\n//  https://github.com/creativecommons/cc-licenses-data/blob/main/legacy/rdf-licenses\nexport const licenses: LicenseList = {\n  'http://creativecommons.org/licenses/by-nc-sa/2.0/fr/': {\n    text: 'Creative Commons Attribution-NonCommercial-ShareAlike 2.0 France (CC-BY-NC-SA-2.0-FR)',\n    logo: 'https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nc-sa.svg',\n  },\n  'http://creativecommons.org/licenses/by-sa/4.0/': {\n    text: 'Creative Commons Attribution Share Alike 4.0 International (CC-BY-SA-4.0)',\n    logo: 'https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-sa.svg',\n  },\n  'http://creativecommons.org/licenses/by/3.0/de/': {\n    text: 'Creative Commons Attribution 3.0 Germany (CC-BY-3.0-DE)',\n    logo: 'https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by.svg',\n  },\n  'http://creativecommons.org/licenses/by-nc-nd/3.0/': {\n    text: 'Creative Commons Attribution Non Commercial No Derivatives 3.0 Unported (CC-BY-NC-ND-3.0)',\n    logo: 'https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nc-nd.svg',\n  },\n  'http://creativecommons.org/licenses/by/1.0/': {\n    text: 'Creative Commons Attribution 1.0 Generic (CC-BY-1.0)',\n    logo: 'https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by.svg',\n  },\n  'http://creativecommons.org/licenses/by-nd/1.0/': {\n    text: 'Creative Commons Attribution No Derivatives 1.0 Generic (CC-BY-ND-1.0)',\n    logo: 'https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nd.svg',\n  },\n  'http://creativecommons.org/licenses/by-nc-sa/3.0/de/': {\n    text: 'Creative Commons Attribution Non Commercial Share Alike 3.0 Germany (CC-BY-NC-SA-3.0-DE)',\n    logo: 'https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nc-sa.svg',\n  },\n  'http://creativecommons.org/licenses/by-nc-sa/1.0/': {\n    text: 'Creative Commons Attribution Non Commercial Share Alike 1.0 Generic (CC-BY-NC-SA-1.0)',\n    logo: 'https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nc-sa.svg',\n  },\n  'http://creativecommons.org/licenses/by-nd/4.0/': {\n    text: 'Creative Commons Attribution No Derivatives 4.0 International (CC-BY-ND-4.0)',\n    logo: 'https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nd.svg',\n  },\n  'http://creativecommons.org/licenses/by-sa/3.0/at/': {\n    text: 'Creative Commons Attribution Share Alike 3.0 Austria (CC-BY-SA-3.0-AT)',\n    logo: 'https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-sa.svg',\n  },\n  'http://creativecommons.org/licenses/by/3.0/at/': {\n    text: 'Creative Commons Attribution 3.0 Austria (CC-BY-3.0-AT)',\n    logo: 'https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by.svg',\n  },\n  'http://creativecommons.org/licenses/by/3.0/': {\n    text: 'Creative Commons Attribution 3.0 Unported (CC-BY-3.0)',\n    logo: 'https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by.svg',\n  },\n  'http://creativecommons.org/licenses/by-nc/2.0/': {\n    text: 'Creative Commons Attribution Non Commercial 2.0 Generic (CC-BY-NC-2.0)',\n    logo: 'https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nc.svg',\n  },\n  'http://creativecommons.org/licenses/by-nc-sa/2.5/': {\n    text: 'Creative Commons Attribution Non Commercial Share Alike 2.5 Generic (CC-BY-NC-SA-2.5)',\n    logo: 'https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nc-sa.svg',\n  },\n  'http://creativecommons.org/licenses/by-nc/2.5/': {\n    text: 'Creative Commons Attribution Non Commercial 2.5 Generic (CC-BY-NC-2.5)',\n    logo: 'https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nc.svg',\n  },\n  'http://creativecommons.org/licenses/by-nd-nc/1.0/': {\n    text: 'Creative Commons Attribution Non Commercial No Derivatives 1.0 Generic (CC-BY-NC-ND-1.0)',\n    logo: 'https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nc-nd.svg',\n  },\n  'http://creativecommons.org/licenses/by-nd/3.0/': {\n    text: 'Creative Commons Attribution No Derivatives 3.0 Unported (CC-BY-ND-3.0)',\n    logo: 'https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nd.svg',\n  },\n  'http://creativecommons.org/licenses/by-sa/2.5/': {\n    text: 'Creative Commons Attribution Share Alike 2.5 Generic (CC-BY-SA-2.5)',\n    logo: 'https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-sa.svg',\n  },\n  'http://creativecommons.org/licenses/by-nc-sa/2.0/uk/': {\n    text: 'Creative Commons Attribution Non Commercial Share Alike 2.0 England and Wales (CC-BY-NC-SA-2.0-UK)',\n    logo: 'https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nc-sa.svg',\n  },\n  'http://creativecommons.org/licenses/by/2.0/': {\n    text: 'Creative Commons Attribution 2.0 Generic (CC-BY-2.0)',\n    logo: 'https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by.svg',\n  },\n  'http://creativecommons.org/licenses/by-nd/2.5/': {\n    text: 'Creative Commons Attribution No Derivatives 2.5 Generic (CC-BY-ND-2.5)',\n    logo: 'https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nd.svg',\n  },\n  'http://creativecommons.org/licenses/by-nc-nd/2.0/': {\n    text: 'Creative Commons Attribution Non Commercial No Derivatives 2.0 Generic (CC-BY-NC-ND-2.0)',\n    logo: 'https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nc-nd.svg',\n  },\n  'http://creativecommons.org/licenses/by-nc-sa/3.0/igo/': {\n    text: 'Creative Commons Attribution Non Commercial Share Alike 3.0 IGO (CC-BY-NC-SA-3.0-IGO)',\n    logo: 'https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nc-sa.svg',\n  },\n  'http://creativecommons.org/licenses/publicdomain//': {\n    text: 'Creative Commons Public Domain Dedication and Certification (CC-PDDC)',\n    logo: 'https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/publicdomain.svg',\n  },\n  'http://creativecommons.org/licenses/by-nc-sa/2.0/': {\n    text: 'Creative Commons Attribution Non Commercial Share Alike 2.0 Generic (CC-BY-NC-SA-2.0)',\n    logo: 'https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nc-sa.svg',\n  },\n  'http://creativecommons.org/licenses/by-nc-nd/3.0/de/': {\n    text: 'Creative Commons Attribution Non Commercial No Derivatives 3.0 Germany (CC-BY-NC-ND-3.0-DE)',\n    logo: 'https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nc-nd.svg',\n  },\n  'http://creativecommons.org/licenses/by-nc/3.0/': {\n    text: 'Creative Commons Attribution Non Commercial 3.0 Unported (CC-BY-NC-3.0)',\n    logo: 'https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nc.svg',\n  },\n  'http://creativecommons.org/licenses/by-nc/3.0/de/': {\n    text: 'Creative Commons Attribution Non Commercial 3.0 Germany (CC-BY-NC-3.0-DE)',\n    logo: 'https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nc.svg',\n  },\n  'http://creativecommons.org/licenses/by-sa/1.0/': {\n    text: 'Creative Commons Attribution Share Alike 1.0 Generic (CC-BY-SA-1.0)',\n    logo: 'https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-sa.svg',\n  },\n  'http://creativecommons.org/licenses/by-nd/3.0/de/': {\n    text: 'Creative Commons Attribution No Derivatives 3.0 Germany (CC-BY-ND-3.0-DE)',\n    logo: 'https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nd.svg',\n  },\n  'http://creativecommons.org/licenses/by-nc-nd/2.5/': {\n    text: 'Creative Commons Attribution Non Commercial No Derivatives 2.5 Generic (CC-BY-NC-ND-2.5)',\n    logo: 'https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nc-nd.svg',\n  },\n  'http://creativecommons.org/licenses/by-sa/3.0/': {\n    text: 'Creative Commons Attribution Share Alike 3.0 Unported (CC-BY-SA-3.0)',\n    logo: 'https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-sa.svg',\n  },\n  'http://creativecommons.org/licenses/by-nc-sa/4.0/': {\n    text: 'Creative Commons Attribution Non Commercial Share Alike 4.0 International (CC-BY-NC-SA-4.0)',\n    logo: 'https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nc-sa.svg',\n  },\n  'http://creativecommons.org/licenses/by-sa/2.0/': {\n    text: 'Creative Commons Attribution Share Alike 2.0 Generic (CC-BY-SA-2.0)',\n    logo: 'https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-sa.svg',\n  },\n  'http://creativecommons.org/licenses/by-sa/2.1/jp/': {\n    text: 'Creative Commons Attribution Share Alike 2.1 Japan (CC-BY-SA-2.1-JP)',\n    logo: 'https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-sa.svg',\n  },\n  'http://creativecommons.org/licenses/by/2.5/': {\n    text: 'Creative Commons Attribution 2.5 Generic (CC-BY-2.5)',\n    logo: 'https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by.svg',\n  },\n  'http://creativecommons.org/licenses/by-sa/2.0/uk/': {\n    text: 'Creative Commons Attribution Share Alike 2.0 England and Wales (CC-BY-SA-2.0-UK)',\n    logo: 'https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-sa.svg',\n  },\n  'http://creativecommons.org/licenses/by/3.0/nl/': {\n    text: 'Creative Commons Attribution 3.0 Netherlands (CC-BY-3.0-NL)',\n    logo: 'https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by.svg',\n  },\n  'http://creativecommons.org/licenses/by-nc-sa/3.0/': {\n    text: 'Creative Commons Attribution Non Commercial Share Alike 3.0 Unported (CC-BY-NC-SA-3.0)',\n    logo: 'https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nc-sa.svg',\n  },\n  'http://creativecommons.org/licenses/by/4.0/': {\n    text: 'Creative Commons Attribution 4.0 International (CC-BY-4.0)',\n    logo: 'https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by.svg',\n  },\n  'http://creativecommons.org/licenses/by/3.0/us/': {\n    text: 'Creative Commons Attribution 3.0 United States (CC-BY-3.0-US)',\n    logo: 'https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by.svg',\n  },\n  'http://creativecommons.org/licenses/by-nc-nd/4.0/': {\n    text: 'Creative Commons Attribution Non Commercial No Derivatives 4.0 International (CC-BY-NC-ND-4.0)',\n    logo: 'https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nc-nd.svg',\n  },\n  'http://creativecommons.org/licenses/by-sa/3.0/de/': {\n    text: 'Creative Commons Attribution Share Alike 3.0 Germany (CC-BY-SA-3.0-DE)',\n    logo: 'https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-sa.svg',\n  },\n  'http://creativecommons.org/licenses/by-nc-nd/3.0/igo/': {\n    text: 'Creative Commons Attribution Non Commercial No Derivatives 3.0 IGO (CC-BY-NC-ND-3.0-IGO)',\n    logo: 'https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nc-nd.svg',\n  },\n  'http://creativecommons.org/publicdomain/zero/1.0/': {\n    text: 'Creative Commons Zero v1.0 Universal (CC0-1.0)',\n    logo: 'https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/cc-zero.svg',\n  },\n  'http://creativecommons.org/publicdomain/mark/1.0/': {\n    text: 'Public Domain Mark 1.0: No Copyright',\n    logo: 'https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/publicdomain.svg',\n  },\n  'http://creativecommons.org/licenses/by/2.5/au/': {\n    text: 'Creative Commons Attribution 2.5 Australia (CC-BY-2.5-AU)',\n    logo: 'https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by.svg',\n  },\n  'http://creativecommons.org/licenses/by-nd/2.0/': {\n    text: 'Creative Commons Attribution No Derivatives 2.0 Generic (CC-BY-ND-2.0)',\n    logo: 'https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nd.svg',\n  },\n  'http://creativecommons.org/licenses/by-nc/1.0/': {\n    text: 'Creative Commons Attribution Non Commercial 1.0 Generic (CC-BY-NC-1.0)',\n    logo: 'https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nc.svg',\n  },\n  'http://creativecommons.org/licenses/by-nc/4.0/': {\n    text: 'Creative Commons Attribution Non Commercial 4.0 International (CC-BY-NC-4.0)',\n    logo: 'https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-nc.svg',\n  },\n  'http://rightsstatements.org/vocab/InC/1.0/': {\n    text: 'In Copyright',\n    logo: 'https://rightsstatements.org/files/buttons/InC.dark.svg',\n  },\n  'http://rightsstatements.org/vocab/InC-OW-EU/1.0/': {\n    text: 'In Copyright - EU Orphan Work',\n    logo: 'https://rightsstatements.org/files/buttons/InC-OW-EU.dark.svg',\n  },\n  'http://rightsstatements.org/vocab/InC-EDU/1.0/': {\n    text: 'In Copyright - Educational Use Permitted',\n    logo: 'https://rightsstatements.org/files/buttons/InC-EDU.dark.svg',\n  },\n  'http://rightsstatements.org/vocab/InC-NC/1.0/': {\n    text: 'In Copyright - Non-Commercial Use Permitted',\n    logo: 'https://rightsstatements.org/files/buttons/InC-NC.dark.svg',\n  },\n  'http://rightsstatements.org/vocab/InC-RUU/1.0/': {\n    text: 'In Copyright - Rights-holder(s) Unlocatable or Unidentifiable',\n    logo: 'https://rightsstatements.org/files/buttons/InC-RUU.dark.svg',\n  },\n  'http://rightsstatements.org/vocab/NoC-CR/1.0/': {\n    text: 'No Copyright - Contractual Restrictions',\n    logo: 'https://rightsstatements.org/files/buttons/NoC-CR.dark.svg',\n  },\n  'http://rightsstatements.org/vocab/NoC-NC/1.0/': {\n    text: 'No Copyright - Non-Commercial Use Only',\n    logo: 'https://rightsstatements.org/files/buttons/NoC-NC.dark.svg',\n  },\n  'http://rightsstatements.org/vocab/NoC-OKLR/1.0/': {\n    text: 'No Copyright - Other Known Legal Restrictions',\n    logo: 'https://rightsstatements.org/files/buttons/NoC-OKLR.dark.svg',\n  },\n  'http://rightsstatements.org/vocab/NoC-US/1.0/': {\n    text: 'No Copyright - United States',\n    logo: 'https://rightsstatements.org/files/buttons/NoC-US.dark.svg',\n  },\n  'http://rightsstatements.org/vocab/CNE/1.0/': {\n    text: 'Copyright Not Evaluated',\n    logo: 'https://rightsstatements.org/files/buttons/CNE.dark.svg',\n  },\n  'http://rightsstatements.org/vocab/UND/1.0/': {\n    text: 'Copyright Undetermined',\n    logo: 'https://rightsstatements.org/files/buttons/UND.dark.svg',\n  },\n  'http://rightsstatements.org/vocab/NKC/1.0/': {\n    text: 'No Known Copyright',\n    logo: 'https://rightsstatements.org/files/buttons/NKC.dark.svg',\n  },\n};\n\nexport function getLicenseInfo(uri: string): LicenseDescription | null {\n  uri = uri.replace(/^https:/, 'http:').replace(/\\/deed\\.[a-z]{2}$/, '');\n  if (!uri.endsWith('/')) {\n    uri += '/';\n  }\n  return licenses[uri];\n}\n","import type { EncodeOptions } from '@jsquash/jpeg/meta';\nimport { randomUUIDv4 } from './util';\nimport OptimizationWorker from './optimization.worker.ts?worker';\nimport log from './log';\n\nexport type InitializationRequest = {\n  mozjpegWasm: Uint8Array;\n};\n\nexport type TaskDescription<I> = {\n  id: string;\n  data: I;\n};\n\nexport type WorkerMessage<I, O> = { input: { id: string; data: I }; result: O };\nexport type WorkerTask<I, O> = {\n  resolve: (value: O) => void;\n  reject: (reason: any) => void;\n  task: TaskDescription<I>;\n};\n\nexport type MozJPEGParams = {\n  method: 'mozjpeg';\n  quality: number;\n} & Partial<EncodeOptions>;\n\nexport type BrowserEncoderParams = {\n  method: 'browser';\n  quality: number;\n};\n\nexport type OptimizationParams = MozJPEGParams | BrowserEncoderParams;\n\nexport type OptimizationRequest = {\n  imageData: Uint8Array;\n  imageFormat: 'image/jpeg' | 'image/png';\n} & OptimizationParams;\n\nexport type OptimizedImage = {\n  jpegData: Uint8Array;\n  sizeFactor: number;\n};\n\nexport class OptimizationError extends Error {\n  constructor(message: string, public taskId: string, public cause?: unknown) {\n    super(message);\n  }\n}\n\nexport const MOZJPEG_DEFAULT_PARAMS: EncodeOptions = {\n  quality: 75,\n  progressive: true,\n  optimize_coding: true,\n  smoothing: 0,\n  color_space: 3, // YCbCr\n  quant_table: 3,\n  trellis_multipass: false,\n  trellis_opt_table: true,\n  trellis_opt_zero: true,\n  trellis_loops: 0,\n  auto_subsample: false,\n  chroma_subsample: 2,\n  separate_chroma_quality: false,\n  chroma_quality: 75,\n  arithmetic: false,\n  baseline: false,\n};\n\nclass WorkerPool<I, O> {\n  private workers: Worker[] = [];\n  private queue: WorkerTask<I, O>[] = [];\n  private pendingTasks: Map<string, WorkerTask<I, O>> = new Map();\n  private busyWorkers: Set<Worker> = new Set();\n\n  constructor(public size: number) {}\n\n  start(): void {\n    for (let i = 0; i < this.size; i++) {\n      const worker = new OptimizationWorker();\n      worker.onmessage = this.handleMessage.bind(this, worker);\n      worker.onerror = this.handleError.bind(this, worker);\n      this.workers.push(worker);\n    }\n  }\n\n  stop(): void {\n    this.workers.forEach((worker) => worker.terminate());\n    this.workers = [];\n    this.queue = [];\n    this.busyWorkers.clear();\n  }\n\n  dispatch(data: I): Promise<O> {\n    return new Promise((resolve, reject) => {\n      this.queue.push({\n        resolve,\n        reject,\n        task: {\n          id: randomUUIDv4(),\n          data,\n        },\n      });\n      this.processQueue();\n    });\n  }\n\n  private processQueue(): void {\n    if (this.queue.length === 0) return;\n    const availableWorker = this.workers.find((w) => !this.busyWorkers.has(w));\n    if (!availableWorker) return;\n\n    const job = this.queue.shift()!;\n    this.pendingTasks.set(job.task.id, job);\n    this.busyWorkers.add(availableWorker);\n    availableWorker.postMessage(job.task);\n  }\n\n  private handleMessage(\n    worker: Worker,\n    event: MessageEvent<WorkerMessage<I, O>>\n  ): void {\n    log.debug(`worker: received message`, event.data);\n    const job = this.pendingTasks.get(event.data.input.id);\n    if (job) {\n      job.resolve(event.data.result);\n      log.debug(`worker: resolved job`, job.task.id);\n      this.pendingTasks.delete(job.task.id);\n      this.busyWorkers.delete(worker);\n      this.processQueue();\n    } else {\n      log.warn(\n        `worker: unknown job, known jobs: ${[...this.pendingTasks.keys()].join(\n          ', '\n        )}`,\n        event.data.input.id\n      );\n    }\n  }\n\n  private handleError(worker: Worker, evt: ErrorEvent): void {\n    const optimError = evt.error as OptimizationError;\n    const job = this.queue.find((j) => j.task.id === optimError.taskId);\n    if (job) {\n      job.reject(optimError.cause);\n      this.busyWorkers.delete(worker);\n      this.processQueue();\n    }\n  }\n}\n\nlet pool: WorkerPool<\n  OptimizationParams | InitializationRequest,\n  OptimizedImage | undefined\n> | null = null;\nlet isInitialized = false;\n\nexport function startWorkerPool(size = navigator.hardwareConcurrency): void {\n  if (pool !== null) {\n    return;\n  }\n  pool = new WorkerPool(size);\n  pool.start();\n}\n\nexport function stopWorkerPool(): void {\n  if (pool === null) {\n    return;\n  }\n  pool.stop();\n  pool = null;\n}\n\nexport async function initialize(wasmLoader: () => Promise<Uint8Array>): Promise<void> {\n  if (pool === null) {\n    startWorkerPool();\n  }\n\n  if (isInitialized) {\n    return;\n  }\n\n  const mozjpegWasm = await wasmLoader();\n  let promises: Promise<undefined>[] = [];\n  for (let i = 0; i < pool!.size; i++) {\n    promises.push(pool!.dispatch({ mozjpegWasm }) as Promise<undefined>);\n  }\n  log.debug('main: mozjpegWasm sent to workers');\n  await Promise.all(promises);\n  log.debug('main: workers initialized with MozJPEG encoder');\n  isInitialized = true;\n}\n\nexport async function optimizeImage(\n  params: OptimizationRequest\n): Promise<OptimizedImage> {\n  if (pool === null) {\n    startWorkerPool();\n  }\n\n  return pool!.dispatch(params) as Promise<OptimizedImage>;\n}\n","/// <reference types=\"wicg-file-system-access\"/>\nimport type { Writable } from 'stream';\nimport {\n  Manifest,\n  RangeItems,\n  Reference,\n  IIIFExternalWebResource,\n  ContentResource,\n  Service,\n  ImageService,\n  Annotation as IIIF3Annotation,\n} from '@iiif/presentation-3';\nimport {\n  ManifestNormalized,\n  CanvasNormalized,\n  RangeNormalized,\n  AnnotationNormalized,\n  ResourceProviderNormalized,\n  NormalizedRangeItemSchemas,\n} from '@iiif/presentation-3-normalized';\nimport Presentation2 from '@iiif/presentation-2';\nimport { upgrade as convertPresentation2 } from '@iiif/parser/upgrader';\nimport PQueue from 'p-queue';\nimport events from 'events';\nimport * as ocrParser from 'ocr-parser';\n\nimport PDFGenerator from './pdf/generator.js';\nimport {\n  CountingWriter,\n  WebWriter,\n  NodeWriter,\n  Writer,\n  BlobWriter,\n} from './io.js';\nimport { TocItem } from './pdf/util.js';\nimport { getLicenseInfo } from './res/licenses.js';\nimport { getOcrReferences } from './ocr.js';\nimport pdiiifVersion from './version.js';\nimport {\n  fetchCanvasData,\n  fetchRespectfully,\n  CanvasData,\n  fetchStartCanvasInfo,\n  StartCanvasInfo,\n  fetchManifestJson,\n} from './download.js';\nimport metrics from './metrics.js';\nimport { initializeSaxParser, isDefined, now, saxParserWasm } from './util.js';\nimport log from './log.js';\nimport {\n  getI18nValue,\n  getThumbnail,\n  getCanvasInfo,\n  vault,\n  parseAnnotation,\n  Annotation,\n} from './iiif.js';\nimport {\n  initialize,\n  OptimizationParams,\n  optimizeImage,\n} from './optimization.js';\n\n/** Progress information for rendering a progress bar or similar UI elements. */\nexport interface ProgressStatus {\n  /** Message code that should be mapped to a human readable description in a UI. */\n  messageCode?: ProgressMessageCode;\n  /** Expected total number of pages in the PDF */\n  totalPages: number;\n  /** Number of pages that were submitted for writing */\n  pagesWritten: number;\n  /** Number of bytes that were submitted for writing to the output stream */\n  bytesPushed: number;\n  /** Number of bytes that were written to the output stream so far */\n  bytesWritten: number;\n  /** Predicted size of the final file in bytes */\n  estimatedFileSize?: number;\n  /** Write speed in bytes per second */\n  writeSpeed: number;\n  /** Estimated time in seconds until PDF has finished generating */\n  remainingDuration: number;\n}\n\n/** Parameters for rendering a cover page, parsed from IIIF manifest. */\nexport interface CoverPageParams {\n  title: string;\n  manifestUrl: string;\n  thumbnail?: {\n    url: string;\n    iiifImageService?: string;\n  };\n  provider?: {\n    label: string;\n    homepage?: string;\n    logo?: string;\n  };\n  requiredStatement?: {\n    label: string;\n    value: string;\n  };\n  rights?: {\n    text: string;\n    url?: string;\n    logo?: string;\n  };\n  metadata?: Array<[string, string | Array<string>]>;\n  pdiiifVersion: string;\n}\n\n/** Options for converting a IIIF Manifest to a PDF. */\nexport interface ConvertOptions {\n  /** Callback to provide annotations for a given canvas identifier.\n   * Should return either a `sc:AnnotationList` (IIIF2) or an `AnnotationPage` (IIIF3).\n   */\n  fetchCanvasAnnotations?: (\n    canvasId: string\n  ) => Promise<Array<IIIF3Annotation> | Array<Presentation2.Annotation>>;\n  /** Pixels per inch to assume for the full resolution version of each canvas.\n      If not set, the conversion will use an available IIIF Physical Dimensions\n      service to calculate the page dimensions instead. */\n  ppi?: number;\n  /** Set of canvas ids to include in PDF, or a predicate to filter canvas identifiers\n      by. By default, all canvases are included in the PDF. */\n  filterCanvases?: readonly string[] | ((canvasId: string) => boolean);\n  /** List of languages to use for metadata, page labels and table of contents, in\n      descending order of preference. Will use the environment's locale settings by\n      default. */\n  languagePreference?: readonly string[];\n  /** Restrict the image size to include in the PDF by downscaling by a fixed factor.\n   * The value must be a number between 0.1 and 1.\n   * Only works with Level 2 Image API services that allow arbitrary downscaling, the\n   * conversion will not perform downscaling itself.\n   * For Level 1 endpoints, the closest available lower width will be selected. */\n  scaleFactor?: number;\n  /** Number of maximum concurrent IIIF Image API requests to be performed, defaults to 1 */\n  concurrency?: number;\n  /** Callback that gets called whenever a page has finished, useful to render a\n      progress bar. */\n  onProgress?: (status: ProgressStatus) => void;\n  /** Callback that gets called with a notification when an error occurs during PDF generation\n   *  that does not cause the conversion to fail. */\n  onNotification?: (notification: ProgressNotification) => void;\n  /** Controller that allows aborting the PDF generation. All pending\n      downloads will be terminated. The caller is responsible for\n      removing underlying partial files and/or other user signaling. */\n  abortController?: AbortController;\n  /** Set PDF metadata, by default `Title` will be the manifest's label. */\n  metadata?: {\n    CreationDate?: Date;\n    Title?: string;\n    Author?: string;\n    Keywords?: string;\n  };\n  /** Endpoint to contact for retrieving PDF data with one or more cover pages\n      to insert before the canvas pages */\n  coverPageEndpoint?: string;\n  /** Callback to call for retrieving PDF data with one or more cover pages\n      to insert before the canvas pages */\n  coverPageCallback?: (params: CoverPageParams) => Promise<Uint8Array>;\n  /** Generate the PDF in a way that the resulting file is also a valid\n   *  ZIP file that contains the manifest, all of the images and, if present,\n   *  the OCR files referenced in the manifest. */\n  polyglotZipPdf?: boolean;\n  /** Base directory in the polyglot ZIP archive. If not set, all resource\n   * directories will be to-level in the archive. */\n  polyglotZipBaseDir?: string;\n  /** Custom loader callback that fetches the WASM binary for the `sax-wasm`\n   *  dependency (v2.2.4). By default, the dependency will be loaded from\n   *  `https://unpkg.com/sax-wasm/dist/sax-wasm.wasm`. Override if you want\n   *  to provide your own payload. Loader will not be called if {@link initialize}\n   *  from `ocr-parser` has been called before.\n   */\n  saxWasmLoader?: () => Promise<Uint8Array>;\n  /** Custom loader callback that fetches the WASM binary for the `@jsquash/jpeg`\n   * dependency (v1.5.0). By default the dependency will be loaded from\n   * `https://unpkg.com/@jsquash/jpeg@1.5.0/codec/enc/mozjpeg_enc.wasm`. Override\n   * if you want to provide your own payload. Loader will not be called if\n   * {@link optimization} is not set to use the `mozjpeg` method.\n   */\n  mozjpegWasmLoader?: () => Promise<Uint8Array>;\n  /** Parameters for optimizing the images for size by re-encoding them to JPEGs. */\n  optimization?: OptimizationParams;\n}\n\n/** Parameters for size estimation */\nexport interface EstimationParams {\n  /** The manifest to determine the PDF size for */\n  manifest: string | Manifest | Presentation2.Manifest;\n  /** Restrict the image size to include in the PDF by downscaling by a fixed factor.\n   * The value must be a number between 0.1 and 1.\n   * Only works with Level 2 Image API services that allow arbitrary downscaling, the\n   * conversion will not perform downscaling itself.\n   * For Level 1 endpoints, the closest available lower width will be selected. */\n  scaleFactor?: number;\n  /** Set of canvas ids to include in PDF, or a predicate to filter canvas identifiers\n      by. By default, all canvases are included in the PDF. */\n  filterCanvases?: readonly string[] | ((canvasId: string) => boolean);\n  /** Number of canvses to sample for estimation, defaults to 8 */\n  numSamples?: number;\n  /** Number of maximum concurrent IIIF Image API requests to be performed, defaults to 1 */\n  concurrency?: number;\n  /** Parameters for optimizing the images for size by re-encoding them to JPEGs. */\n  optimization?: OptimizationParams;\n  /** Custom loader callback that fetches the WASM binary for the `sax-wasm`\n   *  dependency (v2.2.4). By default, the dependency will be loaded from\n   *  `https://unpkg.com/sax-wasm/dist/sax-wasm.wasm`. Override if you want\n   *  to provide your own payload. Loader will not be called if {@link initialize}\n   *  from `ocr-parser` has been called before.\n   */\n  saxWasmLoader?: () => Promise<Uint8Array>;\n  /** Custom loader callback that fetches the WASM binary for the `@jsquash/jpeg`\n   * dependency (v1.5.0). By default the dependency will be loaded from\n   * `https://unpkg.com/@jsquash/jpeg@1.5.0/codec/enc/mozjpeg_enc.wasm`. Override\n   * if you want to provide your own payload. Loader will not be called if\n   * {@link optimization} is not set to use the `mozjpeg` method.\n   */\n  mozjpegWasmLoader?: () => Promise<Uint8Array>;\n  /** Pre-sampled list of canvases to use for estimating the size */\n  sampleCanvases?: CanvasNormalized[];\n}\n\nexport type Estimation = {\n  /** Estimated size of the PDF in bytes */\n  size: number;\n  /** If CORS is enabled for all of the images referenced in the sample canvases */\n  corsSupported: boolean;\n  /** Image data for a sample image, present when optimization is enabled. */\n  sampleImageData?: Uint8Array;\n  /** Image MIME type for a sample image, present when optimization is enabled. */\n  sampleImageMimeType?: string;\n  /** How large is the PDF after the image optimization, compared to the unoptimized images?  */\n  optimizationResult?: number;\n  /** Canvases that were used for estimating */\n  sampleCanvases: CanvasNormalized[];\n};\n\nfunction getCanvasesForSampling(\n  canvases: CanvasNormalized[],\n  numSamples: number\n): CanvasNormalized[] {\n  if (canvases.length <= numSamples) {\n    return canvases;\n  }\n  const meanPixels =\n    canvases.reduce((x, { width, height }) => x + width * height, 0) /\n    canvases.length;\n  const candidateCanvases = canvases.filter(\n    (c) => Math.abs(meanPixels - c.width * c.height) <= 0.25 * meanPixels\n  );\n  if (candidateCanvases.length <= numSamples) {\n    return candidateCanvases;\n  }\n  const sampleCanvases: CanvasNormalized[] = [];\n  while (sampleCanvases.length < numSamples) {\n    const candidate =\n      candidateCanvases[Math.floor(Math.random() * candidateCanvases.length)];\n    if (sampleCanvases.indexOf(candidate) < 0) {\n      sampleCanvases.push(candidate);\n    }\n  }\n  return sampleCanvases.sort(\n    (a, b) => canvases.indexOf(a) - canvases.indexOf(b)\n  );\n}\n\n/** Estimate the final size of the PDF for a given manifest.\n *\n * This will randomly sample a few representative canvases from the manifest,\n * check their size in bytes and extrapolate from that to all canvases.\n *\n * @throws {Error} if the manifest cannot be loaded\n */\nexport async function estimatePdfSize({\n  manifest: inputManifest,\n  concurrency = 1,\n  scaleFactor,\n  filterCanvases = () => true,\n  numSamples = 8,\n  optimization,\n  saxWasmLoader = async () =>\n    fetch(\n      `https://unpkg.com/sax-wasm@${ocrParser.SAX_WASM_VERSION}/lib/sax-wasm.wasm`\n    )\n      .then((res) => res.arrayBuffer())\n      .then((buf) => new Uint8Array(buf)),\n  mozjpegWasmLoader = async () =>\n    fetch('https://unpkg.com/@jsquash/jpeg@1.5.0/codec/enc/mozjpeg_enc.wasm')\n      .then((res) => res.arrayBuffer())\n      .then((buf) => new Uint8Array(buf)),\n  sampleCanvases\n}: EstimationParams): Promise<Estimation> {\n  let manifestId;\n  if (typeof inputManifest === 'string') {\n    manifestId = inputManifest;\n  } else {\n    manifestId =\n      (inputManifest as Manifest).id ??\n      (inputManifest as Presentation2.Manifest)['@id'];\n  }\n  const manifestJson = await fetchManifestJson(manifestId);\n  const manifest = await vault.loadManifest(manifestId, manifestJson);\n  if (!manifest) {\n    throw new Error(`Failed to load manifest from ${manifestId}`);\n  }\n  let canvasPredicate: (canvasId: string) => boolean;\n  if (Array.isArray(filterCanvases)) {\n    canvasPredicate = (canvasId) => filterCanvases.indexOf(canvasId) >= 0;\n  } else {\n    canvasPredicate = filterCanvases as (id: string) => boolean;\n  }\n\n  const canvases = vault.get<CanvasNormalized>(\n    manifest.items.filter(c => canvasPredicate(c.id)).map(c => c.id));\n\n  // Select some representative canvases that are close to the mean in terms\n  // of their pixel area to avoid small images distorting the estimate too much\n  const totalCanvasPixels = canvases.reduce(\n    (sum, canvas) => sum + canvas.width * canvas.height,\n    0\n  );\n  if (!sampleCanvases?.length) {\n    sampleCanvases = getCanvasesForSampling(canvases, numSamples);\n  }\n  const samplePixels = sampleCanvases.reduce(\n    (sum, canvas) => sum + canvas.width * canvas.height,\n    0\n  );\n\n  // Initialize XML parsers\n  if (!saxParserWasm || !ocrParser.isInitialized()) {\n    if (!saxParserWasm) {\n      const wasm = await saxWasmLoader();\n      initializeSaxParser(wasm);\n    }\n    if (!ocrParser.isInitialized()) {\n      await ocrParser.initialize(() => Promise.resolve(saxParserWasm!));\n      ocrParser.setupLogging({\n        debug: log.debug.bind(log),\n        info: log.info.bind(log),\n        warn: log.warn.bind(log),\n        error: log.error.bind(log),\n      });\n    }\n  }\n\n  const queue = new PQueue({ concurrency });\n  const canvasData = await Promise.all(\n    sampleCanvases.map((c) =>\n      queue.add(async () => {\n        const info = getCanvasInfo(c);\n        return fetchCanvasData(c, info.images, {\n          scaleFactor,\n          sizeOnly: optimization === undefined,\n        });\n      })\n    )\n  );\n\n  let optimizationResult: number | undefined;\n  if (optimization) {\n    if (optimization.method === 'mozjpeg') {\n      await initialize(mozjpegWasmLoader);\n    }\n    const images = canvasData\n      .filter((c): c is CanvasData => c !== undefined)\n      .flatMap((c) => c.images);\n    const originalSize = images.reduce(\n      (sum, img) => sum + img.data!.byteLength,\n      0\n    );\n    await Promise.all(\n      images.map(async (img) => {\n        const optimized = await optimizeImage({\n          imageData: new Uint8Array(img.data!),\n          imageFormat:\n            (img.format as 'jpeg' | 'png') === 'jpeg'\n              ? 'image/jpeg'\n              : 'image/png',\n          ...optimization,\n        });\n        img.data = optimized.jpegData.buffer;\n        img.format = 'jpeg';\n      })\n    );\n    const optimizedSize = images.reduce(\n      (sum, img) => sum + img.data!.byteLength,\n      0\n    );\n    optimizationResult = optimizedSize / originalSize;\n  }\n\n  const corsSupported = canvasData\n    .filter(isDefined<CanvasData>)\n    .flatMap((c) => c.images)\n    .every((i) => i.corsAvailable);\n  const sampleBytes = canvasData\n    .filter(isDefined<CanvasData>)\n    .flatMap((c) => c.images)\n    .reduce(\n      (size: number, img) => size + (img?.data?.byteLength ?? img.numBytes),\n      0\n    );\n  const sampleImages = canvasData\n    .filter(isDefined<CanvasData>)\n    .flatMap((c) => c.images);\n  const sampleImage = sampleImages[0];\n  const bpp = sampleBytes / samplePixels;\n  return {\n    size: bpp * totalCanvasPixels,\n    corsSupported,\n    sampleImageData: sampleImage.data\n      ? new Uint8Array(sampleImage.data)\n      : undefined,\n    sampleImageMimeType: sampleImage.format,\n    sampleCanvases,\n    optimizationResult\n  };\n}\n\nasync function buildOutlineFromRanges(\n  manifest: ManifestNormalized,\n  canvases: CanvasNormalized[],\n  languagePreference: string[]\n): Promise<Array<TocItem>> {\n  // ToC generation: IIIF's `Range` construct is so open, doing anything useful with it is a pain :-/\n  // In our case, the pain comes from multiple directions:\n  // - PDFs can only connect an outline node to a *single* page (IIIF connects ranges of pages)\n  // - IIIF doesn't prescribe an order for the ranges or the canvases contained in them\n  // Our approach is to pre-generate the range associated with each canvas and a hierarchy\n  // of parent-child relationships for ranges.\n\n  // All canvas identifiers in the order they appear as in the sequence\n  // Note that this is a *filtered* list of canvases, i.e. if the user only selected a subset of the\n  // canvases for PDF generation, not every Range in the manifest will have all of its canvases in here\n  const canvasIds = canvases.map((canvas) => canvas.id);\n\n  // We have to recurse, this small closure handles each node in the tree\n  const isCanvas = (ri: RangeItems | NormalizedRangeItemSchemas): ri is Reference<'Canvas'> =>\n    typeof ri !== 'string' && ri.type === 'Canvas';\n  const isRange = (ri: RangeItems | NormalizedRangeItemSchemas): ri is Reference<'Range'> =>\n    typeof ri !== 'string' && ri.type == 'Range';\n\n  const seenRanges: Set<string> = new Set();\n  const handleTocRange = async (\n    range: RangeNormalized\n  ): Promise<TocItem | undefined> => {\n    if (seenRanges.has(range.id)) {\n      return;\n    }\n    // Double filtering with `isCanvas` is necessary because of TS limitations\n    const firstCanvas = range.items\n      .filter(isCanvas)\n      .filter((c) => canvasIds.indexOf(c.id!) >= 0)\n      .filter(isCanvas)\n      .sort((a, b) =>\n        canvasIds.indexOf(a.id!) > canvasIds.indexOf(b.id!) ? -1 : 1\n      )[0];\n    const rangeLabel = getI18nValue(\n      range.label ?? '<untitled>',\n      languagePreference,\n      '; '\n    );\n    const childRanges = vault.get<RangeNormalized>(range.items.filter(isRange));\n    const children = (\n      await Promise.all(childRanges.map(handleTocRange))\n    ).filter(isDefined<TocItem>);\n\n    let startCanvas: StartCanvasInfo | undefined;\n    if (range.start) {\n      startCanvas = await fetchStartCanvasInfo(range);\n    }\n    seenRanges.add(range.id);\n    if (children.length === 0 && !firstCanvas) {\n      // Range with no canvases and no child ranges, ignore\n      // This usually happens when the user filtered the canvases to be included in the\n      // PDF and the range and its children only contains canvases that were filtered out\n      return;\n    } else if (!startCanvas && firstCanvas) {\n      startCanvas = firstCanvas.id;\n    } else if (!startCanvas) {\n      startCanvas = children[0].startCanvas;\n    }\n    return {\n      label: rangeLabel,\n      startCanvas: startCanvas!,\n      children,\n    };\n  };\n\n  let tocRanges = vault.get<RangeNormalized>(manifest.structures);\n  const topRange = tocRanges.find(\n    (r) => (r.behavior as string[]).indexOf('top') >= 0\n  );\n  // If there's a 'top' range, only use that as the single top-level ToC node\n  if (topRange) {\n    tocRanges = [topRange];\n  }\n\n  return (\n    (await Promise.all(tocRanges.map(handleTocRange))).filter(\n      isDefined<TocItem>\n    ) ?? []\n  );\n}\n\nexport type ProgressMessageCode =\n  | 'generate-cover-page'\n  | 'generate-pages'\n  | 'finishing';\n\nexport type ProgressNotification =\n  | ImageDownloadFailureNotification\n  | OcrDownloadFailureNotification;\n\nexport type ImageDownloadFailureNotification = {\n  code: 'image-download-failure';\n  canvasIndex: number;\n  numFailed: number;\n  numTotal: number;\n  details: {\n    [imageUrl: string]: string;\n  };\n};\nexport type OcrDownloadFailureNotification = {\n  code: 'ocr-download-failure';\n  canvasIndex: number;\n  ocrUrl: string;\n};\n\n/** Tracks PDF generation progress and various statistics related to that. */\nclass ProgressTracker {\n  canvasPixels = 0;\n  pixelsWritten = 0;\n  pixelBytesFactor = 0;\n  pixelScaleFactor = 0;\n  timeStart: number | undefined;\n\n  pdfGen: PDFGenerator;\n  totalPages: number;\n  totalCanvasPixels = 0;\n  countingStream: CountingWriter;\n  onProgress?: (status: ProgressStatus) => void;\n  onNotification?: (notification: ProgressNotification) => void;\n\n  constructor(\n    canvases: CanvasNormalized[],\n    countingStream: CountingWriter,\n    pdfGen: PDFGenerator,\n    onProgress?: (status: ProgressStatus) => void,\n    onNotification?: (notification: ProgressNotification) => void\n  ) {\n    this.totalCanvasPixels = canvases.reduce(\n      (sum, canvas) => sum + canvas.width * canvas.height,\n      0\n    );\n    this.totalPages = canvases.length;\n    this.pdfGen = pdfGen;\n    this.countingStream = countingStream;\n    this.onProgress = onProgress;\n    this.onNotification = onNotification;\n  }\n\n  /** Check if there is still data that needs to be written out. */\n  get writeOutstanding(): boolean {\n    return this.pdfGen.bytesWritten > this.countingStream.bytesWritten;\n  }\n\n  /** Emit a progress update, with an optional message. */\n  emitProgress(pagesWritten: number, messageCode?: ProgressMessageCode): void {\n    if (!this.timeStart) {\n      this.timeStart = now();\n    }\n    const bytesPushed = this.pdfGen.bytesWritten;\n    let estimatedFileSize;\n    if (pagesWritten === this.totalPages) {\n      estimatedFileSize = bytesPushed;\n    } else if (pagesWritten > 0) {\n      estimatedFileSize = Math.floor(\n        this.pixelBytesFactor * this.pixelScaleFactor * this.totalCanvasPixels\n      );\n    }\n    const bytesWritten = this.countingStream.bytesWritten;\n    const writeSpeed = bytesPushed / ((now() - this.timeStart) / 1000);\n    let remainingDuration = Number.POSITIVE_INFINITY;\n    if (estimatedFileSize) {\n      remainingDuration = (estimatedFileSize - bytesWritten) / writeSpeed;\n    }\n    this.onProgress?.({\n      messageCode,\n      pagesWritten,\n      totalPages: this.totalPages,\n      bytesWritten,\n      bytesPushed,\n      estimatedFileSize,\n      writeSpeed,\n      remainingDuration,\n    });\n  }\n\n  /** Emit a notification message to inform the user about unexpected stuff that\n   * happens during PDF generation */\n  emitNotification(notification: ProgressNotification) {\n    this.onNotification?.(notification);\n  }\n\n  /** Update how many actual pixels and 'canvas pixels' have been written. */\n  updatePixels(pixelsWritten: number, canvasPixels: number) {\n    this.pixelsWritten += pixelsWritten;\n    this.canvasPixels += canvasPixels;\n    this.pixelScaleFactor = this.pixelsWritten / this.canvasPixels;\n    this.pixelBytesFactor = this.pdfGen.bytesWritten / this.pixelsWritten;\n  }\n}\n\n/** Generate a cover page PDF, either via user-provided callback, or by fetching\n * it from a remote endpoint. */\nasync function getCoverPagePdf(\n  manifest: ManifestNormalized,\n  languagePreference: Array<string>,\n  endpoint?: string,\n  callback?: (params: CoverPageParams) => Promise<Uint8Array>\n): Promise<Uint8Array> {\n  const params: CoverPageParams = {\n    // NOTE: Manifest label is mandatory, i.e. safe to assert non-null\n    // eslint-disable-next-line @typescript-eslint/no-non-null-assertion\n    title: getI18nValue(\n      manifest.label ?? '<untitled>',\n      languagePreference,\n      '; '\n    ),\n    manifestUrl: manifest.id,\n    pdiiifVersion,\n  };\n  const thumbUrl = await getThumbnail(manifest, 512);\n  if (thumbUrl) {\n    params.thumbnail = { url: thumbUrl };\n    const manifestThumb = vault.get<ContentResource>(manifest.thumbnail.map(t => t.id))[0];\n    if (manifestThumb && 'type' in manifestThumb) {\n      params.thumbnail.iiifImageService = (\n        manifestThumb as IIIFExternalWebResource\n      ).service?.find(\n        (s: Service): s is ImageService =>\n          (s as ImageService | undefined)?.type?.startsWith('ImageService') ??\n          false\n      )?.id;\n    }\n  }\n\n  const provider = vault.get<ResourceProviderNormalized>(manifest.provider)[0];\n  const required = manifest.requiredStatement;\n  if (provider) {\n    params.provider = {\n      label: getI18nValue(provider.label, languagePreference, '; '),\n      homepage: provider.homepage?.[0]?.id,\n      logo: provider.logo?.[0]?.id,\n    };\n    // FIXME: Currently this is assigned by @iiif/parser when converting from v2 to v3\n    if (params.provider.label === 'Unknown') {\n      params.provider.label = '';\n    }\n  }\n  if (required != null && required.label) {\n    params.requiredStatement = {\n      label: getI18nValue(required.label, languagePreference, '; '),\n      value: getI18nValue(required.value, languagePreference, '; '),\n    };\n  }\n  const license = manifest.rights;\n  if (license) {\n    const licenseDef = getLicenseInfo(license);\n    params.rights = {\n      text: licenseDef?.text ?? license,\n      url: license,\n      logo: licenseDef?.logo,\n    };\n  }\n  params.metadata =\n    manifest.metadata\n      ?.map((itm) => {\n        const label = getI18nValue(itm.label, languagePreference, '; ');\n        const values = getI18nValue(itm.value, languagePreference, '|||').split(\n          '|||'\n        );\n        if (!label || values.length === 0) {\n          return;\n        }\n        if (values.length === 1) {\n          return [label, values[0]];\n        } else {\n          return [label, values];\n        }\n      })\n      .filter((x): x is [string, string | string[]] => x !== undefined) ?? [];\n  if (callback) {\n    return await callback(params);\n  } else if (endpoint) {\n    const resp = await fetchRespectfully(endpoint, {\n      method: 'POST',\n      headers: { 'Content-Type': 'application/json; charset=utf-8' },\n      body: JSON.stringify(params),\n    });\n    const buf = await resp.arrayBuffer();\n    return new Uint8Array(buf);\n  } else {\n    throw 'Either `endpoint` or `callback` must be specified!';\n  }\n}\n\nexport type ConversionReport = {\n  fileSizeBytes: number;\n  numPages: number;\n  fileName?: string;\n  failedImages?: Array<{\n    canvasIndex: number;\n    numFailed: number;\n    numTotal: number;\n    details: {\n      [imageUrl: string]: string;\n    };\n  }>;\n  failedOcr?: Array<{\n    canvasIndex: number;\n    ocrUrl: string;\n  }>;\n};\n\nexport type ConversionReportWithData = ConversionReport & { data: Blob };\n\nexport async function convertManifest(\n  inputManifest: string | Manifest | Presentation2.Manifest,\n  outputStream: Writable | WritableStream,\n  options: ConvertOptions\n): Promise<ConversionReport>;\nexport async function convertManifest(\n  inputManifest: string | Manifest | Presentation2.Manifest,\n  outputStream: undefined,\n  options: ConvertOptions\n): Promise<ConversionReportWithData>;\n/** Convert a IIIF manifest to a PDF,  */\nexport async function convertManifest(\n  /* eslint-disable  @typescript-eslint/explicit-module-boundary-types */\n  inputManifest: string | Manifest | Presentation2.Manifest,\n  outputStream: Writable | WritableStream | undefined,\n  {\n    fetchCanvasAnnotations = () => Promise.resolve([]),\n    filterCanvases = () => true,\n    languagePreference = [Intl.DateTimeFormat().resolvedOptions().locale],\n    scaleFactor,\n    metadata = {},\n    onProgress,\n    onNotification,\n    ppi,\n    concurrency = 1,\n    abortController = new AbortController(),\n    coverPageCallback,\n    coverPageEndpoint,\n    polyglotZipPdf,\n    polyglotZipBaseDir,\n    optimization,\n    saxWasmLoader = async () =>\n      fetch(\n        `https://unpkg.com/sax-wasm@${ocrParser.SAX_WASM_VERSION}/lib/sax-wasm.wasm`\n      )\n        .then((res) => res.arrayBuffer())\n        .then((buf) => new Uint8Array(buf)),\n    mozjpegWasmLoader = async () =>\n      fetch('https://unpkg.com/@jsquash/jpeg@1.5.0/codec/enc/mozjpeg_enc.wasm')\n        .then((res) => res.arrayBuffer())\n        .then((buf) => new Uint8Array(buf)),\n  }: ConvertOptions\n): Promise<ConversionReport | ConversionReportWithData> {\n  // Prevent warning when running in Node.js\n  if (typeof process !== 'undefined') {\n    events.setMaxListeners(100, abortController.signal);\n  }\n  let writer: Writer;\n  if (!outputStream) {\n    log.debug('Writing to Blob');\n    writer = new BlobWriter();\n    // Can't use `instanceof` since we don't have the Node class in the\n    // browser and vice versa, so examine the shape of the object\n  } else if (typeof (outputStream as Writable).destroy === 'function') {\n    log.debug('Writing to Node writable stream');\n    writer = new NodeWriter(outputStream as Writable);\n    // Cancel further processing once the underlying stream has been closed\n    // This will only have an effect if the PDF has not finished generating\n    // yet (i.e. when the client terminates the connection prematurely),\n    // otherwise all processing will long have stopped\n    (outputStream as Writable).on('close', () => abortController.abort());\n  } else {\n    log.debug('Writing to file system');\n    writer = new WebWriter(outputStream as WritableStream);\n  }\n  const countingWriter = new CountingWriter(writer);\n  const report = {\n    fileSizeBytes: 0,\n    numPages: 0,\n  } as ConversionReport;\n\n  // Build a canvas predicate function from a list of identifiers, if needed\n  let canvasPredicate: (canvasId: string) => boolean;\n  if (Array.isArray(filterCanvases)) {\n    canvasPredicate = (canvasId) => filterCanvases.indexOf(canvasId) >= 0;\n  } else {\n    canvasPredicate = filterCanvases as (id: string) => boolean;\n  }\n\n  let manifestId: string;\n  let manifestJson: Manifest | Presentation2.Manifest;\n  if (typeof inputManifest === 'string') {\n    manifestId = inputManifest;\n    manifestJson = (await fetchManifestJson(manifestId)) as\n      | Manifest\n      | Presentation2.Manifest;\n  } else {\n    manifestId =\n      (inputManifest as Presentation2.Manifest)['@id'] ??\n      (inputManifest as Manifest).id;\n    manifestJson = inputManifest;\n  }\n  const manifest = await vault.loadManifest(manifestId, manifestJson);\n  if (!manifest) {\n    throw new Error(`Failed to load manifest from ${manifestId}`);\n  }\n\n  const pdfMetadata = { ...metadata };\n  if (!pdfMetadata.Title && manifest.label) {\n    pdfMetadata.Title = getI18nValue(\n      manifest.label,\n      languagePreference as string[],\n      '; '\n    );\n  }\n\n  const canvases = vault.get<CanvasNormalized>(\n    manifest.items.filter((c) => canvasPredicate(c.id))\n  );\n  const hasText = !!canvases.find((c) => !!getOcrReferences(c));\n  const labels = canvases.map((canvas) =>\n    canvas.label ? getI18nValue(canvas.label, languagePreference, '; ') : ''\n  );\n\n  // Initialize XML parsers\n  if (!saxParserWasm || !ocrParser.isInitialized()) {\n    if (!saxParserWasm) {\n      const wasm = await saxWasmLoader();\n      initializeSaxParser(wasm);\n    }\n    if (!ocrParser.isInitialized()) {\n      await ocrParser.initialize(() => Promise.resolve(saxParserWasm!));\n      ocrParser.setupLogging({\n        debug: log.debug.bind(log),\n        info: log.info.bind(log),\n        warn: log.warn.bind(log),\n        error: log.error.bind(log),\n      });\n    }\n  }\n\n  // Fetch images concurrently, within limits specified by user\n  log.debug(`Setting up queue with ${concurrency} concurrent canvas fetches.`);\n  const queue = new PQueue({ concurrency });\n  abortController.signal.addEventListener('abort', () => queue.clear(), {\n    once: true,\n  });\n  const canvasInfos = canvases.map(getCanvasInfo);\n  const canvasFuts = canvases.map((c, idx) => {\n    return queue.add(async () => {\n      const info = canvasInfos[idx];\n      const canvasData = await fetchCanvasData(c, info.images, {\n        scaleFactor,\n        ppiOverride: ppi,\n        abortSignal: abortController.signal,\n      });\n      // TODO: If downscaling was not possible due to lack of IIIF Image API support,\n      //       we should force an optimization pass with a lower resolution.\n      if (optimization) {\n        await Promise.all(\n          canvasData?.images.map(async (i) => {\n            const optimized = await optimizeImage({\n              imageData: new Uint8Array(i.data!),\n              imageFormat: i.format === 'jpeg' ? 'image/jpeg' : 'image/png',\n              ...optimization,\n            });\n            log.debug('main: Got optimized image', i.resource.id);\n            i.data = optimized.jpegData;\n            i.format = 'jpeg';\n          }) ?? []\n        );\n      }\n      return canvasData;\n    });\n  });\n\n  const outline = await buildOutlineFromRanges(\n    manifest,\n    canvases,\n    languagePreference as string[]\n  );\n  const pdfGen = new PDFGenerator({\n    writer: countingWriter,\n    metadata: pdfMetadata,\n    canvasInfos: canvases.map((c, idx) => ({\n      canvasIdx: idx,\n      ...canvasInfos[idx],\n    })),\n    langPref: languagePreference,\n    pageLabels: labels,\n    outline,\n    hasText,\n    initialCanvas: await fetchStartCanvasInfo(manifest),\n    readingDirection:\n      manifest.viewingDirection === 'right-to-left'\n        ? 'right-to-left'\n        : 'left-to-right',\n    manifestJson,\n    zipPolyglot: polyglotZipPdf,\n    zipBaseDir: polyglotZipBaseDir,\n  });\n  log.debug(`Initialising PDF generator.`);\n  await pdfGen.setup();\n  const progress = new ProgressTracker(\n    canvases,\n    countingWriter,\n    pdfGen,\n    onProgress,\n    onNotification\n  );\n  progress.emitProgress(0);\n\n  if (coverPageCallback || coverPageEndpoint) {\n    log.debug(`Generating cover page`);\n    progress.emitProgress(0, 'generate-cover-page');\n    try {\n      const coverPageData = await getCoverPagePdf(\n        manifest,\n        languagePreference as string[],\n        coverPageEndpoint,\n        coverPageCallback\n      );\n      log.debug('Inserting cover page into PDF');\n      await pdfGen.insertCoverPages(coverPageData);\n    } catch (err) {\n      log.error('Error while generating cover page', err);\n      abortController.abort();\n      throw err;\n    }\n  }\n\n  progress.emitProgress(0, 'generate-pages');\n  for (let canvasIdx = 0; canvasIdx < canvases.length; canvasIdx++) {\n    if (abortController.signal.aborted) {\n      log.debug('Abort signalled, aborting while waiting for image data.');\n      break;\n    }\n    try {\n      log.debug(`Waiting for data for canvas #${canvasIdx}`);\n      const canvasData = await canvasFuts[canvasIdx];\n      // This means the task was aborted, do nothing\n      // FIXME: Doesn't this also happen in case of an error?\n      if (!canvasData) {\n        throw 'Aborted';\n      }\n      const canvas = vault.get<CanvasNormalized>(canvasData.canvas);\n      const canvasInfo = canvasInfos[canvasIdx];\n      const { images, ppi, text, annotations, imageFailures } = canvasData;\n      if (imageFailures.length > 0) {\n        if (!report.failedImages) {\n          report.failedImages = [];\n        }\n        const reportData = {\n          canvasIndex: canvasIdx,\n          numFailed: imageFailures.length,\n          numTotal: images.length + imageFailures.length,\n          details: Object.fromEntries(\n            imageFailures.map((f) => [\n              f.resource.id ?? '<unknown>',\n              f.cause instanceof Error ? f.cause.toString() : f.cause,\n            ])\n          ),\n        };\n        report.failedImages.push(reportData);\n        progress.emitNotification({\n          code: 'image-download-failure',\n          ...reportData,\n        });\n      }\n      if (canvasInfo.ocr && !text?.markup) {\n        if (!report.failedOcr) {\n          report.failedOcr = [];\n        }\n        const reportData = {\n          canvasIndex: canvasIdx,\n          ocrUrl: canvasInfo.ocr.id,\n        };\n        report.failedOcr.push(reportData);\n        progress.emitNotification({\n          code: 'ocr-download-failure',\n          ...reportData,\n        });\n      }\n      const externalAnnotations = await fetchCanvasAnnotations(canvas.id);\n      if (externalAnnotations != null) {\n        const normalized = await Promise.all(\n          externalAnnotations.map((a) => {\n            if (!('id' in a)) {\n              a = convertPresentation2(a) as unknown as IIIF3Annotation;\n            }\n            return vault.load<AnnotationNormalized>(a.id, a);\n          })\n        );\n        if (normalized) {\n          normalized\n            .filter((a): a is AnnotationNormalized => a !== undefined)\n            .map((a) => parseAnnotation(a, languagePreference))\n            .filter((a): a is Annotation => a !== undefined)\n            .forEach((a) => annotations.push(a));\n        }\n      }\n      // eslint-disable-next-line @typescript-eslint/no-non-null-assertion\n      const stopMeasuring = metrics?.pageGenerationDuration.startTimer();\n      log.debug(`Rendering canvas #${canvasIdx} into PDF`);\n      await pdfGen.renderPage(\n        canvasData.canvas.id,\n        { width: canvas.width, height: canvas.height },\n        [...images, ...imageFailures],\n        annotations,\n        text,\n        ppi\n      );\n      stopMeasuring?.();\n      progress.updatePixels(\n        images.reduce((acc, img) => acc + img.width * img.height, 0),\n        canvas.width * canvas.height\n      );\n      report.numPages++;\n    } catch (err) {\n      // Clear queue, cancel all ongoing image fetching\n      if (err !== 'Aborted') {\n        log.error('Failed to render page', err);\n      }\n      queue.clear();\n      if (!abortController.signal.aborted) {\n        abortController.abort();\n      }\n      throw err;\n    } finally {\n      delete canvasFuts[canvasIdx];\n    }\n    progress.emitProgress(canvasIdx + 1);\n  }\n\n  // Finish writing PDF, resulting Promise is resolved once the writer is closed\n  log.debug('Finalizing PDF');\n  const endPromise = pdfGen.end();\n\n  // At this point the PDF data might still be incomplete, so we wait for\n  // drain events on the writer and continue updating our progress tracker\n  // until the writer is actually closed\n  if (!abortController.signal.aborted) {\n    let closed = false;\n    endPromise.then(() => (closed = true));\n    const progressOnDrain = async () => {\n      if (closed) {\n        return;\n      }\n      progress.emitProgress(canvases.length, 'finishing');\n      while (!closed && progress.writeOutstanding) {\n        await writer.waitForDrain();\n      }\n    };\n\n    // Wait for initial drainage event in case the writer isn't already closed\n    if (!closed) {\n      await writer.waitForDrain();\n      await progressOnDrain();\n    }\n  }\n\n  // Wait for the writer to be closed\n  log.debug('Waiting for writer to close.');\n  await endPromise;\n\n  report.fileSizeBytes = countingWriter.bytesWritten;\n  if (writer instanceof BlobWriter) {\n    return { ...report, data: writer.blob };\n  } else {\n    return report;\n  }\n}\n"],"names":["ConsoleLogger","level","__publicField","message","args","logger","setLogger","newLogger","E_CANCELED","__awaiter$2","thisArg","_arguments","P","generator","adopt","value","resolve","reject","fulfilled","step","e","rejected","result","Semaphore","_value","_cancelError","weight","callback","release","queue","entry","_a","queueEntry","previousValue","previousWeight","called","waiter","__awaiter$1","Mutex","cancelError","releaser","SaxEventType$1","Reader$1","data","ptr","Position$1","line","character","AttributeType","Reader","buffer","len","readU32","Text","name","type","readPosition","start","end","target","content","valueLen","readString","nameLen","numAttrs","attributes","i","attrLen","Attribute","numTextNodes","textNodes","textLen","openStart","openEnd","closeStart","closeEnd","selfClosing","SAXParser$1","events","options","event","uint8array","detail","SaxEventType","ProcInst","Tag","self","chunk","write","memory","saxWasm","parser","offset","length","SAXParser","uint8Array","Position","makeLine","spec","c","makeParagraph","l","out","idx","child","makeBlock","acc","makePage","SAX_WASM_VERSION","xmlParserWasm","initialize","loadSaxWasm","res","buf","isInitialized","getParser","readable","StaxParser","NUMERIC_ENTITY_REGEX","HEX_ENTITY_REGEX","ENTITY_MAP","ENTITY_REGEX","resolveXmlEntities","str","match","entity","entityCode","decimalCode","toReadableStream","encoder","controller","getAttributeValue","tag","attrName","attr","a","getAllAttributes","eventMask","wasm","reader","logWithPosition","msg","parseHocrAttribs","titleAttrib","x","val","key","parsePolygon","polyAttr","scaleFactor","last","y","handleChildren","eventIter","allowedTypes","ctx","openTags","evt","SaxEventType2","parentElem","txt","whitespaceOnly","hocrType","getHocrType","handleBlock","handleParagraph","handleLine","handleWord","handlePage","referenceSize","hocrAttribs","pageSize","determineScaleFactor","page","elem","w","ulx","uly","lrx","lry","dim","block","width","height","coords","paragraph","parsedAttribs","parts","slope","intercept","ulx2","uly2","word","wordText","wordChoices","tag2","t","nlp","choice","scaleFactorX","scaleFactorY","scaledWidth","scaledHeight","parseHocrPages","hocr","referenceSizes","sizeArr","_a2","pageIdx","NUMERIC_ATTRIBS","getAttributes","names","getCoordinates","attrs","handlePage2","dims","pageAttribs","SaxEventType3","handleBlock2","handleLine2","polygon","handleShape","handleWord2","points","p","lastElem","parent","text","wordConfidence","altText","handleSourceImageInformation","_tag","ident","location","parseAltoPages","alto","unit","saxParserWasm","now","isDefined","CRC_TABLE","k","crc32","runningInNode","initializeSaxParser","parserWasm","randomUUIDv4","metrics","prometheus","createStoreImpl","createState","state","listeners","setState","partial","replace","nextState","previousState","listener","getState","api","initialState","__vite_import_meta_env__","createStore","o","r","_","I","s","n","E","F","m","f","A","L","h","d","g","M","O","v","u","N","G","R","C","B","S","z","b","j","D","q","V","U","$","W","H","J","K","Q","X","Y","Z","ee","te","ne","ie","re","ae","se","oe","pe","fe","ce","le","he","ue","ve","de","T","ye","ge","me","Ce","Ae","Me","metaState","compatVault","nonRef","id","meta","oldValue","oldValueItem","newValue","resource","metaKey","resourceMeta","idToLoad","response","parseSpecificResource","createPaintingAnnotationsHelper","vault","getAllPaintingAnnotations","canvasOrId","canvas","annotationPages","flatAnnotations","getPaintables","paintingAnnotationsOrCanvas","enabledChoices","paintingAnnotations","types","choices","items","annotation","references","reference","ref","selector","body","nestedBodies","selected","cid","extractChoices","Fe","$e","Se","Re","Ke","Be","createAction","base","payload","IMPORT_ENTITIES","MODIFY_ENTITY_FIELD","REORDER_ENTITY_FIELD","ADD_REFERENCE","UPDATE_REFERENCE","REMOVE_REFERENCE","ADD_METADATA","REMOVE_METADATA","UPDATE_METADATA","REORDER_METADATA","importEntities","modifyEntityField","reorderEntityField","addReference","removeReference","updateReference","addMetadata","updateMetadata","removeMetadata","reorderMetadata","entityActions","ADD_MAPPING","ADD_MAPPINGS","addMapping","addMappings","RESOURCE_ERROR","RESOURCE_LOADING","RESOURCE_READY","REQUEST_RESOURCE","REQUEST_ERROR","REQUEST_MISMATCH","REQUEST_COMPLETE","REQUEST_OFFLINE_RESOURCE","requestResource","requestError","requestMismatch","requestComplete","BATCH_ACTIONS","BATCH_IMPORT","batchActions","actionListFromResource","entities","mapping","normalize","actions","safeIsNaN","isEqual","first","second","areInputsEqual","newInputs","lastInputs","resolveIfExists","url","request","resourceType","fullEntity","HAS_PART","framing","PART_OF","frameResource","isPromise","createFetchHelper","fetcher","waitTimeout","store","resolvedEntity","cleanupSubscription","didContinue","latestState","maybeResolvedEntity","importResource","toDispatch","resourceOrPromise","err","SET_META_VALUE","SET_META_VALUE_DYNAMIC","UNSET_META_VALUE","setMetaValue","setMetaValueDynamic","unsetMetaValue","metaActions","getDefaultEntities","reduxImpl","reducer","initial","set","_get","action","redux","trackedConnections","getTrackedConnectionState","api2","extractConnectionInformation","extensionConnector","existingConnection","newConnection","devtoolsImpl","fn","devtoolsOptions","get","enabled","anonymousActionType","connection","connectionInformation","isRecording","nameOrAction","setStateFromDevtools","originalIsRecording","store2","didWarnAboutReservedActionType","originalDispatch","parseJsonThen","stateFromDevtools","nextLiftedState","lastComputedState","devtools","stringified","parsed","subscribeWithSelectorImpl","origSubscribe","optListener","equalityFn","currentSlice","nextSlice","previousSlice","subscribeWithSelector","mappingReducer","isReferenceList","quickMerge","newResource","added","bValue","numberOr","entitiesReducer","updateField","values","removed","keys","toReturn","newEntities","changed","ids","indexToRemove","metadata","actionPayload","requestReducer","metaReducer","updateValue","combineReducers","reducers2","reducerKeys","hasChanged","createBatchReducer","rootReducer","reducers","getDefaultState","createStore2","enableDevtools","iiifStoreName","defaultState","customReducers","dv","mitt_default","n2","__create","__defProp","__getOwnPropDesc","__getOwnPropNames","__getProtoOf","__hasOwnProp","__defNormalProp","obj","__commonJS","cb","mod","__copyProps","to","from","except","desc","__toESM","isNodeMode","defineProperty","prototype","enumerable","DEFINED","cache","REFS","object","wrapObject","REACTIVE","unwrapObject","PARENT","createPrototype","reactive","refOrObject","fresh","parent2","that","subscription","skipInitial","isWrapped","newObject","wrapped","resolveType","Vault","json","realAction","state2","handler","config","serialize","serializeConfigPresentation2","serializeConfigPresentation3","skipSelfReturn","isSpecificResource","_type2","_type","_id","found","input","prev","next","fn2","newInput","otherOptions","objectType","newValueOrUpdate","getGlobal","globalVault","gv","newVault","getClosestLanguage","i18nLanguage","languages","i18nLanguages","strictFallback","skipLanguages","root","lang","inverseIdx","root2","inverseIdx2","buildLocaleString","inputText","defaultText","separator","fallbackLanguages","closest","language","candidateText","skip","Qe","hi","Si","zi","Pi","Oi","Wi","getImageServerFromId","sampledTilesToTiles","sampledTiles","maxDim","newTiles","tile","lastSize","curWidth","scaleFactors","getImageFromTileSource","image","targetWidth","targetHeight","req","createImageServiceRequest","canonicalServiceUrl","getId","imageServiceRequestToString","isBestMatch","current","candidate","pickBestFromCandidates","inputRequest","candidates","log","explain","indent","lastResorts","fallback","currentChoice","swapChoice","candidateGroups","group","candidatesLength","isImage3","service","getFixedSizesFromService","isImageService","size","getId2","getImageServiceLevel","getCustomSizeFromService","supportsCustomSizes","imagesSizes","profiles","pLen","profile","getId3","getImageServiceLevel2","getImageCandidatesFromService","totalServices","single","fixedSizes","customSizes","inferImageSizeFromUrl","regex","region","format","getFixedSizeFromImage","contentResource","getType","getId4","getImageCandidates","unknownResource","dereference","loader","fixedSizeFromImage","refCandidates","imageServices2","getImageServices","getId5","externalService","imageSizesMatch","sizesA","sizesB","matchOrder","matching","ImageServiceLoader","imageServiceRequest","preLoaded","server","getId6","serviceUrl","canonicalServiceUrl2","existing","isLevel0","extractFixedSizeScales","forceVerify","verify","force","source","serverId","imageServer","fixedSizesFromScales","otherCandidates","getImageServices2","prediction","imageService","isValid","serviceId","canonical","forceFresh","service2","init","running","serviceJson","createImageServiceStore","backgroundRequest","getId7","loaded","error","imageServiceLoader","createThumbnailHelper","dependencies","getBestThumbnailAtSize","dimensions","thumbnailNotFound","fixed","fullInput","thumbnail","potentialThumbnails","contentResources","firstContentResources","firstManifest","firstCanvas","require_parse_svg_path","exports","module","parse","segment","path","command","parseValues","number","numbers","require_abs_svg_path","absolutize","startX","startY","seg","_slicedToArray","sliceIterator","arr","_arr","_n","_d","_e","_i","_s","TAU","mapToEllipse","_ref","rx","ry","cosphi","sinphi","centerx","centery","xp","yp","approxUnitArc","ang1","ang2","x1","y1","x2","y2","vectorAngle","ux","uy","vx","vy","sign","dot","getArcCenter","px","py","cx","cy","largeArcFlag","sweepFlag","pxp","pyp","rxsq","rysq","pxpsq","pypsq","radicant","centerxp","centeryp","vx1","vy1","vx2","vy2","arcToBezier","_ref2","_ref2$xAxisRotation","xAxisRotation","_ref2$largeArcFlag","_ref2$sweepFlag","curves","lambda","_getArcCenter","_getArcCenter2","ratio","segments","curve","_mapToEllipse","_mapToEllipse2","_mapToEllipse3","modules_default","import_parse_svg_path","import_abs_svg_path","parseAndNormalizeSvgPath","absolute","prevCmd","bezierX","bezierY","quadX","quadY","cmd","flattenQuadraticBezier","control","tolerance","QuadraticBezier","flattenCubicBezier","startControl","endControl","CubicBezier","hypot2","approx_myint","approx_inv_myint","mt","x0","y0","ddx","ddy","u0","u2","cross","paramX0","paramX2","scale","params","a0","a2","count","tValues","_CubicBezier","c0","c1","c2","c3","p1","t0","t1","p0","p3","d1","d2","tol","tol1","tol2","sqrt_tol2","err2","n_quads","quads","sum","i2","quad","val2","xmin","cusp_val","BOX_SELECTOR","TEMPORAL_SELECTOR","RGBA_COLOR","parseSelector","domParser","svgPreprocessor","iiifRenderingHints","resolveHints","nextSource","selectors","newIiifRenderingHints","fragment","isImageApiSelector","parsedRegion","matchBoxSelector","matchBoxTimeSelector","matchTimeSelector","rect","style","svg","svgShape","svgElement","selectorElem","getSelectorElement","extractStyles","sel","getShapeTypeFromPath","svgPath","cmdFrequencies","cmdTypes","lastSeg","svgElem","element","normalized","pathToPoints","angle","rad","ps","shapeType","normalizedPath","startPoint","selectorElement","rgbaMatch","rootElem","supported","parsedRotation","parseRotation","num","expandTarget","Le","Oe","Pe","We","je","Te","Ne","ke","Ge","xe","Ie","we","ze","be","Ee","PURPOSE_ORDER","PURPOSE_LABELS","getI18nValue","languagePreference","splitAfter","localized","ImageServiceLoader_","fetchRespectfully","thumbHelper","getThumbnail","manifest","maxDimension","isExternalWebResourceWithProfile","isPhysicalDimensionService","supportsScaling","getCanvasAnnotations","parseAnnotation","getCanvasInfo","imageInfos","getImageInfos","getOcrReferences","agentToString","agent","creatorToString","creator","anno","langPrefs","annoBody","bodyRef","creatorNames","modifiedDates","targets","markup","buildAnnotationMarkup","bodies","purpose","purposeLabel","part","parseTarget","targetStr","canvasId","getImageFormat","_b","_c","paintingAnnos","ap","annoTarget","choiceItem","parseOcr","ocrText","pageIter","isAlto","isHocr","fetchOcrMarkup","resp","refs","fetchAndParseText","annotations","ocrRefs","stopMeasuring","rateLimitRegistry","FALLBACK_PPI","MANIFEST_ACCEPT_HEADER","RateLimitingRegistry","host","mutex","ticket","includedCredentialsHosts","maxRetries","rateLimitMutex","numRetries","waitMs","fetchOptions","retryAfter","getHeaderValue","ietfHeader","header","limit","remaining","reset","secsPerQuotaUnit","getImageSize","imgService","sizeStr","isIIIFv3","maxWidth","requestedWidth","aspectRatio","supportsScaleByWh","fullArea","getPointsPerInch","services","physDimService","physicalScale","physicalUnits","ppi","isImageFetchFailure","fetchCanvasImage","abortSignal","sizeOnly","imageUrl","downscaled","fetchFullImageService","sizeInfo","numBytes","corsAvailable","imgResp","isImageUnavailableDueToCors","imgElem","fetchStartCanvasInfo","startRef","selectorStr","fragSel","selX","selY","selWidth","selHeight","fetchCanvasData","ppiOverride","imagePromises","results","canvasImages","imgInfo","failures","fetchManifestJson","manifestUrl","serviceRef","has","prefix","Events","EE","context","once","addListener","emitter","clearEvent","EventEmitter","handlers","a1","a3","a4","a5","TimeoutError","getDOMException","errorMessage","AbortError","getAbortedReason","signal","reason","pTimeout","promise","milliseconds","timer","cancelablePromise","timeoutError","lowerBound","array","comparator","it","__classPrivateFieldGet","receiver","kind","_PriorityQueue_queue","PriorityQueue","run","index","item","__classPrivateFieldSet","_PQueue_instances","_PQueue_carryoverConcurrencyCount","_PQueue_isIntervalIgnored","_PQueue_intervalCount","_PQueue_intervalCap","_PQueue_interval","_PQueue_intervalEnd","_PQueue_intervalId","_PQueue_timeoutId","_PQueue_queue","_PQueue_queueClass","_PQueue_pending","_PQueue_concurrency","_PQueue_isPaused","_PQueue_throwOnTimeout","_PQueue_doesIntervalAllowAnother_get","_PQueue_doesConcurrentAllowAnother_get","_PQueue_next","_PQueue_onResumeInterval","_PQueue_isIntervalPaused_get","_PQueue_tryToStartAnother","_PQueue_initializeIntervalIfNeeded","_PQueue_onInterval","_PQueue_processQueue","_PQueue_throwOnAbort","_PQueue_onEvent","PQueue","newConcurrency","function_","operation","functions","delay","canInitializeInterval","job","_resolve","filter","lib","templateStrings","matches","strings","pattern","string","u8","u16","i32","fleb","fdeb","clim","freb","eb","fl","revfl","fd","revfd","rev","hMap","cd","mb","co","rvb","sv","r_1","flt","fdt","flm","flrm","fdm","fdrm","max","bits","bits16","shft","slc","ec","ind","nt","inflt","dat","st","dict","sl","dl","noBuf","resize","noSt","cbuf","bl","nbuf","final","pos","bt","lm","dm","lbt","dbt","tbts","hLit","hcLen","tl","ldt","clt","clb","clbmsk","clm","lt","dt","lms","dms","lpos","sym","add","dsym","shift","dend","wbits","wbits16","hTree","t2","et","i0","i1","maxSym","tr","mbt","ln","lft","cst","i2_1","i2_2","i2_3","lc","cl","cli","cln","cls","clen","cf","wfblk","wblk","syms","lf","df","li","bs","dlt","mlb","ddt","mdb","lclt","nlc","lcdt","ndc","lcfreq","lct","mlcb","nlcc","flen","ftlen","dtlen","ll","llm","lcts","clct","dst","deo","dflt","lvl","plvl","pre","post","lst","opt","msk_1","head","bs1_1","bs2_1","hsh","lc_1","wi","hv","imod","pimod","rem","ch_1","dif","maxn","maxd","ml","nl","mmd","md","ti","pti","lin","din","adler","dopt","newDat","wbytes","zlh","lv","zls","zlibSync","opts","unzlibSync","td","tds","textEncoder","textDecoder","util","cryptoImpl","nodeCrypto","IS_BIG_ENDIAN","view","randomData","u32View","tryDeflateStream","pdfStream","compressed","zlib","bytes","compStream","PDF_INDENTATION","PdfRef","makeRef","isUnicode","toUTF16BE","includeBom","outBuf","safeNumber","dictIndent","outsideIndent","insideIndent","CountingWriter","writer","WebWriter","stream","BlobWriter","NodeWriter","writable","waitForDrain","ArrayReader","position","sub","_PNG","retVal","pixels","imageData","colors","palette","alpha","pixelBytes","scanlineLength","pass","dx","dy","singlePass","row","byte","left","col","pixelsIdx","upper","upperLeft","upperIdx","upperLeftIdx","pa","pb","pc","paeth","pixelsPos","bufferPos","b1","b2","b3","b4","transparency","temp","imgDataBuff","chunkSize","section","colorTypeMap","PNG","readUint16BE","PdfImage","JPEGImage","PNGImage","_JPEGImage","marker","channels","startNum","label","dataDecoded","hasAlphaChannel","isInterlaced","nextNum","imgObj","imgDict","paletteObj","rgb","mask","alphaChannelObj","objNum","colorCount","pixelCount","imgData","alphaChannel","skipByteCount","colorIndex","alphaChannelDeflated","predicate","ESCAPE_CHARS","parseCrossRefSection","testForString","trailerIdx","_x","currentSection","entryParts","numObjs","trailerBuf","trailerStartIdx","trailerEndIdx","trailerDict","PdfValueParser","previousXrefOffset","backwards","isDigit","isHex","resetAfter","chr","isInt","chars","intStr","matchNumber","matchWhitespace","doesMatch","isRealNumber","digitSeen","separatorSeen","skipped","vals","openParens","cs","PdfParser","objOffsets","objGenerations","bufStart","eofIdx","startXrefPos","xrefStartOffset","dictEnd","dictStart","entries","gen","inUse","pagesObj","pageRef","pageDict","pagesRef","pagesRoot","pagesDict","annots","annoRef","withStream","nextOffset","objEndIdx","streamIdx","objSig","streamLength","pdiiifVersion","buildLocalZipHeader","creationDate","filename","compressedData","extraDataLength","creationTimeZip","creationDateZip","dataCrc","filenameEncoded","compressedLength","buildCentralFileDirectory","files","trailingLength","chunks","buildCentralDirectoryFileHeader","cdSize","curr","colorName","isArrayish","require$$0","concat","slice","swizzle","simpleSwizzleModule","arg","colorNames","require$$1","hasOwnProperty","reverseNames","colorStringModule","model","abbr","hex","rgba","per","keyword","hexAlpha","clamp","hsl","hwb","hexDouble","hsla","hwba","min","cssKeywords","reverseKeywords","convert","conversions","labels","delta","rdif","gdif","bdif","diff","diffc","comparativeDistance","reversed","currentClosestDistance","currentClosestKeyword","distance","xyz","t3","smin","lmin","hsv","vmin","wh","cmyk","lab","z2","lch","hr","saturation","ansi","color","mult","colorString","char","integer","chroma","grayscale","hue","hcg","pure","mg","apple","gray","buildGraph","graph","models","deriveBFS","fromModel","adjacents","adjacent","node","link","wrapConversion","toModel","cur","route","conversion","wrapRaw","wrappedFn","arg0","wrapRounded","routes","colorConvert","skippedModels","hashedModelKeys","limiters","Color","newArray","zeroArray","hashedKeys","places","roundToPlace","getset","maxfn","rgbArray","alphaHex","lum","chan","color2","lum1","lum2","contrastRatio","degrees","mixinColor","color1","w1","w2","assertArray","roundTo","channel","modifier","eventAggregator","env","CSS_LENGTH_PAT","htmlToPlainText","html","ev","toPdfRect","pageHeight","unitScale","lly","ury","cssColorToRgb","cssColor","cssLengthToPdfUserspace","cssLength","referenceDimensionPx","selectorStyleToPdf","pdfStyle","selectorToPdf","styleDict","point","svgSel","exportPdfAnnotation","annoDict","PRODUCER","CHAR_WIDTH","FONTDATA","PDFGenerator","canvasInfos","langPref","pageLabels","outline","readingDirection","hasText","initialCanvas","manifestJson","zipPolyglot","zipBaseDir","pdfMetadata","catalog","outlines","outlinesObj","itm","childObj","numKids","typeZeroFont","typeTwoFont","cidtoGidMapData","comp","cidToGidMap","cmapStream","dedent","cmap","fontDesc","maybeCompressedFont","fontDataObj","embeddedFiles","fileObjNum","nameTree","dest","destCanvasIdx","ci","rec","numChildren","refName","isObject","seenObjects","handleValue","objDict","newObj","pdfData","newPageRef","description","mimeType","fileSpec","maybeCompressed","embeddedFile","zipData","manifestMime","manifestProfile","initiallyEnabledOCGs","initiallyDisabledOCGs","allOCGs","rbGroups","canvasIdx","images","ocgStart","ocgIdx","rbGroup","img","canvasWidth","canvasHeight","contentOps","optionalGroupIds","choiceInfo","drawWidth","drawHeight","drawX","drawY","imageId","ocId","contentStreamComp","contentsObj","pageResources","xObjects","properties","ocgId","imgIdx","imageObjs","mainImageObj","imgPreambleSize","canvasInfo","pdfAnno","ocr","ops","pageObjNum","lineIdx","handleChild","grandchild","fontRef","fontSize","xPos","lineY","yPos","xOld","yOld","wordX","wordY","wordWidth","wordHeight","wordLength","pdfWordLen","textBytes","numAnnotations","numObjects","untilStreamStart","parentRoot","parentRootRef","pageParents","rootRef","visitEntry","parentRef","objRef","parents","mcId","pidx","xrefEntries","xRefTable","off","free","xrefOffset","trailer","endObj","deflatedData","bytesUntilActualData","zipObjOffset","zipObj","localHeaderOffset","licenses","getLicenseInfo","uri","WorkerPool","worker","OptimizationWorker","availableWorker","optimError","pool","startWorkerPool","wasmLoader","mozjpegWasm","promises","optimizeImage","getCanvasesForSampling","canvases","numSamples","meanPixels","candidateCanvases","sampleCanvases","estimatePdfSize","inputManifest","concurrency","filterCanvases","optimization","saxWasmLoader","ocrParser.SAX_WASM_VERSION","mozjpegWasmLoader","manifestId","canvasPredicate","totalCanvasPixels","samplePixels","ocrParser.isInitialized","ocrParser.initialize","ocrParser.setupLogging","canvasData","info","optimizationResult","originalSize","optimized","corsSupported","sampleBytes","sampleImage","buildOutlineFromRanges","canvasIds","isCanvas","ri","isRange","seenRanges","handleTocRange","range","rangeLabel","childRanges","children","startCanvas","tocRanges","topRange","ProgressTracker","countingStream","pdfGen","onProgress","onNotification","pagesWritten","messageCode","bytesPushed","estimatedFileSize","bytesWritten","writeSpeed","remainingDuration","notification","pixelsWritten","canvasPixels","getCoverPagePdf","endpoint","thumbUrl","manifestThumb","provider","required","_f","license","licenseDef","_g","convertManifest","outputStream","fetchCanvasAnnotations","abortController","coverPageCallback","coverPageEndpoint","polyglotZipPdf","polyglotZipBaseDir","countingWriter","report","canvasFuts","progress","coverPageData","imageFailures","reportData","externalAnnotations","convertPresentation2","endPromise","closed","progressOnDrain"],"mappings":"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EAAI;AAAA,EAAI;AAAA,EAAI;AAAA,EAAI;AAAA,EAAI;AAAA,EAAI;AAAA,EAAK;AAAA,EAAK;AAAA,EAAK;AAAA,EAC3E;AAAA,EAAG;AAAA,EAAG;AAAA,EAAI;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAI;AAAA,EAAI;AAAA,EAAK;AAAA,EAAI;AAAA,EAAK;AAAA,EAAG;AAAA,EAAI;AAAA,EAAG;AAAA,EAAI;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAK;AAAA,EAAG;AAAA,EAAG;AAAA,EAC3E;AAAA,EAAI;AAAA,EAAK;AAAA,EAAK;AAAA,EAAK;AAAA,EAAK;AAAA,EAAI;AAAA,EAAI;AAAA,EAAI;AAAA,EAAI;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAK;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAI;AAAA,EAAK;AAAA,EACxE;AAAA,EAAI;AAAA,EAAK;AAAA,EAAI;AAAA,EAAK;AAAA,EAAK;AAAA,EAAK;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAK;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAI;AAAA,EAAK;AAAA,EAAK;AAAA,EAAK;AAAA,EAAI;AAAA,EAC1E;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAK;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAI;AAAA,EAAK;AAAA,EAAK;AAAA,EAAK;AAAA,EAAK;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAC1E;AAAA,EAAK;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAK;AAAA,EAAK;AAAA,EAAI;AAAA,EAAI;AAAA,EAAG;AAAA,EAAI;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAK;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAC1E;AAAA,EAAI;AAAA,EAAK;AAAA,EAAK;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAI;AAAA,EAAK;AAAA,EAAI;AAAA,EAAK;AAAA,EAAK;AAAA,EACtE;AAAA,EAAK;AAAA,EAAI;AAAA,EAAK;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAK;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAI;AAAA,EAAK;AAAA,EAAK;AAAA,EAAK;AAAA,EAAK;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAC5E;AAAA,EAAG;AAAA,EAAI;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAI;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAK;AAAA,EAAK;AAAA,EAAK;AAAA,EAAI;AAAA,EAAI;AAAA,EAAI;AAAA,EACvE;AAAA,EAAK;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAK;AAAA,EAAK;AAAA,EAAK;AAAA,EAAK;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAK;AAAA,EAAK;AAAA,EACvE;AAAA,EAAK;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAI;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAC3E;AAAA,EAAG;AAAA,EAAG;AAAA,EAAK;AAAA,EAAK;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAC5E;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAC3E;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAK;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAC1E;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAC3E;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAI;AAAA,EAAI;AAAA,EAAI;AAAA,EAAI;AAAA,EAC5E;AAAA,EAAI;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAK;AAAA,EAAK;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAK;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAC5E;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAC3E;AAAA,EAAG;AAAA,EAAG;AAAA,EAAI;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAI;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAI;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAC3E;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAI;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAI;AAAA,EAAI;AAAA,EAAI;AAAA,EACzE;AAAA,EAAG;AAAA,EAAG;AAAA,EAAK;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAI;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAI;AAAA,EAAG;AAAA,EAAG;AAAA,EAC5E;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAI;AAAA,EAAG;AAAA,EAAI;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAI;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAC3E;AAAA,EAAG;AAAA,EAAK;AAAA,EAAG;AAAA,EAAK;AAAA,EAAG;AAAA,EAAK;AAAA,EAAG;AAAA,EAAK;AAAA,EAAG;AAAA,EAAK;AAAA,EAAG;AAAA,EAAK;AAAA,EAAG;AAAA,EAAI;AAAA,EAAG;AAAA,EAAI;AAAA,EAAG;AAAA,EAAI;AAAA,EAAG;AAAA,EACxE;AAAA,EAAI;AAAA,EAAK;AAAA,EAAK;AAAA,EAAK;AAAA,EAAK;AAAA,EAAK;AAAA,EAAK;AAAA,EAAI;AAAA,EAAI;AAAA,EAAI;AAAA,EAAI;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAC1E;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AACvE,CAAC;AAuDD,MAAqBC,GAAa;AAAA;AAAA;AAAA,EAiDhC,YAAY;AAAA,IACV,QAAA1S;AAAA,IACA,UAAAv1B;AAAA,IACA,aAAAkoC;AAAA,IACA,UAAAC;AAAA,IACA,YAAAC;AAAA,IACA,SAAAC,IAAU,CAAC;AAAA,IACX,kBAAAC,IAAmB;AAAA,IACnB,SAAAC,IAAU;AAAA,IACV,eAAAC;AAAA,IACA,cAAAC;AAAA,IACA,aAAAC,IAAc;AAAA,IACd,YAAAC;AAAA,EAAA,GACkB;AA5DpB;AAAA,IAAAhpD,EAAA,iBAAU;AAEV;AAAA,IAAAA,EAAA,kBAA6B,CAAC;AAE9B;AAAA,IAAAA,EAAA,oBAAa;AAEb;AAAA,IAAAA,EAAA,kBAAmC,CAAC;AAEpC;AAAA,IAAAA,EAAA,kBAAqB,CAAC;AAEtB;AAAA,IAAAA,EAAA;AAEA;AAAA,IAAAA,EAAA,uBAAgB;AAEhB;AAAA,IAAAA,EAAA,sBAAkC,CAAC;AAEnC;AAAA,IAAAA,EAAA;AAEA;AAAA,IAAAA,EAAA;AAEA;AAAA,IAAAA,EAAA,wBAAiB;AAEjB;AAAA,IAAAA,EAAA,kBAAsB,CAAC;AAEvB;AAAA,IAAAA,EAAA,kBAAW;AAEX;AAAA,IAAAA,EAAA,oBAAgC,CAAC;AAGjC;AAAA;AAAA,IAAAA,EAAA,wCAA6C,IAAI;AAEjD;AAAA,IAAAA,EAAA,6BAAsB;AAEtB;AAAA,IAAAA,EAAA,4CAA0C,IAAI;AAE9C;AAAA,IAAAA,EAAA;AACA,IAAAA,EAAA;AACQ,IAAAA,EAAA;AACA,IAAAA,EAAA;AACA,IAAAA,EAAA;AACA,IAAAA,EAAA;AACA,IAAAA,EAAA;AAEA;AAAA,IAAAA,EAAA,iDAA0B,IAAoB;AAkBpD,SAAK,UAAU41C,GACf,KAAK,eAAe2S,GACpB,KAAK,cAAcE,GACnB,KAAK,WAAWC,GAChB,KAAK,WAAWE,GAChB,KAAK,oBAAoBD,GACzB,KAAK,YAAYH,GACjB,KAAK,iBAAiBK,GACtB,KAAK,YAAYE,GACjB,KAAK,cAAcC,GACnB,KAAK,gBAAgBF;AAErB,UAAMG,IAA6B;AAAA,MACjC,GAAG,OAAO,QAAQ5oC,CAAQ,EACvB,OAAO,CAACtR,GAAGwC,MAAMA,MAAM,MAAS,EAChC,OAAO,CAAC4T,GAAM,CAACpW,GAAGwC,CAAC,OACb4T,EAAApW,CAAC,IAAI,IAAIwC,CAAC,KACR4T,IACN,EAAmB;AAAA,MACxB,UAAU,IAAIgjC,EAAQ;AAAA,IACxB;AACK,SAAA,WAAWc,GAAa,MAAM;AAAA,EAAA;AAAA;AAAA,EAIrC,MAAM,QAAuB;AAE3B,UAAMC,IAAyB;AAAA,MAC7B,MAAM;AAAA,IACR;AACK,SAAA,WAAWA,GAAS,SAAS;AAGlC,UAAM7L,IAAW,KAAK;AAAA,MACpB;AAAA,QACE,MAAM;AAAA,QACN,OAAO,KAAK,aAAa;AAAA,MAC3B;AAAA,MACA;AAAA,IACF;AAWI,QAVI6L,EAAA,QAAQhU,EAAQmI,CAAQ,GAG5B,KAAK,aACP6L,EAAQ,WAAW;AAAA,MACjB,MAAM;AAAA,MACN,QAAQ;AAAA,IACV,IAGE,KAAK,SAAS,SAAS,GAAG;AAG5B,MAAAA,EAAQ,WAAW;AACnB,YAAMC,IAA0B;AAAA,QAC9B,MAAM;AAAA,QACN,OAAO;AAAA,MACT,GACMC,IAAc,KAAK,WAAWD,CAAQ;AACpC,MAAAD,EAAA,WAAWhU,EAAQkU,CAAW;AAClC,UAAAjkC;AACJ,iBAAW,CAAC9e,GAAKgjD,CAAG,KAAK,KAAK,SAAS,WAAW;AAC1C,cAAA,CAACC,GAAUC,CAAO,IAAI,KAAK,YAAYF,GAAKD,GAAajkC,CAAI;AAClE,QAAAgkC,EAAS,SAAoB,IAAII,GAC9BljD,MAAQ,IACD8iD,EAAA,QAAQjU,EAAQoU,CAAQ,IACxBjjD,MAAQ,KAAK,SAAS,SAAS,MAC/B8iD,EAAA,OAAOjU,EAAQoU,CAAQ,IAE3BnkC,IAAAmkC;AAAA,MAAA;AAAA,IACT;AAGA,MAAAJ,EAAQ,WAAW;AAIrB,IAAAA,EAAQ,oBAAoB;AAAA,MAC1B,WAAW,KAAK,sBAAsB,kBAAkB,SAAS;AAAA,IACnE,GAEI,KAAK,YACP,MAAM,KAAK,qBAAqB;AAAA,EAClC;AAAA;AAAA,EAIF,MAAM,uBAAsC;AAC1C,UAAMM,IAAe,KAAK;AAAA,MACxB;AAAA,QACE,MAAM;AAAA,QACN,SAAS;AAAA,QACT,UAAU;AAAA,QACV,UAAU;AAAA,MACZ;AAAA,MACA;AAAA,IACF,GAEMC,IAAc,KAAK,WAAW;AAAA,MAClC,MAAM;AAAA,MACN,SAAS;AAAA,MACT,UAAU;AAAA,MACV,IAAI,MAAOrB;AAAA,MACX,eAAe;AAAA,QACb,UAAU;AAAA,QACV,UAAU;AAAA,QACV,YAAY;AAAA,MAAA;AAAA,IACd,CACD;AACA,IAAAoB,EAAa,KAAuB,kBAAkB;AAAA,MACrDtU,EAAQuU,CAAW;AAAA,IACrB;AAGA,UAAMC,IAAkB,IAAI,WAAW,MAAM,IAAI;AACjD,aAAS1lD,IAAI,GAAGA,IAAI0lD,EAAgB,QAAQ1lD;AAC1C,MAAA0lD,EAAgB1lD,CAAC,IAAIA,IAAI,IAAI,IAAI;AAE7B,UAAA2lD,IAAO,MAAMjV,GAAiBgV,CAAe,GAC7CE,IAAc,KAAK,WAAWD,EAAK,MAAM,QAAWA,EAAK,MAAM;AACpE,IAAAF,EAAY,KAAuB,cAAcvU,EAAQ0U,CAAW;AAKrE,UAAMC,IAAaC;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,UAsBbC,IAAO,KAAK;AAAA,MAChB;AAAA,QACE,QAAQF,EAAW;AAAA,MACrB;AAAA,MACA;AAAA,MACAA;AAAA,IACF;AACC,IAAAL,EAAa,KAAuB,YAAYtU,EAAQ6U,CAAI;AAGvD,UAAAC,IAAW,KAAK,WAAW;AAAA,MAC/B,MAAM;AAAA,MACN,UAAU;AAAA,MACV,UAAU,CAAC,GAAG,GAAG,MAAO5B,IAAY,GAAI;AAAA,MACxC,QAAQ;AAAA,MACR,WAAW;AAAA,MACX,SAAS;AAAA,MACT,OAAO;AAAA,MACP,aAAa;AAAA,MACb,OAAO;AAAA,IAAA,CACR;AACA,IAAAqB,EAAY,KAAuB,iBAAiBvU,EAAQ8U,CAAQ;AAE/D,UAAAC,IAAsB,MAAMvV,GAAiB2T,EAAQ,GACrD6B,IAAc,KAAK;AAAA,MACvB;AAAA,QACE,SAAS7B,GAAS;AAAA,QAClB,GAAG4B,EAAoB;AAAA,MACzB;AAAA,MACA;AAAA,MACAA,EAAoB;AAAA,IACtB;AACC,IAAAD,EAAS,KAAuB,YAAY9U,EAAQgV,CAAW;AAAA,EAAA;AAAA;AAAA,EAIlE,kCAAkC;AAChC,UAAMhB,IAAU,KAAK,SAAS,KAAK,SAAS,QAAQ,MAAM,EACvD,MACGiB,IAA0B;AAAA,MAC9B;AAAA,MACAjV,EAAQ,KAAK,uBAAwB,KAAK,YAAY,IAAI,EAAE;AAAA,IAC9D;AACA,eAAW,CAAC7uC,GAAKmP,CAAM,KAAK,KAAK,aAAa,WAAW;AACnD,UAAA,CAACA,EAAO;AACV;AAIF,UAAI40C,IAFe,KAAK,sBAAsB/jD,CAAG,IAEnB,KAAK,oBAAoBA,CAAG,IAAI;AAC9D,MAAI,KAAK,cAEO+jD,KAAA,IAEhBD,EAAc,KAAK,IAAI30C,EAAO,IAAI,EAAE,GAAG,GACzB20C,EAAA,KAAKjV,EAAQkV,CAAU,CAAC;AAAA,IAAA;AAEpC,QAAA,CAAClB,EAAQ;AACX,MAAAA,EAAQ,QAAQ;AAAA,QACd,eAAe,EAAE,OAAOiB,EAAc;AAAA,MACxC;AAAA,SACK;AAEL,YAAME,IADQnB,EAAQ,MACC;AACvB,MAAAmB,EAAS,QAASA,EAAS,MAAmB,OAAOF,CAAa;AAAA,IAAA;AAAA,EACpE;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAYF,uBAAuBnhD,GAAqB;AAC1C,QAAI,CAAC,KAAK,oBAAoB,IAAIA,CAAG,GAAG;AAEhC,YAAAqN,IAAM6+B,EAAQ,EAAE;AACjB,WAAA,oBAAoB,IAAIlsC,GAAKqN,CAAG;AAAA,IAAA;AAEhC,WAAA,KAAK,oBAAoB,IAAIrN,CAAG;AAAA,EAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAWzC,YACEqgD,GACAr7C,GACAmX,GACqB;;AACjB,QAAAmlC;AACA,QAAA,OAAOjB,EAAI,eAAgB,UAAU;AAEjC,YAAAkB,IAAgB,KAAK,aAAa;AAAA,QACtC,CAACC,MAAOA,EAAG,OAAO,OAAOnB,EAAI;AAAA,MAC/B;AACA,UAAIkB,IAAgB;AACZ,cAAA;AAAA,UACJ,iCAAiClB,EAAI,WAAW;AAAA,QAClD;AAEK,MAAAiB,IAAA,CAACC,GAAe,MAAM;AAAA,IAAA,OACxB;AAEC,YAAArrB,IAAWmqB,EAAI,YAAY,IAC3BlC,IAAY,KAAKkC,EAAI,YAAY,KACjC1vB,IAAO0vB,EAAI,YAAY,UACvB,EAAE,OAAAj+C,GAAO,QAAAC,EAAO,IAAIg+C,EAAI,YAAY,YACpCkB,IAAgB,KAAK,aAAa;AAAA,QACtC,CAACC,MAAOA,EAAG,OAAO,OAAOtrB;AAAA,MAC3B;AACA,UAAIqrB,IAAgB;AACZ,cAAA,MAAM,iCAAiCrrB,CAAQ,eAAe;AAE/D,MAAAorB,IAAA;AAAA,QACLC;AAAA,QACA;AAAA;AAAA,QAEApD,IAAYxtB,EAAK;AAAA;AAAA,QACjBwtB,IAAYxtB,EAAK;AAAA;AAAA,QACjBwtB,KAAa/7C,KAASuuB,EAAK,IAAIA,EAAK;AAAA;AAAA,QACpCwtB,KAAa97C,KAAUsuB,EAAK,IAAIA,EAAK;AAAA;AAAA,MACvC;AAAA,IAAA;AAGF,UAAM8wB,IAAqB;AAAA,MACzB,OAAO,KAAKpB,EAAI,KAAK;AAAA,MACrB,QAAQnU,EAAQlnC,CAAM;AAAA;AAAA;AAAA;AAAA,MAItB,MAAMs8C;AAAA,IACR,GACMroC,IAAM,KAAK,WAAWwoC,CAAG;AAM3B,QALAtlC,MACEslC,EAAA,OAAOvV,EAAQ/vB,CAAI,GACtBA,EAAK,KAAuB,OAAO+vB,EAAQjzB,CAAG,KAG7CpgB,IAAAwnD,EAAI,aAAJ,QAAAxnD,EAAc,QAAQ;AAEpBsjB,UAAAA;AACJ,MAAAslC,EAAI,QAAQ;AACZ,iBAAW,CAACpkD,GAAKC,CAAK,KAAK+iD,EAAI,SAAS,WAAW;AAC3C,cAAA,CAACC,GAAUoB,CAAW,IAAI,KAAK,YAAYpkD,GAAO2b,GAAKkD,CAAI;AACjE,QAAI9e,MAAQ,IACNokD,EAAA,QAAQvV,EAAQoU,CAAQ,IACnBjjD,MAAQgjD,EAAI,SAAS,SAAS,MACnCoB,EAAA,OAAOvV,EAAQoU,CAAQ,IAEzBmB,EAAA,QAAQA,EAAI,QAAQ,IAAIC,GAC5BvlC,IAAOmkC;AAAA,MAAA;AAAA,IACT;AAEF,WAAO,CAACrnC,GAAMwoC,EAAI,SAAoB,CAAC;AAAA,EAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAUzC,WACE1hD,GACA4hD,GACA7U,GACW;AACX,UAAM8U,IAAW,CAAC9hD,MAChB,OAAOA,KAAM,YAAYA,MAAM;AACjC,QAAIgtC,GAAQ;AACN,UAAA,CAAC8U,EAAS7hD,CAAG;AACf,cAAM,IAAI;AAAA,UACR;AAAA,QACF;AAEE,MAAEA,EAAsB,WACzBA,EAAsB,SAAS+sC,EAAO;AAAA,IACzC;AAEF,UAAM7zB,IAAM;AAAA,MACV,KAAK,KAAK;AAAA,MACV,MAAMlZ;AAAA,MACN,QAAA+sC;AAAA,IACF;AACK,gBAAA,cACA,KAAA,SAAS7zB,EAAI,GAAG,IAAIA,GACrB0oC,MACF,KAAK,SAASA,CAAO,IAAIzV,EAAQjzB,CAAG,IAE/BA;AAAA,EAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAYT,MAAc,kBACZxc,GACAwc,GACA4oC,IAAsC,CAAA,GACrB;AACX,UAAAC,IAAc,OAAOjqD,MAAuC;AAChE,UAAIA,aAAiBo0C,IAAQ;AAC3B,cAAM,IAAI,MAAMxvC,EAAO,WAAW5E,CAAK;AACvC,YAAI,MAAM;AACF,gBAAA,0CAA0CA,EAAM,MAAM;AAG1D,YAAAgqD,EAAY,EAAE,GAAG;AACZ,iBAAAA,EAAY,EAAE,GAAG;AAE1B,cAAME,IAAU,EAAE,MACZC,IAAS,KAAK,WAAWD,GAAS,QAAW,EAAE,MAAM,GACrD10C,IAAM,IAAI4+B,GAAO+V,EAAO,GAAG;AACrB,eAAAH,EAAA,EAAE,GAAG,IAAIx0C,GACd20C,EAAA,OAAO,MAAMF,EAAYC,CAAO,GACnCA,EAAQ,SAAS,YAElBC,EAAO,KAAuB,SAAS,KAAK,SAAS,QAEjD30C;AAAAA,MAAA;YACE,OAAOxV,KAAU,YAAYA,EAAM,CAAC,KAAK;AAClD,iBAAO,IAAIA,CAAK;AACP,YAAA,MAAM,QAAQA,CAAK,GAAG;AAC/B,gBAAMuF,IAAM,CAAC;AACb,qBAAW2C,KAAOlI;AAChB,YAAAuF,EAAI,KAAK,MAAM0kD,EAAY/hD,CAAG,CAAC;AAE1B,iBAAA3C;AAAA,QACE,WAAA,OAAOvF,KAAU,YAAYA,MAAU,MAAM;AACtD,gBAAMuF,IAAqB,CAAC;AAC5B,qBAAW,CAAC4C,GAAKD,CAAG,KAAK,OAAO,QAAQlI,CAAK;AAEvC,YAAAmI,MAAQ,kBAAkBA,MAAQ,oBAGtC5C,EAAI4C,CAAG,IAAI,MAAM8hD,EAAY/hD,CAAoB;AAE5C,iBAAA3C;AAAA,QAAA;AAAA;AAEF,aAAAvF;AAAA,IACT,GACMwV,IAAM,IAAI4+B,GAAOhzB,EAAI,GAAG;AAKtB,WAAA,MAAM6oC,EAAYz0C,CAAG;AAAA,EAAA;AAAA;AAAA,EAI/B,MAAM,iBAAiB40C,GAAqC;AAC1D,QAAI,KAAK;AACD,YAAA;AAER,UAAMxiD,IAAS,IAAI0tC,GAAY,IAAI,WAAW8U,CAAO,CAAC,GAChDxlD,IAAS,MAAMg3C,GAAU,MAAMh0C,CAAM,GACrCi1C,IAAY,KAAK,SAAS,KAAK,SAAS,MAAM,MAAM,EACvD;AACH,IAAAA,EAAU,OAAO,CAAC;AAGD,qBAAA/yC,KAAQlF,EAAO,SAAS;AACvC,YAAMwmC,IAAOthC,EAAK;AAElB,aAAOshC,EAAK,eACZ,OAAOA,EAAK;AACZ,YAAMif,IAAa,MAAM,KAAK,kBAAkBzlD,GAAQkF,CAAI;AAC3D,MAAA+yC,EAAU,KAAkB,KAAKwN,CAAU,GAC3CxN,EAAU,SAAoB,GAC/B,KAAK,kBAAkB;AAAA,IAAA;AAAA,EAEzB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAUF,MAAc,eACZY,GACA6M,GACAC,GACA3oD,GACe;AAGf,UAAM4oD,IAA0B;AAAA,MAC9B,MAAM;AAAA,MACN,GAAG,IAAI/M,CAAQ;AAAA,MACf,IAAIlJ,GAAUkJ,CAAQ;AAAA,MACtB,MAAM,IAAI6M,CAAW;AAAA,MACrB,IAAI;AAAA,QACF,GAAGjW,EAAQ,KAAK,cAAc,KAAK,YAAY,IAAI,EAAE;AAAA,MAAA;AAAA,IAEzD,GAEMoW,IAAkB,MAAM5W,GAAiBjyC,CAAI,GAC7C8oD,IAAe;AAAA,MACnB,MAAM;AAAA,MACN,SAAS,IAAIH,CAAQ;AAAA,MACrB,GAAGE,EAAgB;AAAA,IACrB;AAGA,QADA,KAAK,WAAWD,CAAQ,GACpB,KAAK,WAAW;AACd,UAAAG;AACA,MAAA,OAAO/oD,KAAS,WACR+oD,IAAAvX,GAAY,OAAOxxC,CAAI,IAEvB+oD,IAAA/oD;AAEZ,YAAM+7C,IAAkB,KAAK;AAAA,QAC3B;AAAA,UACE,KAAK,KAAK,aAAa;AAAA,UACvB,MAAM,EAAE,GAAG+M,GAAc,GAAGD,EAAgB,KAAK;AAAA,UACjD,QAAQA,EAAgB;AAAA,QAC1B;AAAA,QACA;AAAA,MACF;AACA,WAAK,4BAA4B;AAAA,QAC/B,UAAAhN;AAAA,QACA,MAAMkN;AAAA,QACN,cAAcF,EAAgB,KAAK,SAC9BA,EAAgB,SACjB;AAAA;AAAA,QAEJ,sBAAsB9M,IAAkB;AAAA,MAAA,CACzC;AAAA,IAAA;AAEH,SAAK,WAAW+M,GAAc,QAAWD,EAAgB,MAAM;AAAA,EAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAOjE,MAAc,eACZxC,GACe;AACf,QAAI2C,IAAe;AACnB,QAAI,MAAM,QAAQ3C,EAAa,UAAU,CAAC,GAAG;AACrC,YAAA4C,IAAkB5C,EAAa,UAAU,EAAE;AAAA,QAAK,CAACh7C,MACrDA,EAAE,WAAW,iCAAiC;AAAA,MAChD;AACA,MAAI49C,MACFD,KAAgB,aAAaC,CAAe;AAAA,IAC9C,MACF,CAAW5C,EAAa,UAAU,MAChB2C,KAAA,aAAa3C,EAAa,UAAU,CAAC;AAEvD,UAAM,KAAK;AAAA,MACT;AAAA,MACA;AAAA,MACA2C;AAAA,MACA,KAAK,UAAU3C,CAAY;AAAA,IAC7B;AAAA,EAAA;AAAA;AAAA;AAAA;AAAA,EAMF,MAAM,oBAAmC;AACvC,UAAMI,IAAU,KAAK,SAAS,KAAK,SAAS,QAAQ,MAAM,EACvD;AAGH,IAAI,KAAK,gBACPA,EAAQ,aAAahU;AAAA,MACnB,KAAK,WAAW;AAAA,QACd,MAAM,KAAK,YACR;AAAA,UAAI,CAACmE,GAAOhzC,MACXgzC,IACI,CAAChzC,IAAM,KAAK,gBAAgB,EAAE,GAAG,KAAKgzC,CAAK,KAAM,CAAA,IACjD;AAAA,UAEL,OAAO,CAACvwC,MAAMA,MAAM,MAAS,EAC7B,KAAK;AAAA,MACT,CAAA;AAAA,IACH;AAOF,UAAMy0C,IAJW,KAAK,SAAS,KAAK,SAAS,MAAM,MAAM,EAI/B;AACtB,IAACA,EAAS,SACZA,EAAS,OAAO,CAAC,IAEnB,KAAK,sBAAsB,KAAK,YAC5B,KAAK,kBACP,KAAK,uBAAuB,GACxB,KAAK,aACF,KAAA;AAGT,eAAW,CAACl3C,CAAG,KAAK,KAAK,aAAa;AACnC,MAAAk3C,EAAS,KAAkB;AAAA,QAC1BrI,EAAQ,KAAK,sBAAsB7uC,CAAG,CAAC;AAAA,MACzC;AAqBF,QAnBK,KAAA,SAEF,OAAO,CAAC4b,MAAS;;AAAA,eAAApgB,IAAAogB,EAAI,SAAJ,gBAAApgB,EAA4B,UAAS;AAAA,KAAS,EAC/D,QAAQ,CAACogB,MAAmB;AACrB,YAAAqoC,IAAQroC,EAAI,KAAuB;AACzC,MAAI,OAAOqoC,EAAK,CAAC,KAAM,aAGlBA,EAAA,CAAC,IAAIpV,EAAQ,KAAK,sBAAsBoV,EAAK,CAAC,CAAC,CAAC;AAAA,IAAA,CACtD,GAGC,KAAK,aACPpB,EAAQ,iBAAiBhU;AAAA,MACvB,KAAK,aAAa,KAAK;AAAA,IACzB,IAIE,KAAK,aAAa,KAAK,CAACsV,MAAOA,EAAG,OAAO,KAAK,CAACxmD,MAAMA,EAAE,UAAU,CAAC,GAAG;AAIvE,YAAM2nD,IAAiC,CAAC,GAClCC,IAAkC,CAAC,GACnCC,IAAoB,CAAC,GACrBC,IAAuB,CAAC;AACnB,iBAAA,CAACC,GAAW,EAAE,QAAAC,EAAA,CAAQ,KAAK,KAAK,aAAa,WAAW;AAE7D,YAAAC,IADe,KAAK,sBAAsBF,CAAS,IAC3B,IAAIC,EAAO;AACvC,QAAI,KAAK,cAEPC,KAAYD,EAAO;AAErB,YAAIE,IAAS;AACb,cAAMC,IAAU,CAAC;AACjB,mBAAWC,KAAOJ,GAAQ;AACpB,cAAA,CAACI,EAAI;AACP;AAEI,gBAAA/1C,IAAM6+B,EAAQ+W,IAAWC,CAAM;AACjC,UAAAE,EAAI,WAAW,UACjBT,EAAqB,KAAKt1C,CAAG,IAE7Bu1C,EAAsB,KAAKv1C,CAAG,GAEhCw1C,EAAQ,KAAKx1C,CAAG,GAChB81C,EAAQ,KAAK91C,CAAG,GAChB61C;AAAA,QAAA;AAEF,QAAAJ,EAAS,KAAKK,CAAO;AAAA,MAAA;AAEvB,MAAAjD,EAAQ,eAAe;AAAA,QACrB,MAAM2C;AAAA,QACN,GAAG;AAAA,UACD,WAAW;AAAA,UACX,IAAIF;AAAA,UACJ,KAAKC;AAAA,UACL,UAAUE;AAAA,QAAA;AAAA,MAEd;AAAA,IAAA;AAIE,QAAA,OAAO,KAAK,kBAAmB;AAEjC,MAAA5C,EAAQ,aAAa;AAAA,QACnBhU;AAAA,UACE,KAAK;AAAA,YACH,KAAK,aAAa;AAAA,cAChB,CAACsV,MAAOA,EAAG,OAAO,OAAO,KAAK;AAAA,YAAA;AAAA,UAChC;AAAA,QACF;AAAA,MAEJ;AAAA,aACS,KAAK,gBAAgB;AAExB,YAAArD,IAAY,KAAK,KAAK,eAAe,KACrCxtB,IAAO,KAAK,eAAe,UAC3B,EAAE,OAAAvuB,GAAO,QAAAC,EAAO,IAAI,KAAK,eAAe;AAC9C,MAAA69C,EAAQ,aAAa;AAAA,QACnBhU;AAAA,UACE,KAAK;AAAA,YACH,KAAK,aAAa;AAAA,cAChB,CAACsV,MAAOA,EAAG,OAAO,OAAO,KAAK;AAAA,YAAA;AAAA,UAChC;AAAA,QAEJ;AAAA,QACA;AAAA;AAAA,QAEArD,IAAYxtB,EAAK;AAAA;AAAA,QACjBwtB,IAAYxtB,EAAK;AAAA;AAAA,QACjBwtB,KAAa/7C,KAASuuB,EAAK,IAAIA,EAAK;AAAA;AAAA,QACpCwtB,KAAa97C,KAAUsuB,EAAK,IAAIA,EAAK;AAAA;AAAA,MACvC;AAAA,IAAA;AAGF,SAAK,gCAAgC,GAErC,MAAM,KAAK,OAAO,GAEd,KAAK,kBACD,MAAA,KAAK,eAAe,KAAK,aAAa,GAC5C,MAAM,KAAK,OAAO;AAAA,EACpB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAcF,MAAM,WACJuF,GACA;AAAA,IACE,OAAOmtB;AAAA,IACP,QAAQC;AAAA,EAEV,GAAAN,GACA7rB,GACAR,GACA8C,IAAM,KACS;;AACX,IAAC,KAAK,kBACRxZ,EAAI,MAAM,iDAAiD,GAC3D,MAAM,KAAK,kBAAkB,GAC7B,KAAK,gBAAgB;AAIvB,UAAMk+B,IAAY,KAAK1kB,GACjB8a,IAA0B;AAAA,MAC9B,MAAM;AAAA,MACN,QAAQ,KAAK,SAAS;AAAA,MACtB,UAAU,CAAC,GAAG,GAAG4J,IAAYkF,GAAalF,IAAYmF,CAAY;AAAA,MAClE,WAAW;AAAA,QACT,SAAS,CAAC,QAAQ,SAAS,WAAW,WAAW,SAAS;AAAA,MAAA;AAAA,IAE9D;AAEA,IAAI,KAAK,aACP/O,EAAS,gBAAgB,KAAK,qBAC9B,KAAK,eAAe,IAAI,KAAK,YAAY,KAAK,mBAAmB,GAC5D,KAAA,wBAGH5d,KAAW,KAAK,SAAS,cAC1B4d,EAAS,UAA4B,OAAO;AAAA,MAC3C,SAAS,KAAK,SAAS;AAAA,IACzB;AAEI,UAAA5yC,IAAO,KAAK,WAAW4yC,CAAQ,GAG/BgP,IAAuB,CAAC,GACxBC,IAAgD,CAAC;AACvD,eAAW,CAACnmD,GAAK8hB,CAAK,KAAK6jC,EAAO,WAAW;AACvC,UAAAtpB,GAAoBva,CAAK;AAC3B;AAEF,YAAM,EAAE,GAAArf,GAAG,GAAAO,GAAG,OAAA+B,GAAO,QAAAC,GAAQ,YAAAohD,MAAetkC,GACtCukC,IAAYvF,IAAY/7C,GACxBuhD,IAAaxF,IAAY97C,GACzBuhD,IAAQzF,IAAYr+C,GACpB+jD,IAAQ1F,KAAamF,IAAejhD,IAAShC,IAC7CyjD,IAAU,MAAMzmD,IAAM,CAAC;AAE7B,UAAIomD,KAAA,QAAAA,EAAY,UAAU;AACxB,cAAMM,IAAO,MAAM,OAAO,KAAKP,CAAgB,EAAE,SAAS,CAAC;AAC3D,QAAAA,EAAiBM,CAAO,IAAIC,GACjBR,EAAA,KAAK,OAAOQ,CAAI,MAAM;AAAA,MAAA;AAExB,MAAAR,EAAA,KAAK,KAAKG,CAAS,QAAQC,CAAU,IAAIC,CAAK,IAAIC,CAAK,KAAK,GAC5DN,EAAA,KAAK,GAAGO,CAAO,KAAK,GAC/BP,EAAW,KAAK,GAAG,GACfE,KAAA,QAAAA,EAAY,YACdF,EAAW,KAAK,KAAK;AAAA,IACvB;AAGF,IAAI5sB,KACF4sB,EAAW,KAAK,KAAK,eAAe5sB,GAASwnB,CAAS,CAAC,GAGzDl+B,EAAI,MAAM,oCAAoC;AAC9C,UAAM+jC,IAAoB,MAAMtY,GAAiB6X,EAAW,KAAK;AAAA,CAAI,CAAC,GAChEU,IAAc,KAAK;AAAA,MACvBD,EAAkB;AAAA,MAClB;AAAA,MACAA,EAAkB;AAAA,IACpB;AACC,IAAAriD,EAAK,KAAuB,WAAWuqC,EAAQ+X,CAAW;AAGrD,UAAAC,IAAiBviD,EAAK,KACzB,WACGwiD,IAA0B,CAAC,GAC3BC,IAA4B,CAAC;AACnC,eAAW,CAAC/mD,GAAK+lD,CAAG,KAAKJ,EAAO,WAAW;AACrC,UAAAtpB,GAAoB0pB,CAAG;AACzB;AAEI,YAAAU,IAAU,MAAMzmD,IAAM,CAAC;AAEzB,UADJ8mD,EAASL,EAAQ,UAAU,CAAC,CAAC,IAAI,KAAK,uBAAuBA,CAAO,IAChEjrD,IAAAuqD,EAAI,eAAJ,QAAAvqD,EAAgB,UAAU;AACtB,cAAAwrD,IAAQb,EAAiBM,CAAO;AACtC,QAAAM,EAAWC,EAAM,UAAU,CAAC,CAAC,IAAI,KAAK,uBAAuBA,CAAK;AAAA,MAAA;AAAA,IACpE;AAEF,IAAAH,EAAc,UAAUC,GACpB,OAAO,KAAKC,CAAU,EAAE,SAAS,MACnCF,EAAc,aAAaE,IAG7BnkC,EAAI,MAAM,yBAAyB;AAC7B,UAAA8iC,IAAY,KAAK,aAAa;AAAA,MAClC,CAACvB,MAAOA,EAAG,OAAO,OAAOtrB;AAAA,IAC3B;AACA,eAAW,CAACouB,GAAQlB,CAAG,KAAKJ,EAAO,WAAW;AACxC,UAAAtpB,GAAoB0pB,CAAG,GAAG;AAEvB,aAAA,WAAW,EAAE,GACd,KAAK,aAEF,KAAA,WAAW,EAAE;AAEpB;AAAA,MAAA;AAEF,YAAM3V,IAAY,IAAI,WAAW2V,EAAI,IAAK,GACpCjkC,IAAQ2wB,GAAS,KAAKrC,CAAS,GAE/B8W,IAAYplC,EAAM;AAAA;AAAA,QAEtB,KAAK,YAAY,KAAK,aAAa,IAAI,KAAK;AAAA,MAC9C;AAEA,UAAIikC,EAAI,WAAW,UAAUjkC,aAAiB4wB,IAAW;AAIvD,YAAIiB,IAASuT,EAAU,MAAM,EAAE,EAAE,CAAC,EAAE;AACpC,iBAASvpD,IAAI,GAAGupD,EAAU,SAAS,GAAGvpD;AACpC,UAAAupD,EAAU,KAAK,EAAE,KAAKvT,IAAA,CAAU;AAAA,MAClC;AAII,YAAAwT,IAAeD,EAAU,CAAC,GAC1BT,IAAU,MAAMQ,IAAS,CAAC;AAGhC,UAFA,KAAK,oBAAoB,IAAIR,CAAO,EAAG,SAASU,EAAa,KAEzD,KAAK;AACP,YAAIrlC,aAAiB4wB,IAAW;AAC9B,gBAAM0U,IAAkB,KAAK,mBAAmBD,GAAc,EAAI,GAC5DlP,IAAW,cAAcyN,CAAS,IAAIuB,CAAM;AAClD,eAAK,4BAA4B;AAAA,YAC/B,UAAAhP;AAAA,YACA,MAAM7H;AAAA,YACN,sBAAsBgX;AAAA,UAAA,CACvB;AAAA,QAAA;AAMI,eAAA,WAAW,EAAE;AAGtB,MAAAF,EAAU,QAAQ,CAACtrC,MAAQ,KAAK,SAAS,KAAKA,CAAG,CAAC,GAClD,KAAK,aAAasrC,EAAU,MAAM,EAAE,EAAE,CAAC,EAAE,MAAM;AAAA,IAAA;AAGjD,QAAIvB,EAAO,KAAK,CAAChoD,MAAM;;AAAA,cAAAnC,IAAAmC,KAAA,gBAAAA,EAAG,eAAH,gBAAAnC,EAAe;AAAA,KAAQ,GAAG;AAC/ConB,MAAAA,EAAI,MAAM,2CAA2C;AACrD,iBAAW,CAAC5iB,GAAK+lD,CAAG,KAAKJ,EAAO,WAAW;AACnC,cAAAc,IAAU,MAAMzmD,IAAM,CAAC;AACzB,YAAC+lD,KAAA,QAAAA,EAAK,YAGN;AAAA,cAAA1pB,GAAoB0pB,CAAG,GAAG;AAEvB,iBAAA,WAAW,EAAE;AAClB;AAAA,UAAA;AAEF,eAAK,oBAAoB,IAAII,EAAiBM,CAAO,CAAC,EAAG,SACvD,KAAK,YACP,KAAK,WAAW;AAAA,YACd,MAAM;AAAA,YACN,MAAMV,EAAI,WAAW,QACjB,IAAIxvB,GAAawvB,EAAI,WAAW,OAAO,KAAK,WAAW,GAAG,CAAC,MAC3D;AAAA,YACJ,QAAQ;AAAA,YACR,OAAOA,EAAI,WAAW,mBAAmB,QAAQ;AAAA,UAAA,CACjC;AAAA;AAAA,MAAA;AAAA,IACpB;AAGI,UAAAsB,IAAa,KAAK,aAAa3B,CAAS;AAG9C,QAAIpsB,KAAA,QAAAA,EAAS,QAAQ;AACbosB,YAAAA,IAAY,KAAK,aAAa;AAAA,QAClC,CAACvB,MAAOA,EAAG,OAAO,OAAOtrB;AAAA,MAC3B;AACI,UAAAof,IAAW,cAAcyN,CAAS;AACtC,MAAIpsB,EAAQ,SAAS,QAAQ,MAAM,KAAK,IAC1B2e,KAAA,UAEAA,KAAA,QAGd,MAAM,KAAK;AAAA,QACTA;AAAA,QACA,mBAAmByN,CAAS;AAAA,QAC5BpsB,EAAQ;AAAA,QACRA,EAAQ;AAAA,MACV;AAAA,IAAA,MACF,CAAW+tB,EAAW,QAIf,KAAA,WAAW,EAAE,GACb,KAAA,WAAW,EAAE,GAEd,KAAK,aACF,KAAA,WAAW,EAAE;AAKlB,IAAAvtB,KAAeA,EAAY,SAAS,MACtClX,EAAI,MAAM,+BAA+B,GACzCs0B,EAAS,SAASpd,EACf,QAAQ,CAAChC,MAAS8pB,GAAoB9pB,GAAMgpB,GAAWmF,CAAY,CAAC,EACpE,IAAI,CAACqB,MAAYzY,EAAQ,KAAK,WAAWyY,CAAO,CAAC,CAAC,IAIvD1kC,EAAI,MAAM,wBAAwB,GAClC,MAAM,KAAK,OAAO,GAClBA,EAAI,MAAM,yBAAyB;AAAA,EAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAerC,eAAe2kC,GAAwBzG,GAA2B;AAKhE,UAAMD,IAAa0G,EAAI,QACjBC,IAAqB,CAAC;AAC5B,IAAAA,EAAI,KAAK,IAAI,GACbA,EAAI,KAAK,MAAM;AACT,UAAAC,IAAa,KAAK,aAAa;AACrC,QAAIC,IAAU;AACd,UAAM7Q,IAA6B,CAAC,GAC9B8Q,IAAc,CAClB1nD,GACA0H,MACG;AACC,UAAA1H,EAAM,SAAS;AACjB,QAAA42C,EAAQ,KAAK;AAAA,UACX,MAAM;AAAA,UACN,UAAU,CAAC;AAAA,UACX,YAAA4Q;AAAA,UACA,KAAK,CAAA;AAAA,QAAC,CACP;AAAA,eACQxnD,EAAM,SAAS;AACxB,QAAA42C,EAAQ,KAAK;AAAA,UACX,MAAM;AAAA,UACN,UAAU,CAAC;AAAA,UACX,YAAA4Q;AAAA,UACA,KAAK,CAAA;AAAA,QAAC,CACP,GACG9/C,KACFA,EAAO,SAAS,KAAKkvC,EAAQ,MAAM,EAAE,EAAE,CAAC,CAAC;AAAA,eAElC52C,EAAM,SAAS,QAAQ;AAC5B,QAAAunD,EAAA;AAAA,UACF,GAAG,KAAK;AAAA,YACNvnD;AAAA,YACAynD;AAAA,YACA5G;AAAA,YACAD;AAAA,YACA4G;AAAA,UAAA;AAAA,QAEJ,GACI9/C,KACFA,EAAO,SAAS,KAAK;AAAA,UACnB,MAAM;AAAA,UACN,UAAU,CAAC;AAAA,UACX,YAAA8/C;AAAA,UACA,KAAK,CAACC,CAAO;AAAA,QAAA,CACd,GAEHA;AACA;AAAA,MAAA;AAES,iBAAAE,KAAc3nD,EAAM;AAC7B,QAAA0nD,EAAYC,GAAY/Q,EAAQ,MAAM,EAAE,EAAE,CAAC,CAAC;AAAA,IAEhD;AACA,WAAA8Q,EAAYJ,CAAG,GACV,KAAA,WAAW,KAAK,GAAG1Q,CAAO,GAC/B2Q,EAAI,KAAK,IAAI,GACNA,EAAI,KAAK;AAAA,CAAI;AAAA,EAAA;AAAA;AAAA,EAItB,cACEjrD,GACAmrD,GACA5G,GACAD,GACA4G,GACU;AACV,UAAMI,IAAU,UAKVL,IAAqB,CAAC;AAExB,IAAAA,EAAA,KAAK,kBAAkBE,CAAO,SAAS;AAGrC,UAAAI,IAAWvrD,EAAK,SAASukD,IAAY;AAE3C,IAAA0G,EAAI,KAAK,GAAGK,CAAO,IAAIC,CAAQ,KAAK;AAK9B,UAAAC,IAAOxrD,EAAK,IAAIukD,GAChBkH,IAAQnH,IAAatkD,EAAK,IAAIA,EAAK,SAAS,MAC5C0rD,IAAOD,IAAQlH;AACrB,IAAA0G,EAAI,KAAK,WAA2CO,CAAI,IAAIE,CAAI,KAAK;AACrE,QAAIC,IAAO,GACPC,IAAO;AAEA,eAAA1iD,KAAQlJ,EAAK,OAAO;AAIzB,UAHA,CAACkJ,EAAK,QAGN,CAACA,EAAK;AACR;AAGF,YAAM2iD,KAAS3iD,EAAK,IAAIlJ,EAAK,KAAKukD,GAG5BuH,KADgBxH,IAAap7C,EAAK,IAAIA,EAAK,SAAS,OAC3BuiD,KAASlH,GAClCwH,IAAY7iD,EAAK,QAAQq7C,GACzByH,IAAa9iD,EAAK,SAASq7C,GAC3BnQ,IAAKyX,IAAQF,GACbtX,IAAKyX,IAAQF;AACf,MAAAX,EAAA,KAAK,GAAG7W,IAAK,IAASC,IAAK,CAAM,IAAID,IAAK,IAASC,IAAK,CAAM,KAAK,GAChEsX,IAAAE,GACAD,IAAAE;AAKP,YAAMG,IAAa,KAAK;AAAA,QACtB,KAAK,IAAIF,GAAW,CAAC,IAAI,KAAK,IAAIC,GAAY,CAAC;AAAA,QAC/C;AAAA,MACF,GACME,IAAahjD,EAAK,KAAK;AACzB,MAAA+hD,EAAA;AAAA,QACF,GAAGzF,MAAe,MAAMyG,KAAeV,IAAWW,GAAY;AAAA,MAChE;AAGA,YAAMC,IAAYtqC,GAAU2wB,GAAUtpC,EAAK,OAAO,KAAK,EAAK,CAAC;AACzD,MAAA+hD,EAAA,KAAK,KAAKkB,CAAS,OAAO;AAAA,IAAA;AAEhC,WAAAlB,EAAI,KAAK,KAAK,GAEdA,EAAI,KAAK,EAAE,GACN,KAAK,WAAW,IAAIC,CAAU,KACjC,KAAK,WAAW,IAAIA,GAAY,CAAA,CAAE,GAEpC,KAAK,WAAW,IAAIA,CAAU,EAAG,KAAKC,CAAO,GACtCF;AAAA,EAAA;AAAA;AAAA,EAIT,IAAI,eAAuB;AACzB,WAAO,KAAK;AAAA,EAAA;AAAA;AAAA,EAId,IAAI,qBAA6B;AAE/B,WAAO,KAAK,aAAa;AAAA,MACvB,CAACz1B,GAAK5nB,GAAGnK,MAAQ+xB,IAAM,KAAK,sBAAsB/xB,CAAG;AAAA,MACrD;AAAA,IACF;AAAA,EAAA;AAAA;AAAA,EAIF,oBAAoB0lD,GAA2B;AAC7C,UAAM,EAAE,QAAAC,GAAQ,KAAA4B,GAAK,gBAAAoB,EAAmB,IAAA,KAAK,aAAajD,CAAS;AAC/D,QAAAkD;AAAA;AAAA;AAAA;AAAA,MAIFjD,EACG,IAAI,CAACI,MAASA,EAAI,WAAW,SAAS,IAAI,CAAE,EAC5C,OAAO,CAAC,GAAGp6C,MAAM,IAAIA,GAAG,CAAC;AAAA,MAE5B;AAAA,MAEAg6C,EAAO,OAAO,CAAChoD,MAAMA,EAAE,eAAe,MAAS,EAAE;AAAA,MAEjDgrD;AAAA;AACF,WAAI,KAAK,cAOPC,IAAaA,IAAajD,EAAO,UAAU4B,IAAM,IAAI,KAEnDA,MACYqB,KAAA,IAETA;AAAA,EAAA;AAAA;AAAA,EAIT,sBAAsBlD,GAA2B;AAC/C,QAAItwB,IAAM,KAAK;AACf,eAAW,CAACp1B,CAAG,KAAK,KAAK,aAAa,WAAW;AAC/C,UAAIA,MAAQ0lD;AACH,eAAAtwB;AAEF,MAAAA,KAAA,KAAK,oBAAoBp1B,CAAG;AAAA,IAAA;AAErC,UAAM,IAAI,MAAM,WAAW0lD,CAAS,aAAa;AAAA,EAAA;AAAA;AAAA,EAInD,MAAM,SAAwB;AACxB,IAAA,KAAK,SAAS,WAAW,MAC3B9iC,EAAI,MAAM,oBAAoB,GAC9B,MAAM,KAAK,OAAO;AAAA;AAAA,CAA+B;AAExC,eAAAhH,KAAO,KAAK;AACrB,MAAKA,MAGLgH,EAAI,MAAM,uBAAuBhH,EAAI,GAAG,EAAE,GACpC,MAAA,KAAK,iBAAiBA,CAAG;AAEjC,SAAK,WAAW,CAAC;AAAA,EAAA;AAAA;AAAA,EAInB,mBACE,EAAE,KAAAwZ,GAAK,MAAAh5B,GAAM,QAAAqzC,EAAO,GACpBoZ,IAAmB,IACX;AACR,QAAInlC,IAAO;AAMX,QALAA,KAAQ,GAAG0R,CAAG;AAAA,EAAW,QAErBh5B,MACMsnB,KAAAtF,GAAUhiB,CAAI,EAAE,SAEtBqzC,GAAQ;AAEV,UADA/rB,KAAQ,GACJmlC;AACK,eAAAnlC;AAEL,MAAA,OAAO+rB,KAAW,WACZ/rB,KAAAkqB,GAAY,OAAO6B,CAAM,EAAE,aAEnC/rB,KAAQ+rB,EAAO,YAEjB/rB,KAAQ;AAAA,IAAc;AAExB,WAAAA,KAAQ,GACDA;AAAA,EAAA;AAAA;AAAA,EAIT,MAAM,iBAAiB9H,GAA+B;AAC/C,SAAA,SAAS,KAAK,KAAK,OAAO;AAC/B,UAAM,EAAE,KAAAwZ,GAAK,MAAAh5B,GAAM,QAAAqzC,EAAW,IAAA7zB;AACxB,UAAA,KAAK,OAAO,GAAGwZ,CAAG;AAAA,CAAU,GAC9Bh5B,KACF,MAAM,KAAK,OAAOgiB,GAAUhiB,CAAI,CAAC,GAE/BqzC,MACI,MAAA,KAAK,OAAO;AAAA;AAAA,CAAY,GACxB,MAAA,KAAK,OAAOA,CAAM,GAClB,MAAA,KAAK,OAAO;AAAA,UAAa,IAE3B,MAAA,KAAK,OAAO;AAAA;AAAA,CAAY;AAAA,EAAA;AAAA;AAAA,EAIhC,MAAM,OAAOrzC,GAA0C;AACjD,QAAA,KAAK,YAAY;AACnB,YAAM,IAAI;AAAA,QACR;AAAA,MACF;AAEE,IAAA,OAAOA,KAAS,aACXA,IAAAwxC,GAAY,OAAOxxC,CAAI,IAEhC,KAAK,WAAWA,EAAK,YACf,MAAA,KAAK,QAAQ,MAAMA,CAAI;AAAA,EAAA;AAAA;AAAA,EAI/B,MAAM,sBAAqC;AACzC,UAAM0sD,IAA4B;AAAA,MAChC,MAAM,CAAA;AAAA,IACR,GACMC,IAAgBla,EAAQ,KAAK,WAAWia,CAAU,CAAC,GACnD/oC,IAAsB;AAAA,MAC1B,MAAM;AAAA,MACN,GAAG,CAAC;AAAA,MACJ,YAAYgpC;AAAA,MACZ,mBAAmB,KAAK;AAAA,IAC1B,GACMC,wBAA8C,IAAI,GAClDC,IAAUpa,EAAQ,KAAK,WAAW9uB,CAAI,CAAC,GACvCmpC,IAAa,OACjB3tD,GACAoM,GACAwhD,MACkB;AAClB,YAAMvtC,IAAqB;AAAA,QACzB,MAAM;AAAA,QACN,GAAG,IAAIrgB,EAAM,IAAI;AAAA,QACjB,GAAG4tD;AAAA,QACH,IAAIta,EAAQtzC,EAAM,UAAU;AAAA,QAC5B,GAAG,CAAA;AAAA,MACL;AACA,MAAKytD,EAAY,IAAIztD,EAAM,UAAU,KACnCytD,EAAY,IAAIztD,EAAM,YAAY,CAAA,CAAE;AAEtC,YAAM6tD,IAASva,EAAQ,KAAK,WAAWjzB,CAAG,CAAC;AAEvC,UADHjU,EAAO,EAAe,KAAKyhD,CAAM,GAC9B7tD,EAAM,SAAS,SAAS;AACf,mBAAAoC,KAAKpC,EAAM;AACd,gBAAA2tD,EAAWvrD,GAAGie,GAAKwtC,CAAM;AAAA,UAExB,CAAA7tD,EAAM,IAAI,UAAU,IACzBqgB,EAAA,IAAIrgB,EAAM,IAAI,CAAC,IACVA,EAAM,IAAI,SAAS,MAC5BqgB,EAAI,IAAIrgB,EAAM;AAEZ,UAAAA,EAAM,IAAI,SAAS,GAAG;AACxB,cAAM8tD,IAAUL,EAAY,IAAIztD,EAAM,UAAU;AACrC,mBAAA+tD,KAAQ/tD,EAAM;AACvB,UAAA8tD,EAAQC,CAAI,IAAIF;AAAA,MAClB;AAEE,MAAA,KAAK,SAAS,SAAS,OACzB,MAAM,KAAK,OAAO;AAAA,IAEtB;AACW,eAAAzrD,KAAK,KAAK;AACb,YAAAurD,EAAWvrD,GAAGoiB,GAAMkpC,CAAO;AAEnC,eAAW,CAACxB,GAAY4B,CAAO,KAAKL,GAAa;AAC/C,YAAMO,IAAO,KAAK,eAAe,IAAI9B,CAAU;AAC9C,MAAAqB,EAAW,KAAkB;AAAA,QAC5BS;AAAA,QACA1a,EAAQ,KAAK,WAAWwa,CAAO,CAAC;AAAA,MAClC;AAAA,IAAA;AAEF,UAAM,KAAK,OAAO;AAAA,EAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAQpB,MAAM,MAAqB;AACrB,QAAA,CAAC,KAAK;AACR;AAUFzmC,IAAAA,EAAI,MAAM,oBAAoB;AAE9B,UAAM4mC,IAAgC;AAAA,MACpC,CAAC,GAAG,OAAO,GAAG;AAAA,MACd,GAAG,KAAK,SAAS,IAAI,CAACnqD,MAAsB,CAACA,GAAQ,GAAG,GAAG,CAAC;AAAA,IAC9D,GACMoqD,IAAYD,EACf;AAAA,MAAI,CAAC,CAACE,GAAK5S,GAAK6S,CAAI,MACnB;AAAA,QACED,EAAI,SAAS,EAAE,EAAE,SAAS,IAAI,GAAG;AAAA,QACjC5S,EAAI,SAAS,EAAE,EAAE,SAAS,GAAG,GAAG;AAAA,QAChC6S;AAAA,QACA;AAAA,MACF,EAAE,KAAK,GAAG;AAAA,IAAA,EAEX,KAAK;AAAA,CAAI,GACNC,IAAa,KAAK;AACxB,UAAM,KAAK,OAAO;AAAA,IAAWJ,EAAY,MAAM;AAAA,EAAKC,CAAS;AAAA,CAAI;AACjE,UAAM1U,IAA6B;AAAA,MACjC,MAAMyU,EAAY;AAAA,MAClB,MAAM,KAAK,SAAS;AAAA,MACpB,MAAM,KAAK,SAAS;AAAA,MACpB,IAAI,CAACrb,GAAW,EAAE,GAAGA,GAAW,EAAE,CAAC;AAAA,IACrC;AACA,UAAM,KAAK,OAAO;AAAA;AAAA,EAAc/vB,GAAU22B,CAAW,CAAC,EAAE;AACxD,UAAM8U,IAAU;AAAA,EAAcD,CAAU;AAAA;AACpC,QAAA,KAAK,aAAa,KAAK,aAAa;AACtChnC,MAAAA,EAAI,MAAM,sCAAsC,GAC1C,MAAA,KAAK,OAAO;AAAA;AAAA;AAAA,CAA4B;AAC9C,YAAMknC,IAAS;AAAA;AAAA;AAAA;AACf,YAAM,KAAK;AAAA,QACTrR,GAA0B;AAAA,UACxB,OAAO,KAAK;AAAA,UACZ,gBAAgBoR,EAAQ,SAASC,EAAO;AAAA,UACxC,QAAQ,KAAK;AAAA,QACd,CAAA;AAAA,MACH,GACM,MAAA,KAAK,OAAOA,CAAM;AAAA,IAAA;AAE1B,UAAM,KAAK,OAAO,GAClBlnC,EAAI,MAAM,iBAAiB,GACrB,MAAA,KAAK,OAAOinC,CAAO,GACzBjnC,EAAI,MAAM,UAAU,GACpB,MAAM,KAAK,OAAO,GAKlBA,EAAI,MAAM,8BAA8B,GAClC,MAAA,KAAK,QAAQ,MAAM,GACzBA,EAAI,MAAM,eAAe,GACzB,KAAK,UAAU;AAAA,EAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAOT,4BAA4B;AAAA,IAClC,UAAAq1B;AAAA,IACA,MAAA77C;AAAA,IACA,cAAA2tD;AAAA,IACA,sBAAAC;AAAA,EAAA,GAC2B;AAC3B,IAAI,KAAK,gBACP/R,IAAW,GAAG,KAAK,WAAW,IAAIA,CAAQ;AAE5C,UAAMgS,IACJ,KAAK,UACL,KAAK,SAAS,OAAO,CAAC9pD,GAAKyb,MAAQzb,IAAM,KAAK,mBAAmByb,CAAG,GAAG,CAAC,GACpEo8B,wBAAmB,KAAK;AAC9B,IAAAgS,KAAwB;AACxB,UAAME,IAAS,KAAK;AAAA,MAClB,CAAC;AAAA,MACD;AAAA,MACAnS,GAAoB;AAAA,QAClB,UAAAE;AAAA,QACA,MAAA77C;AAAA,QACA,gBAAgB2tD;AAAA,QAChB,iBAAiBC;AAAA,QACjB,cAAAhS;AAAA,MACD,CAAA;AAAA,IACH,GACMmS,IACJF,IAAe,KAAK,mBAAmBC,GAAQ,EAAI;AACjD,IAAC,KAAK,gBACR,KAAK,cAAc,CAAC,IAEtB,KAAK,YAAY,KAAK;AAAA,MACpB,mBAAAC;AAAA,MACA,WAAUJ,KAAA,gBAAAA,EAAc,YAAW3tD,EAAK;AAAA,MACxC,kCAAkB,KAAK;AAAA,MACvB,OAAOuM,GAAMvM,CAAI;AAAA,MACjB,YAAYA,EAAK;AAAA;AAAA,MAEjB,sBAAsB2tD,IAClBA,EAAa,SAAS,IACtB3tD,EAAK;AAAA,MACT,UAAA67C;AAAA,IAAA,CACD;AAAA,EAAA;AAEL;AC5iDO,MAAMmS,KAAwB;AAAA,EACnC,wDAAwD;AAAA,IACtD,MAAM;AAAA,IACN,MAAM;AAAA,EACR;AAAA,EACA,kDAAkD;AAAA,IAChD,MAAM;AAAA,IACN,MAAM;AAAA,EACR;AAAA,EACA,kDAAkD;AAAA,IAChD,MAAM;AAAA,IACN,MAAM;AAAA,EACR;AAAA,EACA,qDAAqD;AAAA,IACnD,MAAM;AAAA,IACN,MAAM;AAAA,EACR;AAAA,EACA,+CAA+C;AAAA,IAC7C,MAAM;AAAA,IACN,MAAM;AAAA,EACR;AAAA,EACA,kDAAkD;AAAA,IAChD,MAAM;AAAA,IACN,MAAM;AAAA,EACR;AAAA,EACA,wDAAwD;AAAA,IACtD,MAAM;AAAA,IACN,MAAM;AAAA,EACR;AAAA,EACA,qDAAqD;AAAA,IACnD,MAAM;AAAA,IACN,MAAM;AAAA,EACR;AAAA,EACA,kDAAkD;AAAA,IAChD,MAAM;AAAA,IACN,MAAM;AAAA,EACR;AAAA,EACA,qDAAqD;AAAA,IACnD,MAAM;AAAA,IACN,MAAM;AAAA,EACR;AAAA,EACA,kDAAkD;AAAA,IAChD,MAAM;AAAA,IACN,MAAM;AAAA,EACR;AAAA,EACA,+CAA+C;AAAA,IAC7C,MAAM;AAAA,IACN,MAAM;AAAA,EACR;AAAA,EACA,kDAAkD;AAAA,IAChD,MAAM;AAAA,IACN,MAAM;AAAA,EACR;AAAA,EACA,qDAAqD;AAAA,IACnD,MAAM;AAAA,IACN,MAAM;AAAA,EACR;AAAA,EACA,kDAAkD;AAAA,IAChD,MAAM;AAAA,IACN,MAAM;AAAA,EACR;AAAA,EACA,qDAAqD;AAAA,IACnD,MAAM;AAAA,IACN,MAAM;AAAA,EACR;AAAA,EACA,kDAAkD;AAAA,IAChD,MAAM;AAAA,IACN,MAAM;AAAA,EACR;AAAA,EACA,kDAAkD;AAAA,IAChD,MAAM;AAAA,IACN,MAAM;AAAA,EACR;AAAA,EACA,wDAAwD;AAAA,IACtD,MAAM;AAAA,IACN,MAAM;AAAA,EACR;AAAA,EACA,+CAA+C;AAAA,IAC7C,MAAM;AAAA,IACN,MAAM;AAAA,EACR;AAAA,EACA,kDAAkD;AAAA,IAChD,MAAM;AAAA,IACN,MAAM;AAAA,EACR;AAAA,EACA,qDAAqD;AAAA,IACnD,MAAM;AAAA,IACN,MAAM;AAAA,EACR;AAAA,EACA,yDAAyD;AAAA,IACvD,MAAM;AAAA,IACN,MAAM;AAAA,EACR;AAAA,EACA,sDAAsD;AAAA,IACpD,MAAM;AAAA,IACN,MAAM;AAAA,EACR;AAAA,EACA,qDAAqD;AAAA,IACnD,MAAM;AAAA,IACN,MAAM;AAAA,EACR;AAAA,EACA,wDAAwD;AAAA,IACtD,MAAM;AAAA,IACN,MAAM;AAAA,EACR;AAAA,EACA,kDAAkD;AAAA,IAChD,MAAM;AAAA,IACN,MAAM;AAAA,EACR;AAAA,EACA,qDAAqD;AAAA,IACnD,MAAM;AAAA,IACN,MAAM;AAAA,EACR;AAAA,EACA,kDAAkD;AAAA,IAChD,MAAM;AAAA,IACN,MAAM;AAAA,EACR;AAAA,EACA,qDAAqD;AAAA,IACnD,MAAM;AAAA,IACN,MAAM;AAAA,EACR;AAAA,EACA,qDAAqD;AAAA,IACnD,MAAM;AAAA,IACN,MAAM;AAAA,EACR;AAAA,EACA,kDAAkD;AAAA,IAChD,MAAM;AAAA,IACN,MAAM;AAAA,EACR;AAAA,EACA,qDAAqD;AAAA,IACnD,MAAM;AAAA,IACN,MAAM;AAAA,EACR;AAAA,EACA,kDAAkD;AAAA,IAChD,MAAM;AAAA,IACN,MAAM;AAAA,EACR;AAAA,EACA,qDAAqD;AAAA,IACnD,MAAM;AAAA,IACN,MAAM;AAAA,EACR;AAAA,EACA,+CAA+C;AAAA,IAC7C,MAAM;AAAA,IACN,MAAM;AAAA,EACR;AAAA,EACA,qDAAqD;AAAA,IACnD,MAAM;AAAA,IACN,MAAM;AAAA,EACR;AAAA,EACA,kDAAkD;AAAA,IAChD,MAAM;AAAA,IACN,MAAM;AAAA,EACR;AAAA,EACA,qDAAqD;AAAA,IACnD,MAAM;AAAA,IACN,MAAM;AAAA,EACR;AAAA,EACA,+CAA+C;AAAA,IAC7C,MAAM;AAAA,IACN,MAAM;AAAA,EACR;AAAA,EACA,kDAAkD;AAAA,IAChD,MAAM;AAAA,IACN,MAAM;AAAA,EACR;AAAA,EACA,qDAAqD;AAAA,IACnD,MAAM;AAAA,IACN,MAAM;AAAA,EACR;AAAA,EACA,qDAAqD;AAAA,IACnD,MAAM;AAAA,IACN,MAAM;AAAA,EACR;AAAA,EACA,yDAAyD;AAAA,IACvD,MAAM;AAAA,IACN,MAAM;AAAA,EACR;AAAA,EACA,qDAAqD;AAAA,IACnD,MAAM;AAAA,IACN,MAAM;AAAA,EACR;AAAA,EACA,qDAAqD;AAAA,IACnD,MAAM;AAAA,IACN,MAAM;AAAA,EACR;AAAA,EACA,kDAAkD;AAAA,IAChD,MAAM;AAAA,IACN,MAAM;AAAA,EACR;AAAA,EACA,kDAAkD;AAAA,IAChD,MAAM;AAAA,IACN,MAAM;AAAA,EACR;AAAA,EACA,kDAAkD;AAAA,IAChD,MAAM;AAAA,IACN,MAAM;AAAA,EACR;AAAA,EACA,kDAAkD;AAAA,IAChD,MAAM;AAAA,IACN,MAAM;AAAA,EACR;AAAA,EACA,8CAA8C;AAAA,IAC5C,MAAM;AAAA,IACN,MAAM;AAAA,EACR;AAAA,EACA,oDAAoD;AAAA,IAClD,MAAM;AAAA,IACN,MAAM;AAAA,EACR;AAAA,EACA,kDAAkD;AAAA,IAChD,MAAM;AAAA,IACN,MAAM;AAAA,EACR;AAAA,EACA,iDAAiD;AAAA,IAC/C,MAAM;AAAA,IACN,MAAM;AAAA,EACR;AAAA,EACA,kDAAkD;AAAA,IAChD,MAAM;AAAA,IACN,MAAM;AAAA,EACR;AAAA,EACA,iDAAiD;AAAA,IAC/C,MAAM;AAAA,IACN,MAAM;AAAA,EACR;AAAA,EACA,iDAAiD;AAAA,IAC/C,MAAM;AAAA,IACN,MAAM;AAAA,EACR;AAAA,EACA,mDAAmD;AAAA,IACjD,MAAM;AAAA,IACN,MAAM;AAAA,EACR;AAAA,EACA,iDAAiD;AAAA,IAC/C,MAAM;AAAA,IACN,MAAM;AAAA,EACR;AAAA,EACA,8CAA8C;AAAA,IAC5C,MAAM;AAAA,IACN,MAAM;AAAA,EACR;AAAA,EACA,8CAA8C;AAAA,IAC5C,MAAM;AAAA,IACN,MAAM;AAAA,EACR;AAAA,EACA,8CAA8C;AAAA,IAC5C,MAAM;AAAA,IACN,MAAM;AAAA,EAAA;AAEV;AAEO,SAASC,GAAeC,GAAwC;AACrE,SAAAA,IAAMA,EAAI,QAAQ,WAAW,OAAO,EAAE,QAAQ,qBAAqB,EAAE,GAChEA,EAAI,SAAS,GAAG,MACZA,KAAA,MAEFF,GAASE,CAAG;AACrB;;;;;;;;;;ACrMA,MAAMC,GAAiB;AAAA,EAMrB,YAAmB7mC,GAAc;AALzB,IAAA/pB,EAAA,iBAAoB,CAAC;AACrB,IAAAA,EAAA,eAA4B,CAAC;AAC7B,IAAAA,EAAA,0CAAkD,IAAI;AACtD,IAAAA,EAAA,yCAA+B,IAAI;AAExB,SAAA,OAAA+pB;AAAA,EAAA;AAAA,EAEnB,QAAc;AACZ,aAAS/lB,IAAI,GAAGA,IAAI,KAAK,MAAMA,KAAK;AAC5B,YAAA6sD,IAAS,IAAIC,GAAmB;AACtC,MAAAD,EAAO,YAAY,KAAK,cAAc,KAAK,MAAMA,CAAM,GACvDA,EAAO,UAAU,KAAK,YAAY,KAAK,MAAMA,CAAM,GAC9C,KAAA,QAAQ,KAAKA,CAAM;AAAA,IAAA;AAAA,EAC1B;AAAA,EAGF,OAAa;AACX,SAAK,QAAQ,QAAQ,CAACA,MAAWA,EAAO,WAAW,GACnD,KAAK,UAAU,CAAC,GAChB,KAAK,QAAQ,CAAC,GACd,KAAK,YAAY,MAAM;AAAA,EAAA;AAAA,EAGzB,SAASpuD,GAAqB;AAC5B,WAAO,IAAI,QAAQ,CAAC3B,GAASC,MAAW;AACtC,WAAK,MAAM,KAAK;AAAA,QACd,SAAAD;AAAA,QACA,QAAAC;AAAA,QACA,MAAM;AAAA,UACJ,IAAIqO,GAAa;AAAA,UACjB,MAAA3M;AAAA,QAAA;AAAA,MACF,CACD,GACD,KAAK,aAAa;AAAA,IAAA,CACnB;AAAA,EAAA;AAAA,EAGK,eAAqB;AACvB,QAAA,KAAK,MAAM,WAAW,EAAG;AACvB,UAAAsuD,IAAkB,KAAK,QAAQ,KAAK,CAAClmD,MAAM,CAAC,KAAK,YAAY,IAAIA,CAAC,CAAC;AACzE,QAAI,CAACkmD,EAAiB;AAEhB,UAAA5nB,IAAM,KAAK,MAAM,MAAM;AAC7B,SAAK,aAAa,IAAIA,EAAI,KAAK,IAAIA,CAAG,GACjC,KAAA,YAAY,IAAI4nB,CAAe,GACpBA,EAAA,YAAY5nB,EAAI,IAAI;AAAA,EAAA;AAAA,EAG9B,cACN0nB,GACA/rD,GACM;AACFmkB,IAAAA,EAAA,MAAM,4BAA4BnkB,EAAM,IAAI;AAChD,UAAMqkC,IAAM,KAAK,aAAa,IAAIrkC,EAAM,KAAK,MAAM,EAAE;AACrD,IAAIqkC,KACEA,EAAA,QAAQrkC,EAAM,KAAK,MAAM,GAC7BmkB,EAAI,MAAM,wBAAwBkgB,EAAI,KAAK,EAAE,GAC7C,KAAK,aAAa,OAAOA,EAAI,KAAK,EAAE,GAC/B,KAAA,YAAY,OAAO0nB,CAAM,GAC9B,KAAK,aAAa,KAEd5nC,EAAA;AAAA,MACF,oCAAoC,CAAC,GAAG,KAAK,aAAa,KAAM,CAAA,EAAE;AAAA,QAChE;AAAA,MAAA,CACD;AAAA,MACDnkB,EAAM,KAAK,MAAM;AAAA,IACnB;AAAA,EACF;AAAA,EAGM,YAAY+rD,GAAgBlnD,GAAuB;AACzD,UAAMqnD,IAAarnD,EAAI,OACjBw/B,IAAM,KAAK,MAAM,KAAK,CAACl3B,MAAMA,EAAE,KAAK,OAAO++C,EAAW,MAAM;AAClE,IAAI7nB,MACEA,EAAA,OAAO6nB,EAAW,KAAK,GACtB,KAAA,YAAY,OAAOH,CAAM,GAC9B,KAAK,aAAa;AAAA,EACpB;AAEJ;AAEA,IAAII,KAGO,MACPjqD,KAAgB;AAEJ,SAAAkqD,GAAgBnnC,IAAO,UAAU,qBAA2B;AAC1E,EAAIknC,OAAS,SAGNA,KAAA,IAAIL,GAAW7mC,CAAI,GAC1BknC,GAAK,MAAM;AACb;AAUA,eAAsBrqD,GAAWuqD,GAAsD;AAKrF,MAJIF,OAAS,QACKC,GAAA,GAGdlqD;AACF;AAGI,QAAAoqD,IAAc,MAAMD,EAAW;AACrC,MAAIE,IAAiC,CAAC;AACtC,WAAS,IAAI,GAAG,IAAIJ,GAAM,MAAM;AAC9B,IAAAI,EAAS,KAAKJ,GAAM,SAAS,EAAE,aAAAG,EAAa,CAAA,CAAuB;AAErEnoC,EAAAA,EAAI,MAAM,mCAAmC,GACvC,MAAA,QAAQ,IAAIooC,CAAQ,GAC1BpoC,EAAI,MAAM,gDAAgD,GAC1CjiB,KAAA;AAClB;AAEA,eAAsBsqD,GACpB16B,GACyB;AACzB,SAAIq6B,OAAS,QACKC,GAAA,GAGXD,GAAM,SAASr6B,CAAM;AAC9B;ACoCA,SAAS26B,GACPC,GACAC,GACoB;AAChB,MAAAD,EAAS,UAAUC;AACd,WAAAD;AAET,QAAME,IACJF,EAAS,OAAO,CAAC1oD,GAAG,EAAE,OAAAsC,GAAO,QAAAC,EAAO,MAAMvC,IAAIsC,IAAQC,GAAQ,CAAC,IAC/DmmD,EAAS,QACLG,IAAoBH,EAAS;AAAA,IACjC,CAACvrD,MAAM,KAAK,IAAIyrD,IAAazrD,EAAE,QAAQA,EAAE,MAAM,KAAK,OAAOyrD;AAAA,EAC7D;AACI,MAAAC,EAAkB,UAAUF;AACvB,WAAAE;AAET,QAAMC,IAAqC,CAAC;AACrC,SAAAA,EAAe,SAASH,KAAY;AACnC,UAAA5oC,IACJ8oC,EAAkB,KAAK,MAAM,KAAK,OAAO,IAAIA,EAAkB,MAAM,CAAC;AACxE,IAAIC,EAAe,QAAQ/oC,CAAS,IAAI,KACtC+oC,EAAe,KAAK/oC,CAAS;AAAA,EAC/B;AAEF,SAAO+oC,EAAe;AAAA,IACpB,CAACvpD,GAAG2J,MAAMw/C,EAAS,QAAQnpD,CAAC,IAAImpD,EAAS,QAAQx/C,CAAC;AAAA,EACpD;AACF;AASA,eAAsB6/C,GAAgB;AAAA,EACpC,UAAUC;AAAA,EACV,aAAAC,IAAc;AAAA,EACd,aAAA5oD;AAAA,EACA,gBAAA6oD,IAAiB,MAAM;AAAA,EACvB,YAAAP,IAAa;AAAA,EACb,cAAAQ;AAAA,EACA,eAAAC,IAAgB,YACd;AAAA,IACE,8BAA8BC,EAA0B;AAAA,EAEvD,EAAA,KAAK,CAACrrD,MAAQA,EAAI,YAAa,CAAA,EAC/B,KAAK,CAACC,MAAQ,IAAI,WAAWA,CAAG,CAAC;AAAA,EACtC,mBAAAqrD,IAAoB,YAClB,MAAM,kEAAkE,EACrE,KAAK,CAACtrD,MAAQA,EAAI,YAAa,CAAA,EAC/B,KAAK,CAACC,MAAQ,IAAI,WAAWA,CAAG,CAAC;AAAA,EACtC,gBAAA6qD;AACF,GAA0C;AACpC,MAAAS;AACA,EAAA,OAAOP,KAAkB,WACdO,IAAAP,IAGVO,IAAAP,EAA2B,MAC3BA,EAAyC,KAAK;AAE7C,QAAAhJ,IAAe,MAAMxkB,GAAkB+tB,CAAU,GACjDj1B,IAAW,MAAM/nB,EAAM,aAAag9C,GAAYvJ,CAAY;AAClE,MAAI,CAAC1rB;AACH,UAAM,IAAI,MAAM,gCAAgCi1B,CAAU,EAAE;AAE1D,MAAAC;AACA,EAAA,MAAM,QAAQN,CAAc,IAC9BM,IAAkB,CAACpzB,MAAa8yB,EAAe,QAAQ9yB,CAAQ,KAAK,IAElDozB,IAAAN;AAGpB,QAAMR,IAAWn8C,EAAM;AAAA,IACrB+nB,EAAS,MAAM,OAAO,CAAAn3B,MAAKqsD,EAAgBrsD,EAAE,EAAE,CAAC,EAAE,IAAI,CAAKA,MAAAA,EAAE,EAAE;AAAA,EAAC,GAI5DssD,IAAoBf,EAAS;AAAA,IACjC,CAACp5B,GAAK5iB,MAAW4iB,IAAM5iB,EAAO,QAAQA,EAAO;AAAA,IAC7C;AAAA,EACF;AACI,EAACo8C,KAAA,QAAAA,EAAgB,WACFA,IAAAL,GAAuBC,GAAUC,CAAU;AAE9D,QAAMe,IAAeZ,EAAe;AAAA,IAClC,CAACx5B,GAAK5iB,MAAW4iB,IAAM5iB,EAAO,QAAQA,EAAO;AAAA,IAC7C;AAAA,EACF;AAGA,MAAI,CAAC7G,MAAiB,CAAC8jD,MAA2B;AAChD,QAAI,CAAC9jD,IAAe;AACZ,YAAAnG,IAAO,MAAM0pD,EAAc;AACjC,MAAAhjD,GAAoB1G,CAAI;AAAA,IAAA;AAEtB,IAACiqD,GAAU,MACb,MAAMC,GAAqB,MAAM,QAAQ,QAAQ/jD,EAAc,CAAC,GAEvDsa,EAAI,MAAM,KAAKA,CAAG,GACnBA,EAAI,KAAK,KAAKA,CAAG,GACjBA,EAAI,KAAK,KAAKA,CAAG,GAChBA,EAAI,MAAM,KAAKA,CAAG,GAJ3B0pC;AAAAA,EAMF;AAGF,QAAMhxD,IAAQ,IAAIinC,GAAO,EAAE,aAAAmpB,GAAa,GAClCa,IAAa,MAAM,QAAQ;AAAA,IAC/BhB,EAAe;AAAA,MAAI,CAAC3rD,MAClBtE,EAAM,IAAI,YAAY;AACd,cAAAkxD,IAAOl1B,GAAc13B,CAAC;AACrB,eAAA89B,GAAgB99B,GAAG4sD,EAAK,QAAQ;AAAA,UACrC,aAAA1pD;AAAA,UACA,UAAU8oD,MAAiB;AAAA,QAAA,CAC5B;AAAA,MACF,CAAA;AAAA,IAAA;AAAA,EAEL;AAEI,MAAAa;AACJ,MAAIb,GAAc;AACZ,IAAAA,EAAa,WAAW,aAC1B,MAAMrrD,GAAWwrD,CAAiB;AAEpC,UAAMpG,IAAS4G,EACZ,OAAO,CAAC3sD,MAAuBA,MAAM,MAAS,EAC9C,QAAQ,CAACA,MAAMA,EAAE,MAAM,GACpB8sD,IAAe/G,EAAO;AAAA,MAC1B,CAAC5zB,GAAKg0B,MAAQh0B,IAAMg0B,EAAI,KAAM;AAAA,MAC9B;AAAA,IACF;AACA,UAAM,QAAQ;AAAA,MACZJ,EAAO,IAAI,OAAOI,MAAQ;AAClB,cAAA4G,IAAY,MAAM1B,GAAc;AAAA,UACpC,WAAW,IAAI,WAAWlF,EAAI,IAAK;AAAA,UACnC,aACGA,EAAI,WAA8B,SAC/B,eACA;AAAA,UACN,GAAG6F;AAAA,QAAA,CACJ;AACG,QAAA7F,EAAA,OAAO4G,EAAU,SAAS,QAC9B5G,EAAI,SAAS;AAAA,MACd,CAAA;AAAA,IACH,GAKA0G,IAJsB9G,EAAO;AAAA,MAC3B,CAAC5zB,GAAKg0B,MAAQh0B,IAAMg0B,EAAI,KAAM;AAAA,MAC9B;AAAA,IACF,IACqC2G;AAAA,EAAA;AAGvC,QAAME,IAAgBL,EACnB,OAAO/jD,EAAqB,EAC5B,QAAQ,CAAC5I,MAAMA,EAAE,MAAM,EACvB,MAAM,CAACjC,MAAMA,EAAE,aAAa,GACzBkvD,IAAcN,EACjB,OAAO/jD,EAAqB,EAC5B,QAAQ,CAAC5I,MAAMA,EAAE,MAAM,EACvB;AAAA,IACC,CAAC8jB,GAAcqiC,MAAA;;AAAQ,aAAAriC,OAAQloB,IAAAuqD,KAAA,gBAAAA,EAAK,SAAL,gBAAAvqD,EAAW,eAAcuqD,EAAI;AAAA;AAAA,IAC5D;AAAA,EACF,GAII+G,IAHeP,EAClB,OAAO/jD,EAAqB,EAC5B,QAAQ,CAAC5I,MAAMA,EAAE,MAAM,EACO,CAAC;AAE3B,SAAA;AAAA,IACL,MAFUitD,IAAcV,IAEZD;AAAA,IACZ,eAAAU;AAAA,IACA,iBAAiBE,EAAY,OACzB,IAAI,WAAWA,EAAY,IAAI,IAC/B;AAAA,IACJ,qBAAqBA,EAAY;AAAA,IACjC,gBAAAvB;AAAA,IACA,oBAAAkB;AAAA,EACF;AACF;AAEA,eAAeM,GACbh2B,GACAo0B,GACA30B,GACyB;AAWzB,QAAMw2B,IAAY7B,EAAS,IAAI,CAACh8C,MAAWA,EAAO,EAAE,GAG9C89C,IAAW,CAACC,MAChB,OAAOA,KAAO,YAAYA,EAAG,SAAS,UAClCC,IAAU,CAACD,MACf,OAAOA,KAAO,YAAYA,EAAG,QAAQ,SAEjCE,wBAA8B,IAAI,GAClCC,IAAiB,OACrBC,MACiC;AACjC,QAAIF,EAAW,IAAIE,EAAM,EAAE;AACzB;AAGF,UAAMtkC,IAAcskC,EAAM,MACvB,OAAOL,CAAQ,EACf,OAAO,CAACrtD,MAAMotD,EAAU,QAAQptD,EAAE,EAAG,KAAK,CAAC,EAC3C,OAAOqtD,CAAQ,EACf;AAAA,MAAK,CAACjrD,GAAG2J,MACRqhD,EAAU,QAAQhrD,EAAE,EAAG,IAAIgrD,EAAU,QAAQrhD,EAAE,EAAG,IAAI,KAAK;AAAA,MAC3D,CAAC,GACC4hD,IAAah3B;AAAA,MACjB+2B,EAAM,SAAS;AAAA,MACf92B;AAAA,MACA;AAAA,IACF,GACMg3B,IAAcx+C,EAAM,IAAqBs+C,EAAM,MAAM,OAAOH,CAAO,CAAC,GACpEM,KACJ,MAAM,QAAQ,IAAID,EAAY,IAAIH,CAAc,CAAC,GACjD,OAAO7kD,EAAkB;AAEvB,QAAAklD;AAKJ,QAJIJ,EAAM,UACMI,IAAA,MAAMxwB,GAAqBowB,CAAK,IAErCF,EAAA,IAAIE,EAAM,EAAE,GACnB,EAAAG,EAAS,WAAW,KAAK,CAACzkC;AAK9B,aAAW,CAAC0kC,KAAe1kC,IACzB0kC,IAAc1kC,EAAY,KAChB0kC,MACIA,IAAAD,EAAS,CAAC,EAAE,cAErB;AAAA,QACL,OAAOF;AAAA,QACP,aAAAG;AAAA,QACA,UAAAD;AAAA,MACF;AAAA,EACF;AAEA,MAAIE,IAAY3+C,EAAM,IAAqB+nB,EAAS,UAAU;AAC9D,QAAM62B,IAAWD,EAAU;AAAA,IACzB,CAACzjD,MAAOA,EAAE,SAAsB,QAAQ,KAAK,KAAK;AAAA,EACpD;AAEA,SAAI0jD,MACFD,IAAY,CAACC,CAAQ,KAIpB,MAAM,QAAQ,IAAID,EAAU,IAAIN,CAAc,CAAC,GAAG;AAAA,IACjD7kD;AAAA,EAAA,KACG,CAAC;AAEV;AA2BA,MAAMqlD,GAAgB;AAAA,EAcpB,YACE1C,GACA2C,GACAC,GACAC,GACAC,GACA;AAnBF,IAAAt0D,EAAA,sBAAe;AACf,IAAAA,EAAA,uBAAgB;AAChB,IAAAA,EAAA,0BAAmB;AACnB,IAAAA,EAAA,0BAAmB;AACnB,IAAAA,EAAA;AAEA,IAAAA,EAAA;AACA,IAAAA,EAAA;AACA,IAAAA,EAAA,2BAAoB;AACpB,IAAAA,EAAA;AACA,IAAAA,EAAA;AACA,IAAAA,EAAA;AASE,SAAK,oBAAoBwxD,EAAS;AAAA,MAChC,CAACp5B,GAAK5iB,MAAW4iB,IAAM5iB,EAAO,QAAQA,EAAO;AAAA,MAC7C;AAAA,IACF,GACA,KAAK,aAAag8C,EAAS,QAC3B,KAAK,SAAS4C,GACd,KAAK,iBAAiBD,GACtB,KAAK,aAAaE,GAClB,KAAK,iBAAiBC;AAAA,EAAA;AAAA;AAAA,EAIxB,IAAI,mBAA4B;AAC9B,WAAO,KAAK,OAAO,eAAe,KAAK,eAAe;AAAA,EAAA;AAAA;AAAA,EAIxD,aAAaC,GAAsBC,GAAyC;;AACtE,IAAC,KAAK,cACR,KAAK,YAAY5lD,GAAI;AAEjB,UAAA6lD,IAAc,KAAK,OAAO;AAC5B,QAAAC;AACA,IAAAH,MAAiB,KAAK,aACJG,IAAAD,IACXF,IAAe,MACxBG,IAAoB,KAAK;AAAA,MACvB,KAAK,mBAAmB,KAAK,mBAAmB,KAAK;AAAA,IACvD;AAEI,UAAAC,IAAe,KAAK,eAAe,cACnCC,IAAaH,MAAgB7lD,GAAI,IAAI,KAAK,aAAa;AAC7D,QAAIimD,IAAoB,OAAO;AAC/B,IAAIH,MACFG,KAAqBH,IAAoBC,KAAgBC,KAE3D/yD,IAAA,KAAK,eAAL,QAAAA,EAAA,WAAkB;AAAA,MAChB,aAAA2yD;AAAA,MACA,cAAAD;AAAA,MACA,YAAY,KAAK;AAAA,MACjB,cAAAI;AAAA,MACA,aAAAF;AAAA,MACA,mBAAAC;AAAA,MACA,YAAAE;AAAA,MACA,mBAAAC;AAAA,IAAA;AAAA,EACD;AAAA;AAAA;AAAA,EAKH,iBAAiBC,GAAoC;;AACnD,KAAAjzD,IAAA,KAAK,mBAAL,QAAAA,EAAA,WAAsBizD;AAAA,EAAY;AAAA;AAAA,EAIpC,aAAaC,GAAuBC,GAAsB;AACxD,SAAK,iBAAiBD,GACtB,KAAK,gBAAgBC,GAChB,KAAA,mBAAmB,KAAK,gBAAgB,KAAK,cAClD,KAAK,mBAAmB,KAAK,OAAO,eAAe,KAAK;AAAA,EAAA;AAE5D;AAIA,eAAeC,GACb73B,GACAP,GACAq4B,GACAzzD,GACqB;;AACrB,QAAMm1B,IAA0B;AAAA;AAAA;AAAA,IAG9B,OAAOgG;AAAA,MACLQ,EAAS,SAAS;AAAA,MAClBP;AAAA,MACA;AAAA,IACF;AAAA,IACA,aAAaO,EAAS;AAAA,IACtB,eAAA+gB;AAAA,EACF,GACMgX,IAAW,MAAMh4B,GAAaC,GAAU,GAAG;AACjD,MAAI+3B,GAAU;AACL,IAAAv+B,EAAA,YAAY,EAAE,KAAKu+B,EAAS;AAC7B,UAAAC,IAAgB//C,EAAM,IAAqB+nB,EAAS,UAAU,IAAI,CAAAlxB,MAAKA,EAAE,EAAE,CAAC,EAAE,CAAC;AACjF,IAAAkpD,KAAiB,UAAUA,MACtBx+B,EAAA,UAAU,oBACfwI,KAAAv9B,IAAAuzD,EACA,YADA,gBAAAvzD,EACS;AAAA,MACT,CAAC6O,MACE;;AAAA,iBAAA7O,IAAA6O,KAAA,gBAAAA,EAAgC,SAAhC,gBAAA7O,EAAsC,WAAW,oBAClD;AAAA;AAAA,UAJF,gBAAAu9B,EAKC;AAAA,EACL;AAGF,QAAMi2B,IAAWhgD,EAAM,IAAgC+nB,EAAS,QAAQ,EAAE,CAAC,GACrEk4B,IAAWl4B,EAAS;AAC1B,EAAIi4B,MACFz+B,EAAO,WAAW;AAAA,IAChB,OAAOgG,GAAay4B,EAAS,OAAOx4B,GAAoB,IAAI;AAAA,IAC5D,WAAUnM,KAAA2O,IAAAg2B,EAAS,aAAT,gBAAAh2B,EAAoB,OAApB,gBAAA3O,EAAwB;AAAA,IAClC,OAAM6kC,KAAA5kC,IAAA0kC,EAAS,SAAT,gBAAA1kC,EAAgB,OAAhB,gBAAA4kC,EAAoB;AAAA,EAC5B,GAEI3+B,EAAO,SAAS,UAAU,cAC5BA,EAAO,SAAS,QAAQ,MAGxB0+B,KAAY,QAAQA,EAAS,UAC/B1+B,EAAO,oBAAoB;AAAA,IACzB,OAAOgG,GAAa04B,EAAS,OAAOz4B,GAAoB,IAAI;AAAA,IAC5D,OAAOD,GAAa04B,EAAS,OAAOz4B,GAAoB,IAAI;AAAA,EAC9D;AAEF,QAAM24B,IAAUp4B,EAAS;AACzB,MAAIo4B,GAAS;AACL,UAAAC,IAAa/E,GAAe8E,CAAO;AACzC,IAAA5+B,EAAO,SAAS;AAAA,MACd,OAAM6+B,KAAA,gBAAAA,EAAY,SAAQD;AAAA,MAC1B,KAAKA;AAAA,MACL,MAAMC,KAAA,gBAAAA,EAAY;AAAA,IACpB;AAAA,EAAA;AAmBF,MAjBA7+B,EAAO,aACL8+B,IAAAt4B,EAAS,aAAT,gBAAAs4B,EACI,IAAI,CAACrM,MAAQ;AACb,UAAMhQ,IAAQzc,GAAaysB,EAAI,OAAOxsB,GAAoB,IAAI,GACxDhd,IAAS+c,GAAaysB,EAAI,OAAOxsB,GAAoB,KAAK,EAAE;AAAA,MAChE;AAAA,IACF;AACA,QAAI,GAACwc,KAASx5B,EAAO,WAAW;AAG5B,aAAAA,EAAO,WAAW,IACb,CAACw5B,GAAOx5B,EAAO,CAAC,CAAC,IAEjB,CAACw5B,GAAOx5B,CAAM;AAAA,EACvB,GAED,OAAO,CAAC/W,MAAwCA,MAAM,YAAc,CAAC,GACtErH;AACK,WAAA,MAAMA,EAASm1B,CAAM;MACnBs+B,GAAU;AAMb,UAAAnuD,IAAM,OALC,MAAMk2B,GAAkBi4B,GAAU;AAAA,MAC7C,QAAQ;AAAA,MACR,SAAS,EAAE,gBAAgB,kCAAkC;AAAA,MAC7D,MAAM,KAAK,UAAUt+B,CAAM;AAAA,IAAA,CAC5B,GACsB,YAAY;AAC5B,WAAA,IAAI,WAAW7vB,CAAG;AAAA,EAAA;AAEnB,UAAA;AAEV;AAiCsB,eAAA4uD,GAEpB7D,GACA8D,GACA;AAAA,EACE,wBAAAC,IAAyB,MAAM,QAAQ,QAAQ,EAAE;AAAA,EACjD,gBAAA7D,IAAiB,MAAM;AAAA,EACvB,oBAAAn1B,IAAqB,CAAC,KAAK,eAAiB,EAAA,gBAAA,EAAkB,MAAM;AAAA,EACpE,aAAA1zB;AAAA,EACA,UAAAkX,IAAW,CAAC;AAAA,EACZ,YAAAg0C;AAAA,EACA,gBAAAC;AAAA,EACA,KAAA7xB;AAAA,EACA,aAAAsvB,IAAc;AAAA,EACd,iBAAA+D,IAAkB,IAAI,gBAAgB;AAAA,EACtC,mBAAAC;AAAA,EACA,mBAAAC;AAAA,EACA,gBAAAC;AAAA,EACA,oBAAAC;AAAA,EACA,cAAAjE;AAAA,EACA,eAAAC,IAAgB,YACd;AAAA,IACE,8BAA8BC,EAA0B;AAAA,EAEvD,EAAA,KAAK,CAACrrD,MAAQA,EAAI,YAAa,CAAA,EAC/B,KAAK,CAACC,MAAQ,IAAI,WAAWA,CAAG,CAAC;AAAA,EACtC,mBAAAqrD,IAAoB,YAClB,MAAM,kEAAkE,EACrE,KAAK,CAACtrD,MAAQA,EAAI,YAAa,CAAA,EAC/B,KAAK,CAACC,MAAQ,IAAI,WAAWA,CAAG,CAAC;AACxC,GACsD;AAElD,EAAA,OAAO,UAAY,OACdnC,GAAA,gBAAgB,KAAKkxD,EAAgB,MAAM;AAEhD,MAAAlgB;AACJ,EAAKggB,IAKM,OAAQA,EAA0B,WAAY,cACvD3sC,EAAI,MAAM,iCAAiC,GAClC2sB,IAAA,IAAII,GAAW4f,CAAwB,GAK/CA,EAA0B,GAAG,SAAS,MAAME,EAAgB,OAAO,MAEpE7sC,EAAI,MAAM,wBAAwB,GACzB2sB,IAAA,IAAIC,GAAU+f,CAA8B,MAdrD3sC,EAAI,MAAM,iBAAiB,GAC3B2sB,IAAS,IAAIG,GAAW;AAepB,QAAAogB,IAAiB,IAAIxgB,GAAeC,CAAM,GAC1CwgB,IAAS;AAAA,IACb,eAAe;AAAA,IACf,UAAU;AAAA,EACZ;AAGI,MAAA9D;AACA,EAAA,MAAM,QAAQN,CAAc,IAC9BM,IAAkB,CAACpzB,MAAa8yB,EAAe,QAAQ9yB,CAAQ,KAAK,IAElDozB,IAAAN;AAGhB,MAAAK,GACAvJ;AACA,EAAA,OAAOgJ,KAAkB,YACdO,IAAAP,GACGhJ,IAAA,MAAMxkB,GAAkB+tB,CAAU,MAK/CA,IAAAP,EAAyC,KAAK,KAC9CA,EAA2B,IACfhJ,IAAAgJ;AAEjB,QAAM10B,IAAW,MAAM/nB,EAAM,aAAag9C,GAAYvJ,CAAY;AAClE,MAAI,CAAC1rB;AACH,UAAM,IAAI,MAAM,gCAAgCi1B,CAAU,EAAE;AAGxD,QAAApJ,IAAc,EAAE,GAAG5oC,EAAS;AAClC,EAAI,CAAC4oC,EAAY,SAAS7rB,EAAS,UACjC6rB,EAAY,QAAQrsB;AAAA,IAClBQ,EAAS;AAAA,IACTP;AAAA,IACA;AAAA,EACF;AAGF,QAAM20B,IAAWn8C,EAAM;AAAA,IACrB+nB,EAAS,MAAM,OAAO,CAACn3B,MAAMqsD,EAAgBrsD,EAAE,EAAE,CAAC;AAAA,EACpD,GACM2iD,IAAU,CAAC,CAAC4I,EAAS,KAAK,CAACvrD,MAAM,CAAC,CAAC63B,GAAiB73B,CAAC,CAAC,GACtDm7C,IAASoQ,EAAS;AAAA,IAAI,CAACh8C,MAC3BA,EAAO,QAAQonB,GAAapnB,EAAO,OAAOqnB,GAAoB,IAAI,IAAI;AAAA,EACxE;AAGA,MAAI,CAACluB,MAAiB,CAAC8jD,MAA2B;AAChD,QAAI,CAAC9jD,IAAe;AACZ,YAAAnG,IAAO,MAAM0pD,EAAc;AACjC,MAAAhjD,GAAoB1G,CAAI;AAAA,IAAA;AAEtB,IAACiqD,GAAU,MACb,MAAMC,GAAqB,MAAM,QAAQ,QAAQ/jD,EAAc,CAAC,GAEvDsa,EAAI,MAAM,KAAKA,CAAG,GACnBA,EAAI,KAAK,KAAKA,CAAG,GACjBA,EAAI,KAAK,KAAKA,CAAG,GAChBA,EAAI,MAAM,KAAKA,CAAG,GAJ3B0pC;AAAAA,EAMF;AAIE1pC,EAAAA,EAAA,MAAM,yBAAyB8oC,CAAW,6BAA6B;AAC3E,QAAMpwD,IAAQ,IAAIinC,GAAO,EAAE,aAAAmpB,GAAa;AACxC,EAAA+D,EAAgB,OAAO,iBAAiB,SAAS,MAAMn0D,EAAM,SAAS;AAAA,IACpE,MAAM;AAAA,EAAA,CACP;AACK,QAAA4mD,IAAciJ,EAAS,IAAI7zB,EAAa,GACxC04B,IAAa7E,EAAS,IAAI,CAACvrD,GAAGI,MAC3B1E,EAAM,IAAI,YAAY;AACrB,UAAAkxD,KAAOtK,EAAYliD,CAAG,GACtBusD,KAAa,MAAM7uB,GAAgB99B,GAAG4sD,GAAK,QAAQ;AAAA,MACvD,aAAA1pD;AAAA,MACA,aAAas5B;AAAA,MACb,aAAaqzB,EAAgB;AAAA,IAAA,CAC9B;AAGD,WAAI7D,KACF,MAAM,QAAQ;AAAA,OACZW,MAAA,gBAAAA,GAAY,OAAO,IAAI,OAAO5uD,MAAM;AAC5B,cAAAgvD,KAAY,MAAM1B,GAAc;AAAA,UACpC,WAAW,IAAI,WAAWttD,EAAE,IAAK;AAAA,UACjC,aAAaA,EAAE,WAAW,SAAS,eAAe;AAAA,UAClD,GAAGiuD;AAAA,QAAA,CACJ;AACDhpC,QAAAA,EAAI,MAAM,6BAA6BjlB,EAAE,SAAS,EAAE,GACpDA,EAAE,OAAOgvD,GAAU,UACnBhvD,EAAE,SAAS;AAAA,MAAA,OACP,CAAA;AAAA,IACR,GAEK4uD;AAAA,EAAA,CACR,CACF,GAEKlK,IAAU,MAAM0K;AAAA,IACpBh2B;AAAA,IACAo0B;AAAA,IACA30B;AAAA,EACF,GACMu3B,IAAS,IAAI9L,GAAa;AAAA,IAC9B,QAAQ6N;AAAA,IACR,UAAUlN;AAAA,IACV,aAAauI,EAAS,IAAI,CAACvrD,GAAGI,OAAS;AAAA,MACrC,WAAWA;AAAA,MACX,GAAGkiD,EAAYliD,CAAG;AAAA,IAAA,EAClB;AAAA,IACF,UAAUw2B;AAAA,IACV,YAAYukB;AAAA,IACZ,SAAAsH;AAAA,IACA,SAAAE;AAAA,IACA,eAAe,MAAMrlB,GAAqBnG,CAAQ;AAAA,IAClD,kBACEA,EAAS,qBAAqB,kBAC1B,kBACA;AAAA,IACN,cAAA0rB;AAAA,IACA,aAAamN;AAAA,IACb,YAAYC;AAAA,EAAA,CACb;AACDjtC,EAAAA,EAAI,MAAM,6BAA6B,GACvC,MAAMmrC,EAAO,MAAM;AACnB,QAAMkC,IAAW,IAAIpC;AAAA,IACnB1C;AAAA,IACA2E;AAAA,IACA/B;AAAA,IACAC;AAAA,IACAC;AAAA,EACF;AAGA,MAFAgC,EAAS,aAAa,CAAC,GAEnBP,KAAqBC,GAAmB;AAC1C/sC,IAAAA,EAAI,MAAM,uBAAuB,GACxBqtC,EAAA,aAAa,GAAG,qBAAqB;AAC1C,QAAA;AACF,YAAMC,IAAgB,MAAMtB;AAAA,QAC1B73B;AAAA,QACAP;AAAA,QACAm5B;AAAA,QACAD;AAAA,MACF;AACA9sC,MAAAA,EAAI,MAAM,+BAA+B,GACnC,MAAAmrC,EAAO,iBAAiBmC,CAAa;AAAA,aACpCx6C,GAAK;AACRkN,YAAAA,EAAA,MAAM,qCAAqClN,CAAG,GAClD+5C,EAAgB,MAAM,GAChB/5C;AAAA,IAAA;AAAA,EACR;AAGO,EAAAu6C,EAAA,aAAa,GAAG,gBAAgB;AACzC,WAASvK,IAAY,GAAGA,IAAYyF,EAAS,QAAQzF,KAAa;AAC5D,QAAA+J,EAAgB,OAAO,SAAS;AAClC7sC,MAAAA,EAAI,MAAM,yDAAyD;AACnE;AAAA,IAAA;AAEE,QAAA;AACEA,MAAAA,EAAA,MAAM,gCAAgC8iC,CAAS,EAAE;AAC/C,YAAA6G,IAAa,MAAMyD,EAAWtK,CAAS;AAG7C,UAAI,CAAC6G;AACG,cAAA;AAER,YAAMp9C,KAASH,EAAM,IAAsBu9C,EAAW,MAAM,GACtDlF,KAAanF,EAAYwD,CAAS,GAClC,EAAE,QAAAC,GAAQ,KAAAvpB,IAAK,MAAAx0B,IAAM,aAAAkyB,IAAa,eAAAq2B,OAAkB5D;AACtD,UAAA4D,GAAc,SAAS,GAAG;AACxB,QAACJ,EAAO,iBACVA,EAAO,eAAe,CAAC;AAEzB,cAAMK,KAAa;AAAA,UACjB,aAAa1K;AAAA,UACb,WAAWyK,GAAc;AAAA,UACzB,UAAUxK,EAAO,SAASwK,GAAc;AAAA,UACxC,SAAS,OAAO;AAAA,YACdA,GAAc,IAAI,CAACzlD,MAAM;AAAA,cACvBA,EAAE,SAAS,MAAM;AAAA,cACjBA,EAAE,iBAAiB,QAAQA,EAAE,MAAM,aAAaA,EAAE;AAAA,YACnD,CAAA;AAAA,UAAA;AAAA,QAEL;AACO,QAAAqlD,EAAA,aAAa,KAAKK,EAAU,GACnCH,EAAS,iBAAiB;AAAA,UACxB,MAAM;AAAA,UACN,GAAGG;AAAA,QAAA,CACJ;AAAA,MAAA;AAEH,UAAI/I,GAAW,OAAO,EAACz/C,MAAA,QAAAA,GAAM,SAAQ;AAC/B,QAACmoD,EAAO,cACVA,EAAO,YAAY,CAAC;AAEtB,cAAMK,KAAa;AAAA,UACjB,aAAa1K;AAAA,UACb,QAAQ2B,GAAW,IAAI;AAAA,QACzB;AACO,QAAA0I,EAAA,UAAU,KAAKK,EAAU,GAChCH,EAAS,iBAAiB;AAAA,UACxB,MAAM;AAAA,UACN,GAAGG;AAAA,QAAA,CACJ;AAAA,MAAA;AAEH,YAAMC,KAAsB,MAAMb,EAAuBrgD,GAAO,EAAE;AAClE,UAAIkhD,MAAuB,MAAM;AACzB,cAAA/7B,KAAa,MAAM,QAAQ;AAAA,UAC/B+7B,GAAoB,IAAI,CAACruD,OACjB,QAAQA,MACZA,IAAIsuD,GAAqBtuD,CAAC,IAErBgN,EAAM,KAA2BhN,EAAE,IAAIA,CAAC,EAChD;AAAA,QACH;AACA,QAAIsyB,MAECA,GAAA,OAAO,CAACtyB,MAAiCA,MAAM,MAAS,EACxD,IAAI,CAACA,MAAMq1B,GAAgBr1B,GAAGw0B,CAAkB,CAAC,EACjD,OAAO,CAACx0B,MAAuBA,MAAM,MAAS,EAC9C,QAAQ,CAACA,MAAM83B,GAAY,KAAK93B,CAAC,CAAC;AAAA,MACvC;AAGI,YAAAg4B,KAAgBhxB,MAAA,gBAAAA,GAAS,uBAAuB;AAClD4Z,MAAAA,EAAA,MAAM,qBAAqB8iC,CAAS,WAAW,GACnD,MAAMqI,EAAO;AAAA,QACXxB,EAAW,OAAO;AAAA,QAClB,EAAE,OAAOp9C,GAAO,OAAO,QAAQA,GAAO,OAAO;AAAA,QAC7C,CAAC,GAAGw2C,GAAQ,GAAGwK,EAAa;AAAA,QAC5Br2B;AAAA,QACAlyB;AAAA,QACAw0B;AAAAA,MACF,GACgBpC,MAAA,QAAAA,MACPi2B,EAAA;AAAA,QACPtK,EAAO,OAAO,CAACxlD,IAAK4lD,MAAQ5lD,KAAM4lD,EAAI,QAAQA,EAAI,QAAQ,CAAC;AAAA,QAC3D52C,GAAO,QAAQA,GAAO;AAAA,MACxB,GACO4gD,EAAA;AAAA,aACAr6C,GAAK;AAEZ,YAAIA,MAAQ,aACNkN,EAAA,MAAM,yBAAyBlN,CAAG,GAExCpa,EAAM,MAAM,GACPm0D,EAAgB,OAAO,WAC1BA,EAAgB,MAAM,GAElB/5C;AAAA,IAAA,UACN;AACA,aAAOs6C,EAAWtK,CAAS;AAAA,IAAA;AAEpB,IAAAuK,EAAA,aAAavK,IAAY,CAAC;AAAA,EAAA;AAIrC9iC,EAAAA,EAAI,MAAM,gBAAgB;AACpB,QAAA2tC,KAAaxC,EAAO,IAAI;AAK1B,MAAA,CAAC0B,EAAgB,OAAO,SAAS;AACnC,QAAIe,IAAS;AACF,IAAAD,GAAA,KAAK,MAAOC,IAAS,EAAK;AACrC,UAAMC,IAAkB,YAAY;AAClC,UAAI,CAAAD;AAIG,aADEP,EAAA,aAAa9E,EAAS,QAAQ,WAAW,GAC3C,CAACqF,KAAUP,EAAS;AACzB,gBAAM1gB,EAAO,aAAa;AAAA,IAE9B;AAGA,IAAKihB,MACH,MAAMjhB,EAAO,aAAa,GAC1B,MAAMkhB,EAAgB;AAAA,EACxB;AAQF,SAJA7tC,EAAI,MAAM,8BAA8B,GAClC,MAAA2tC,IAENR,EAAO,gBAAgBD,EAAe,cAClCvgB,aAAkBG,KACb,EAAE,GAAGqgB,GAAQ,MAAMxgB,EAAO,KAAK,IAE/BwgB;AAEX;","x_google_ignoreList":[1,2,3,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,34,35,36,37,38,39,40,49,50,51,52,53,54,55,56,57]}
\ No newline at end of file
diff --git a/node_modules/pdiiif/dist/io.d.ts b/node_modules/pdiiif/dist/io.d.ts
new file mode 100644
index 0000000..3c4a888
--- /dev/null
+++ b/node_modules/pdiiif/dist/io.d.ts
@@ -0,0 +1,75 @@
+import { Writable as NodeWritable } from 'stream';
+import { default as nodeFs } from 'fs';
+
+/** Base interface to be implemented by all readers.  */
+export interface Reader {
+    read(dst: Uint8Array, offset: number, position: number, length: number): Promise<number>;
+    size(): Promise<number>;
+}
+/** Base interface to be implemented by all writers. */
+export interface Writer {
+    /** Write a chunk to the writer */
+    write(buffer: Uint8Array | string): Promise<void>;
+    /** Close the writer */
+    close(): Promise<void>;
+    /** Wait for the next drainage/flush event */
+    waitForDrain(): Promise<void>;
+}
+/** Reader implementation using the Web `File` API.  */
+export declare class WebReader implements Reader {
+    private file;
+    constructor(file: File);
+    read(dst: Uint8Array, offset: number, position: number, length: number): Promise<number>;
+    size(): Promise<number>;
+}
+/** Wraps a writer and counts the bytes written to it. */
+export declare class CountingWriter implements Writer {
+    private _writer;
+    bytesWritten: number;
+    constructor(writer: Writer);
+    write(buffer: string | Uint8Array): Promise<void>;
+    close(): Promise<void>;
+    waitForDrain(): Promise<void>;
+}
+/** A Writer implemented using the `File System Access API` available in
+ *  recent Chrome, Edge and Opera browsers. */
+export declare class WebWriter implements Writer {
+    private _writer;
+    constructor(stream: WritableStream);
+    write(buffer: string | Uint8Array): Promise<void>;
+    waitForDrain(): Promise<void>;
+    close(): Promise<void>;
+}
+/** Writer implementation using the `Blob` API available in all browsers. */
+export declare class BlobWriter implements Writer {
+    private _parts;
+    private _blob?;
+    constructor();
+    write(buffer: string | Uint8Array): Promise<void>;
+    waitForDrain(): Promise<void>;
+    close(): Promise<void>;
+    get blob(): Blob;
+}
+/** Reader implentation using the node.js filesystem API. */
+export declare class NodeReader implements Reader {
+    private fileHandle;
+    constructor(handle: nodeFs.promises.FileHandle);
+    read(dst: Uint8Array, offset: number, position: number, length: number): Promise<number>;
+    size(): Promise<number>;
+}
+/** Writer implementation using the node.js filesystem API. */
+export declare class NodeWriter implements Writer {
+    _writable: NodeWritable;
+    _drainWaiters: Array<() => void>;
+    constructor(writable: NodeWritable);
+    write(buffer: string | Uint8Array): Promise<void>;
+    waitForDrain(): Promise<void>;
+    close(): Promise<void>;
+}
+/** Very basic Reader implementation using an Array. */
+export declare class ArrayReader implements Reader {
+    _buf: Uint8Array;
+    constructor(buf: Uint8Array);
+    read(dst: Uint8Array, offset: number, position: number, length: number): Promise<number>;
+    size(): Promise<number>;
+}
diff --git a/node_modules/pdiiif/dist/log.d.ts b/node_modules/pdiiif/dist/log.d.ts
new file mode 100644
index 0000000..b7f6e12
--- /dev/null
+++ b/node_modules/pdiiif/dist/log.d.ts
@@ -0,0 +1,21 @@
+type LogLevel = 'debug' | 'info' | 'warn' | 'error';
+export interface Logger {
+    setLevel(level: LogLevel): void;
+    debug(message: string, ...args: any[]): void;
+    info(message: string, ...args: any[]): void;
+    warn(message: string, ...args: any[]): void;
+    error(message: string, ...args: any[]): void;
+}
+/** Simple logger that simply outputs to the console */
+export declare class ConsoleLogger implements Logger {
+    private level;
+    constructor(level?: LogLevel);
+    setLevel(level: LogLevel): void;
+    debug(message: string, ...args: any[]): void;
+    info(message: string, ...args: any[]): void;
+    warn(message: string, ...args: any[]): void;
+    error(message: string, ...args: any[]): void;
+}
+declare let logger: Logger;
+export declare function setLogger(newLogger: Logger): void;
+export { logger as default };
diff --git a/node_modules/pdiiif/dist/metrics.d.ts b/node_modules/pdiiif/dist/metrics.d.ts
new file mode 100644
index 0000000..a46b786
--- /dev/null
+++ b/node_modules/pdiiif/dist/metrics.d.ts
@@ -0,0 +1,10 @@
+import { Histogram } from 'prom-client';
+
+type Metrics = {
+    pageGenerationDuration: Histogram<string>;
+    imageFetchDuration: Histogram<string>;
+    imageInfoDuration: Histogram<string>;
+    ocrFetchDuration: Histogram<string>;
+} | undefined;
+declare let metrics: Metrics;
+export default metrics;
diff --git a/node_modules/pdiiif/dist/ocr.d.ts b/node_modules/pdiiif/dist/ocr.d.ts
new file mode 100644
index 0000000..3b34080
--- /dev/null
+++ b/node_modules/pdiiif/dist/ocr.d.ts
@@ -0,0 +1,36 @@
+import { Annotation } from '@iiif/presentation-3';
+import { AnnotationNormalized, CanvasNormalized } from '@iiif/presentation-3-normalized';
+import { OcrPage, Dimensions } from 'ocr-parser';
+import { ExternalWebResourceWithProfile } from './iiif.js';
+
+export type OcrPageWithMarkup = OcrPage & {
+    id: string;
+    markup: string;
+    mimeType: string;
+};
+/**
+ * Parse an OCR document (currently hOCR or ALTO)
+ *
+ * @param {string} ocrText  ALTO or hOCR markup
+ * @param {object} referenceSize Reference size to scale coordinates to
+ * @returns {OcrPage} the parsed OCR page
+ */
+export declare function parseOcr(id: string, ocrText: string, referenceSize: Dimensions): Promise<OcrPageWithMarkup | null>;
+/** Parse OCR data from IIIF annotations.
+ *
+ * Annotations should be pre-filtered so that they all refer to a single canvas/page.
+ * Annotations should only contain a single text granularity, that is either line or word.
+ *
+ * @param {object} annos IIIF annotations with a plaintext body and line or word granularity
+ * @param {Dimensions} imgSize Reference width and height of the rendered target image
+ * @returns {OcrPage} parsed OCR boxes
+ */
+export declare function parseIiifAnnotations(annos: Array<Annotation>, imgSize: Dimensions): OcrPage;
+/** Fetch external annotation resource JSON */
+export declare function fetchAnnotationResource(url: string): Promise<any>;
+/** Retrieve a supported OCR references from a Canvas' `seeAlso` or `rendering`, if present.
+ *
+ * 'Supported' currently means external ALTO or hOCR markup.
+ */
+export declare function getOcrReferences(canvas: CanvasNormalized): ExternalWebResourceWithProfile | undefined;
+export declare function fetchAndParseText(canvas: CanvasNormalized, annotations?: AnnotationNormalized[]): Promise<OcrPageWithMarkup | undefined>;
diff --git a/node_modules/pdiiif/dist/optimization.d.ts b/node_modules/pdiiif/dist/optimization.d.ts
new file mode 100644
index 0000000..2eba4b8
--- /dev/null
+++ b/node_modules/pdiiif/dist/optimization.d.ts
@@ -0,0 +1,48 @@
+import { EncodeOptions } from '@jsquash/jpeg/meta';
+
+export type InitializationRequest = {
+    mozjpegWasm: Uint8Array;
+};
+export type TaskDescription<I> = {
+    id: string;
+    data: I;
+};
+export type WorkerMessage<I, O> = {
+    input: {
+        id: string;
+        data: I;
+    };
+    result: O;
+};
+export type WorkerTask<I, O> = {
+    resolve: (value: O) => void;
+    reject: (reason: any) => void;
+    task: TaskDescription<I>;
+};
+export type MozJPEGParams = {
+    method: 'mozjpeg';
+    quality: number;
+} & Partial<EncodeOptions>;
+export type BrowserEncoderParams = {
+    method: 'browser';
+    quality: number;
+};
+export type OptimizationParams = MozJPEGParams | BrowserEncoderParams;
+export type OptimizationRequest = {
+    imageData: Uint8Array;
+    imageFormat: 'image/jpeg' | 'image/png';
+} & OptimizationParams;
+export type OptimizedImage = {
+    jpegData: Uint8Array;
+    sizeFactor: number;
+};
+export declare class OptimizationError extends Error {
+    taskId: string;
+    cause?: unknown | undefined;
+    constructor(message: string, taskId: string, cause?: unknown | undefined);
+}
+export declare const MOZJPEG_DEFAULT_PARAMS: EncodeOptions;
+export declare function startWorkerPool(size?: number): void;
+export declare function stopWorkerPool(): void;
+export declare function initialize(wasmLoader: () => Promise<Uint8Array>): Promise<void>;
+export declare function optimizeImage(params: OptimizationRequest): Promise<OptimizedImage>;
diff --git a/node_modules/pdiiif/dist/optimization.worker.d.ts b/node_modules/pdiiif/dist/optimization.worker.d.ts
new file mode 100644
index 0000000..cb0ff5c
--- /dev/null
+++ b/node_modules/pdiiif/dist/optimization.worker.d.ts
@@ -0,0 +1 @@
+export {};
diff --git a/node_modules/pdiiif/dist/pdf/annos.d.ts b/node_modules/pdiiif/dist/pdf/annos.d.ts
new file mode 100644
index 0000000..1c5d0d7
--- /dev/null
+++ b/node_modules/pdiiif/dist/pdf/annos.d.ts
@@ -0,0 +1,4 @@
+import { PdfDictionary } from './common.js';
+import { Annotation } from '../iiif.js';
+
+export declare function exportPdfAnnotation(anno: Annotation, unitScale: number, pageHeight: number): Array<PdfDictionary>;
diff --git a/node_modules/pdiiif/dist/pdf/common.d.ts b/node_modules/pdiiif/dist/pdf/common.d.ts
new file mode 100644
index 0000000..412e9d0
--- /dev/null
+++ b/node_modules/pdiiif/dist/pdf/common.d.ts
@@ -0,0 +1,48 @@
+export interface Metadata {
+    Producer?: string;
+    Creator?: string;
+    CreationDate?: Date;
+    Title?: string;
+    Author?: string;
+    Keywords?: string;
+    ModDate?: Date;
+}
+export interface PdfObject {
+    num: number;
+    data?: PdfValue;
+    stream?: Uint8Array | string;
+}
+export declare class PdfRef {
+    refObj: number;
+    constructor(num: number);
+}
+export type PdfPrimitive = string | number | boolean | Uint8Array | null | Date | PdfRef;
+export interface PdfDictionary {
+    [member: string]: PdfPrimitive | PdfArray | PdfDictionary;
+}
+export type PdfArray = Array<PdfPrimitive | PdfArray | PdfDictionary>;
+export type PdfValue = PdfPrimitive | PdfDictionary | PdfArray | null;
+export interface PdfAnnotation {
+    Type: 'Annot';
+    Subtype: string;
+    Rect: [number, number, number, number];
+    Contents: string | undefined;
+    P?: PdfRef;
+    NM?: string;
+    M?: Date;
+    F?: number;
+    AP?: PdfDictionary;
+    AS?: string;
+    Border?: [number, number, number] | [number, number, number, number];
+    C?: [] | [number] | [number, number, number] | [number, number, number, number];
+}
+export interface StructTreeEntry {
+    type: 'Sect' | 'P' | 'Span';
+    children: Array<StructTreeEntry>;
+    pageObjNum: number;
+    mcs: Array<number>;
+}
+export declare function makeRef(target: number | PdfObject): PdfRef;
+/** Convert a JS UTF8 string to a UTF16 Big Endian string */
+export declare function toUTF16BE(str: string, includeBom?: boolean): Uint8Array;
+export declare function serialize(value: PdfValue, dictIndent?: number): string;
diff --git a/node_modules/pdiiif/dist/pdf/generator.d.ts b/node_modules/pdiiif/dist/pdf/generator.d.ts
new file mode 100644
index 0000000..d8e3f27
--- /dev/null
+++ b/node_modules/pdiiif/dist/pdf/generator.d.ts
@@ -0,0 +1,192 @@
+import { Manifest } from '@iiif/presentation-3';
+import { Manifest as ManifestV2 } from '@iiif/presentation-2';
+import { OcrLine } from 'ocr-parser';
+import { Metadata, PdfObject, PdfRef, PdfValue, StructTreeEntry } from './common.js';
+import { TocItem } from './util.js';
+import { Writer } from '../io.js';
+import { OcrPageWithMarkup } from '../ocr.js';
+import { CanvasImage, ImageFetchFailure, StartCanvasInfo } from '../download.js';
+import { Annotation, CanvasInfo } from '../iiif.js';
+import { OptimizationParams } from '../optimization.js';
+
+export type GeneratorParams = {
+    writer: Writer;
+    metadata: Metadata;
+    canvasInfos: CanvasInfo[];
+    langPref: readonly string[];
+    pageLabels?: string[];
+    outline: TocItem[];
+    hasText?: boolean;
+    readingDirection?: 'right-to-left' | 'left-to-right';
+    initialCanvas?: StartCanvasInfo;
+    manifestJson?: Manifest | ManifestV2;
+    zipPolyglot?: boolean;
+    zipBaseDir?: string;
+    optimization?: OptimizationParams;
+};
+/** Streaming PDF generator based on a IIIF manifest.
+ *
+ * This class is responsible for generating a PDF document based on a IIIF manifest.
+ * It is designed to be used in a streaming fashion, i.e. it can start writing the PDF
+ * before all the resources have been loaded and thus does not require a huge amount
+ * of memory. On the flipside, this makes the code a lot more complex, since we need
+ * to keep track of the PDF's internal state and write objects in the correct order.
+ * Another complication is that we want to write out the catalog and page tree first
+ * to allow viewers to quickly display the first page, which requires a bunch of
+ * complicated pre-allocation of objects.
+ *
+ * FIXME: Can't we just write the pages first and then the catalog and page tree at
+ *        the end of the file? Would make things *A LOT* easier and less complex and
+ *        error-prone.
+ */
+export default class PDFGenerator {
+    _offset: number;
+    _objects: Array<PdfObject>;
+    _nextObjNo: number;
+    _objRefs: Record<string, PdfRef>;
+    _offsets: number[];
+    _writer: Writer | undefined;
+    _pagesStarted: boolean;
+    _canvasInfos: Array<CanvasInfo>;
+    _firstPageObjectNum: number | undefined;
+    _pageLabels?: string[];
+    _numCoverPages: number;
+    _outline: TocItem[];
+    _hasText: boolean;
+    _strucTree: StructTreeEntry[];
+    _pageMCIds: Map<number, Array<number>>;
+    _nextStructParentId: number;
+    _pageParentIds: Map<number, number>;
+    _langPref: readonly string[];
+    _initialCanvas?: StartCanvasInfo;
+    private _polyglot;
+    private _manifestJson?;
+    private _zipCatalog?;
+    private _zipBaseDir?;
+    private _readingDirection;
+    private _deferredReferences;
+    /** Just basic setup of state, real setup is done in setup()
+        method since we need to call a bunch of async stuff */
+    constructor({ writer, metadata, canvasInfos, langPref, pageLabels, outline, readingDirection, hasText, initialCanvas, manifestJson, zipPolyglot, zipBaseDir, }: GeneratorParams);
+    /** Set up the basic PDF document, creating neccessary objects.  */
+    setup(): Promise<void>;
+    /** Set up neccessary fonts for the hidden text layer. */
+    _setupHiddenTextFont(): Promise<void>;
+    /** Register embedded OCR files in the PDF's catalog object. */
+    _registerEmbeddedFilesInCatalog(): void;
+    /** Create a PdfRef whose value is deferred, i.e. will be set at a later stage.
+     *
+     * Useful for bidirectional references.
+     *
+     * Prevents serialization of objects containing this reference as long as the
+     * value is not set.
+     *
+     * @param key A unique key to identify the reference
+     */
+    _makeDeferredReference(key: string): PdfRef;
+    /** Add items to the PDF's outline, based on the passed TocItem tree.
+     *
+     * @param itm The item we want to add to the outline
+     * @param parent The parent outline item
+     * @param prev The preceding sibling outline item, if present
+     * @returns A tuple containing the object reference of the added outline item and the number
+     *         of children outline items that were created
+     */
+    _addOutline(itm: TocItem, parent: PdfObject, prev?: PdfObject): [PdfObject, number];
+    /** Add a new object to the PDF document.
+     *
+     * @param val A PDF value, can be any of the supported types.
+     * @param refName An optional name to reference the object by.
+     * @param stream An optional stream to attach to the object, value must be adictionary in this case
+     * @returns The created object
+     */
+    _addObject(val: PdfValue, refName?: string, stream?: Uint8Array | string): PdfObject;
+    /** Clone an object from a foreign PDF into the current PDF, adjusting
+     *  the encountered indirect object references.
+     *
+     * @param parser PdfParser instance for the PDF the object is from
+     * @param obj The object to transplant into our document
+     * @param seenObjects A map of object numbers to known references, used to avoid
+     *                    infinite recursion
+     * @returns A reference to the transplanted object
+     */
+    private _transplantObject;
+    /** Insert cover pages from another PDF into our document. */
+    insertCoverPages(pdfData: ArrayBuffer): Promise<void>;
+    /** Embed a file resource in the PDF.
+     *
+     * @param filename The filename for the embedded resource
+     * @param description A description of the file
+     * @param mimeType The MIME type of the file
+     * @param data The data to embed
+     */
+    private _embedResource;
+    /** Embed the IIIF Manifest JSON in the PDF.
+     *
+     * @param manifestJson The IIIF (v2 or v3) Manifest to embed
+     */
+    private _embedManifest;
+    /** Once all setup is complete and we begin rendering pages into the document,
+     *  we need to finalize the PDF header with the remaining information.
+     */
+    finalizePdfHeader(): Promise<void>;
+    /** Render a new page, based on a IIIF canvas, its associated annotations and OCR text.
+     *
+     * @param canvasId The ID of the canvas to render
+     * @param width The width of the canvas in pixels
+     * @param height The height of the canvas in pixels
+     * @param images The images to render on the canvas
+     * @param annotations The annotations to render on the canvas
+     * @param ocrText The OCR text to render on the canvas
+     * @param ppi The resolution of the canvas in pixels per inch, used to determine the physical
+     *            size of the PDF page. Assumes 300ppi by default.
+     */
+    renderPage(canvasId: string, { width: canvasWidth, height: canvasHeight, }: {
+        width: number;
+        height: number;
+    }, images: (CanvasImage | ImageFetchFailure)[], annotations: Annotation[], ocrText?: OcrPageWithMarkup, ppi?: number): Promise<void>;
+    /** Get PDF instructions to render a hidden text layer with the page's OCR.
+     *
+     * This owes *a lot* to Tesseract's PDF renderer[1] and the IA's `pdf-tools`[2]
+     * that ported it to Python. Accordingly, the license of this method is Apache 2.0.
+     *
+     * [1] https://github.com/tesseract-ocr/tesseract/blob/5.0.0-beta-20210916/src/api/pdfrenderer.cpp
+     * [2] https://github.com/internetarchive/archive-pdf-tools/blob/master/internetarchivepdf/pdfrenderer.py
+     *
+     *                            Apache License
+     *                     Version 2.0, January 2004
+     *                  http://www.apache.org/licenses/
+     */
+    _renderOcrText(ocr: OcrPageWithMarkup, unitScale: number): string;
+    /** Get PDF instructions to render a single line of OCR text. */
+    renderOcrLine(line: OcrLine, lineIdx: number, unitScale: number, pageHeight: number, pageObjNum: number): string[];
+    /** How many bytes have we written to the output so far? */
+    get bytesWritten(): number;
+    /** Number of objects needed to render all canvases */
+    get totalCanvasObjects(): number;
+    /** How many objects are needed to render the canvas at the given index? */
+    getObjectsPerCanvas(canvasIdx: number): number;
+    /** Get the object number for the canvas at the given index. */
+    getCanvasObjectNumber(canvasIdx: number): number;
+    /** Flush remaining data to output. */
+    _flush(): Promise<void>;
+    /** Get the serialized size in bytes of a PDF object. */
+    _getSerializedSize({ num, data, stream }: PdfObject, untilStreamStart?: boolean): number;
+    /** Serialize a PDF object to the output. */
+    _serializeObject(obj: PdfObject): Promise<void>;
+    /** Write data to the output. */
+    _write(data: Uint8Array | string): Promise<void>;
+    /** Write the PDF objects required for the structure tree */
+    _writeStructureTree(): Promise<void>;
+    /** Finish writing the PDF and close the writer.
+     *
+     * Writes XRef table, trailer and EOF marker to the output.
+     * Also adds ZIP central directory if polyglot PDF is enabled.
+     */
+    end(): Promise<void>;
+    /** Insert a 'dummy' PDF object that isn't referenced anywhere, but which
+     *  contains the data neccessary to expose the following object's data as a
+     *  file in the ZIP archive.
+     */
+    private _insertZipHeaderDummyObject;
+}
diff --git a/node_modules/pdiiif/dist/pdf/image.d.ts b/node_modules/pdiiif/dist/pdf/image.d.ts
new file mode 100644
index 0000000..1c2dd12
--- /dev/null
+++ b/node_modules/pdiiif/dist/pdf/image.d.ts
@@ -0,0 +1,34 @@
+import { PdfObject } from './common.js';
+import { default as PNG } from './png.js';
+
+declare abstract class PdfImage {
+    static open(data: Uint8Array): PdfImage;
+    abstract toObjects(startNum: number, isOptional?: boolean, optionalTitle?: string, optionalDefaultState?: boolean): Array<PdfObject>;
+}
+export declare class JPEGImage extends PdfImage {
+    static MARKERS: number[];
+    static COLOR_SPACE_MAP: {
+        1: string;
+        3: string;
+        4: string;
+    };
+    data: Uint8Array;
+    bits: number;
+    width: number;
+    height: number;
+    colorSpace: string;
+    constructor(data: Uint8Array);
+    toObjects(startNum: number): Array<PdfObject>;
+}
+export declare class PNGImage extends PdfImage {
+    label: string | undefined;
+    image: PNG;
+    width: number;
+    height: number;
+    imgData: Uint8Array;
+    constructor(data: Uint8Array, label?: string);
+    toObjects(startNum: number): Array<PdfObject>;
+    splitAlphaChannel(objNum: number): [Uint8Array, PdfObject];
+    loadIndexedAlphaChannel(objNum: number): PdfObject;
+}
+export default PdfImage;
diff --git a/node_modules/pdiiif/dist/pdf/parser.d.ts b/node_modules/pdiiif/dist/pdf/parser.d.ts
new file mode 100644
index 0000000..a08494d
--- /dev/null
+++ b/node_modules/pdiiif/dist/pdf/parser.d.ts
@@ -0,0 +1,131 @@
+import { Reader } from '../io.js';
+import { PdfObject, PdfValue, PdfDictionary, PdfRef } from './common.js';
+
+/** Parse a PDF "value", which can be one of:
+ * - number (integer or float)
+ * - string
+ * - name (represented as a JS string starting with `/`)
+ * - boolean
+ * - null
+ * - date
+ * - XRef
+ * - Array
+ * - Dictionary
+ *
+ * API walkthrough:
+ * - `read()` is the main entry point, it will read the next value from the
+ *   buffer and advance the cursor
+ *  - `match*` methods check if the buffer at the current offset matches a
+ *    certain type of value, either returning a boolean or the section of the
+ *    buffer containing the value as a string.
+ *  - `read*` methods read a value of a specific type from the buffer and
+ *    advance the cursor
+ */
+export declare class PdfValueParser {
+    start: number;
+    current: number;
+    private readonly buf;
+    /** Construct a parser for a buffer containing one or more PDF values. */
+    constructor(buf: Uint8Array);
+    /** Get the buffer content at the current offset as a character. */
+    private getChar;
+    /** Compares the buffer contents at the current offset against a string value. */
+    private matchValue;
+    /** Checks if the buffer at the current offset contains a number.
+     *
+     * See ISO32000-2:2020 section 7.3.3.
+     */
+    private matchInteger;
+    /** Read a PDF value from the current offset, advancing the cursor. */
+    read(): PdfValue;
+    /** Check if the input string contains PDF whitespace.
+     *
+     * See ISO32000-2:2020 section 7.2.3, Table 1.
+     */
+    matchWhiteSpace(c: string): boolean;
+    /** Read an integer from the current offset. */
+    readInteger(): number;
+    /** Read an indirect object from the current offset. */
+    readIndirectObject(): PdfRef;
+    /** Check if the buffer contains an indirect object at the current offset.
+     *
+     * See ISO32000-2:2020 section 7.3.10.
+     */
+    matchIndirectObject(resetAfter?: boolean): string | undefined;
+    /** Check if the buffer contains a real number at the current offset.
+     *
+     * See ISO32000-2:2020 section 7.3.3.
+     */
+    matchRealNumber(resetAfter?: boolean): string | undefined;
+    /** Read a real number from the current offset. */
+    readRealNumber(): number;
+    /** Skip a contiguous sequence of whitespae, advancing the cursor. */
+    skipWhiteSpace(): boolean;
+    /** Check if we're at the end of the buffer. */
+    atEnd(): boolean;
+    /** Read a name from the current offset.
+     *
+     * See ISO32000-2:2020 section 7.3.5.
+     */
+    readName(): PdfValue;
+    /** Check if the current offset contains a delimiter.
+     *
+     * See ISO32000-2:2020 section 7.2.3, Table 2
+     */
+    matchDelimiter(c: string): boolean;
+    /** Read a hex string from the current offset.
+     *
+     * See ISO32000-2:2020 section 7.3.4.3
+     */
+    readHexString(): PdfValue;
+    /** Read a literal string from the current offset.
+     *
+     * See ISO32000-2:2020 section 7.3.4.2
+     */
+    readLiteralString(): PdfValue;
+    /** Read a dictionary from the current offset.
+     *
+     * See ISO32000-2:2020 section 7.3.7
+     */
+    readDict(): PdfValue;
+    /** Read an array from the current offset.
+     *
+     * See ISO32000-2:2020 section 7.3.6
+     */
+    readArray(): Array<PdfValue>;
+}
+/** Minimalist low-level PDF parser operating on a Reader object.
+ *
+ * Currently only supports discovering page objects and annotation objects, as well
+ * as obtaining arbitrary objects given the object number and generation.
+ */
+export declare class PdfParser {
+    private reader;
+    private objectOffsets;
+    private sortedOffsets;
+    pdfSize: any;
+    objGenerations: number[];
+    infoNum: number;
+    catalogNum: number;
+    /** Construct a new parser from a Reader.
+     *
+     * Used instead of the constructor to allow for async initialization.
+     */
+    static parse(reader: Reader): Promise<PdfParser>;
+    /** Private constructor, use factory method above. */
+    private constructor();
+    /** Retrieve the catalog dictionary. */
+    catalog(): Promise<PdfDictionary>;
+    /** Retrieve the info dictionary. */
+    info(): Promise<PdfDictionary>;
+    /** Yield all pages referenced in the given page dictionary. */
+    _pagesFromPagesObj(pagesObj: PdfDictionary): AsyncGenerator<PdfObject>;
+    /** Yield all pages in the PDF. */
+    pages(): AsyncGenerator<PdfObject>;
+    /** Yield all annotations for the given page dictionary. */
+    annotations(pageDict: PdfDictionary): AsyncGenerator<PdfDictionary>;
+    /** Resolve a PDF reference to the corresponding object. */
+    resolveRef(ref: PdfRef): Promise<PdfObject | undefined>;
+    /** Get an object from the PDF from its number. */
+    getObject(num: number, withStream?: boolean): Promise<PdfObject | undefined>;
+}
diff --git a/node_modules/pdiiif/dist/pdf/pkzip.d.ts b/node_modules/pdiiif/dist/pdf/pkzip.d.ts
new file mode 100644
index 0000000..b64fe68
--- /dev/null
+++ b/node_modules/pdiiif/dist/pdf/pkzip.d.ts
@@ -0,0 +1,23 @@
+export type LocalHeaderParams = {
+    creationDate?: Date;
+    filename: string;
+    data: Uint8Array;
+    compressedData?: Uint8Array;
+    extraDataLength: number;
+};
+export type CentralDirectoryFileSpec = {
+    localHeaderOffset: number;
+    deflated: boolean;
+    creationDate: Date;
+    crc32: number;
+    dataLength: number;
+    compressedDataLength: number;
+    filename: string;
+};
+export type CentralFileDirectorySpec = {
+    files: CentralDirectoryFileSpec[];
+    trailingLength: number;
+    offset: number;
+};
+export declare function buildLocalZipHeader({ creationDate, filename, data, compressedData, extraDataLength, }: LocalHeaderParams): Uint8Array;
+export declare function buildCentralFileDirectory({ files, trailingLength, offset }: CentralFileDirectorySpec): Uint8Array;
diff --git a/node_modules/pdiiif/dist/pdf/png.d.ts b/node_modules/pdiiif/dist/pdf/png.d.ts
new file mode 100644
index 0000000..9835ef4
--- /dev/null
+++ b/node_modules/pdiiif/dist/pdf/png.d.ts
@@ -0,0 +1,34 @@
+export type ColorSpace = 'DeviceGray' | 'DeviceRGB';
+export default class PNG {
+    static load: (data: Uint8Array) => PNG;
+    palette: number[];
+    imgData: Uint8Array;
+    transparency: {
+        indexed?: number[];
+        grayscale?: number;
+        rgb?: number[];
+    };
+    text: {
+        [key: string]: string;
+    };
+    width: number;
+    height: number;
+    bits: number;
+    colorType: number;
+    compressionMethod: number;
+    filterMethod: number;
+    interlaceMethod: number;
+    colors: 1 | 3;
+    hasAlphaChannel: boolean;
+    pixelBitlength: number;
+    colorSpace: ColorSpace;
+    private data;
+    private pos;
+    constructor(data: Uint8Array);
+    decode: () => Uint8Array<ArrayBuffer>;
+    copyImageDataToBuffer: (imageData: Uint8Array, pixels: Uint8Array) => void;
+    decodePixels: () => Uint8Array;
+    private read;
+    private readUInt32;
+    private decodePalette;
+}
diff --git a/node_modules/pdiiif/dist/pdf/util.d.ts b/node_modules/pdiiif/dist/pdf/util.d.ts
new file mode 100644
index 0000000..d68a185
--- /dev/null
+++ b/node_modules/pdiiif/dist/pdf/util.d.ts
@@ -0,0 +1,18 @@
+import { default as util } from 'util';
+import { StartCanvasInfo } from '../download.js';
+import { PdfDictionary } from './common.js';
+
+export declare let textEncoder: TextEncoder | util.TextEncoder;
+export declare let textDecoder: TextDecoder | util.TextDecoder;
+export declare const IS_BIG_ENDIAN: boolean;
+export interface TocItem {
+    label: string;
+    children?: Array<TocItem>;
+    startCanvas: StartCanvasInfo;
+}
+export declare function getNumChildren(itm: TocItem): number;
+export declare function randomData(length: number): Uint8Array;
+export declare function tryDeflateStream(pdfStream: Uint8Array | string): Promise<{
+    stream: Uint8Array | string;
+    dict: PdfDictionary;
+}>;
diff --git a/node_modules/pdiiif/dist/res/licenses.d.ts b/node_modules/pdiiif/dist/res/licenses.d.ts
new file mode 100644
index 0000000..2120fb9
--- /dev/null
+++ b/node_modules/pdiiif/dist/res/licenses.d.ts
@@ -0,0 +1,7 @@
+export interface LicenseDescription {
+    text: string;
+    logo: string;
+}
+export type LicenseList = Record<string, LicenseDescription>;
+export declare const licenses: LicenseList;
+export declare function getLicenseInfo(uri: string): LicenseDescription | null;
diff --git a/node_modules/pdiiif/dist/res/srgbColorspace.d.ts b/node_modules/pdiiif/dist/res/srgbColorspace.d.ts
new file mode 100644
index 0000000..76386ae
--- /dev/null
+++ b/node_modules/pdiiif/dist/res/srgbColorspace.d.ts
@@ -0,0 +1,2 @@
+/** sRGB color profile in ICM format, taken from https://github.com/bencomp/pdfx-ext. */
+export declare const sRGBIEC1966_21: Uint8Array<ArrayBuffer>;
diff --git a/node_modules/pdiiif/dist/util.d.ts b/node_modules/pdiiif/dist/util.d.ts
new file mode 100644
index 0000000..4f262a2
--- /dev/null
+++ b/node_modules/pdiiif/dist/util.d.ts
@@ -0,0 +1,8 @@
+export declare let saxParserWasm: Uint8Array | null;
+/** Get a timestamp in milliseconds, prefereably high-resolution */
+export declare function now(): number;
+export declare function isDefined<T>(val: T | undefined | null | void): val is T;
+export declare function crc32(data: Uint8Array): number;
+export declare function runningInNode(): boolean;
+export declare function initializeSaxParser(parserWasm: Uint8Array): void;
+export declare function randomUUIDv4(): string;
diff --git a/node_modules/pdiiif/dist/version.d.ts b/node_modules/pdiiif/dist/version.d.ts
new file mode 100644
index 0000000..1b144ce
--- /dev/null
+++ b/node_modules/pdiiif/dist/version.d.ts
@@ -0,0 +1,2 @@
+declare const _default: "0.2.6";
+export default _default;
diff --git a/node_modules/pdiiif/src/__tests__/pdf.spec.ts b/node_modules/pdiiif/src/__tests__/pdf.spec.ts
index 8c40af6..72d4ed2 100644
--- a/node_modules/pdiiif/src/__tests__/pdf.spec.ts
+++ b/node_modules/pdiiif/src/__tests__/pdf.spec.ts
@@ -90,7 +90,8 @@ describe('PDF generation', () => {
             enabled: true,
             optional: false,
             visibleByDefault: true
-          }
+          },
+          format: 'jpeg',
         },
       ],
       [],
diff --git a/node_modules/pdiiif/src/convert.ts b/node_modules/pdiiif/src/convert.ts
index 4655404..99502e6 100644
--- a/node_modules/pdiiif/src/convert.ts
+++ b/node_modules/pdiiif/src/convert.ts
@@ -3,20 +3,23 @@ import type { Writable } from 'stream';
 import {
   Manifest,
   RangeItems,
-  ManifestNormalized,
-  CanvasNormalized,
-  RangeNormalized,
   Reference,
   IIIFExternalWebResource,
   ContentResource,
   Service,
   ImageService,
-  AnnotationNormalized,
-  ResourceProviderNormalized,
   Annotation as IIIF3Annotation,
 } from '@iiif/presentation-3';
+import {
+  ManifestNormalized,
+  CanvasNormalized,
+  RangeNormalized,
+  AnnotationNormalized,
+  ResourceProviderNormalized,
+  NormalizedRangeItemSchemas,
+} from '@iiif/presentation-3-normalized';
 import Presentation2 from '@iiif/presentation-2';
-import { convertPresentation2 } from '@iiif/parser/presentation-2';
+import { upgrade as convertPresentation2 } from '@iiif/parser/upgrader';
 import PQueue from 'p-queue';
 import events from 'events';
 import * as ocrParser from 'ocr-parser';
@@ -52,6 +55,11 @@ import {
   parseAnnotation,
   Annotation,
 } from './iiif.js';
+import {
+  initialize,
+  OptimizationParams,
+  optimizeImage,
+} from './optimization.js';
 
 /** Progress information for rendering a progress bar or similar UI elements. */
 export interface ProgressStatus {
@@ -163,6 +171,15 @@ export interface ConvertOptions {
    *  from `ocr-parser` has been called before.
    */
   saxWasmLoader?: () => Promise<Uint8Array>;
+  /** Custom loader callback that fetches the WASM binary for the `@jsquash/jpeg`
+   * dependency (v1.5.0). By default the dependency will be loaded from
+   * `https://unpkg.com/@jsquash/jpeg@1.5.0/codec/enc/mozjpeg_enc.wasm`. Override
+   * if you want to provide your own payload. Loader will not be called if
+   * {@link optimization} is not set to use the `mozjpeg` method.
+   */
+  mozjpegWasmLoader?: () => Promise<Uint8Array>;
+  /** Parameters for optimizing the images for size by re-encoding them to JPEGs. */
+  optimization?: OptimizationParams;
 }
 
 /** Parameters for size estimation */
@@ -182,6 +199,24 @@ export interface EstimationParams {
   numSamples?: number;
   /** Number of maximum concurrent IIIF Image API requests to be performed, defaults to 1 */
   concurrency?: number;
+  /** Parameters for optimizing the images for size by re-encoding them to JPEGs. */
+  optimization?: OptimizationParams;
+  /** Custom loader callback that fetches the WASM binary for the `sax-wasm`
+   *  dependency (v2.2.4). By default, the dependency will be loaded from
+   *  `https://unpkg.com/sax-wasm/dist/sax-wasm.wasm`. Override if you want
+   *  to provide your own payload. Loader will not be called if {@link initialize}
+   *  from `ocr-parser` has been called before.
+   */
+  saxWasmLoader?: () => Promise<Uint8Array>;
+  /** Custom loader callback that fetches the WASM binary for the `@jsquash/jpeg`
+   * dependency (v1.5.0). By default the dependency will be loaded from
+   * `https://unpkg.com/@jsquash/jpeg@1.5.0/codec/enc/mozjpeg_enc.wasm`. Override
+   * if you want to provide your own payload. Loader will not be called if
+   * {@link optimization} is not set to use the `mozjpeg` method.
+   */
+  mozjpegWasmLoader?: () => Promise<Uint8Array>;
+  /** Pre-sampled list of canvases to use for estimating the size */
+  sampleCanvases?: CanvasNormalized[];
 }
 
 export type Estimation = {
@@ -189,29 +224,43 @@ export type Estimation = {
   size: number;
   /** If CORS is enabled for all of the images referenced in the sample canvases */
   corsSupported: boolean;
+  /** Image data for a sample image, present when optimization is enabled. */
+  sampleImageData?: Uint8Array;
+  /** Image MIME type for a sample image, present when optimization is enabled. */
+  sampleImageMimeType?: string;
+  /** How large is the PDF after the image optimization, compared to the unoptimized images?  */
+  optimizationResult?: number;
+  /** Canvases that were used for estimating */
+  sampleCanvases: CanvasNormalized[];
+};
 
-}
-
-function getCanvasesForSampling(canvases: CanvasNormalized[], numSamples: number): CanvasNormalized[] {
+function getCanvasesForSampling(
+  canvases: CanvasNormalized[],
+  numSamples: number
+): CanvasNormalized[] {
   if (canvases.length <= numSamples) {
     return canvases;
   }
-  const meanPixels = canvases.reduce(
-    (x, { width, height }) => x + width * height, 0) / canvases.length;
+  const meanPixels =
+    canvases.reduce((x, { width, height }) => x + width * height, 0) /
+    canvases.length;
   const candidateCanvases = canvases.filter(
     (c) => Math.abs(meanPixels - c.width * c.height) <= 0.25 * meanPixels
   );
   if (candidateCanvases.length <= numSamples) {
     return candidateCanvases;
   }
-  const sampleCanvases: CanvasNormalized[] = []
+  const sampleCanvases: CanvasNormalized[] = [];
   while (sampleCanvases.length < numSamples) {
-    const candidate = candidateCanvases[Math.floor(Math.random() * candidateCanvases.length)]
+    const candidate =
+      candidateCanvases[Math.floor(Math.random() * candidateCanvases.length)];
     if (sampleCanvases.indexOf(candidate) < 0) {
-      sampleCanvases.push(candidate)
+      sampleCanvases.push(candidate);
     }
   }
-  return sampleCanvases;
+  return sampleCanvases.sort(
+    (a, b) => canvases.indexOf(a) - canvases.indexOf(b)
+  );
 }
 
 /** Estimate the final size of the PDF for a given manifest.
@@ -227,6 +276,18 @@ export async function estimatePdfSize({
   scaleFactor,
   filterCanvases = () => true,
   numSamples = 8,
+  optimization,
+  saxWasmLoader = async () =>
+    fetch(
+      `https://unpkg.com/sax-wasm@${ocrParser.SAX_WASM_VERSION}/lib/sax-wasm.wasm`
+    )
+      .then((res) => res.arrayBuffer())
+      .then((buf) => new Uint8Array(buf)),
+  mozjpegWasmLoader = async () =>
+    fetch('https://unpkg.com/@jsquash/jpeg@1.5.0/codec/enc/mozjpeg_enc.wasm')
+      .then((res) => res.arrayBuffer())
+      .then((buf) => new Uint8Array(buf)),
+  sampleCanvases
 }: EstimationParams): Promise<Estimation> {
   let manifestId;
   if (typeof inputManifest === 'string') {
@@ -249,8 +310,7 @@ export async function estimatePdfSize({
   }
 
   const canvases = vault.get<CanvasNormalized>(
-    manifest.items.filter((c) => canvasPredicate(c.id))
-  );
+    manifest.items.filter(c => canvasPredicate(c.id)).map(c => c.id));
 
   // Select some representative canvases that are close to the mean in terms
   // of their pixel area to avoid small images distorting the estimate too much
@@ -258,32 +318,102 @@ export async function estimatePdfSize({
     (sum, canvas) => sum + canvas.width * canvas.height,
     0
   );
-  const sampleCanvases = getCanvasesForSampling(canvases, numSamples);
+  if (!sampleCanvases?.length) {
+    sampleCanvases = getCanvasesForSampling(canvases, numSamples);
+  }
   const samplePixels = sampleCanvases.reduce(
     (sum, canvas) => sum + canvas.width * canvas.height,
     0
   );
+
+  // Initialize XML parsers
+  if (!saxParserWasm || !ocrParser.isInitialized()) {
+    if (!saxParserWasm) {
+      const wasm = await saxWasmLoader();
+      initializeSaxParser(wasm);
+    }
+    if (!ocrParser.isInitialized()) {
+      await ocrParser.initialize(() => Promise.resolve(saxParserWasm!));
+      ocrParser.setupLogging({
+        debug: log.debug.bind(log),
+        info: log.info.bind(log),
+        warn: log.warn.bind(log),
+        error: log.error.bind(log),
+      });
+    }
+  }
+
   const queue = new PQueue({ concurrency });
   const canvasData = await Promise.all(
     sampleCanvases.map((c) =>
       queue.add(async () => {
         const info = getCanvasInfo(c);
-        return fetchCanvasData(c, info.images, { scaleFactor, sizeOnly: true });
+        return fetchCanvasData(c, info.images, {
+          scaleFactor,
+          sizeOnly: optimization === undefined,
+        });
       })
     )
   );
+
+  let optimizationResult: number | undefined;
+  if (optimization) {
+    if (optimization.method === 'mozjpeg') {
+      await initialize(mozjpegWasmLoader);
+    }
+    const images = canvasData
+      .filter((c): c is CanvasData => c !== undefined)
+      .flatMap((c) => c.images);
+    const originalSize = images.reduce(
+      (sum, img) => sum + img.data!.byteLength,
+      0
+    );
+    await Promise.all(
+      images.map(async (img) => {
+        const optimized = await optimizeImage({
+          imageData: new Uint8Array(img.data!),
+          imageFormat:
+            (img.format as 'jpeg' | 'png') === 'jpeg'
+              ? 'image/jpeg'
+              : 'image/png',
+          ...optimization,
+        });
+        img.data = optimized.jpegData.buffer;
+        img.format = 'jpeg';
+      })
+    );
+    const optimizedSize = images.reduce(
+      (sum, img) => sum + img.data!.byteLength,
+      0
+    );
+    optimizationResult = optimizedSize / originalSize;
+  }
+
   const corsSupported = canvasData
     .filter(isDefined<CanvasData>)
     .flatMap((c) => c.images)
-    .every(i => i.corsAvailable);
+    .every((i) => i.corsAvailable);
   const sampleBytes = canvasData
     .filter(isDefined<CanvasData>)
     .flatMap((c) => c.images)
-    .reduce((size: number, data) => size + (data?.numBytes ?? 0), 0);
+    .reduce(
+      (size: number, img) => size + (img?.data?.byteLength ?? img.numBytes),
+      0
+    );
+  const sampleImages = canvasData
+    .filter(isDefined<CanvasData>)
+    .flatMap((c) => c.images);
+  const sampleImage = sampleImages[0];
   const bpp = sampleBytes / samplePixels;
   return {
     size: bpp * totalCanvasPixels,
     corsSupported,
+    sampleImageData: sampleImage.data
+      ? new Uint8Array(sampleImage.data)
+      : undefined,
+    sampleImageMimeType: sampleImage.format,
+    sampleCanvases,
+    optimizationResult
   };
 }
 
@@ -305,9 +435,9 @@ async function buildOutlineFromRanges(
   const canvasIds = canvases.map((canvas) => canvas.id);
 
   // We have to recurse, this small closure handles each node in the tree
-  const isCanvas = (ri: RangeItems): ri is Reference<'Canvas'> =>
+  const isCanvas = (ri: RangeItems | NormalizedRangeItemSchemas): ri is Reference<'Canvas'> =>
     typeof ri !== 'string' && ri.type === 'Canvas';
-  const isRange = (ri: RangeItems): ri is Reference<'Range'> =>
+  const isRange = (ri: RangeItems | NormalizedRangeItemSchemas): ri is Reference<'Range'> =>
     typeof ri !== 'string' && ri.type == 'Range';
 
   const seenRanges: Set<string> = new Set();
@@ -320,9 +450,11 @@ async function buildOutlineFromRanges(
     // Double filtering with `isCanvas` is necessary because of TS limitations
     const firstCanvas = range.items
       .filter(isCanvas)
-      .filter(c => canvasIds.indexOf(c.id) >= 0)
+      .filter((c) => canvasIds.indexOf(c.id!) >= 0)
       .filter(isCanvas)
-      .sort((a, b) => canvasIds.indexOf(a.id) > canvasIds.indexOf(b.id) ? -1 : 1)[0];
+      .sort((a, b) =>
+        canvasIds.indexOf(a.id!) > canvasIds.indexOf(b.id!) ? -1 : 1
+      )[0];
     const rangeLabel = getI18nValue(
       range.label ?? '<untitled>',
       languagePreference,
@@ -350,34 +482,35 @@ async function buildOutlineFromRanges(
     }
     return {
       label: rangeLabel,
-      startCanvas,
+      startCanvas: startCanvas!,
       children,
     };
   };
 
   let tocRanges = vault.get<RangeNormalized>(manifest.structures);
-  const topRange = tocRanges.find(r => (r.behavior as string[]).indexOf("top") >= 0);
+  const topRange = tocRanges.find(
+    (r) => (r.behavior as string[]).indexOf('top') >= 0
+  );
   // If there's a 'top' range, only use that as the single top-level ToC node
   if (topRange) {
     tocRanges = [topRange];
   }
 
   return (
-    (
-      await Promise.all(tocRanges.map(handleTocRange)
-      )
-    ).filter(isDefined<TocItem>) ?? []
+    (await Promise.all(tocRanges.map(handleTocRange))).filter(
+      isDefined<TocItem>
+    ) ?? []
   );
 }
 
 export type ProgressMessageCode =
-  'generate-cover-page' |
-  'generate-pages' |
-  'finishing';
+  | 'generate-cover-page'
+  | 'generate-pages'
+  | 'finishing';
 
 export type ProgressNotification =
-  ImageDownloadFailureNotification |
-  OcrDownloadFailureNotification;
+  | ImageDownloadFailureNotification
+  | OcrDownloadFailureNotification;
 
 export type ImageDownloadFailureNotification = {
   code: 'image-download-failure';
@@ -386,13 +519,13 @@ export type ImageDownloadFailureNotification = {
   numTotal: number;
   details: {
     [imageUrl: string]: string;
-  }
-}
+  };
+};
 export type OcrDownloadFailureNotification = {
   code: 'ocr-download-failure';
   canvasIndex: number;
   ocrUrl: string;
-}
+};
 
 /** Tracks PDF generation progress and various statistics related to that. */
 class ProgressTracker {
@@ -501,7 +634,7 @@ async function getCoverPagePdf(
   const thumbUrl = await getThumbnail(manifest, 512);
   if (thumbUrl) {
     params.thumbnail = { url: thumbUrl };
-    const manifestThumb = vault.get<ContentResource>(manifest.thumbnail)[0];
+    const manifestThumb = vault.get<ContentResource>(manifest.thumbnail.map(t => t.id))[0];
     if (manifestThumb && 'type' in manifestThumb) {
       params.thumbnail.iiifImageService = (
         manifestThumb as IIIFExternalWebResource
@@ -563,7 +696,7 @@ async function getCoverPagePdf(
   } else if (endpoint) {
     const resp = await fetchRespectfully(endpoint, {
       method: 'POST',
-      headers: { 'Content-Type': 'application/json' },
+      headers: { 'Content-Type': 'application/json; charset=utf-8' },
       body: JSON.stringify(params),
     });
     const buf = await resp.arrayBuffer();
@@ -583,13 +716,13 @@ export type ConversionReport = {
     numTotal: number;
     details: {
       [imageUrl: string]: string;
-    }
+    };
   }>;
   failedOcr?: Array<{
     canvasIndex: number;
     ocrUrl: string;
   }>;
-}
+};
 
 export type ConversionReportWithData = ConversionReport & { data: Blob };
 
@@ -623,14 +756,21 @@ export async function convertManifest(
     coverPageEndpoint,
     polyglotZipPdf,
     polyglotZipBaseDir,
+    optimization,
     saxWasmLoader = async () =>
-      fetch(`https://unpkg.com/sax-wasm@${ocrParser.SAX_WASM_VERSION}/lib/sax-wasm.wasm`)
+      fetch(
+        `https://unpkg.com/sax-wasm@${ocrParser.SAX_WASM_VERSION}/lib/sax-wasm.wasm`
+      )
+        .then((res) => res.arrayBuffer())
+        .then((buf) => new Uint8Array(buf)),
+    mozjpegWasmLoader = async () =>
+      fetch('https://unpkg.com/@jsquash/jpeg@1.5.0/codec/enc/mozjpeg_enc.wasm')
         .then((res) => res.arrayBuffer())
         .then((buf) => new Uint8Array(buf)),
   }: ConvertOptions
 ): Promise<ConversionReport | ConversionReportWithData> {
   // Prevent warning when running in Node.js
-  if (typeof process !== "undefined") {
+  if (typeof process !== 'undefined') {
     events.setMaxListeners(100, abortController.signal);
   }
   let writer: Writer;
@@ -669,7 +809,7 @@ export async function convertManifest(
   let manifestJson: Manifest | Presentation2.Manifest;
   if (typeof inputManifest === 'string') {
     manifestId = inputManifest;
-    manifestJson = await fetchManifestJson(manifestId) as
+    manifestJson = (await fetchManifestJson(manifestId)) as
       | Manifest
       | Presentation2.Manifest;
   } else {
@@ -725,13 +865,30 @@ export async function convertManifest(
   });
   const canvasInfos = canvases.map(getCanvasInfo);
   const canvasFuts = canvases.map((c, idx) => {
-    return queue.add(() => {
+    return queue.add(async () => {
       const info = canvasInfos[idx];
-      return fetchCanvasData(c, info.images, {
+      const canvasData = await fetchCanvasData(c, info.images, {
         scaleFactor,
         ppiOverride: ppi,
         abortSignal: abortController.signal,
       });
+      // TODO: If downscaling was not possible due to lack of IIIF Image API support,
+      //       we should force an optimization pass with a lower resolution.
+      if (optimization) {
+        await Promise.all(
+          canvasData?.images.map(async (i) => {
+            const optimized = await optimizeImage({
+              imageData: new Uint8Array(i.data!),
+              imageFormat: i.format === 'jpeg' ? 'image/jpeg' : 'image/png',
+              ...optimization,
+            });
+            log.debug('main: Got optimized image', i.resource.id);
+            i.data = optimized.jpegData;
+            i.format = 'jpeg';
+          }) ?? []
+        );
+      }
+      return canvasData;
     });
   });
 
@@ -745,7 +902,7 @@ export async function convertManifest(
     metadata: pdfMetadata,
     canvasInfos: canvases.map((c, idx) => ({
       canvasIdx: idx,
-      ...canvasInfos[idx]
+      ...canvasInfos[idx],
     })),
     langPref: languagePreference,
     pageLabels: labels,
@@ -767,7 +924,7 @@ export async function convertManifest(
     countingWriter,
     pdfGen,
     onProgress,
-    onNotification,
+    onNotification
   );
   progress.emitProgress(0);
 
@@ -818,13 +975,14 @@ export async function convertManifest(
           details: Object.fromEntries(
             imageFailures.map((f) => [
               f.resource.id ?? '<unknown>',
-              f.cause instanceof Error ? f.cause.toString() : f.cause
-            ]))
+              f.cause instanceof Error ? f.cause.toString() : f.cause,
+            ])
+          ),
         };
         report.failedImages.push(reportData);
         progress.emitNotification({
           code: 'image-download-failure',
-          ...reportData
+          ...reportData,
         });
       }
       if (canvasInfo.ocr && !text?.markup) {
@@ -834,7 +992,7 @@ export async function convertManifest(
         const reportData = {
           canvasIndex: canvasIdx,
           ocrUrl: canvasInfo.ocr.id,
-        }
+        };
         report.failedOcr.push(reportData);
         progress.emitNotification({
           code: 'ocr-download-failure',
@@ -846,7 +1004,7 @@ export async function convertManifest(
         const normalized = await Promise.all(
           externalAnnotations.map((a) => {
             if (!('id' in a)) {
-              a = convertPresentation2(a) as IIIF3Annotation;
+              a = convertPresentation2(a) as unknown as IIIF3Annotation;
             }
             return vault.load<AnnotationNormalized>(a.id, a);
           })
@@ -872,10 +1030,7 @@ export async function convertManifest(
       );
       stopMeasuring?.();
       progress.updatePixels(
-        images.reduce(
-          (acc, img) => acc + img.width * img.height,
-          0
-        ),
+        images.reduce((acc, img) => acc + img.width * img.height, 0),
         canvas.width * canvas.height
       );
       report.numPages++;
@@ -928,7 +1083,7 @@ export async function convertManifest(
 
   report.fileSizeBytes = countingWriter.bytesWritten;
   if (writer instanceof BlobWriter) {
-    return {...report, data: writer.blob };
+    return { ...report, data: writer.blob };
   } else {
     return report;
   }
diff --git a/node_modules/pdiiif/src/download.ts b/node_modules/pdiiif/src/download.ts
index 3769843..85f0a4b 100644
--- a/node_modules/pdiiif/src/download.ts
+++ b/node_modules/pdiiif/src/download.ts
@@ -1,18 +1,20 @@
 /* eslint-disable @typescript-eslint/no-non-null-assertion */
 import { Mutex } from 'async-mutex';
 import {
-  CanvasNormalized,
   ExternalWebResource,
   FragmentSelector,
   IIIFExternalWebResource,
   ImageService,
   ImageService3,
-  ManifestNormalized,
-  RangeNormalized,
   Reference,
   Selector,
   Service,
 } from '@iiif/presentation-3';
+import {
+  CanvasNormalized,
+  ManifestNormalized,
+  RangeNormalized,
+} from '@iiif/presentation-3-normalized'
 
 import { OcrPageWithMarkup, fetchAndParseText } from './ocr.js';
 import metrics from './metrics.js';
@@ -22,7 +24,6 @@ import {
   isPhysicalDimensionService,
   PhysicalDimensionService,
   supportsScaling,
-  fetchFullImageService,
   getCanvasAnnotations,
   Annotation,
   ImageInfo,
@@ -77,13 +78,21 @@ class RateLimitingRegistry {
 
 export const rateLimitRegistry = new RateLimitingRegistry();
 
+/** Tracks for which domains we need and safely can include credentials for */
+const includedCredentialsHosts = new Set<string>();
+
+/** Check if requests to the given host should include credentials */
+export function requestsShouldIncludeCredentials(host: string): boolean {
+  return includedCredentialsHosts.has(host);
+}
+
 /** A 'respectful' wrapper around `fetch` that tries to respect rate-limiting headers.
  *
  * Will also retry with exponential backoff in case of server errors.
  */
 export async function fetchRespectfully(
   url: string,
-  init?: RequestInit,
+  init: RequestInit = {},
   maxRetries = 3
 ): Promise<Response> {
   const { host } = new URL(url);
@@ -93,17 +102,31 @@ export async function fetchRespectfully(
   let numRetries = -1;
   let resp: Response | undefined;
   let waitMs = 5000;
-  let lastError: unknown;
+  let fetchOptions = { ...init };
+  if (includedCredentialsHosts.has(host)) {
+    fetchOptions.credentials = 'include';
+  }
   // If we're fetching from a rate-limited host, wait until there's no other fetch for it
   // going on
   const release = await rateLimitMutex?.acquire();
   try {
     do {
-      // Don't catch network errors, let them bubble up
-      resp = await fetch(url, init);
+      resp = await fetch(url, fetchOptions);
       if (resp.ok) {
+        if (fetchOptions.credentials === 'include') {
+          // If we successfully fetched with credentials, remember that for next request to that host
+          includedCredentialsHosts.add(host);
+        }
         break;
       }
+
+      if ((resp.status == 401 || resp.status == 403) && fetchOptions.credentials !== 'include') {
+        // Retry with included credentials and don't increment counter
+        fetchOptions.credentials = 'include';
+        continue;
+      }
+
+
       numRetries++;
 
       const retryAfter = resp?.headers.get('retry-after');
@@ -168,9 +191,6 @@ export async function fetchRespectfully(
     }
     release?.();
   }
-  if (!resp) {
-    throw lastError;
-  }
   return resp;
 }
 
@@ -279,10 +299,12 @@ export type CanvasImage = ImageInfo & CanvasImageData;
 export type CanvasImageData = {
   data?: ArrayBuffer;
   numBytes: number;
+  format: 'jpeg' | 'png';
   corsAvailable: boolean;
   ppi?: number;
   nativeWidth?: number;
   nativeHeight?: number;
+  downscaled?: boolean;
 };
 
 /** Options for fetching image */
@@ -324,6 +346,7 @@ async function fetchCanvasImage(
   }
   let ppi: number | undefined;
   let imageUrl: string;
+  let downscaled = false;
   if (imgService) {
     if (!imgService.width) {
       imgService = await fetchFullImageService(imgService);
@@ -335,11 +358,14 @@ async function fetchCanvasImage(
     if (ppi) {
       ppi = ppi * (sizeInfo.width / imgService.width!);
     }
-  } else if (image.id && image.format === 'image/jpeg') {
+    if (sizeInfo.width < imgService.width!) {
+      downscaled = true;
+    }
+  } else if (image.id && ['image/jpeg', 'image/png'].indexOf(image.format ?? 'unknown') >= 0) {
     imageUrl = image.id;
   } else {
     log.error(
-      `No JPEG image identifier for resource ${image.id} could be found!`
+      `No JPEG or PNG image identifier for resource ${image.id} could be found!`
     );
     return null;
   }
@@ -347,6 +373,7 @@ async function fetchCanvasImage(
   let data: ArrayBuffer | undefined;
   let numBytes: number;
   let corsAvailable = true;
+  let format: 'jpeg' | 'png' | null = null;
   const stopMeasuring = metrics?.imageFetchDuration.startTimer({
     iiif_host: new URL(imageUrl).host,
   });
@@ -366,6 +393,13 @@ async function fetchCanvasImage(
     }
     numBytes = Number.parseInt(imgResp.headers.get('Content-Length') ?? '-1');
     data = sizeOnly && numBytes >= 0 ? undefined : await imgResp.arrayBuffer();
+    if (imgResp.headers.get('Content-Type')?.startsWith('image/jpeg')) {
+      format = 'jpeg';
+    } else if (imgResp.headers.get('Content-Type')?.startsWith('image/png')) {
+      format = 'png';
+    } else {
+      throw new Error('Unsupported image content type', { cause: { type: 'content-type' } });
+    }
     if (numBytes < 0) {
       numBytes = data?.byteLength ?? -1;
     }
@@ -408,6 +442,8 @@ async function fetchCanvasImage(
     ppi,
     numBytes,
     corsAvailable,
+    format: format!,
+    downscaled,
   };
 }
 
@@ -456,19 +492,19 @@ export async function fetchStartCanvasInfo(
     }
     canvasId = ident;
     fragment = `xywh=${selectorStr}`;
-  } else if (startRef.type === 'Canvas') {
+  } else if (startRef.type === 'SpecificResource') {
     return startRef.id;
   } else {
-    const selector = vault.get<Selector>(startRef);
+    const selector = vault.get<Exclude<Selector, string>>(startRef.id!);
     if (typeof selector === 'string' || selector.type !== 'FragmentSelector') {
-      console.warn(
+      log.warn(
         `Unsupported selector type, cannot determine start canvas for ${resource.id}`
       );
       return;
     }
     const fragSel = selector as FragmentSelector;
     if (fragSel.conformsTo !== 'http://www.w3.org/TR/media-frags/') {
-      console.warn(
+      log.warn(
         `Unsupported selector type, cannot determine start canvas for ${resource.id} (fragment selector type was ${fragSel.conformsTo})`
       );
       return;
@@ -476,7 +512,7 @@ export async function fetchStartCanvasInfo(
     canvasId = fragSel.value;
   }
   if (!fragment || !canvasId) {
-    console.error(
+    log.error(
       `Couldn't parse either canvas identifier or selector for ${resource.id} start canvas.`
     );
     return;
@@ -573,3 +609,14 @@ export async function fetchManifestJson(manifestUrl: string): Promise<any> {
     return await resp.json();
   }
 }
+
+/** Fetch the full IIIF Image service definition from
+ * its info.json endpoint. */
+export async function fetchFullImageService(
+  serviceRef: ImageService
+): Promise<ImageService> {
+  const serviceUrl = `${serviceRef['@id'] ?? serviceRef.id}/info.json`;
+  const resp = await fetch(serviceUrl);
+  const res = await resp.json();
+  return res as ImageService;
+}
\ No newline at end of file
diff --git a/node_modules/pdiiif/src/iiif.ts b/node_modules/pdiiif/src/iiif.ts
index 6aad319..e48df4a 100644
--- a/node_modules/pdiiif/src/iiif.ts
+++ b/node_modules/pdiiif/src/iiif.ts
@@ -1,30 +1,34 @@
 import {
   InternationalString,
-  ManifestNormalized,
   ExternalWebResource,
   IIIFExternalWebResource,
   ContentResource,
   ImageProfile,
   ImageService,
-  CanvasNormalized,
   Reference,
-  AnnotationPageNormalized,
-  AnnotationNormalized,
   Creator,
   Agent,
+  W3CAnnotationTarget,
 } from '@iiif/presentation-3';
-import { globalVault, Vault } from '@iiif/vault';
 import {
+  ManifestNormalized,
+  CanvasNormalized,
+  AnnotationPageNormalized,
+  AnnotationNormalized,
+} from '@iiif/presentation-3-normalized';
+import {
+  globalVault, Vault,
   buildLocaleString,
   createPaintingAnnotationsHelper,
   createThumbnailHelper,
   expandTarget,
   SupportedTarget,
-} from '@iiif/vault-helpers';
+} from '@iiif/helpers';
 import { ImageServiceLoader as ImageServiceLoader_ } from '@atlas-viewer/iiif-image-api';
 
 import { getOcrReferences } from './ocr.js';
 import log from './log.js';
+import { fetchRespectfully } from './download.js';
 
 const PURPOSE_ORDER = ['commenting', 'describing', 'tagging', 'no-purpose'];
 const PURPOSE_LABELS: { [purpose: string]: string } = {
@@ -70,14 +74,13 @@ export function getI18nValue(
   }
 }
 
-
 /** Custom image loader to deal with browser + node intercompatibility.
  *
  * Used for the thumbnail helper.
  */
 class ImageServiceLoader extends ImageServiceLoader_ {
   async fetch(input: RequestInfo, init?: RequestInit): Promise<Response> {
-    return fetch(input as any, init as any) as any;
+    return fetchRespectfully(input as any, init as any) as any;
   }
 }
 
@@ -86,11 +89,8 @@ const thumbHelper = createThumbnailHelper(vault, {
 });
 
 // A few helpers to deal with painting annotations
-export const {
-  getPaintables,
-  getAllPaintingAnnotations,
-  extractChoices
-} = createPaintingAnnotationsHelper(vault);
+export const { getPaintables, getAllPaintingAnnotations, extractChoices } =
+  createPaintingAnnotationsHelper(vault);
 
 /** Determine best thumbnail image for the manifest. */
 export async function getThumbnail(
@@ -143,7 +143,6 @@ export function isPhysicalDimensionService(
   );
 }
 
-
 /** Check if a IIIF Image endpoint supports arbitrary downscaling. */
 export function supportsScaling(profile: ImageProfile): boolean {
   if (typeof profile === 'string') {
@@ -153,23 +152,12 @@ export function supportsScaling(profile: ImageProfile): boolean {
   }
 }
 
-/** Fetch the full IIIF Image service definition from
- * its info.json endpoint. */
-export async function fetchFullImageService(
-  serviceRef: ImageService
-): Promise<ImageService> {
-  const serviceUrl = `${serviceRef['@id'] ?? serviceRef.id}/info.json`;
-  const resp = await fetch(serviceUrl);
-  const res = await resp.json();
-  return res as ImageService;
-}
-
 export type ImageInfo = {
   // The 'Image' content resource
   resource: (ExternalWebResource | IIIFExternalWebResource) & { type: 'Image' };
   // Where to draw on the corresponding canvas
   x: number;
-  y: number
+  y: number;
   // At what size to draw on the canvas?
   width: number;
   height: number;
@@ -177,13 +165,14 @@ export type ImageInfo = {
   nativeWidth?: number;
   nativeHeight?: number;
   ppi?: number;
+  format?: 'jpeg' | 'png' | 'unsupported';
   choiceInfo?: {
     enabled: boolean;
     optional: boolean;
     visibleByDefault: boolean;
     label?: InternationalString;
-  }
-}
+  };
+};
 
 /** Information about a canvas that can be obtained without
  *  fetching any external resources */
@@ -205,7 +194,7 @@ export function getCanvasAnnotations(canvas: CanvasNormalized): Annotation[] {
     .filter((a) =>
       Array.isArray(a.motivation)
         ? a.motivation.find((m) => PURPOSE_LABELS[m] !== undefined) !==
-        undefined
+          undefined
         : PURPOSE_LABELS[a.motivation ?? 'invalid'] !== undefined
     )
     .map((a) => parseAnnotation(a, []))
@@ -275,7 +264,7 @@ export function parseAnnotation(
   }
   // TODO: i18n?
   const annoBody = anno.body.map((bodyRef) =>
-    vault.get<ContentResource>(bodyRef)
+    vault.get<ContentResource>(bodyRef.id)
   );
   const creatorNames: Array<string> = annoBody
     .map((body) => body.creator)
@@ -285,7 +274,11 @@ export function parseAnnotation(
     .map((body) => body.modified)
     .filter((v: string | undefined): v is string => v !== undefined)
     .map((v: string) => new Date(v).getTime());
-  const target = expandTarget(anno.target);
+  if (typeof anno.target === 'string') {
+    return;
+  }
+  const targets = vault.get<Exclude<W3CAnnotationTarget, string>>(anno.target.map(t => t.id));
+  const target = expandTarget(targets);
   const markup = buildAnnotationMarkup(annoBody);
   if (!markup) {
     // TODO: Log?
@@ -381,7 +374,7 @@ export function checkCompatibility(
     const paintingResources = vault
       .get<AnnotationPageNormalized>(canvas.items)
       .flatMap((ap) => vault.get<AnnotationNormalized>(ap.items))
-      .flatMap((a) => vault.get<ContentResource>(a.body));
+      .flatMap((a) => vault.get<ContentResource>(a.body.map(b => b.id)));
     const nonPaintingAnnos = manifest.annotations;
     // TODO: Check if canvas has an image
     // TODO: Check if every painting annotation is an image with a JPEG available
@@ -391,7 +384,12 @@ export function checkCompatibility(
 }
 
 /** Parse a IIIF target specification */
-export function parseTarget(targetStr: string): { x: number; y: number, width: number, height: number } {
+export function parseTarget(targetStr: string): {
+  x: number;
+  y: number;
+  width: number;
+  height: number;
+} {
   const [canvasId, fragment] = targetStr.split('#xywh=');
   if (fragment) {
     const [x, y, width, height] = fragment
@@ -405,25 +403,54 @@ export function parseTarget(targetStr: string): { x: number; y: number, width: n
   }
 }
 
+export function getImageFormat(
+  image: ExternalWebResource | IIIFExternalWebResource
+): 'jpeg' | 'png' | 'unsupported' | undefined {
+  if (image.format === 'image/jpeg') {
+    return 'jpeg';
+  } else if (image.format === 'image/png') {
+    return 'png';
+  } else if (image.format === undefined) {
+    if (image.id?.endsWith('.jpg') || image.id?.endsWith('.jpeg')) {
+      return 'jpeg';
+    } else if (image.id?.endsWith('.png')) {
+      return 'png';
+    }
+  } else {
+    return 'unsupported';
+  }
+}
+
 /** Get information about images on a Canvas. */
 export function getImageInfos(canvas: CanvasNormalized): ImageInfo[] {
   const imageInfos: ImageInfo[] = [];
-  const paintingAnnos = getAllPaintingAnnotations(canvas);
+  const paintingAnnos = vault.get<AnnotationPageNormalized>(canvas.items)
+    .flatMap((ap) => vault.get<AnnotationNormalized>(ap.items));
   for (const anno of paintingAnnos) {
-    if (typeof anno.target !== 'string') {
-      log.error(`Annotation ${anno.id} has a non-string target, currently not supported.`);
+    const annoTarget = anno.target as any;
+    let target;
+    if (typeof annoTarget === 'string') {
+      target = parseTarget(annoTarget);
+    } else if (annoTarget.type === 'SpecificResource') {
+      target = parseTarget(annoTarget.source.id);
+    } else {
+      console.error(`Unsupported target type for annotation on canvas ${canvas.id}: '${annoTarget.type}'`);
       continue;
     }
-    const target = parseTarget(anno.target);
 
-    const body = vault.get<ContentResource>(anno.body);
+
+    const body = vault.get<ContentResource>(anno.body.map(b => b.id));
     for (const resource of body) {
       if (resource.type !== 'Image') {
         continue;
       }
       imageInfos.push({
-        resource: resource as (ExternalWebResource | IIIFExternalWebResource) & { type: 'Image' },
+        resource: resource as (
+          | ExternalWebResource
+          | IIIFExternalWebResource
+        ) & { type: 'Image' },
         ...target,
+        format: getImageFormat(resource),
         nativeWidth: (resource as any).width as number | undefined,
         nativeHeight: (resource as any).height as number | undefined,
       });
@@ -442,7 +469,9 @@ export function getImageInfos(canvas: CanvasNormalized): ImageInfo[] {
       continue;
     }
     imageInfos.push({
-      resource: resource as (ExternalWebResource | IIIFExternalWebResource) & { type: 'Image' },
+      resource: resource as (ExternalWebResource | IIIFExternalWebResource) & {
+        type: 'Image';
+      },
       // FIXME: Can't choice images have a location and rendering dimensions?
       x: 0,
       y: 0,
@@ -450,12 +479,13 @@ export function getImageInfos(canvas: CanvasNormalized): ImageInfo[] {
       height: canvas.height,
       nativeWidth: (resource as any).width as number | undefined,
       nativeHeight: (resource as any).height as number | undefined,
+      format: getImageFormat(resource),
       choiceInfo: {
         enabled: choiceItem.selected ?? false,
         optional: true,
         label: (resource as any).label,
         visibleByDefault: choiceItem.selected ?? false,
-      }
+      },
     });
   }
 
diff --git a/node_modules/pdiiif/src/index.ts b/node_modules/pdiiif/src/index.ts
index 61ccb36..343075e 100644
--- a/node_modules/pdiiif/src/index.ts
+++ b/node_modules/pdiiif/src/index.ts
@@ -2,4 +2,6 @@ export type { Logger } from './log.js';
 export { setLogger, ConsoleLogger } from './log.js';
 export { fetchManifestJson } from './download.js';
 export * from './convert.js';
+export { vault } from './iiif.js';
+export type { OptimizationParams } from './optimization.js'
 export { default as version } from './version.js';
diff --git a/node_modules/pdiiif/src/ocr.ts b/node_modules/pdiiif/src/ocr.ts
index aca627e..1dfffdd 100644
--- a/node_modules/pdiiif/src/ocr.ts
+++ b/node_modules/pdiiif/src/ocr.ts
@@ -3,10 +3,12 @@
 /// Utilities for parsing OCR text from hOCR, ALTO and IIIF Annotations
 import {
   Annotation,
-  AnnotationNormalized,
-  CanvasNormalized,
   ContentResource,
 } from '@iiif/presentation-3';
+import {
+  AnnotationNormalized,
+  CanvasNormalized,
+} from '@iiif/presentation-3-normalized';
 import {
   parseAltoPages,
   parseHocrPages,
@@ -103,7 +105,7 @@ const isHocr = (resource: ExternalWebResourceWithProfile) =>
 
 /** Wrapper around fetch() that returns the content as text */
 async function fetchOcrMarkup(url: string): Promise<string | undefined> {
-  const resp = await fetch(url);
+  const resp = await fetchRespectfully(url);
   if (resp.status === 404) {
     return undefined;
   }
@@ -128,8 +130,8 @@ export async function fetchAnnotationResource(url: string): Promise<any> {
 export function getOcrReferences(
   canvas: CanvasNormalized
 ): ExternalWebResourceWithProfile | undefined {
-  const refs = vault.get<ContentResource>(canvas.seeAlso);
-  refs.push(...vault.get<ContentResource>(canvas.rendering));
+  const refs = vault.get<ContentResource>(canvas.seeAlso.map((r) => r.id));
+  refs.push(...vault.get<ContentResource>(canvas.rendering.map((r) => r.id)));
   return refs
     .filter(isExternalWebResourceWithProfile)
     .find((r) => isAlto(r) || isHocr(r));
diff --git a/node_modules/pdiiif/src/optimization.ts b/node_modules/pdiiif/src/optimization.ts
new file mode 100644
index 0000000..21a4563
--- /dev/null
+++ b/node_modules/pdiiif/src/optimization.ts
@@ -0,0 +1,201 @@
+import type { EncodeOptions } from '@jsquash/jpeg/meta';
+import { randomUUIDv4 } from './util';
+import OptimizationWorker from './optimization.worker.ts?worker';
+import log from './log';
+
+export type InitializationRequest = {
+  mozjpegWasm: Uint8Array;
+};
+
+export type TaskDescription<I> = {
+  id: string;
+  data: I;
+};
+
+export type WorkerMessage<I, O> = { input: { id: string; data: I }; result: O };
+export type WorkerTask<I, O> = {
+  resolve: (value: O) => void;
+  reject: (reason: any) => void;
+  task: TaskDescription<I>;
+};
+
+export type MozJPEGParams = {
+  method: 'mozjpeg';
+  quality: number;
+} & Partial<EncodeOptions>;
+
+export type BrowserEncoderParams = {
+  method: 'browser';
+  quality: number;
+};
+
+export type OptimizationParams = MozJPEGParams | BrowserEncoderParams;
+
+export type OptimizationRequest = {
+  imageData: Uint8Array;
+  imageFormat: 'image/jpeg' | 'image/png';
+} & OptimizationParams;
+
+export type OptimizedImage = {
+  jpegData: Uint8Array;
+  sizeFactor: number;
+};
+
+export class OptimizationError extends Error {
+  constructor(message: string, public taskId: string, public cause?: unknown) {
+    super(message);
+  }
+}
+
+export const MOZJPEG_DEFAULT_PARAMS: EncodeOptions = {
+  quality: 75,
+  progressive: true,
+  optimize_coding: true,
+  smoothing: 0,
+  color_space: 3, // YCbCr
+  quant_table: 3,
+  trellis_multipass: false,
+  trellis_opt_table: true,
+  trellis_opt_zero: true,
+  trellis_loops: 0,
+  auto_subsample: false,
+  chroma_subsample: 2,
+  separate_chroma_quality: false,
+  chroma_quality: 75,
+  arithmetic: false,
+  baseline: false,
+};
+
+class WorkerPool<I, O> {
+  private workers: Worker[] = [];
+  private queue: WorkerTask<I, O>[] = [];
+  private pendingTasks: Map<string, WorkerTask<I, O>> = new Map();
+  private busyWorkers: Set<Worker> = new Set();
+
+  constructor(public size: number) {}
+
+  start(): void {
+    for (let i = 0; i < this.size; i++) {
+      const worker = new OptimizationWorker();
+      worker.onmessage = this.handleMessage.bind(this, worker);
+      worker.onerror = this.handleError.bind(this, worker);
+      this.workers.push(worker);
+    }
+  }
+
+  stop(): void {
+    this.workers.forEach((worker) => worker.terminate());
+    this.workers = [];
+    this.queue = [];
+    this.busyWorkers.clear();
+  }
+
+  dispatch(data: I): Promise<O> {
+    return new Promise((resolve, reject) => {
+      this.queue.push({
+        resolve,
+        reject,
+        task: {
+          id: randomUUIDv4(),
+          data,
+        },
+      });
+      this.processQueue();
+    });
+  }
+
+  private processQueue(): void {
+    if (this.queue.length === 0) return;
+    const availableWorker = this.workers.find((w) => !this.busyWorkers.has(w));
+    if (!availableWorker) return;
+
+    const job = this.queue.shift()!;
+    this.pendingTasks.set(job.task.id, job);
+    this.busyWorkers.add(availableWorker);
+    availableWorker.postMessage(job.task);
+  }
+
+  private handleMessage(
+    worker: Worker,
+    event: MessageEvent<WorkerMessage<I, O>>
+  ): void {
+    log.debug(`worker: received message`, event.data);
+    const job = this.pendingTasks.get(event.data.input.id);
+    if (job) {
+      job.resolve(event.data.result);
+      log.debug(`worker: resolved job`, job.task.id);
+      this.pendingTasks.delete(job.task.id);
+      this.busyWorkers.delete(worker);
+      this.processQueue();
+    } else {
+      log.warn(
+        `worker: unknown job, known jobs: ${[...this.pendingTasks.keys()].join(
+          ', '
+        )}`,
+        event.data.input.id
+      );
+    }
+  }
+
+  private handleError(worker: Worker, evt: ErrorEvent): void {
+    const optimError = evt.error as OptimizationError;
+    const job = this.queue.find((j) => j.task.id === optimError.taskId);
+    if (job) {
+      job.reject(optimError.cause);
+      this.busyWorkers.delete(worker);
+      this.processQueue();
+    }
+  }
+}
+
+let pool: WorkerPool<
+  OptimizationParams | InitializationRequest,
+  OptimizedImage | undefined
+> | null = null;
+let isInitialized = false;
+
+export function startWorkerPool(size = navigator.hardwareConcurrency): void {
+  if (pool !== null) {
+    return;
+  }
+  pool = new WorkerPool(size);
+  pool.start();
+}
+
+export function stopWorkerPool(): void {
+  if (pool === null) {
+    return;
+  }
+  pool.stop();
+  pool = null;
+}
+
+export async function initialize(wasmLoader: () => Promise<Uint8Array>): Promise<void> {
+  if (pool === null) {
+    startWorkerPool();
+  }
+
+  if (isInitialized) {
+    return;
+  }
+
+  const mozjpegWasm = await wasmLoader();
+  let promises: Promise<undefined>[] = [];
+  for (let i = 0; i < pool!.size; i++) {
+    promises.push(pool!.dispatch({ mozjpegWasm }) as Promise<undefined>);
+  }
+  log.debug('main: mozjpegWasm sent to workers');
+  await Promise.all(promises);
+  log.debug('main: workers initialized with MozJPEG encoder');
+  isInitialized = true;
+}
+
+export async function optimizeImage(
+  params: OptimizationRequest
+): Promise<OptimizedImage> {
+  if (pool === null) {
+    startWorkerPool();
+  }
+
+  return pool!.dispatch(params) as Promise<OptimizedImage>;
+}
diff --git a/node_modules/pdiiif/src/optimization.worker.ts b/node_modules/pdiiif/src/optimization.worker.ts
new file mode 100644
index 0000000..9377292
--- /dev/null
+++ b/node_modules/pdiiif/src/optimization.worker.ts
@@ -0,0 +1,118 @@
+import encode, { init as initMozJpegEnc } from '@jsquash/jpeg/encode';
+
+import {
+  BrowserEncoderParams,
+  InitializationRequest,
+  MOZJPEG_DEFAULT_PARAMS,
+  MozJPEGParams,
+  OptimizationError,
+  OptimizationRequest,
+  OptimizedImage,
+  TaskDescription,
+  type WorkerMessage,
+} from './optimization';
+
+let mozjpegInitialized = false;
+const canvas = new OffscreenCanvas(1, 1);
+
+self.onmessage = async function (
+  evt: MessageEvent<TaskDescription<OptimizationRequest | InitializationRequest>>
+) {
+  if ('mozjpegWasm' in evt.data.data) {
+    console.debug(`worker: received MozJPEG WASM module`);
+    const module = await WebAssembly.compile(evt.data.data.mozjpegWasm);
+    await initMozJpegEnc(module);
+    mozjpegInitialized = true;
+    console.debug(`worker: initialized MozJPEG encoder`);
+    self.postMessage({
+      input: evt.data,
+      result: {},
+    });
+    return;
+  }
+
+  const params = evt.data.data;
+  console.debug(`worker: received optimization task`, evt.data.id, params);
+  let optimizedData: Uint8Array;
+  try {
+    if (params.method === 'mozjpeg') {
+      if (!mozjpegInitialized) {
+        throw new Error('MozJPEG encoder not initialized');
+      }
+      optimizedData = await reencodeWithMozJPEG(params);
+    } else if (params.method === 'browser') {
+      optimizedData = await reencodeWithBrowserEncoder(params);
+    } else {
+      throw new Error('Unsupported optimization method');
+    }
+  } catch (err) {
+    console.error(`Failed to optimize image: ${err}`, evt.data.id, err);
+    self.postMessage(
+      new OptimizationError(
+        `Failed to optimize image: ${err}`,
+        evt.data.id,
+        err
+      )
+    );
+    return;
+  }
+  const result = {
+    input: evt.data,
+    result: {
+      jpegData: optimizedData,
+      sizeFactor: optimizedData.length / params.imageData.length,
+    },
+  };
+  self.postMessage(result);
+  console.debug(`worker optimized image with factor ${result.result.sizeFactor}`);
+};
+
+function loadImageToCanvas(
+  imageData: Uint8Array,
+  imageFormat: string
+): Promise<void> {
+  return new Promise(async (resolve, reject) => {
+    try {
+      const bitmap = await createImageBitmap(
+        new Blob([imageData], { type: imageFormat })
+      );
+      canvas.width = bitmap.width;
+      canvas.height = bitmap.height;
+      const ctx = canvas.getContext('2d');
+      if (!ctx) {
+        reject(new Error('Could not get 2D context'));
+        return;
+      }
+      ctx.drawImage(bitmap, 0, 0);
+      resolve();
+    } catch (err) {
+      reject(err);
+      return;
+    }
+  });
+}
+
+async function reencodeWithMozJPEG(
+  params: OptimizationRequest & MozJPEGParams
+): Promise<Uint8Array> {
+  await loadImageToCanvas(params.imageData, params.imageFormat);
+  const pixelData = canvas
+    .getContext('2d')!
+    .getImageData(0, 0, canvas.width, canvas.height);
+  const encoded = await encode(pixelData, {
+    ...MOZJPEG_DEFAULT_PARAMS,
+    ...params,
+  });
+  return new Uint8Array(encoded);
+}
+
+async function reencodeWithBrowserEncoder(
+  params: OptimizationRequest & BrowserEncoderParams
+): Promise<Uint8Array> {
+  await loadImageToCanvas(params.imageData, params.imageFormat);
+  const encoded = await canvas.convertToBlob({
+    type: 'image/jpeg',
+    quality: params.quality / 100,
+  });
+  return new Uint8Array(await encoded.arrayBuffer());
+}
diff --git a/node_modules/pdiiif/src/pdf/annos.ts b/node_modules/pdiiif/src/pdf/annos.ts
index 0898b34..e1b6558 100644
--- a/node_modules/pdiiif/src/pdf/annos.ts
+++ b/node_modules/pdiiif/src/pdf/annos.ts
@@ -5,7 +5,7 @@ import {
   SelectorStyle,
   SupportedSelector,
   SvgSelector,
-} from '@iiif/vault-helpers/annotation-targets';
+} from '@iiif/helpers';
 import { PointSelector } from '@iiif/presentation-3';
 import Color from 'color';
 import { SAXParser, SaxEventType, Text } from 'sax-wasm';
@@ -41,7 +41,7 @@ function sanitizeCssForPdf(styleAttrib: string): string {
 }
 
 function htmlToPlainText(html: string): string {
-  const parser = new SAXParser(SaxEventType.Text, { highWaterMark: 1024 });
+  const parser = new SAXParser(SaxEventType.Text);
   const txt: string[] = [];
   parser.eventHandler = (ev, data) => {
     txt.push((data as Text).value);
diff --git a/node_modules/pdiiif/src/pdf/common.ts b/node_modules/pdiiif/src/pdf/common.ts
index 107e816..b26f80b 100644
--- a/node_modules/pdiiif/src/pdf/common.ts
+++ b/node_modules/pdiiif/src/pdf/common.ts
@@ -137,6 +137,9 @@ export function serialize(value: PdfValue, dictIndent = 0): string {
   } else if (Array.isArray(value)) {
     return `[${value.map((v) => serialize(v, dictIndent + 1)).join(' ')}]`;
   } else if (value instanceof PdfRef) {
+    if (value.refObj === -1) {
+      throw new Error('Cannot serialize a deferred object reference');
+    }
     return `${value.refObj} 0 R`;
   } else if ({}.toString.call(value) === '[object Object]') {
     const outsideIndent = ' '.repeat(PDF_INDENTATION * dictIndent);
diff --git a/node_modules/pdiiif/src/pdf/generator.ts b/node_modules/pdiiif/src/pdf/generator.ts
index 5087240..2b04a30 100644
--- a/node_modules/pdiiif/src/pdf/generator.ts
+++ b/node_modules/pdiiif/src/pdf/generator.ts
@@ -24,7 +24,7 @@ import {
 import { TocItem, textEncoder, randomData, tryDeflateStream } from './util.js';
 import { ArrayReader, Writer } from '../io.js';
 import { OcrPageWithMarkup } from '../ocr.js';
-import PdfImage from './image.js';
+import PdfImage, { JPEGImage, PNGImage } from './image.js';
 import { PdfParser } from './parser.js';
 import pdiiifVersion from '../version.js';
 import log from '../log.js';
@@ -42,6 +42,7 @@ import {
 } from './pkzip.js';
 import { crc32 } from '../util.js';
 import { exportPdfAnnotation } from './annos.js';
+import { OptimizationParams } from '../optimization.js';
 
 const PRODUCER = `pdiiif v${pdiiifVersion}`;
 
@@ -121,8 +122,25 @@ export type GeneratorParams = {
   // Base directory name for the polyglot ZIP archive, if not set the resources will be
   // top-level in the archive
   zipBaseDir?: string;
+  // Optimize images to reduce size
+  optimization?: OptimizationParams;
 };
 
+/** Streaming PDF generator based on a IIIF manifest.
+ *
+ * This class is responsible for generating a PDF document based on a IIIF manifest.
+ * It is designed to be used in a streaming fashion, i.e. it can start writing the PDF
+ * before all the resources have been loaded and thus does not require a huge amount
+ * of memory. On the flipside, this makes the code a lot more complex, since we need
+ * to keep track of the PDF's internal state and write objects in the correct order.
+ * Another complication is that we want to write out the catalog and page tree first
+ * to allow viewers to quickly display the first page, which requires a bunch of
+ * complicated pre-allocation of objects.
+ *
+ * FIXME: Can't we just write the pages first and then the catalog and page tree at
+ *        the end of the file? Would make things *A LOT* easier and less complex and
+ *        error-prone.
+ */
 export default class PDFGenerator {
   // Keep track of how many bytes have been written so far
   _offset = 0;
@@ -167,7 +185,11 @@ export default class PDFGenerator {
   private _zipCatalog?: Array<CentralDirectoryFileSpec>;
   private _zipBaseDir?: string;
   private _readingDirection: 'right-to-left' | 'left-to-right';
+  // FIXME: Overlap with _objRefs, should be unified
+  private _deferredReferences = new Map<string, PdfRef>();
 
+  /** Just basic setup of state, real setup is done in setup()
+      method since we need to call a bunch of async stuff */
   constructor({
     writer,
     metadata,
@@ -206,12 +228,15 @@ export default class PDFGenerator {
     this._addObject(pdfMetadata, 'Info');
   }
 
+  /** Set up the basic PDF document, creating neccessary objects.  */
   async setup(): Promise<void> {
+    // Add the catalog object, will be updated later
     const catalog: PdfDictionary = {
       Type: '/Catalog',
     };
     this._addObject(catalog, 'Catalog');
 
+    // Pages Dictionary, will be updated later
     const pagesObj = this._addObject(
       {
         Type: '/Pages',
@@ -221,6 +246,7 @@ export default class PDFGenerator {
     );
     catalog.Pages = makeRef(pagesObj);
 
+    // Indicate that our PDF contains structure information, attached to the text layer
     if (this._hasText) {
       catalog.MarkInfo = {
         Type: '/MarkInfo',
@@ -229,6 +255,8 @@ export default class PDFGenerator {
     }
 
     if (this._outline.length > 0) {
+      // If we have an outline, display the ToC by default in PDF viewers and set up
+      // the required objects
       catalog.PageMode = '/UseOutlines';
       const outlines: PdfDictionary = {
         Type: '/Outlines',
@@ -248,16 +276,21 @@ export default class PDFGenerator {
         prev = childObj;
       }
     } else {
+      // Otherwise, display the thumbnails in PDF viewers
       catalog.PageMode = '/UseThumbs';
     }
+
+    // Adjust reading direction to RTL if neccessary
     catalog.ViewerPreferences = {
       Direction: this._readingDirection === 'right-to-left' ? '/R2L' : '/L2R',
     };
+
     if (this._hasText) {
       await this._setupHiddenTextFont();
     }
   }
 
+  /** Set up neccessary fonts for the hidden text layer. */
   async _setupHiddenTextFont(): Promise<void> {
     const typeZeroFont = this._addObject(
       {
@@ -284,6 +317,7 @@ export default class PDFGenerator {
       makeRef(typeTwoFont),
     ];
 
+    // Set up character id to glyph id mapping
     const cidtoGidMapData = new Uint8Array(128 * 1024);
     for (let i = 0; i < cidtoGidMapData.length; i++) {
       cidtoGidMapData[i] = i % 2 ? 1 : 0;
@@ -292,6 +326,9 @@ export default class PDFGenerator {
     const cidToGidMap = this._addObject(comp.dict, undefined, comp.stream);
     (typeTwoFont.data as PdfDictionary).CIDToGIDMap = makeRef(cidToGidMap);
 
+    // Set up character code to unicode codepoint mapping
+    // Effectively an identity mapping, since in our font every character code
+    // exactly corresponds to the unicode codepoint
     const cmapStream = dedent`
       /CIDInit /ProcSet findresource begin
         12 dict begin
@@ -302,13 +339,13 @@ export default class PDFGenerator {
               /Ordering (UCS)
               /Supplement 0
             >> def
-            /CMapName /Adobe-Identify-UCS def
+            /CMapName /Identity-H def
             /CMapType 2 def
             1 begincodespacerange
             <0000> <FFFF>
             endcodespacerange
             1 beginbfrange
-            <0000> <FFFE> <0000>
+            <0000> <FFFF> <0000>
             endbfrange
         endcmap
         CMapName currentdict /CMap defineresource pop
@@ -323,6 +360,7 @@ export default class PDFGenerator {
     );
     (typeZeroFont.data as PdfDictionary).ToUnicode = makeRef(cmap);
 
+    // Set up the font descriptor for our hidden text font
     const fontDesc = this._addObject({
       Type: '/FontDescriptor',
       FontName: '/GlyphLessFont',
@@ -348,6 +386,7 @@ export default class PDFGenerator {
     (fontDesc.data as PdfDictionary).FontFile2 = makeRef(fontDataObj);
   }
 
+  /** Register embedded OCR files in the PDF's catalog object. */
   _registerEmbeddedFilesInCatalog() {
     const catalog = this._objects[this._objRefs.Catalog.refObj]
       .data as PdfDictionary;
@@ -380,6 +419,32 @@ export default class PDFGenerator {
     }
   }
 
+  /** Create a PdfRef whose value is deferred, i.e. will be set at a later stage.
+   *
+   * Useful for bidirectional references.
+   *
+   * Prevents serialization of objects containing this reference as long as the
+   * value is not set.
+   *
+   * @param key A unique key to identify the reference
+   */
+  _makeDeferredReference(key: string): PdfRef {
+    if (!this._deferredReferences.has(key)) {
+      // Placeholder reference
+      const ref = makeRef(-1);
+      this._deferredReferences.set(key, ref);
+    }
+    return this._deferredReferences.get(key)!;
+  }
+
+  /** Add items to the PDF's outline, based on the passed TocItem tree.
+   *
+   * @param itm The item we want to add to the outline
+   * @param parent The parent outline item
+   * @param prev The preceding sibling outline item, if present
+   * @returns A tuple containing the object reference of the added outline item and the number
+   *         of children outline items that were created
+   */
   _addOutline(
     itm: TocItem,
     parent: PdfObject,
@@ -387,6 +452,7 @@ export default class PDFGenerator {
   ): [PdfObject, number] {
     let dest: PdfArray;
     if (typeof itm.startCanvas === 'string') {
+      // Simple case, just linke to a whole canvas/page
       const destCanvasIdx = this._canvasInfos.findIndex(
         (ci) => ci.canvas.id === itm.startCanvas
       );
@@ -397,6 +463,7 @@ export default class PDFGenerator {
       }
       dest = [destCanvasIdx, '/Fit'];
     } else {
+      // More complex: link to a specific region on a canvas
       const canvasId = itm.startCanvas.id;
       const unitScale = 72 / itm.startCanvas.ppi;
       const rect = itm.startCanvas.position;
@@ -417,6 +484,7 @@ export default class PDFGenerator {
         unitScale * (height - (rect.y + rect.height)), // top,
       ];
     }
+
     const rec: PdfDictionary = {
       Title: `( ${itm.label} )`,
       Parent: makeRef(parent),
@@ -430,7 +498,9 @@ export default class PDFGenerator {
       rec.Prev = makeRef(prev);
       (prev.data as PdfDictionary).Next = makeRef(obj);
     }
+
     if (itm.children?.length) {
+      // Recursively add children
       let prev: PdfObject | undefined;
       rec.Count = 0;
       for (const [idx, child] of itm.children.entries()) {
@@ -447,6 +517,13 @@ export default class PDFGenerator {
     return [obj, (rec.Count as number) ?? 0];
   }
 
+  /** Add a new object to the PDF document.
+   *
+   * @param val A PDF value, can be any of the supported types.
+   * @param refName An optional name to reference the object by.
+   * @param stream An optional stream to attach to the object, value must be adictionary in this case
+   * @returns The created object
+   */
   _addObject(
     val: PdfValue,
     refName?: string,
@@ -479,6 +556,12 @@ export default class PDFGenerator {
 
   /** Clone an object from a foreign PDF into the current PDF, adjusting
    *  the encountered indirect object references.
+   *
+   * @param parser PdfParser instance for the PDF the object is from
+   * @param obj The object to transplant into our document
+   * @param seenObjects A map of object numbers to known references, used to avoid
+   *                    infinite recursion
+   * @returns A reference to the transplanted object
    */
   private async _transplantObject(
     parser: PdfParser,
@@ -531,10 +614,10 @@ export default class PDFGenerator {
     //       a /StructParents key, check for the /StructTreeRoot key in
     //       the catalog, and then transplant that to our _strucTree
     //       and _pageMCIDs structures. Quite the handful!!
-    //
     return (await handleValue(ref)) as PdfRef;
   }
 
+  /** Insert cover pages from another PDF into our document. */
   async insertCoverPages(pdfData: ArrayBuffer): Promise<void> {
     if (this._pagesStarted) {
       throw 'Cover pages must be inserted before writing the first regular page';
@@ -559,13 +642,19 @@ export default class PDFGenerator {
     return;
   }
 
+  /** Embed a file resource in the PDF.
+   *
+   * @param filename The filename for the embedded resource
+   * @param description A description of the file
+   * @param mimeType The MIME type of the file
+   * @param data The data to embed
+   */
   private async _embedResource(
-    id: string,
     filename: string,
     description: string,
     mimeType: string,
     data: string
-  ) {
+  ): Promise<void> {
     // TODO: Add check that the file is actually pre-registered in
     //       the catalog!
     const fileSpec: PdfDictionary = {
@@ -614,6 +703,10 @@ export default class PDFGenerator {
     this._addObject(embeddedFile, undefined, maybeCompressed.stream);
   }
 
+  /** Embed the IIIF Manifest JSON in the PDF.
+   *
+   * @param manifestJson The IIIF (v2 or v3) Manifest to embed
+   */
   private async _embedManifest(
     manifestJson: ManifestV2 | Manifest
   ): Promise<void> {
@@ -629,7 +722,6 @@ export default class PDFGenerator {
       manifestMime += `;profile="${manifestJson['@context']}"`;
     }
     await this._embedResource(
-      '@id' in manifestJson ? manifestJson['@id'] : manifestJson.id,
       'manifest.json',
       'IIIF Manifest this PDF is based on',
       manifestMime,
@@ -637,6 +729,9 @@ export default class PDFGenerator {
     );
   }
 
+  /** Once all setup is complete and we begin rendering pages into the document,
+   *  we need to finalize the PDF header with the remaining information.
+   */
   async finalizePdfHeader(): Promise<void> {
     const catalog = this._objects[this._objRefs.Catalog.refObj]
       .data as PdfDictionary;
@@ -695,6 +790,7 @@ export default class PDFGenerator {
       );
     }
 
+    // Register the optional content groups, if present
     if (this._canvasInfos.some((ci) => ci.images.some((i) => i.choiceInfo))) {
       // We're *very* explicit with the visibility of the various OCGs to
       // ensure as broad a viewer support as possible (especially pdf.js
@@ -739,7 +835,9 @@ export default class PDFGenerator {
       };
     }
 
+    // Set the initial view of the PDF
     if (typeof this._initialCanvas === 'string') {
+      // ...to a whole page
       catalog.OpenAction = [
         makeRef(
           this.getCanvasObjectNumber(
@@ -750,6 +848,7 @@ export default class PDFGenerator {
         ),
       ];
     } else if (this._initialCanvas) {
+      // ...to a specific region on a page
       const unitScale = 72 / this._initialCanvas.ppi;
       const rect = this._initialCanvas.position;
       const { width, height } = this._initialCanvas.dimensions;
@@ -780,6 +879,17 @@ export default class PDFGenerator {
     }
   }
 
+  /** Render a new page, based on a IIIF canvas, its associated annotations and OCR text.
+   *
+   * @param canvasId The ID of the canvas to render
+   * @param width The width of the canvas in pixels
+   * @param height The height of the canvas in pixels
+   * @param images The images to render on the canvas
+   * @param annotations The annotations to render on the canvas
+   * @param ocrText The OCR text to render on the canvas
+   * @param ppi The resolution of the canvas in pixels per inch, used to determine the physical
+   *            size of the PDF page. Assumes 300ppi by default.
+   */
   async renderPage(
     canvasId: string,
     {
@@ -796,6 +906,7 @@ export default class PDFGenerator {
       await this.finalizePdfHeader();
       this._pagesStarted = true;
     }
+
     // Factor to multiply pixels by to get equivalent PDF units (72 pdf units === 1 inch)
     const unitScale = 72 / ppi;
     const pageDict: PdfDictionary = {
@@ -806,11 +917,13 @@ export default class PDFGenerator {
         ProcSet: ['/PDF', '/Text', '/ImageB', '/ImageI', '/ImageC'],
       },
     };
+
     if (this._hasText) {
       pageDict.StructParents = this._nextStructParentId;
       this._pageParentIds.set(this._nextObjNo, this._nextStructParentId);
       this._nextStructParentId++;
     }
+
     if (ocrText && this._objRefs.Type0Font) {
       (pageDict.Resources as PdfDictionary).Font = {
         'f-0-0': this._objRefs.Type0Font,
@@ -818,6 +931,7 @@ export default class PDFGenerator {
     }
     const page = this._addObject(pageDict);
 
+    // Draw images onto the page
     const contentOps: string[] = [];
     const optionalGroupIds: { [imgId: string]: string } = {};
     for (const [idx, image] of images.entries()) {
@@ -843,9 +957,11 @@ export default class PDFGenerator {
         contentOps.push('EMC');
       }
     }
+
     if (ocrText) {
       contentOps.push(this._renderOcrText(ocrText, unitScale));
     }
+
     log.debug('Trying to compress content stream.');
     const contentStreamComp = await tryDeflateStream(contentOps.join('\n'));
     const contentsObj = this._addObject(
@@ -855,45 +971,20 @@ export default class PDFGenerator {
     );
     (page.data as PdfDictionary).Contents = makeRef(contentsObj);
 
-    // Since we need the finalized page dictionary in order to determine
-    // the offset for the the local zip header, we pre-generate all the
-    // relevant information
-    const imageObjectNums = [...images.keys()].map((idx) => {
-      if (this._polyglot) {
-        return this._nextObjNo + idx * 2 + 1;
-      } else {
-        return this._nextObjNo + idx;
-      }
-    });
-    const optionalGroupObjectNums: { [imgId: string]: number } = {};
-    if (images.some((i) => i.choiceInfo?.optional)) {
-      for (const [idx, img] of images.entries()) {
-        if (isImageFetchFailure(img)) {
-          continue;
-        }
-        const imageId = `/Im${idx + 1}`;
-        if (!img.choiceInfo?.optional) {
-          continue;
-        }
-        // FIXME: This is broken for the layers example!
-        optionalGroupObjectNums[imageId] =
-          imageObjectNums.slice(-1)[0] + idx + 1;
-      }
-    }
+    // Register all resources for the page
     const pageResources = (page.data as PdfDictionary)
       .Resources as PdfDictionary;
     const xObjects: PdfDictionary = {};
     const properties: PdfDictionary = {};
-    for (const [idx, num] of imageObjectNums.entries()) {
-      if (isImageFetchFailure(images[idx])) {
+    for (const [idx, img] of images.entries()) {
+      if (isImageFetchFailure(img)) {
         continue;
       }
       const imageId = `/Im${idx + 1}`;
-      xObjects[imageId.substring(1)] = makeRef(num);
-      const ocgNum = optionalGroupObjectNums[imageId];
-      if (ocgNum !== undefined) {
+      xObjects[imageId.substring(1)] = this._makeDeferredReference(imageId);
+      if (img.choiceInfo?.optional) {
         const ocgId = optionalGroupIds[imageId];
-        properties[ocgId.substring(1)] = makeRef(ocgNum);
+        properties[ocgId.substring(1)] = this._makeDeferredReference(ocgId);
       }
     }
     pageResources.XObject = xObjects;
@@ -917,21 +1008,46 @@ export default class PDFGenerator {
       }
       const imageData = new Uint8Array(img.data!);
       const image = PdfImage.open(imageData);
-      // TODO: Currently we only support JPEG, if we expand to other
-      //       file types we need to consider multiple objects pe rimage
-      const imageObj = image.toObjects(this._nextObjNo)[0];
+
+      const imageObjs = image.toObjects(
+        // Account for local zip header object if polyglot Zip-PDF is enabled
+        this._polyglot ? this._nextObjNo + 1 : this._nextObjNo
+      );
+
+      if (img.format !== 'jpeg' && image instanceof JPEGImage) {
+        // We calculated with 3 objects for this image, since it was either identified
+        // as PNG or we did not have a format in the manifest. So we need to add empty
+        // dummy objects to keep the object numbers in sync.
+        let objNum = imageObjs.slice(-1)[0].num;
+        for (let i = 0; imageObjs.length < 3; i++) {
+          imageObjs.push({ num: objNum++ });
+        }
+      }
+
+      // Resolve deferred references to this image
+      const mainImageObj = imageObjs[0];
+      const imageId = `/Im${imgIdx + 1}`;
+      this._deferredReferences.get(imageId)!.refObj = mainImageObj.num;
+
       if (this._polyglot) {
-        const imgPreambleSize = this._getSerializedSize(imageObj, true);
-        const filename = `img/canvas-${canvasIdx}-${imgIdx}.jpg`;
-        this._insertZipHeaderDummyObject({
-          filename,
-          data: imageData,
-          bytesUntilActualData: imgPreambleSize,
-        });
-        imageObj.num = this._nextObjNo;
+        if (image instanceof JPEGImage) {
+          const imgPreambleSize = this._getSerializedSize(mainImageObj, true);
+          const filename = `img/canvas-${canvasIdx}-${imgIdx}.jpg`;
+          this._insertZipHeaderDummyObject({
+            filename,
+            data: imageData,
+            bytesUntilActualData: imgPreambleSize,
+          });
+        } else {
+          // Polyglot PDF is not possible for PNG images, since PNGs are not stored
+          // as-is in the PDF, but can be split and stored across multiple objects
+          // To keep our pre-calculated object numbers valid, we need to insert an
+          // empty dummy object in place of the local zip header
+          this._addObject({});
+        }
       }
-      this._nextObjNo += 1;
-      this._objects.push(imageObj);
+      imageObjs.forEach((obj) => this._objects.push(obj));
+      this._nextObjNo = imageObjs.slice(-1)[0].num + 1;
     }
 
     if (images.some((i) => i?.choiceInfo?.optional)) {
@@ -946,7 +1062,8 @@ export default class PDFGenerator {
           this._addObject({});
           continue;
         }
-        optionalGroupObjectNums[imageId] = this._nextObjNo;
+        this._deferredReferences.get(optionalGroupIds[imageId])!.refObj =
+          this._nextObjNo;
         this._addObject({
           Type: '/OCG',
           Name: img.choiceInfo.label
@@ -959,6 +1076,8 @@ export default class PDFGenerator {
     }
 
     const canvasInfo = this._canvasInfos[canvasIdx];
+
+    // Embed OCR text, if present
     if (ocrText?.markup) {
       const canvasIdx = this._canvasInfos.findIndex(
         (ci) => ci.canvas.id === canvasId
@@ -971,7 +1090,6 @@ export default class PDFGenerator {
       }
 
       await this._embedResource(
-        ocrText.id,
         filename,
         `OCR for canvas #${canvasIdx}`,
         ocrText.mimeType,
@@ -979,7 +1097,7 @@ export default class PDFGenerator {
       );
     } else if (canvasInfo.ocr) {
       // Canvas Info says we have OCR, but none was passed, possible
-      // when he OCR doesn't have CORS or fetching failed for another reason
+      // when the OCR doesn't have CORS or fetching failed for another reason
       // Add two empty objects so object references are still valid
       this._addObject({});
       this._addObject({});
@@ -1079,6 +1197,7 @@ export default class PDFGenerator {
     return ops.join('\n');
   }
 
+  /** Get PDF instructions to render a single line of OCR text. */
   renderOcrLine(
     line: OcrLine,
     lineIdx: number,
@@ -1156,6 +1275,7 @@ export default class PDFGenerator {
     return ops;
   }
 
+  /** How many bytes have we written to the output so far? */
   get bytesWritten(): number {
     return this._offset;
   }
@@ -1169,11 +1289,16 @@ export default class PDFGenerator {
     );
   }
 
+  /** How many objects are needed to render the canvas at the given index? */
   getObjectsPerCanvas(canvasIdx: number): number {
     const { images, ocr, numAnnotations } = this._canvasInfos[canvasIdx];
     let numObjects =
-      // 1 XObject per image
-      images.length +
+      // 1 XObject for JPEGs, 3 for PNGs or unknown formats
+      // The minority of PNGs actually need three XObjects, but we can't know
+      // that in advance and so we simply add empty dummy objects if we need less.
+      images
+        .map((img) => (img.format === 'jpeg' ? 1 : 3))
+        .reduce((a, b) => a + b, 0) +
       // Page dictionary and content
       2 +
       // 1 Optional Content Group per optional image
@@ -1185,6 +1310,8 @@ export default class PDFGenerator {
       // to expose as a file in the ZIP with a separate XObject that contains
       // the local ZIP header for that file. Currently this concerns the
       // images and the OCR data
+      // PNG images can't be embedded in the polyglot ZIP, so we simply add an
+      // empty object for each PNG image in place of the zip header object.
       numObjects = numObjects + images.length + (ocr ? 1 : 0);
     }
     if (ocr) {
@@ -1193,6 +1320,7 @@ export default class PDFGenerator {
     return numObjects;
   }
 
+  /** Get the object number for the canvas at the given index. */
   getCanvasObjectNumber(canvasIdx: number): number {
     let num = this._firstPageObjectNum!;
     for (const [idx] of this._canvasInfos.entries()) {
@@ -1204,6 +1332,7 @@ export default class PDFGenerator {
     throw new Error(`Canvas #${canvasIdx} not found.`);
   }
 
+  /** Flush remaining data to output. */
   async _flush(): Promise<void> {
     if (this._offsets.length === 0) {
       log.debug('Writing PDF header');
@@ -1219,6 +1348,7 @@ export default class PDFGenerator {
     this._objects = [];
   }
 
+  /** Get the serialized size in bytes of a PDF object. */
   _getSerializedSize(
     { num, data, stream }: PdfObject,
     untilStreamStart = false
@@ -1245,6 +1375,7 @@ export default class PDFGenerator {
     return size;
   }
 
+  /** Serialize a PDF object to the output. */
   async _serializeObject(obj: PdfObject): Promise<void> {
     this._offsets.push(this._offset);
     const { num, data, stream } = obj;
@@ -1260,6 +1391,7 @@ export default class PDFGenerator {
     await this._write('\nendobj\n');
   }
 
+  /** Write data to the output. */
   async _write(data: Uint8Array | string): Promise<void> {
     if (this._writer === undefined) {
       throw new Error(
@@ -1273,6 +1405,7 @@ export default class PDFGenerator {
     await this._writer.write(data);
   }
 
+  /** Write the PDF objects required for the structure tree */
   async _writeStructureTree(): Promise<void> {
     const parentRoot: PdfDictionary = {
       Nums: [],
@@ -1335,6 +1468,11 @@ export default class PDFGenerator {
     await this._flush();
   }
 
+  /** Finish writing the PDF and close the writer.
+   *
+   * Writes XRef table, trailer and EOF marker to the output.
+   * Also adds ZIP central directory if polyglot PDF is enabled.
+   */
   async end(): Promise<void> {
     if (!this._writer) {
       return;
@@ -1342,7 +1480,7 @@ export default class PDFGenerator {
     /* FIXME: Disabled due to poor performance on large volumes and a strange
      *        interaction with streamsaver, where the PDF would be prematurely
      *        closed in the middle of writing out the structure tree.
-    console.debug("Writing structure tree");
+    log.debug("Writing structure tree");
     if (this._strucTree.length > 0) {
       await this._writeStructureTree();
     }
@@ -1401,6 +1539,10 @@ export default class PDFGenerator {
     this._writer = undefined;
   }
 
+  /** Insert a 'dummy' PDF object that isn't referenced anywhere, but which
+   *  contains the data neccessary to expose the following object's data as a
+   *  file in the ZIP archive.
+   */
   private _insertZipHeaderDummyObject({
     filename,
     data,
diff --git a/node_modules/pdiiif/src/pdf/image.ts b/node_modules/pdiiif/src/pdf/image.ts
index 5be9a72..1ccd779 100644
--- a/node_modules/pdiiif/src/pdf/image.ts
+++ b/node_modules/pdiiif/src/pdf/image.ts
@@ -1,9 +1,10 @@
 /* Based on the `images` modules in `pdfkit` by Devon Govett, licensed under MIT.
  *
- * Ported to TypeScript and modified to better fit a web use case, by using  Uint8Array
+ * Ported to TypeScript and modified to better fit a web use case, by using Uint8Array
  * instead of Buffer.
  *
  * https://github.com/foliojs/pdfkit/blob/master/lib/image/jpeg.js
+ * https://github.com/foliojs/pdfkit/blob/master/lib/image/png.js
  *
  * MIT LICENSE
  * Copyright (c) 2011 Devon Govett
@@ -23,7 +24,9 @@
  * DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
  * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
  */
-import { PdfDictionary, serialize, PdfObject } from './common.js';
+import { zlibSync } from 'fflate';
+import { PdfDictionary, serialize, PdfObject, makeRef } from './common.js';
+import PNG from './png.js';
 import { IS_BIG_ENDIAN } from './util.js';
 
 function readUint16BE(buf: Uint8Array, pos = 0): number {
@@ -38,8 +41,20 @@ function readUint16BE(buf: Uint8Array, pos = 0): number {
 
 abstract class PdfImage {
   static open(data: Uint8Array): PdfImage {
-    if (data[0] === 0xff && data[1] === 0xd8) {
+    if (data.length > 2 && data[0] === 0xff && data[1] === 0xd8) {
       return new JPEGImage(data);
+    } else if (
+      data.length > 8 &&
+      data[0] === 0x89 &&
+      data[1] === 0x50 &&
+      data[2] === 0x4e &&
+      data[3] === 0x47 &&
+      data[4] === 0x0d &&
+      data[5] === 0x0a &&
+      data[6] === 0x1a &&
+      data[7] === 0x0a
+    ) {
+      return new PNGImage(data);
     } else {
       throw new Error('Unknown image format.');
     }
@@ -53,7 +68,7 @@ abstract class PdfImage {
   ): Array<PdfObject>;
 }
 
-class JPEGImage extends PdfImage {
+export class JPEGImage extends PdfImage {
   static MARKERS = [
     0xffc0, 0xffc1, 0xffc2, 0xffc3, 0xffc5, 0xffc6, 0xffc7, 0xffc8, 0xffc9,
     0xffca, 0xffcb, 0xffcc, 0xffcd, 0xffce, 0xffcf,
@@ -129,4 +144,197 @@ class JPEGImage extends PdfImage {
   }
 }
 
+export class PNGImage extends PdfImage {
+  label: string | undefined;
+  image: PNG;
+  width: number;
+  height: number;
+  imgData: Uint8Array;
+
+  constructor(data: Uint8Array, label?: string) {
+    super();
+    this.label = label;
+    this.image = new PNG(data);
+    this.width = this.image.width;
+    this.height = this.image.height;
+    this.imgData = this.image.imgData;
+  }
+
+  toObjects(startNum: number): Array<PdfObject> {
+    let dataDecoded = false;
+
+    const hasAlphaChannel = this.image.hasAlphaChannel;
+    const isInterlaced = this.image.interlaceMethod === 1;
+
+    const out: Array<PdfObject> = [];
+    let nextNum = startNum;
+    const imgObj: PdfObject = {
+      num: nextNum++,
+    };
+    out.push(imgObj);
+
+    const imgDict: PdfDictionary = {
+      Type: '/XObject',
+      Subtype: '/Image',
+      BitsPerComponent: hasAlphaChannel ? 8 : this.image.bits,
+      Width: this.width,
+      Height: this.height,
+      Filter: '/FlateDecode',
+    };
+
+    if (!hasAlphaChannel) {
+      imgDict.DecodeParms = {
+        Predictor: isInterlaced ? 1 : 15,
+        Colors: this.image.colors,
+        BitsPerComponent: this.image.bits,
+        Columns: this.width,
+      };
+    }
+
+    if (this.image.palette.length === 0) {
+      imgDict.ColorSpace = `/${this.image.colorSpace}`;
+    } else {
+      // embed the color palette in the PDF as an object stream
+      const paletteObj: PdfObject = {
+        num: nextNum++,
+        data: serialize({ Length: this.image.palette.length }),
+        stream: new Uint8Array(this.image.palette),
+      };
+      out.push(paletteObj);
+      // build the color space array for the image
+      imgDict.ColorSpace = [
+        '/Indexed',
+        '/DeviceRGB',
+        this.image.palette.length / 3 - 1,
+        makeRef(paletteObj),
+      ];
+    }
+
+    // For PNG color types 0, 2 and 3, the transparency data is stored in
+    // a dedicated PNG chunk.
+    if (this.image.transparency.grayscale != null) {
+      // Use Color Key Masking (spec section 4.8.5)
+      // An array with N elements, where N is two times the number of color components.
+      const val = this.image.transparency.grayscale;
+      imgDict.Mask = [val, val];
+    } else if (this.image.transparency.rgb) {
+      // Use Color Key Masking (spec section 4.8.5)
+      // An array with N elements, where N is two times the number of color components.
+      const { rgb } = this.image.transparency;
+      const mask = [];
+      for (let x of rgb) {
+        mask.push(x, x);
+      }
+
+      imgDict.Mask = mask;
+    } else if (this.image.transparency.indexed) {
+      // Create a transparency SMask for the image based on the data
+      // in the PLTE and tRNS sections. See below for details on SMasks.
+      const alphaChannelObj = this.loadIndexedAlphaChannel(nextNum++);
+      imgDict.SMask = makeRef(alphaChannelObj);
+      out.push(alphaChannelObj);
+      dataDecoded = true;
+    } else if (hasAlphaChannel) {
+      // For PNG color types 4 and 6, the transparency data is stored as a alpha
+      // channel mixed in with the main image data. Separate this data out into an
+      // SMask object and store it separately in the PDF.
+      const [imageData, alphaChannelObj] = this.splitAlphaChannel(nextNum++);
+      imgObj.stream = zlibSync(imageData);
+      imgDict.Length = imgObj.stream.length;
+      imgDict.SMask = makeRef(alphaChannelObj);
+      out.push(alphaChannelObj);
+    }
+
+    if (isInterlaced && !dataDecoded && !imgObj.stream) {
+      imgObj.stream = zlibSync(this.image.decodePixels());
+      imgDict.Length = imgObj.stream.length;
+    } else if (!imgObj.stream) {
+      imgObj.stream = this.imgData;
+      imgDict.Length = imgObj.stream.length;
+    }
+
+    imgObj.data = serialize(imgDict);
+
+    if (out.length < 3) {
+      // Add empty dummy objects until we have 3 objects for the image, to stay true
+      // to our pre-determined object numbering
+      for (let i = out.length; i < 3; i++) {
+        out.push({ num: nextNum++ });
+      }
+    }
+    return out;
+  }
+
+  splitAlphaChannel(objNum: number): [Uint8Array, PdfObject] {
+    const pixels = this.image.decodePixels();
+    const colorCount = this.image.colors;
+    const pixelCount = this.width * this.height;
+    const imgData = new Uint8Array(pixelCount * colorCount);
+    const alphaChannel = new Uint8Array(pixelCount);
+
+    let i = 0;
+    let a = 0;
+    let p = 0;
+    const len = pixels.length;
+    // For 16bit images copy only most significant byte (MSB) - PNG data is always stored in network byte order (MSB first)
+    const skipByteCount = this.image.bits === 16 ? 1 : 0;
+    while (i < len) {
+      for (let colorIndex = 0; colorIndex < colorCount; colorIndex++) {
+        imgData[p++] = pixels[i++];
+        i += skipByteCount;
+      }
+      alphaChannel[a++] = pixels[i++];
+      i += skipByteCount;
+    }
+
+    const alphaChannelDeflated = zlibSync(alphaChannel);
+    return [
+      imgData,
+      {
+        num: objNum,
+        data: serialize({
+          Type: '/XObject',
+          Subtype: '/Image',
+          Width: this.width,
+          Height: this.height,
+          BitsPerComponent: 8,
+          Decode: [0, 1],
+          ColorSpace: '/DeviceGray',
+          Filter: '/FlateDecode',
+          Length: alphaChannelDeflated.length,
+        }),
+        stream: alphaChannelDeflated,
+      },
+    ];
+  }
+
+  loadIndexedAlphaChannel(objNum: number): PdfObject {
+    const pixels = this.image.decodePixels();
+    const transparency = this.image.transparency.indexed!;
+    const alphaChannel = new Uint8Array(this.width * this.height);
+
+    let i = 0;
+    for (let j = 0, end = pixels.length; j < end; j++) {
+      alphaChannel[i++] = transparency[pixels[j]];
+    }
+
+    const alphaChannelDeflated = zlibSync(alphaChannel);
+    return {
+      num: objNum,
+      data: serialize({
+        Type: '/XObject',
+        Subtype: '/Image',
+        Width: this.width,
+        Height: this.height,
+        BitsPerComponent: 8,
+        Decode: [0, 1],
+        ColorSpace: '/DeviceGray',
+        Filter: '/FlateDecode',
+        Length: alphaChannelDeflated.length,
+      }),
+      stream: alphaChannelDeflated,
+    };
+  }
+}
+
 export default PdfImage;
diff --git a/node_modules/pdiiif/src/pdf/png.ts b/node_modules/pdiiif/src/pdf/png.ts
new file mode 100644
index 0000000..a50f967
--- /dev/null
+++ b/node_modules/pdiiif/src/pdf/png.ts
@@ -0,0 +1,397 @@
+/*
+Taken from Hopding/png-ts, which is a TypeScript port by Andrew Dillon of the
+PNG decoder from pdfkit written by Devon Govett.
+The original code can be found at:
+https://github.com/Hopding/png-ts/blob/master/src/png.ts
+
+Modified by me (@jbaiter):
+- use `fflate` instead of `pako` for decompression.
+- add support for decoding interlaced images
+
+MIT License
+
+Copyright (c) 2018 Andrew Dillon
+Copyright (c) 2017 Devon Govett
+
+Permission is hereby granted, free of charge, to any person obtaining a copy
+of this software and associated documentation files (the "Software"), to deal
+in the Software without restriction, including without limitation the rights
+to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
+copies of the Software, and to permit persons to whom the Software is
+furnished to do so, subject to the following conditions:
+
+The above copyright notice and this permission notice shall be included in all
+copies or substantial portions of the Software.
+
+THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
+IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
+FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
+AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
+LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
+OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
+SOFTWARE.
+*/
+import { unzipSync, unzlibSync } from "fflate";
+
+export type ColorSpace = 'DeviceGray' | 'DeviceRGB';
+
+export default class PNG {
+  static load = (data: Uint8Array) => new PNG(data);
+
+  palette: number[];
+  imgData: Uint8Array;
+  transparency: {
+    indexed?: number[];
+    grayscale?: number;
+    rgb?: number[];
+  };
+  text: { [key: string]: string };
+  width!: number;
+  height!: number;
+  bits!: number;
+  colorType!: number;
+  compressionMethod!: number;
+  filterMethod!: number;
+  interlaceMethod!: number;
+  colors: 1 | 3;
+  hasAlphaChannel: boolean;
+  pixelBitlength: number;
+  colorSpace: ColorSpace;
+
+  private data: Uint8Array;
+  private pos: number;
+
+  constructor(data: Uint8Array) {
+    this.data = data;
+    this.pos = 8; // Skip the default header;
+
+    this.palette = [];
+    const imgDataBuff = [];
+    this.transparency = {};
+    this.text = {};
+
+    while (true) {
+      const chunkSize = this.readUInt32();
+
+      let section = '';
+      for (let i = 0; i < 4; i++) {
+        section += String.fromCharCode(this.data[this.pos++]);
+      }
+
+      switch (section) {
+        case 'IHDR': {
+          // We can grab interesting values from here (like width, height, etc...)
+          this.width = this.readUInt32();
+          this.height = this.readUInt32();
+          this.bits = this.data[this.pos++];
+          this.colorType = this.data[this.pos++];
+          this.compressionMethod = this.data[this.pos++];
+          this.filterMethod = this.data[this.pos++];
+          this.interlaceMethod = this.data[this.pos++];
+          break;
+        }
+
+        case 'PLTE': {
+          this.palette = this.read(chunkSize);
+          break;
+        }
+
+        case 'IDAT': {
+          for (let i = 0; i < chunkSize; i++) {
+            imgDataBuff.push(this.data[this.pos++]);
+          }
+          break;
+        }
+
+        case 'tRNS': {
+          // This chunk can only occur once and it must occur after the
+          // PLTE chunk and before the IDAT chunk.
+          this.transparency = {};
+          switch (this.colorType) {
+            case 3: {
+              // Indexed color, RGB. Each byte in this chunk is an alpha for the
+              // palette index in the PLTE ("palette") chunk up until the last
+              // non-opaque entry. Set up an array, stretching over all palette
+              // entries which will be 0 (opaque) or 1 (transparent).
+              this.transparency.indexed = this.read(chunkSize);
+              const short = 255 - this.transparency.indexed.length;
+              if (short > 0) {
+                for (let i = 0; i < 255; i++) {
+                  this.transparency.indexed.push(255);
+                }
+              }
+              break;
+            }
+            case 0: {
+              // Greyscale. Corresponding to entries in the PLTE chunk.
+              // Grey is two bytes, range 0 .. (2 ^ bit-depth) - 1
+              this.transparency.grayscale = this.read(chunkSize)[0];
+              break;
+            }
+            case 2: {
+              // True color with proper alpha channel.
+              this.transparency.rgb = this.read(chunkSize);
+              break;
+            }
+          }
+          break;
+        }
+
+        case 'tEXt': {
+          const text = this.read(chunkSize);
+          const index = text.indexOf(0);
+          const key = String.fromCharCode(...text.slice(0, index));
+          this.text[key] = String.fromCharCode(...text.slice(index + 1));
+          break;
+        }
+
+        case 'IEND': {
+          // We've got everything we need!
+          const colorTypeMap: { [colorType: number]: 1 | 3 } = {
+            0: 1,
+            3: 1,
+            4: 1,
+            2: 3,
+            6: 3,
+          };
+          this.colors = colorTypeMap[this.colorType];
+
+          this.hasAlphaChannel = [4, 6].includes(this.colorType);
+          const colors = this.colors + (this.hasAlphaChannel ? 1 : 0);
+          this.pixelBitlength = this.bits * colors;
+          this.colorSpace = {
+            1: 'DeviceGray',
+            3: 'DeviceRGB',
+          }[this.colors] as ColorSpace;
+          this.imgData = new Uint8Array(imgDataBuff);
+
+          return;
+        }
+
+        default: {
+          // Unknown (or unimportant) section, skip it
+          this.pos += chunkSize;
+        }
+      }
+
+      this.pos += 4; // Skip the CRC
+      if (this.pos > this.data.length) {
+        throw new Error('Incomplete or corrupt PNG file');
+      }
+    }
+  }
+
+  decode = () => {
+    const retVal = new Uint8Array(this.width * this.height * 4);
+    const pixels = this.decodePixels();
+    this.copyImageDataToBuffer(retVal, pixels);
+    return retVal;
+  };
+
+  copyImageDataToBuffer = (imageData: Uint8Array, pixels: Uint8Array): void => {
+    let colors: 1 | 3 | 4 = this.colors;
+    let palette;
+    let alpha = this.hasAlphaChannel;
+
+    if (this.palette.length) {
+      palette = this.decodePalette();
+      colors = 4;
+      alpha = true;
+    }
+
+    const data = imageData;
+    const length = data.length;
+    const input = palette || pixels;
+
+    let i = 0;
+    let j = 0;
+
+    if (colors === 1) {
+      while (i < length) {
+        let k = palette ? pixels[i / 4] * 4 : j;
+        const v = input[k++];
+        data[i++] = v;
+        data[i++] = v;
+        data[i++] = v;
+        data[i++] = alpha ? input[k++] : 255;
+        j = k;
+      }
+    } else {
+      while (i < length) {
+        let k = palette ? pixels[i / 4] * 4 : j;
+        data[i++] = input[k++];
+        data[i++] = input[k++];
+        data[i++] = input[k++];
+        data[i++] = alpha ? input[k++] : 255;
+        j = k;
+      }
+    }
+  };
+
+  decodePixels = (): Uint8Array => {
+    const data = unzlibSync(this.imgData);
+
+    const width = this.width;
+    const height = this.height;
+    const pixelBytes = this.pixelBitlength / 8;
+    const scanlineLength = pixelBytes * this.width;
+
+    const pixels = new Uint8Array(scanlineLength * this.height);
+    const length = data.length;
+    let row = 0;
+    let pos = 0;
+    let c = 0;
+
+    function pass(x0: number, y0: number, dx: number, dy: number, singlePass = false): void {
+      const w = Math.ceil((width - x0) / dx);
+      const h = Math.ceil((height - y0) / dy);
+      const scanlineLength = pixelBytes * w;
+      const buffer = singlePass ? pixels : new Uint8Array(scanlineLength * h);
+      let row = 0;
+      let c = 0;
+      while (row < h && pos < length) {
+        switch (data[pos++]) {
+          case 0: // None
+            for (let i = 0; i < scanlineLength; i++) {
+              buffer[c++] = data[pos++];
+            }
+            break;
+          case 1: // Sub
+            for (let i = 0; i < scanlineLength; i++) {
+              const byte = data[pos++];
+              const left = i < pixelBytes ? 0 : buffer[c - pixelBytes];
+              buffer[c++] = (byte + left) % 256;
+            }
+            break;
+          case 2: // Up
+            for (let i = 0; i < scanlineLength; i++) {
+              const byte = data[pos++];
+              const col = (i - (i % pixelBytes)) / pixelBytes;
+              const pixelsIdx = (row - 1) * scanlineLength + col * pixelBytes + (i % pixelBytes);
+              const upper = row && buffer[pixelsIdx];
+              buffer[c++] = (upper + byte) % 256;
+            }
+            break;
+          case 3: // Average
+            for (let i = 0; i < scanlineLength; i++) {
+              const byte = data[pos++];
+              const col = (i - (i % pixelBytes)) / pixelBytes;
+              const left = i < pixelBytes ? 0 : buffer[c - pixelBytes];
+              const pixelsIdx = (row - 1) * scanlineLength + col * pixelBytes + (i % pixelBytes);
+              const upper = row && buffer[pixelsIdx];
+              buffer[c++] = (byte + Math.floor((left + upper) / 2)) % 256;
+            }
+            break;
+          case 4: // Paeth
+            for (let i = 0; i < scanlineLength; i++) {
+              const byte = data[pos++];
+              const col = (i - (i % pixelBytes)) / pixelBytes;
+              const left = i < pixelBytes ? 0 : buffer[c - pixelBytes];
+              let upper;
+              let upperLeft;
+              if (row === 0) {
+                upper = upperLeft = 0;
+              } else {
+                const upperIdx = (row - 1) * scanlineLength + col * pixelBytes + (i % pixelBytes);
+                const upperLeftIdx = (row - 1) * scanlineLength + (col - 1) * pixelBytes + (i % pixelBytes);
+                upper = buffer[upperIdx];
+                upperLeft = col && buffer[upperLeftIdx];
+              }
+              const p = left + upper - upperLeft;
+              const pa = Math.abs(p - left);
+              const pb = Math.abs(p - upper);
+              const pc = Math.abs(p - upperLeft);
+              let paeth;
+              if (pa <= pb && pa <= pc) {
+                paeth = left;
+              } else if (pb <= pc) {
+                paeth = upper;
+              } else {
+                paeth = upperLeft;
+              }
+              buffer[c++] = (byte + paeth) % 256;
+            }
+            break;
+          default:
+            throw new Error(`Invalid filter algorithm: ${data[pos - 1]}`);
+          }
+
+          if (!singlePass) {
+            let pixelsPos = ((y0 + row * dy) * width + x0) * pixelBytes;
+            let bufferPos = row * scanlineLength;
+            for (let i = 0; i < w; i++) {
+              for (let j = 0; j < pixelBytes; j++) {
+                pixels[pixelsPos++] = buffer[bufferPos++];
+              }
+              pixelsPos += (dx - 1) * pixelBytes;
+            }
+          }
+
+          row++;
+      }
+    }
+
+    if (this.interlaceMethod === 0) {
+      // Single pass from top to bottom with no skips
+      pass(0, 0, 1, 1, true);
+    } else {
+      /*
+        Adam7 interlacing consists of 7 passes over the data, each one
+        starting at a different x,y offset and covering a different fraction of the pixels.
+
+        1 6 4 6 2 6 4 6
+        7 7 7 7 7 7 7 7
+        5 6 5 6 5 6 5 6
+        7 7 7 7 7 7 7 7
+        3 6 4 6 3 6 4 6
+        7 7 7 7 7 7 7 7
+        5 6 5 6 5 6 5 6
+        7 7 7 7 7 7 7 7
+      */
+      pass(0, 0, 8, 8); // 1
+      pass(4, 0, 8, 8); // 2
+      pass(0, 4, 4, 8); // 3
+      pass(2, 0, 4, 4); // 4
+      pass(0, 2, 2, 4); // 5
+      pass(1, 0, 2, 2); // 6
+      pass(0, 1, 1, 2); // 7
+    }
+
+
+    return pixels;
+  };
+
+  private read = (numBytes: number): number[] => {
+    const results = [];
+    for (let i = 0; i < numBytes; i++) {
+      results[i] = this.data[this.pos++];
+    }
+    return results;
+  };
+
+  private readUInt32 = (): number => {
+    const b1 = this.data[this.pos++] << 24;
+    const b2 = this.data[this.pos++] << 16;
+    const b3 = this.data[this.pos++] << 8;
+    const b4 = this.data[this.pos++];
+    return b1 | b2 | b3 | b4;
+  };
+
+  private decodePalette = (): Uint8Array => {
+    const palette = this.palette;
+    const transparency = this.transparency.indexed || [];
+    const retVal = new Uint8Array(transparency.length + palette.length);
+    let pos = 0;
+    let c = 0;
+
+    for (let i = 0; i < palette.length; i++) {
+      retVal[pos++] = palette[i];
+      retVal[pos++] = palette[i + 1];
+      retVal[pos++] = palette[i + 2];
+      const temp = transparency[c++];
+      retVal[pos++] = temp !== undefined ? temp : 255;
+    }
+
+    return retVal;
+  };
+}
\ No newline at end of file
diff --git a/node_modules/pdiiif/src/types.d.ts b/node_modules/pdiiif/src/types.d.ts
new file mode 100644
index 0000000..e737d8f
--- /dev/null
+++ b/node_modules/pdiiif/src/types.d.ts
@@ -0,0 +1,6 @@
+ declare module '*?worker' {
+   const workerConstructor: {
+     new (): Worker
+   }
+   export default workerConstructor
+ }
diff --git a/node_modules/pdiiif/src/util.ts b/node_modules/pdiiif/src/util.ts
index 79ec95c..6196392 100644
--- a/node_modules/pdiiif/src/util.ts
+++ b/node_modules/pdiiif/src/util.ts
@@ -38,3 +38,18 @@ export function runningInNode(): boolean {
 export function initializeSaxParser(parserWasm: Uint8Array): void {
   saxParserWasm = parserWasm;
 }
+
+export function randomUUIDv4() {
+  if (typeof crypto !== 'undefined' && crypto.randomUUID) {
+    return crypto.randomUUID();
+  }
+
+  return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
+    if (c !== 'x') {
+      return c;
+    }
+    const randomInteger = (Math.random() * 16) | 0;
+    const encoded = (randomInteger & 0x3) | 0x8;
+    return encoded.toString(16);
+  });
+}
diff --git a/node_modules/pdiiif/src/version.ts b/node_modules/pdiiif/src/version.ts
index 3e78bc2..5387748 100644
--- a/node_modules/pdiiif/src/version.ts
+++ b/node_modules/pdiiif/src/version.ts
@@ -1 +1 @@
-export default '0.2.3';
+export default '0.2.6';
